#!/bin/bash
# Script di debug per analizzare il problema WebSocket

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” ANALISI PROBLEMA WEBSOCKET - NESSUNA CONNESSIONE CLIENT"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "ğŸ“‹ SINTOMI RILEVATI:"
echo "  âŒ Nessuna connessione WebSocket client nei log backend"
echo "  âŒ Admin panel mostra sempre status 'idle' (giallo)"
echo "  âœ… WebSocket server inizializzato correttamente"
echo "  âœ… Sync PDF periodica funziona"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” ANALISI CODEBASE COMPLETATA"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "ğŸ“ ARCHITETTURA FRONTEND:"
echo "  â”œâ”€â”€ AppRouter.tsx"
echo "  â”‚   â””â”€â”€ {auth.isAuthenticated && <WebSocketSync />}"
echo "  â”œâ”€â”€ WebSocketSync.tsx"
echo "  â”‚   â”œâ”€â”€ useDraftSync() â”€â”€â”"
echo "  â”‚   â””â”€â”€ usePendingSync() â”€â”¤"
echo "  â””â”€â”€ hooks/                â”‚"
echo "      â”œâ”€â”€ useDraftSync.ts â”€â”€â”¼â”€â”€ useWebSocket() [ISTANZA 1]"
echo "      â””â”€â”€ usePendingSync.ts â”€â”€â”€ useWebSocket() [ISTANZA 2]"
echo ""

echo "âš ï¸  PROBLEMA CRITICO IDENTIFICATO #1:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âŒ MULTIPLE ISTANZE WEBSOCKET"
echo ""
echo "Ogni hook (useDraftSync, usePendingSync) chiama useWebSocket(),"
echo "creando una NUOVA istanza di WebSocket indipendente:"
echo ""
echo "  â€¢ useDraftSync() chiama useWebSocket() â†’ crea ws://host/ws/realtime?token=xxx"
echo "  â€¢ usePendingSync() chiama useWebSocket() â†’ crea ws://host/ws/realtime?token=xxx"
echo ""
echo "Risultato: 2 CONNESSIONI WEBSOCKET PARALLELE allo stesso endpoint!"
echo ""
echo "Questo Ã¨ inefficiente e puÃ² causare:"
echo "  - Consumo doppio di risorse"
echo "  - Race conditions"
echo "  - Problemi di sincronizzazione"
echo "  - Possibile rifiuto da parte del server"
echo ""

echo "âš ï¸  PROBLEMA CRITICO IDENTIFICATO #2:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âŒ DOPPIO WEBSOCKET SERVER NEL BACKEND"
echo ""
echo "Il backend ha DUE server WebSocket attivi contemporaneamente:"
echo ""
echo "  1. VECCHIO: /ws/sync (riga 97 in index.ts)"
echo "     export const wss = new WebSocketServer({ server, path: '/ws/sync' });"
echo ""
echo "  2. NUOVO: /ws/realtime (riga 6148 in index.ts)"
echo "     WebSocketServerService.getInstance().initialize(server);"
echo ""
echo "Il vecchio endpoint era stato DISABILITATO nel frontend (commit 2e2cf6c)"
echo "ma il server backend NON Ã¨ stato rimosso!"
echo ""
echo "Questo puÃ² causare:"
echo "  - Interferenza tra i due server"
echo "  - Consumo inutile di risorse"
echo "  - Confusione nel debugging"
echo ""

echo "âš ï¸  PROBLEMA CRITICO IDENTIFICATO #3:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âŒ TOKEN JWT NON VERIFICATO AL MOMENTO DEL MOUNT"
echo ""
echo "useWebSocket.ts controlla il token alla connessione (riga 163-168):"
echo ""
echo "  const token = getToken();"
echo "  if (!token) {"
echo "    console.warn('[WebSocket] No auth token, cannot connect');"
echo "    setState('disconnected');"
echo "    return;"
echo "  }"
echo ""
echo "Se il token non Ã¨ disponibile quando il componente monta:"
echo "  â†’ La connessione NON viene tentata"
echo "  â†’ Nessun retry automatico se il token arriva dopo"
echo "  â†’ Il componente rimane in stato 'disconnected' per sempre"
echo ""
echo "Possibili cause:"
echo "  - WebSocketSync monta prima che auth.token sia salvato in localStorage"
echo "  - Race condition tra login e mount del componente"
echo "  - Token scaduto e non rinnovato"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ RACCOMANDAZIONI DI FIX"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "âœ… FIX #1: SINGLETON WEBSOCKET (FRONTEND)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Creare UN'UNICA istanza WebSocket condivisa da tutti i componenti:"
echo ""
echo "Opzione A) WebSocket Context Provider (RACCOMANDATO)"
echo "  â””â”€â”€ WebSocketProvider wrappa l'app e fornisce una singola connessione"
echo ""
echo "Opzione B) Singleton Service"
echo "  â””â”€â”€ Convertire useWebSocket in un service globale con getInstance()"
echo ""
echo "Vantaggi:"
echo "  â€¢ Una sola connessione WebSocket"
echo "  â€¢ Gestione centralizzata dello stato"
echo "  â€¢ PiÃ¹ facile da debuggare"
echo "  â€¢ Meno consumo di risorse"
echo ""

echo "âœ… FIX #2: RIMUOVERE VECCHIO WEBSOCKET SERVER (BACKEND)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Eliminare il vecchio WebSocket server /ws/sync dal backend:"
echo ""
echo "File: backend/src/index.ts"
echo "Riga 97: export const wss = new WebSocketServer({ server, path: '/ws/sync' });"
echo ""
echo "Azioni:"
echo "  1. Rimuovere l'inizializzazione del vecchio server"
echo "  2. Rimuovere tutti i riferimenti a wss (grep per trovare usi)"
echo "  3. Mantenere SOLO WebSocketServerService su /ws/realtime"
echo ""

echo "âœ… FIX #3: GESTIRE TOKEN MANCANTE/SCADUTO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Aggiungere retry logic quando il token non Ã¨ disponibile:"
echo ""
echo "  1. Aggiungere listener su localStorage per rilevare quando il token cambia"
echo "  2. Tentare reconnect quando un token valido diventa disponibile"
echo "  3. Verificare che WebSocketSync monti DOPO che auth.token Ã¨ settato"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š PRIORITÃ€ DI INTERVENTO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ”´ PRIORITÃ€ ALTA:"
echo "  1. FIX #1 - Implementare WebSocket Singleton/Context"
echo "     â†’ Risolve il problema delle multiple connessioni"
echo ""
echo "ğŸŸ¡ PRIORITÃ€ MEDIA:"
echo "  2. FIX #2 - Rimuovere vecchio WebSocket server"
echo "     â†’ Pulizia e prevenzione di conflitti futuri"
echo ""
echo "ğŸŸ¢ PRIORITÃ€ BASSA:"
echo "  3. FIX #3 - Gestire token mancante/scaduto"
echo "     â†’ Potrebbe non essere necessario se Fix #1 risolve giÃ "
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ PIANO DI IMPLEMENTAZIONE DETTAGLIATO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "FASE 1: REFACTORING FRONTEND (Fix #1)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Step 1.1: Creare WebSocketContext"
echo "  File: frontend/src/contexts/WebSocketContext.tsx"
echo "  - Creare Context con useWebSocket hook al suo interno"
echo "  - Esportare WebSocketProvider e useWebSocketContext"
echo ""
echo "Step 1.2: Wrappare l'app con WebSocketProvider"
echo "  File: frontend/src/AppRouter.tsx"
echo "  - Aggiungere <WebSocketProvider> intorno alle routes autenticate"
echo "  - Rimuovere <WebSocketSync /> (sostituito dal provider)"
echo ""
echo "Step 1.3: Aggiornare useDraftSync e usePendingSync"
echo "  Files:"
echo "    - frontend/src/hooks/useDraftSync.ts"
echo "    - frontend/src/hooks/usePendingSync.ts"
echo "  - Sostituire useWebSocket() con useWebSocketContext()"
echo ""

echo "FASE 2: CLEANUP BACKEND (Fix #2)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Step 2.1: Rimuovere vecchio WebSocket server"
echo "  File: backend/src/index.ts"
echo "  - Commentare/rimuovere riga 97"
echo "  - Verificare con grep che non ci siano altri usi di 'wss'"
echo ""
echo "Step 2.2: Verificare dipendenze"
echo "  File: backend/src/price-endpoints.ts"
echo "  - Verificare se setWssInstance Ã¨ ancora necessario"
echo "  - Se sÃ¬, migrare a WebSocketServerService"
echo ""

echo "FASE 3: TESTING"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Step 3.1: Test connessione WebSocket"
echo "  - Effettuare login"
echo "  - Verificare log browser console: '[WebSocket] Connected'"
echo "  - Verificare log backend: 'WebSocket client authenticated'"
echo ""
echo "Step 3.2: Test admin panel"
echo "  - Aprire pagina admin"
echo "  - Verificare status: 'healthy' (verde) invece di 'idle'"
echo "  - Verificare 'Connessioni Attive' > 0"
echo ""
echo "Step 3.3: Test sync real-time"
echo "  - Creare draft order"
echo "  - Verificare sync immediato"
echo "  - Verificare log WebSocket eventi"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ VUOI PROCEDERE CON L'IMPLEMENTAZIONE?"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Prossimi passi:"
echo "  1. Conferma il piano di fix"
echo "  2. Implemento il refactoring con WebSocketContext"
echo "  3. Rimuovo il vecchio WebSocket server"
echo "  4. Testiamo la connessione"
echo ""
