# Plan 12-03: Production Operations & Automation

**Phase**: 12 - Deployment & Infrastructure
**Plan**: 12-03 - Graceful Shutdown, Monitoring, CI/CD, Blue-Green Deployment
**Status**: ðŸ”„ IN PROGRESS
**Created**: 2026-01-17
**Estimated Duration**: 12-16 hours total

---

## Context

Application successfully deployed to production (https://formicanera.com) with basic Docker orchestration. Now we need to add operational maturity:

1. **Graceful Shutdown** - Safe container restarts without interrupting operations
2. **Monitoring** - Observability with Prometheus + Grafana
3. **CI/CD Pipeline** - Automated build, test, deploy
4. **Blue-Green Deployment** - Zero-downtime deployments

---

## Prerequisites

âœ… **Phase 12-01**: VPS setup complete (Hetzner Cloud)
âœ… **Phase 12-02**: Docker orchestration complete (4 containers running)
âœ… **Application Live**: https://formicanera.com functional
âœ… **TypeScript Clean**: 0 compilation errors
âœ… **Admin User**: Created and tested

---

## Plan Structure

### Part A: Graceful Shutdown (2-3 hours)
**Goal**: Implement SIGTERM handling to wait for active operations

**Tasks**:
1. Add operation tracking to backend (in-flight jobs count)
2. Implement SIGTERM handler with drain period (max 60s)
3. Update Docker health check to reflect draining state
4. Test with simulated long-running operation
5. Document shutdown behavior

**Acceptance Criteria**:
- âœ… SIGTERM waits for active operations (max 60s timeout)
- âœ… No operations interrupted during container restart
- âœ… Health check returns unhealthy during drain
- âœ… Logs show graceful shutdown events

---

### Part B: Monitoring & Observability (3-4 hours)
**Goal**: Prometheus metrics + Grafana dashboards for production visibility

**Tasks**:
1. Add `prom-client` to backend for metrics export
2. Expose `/metrics` endpoint with:
   - HTTP request duration histogram
   - Active operations gauge
   - Job queue size/processing time
   - Puppeteer browser pool usage
   - Database query counts
3. Add Prometheus to docker-compose.yml
4. Add Grafana to docker-compose.yml
5. Create dashboards:
   - **System Overview**: CPU, memory, disk, network
   - **Application Health**: Request rate, error rate, latency
   - **Job Queue**: Queue depth, processing time, success rate
   - **Browser Pool**: Active contexts, browser restarts
6. Configure alerting rules (optional)

**Acceptance Criteria**:
- âœ… Prometheus scraping backend metrics every 15s
- âœ… Grafana dashboards accessible on https://formicanera.com/grafana
- âœ… At least 4 dashboards created and functional
- âœ… Metrics retained for 15 days

---

### Part C: CI/CD Pipeline (4-5 hours)
**Goal**: GitHub Actions for automated build, test, deploy

**Tasks**:
1. Create `.github/workflows/ci.yml`:
   - Trigger on push to master
   - Run TypeScript type checking (backend + frontend)
   - Run unit tests (backend + frontend)
   - Run integration tests (backend)
   - Build Docker images
   - Push to GitHub Container Registry (ghcr.io)
2. Create `.github/workflows/cd.yml`:
   - Trigger on successful CI + manual approval
   - SSH to VPS
   - Pull new images from ghcr.io
   - Run `docker compose pull && docker compose up -d`
   - Verify health checks
   - Rollback on failure
3. Add deployment secrets to GitHub:
   - `VPS_SSH_KEY` (private key for deploy user)
   - `VPS_HOST` (91.98.136.198)
   - `VPS_USER` (deploy)
4. Test CI/CD with dummy commit

**Acceptance Criteria**:
- âœ… CI runs on every push to master
- âœ… All tests pass in CI environment
- âœ… Docker images built and pushed to ghcr.io
- âœ… CD deploys to VPS with manual approval
- âœ… Health checks verified post-deploy
- âœ… Rollback tested and functional

---

### Part D: Blue-Green Deployment (3-4 hours)
**Goal**: Zero-downtime deployments with automated switch

**Tasks**:
1. Modify docker-compose.yml to support blue/green:
   - Add `backend-blue` and `backend-green` services
   - Add `frontend-blue` and `frontend-green` services
   - Nginx routes to active color (via environment variable)
2. Create deployment script `scripts/deploy-blue-green.sh`:
   - Detect current active color (blue or green)
   - Deploy to inactive color
   - Run health checks on inactive
   - Switch Nginx to new color (update env + reload)
   - Keep old color running for 5 minutes (rollback window)
   - Stop old color after verification
3. Update CI/CD to use blue-green script
4. Test deployment with simulated traffic

**Acceptance Criteria**:
- âœ… Deployments have zero downtime
- âœ… Active traffic never hits deploying container
- âœ… Rollback possible within 5 minutes
- âœ… Health checks gate traffic switch
- âœ… Logs show color switch events

---

## Technical Design

### Graceful Shutdown Architecture

```typescript
// backend/src/index.ts
let activeOperations = 0;
let isShuttingDown = false;

function incrementOps() { activeOperations++; }
function decrementOps() { activeOperations--; }

process.on('SIGTERM', async () => {
  console.log('SIGTERM received, draining...');
  isShuttingDown = true;

  // Mark unhealthy immediately
  app.get('/health', (req, res) => res.status(503).send('Draining'));

  // Wait for active operations (max 60s)
  const maxWait = 60000;
  const start = Date.now();

  while (activeOperations > 0 && Date.now() - start < maxWait) {
    await sleep(100);
  }

  console.log(`Drained ${activeOperations} operations in ${Date.now() - start}ms`);
  process.exit(0);
});
```

### Prometheus Metrics

```typescript
// backend/src/metrics.ts
import promClient from 'prom-client';

const register = new promClient.Registry();

export const httpDuration = new promClient.Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP request duration',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.5, 1, 2, 5, 10]
});

export const activeOps = new promClient.Gauge({
  name: 'active_operations',
  help: 'Number of active operations'
});

export const queueSize = new promClient.Gauge({
  name: 'job_queue_size',
  help: 'Number of jobs in queue'
});

register.registerMetric(httpDuration);
register.registerMetric(activeOps);
register.registerMetric(queueSize);

export { register };
```

### Blue-Green Docker Compose

```yaml
services:
  backend-blue:
    image: ghcr.io/h4tholdir/archibald-backend:${BLUE_VERSION}
    container_name: archibald-backend-blue
    # ... same config as backend

  backend-green:
    image: ghcr.io/h4tholdir/archibald-backend:${GREEN_VERSION}
    container_name: archibald-backend-green
    # ... same config as backend

  nginx-proxy:
    environment:
      - ACTIVE_COLOR=${ACTIVE_COLOR:-blue}
    volumes:
      - ./nginx/nginx.conf.template:/etc/nginx/templates/default.conf.template
```

### GitHub Actions CI/CD

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend deps
        run: cd archibald-web-app/backend && npm ci

      - name: Backend type check
        run: cd archibald-web-app/backend && npm run build

      - name: Backend tests
        run: cd archibald-web-app/backend && npm test

      - name: Install frontend deps
        run: cd archibald-web-app/frontend && npm ci

      - name: Frontend type check
        run: cd archibald-web-app/frontend && npm run type-check

      - name: Frontend tests
        run: cd archibald-web-app/frontend && npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./archibald-web-app/backend
          push: true
          tags: ghcr.io/h4tholdir/archibald-backend:${{ github.sha }},ghcr.io/h4tholdir/archibald-backend:latest

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./archibald-web-app/frontend
          push: true
          tags: ghcr.io/h4tholdir/archibald-frontend:${{ github.sha }},ghcr.io/h4tholdir/archibald-frontend:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/archibald-app
            docker compose pull
            ./scripts/deploy-blue-green.sh ${{ github.sha }}
```

---

## Execution Order

### Session 1: Graceful Shutdown (2-3h)
1. Add operation tracking
2. Implement SIGTERM handler
3. Test with long operation
4. Document behavior
5. Deploy and verify

### Session 2: Monitoring Setup (3-4h)
1. Add Prometheus metrics to backend
2. Update docker-compose with Prometheus + Grafana
3. Create Grafana dashboards
4. Configure retention
5. Test and verify metrics

### Session 3: CI/CD Pipeline (4-5h)
1. Create GitHub Actions workflows
2. Add deployment secrets
3. Test CI on feature branch
4. Test CD with manual approval
5. Document workflow

### Session 4: Blue-Green Deployment (3-4h)
1. Refactor docker-compose for colors
2. Create deployment script
3. Integrate with CI/CD
4. Test with dummy deployment
5. Document rollback procedure

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Graceful shutdown too slow | Medium | Medium | Tunable timeout, force kill after 60s |
| Prometheus high memory | Low | Medium | Configure retention, resource limits |
| CI/CD SSH access fails | Medium | High | Test SSH key beforehand, backup manual deploy |
| Blue-green switch race | Low | High | Atomic Nginx config switch, health checks |
| Docker image registry down | Low | High | Fallback to local build, cache images |

---

## Rollback Plan

### If Graceful Shutdown Breaks
- Revert SIGTERM handler commit
- Deploy previous Docker image
- Operations may be interrupted on restart (existing behavior)

### If Monitoring Breaks
- Stop Prometheus/Grafana containers
- No impact on application functionality
- Fix and redeploy monitoring stack

### If CI/CD Breaks
- Continue manual deployment (existing process)
- Fix GitHub Actions workflow
- Re-test on feature branch

### If Blue-Green Breaks
- Use `docker compose down && docker compose up -d` (downtime)
- Fix deployment script
- Test locally before production

---

## Success Criteria

### Part A: Graceful Shutdown
- [ ] No operations interrupted during 10 test restarts
- [ ] Shutdown logs show drain time < 60s
- [ ] Health check returns 503 during drain
- [ ] Documentation updated

### Part B: Monitoring
- [ ] Prometheus scraping 5+ metrics
- [ ] Grafana dashboards functional
- [ ] Metrics retained 15 days
- [ ] Alert on >10% error rate (optional)

### Part C: CI/CD
- [ ] CI runs on every push (5+ successful runs)
- [ ] CD deploys with approval (3+ successful deploys)
- [ ] Rollback tested and verified
- [ ] Documentation updated

### Part D: Blue-Green
- [ ] 5+ deployments with zero downtime
- [ ] Traffic switch verified with curl
- [ ] Rollback tested within 5 minutes
- [ ] Color indicator visible in logs

---

## Documentation Updates Required

1. **README.md**:
   - Add Monitoring section (Grafana access)
   - Add CI/CD section (workflow triggers)
   - Add Deployment section (blue-green process)

2. **OPERATIONS.md** (new):
   - Graceful shutdown behavior
   - Monitoring dashboard guide
   - Deployment procedures
   - Rollback procedures
   - Incident response playbook

3. **.planning/ROADMAP.md**:
   - Mark Plan 12-03 as complete
   - Update Phase 12 status

4. **.planning/milestones/12/12-03-SUMMARY.md**:
   - Document all implementations
   - Capture metrics and learnings

---

## Dependencies

**External**:
- GitHub Actions (free for public repos, included in private)
- GitHub Container Registry (ghcr.io)
- Prometheus image (docker.io/prom/prometheus)
- Grafana image (docker.io/grafana/grafana)

**Internal**:
- Phase 12-02 complete âœ…
- Docker Compose installed âœ…
- VPS SSH access âœ…
- Domain configured âœ…

---

## Notes

- **Graceful shutdown** most critical for production stability
- **Monitoring** provides visibility for troubleshooting
- **CI/CD** reduces manual deploy errors
- **Blue-green** eliminates downtime but adds complexity

Execute in order for progressive enhancement. Each part delivers independent value.

---

**Next Steps**: Begin with Part A (Graceful Shutdown) implementation.
