# Milestone v1.0: Archibald Stabilization

**Status:** SHIPPED 2026-02-21
**Phases:** 1-10
**Total Plans:** 33

## Overview

Riportare la PWA Archibald Black Ant a perfetto funzionamento dopo due grandi refactoring (eliminazione IndexedDB + queue unificata BullMQ). Si parte dalla pulizia del codice morto, si fixano i bug dal più critico al meno, si implementano le feature mancanti, e si chiude con una suite di test automatici completa (unit, integration, E2E) eseguibile anche in VPS.

## Phases

### Phase 1: Cleanup & Dead Code Removal
**Goal**: Codebase pulito senza file orfani, dead code o naming inconsistencies — base solida per i fix successivi
**Depends on**: Nothing (first phase)
**Research**: Unlikely (internal file operations)
**Plans**: 3 plans

Plans:
- [x] 01-01: Knip analysis + cancellare file orfani frontend (19 deleted) + commit baseline refactoring
- [x] 01-02: Fix naming sentToMilanoAt→sentToVeronaAt (code+DB), rimuovere legacy localStorage keys, rinominare .test.ts→.spec.ts, pulire dead exports
- [x] 01-03: Pulizia root directory (4 dir clutter, ~25 MD file, log, script debug), fix struttura .planning/, .gitignore

### Phase 2: Operation Queue Core Fixes
**Goal**: Preemption funzionante, sync interrompibili, nessun job duplicato, timeout su handler
**Depends on**: Phase 1
**Research**: Unlikely (fixing existing BullMQ patterns)
**Plans**: 3 plans

Plans:
- [x] 02-01: Implementare shouldStop() reale nei sync handlers collegato a agentLock.setStopCallback
- [x] 02-02: Fix race condition preemption (attendere stop effettivo) + aggiungere timeout handler
- [x] 02-03: Implementare deduplicazione idempotency key nella queue + aggiungere shouldStop() check nei loop sync

### Phase 3: Browser Pool & Concurrency
**Goal**: Nessuna race condition nel browser pool, concurrency per-utente, transazioni distribuite sicure
**Depends on**: Phase 2
**Research**: Unlikely (fixing existing Puppeteer pool logic)
**Plans**: 3 plans

Plans:
- [x] 03-01: Fix race condition browser pool user lock (lock rilasciato prima del completamento)
- [x] 03-02: Implementare concurrency per-utente nel worker BullMQ (utenti diversi in parallelo, 1 op/utente)
- [x] 03-03: Gestire fallimento transazione post-bot con compensating logic (submit-order, delete-order, send-to-verona)

### Phase 4: Sync Scheduler & Auto-Sync
**Goal**: Sync automatici funzionanti con intervalli configurabili da admin
**Depends on**: Phase 2
**Research**: Unlikely (fixing existing sync-scheduler.ts)
**Plans**: 3 plans

Plans:
- [x] 04-01: Sync settings persistence layer (migration 007-sync-settings.sql, repository CRUD, unit test)
- [x] 04-02: Refactor scheduler per-type intervals, async agent registry, bootstrap auto-start con DB intervals, API routes funzionanti
- [x] 04-03: Proteggere customer sync da parser failures (count validation) + warning monitoring API

### Phase 5: WebSocket & Real-time Events
**Goal**: Tutti i dispositivi ricevono aggiornamenti real-time per ogni operazione
**Depends on**: Phase 2, Phase 3
**Research**: Unlikely (extending existing WebSocket server)
**Plans**: 3 plans

Plans:
- [x] 05-01: Emettere eventi PENDING_CREATED/UPDATED/DELETED/SUBMITTED da pending-orders routes
- [x] 05-02: Emettere JOB_STARTED, JOB_PROGRESS, ORDER_NUMBERS_RESOLVED da operation-processor
- [x] 05-03: Decidere SSE vs WebSocket per progress, implementare soluzione scelta, riattivare UnifiedSyncProgress

### Phase 6: Data Integrity & Hardening
**Goal**: Dati corretti (IVA, hash), input validati, rate limiting, PDF persistenti
**Depends on**: Phase 4
**Research**: Unlikely (DB queries, crypto, Express middleware)
**Plans**: 4 plans

Plans:
- [x] 06-01: Fix IVA data flow (products.service.ts shape mismatch) + remove dead order-calculation code (VAT_RATE, calculateItemTotals, calculateOrderTotals, reverseCalculateGlobalDiscount)
- [x] 06-02: Standardizzare hashing a SHA-256 (eliminare MD5 da price-sync, order-sync, orders repo) + extract shared computeOrderHash
- [x] 06-03: Validazione parseInt con isNaN su route params + install express-rate-limit con 3 tier (global, strict, auth)
- [x] 06-04: PDF filesystem store con TTL cleanup (sostituire in-memory Map) + cleanup scheduler

### Phase 7: Missing Feature Implementation
**Goal**: Tutti gli endpoint stub attivamente usati dal frontend funzionanti
**Depends on**: Phase 3, Phase 5
**Research**: Likely (subclient data model, Arca export format, FT numbering)
**Research topics**: Archibald subclient data structure via bot, Arca export format, FT numbering convention
**Plans**: 3 plans

Plans:
- [x] 07-01: Passare createCustomerBot a createApp + verificare route interattive clienti funzionanti
- [x] 07-02: Implementare subclients API (getAll, search, getByCode, importSubclients via bot/PDF)
- [x] 07-03: Implementare getNextFtNumber (numerazione progressiva PostgreSQL) + exportArca + altri stub usati

### Phase 8: Unit & Integration Tests
**Goal**: Copertura test completa per tutti i fix critici e le feature core
**Depends on**: Phase 1-7
**Research**: Unlikely (Vitest already in use)
**Plans**: 5 plans

Plans:
- [x] 08-01: Unit test operation processor (preemption, shouldStop, timeout, lock acquire/release)
- [x] 08-02: Unit test agent lock (acquire, release, setStopCallback, preemptable detection)
- [x] 08-03: Unit test sync handlers (shouldStop interruption, progress callbacks, error handling)
- [x] 08-04: Integration test WebSocket events (emit + receive per tutti i 9+ eventi)
- [x] 08-05: Integration test sync services con PostgreSQL (customer, order, product, price sync con DB reale)

### Phase 9: E2E Tests & VPS Validation
**Goal**: Test end-to-end completi eseguiti contro la PWA deployata in VPS
**Depends on**: Phase 8
**Research**: Likely (Playwright remote testing, multi-device simulation)
**Research topics**: Playwright remote test config, multi-device test patterns, VPS test runner setup
**Plans**: 4 plans

Plans:
- [x] 09-01: Setup Playwright per test remoti contro VPS (config, auth fixtures, base URL)
- [x] 09-02: E2E test login flow (login, PIN setup, unlock, target wizard, logout, account switch)
- [x] 09-03: E2E test order flow (crea ordine, modifica, cancella, invia a Verona, verifica sync)
- [x] 09-04: E2E test multi-device sync (2 browser contexts, verifica real-time sync pending orders)

### Phase 10: Final Review & Stabilization
**Goal**: PWA verificata e stabile, pronta per uso quotidiano in produzione
**Depends on**: Phase 9
**Research**: Unlikely (internal verification)
**Plans**: 2 plans

Plans:
- [x] 10-01: Smoke test completo di tutte le funzionalità + fix regressioni trovate
- [x] 10-02: Deploy finale, verifica multi-dispositivo live, documentazione stato produzione

## Progress

**Execution Order:**
Phases execute in numeric order: 1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 9 → 10

| Phase | Plans Complete | Status | Completed |
|-------|---------------|--------|-----------|
| 1. Cleanup & Dead Code | 3/3 | Complete | 2026-02-20 |
| 2. Operation Queue Core | 3/3 | Complete | 2026-02-20 |
| 3. Browser Pool & Concurrency | 3/3 | Complete | 2026-02-20 |
| 4. Sync Scheduler & Auto-Sync | 3/3 | Complete | 2026-02-20 |
| 5. WebSocket & Real-time | 3/3 | Complete | 2026-02-20 |
| 6. Data Integrity & Hardening | 4/4 | Complete | 2026-02-20 |
| 7. Missing Features | 3/3 | Complete | 2026-02-20 |
| 8. Unit & Integration Tests | 5/5 | Complete | 2026-02-20 |
| 9. E2E Tests & VPS | 4/4 | Complete | 2026-02-21 |
| 10. Final Review | 2/2 | Complete | 2026-02-21 |

## Milestone Summary

**Key Decisions:**
- Concurrency per-utente (non globale) per il worker BullMQ
- IVA da database (excel admin + alert articoli)
- Sync intervals configurabili da admin
- File orfani cancellati direttamente (git safety net)
- PDF store su filesystem con TTL
- BullMQ native deduplication (Simple mode for syncs, Throttle mode for writes)
- bot_results table con compensating transaction pattern
- Per-type timers via Map<SyncType, NodeJS.Timeout>
- shouldSkipSync as pure function with count validation
- All processor broadcasts standardized to { type, payload, timestamp } format
- Filesystem PDF store with .pdf/.meta.json sidecar pattern
- Health check registered before rate limiting middleware
- MemoryStore for rate limiting (single-process VPS)

**Issues Resolved:**
- 23 bugs from original code review — all fixed
- Race conditions in browser pool, preemption, and lock management
- 13 stubs replaced with real implementations
- MD5 hashing replaced with SHA-256
- Missing input validation on route params
- No rate limiting on public APIs
- In-memory PDF storage not surviving restarts

**Issues Deferred:**
- ~50 unused type exports from Knip report (cosmetic, no runtime impact)

**Technical Debt Incurred:**
- SSE progress endpoint returns no-op (WebSocket provides real-time progress)
- Product sync has no hash-based deduplication (always UPDATEs)
- Frontend fetchWithRetry doesn't handle 429 responses

---

_For current project status, see .planning/ROADMAP.md_
