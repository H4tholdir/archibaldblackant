---
phase: 02-code-quality-foundation
plan: 08
type: tdd
---

<objective>
Add integration tests for sync services with mocked Puppeteer automation.

Purpose: Verify sync services work correctly with database integration, establish testing pattern for browser automation.
Output: Integration tests for customer-sync, product-sync, and price-sync services.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-code-quality-foundation/02-07-SUMMARY.md
@.planning/codebase/TESTING.md
@src/customer-sync-service.ts
@src/product-sync-service.ts
@src/price-sync-service.ts

**Tech stack:**
- Vitest with vi mocking
- Puppeteer (to be mocked)
- CustomerDatabase, ProductDatabase (use in-memory)

**From previous plans:**
- Database layer tested
- Unit test patterns established

**Testing approach:**
- Integration tests with database
- Mock Puppeteer page interactions
- Verify data flows from mock scraping → database
- Test error handling and edge cases
</context>

<feature>
  <name>CustomerSyncService Integration Tests</name>
  <files>src/customer-sync-service.ts, src/customer-sync-service.test.ts</files>
  <behavior>
CustomerSyncService sync operations with database:
- syncCustomers() with mocked Puppeteer → customers in database
- Pagination handling → all pages processed
- Database persistence → data survives sync
- Error handling → logs errors, doesn't crash

Mock Puppeteer interactions:
- Mock page.goto(), page.$(), page.evaluate()
- Return fake customer data (name, code, email)
- Simulate pagination (hasNextPage true/false)

Test cases:
- Sync single page → customers inserted
- Sync multiple pages → all customers inserted
- Sync with existing data → updates/inserts correctly
- Sync with error → handles gracefully, logs error
  </behavior>
  <implementation>
RED: Write failing integration tests
GREEN: Tests should pass (service already implemented, mocks correct)
REFACTOR: Extract mock factories, clean up test setup

Test structure:
```typescript
describe('CustomerSyncService integration', () => {
  let service: CustomerSyncService;
  let mockPage: any; // Puppeteer Page mock

  beforeEach(() => {
    // Setup in-memory database
    // Create service with mocked bot
    // Mock Puppeteer page interactions
  });

  it('should sync customers to database', async () => {
    // Mock page returns fake customer data
    // Run sync
    // Verify customers in database
  });

  it('should handle pagination', async () => { ... });
  it('should handle sync errors gracefully', async () => { ... });
});
```
  </implementation>
</feature>

<feature>
  <name>ProductSyncService and PriceSyncService Integration Tests</name>
  <files>src/product-sync-service.ts, src/product-sync-service.test.ts, src/price-sync-service.ts, src/price-sync-service.test.ts</files>
  <behavior>
ProductSyncService operations:
- syncProducts() → products in database
- Pagination → all pages processed
- Article code normalization → codes stored correctly

PriceSyncService operations:
- syncPrices() → prices in database
- Price parsing → numeric values correct
- Article matching → prices linked to products

Mock Puppeteer:
- Mock product list pages (article code, description)
- Mock price list pages (article code, price, discount)

Test cases:
- Sync products single page → products inserted
- Sync products multiple pages → all products present
- Sync prices → prices inserted and retrievable
- Price lookup → correct price for article
- Error handling → both services handle errors gracefully
  </behavior>
  <implementation>
RED: Write failing tests for both services
GREEN: Tests pass with correct mocks
REFACTOR: Share mock setup between test files

Test structure:
```typescript
describe('ProductSyncService integration', () => {
  // Similar structure to CustomerSyncService tests
  it('should sync products to database', async () => { ... });
  it('should normalize article codes', async () => { ... });
});

describe('PriceSyncService integration', () => {
  it('should sync prices to database', async () => { ... });
  it('should link prices to products', async () => { ... });
});
```
  </implementation>
</feature>

<verification>
- [ ] All CustomerSyncService integration tests pass
- [ ] All ProductSyncService integration tests pass
- [ ] All PriceSyncService integration tests pass
- [ ] npm test shows all tests green
- [ ] Puppeteer mocking works correctly
</verification>

<success_criteria>
- RED phase: Failing tests written and committed
- GREEN phase: Mocks correct, tests pass
- REFACTOR phase: Mock factories extracted (if needed)
- All 2-3 commits present
- Integration tests establish pattern for future service tests
- Phase 2 complete - testing foundation established
</success_criteria>

<output>
After completion, create `.planning/phases/02-code-quality-foundation/02-08-SUMMARY.md`:

# Phase 2 Plan 08: Integration Tests for Sync Services

**Sync services fully tested - [X] integration tests with mocked browser automation**

## Accomplishments

### RED - Failing Tests
- Wrote failing integration tests for CustomerSyncService
- Wrote failing integration tests for ProductSyncService
- Wrote failing integration tests for PriceSyncService
- [Why tests failed initially]

### GREEN - Passing Implementation
- All CustomerSyncService tests pass
- All ProductSyncService tests pass
- All PriceSyncService tests pass
- Puppeteer mocking pattern established

### REFACTOR - Cleanup
- [Mock factories extracted, or "None needed"]
- [Test setup shared between files, or "Tests remain independent"]

## Commits
- `test(02-08): add failing integration tests for sync services`
- `feat(02-08): [any implementation fixes, or "tests pass with mocks"]`
- `refactor(02-08): [cleanup if done]`

## Files Created/Modified

- `src/customer-sync-service.test.ts` - Integration tests
- `src/product-sync-service.test.ts` - Integration tests
- `src/price-sync-service.test.ts` - Integration tests
- [any service files if bugs found]

## Decisions Made

[Document decisions about Puppeteer mocking strategy, test isolation, data fixtures]

## Issues Encountered

[Document any problems and resolutions, or "None"]

## Phase 2 Complete

✅ **Code Quality Foundation Established**

All 8 plans completed:
- 02-01: Vitest framework setup ✅
- 02-02: Logger in sync services ✅
- 02-03: Logger in bot & pool ✅
- 02-04: Type any removed (database) ✅
- 02-05: Type any removed (services) ✅
- 02-06: Dead code removed ✅
- 02-07: Unit tests (database layer) ✅
- 02-08: Integration tests (sync services) ✅

**Outcomes:**
- Testing framework operational
- 36+ console.log replaced with logger
- 24+ type any removed (full type safety)
- Dead code cleaned up
- Comprehensive test suite established

**Ready for Phase 3: MVP Order Form**
</output>
