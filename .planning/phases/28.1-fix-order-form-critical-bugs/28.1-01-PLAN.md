---
phase: 28.1-fix-order-form-critical-bugs
plan: 01
type: execute
---

<objective>
Fix customer selection bug where dropdown shows/filters customers but clicking doesn't select them.

Purpose: Restore core order creation functionality - users must be able to select customers to create orders.
Output: Working customer selection with visible confirmation of selected customer.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28.1-fix-order-form-critical-bugs/28.1-CONTEXT.md
@archibald-web-app/frontend/src/components/OrderForm.tsx

**Root Cause Analysis (from CONTEXT.md):**
- Line 714-721: handleCustomerSelect sets state but dropdown closes immediately
- Suspected race condition: setShowCustomerDropdown(false) may trigger re-render before other state updates complete
- Missing event.stopPropagation() on dropdown click (line 2077)
- Outside click handler may fire before selection handler

**Key Decision (Phase 08-03):**
- Dexie startsWithIgnoreCase() for indexed search (<100ms performance)
- Cache-first strategy with API fallback

**Tech Stack Available:**
- React 18 with hooks
- IndexedDB via Dexie.js
- Inline styles (project convention)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diagnostic logging to customer selection flow</name>
  <files>archibald-web-app/frontend/src/components/OrderForm.tsx</files>
  <action>
Add comprehensive console.log statements to debug customer selection:

1. In handleCustomerSearchChange (line 724-732):
   - Log when search value changes
   - Log filteredCustomers.length after filter

2. In handleCustomerSelect (line 714-721):
   - Log customer object received
   - Log state BEFORE updates (customerId, customerName)
   - Log immediately after each setState call
   - Add useEffect to log state AFTER updates complete

3. Add logging to dropdown render (line 2066-2088):
   - Log showCustomerDropdown value
   - Log filteredCustomers.length
   - Log when dropdown item is clicked

This diagnostic logging will help us see exactly where the state update fails.
DO NOT make any functional changes yet - only add logging.
  </action>
  <verify>
Open browser console, try selecting a customer, confirm logs appear showing:
1. Customer object logged on click
2. State values before/after updates
3. Dropdown visibility state changes
  </verify>
  <done>All diagnostic logs present in correct locations, no functional changes made</done>
</task>

<task type="auto">
  <name>Task 2: Fix race condition in customer selection handler</name>
  <files>archibald-web-app/frontend/src/components/OrderForm.tsx</files>
  <action>
Fix the race condition in handleCustomerSelect (lines 714-721):

1. **Add event.stopPropagation() and event.preventDefault()**:
   - Update dropdown onClick (line 2077) to: `onClick={(e) => { e.stopPropagation(); e.preventDefault(); handleCustomerSelect(customer); }}`
   - Prevents event bubbling that might trigger outside click handler

2. **Delay dropdown close to allow state updates**:
   ```typescript
   const handleCustomerSelect = (customer: Customer) => {
     console.log("[Customer] Selected:", customer.id, customer.name);

     // Update state first
     setCustomerId(customer.id);
     setCustomerName(customer.name);
     setCustomerSearch(customer.name);

     // Delay dropdown close by 100ms to ensure state updates complete
     setTimeout(() => {
       setShowCustomerDropdown(false);
     }, 100);

     console.log("[Customer] State updated - customerId:", customer.id);
   };
   ```

3. **Verify "✅ Cliente selezionato" section appears**:
   - The section at lines 2092-2097 should become visible after selection
   - It depends on `customerId` being set

DO NOT remove diagnostic logs yet - keep them for verification.
AVOID changing dropdown positioning or styling - focus only on state management.
  </action>
  <verify>
1. npm run dev
2. Navigate to order form
3. Click customer dropdown
4. Select a customer
5. Confirm: Customer name appears in input field
6. Confirm: "✅ Cliente selezionato: [name] (ID: [id])" section appears
7. Confirm: Console logs show successful state update
  </verify>
  <done>Customer selection works - input shows name, confirmation section appears, state updates logged successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed customer selection in order form with event propagation fix and delayed dropdown close</what-built>
  <how-to-verify>
1. Run: `cd archibald-web-app/frontend && npm run dev`
2. Visit: http://localhost:5173 (or assigned port)
3. Navigate to order creation form
4. Test customer selection:
   a. Click on "Cliente" input field
   b. Verify dropdown appears with customer list
   c. Type a few letters to filter (e.g., "ros")
   d. Verify dropdown filters to matching customers only
   e. Click on a customer in the dropdown
   f. **EXPECTED**: Customer name appears in input field
   g. **EXPECTED**: Green "✅ Cliente selezionato: [name] (ID: [id])" section appears below
   h. **EXPECTED**: Dropdown closes
5. Check browser console:
   - Should see logs confirming state update
   - Should NOT see errors
6. Test again with different customer to confirm repeatable
7. Test edge cases:
   - Very long customer names
   - Customers with special characters
   - Clicking customer at bottom of dropdown
  </how-to-verify>
  <resume-signal>Type "approved" if customer selection works correctly, or describe any issues observed</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Clean up diagnostic logging</name>
  <files>archibald-web-app/frontend/src/components/OrderForm.tsx</files>
  <action>
Remove all diagnostic console.log statements added in Task 1, EXCEPT:
- Keep the existing "[Customer] Selected:" log at line 715
- Keep the existing "[Customer] State updated" log at line 720

Remove:
- All new logs added to handleCustomerSearchChange
- All new logs added to handleCustomerSelect (except the 2 existing ones)
- All new logs added to dropdown render section
- The useEffect that logs state changes

This returns the code to production-ready state with only essential logging.
  </action>
  <verify>
1. Search for "console.log" in OrderForm.tsx
2. Confirm only essential logs remain (not the diagnostic ones from Task 1)
3. npm run build succeeds without warnings
  </verify>
  <done>Diagnostic logs removed, only 2 essential customer logs remain, build passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Customer can be selected from dropdown
- [ ] Customer name appears in input field after selection
- [ ] "✅ Cliente selezionato" confirmation section appears
- [ ] Dropdown closes after selection
- [ ] No console errors appear
- [ ] Build succeeds without warnings
- [ ] Diagnostic logs cleaned up
</verification>

<success_criteria>
- All tasks completed
- User can successfully select customers from dropdown
- Visual confirmation of selected customer appears
- No race condition - selection works every time
- Code is production-ready (diagnostic logs removed)
</success_criteria>

<output>
After completion, create `.planning/phases/28.1-fix-order-form-critical-bugs/28.1-01-SUMMARY.md`:

# Phase 28.1 Plan 01: Fix Customer Selection Bug - Summary

**Customer selection in order form restored - dropdown click now properly selects customer**

## Accomplishments

- Fixed race condition between state updates and dropdown close
- Added event propagation fix to prevent outside click handler interference
- Delayed dropdown close by 100ms to ensure state updates complete
- Verified "✅ Cliente selezionato" confirmation section appears
- Customer selection now works reliably and repeatedly

## Files Modified

- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Fixed handleCustomerSelect race condition, added event.stopPropagation()

## Root Cause

Race condition: `setShowCustomerDropdown(false)` was causing immediate re-render before `setCustomerId` and `setCustomerName` updates completed. Combined with missing event propagation control, click events were bubbling and triggering outside click handlers before selection handler completed.

## Fix Applied

1. Added `event.stopPropagation()` and `event.preventDefault()` to dropdown click handler
2. Delayed dropdown close with 100ms setTimeout to allow state updates to complete
3. Preserved React state batching while ensuring UI feedback appears

## Issues Encountered

[Document any issues during testing, or "None"]

## Testing Results

- ✅ Customer selection works on first try
- ✅ Selection repeatable multiple times
- ✅ Visual confirmation appears correctly
- ✅ No console errors
- ✅ Edge cases tested (long names, special characters)

## Next Step

Ready for 28.1-02-PLAN.md (Fix Product Filtering Bug)
</output>
