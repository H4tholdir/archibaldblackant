# Phase 28.1: Fix Order Form Critical Bugs

## ðŸ”´ CRITICAL PRODUCTION BLOCKER

**Status**: Not planned yet
**Priority**: URGENT - Order creation completely broken
**Depends on**: Phase 28
**Created**: 2026-01-23

---

## Problem Statement

La scheda per creare ordini nella PWA ha tre bug critici che bloccano completamente la funzionalitÃ :

1. **Selezione clienti non funziona**:
   - La lista clienti appare quando si clicca nel campo
   - I clienti vengono filtrati correttamente quando si digita il nome
   - **MA**: quando si clicca su un cliente, NON viene selezionato
   - Il campo rimane vuoto e l'ordine non puÃ² essere creato

2. **Filtro articoli non funziona**:
   - Si prova a digitare un codice articolo (es: "h129fsq.104.023")
   - **NON filtra nessun risultato** - dropdown rimane vuoto
   - Impossibile selezionare articoli per codice

3. **Schermata bianca su submit**:
   - Si riesce a selezionare un articolo e un cliente (in qualche modo)
   - Si preme su "Aggiungi articolo"
   - **La PWA mostra una schermata bianca** (crash completo)
   - App diventa inutilizzabile

**Impact**: Ordini non possono essere creati - funzionalitÃ  core della PWA completamente bloccata.

---

## Technical Analysis

### Component Architecture

**File**: `/archibald-web-app/frontend/src/components/OrderForm.tsx` (2663 lines)

**Key Dependencies**:
- `cache-service.ts` - IndexedDB caching layer
- `draft-service.ts` - Draft order persistence
- `db/schema.ts` - Dexie IndexedDB schema
- `/api/customers`, `/api/products` - Backend API fallbacks

### Data Flow

```
Mount
  â†“
Load Customers (useEffect 541-621)
  â†’ Smart sync: /api/customers/smart-sync
  â†’ IndexedDB cache: cacheService.searchCustomers("", 10000)
  â†’ API fallback: /api/customers
  â†’ State: setCustomers(cachedCustomers)

Load Products (useEffect 623-678)
  â†’ IndexedDB cache: cacheService.searchProducts("", 10000)
  â†’ Map to Product type with article field (line 635-643)
  â†’ API fallback: /api/products
  â†’ State: setProducts(mappedProducts)

User Types in Customer Field
  â†“
handleCustomerSearchChange (724-732)
  â†’ setCustomerSearch(value)
  â†’ Clear customerId and customerName
  â†’ filteredCustomers computed (681-690)

Dropdown Shows (2066-2088)
  â†’ Conditions: showCustomerDropdown && customers.length > 0 && filteredCustomers.length > 0
  â†’ Shows top 10 filtered results

User Clicks Customer
  â†“
handleCustomerSelect (714-721)
  â†’ setCustomerId(customer.id)
  â†’ setCustomerName(customer.name)
  â†’ setCustomerSearch(customer.name)
  â†’ setShowCustomerDropdown(false)
  âš ï¸ POTENTIAL ISSUE: State update might not trigger re-render

User Types in Product Field
  â†“
handleProductSearchChange (773-779)
  â†’ setProductSearch(value)
  â†’ filteredProducts memoized (691-711)
  âš ï¸ ISSUE: Filter checks product.article field
  âš ï¸ If article field is undefined/null, filter fails

Dropdown Shows (2147-2178)
  â†’ Condition: showProductDropdown && filteredProducts.length > 0
  âš ï¸ If filteredProducts is empty, dropdown never appears

User Clicks Product
  â†“
handleProductSelect (735-763)
  â†’ Parses packageContent for constraints
  â†’ Sets newItem state
  â†’ Sets productSearch to product.name

User Clicks "Aggiungi Articolo"
  â†“
handleAddItem (820-877)
  â†’ Validates articleCode and quantity
  â†’ Validates package constraints
  â†’ setDraftItems([...prev, newItem])
  âš ï¸ POTENTIAL CRASH: If newItem has invalid data or state update fails

User Clicks "Fine" or "ðŸš€ Create Order"
  â†“
handleConfirmOrder (997-1012)
  â†’ Checks pricingError
  â†’ Checks cache staleness: cacheService.isCacheStale()
  âš ï¸ POTENTIAL CRASH: Unhandled promise rejection
  â†’ calls submitOrder()

submitOrder (1015-1077)
  â†’ Creates draftData object
  â†’ Calls saveDraftOrder() or updateDraftOrder()
  â†’ Clears IndexedDB: draftService.clearDraft()
  âš ï¸ POTENTIAL CRASH: IndexedDB operations can throw
  â†’ Shows success alert
```

---

## Root Cause Analysis

### Bug #1: Customer Selection Broken

**Location**: Lines 714-721, 2040-2097

**Suspected Causes**:

1. **Race Condition with Dropdown Close**:
   ```typescript
   const handleCustomerSelect = (customer: Customer) => {
     setCustomerId(customer.id);
     setCustomerName(customer.name);
     setCustomerSearch(customer.name);
     setShowCustomerDropdown(false);  // â† Dropdown closes immediately
   };
   ```
   - Setting `showCustomerDropdown(false)` might cause component to re-render before other state updates complete
   - React batches state updates, but timing could be off

2. **Input Ref Lost Focus**:
   - Line 2042: `ref={customerInputRef}`
   - Clicking dropdown item might not properly handle focus
   - Input value might reset before state update completes

3. **Event Propagation Issue**:
   - Line 2077: `onClick={() => handleCustomerSelect(customer)}`
   - Click event might bubble up and trigger other handlers
   - Need `event.stopPropagation()` or `event.preventDefault()`

4. **Dropdown Outside Click Handler**:
   - Lines 2115-2139: `productDropdownRef` with `useEffect` to close on outside click
   - Similar pattern likely exists for customerDropdownRef
   - Outside click handler might fire before selection handler

**Evidence Needed**:
- Console logs showing state updates
- Check if `customerId` is actually set in React DevTools
- Verify dropdown closes before/after state update

---

### Bug #2: Product Filtering Broken

**Location**: Lines 691-711, 623-678

**Suspected Causes**:

1. **Missing `article` Field in Product Data**:
   ```typescript
   const mappedProducts = cachedProducts.map((p) => ({
     id: p.id,
     name: p.name,
     article: p.article,  // â† If undefined, filter fails
     description: p.description,
     ...
   }));
   ```
   - If IndexedDB cache has products without `article` field, mapping preserves undefined
   - Filter logic (line 704-705) checks `product.article.toLowerCase().includes(searchLower)`
   - If `product.article` is undefined, this throws or returns false

2. **API Fallback Missing Article Field**:
   - Lines 650-661: API fallback loads products from `/api/products`
   - If API response doesn't include `article` field, products won't be searchable by code
   - Backend might be returning different schema than IndexedDB cache

3. **Search Normalization Issue**:
   - Article codes have dots: "h129fsq.104.023"
   - User might type with spaces: "h129fsq 104 023"
   - Filter uses `.includes()` which requires exact match (case-insensitive)
   - Need normalization: remove dots/spaces before comparison

4. **Cache Empty or Corrupted**:
   - If `cachedProducts.length === 0`, API fallback loads
   - If API also returns 0 products, `products` array stays empty
   - No error shown to user - silent failure

**Evidence Needed**:
- Check IndexedDB schema for products table
- Verify `article` field exists in product records
- Check API response structure from `/api/products`
- Test search with exact article code match

---

### Bug #3: White Screen on Submit

**Location**: Lines 820-877, 997-1077

**Suspected Causes**:

1. **Unhandled Exception in handleAddItem**:
   ```typescript
   const handleAddItem = () => {
     // No try-catch wrapper
     if (packageConstraints) {
       const multiple = packageConstraints.multipleQty;
       if (newItem.quantity % multiple !== 0) { // â† Could throw if NaN
         alert(...);
       }
     }
     setDraftItems((prev) => [...prev, { ...newItem }]); // â† Could fail
   };
   ```
   - If `packageConstraints.multipleQty` is NaN or undefined, modulo operation throws
   - If `newItem` has invalid data structure, array spread fails
   - No error boundary to catch render errors

2. **IndexedDB Operation Failure**:
   ```typescript
   await draftService.clearDraft(); // Line 1053
   ```
   - If IndexedDB quota exceeded, operation throws QuotaExceededError
   - If IndexedDB is blocked (Firefox private mode), throws InvalidStateError
   - Error caught by try-catch (lines 1071-1073) but might crash before reaching try block

3. **Cache Staleness Check Throws**:
   ```typescript
   const isStale = await cacheService.isCacheStale(); // Line 1005
   ```
   - If cache service throws, promise rejection is unhandled
   - Component crashes before reaching try-catch in submitOrder

4. **Invalid draftData Structure**:
   ```typescript
   const draftData = {
     customerId,    // â† Could be empty string
     customerName,  // â† Could be empty string
     items: draftItems.map((item) => ({...})),  // â† Could be empty array
   };
   ```
   - If customerId is empty, `saveDraftOrder()` might throw validation error
   - If items array is empty, backend might reject

5. **Pricing Calculation Error**:
   ```typescript
   if (pricingError) {  // Line 999
     alert(pricingError);
     return;
   }
   ```
   - If `calculatePricing()` throws exception instead of returning error string
   - Component crashes before reaching this check

**Evidence Needed**:
- Check browser console for error stack trace
- Test with Chrome DevTools error breakpoints enabled
- Check IndexedDB quota usage
- Verify error boundary exists in parent component

---

## Files to Investigate

### Primary File:
- `/archibald-web-app/frontend/src/components/OrderForm.tsx` (2663 lines)
  - Lines 541-678: Data loading useEffects
  - Lines 681-711: Filter logic
  - Lines 714-877: Event handlers
  - Lines 997-1077: Form submission
  - Lines 2040-2179: Customer and product input fields

### Supporting Files:
- `/archibald-web-app/frontend/src/services/cache-service.ts`
  - Lines 70-130: searchProducts() method
  - Lines 35-69: searchCustomers() method
  - Method: isCacheStale()

- `/archibald-web-app/frontend/src/services/draft-service.ts`
  - Lines 18-47: saveDraft() method
  - Lines 60-67: clearDraft() method

- `/archibald-web-app/frontend/src/db/schema.ts`
  - Products table schema
  - Customers table schema
  - IndexedDB version migrations

- `/archibald-web-app/backend/src/routes/products.ts`
  - GET /api/products endpoint schema
  - Verify `article` field is returned

- `/archibald-web-app/backend/src/routes/customers.ts`
  - GET /api/customers endpoint schema
  - POST /api/customers/smart-sync endpoint

### CSS/Styling:
- Autocomplete dropdown positioning (might hide selected customer feedback)
- Check if "âœ… Cliente selezionato" section (lines 2092-2097) is visible

---

## Diagnostic Steps

### For Bug #1 (Customer Selection):

1. **Add Console Logging**:
   ```typescript
   const handleCustomerSelect = (customer: Customer) => {
     console.log('[DEBUG] Before state update:', { customerId, customerName });
     console.log('[DEBUG] Selecting customer:', customer);

     setCustomerId(customer.id);
     setCustomerName(customer.name);
     setCustomerSearch(customer.name);

     console.log('[DEBUG] After state update (same render):', { customerId, customerName });
     setShowCustomerDropdown(false);
   };

   // Add useEffect to log state changes
   useEffect(() => {
     console.log('[DEBUG] customerId changed:', customerId);
     console.log('[DEBUG] customerName changed:', customerName);
   }, [customerId, customerName]);
   ```

2. **Test State Update**:
   - Open React DevTools
   - Click customer in dropdown
   - Check if `customerId` and `customerName` state actually update
   - Verify "âœ… Cliente selezionato" section appears

3. **Check Event Propagation**:
   ```typescript
   onClick={(e) => {
     e.stopPropagation();
     e.preventDefault();
     handleCustomerSelect(customer);
   }}
   ```

4. **Test with Delayed Dropdown Close**:
   ```typescript
   const handleCustomerSelect = (customer: Customer) => {
     setCustomerId(customer.id);
     setCustomerName(customer.name);
     setCustomerSearch(customer.name);

     // Delay dropdown close to allow state update to complete
     setTimeout(() => {
       setShowCustomerDropdown(false);
     }, 100);
   };
   ```

### For Bug #2 (Product Filtering):

1. **Check IndexedDB Data**:
   - Open Chrome DevTools â†’ Application â†’ IndexedDB â†’ ArchibaldOfflineDB
   - Inspect `products` table
   - Verify `article` field exists and has values
   - Check a few product records for article codes

2. **Add Diagnostic Logging**:
   ```typescript
   const filteredProducts = useMemo(() => {
     console.log('[DEBUG] Filter input:', {
       productsLength: products.length,
       productSearch,
       firstProduct: products[0],
     });

     if (!productSearch) return products;

     const searchLower = productSearch.toLowerCase();
     const filtered = products.filter((product) => {
       const matches = {
         name: product.name?.toLowerCase().includes(searchLower),
         article: product.article?.toLowerCase().includes(searchLower),
         id: product.id?.toLowerCase().includes(searchLower),
         description: product.description?.toLowerCase().includes(searchLower),
       };
       console.log('[DEBUG] Product match:', product.id, matches);
       return Object.values(matches).some(v => v);
     });

     console.log('[DEBUG] Filtered results:', filtered.length);
     return filtered;
   }, [products, productSearch]);
   ```

3. **Test API Response**:
   - Open Network tab
   - Clear cache
   - Reload page
   - Check `/api/products` response
   - Verify response includes `article` field

4. **Test with Sample Data**:
   ```typescript
   // Temporarily hardcode test product
   useEffect(() => {
     setProducts([{
       id: 'TEST001',
       name: 'Test Product',
       article: 'h129fsq.104.023',
       description: 'Test',
       price: 10.00,
       packageContent: '5',
     }]);
   }, []);
   ```

### For Bug #3 (White Screen):

1. **Add Error Boundaries**:
   ```typescript
   class ErrorBoundary extends React.Component {
     componentDidCatch(error, errorInfo) {
       console.error('[ERROR BOUNDARY]', error, errorInfo);
       alert(`App crashed: ${error.message}`);
     }
     render() {
       return this.props.children;
     }
   }

   // Wrap OrderForm in ErrorBoundary
   ```

2. **Add Try-Catch to Event Handlers**:
   ```typescript
   const handleAddItem = () => {
     try {
       // Existing logic
       if (!newItem.articleCode || newItem.quantity <= 0) {
         alert("Inserisci nome prodotto e quantitÃ ");
         return;
       }
       // ... rest of validation
       setDraftItems((prev) => [...prev, { ...newItem }]);
     } catch (error) {
       console.error('[ERROR] handleAddItem failed:', error);
       alert(`Errore durante l'aggiunta: ${error.message}`);
     }
   };
   ```

3. **Add Validation Before State Updates**:
   ```typescript
   const handleAddItem = () => {
     // Validate newItem structure
     if (!newItem || typeof newItem !== 'object') {
       console.error('[ERROR] Invalid newItem:', newItem);
       alert('Errore: dati articolo non validi');
       return;
     }

     // Validate packageConstraints
     if (packageConstraints && typeof packageConstraints.multipleQty !== 'number') {
       console.error('[ERROR] Invalid packageConstraints:', packageConstraints);
       alert('Errore: vincoli package non validi');
       return;
     }

     // ... existing logic
   };
   ```

4. **Enable Break on Caught Exceptions**:
   - Chrome DevTools â†’ Sources â†’ Pause on exceptions (checkbox)
   - Enable "Pause on caught exceptions"
   - Reproduce the white screen
   - Debugger will break at the exact line that throws

5. **Check Console for Errors**:
   - Open Console before reproducing bug
   - Look for red error messages
   - Check for warnings about state updates
   - Look for IndexedDB errors

---

## Success Criteria

Phase 28.1 is complete when:

1. **Customer Selection Works**:
   - [ ] User clicks customer in dropdown
   - [ ] Customer is selected (customerId and customerName state set)
   - [ ] "âœ… Cliente selezionato" section appears with correct name
   - [ ] Input field shows selected customer name
   - [ ] Dropdown closes after selection
   - [ ] Can create order with selected customer

2. **Product Filtering Works**:
   - [ ] User types article code (e.g., "h129fsq.104.023")
   - [ ] Dropdown shows matching products
   - [ ] Can select product by article code
   - [ ] Article codes from IndexedDB cache are searchable
   - [ ] Article codes from API fallback are searchable
   - [ ] Case-insensitive search works
   - [ ] Dot-separated codes (XX.XX.XXX.XXX) are searchable

3. **No White Screen on Submit**:
   - [ ] User selects customer
   - [ ] User selects product
   - [ ] User sets quantity
   - [ ] User clicks "Aggiungi articolo"
   - [ ] Article is added to draft list (no crash)
   - [ ] User clicks "Fine" or "ðŸš€ Create Order"
   - [ ] Confirmation modal appears (no crash)
   - [ ] User confirms order
   - [ ] Success message appears (no crash)
   - [ ] Form clears and ready for next order

4. **Error Handling Robust**:
   - [ ] All try-catch blocks cover critical operations
   - [ ] Error boundary catches render errors
   - [ ] User sees helpful error messages (not generic "Error")
   - [ ] Console logs provide actionable debugging info
   - [ ] IndexedDB failures don't crash app
   - [ ] API failures don't crash app

5. **Regression Testing**:
   - [ ] Voice input still works
   - [ ] Draft orders still save
   - [ ] Offline mode still works
   - [ ] Price calculations still work
   - [ ] Package constraints still work
   - [ ] All existing tests still pass

---

## Testing Strategy

### Unit Tests:
- Test `filteredProducts` memo with various search inputs
- Test `filteredCustomers` filter with various inputs
- Test `handleCustomerSelect` state updates
- Test `handleProductSelect` with missing fields
- Test `handleAddItem` with invalid inputs
- Test `submitOrder` error handling

### Integration Tests:
- Test full customer selection flow
- Test full product selection flow
- Test full order creation flow
- Test with empty IndexedDB cache
- Test with API fallback
- Test with network errors

### Manual UAT:
- Test on Chrome desktop
- Test on Firefox desktop
- Test on Safari mobile
- Test with slow network (throttling)
- Test with IndexedDB disabled
- Test with JavaScript debugger (should not break workflow)

---

## Related Issues

- Phase 3: MVP Order Form (original implementation)
- Phase 4: Voice Input Enhancement (might be affected)
- Phase 8: Offline Capability (IndexedDB dependencies)
- Phase 19.1: Product Cards UI Enhancement (product data structure)

---

## Notes

- This is a CRITICAL blocker - must be fixed before any new features
- User reported the bug directly - high priority
- All three bugs might be related to same root cause (state management)
- Consider adding comprehensive error tracking (Sentry/LogRocket)
- Consider adding integration test coverage for form workflows

