---
phase: 29-websocket-server-infrastructure
plan: 01
type: execute
---

<objective>
Setup Node.js WebSocket server dedicato per real-time draft/pending operations con autenticazione JWT, connection manager e broadcast capabilities.

Purpose: Sostituire polling HTTP (ogni 15s) con WebSocket bidirectional real-time (<100ms latency) per draft/pending orders multi-device.
Output: WebSocket server funzionante con JWT auth, connection pool, broadcast rooms per user, health monitoring.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@SYNC-ARCHITECTURE-RESEARCH.md

**Research findings:**
- WebSocket scelto vs SSE per bi-direzionalità (client ↔ server)
- Server = single source of truth (no tombstones needed)
- Target latency: < 100ms per ogni operazione
- Benefici attesi: 150x faster (0.05s vs 15s), 75% less code

**Tech stack available:**
- ws 8.19.0 (già installato, usato per sync progress)
- Express 4.18.2 + Node.js 18+
- JWT auth con jose 6.1.3 (Phase 6)
- TypeScript strict mode
- Winston logger

**Established patterns:**
- Singleton services con getInstance()
- EventEmitter per progress updates
- Structured logging (Winston)
- JWT middleware authenticateJWT

**Constraining decisions:**
- Mantenere ws library (no socket.io) per consistency
- JWT auth già implementato (8h expiry)
- Backend stateless HTTP (session state in Redis)

**Current WebSocket usage:**
- Location: backend/src/index.ts line 22
- Purpose: Sync progress broadcast (unidirezionale)
- Pattern: EventEmitter → WebSocket broadcast → Frontend

**Issues being addressed:**
- Bug #1: Draft deletion non funziona (DRAFT-DELETION-ANALYSIS.md)
- Complex sync logic (~2000 lines, 5 bugs identified)
- 15s polling latency troppo lento
- Tombstones accumulation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocket Server Service with JWT Authentication</name>
  <files>backend/src/websocket-server.ts, backend/src/types.ts</files>
  <action>
Create WebSocketServer class (Singleton pattern) che gestisce:
- WebSocket.Server su path dedicato (/ws/realtime)
- JWT authentication durante handshake (verifica token nel query param ?token= o header)
- Connection pool: Map<userId, Set<WebSocket>> per broadcast per-user
- Event types: DRAFT_CREATED, DRAFT_UPDATED, DRAFT_DELETED, DRAFT_CONVERTED, PENDING_CREATED, PENDING_UPDATED, PENDING_DELETED
- Error handling: log con Winston, graceful disconnect
- Health monitoring: connection count, active users

Implementare metodi:
- initialize(server: http.Server): void - Attach WebSocket al server HTTP esistente
- authenticateConnection(ws, request): Promise<string> - Verifica JWT e ritorna userId
- registerConnection(userId, ws): void - Aggiungi alla connection pool
- unregisterConnection(userId, ws): void - Rimuovi dalla pool
- broadcast(userId, event): void - Invia evento a tutti device dell'utente
- broadcastToAll(event): void - Broadcast globale (admin features)
- getStats(): object - Stats per monitoring

TypeScript interface in types.ts:
- WebSocketMessage { type: string, payload: any, timestamp: string }
- ConnectionStats { totalConnections: number, activeUsers: number }

AVOID socket.io library (use ws for consistency with existing stack). AVOID storing passwords or credentials in WebSocket context. AVOID keeping connections alive indefinitely (implement ping/pong heartbeat).
  </action>
  <verify>
1. TypeScript compiles without errors: npm run build
2. WebSocketServer exports getInstance() method
3. Types defined in types.ts include WebSocketMessage and ConnectionStats
4. Winston logger importato e usato per error logging
  </verify>
  <done>
- WebSocketServer class created with Singleton pattern
- JWT authentication implemented in authenticateConnection()
- Connection pool Map<userId, Set<WebSocket>> implemented
- broadcast() and broadcastToAll() methods defined
- getStats() method returns connection metrics
- TypeScript strict mode compliant
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate WebSocket Server with Express App</name>
  <files>backend/src/index.ts</files>
  <action>
Integrare WebSocketServer nel server Express esistente:
1. Import WebSocketServer.getInstance()
2. Dopo server.listen(), chiamare wsServer.initialize(httpServer)
3. Aggiungere endpoint REST per stats: GET /api/websocket/stats (requireAdmin middleware)
4. Aggiungere graceful shutdown: process SIGTERM chiude tutte le connections prima di terminare
5. Log startup: "WebSocket server initialized on /ws/realtime"

Modificare existing WebSocket sync progress (se presente) per coesistere su path diverso (/ws/sync vs /ws/realtime).

AVOID closing existing /ws/sync endpoint used for sync progress (mantienilo funzionante). AVOID blocking HTTP server startup se WebSocket fallisce (log error and continue). AVOID synchronous operations during shutdown (use async/await for graceful closure).
  </action>
  <verify>
1. Server starts successfully: npm start (no errors)
2. Winston log shows "WebSocket server initialized on /ws/realtime"
3. GET /api/websocket/stats returns { totalConnections: 0, activeUsers: 0 }
4. Existing /ws/sync endpoint still functional (if present)
5. SIGTERM triggers graceful shutdown with connection closure
  </verify>
  <done>
- WebSocketServer initialized after server.listen()
- GET /api/websocket/stats endpoint returns connection metrics
- Graceful shutdown implemented for SIGTERM/SIGINT
- Winston logging confirms WebSocket server startup
- No conflicts with existing /ws/sync endpoint
- TypeScript strict mode compliant, no compilation errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>WebSocket server con JWT auth e connection management integrato in Express</what-built>
  <how-to-verify>
1. Start server: cd backend && npm start
2. Check logs: Should see "WebSocket server initialized on /ws/realtime"
3. Test stats endpoint: curl http://localhost:3000/api/websocket/stats (should return { totalConnections: 0, activeUsers: 0 })
4. Test JWT auth (manual): Use wscat or browser WebSocket client to connect to ws://localhost:3000/ws/realtime?token=YOUR_JWT_TOKEN
5. Verify connection rejected without valid JWT (error logged)
6. Verify SIGTERM graceful shutdown: kill -TERM <pid> (should close connections gracefully)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] Server starts without errors (npm start)
- [ ] WebSocket server logs "initialized on /ws/realtime"
- [ ] GET /api/websocket/stats returns valid JSON
- [ ] JWT authentication prevents unauthorized connections
- [ ] Winston logging captures all WebSocket events
- [ ] Graceful shutdown works (SIGTERM)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- WebSocketServer class follows Singleton pattern
- JWT authentication working during handshake
- Connection pool manages per-user WebSocket sets
- broadcast() method ready for Phase 30-31 usage
- No TypeScript errors or warnings
- Winston logging structured and consistent
- Phase 29 complete, ready for Phase 30 (WebSocket Client)
  </success_criteria>

<output>
After completion, create `.planning/phases/29-websocket-server-infrastructure/29-01-SUMMARY.md`:

# Phase 29 Plan 01: WebSocket Server Infrastructure Summary

**WebSocket server con JWT auth e connection management pronto per real-time draft/pending sync**

## Accomplishments

- WebSocketServer Singleton class with JWT authentication
- Connection pool per-user (Map<userId, Set<WebSocket>>)
- Broadcast methods for multi-device sync
- Integration con Express server esistente
- Health monitoring endpoint (GET /api/websocket/stats)
- Graceful shutdown con connection cleanup

## Files Created/Modified

- `backend/src/websocket-server.ts` - WebSocketServer class (new)
- `backend/src/types.ts` - WebSocketMessage, ConnectionStats interfaces (modified)
- `backend/src/index.ts` - WebSocket initialization and stats endpoint (modified)

## Decisions Made

- Usato ws library esistente (no socket.io) per consistency
- Path /ws/realtime per nuovo server (coesiste con /ws/sync)
- JWT authentication in query param per semplicità handshake
- Connection pool: Map<userId, Set<WebSocket>> per broadcast efficiente
- Graceful shutdown con async connection closure

## Issues Encountered

[Descrivere problemi incontrati durante execution, o "None"]

## Next Phase Readiness

Ready for Phase 30: WebSocket Client & Auto-Reconnect
- Server infrastructure pronta per client connections
- broadcast() method pronto per draft/pending events
- JWT auth verificato e funzionante
</output>
