---
phase: 20-prices-sync-optimization
plan: 04
type: execute
---

<objective>
Add API endpoints and UI controls for granular manual price sync (full, incremental).

Purpose: Give users explicit control over price sync strategy, consistent with Phases 18-04 and 19-04.
Output: Three API endpoints for sync granularity + frontend UI dropdown for mode selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-04-PLAN.md
@.planning/phases/19-products-sync-optimization/19-04-PLAN.md

**Key files:**
@archibald-web-app/backend/src/index.ts
@archibald-web-app/frontend/src/components/SyncButton.tsx

**Established patterns from Phase 18-04, 19-04:**
- POST /api/sync/{type}/full - Force full sync
- POST /api/sync/{type}/incremental - Force incremental sync
- Dropdown UI with 3 modes (Auto, Full, Incremental)
- Sync progress messages show mode indicator

**New endpoints required:**
1. POST /api/sync/prices/full - Force full price sync
2. POST /api/sync/prices/incremental - Force incremental price sync
3. POST /api/sync/prices/:priceId - Not applicable (prices update existing products)

**Implementation**: Apply identical pattern from Phases 18-04 and 19-04.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add granular price sync API endpoints to backend</name>
  <files>
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Add two price sync endpoints (same pattern as customers/products):

    1. POST /api/sync/prices/full:
    ```typescript
    app.post(
      '/api/sync/prices/full',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          logger.info('Force full price sync requested', { userId: req.userId });

          priceSyncService.forceFullSync().catch((error) => {
            logger.error('Error in force full price sync', { error, userId: req.userId });
          });

          res.json({
            success: true,
            data: null,
            message: 'Sincronizzazione completa prezzi avviata in background'
          });
        } catch (error) {
          logger.error('Error starting force full price sync', { error, userId: req.userId });
          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore avvio sync completo'
          });
        }
      }
    );
    ```

    2. POST /api/sync/prices/incremental:
    ```typescript
    app.post(
      '/api/sync/prices/incremental',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          logger.info('Force incremental price sync requested', { userId: req.userId });

          priceSyncService.forceIncrementalSync().catch((error) => {
            logger.error('Error in force incremental price sync', { error, userId: req.userId });
          });

          res.json({
            success: true,
            data: null,
            message: 'Sincronizzazione incrementale prezzi avviata (prime 3 pagine)'
          });
        } catch (error) {
          logger.error('Error starting force incremental price sync', { error, userId: req.userId });
          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore avvio sync incrementale'
          });
        }
      }
    );
    ```

    Note: No single-price endpoint (prices are bulk updates, not individual).

    See Phase 18-04 Task 1 for reference.
  </action>
  <verify>
    npm run typecheck passes
    Endpoints trigger correct sync modes
  </verify>
  <done>
    Two granular price sync endpoints added.
    POST /api/sync/prices/full and /incremental functional.
    JWT authentication required.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend SyncButton to support prices with dropdown</name>
  <files>
    archibald-web-app/frontend/src/components/SyncButton.tsx
  </files>
  <action>
    If SyncButton is generic, update endpoint mapping to include prices:

    ```typescript
    const handleSync = async () => {
      // ... existing logic ...

      let endpoint = '';
      if (syncType === 'customers') {
        // ... existing customer endpoints ...
      } else if (syncType === 'products') {
        // ... existing product endpoints ...
      } else if (syncType === 'prices') {
        endpoint = selectedMode === 'full'
          ? 'http://localhost:3000/api/sync/prices/full'
          : selectedMode === 'incremental'
          ? 'http://localhost:3000/api/sync/prices/incremental'
          : 'http://localhost:3000/api/sync/prices';
      }

      // ... rest of fetch logic ...
    };
    ```

    See Phase 18-04 Task 2 for reference.
  </action>
  <verify>
    npm run typecheck passes
    Dropdown works for price sync
  </verify>
  <done>
    SyncButton supports price sync with dropdown.
    Endpoint mapping includes prices.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update sync progress display to show price sync mode</name>
  <files>
    archibald-web-app/frontend/src/components/SyncBanner.tsx
  </files>
  <action>
    Update progress display to show price sync mode (same pattern as customers/products):

    ```typescript
    {progress.status === 'syncing' && progress.syncType === 'prices' && (
      <div style={{ padding: '15px', background: '#3498db', color: 'white', textAlign: 'center' }}>
        Sincronizzazione prezzi in corso...
        <br />
        <small>
          Modalit√†: {progress.message.includes('incrementale') ? 'Incrementale (veloce)' : 'Completa'}
          {' | '}
          Pagina {progress.currentPage} di {progress.totalPages}
          {' | '}
          Prezzi: {progress.pricesProcessed}
        </small>
      </div>
    )}
    ```

    See Phase 18-04 Task 3 for reference.
  </action>
  <verify>
    npm run typecheck passes
    Progress shows price sync mode
  </verify>
  <done>
    Sync progress displays price sync mode.
    Shows "Completa" or "Incrementale (veloce)".
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
- [ ] Two granular price sync endpoints added
- [ ] Frontend SyncButton supports price sync with dropdown
- [ ] Sync progress shows price sync mode indicator
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- Two granular price sync API endpoints functional
- Frontend dropdown UI for price sync mode selection
- Auto mode (default), Full mode, Incremental mode selectable
- Sync progress displays mode indicator for prices
- Consistent with Phases 18-04, 19-04
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/20-prices-sync-optimization/20-04-SUMMARY.md`
</output>
