---
phase: 20-prices-sync-optimization
plan: 01
type: execute
---

<objective>
Profile and analyze price sync performance to identify bottlenecks and optimization opportunities.

Purpose: Establish baseline performance metrics for PriceSyncService and document bottlenecks for optimization.
Output: Performance analysis report with execution times, bottleneck identification, and optimization recommendations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-01-PLAN.md
@.planning/phases/19-products-sync-optimization/19-01-PLAN.md

**Key files:**
@archibald-web-app/backend/src/price-sync-service.ts
@archibald-web-app/backend/src/product-db.ts

**Tech stack available:**
- Puppeteer for browser automation
- SQLite with better-sqlite3 for price storage
- Winston logger for timing logs
- TypeScript strict mode

**Existing sync implementation:**
- PriceSyncService.syncPrices() method (~773 lines total file)
- Similar structure to CustomerSyncService and ProductSyncService
- Pagination through price list pages
- Checkpoint resume capability
- 60-minute default auto-sync interval (vs 30min for customers/products)

**Price sync specifics:**
- Updates existing products in ProductDatabase with price data
- May scrape price lists or product detail pages
- Potentially Excel/CSV integration for bulk price imports (ROADMAP mentions "Excel listino integration")

**Profiling approach (same as Phase 18-01, 19-01):**
- Add timestamp logging at key points
- Measure: total sync time, per-page time, per-price time
- Run full sync and collect metrics
- Compare with customer/product sync patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add performance profiling instrumentation to syncPrices</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
    Add timing logs throughout syncPrices method (same pattern as Phase 18-01, 19-01):

    1. At start of method:
    ```typescript
    const syncStartTime = Date.now();
    logger.info('⏱️ [PERF] Price sync started', { startTime: syncStartTime });
    ```

    2. After login:
    ```typescript
    const loginEndTime = Date.now();
    logger.info('⏱️ [PERF] Login completed', {
      duration: loginEndTime - syncStartTime,
      elapsed: `${((loginEndTime - syncStartTime) / 1000).toFixed(2)}s`
    });
    ```

    3. After navigation to price list:
    ```typescript
    const navEndTime = Date.now();
    logger.info('⏱️ [PERF] Navigation to price list completed', {
      duration: navEndTime - loginEndTime,
      elapsed: `${((navEndTime - loginEndTime) / 1000).toFixed(2)}s`
    });
    ```

    4. Inside pagination loop - start of page:
    ```typescript
    const pageStartTime = Date.now();
    logger.info('⏱️ [PERF] Processing page started', {
      page: currentPage,
      timestamp: pageStartTime
    });
    ```

    5. End of page processing:
    ```typescript
    const pageEndTime = Date.now();
    const pricesOnPage = prices.length;
    logger.info('⏱️ [PERF] Page processing completed', {
      page: currentPage,
      pricesCount: pricesOnPage,
      duration: pageEndTime - pageStartTime,
      elapsed: `${((pageEndTime - pageStartTime) / 1000).toFixed(2)}s`,
      avgPerPrice: pricesOnPage > 0 ? `${((pageEndTime - pageStartTime) / pricesOnPage).toFixed(0)}ms` : 'N/A'
    });
    ```

    6. At end of sync:
    ```typescript
    const syncEndTime = Date.now();
    const totalDuration = syncEndTime - syncStartTime;
    logger.info('⏱️ [PERF] Price sync completed', {
      totalDuration,
      elapsed: `${(totalDuration / 1000).toFixed(2)}s`,
      pagesProcessed: currentPage,
      pricesProcessed: this.progress.pricesProcessed,
      avgPerPage: currentPage > 0 ? `${(totalDuration / currentPage / 1000).toFixed(2)}s` : 'N/A',
      avgPerPrice: this.progress.pricesProcessed > 0 ? `${(totalDuration / this.progress.pricesProcessed).toFixed(0)}ms` : 'N/A'
    });
    ```

    Why detailed timing: Identifies bottlenecks for targeted optimization, consistent with customer/product sync profiling.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend
    2. Trigger price sync
    3. Check logs for [PERF] entries
    4. Verify duration calculations are correct
  </verify>
  <done>
    Performance profiling instrumentation added to syncPrices.
    Timing logs at key points: start, login, navigation, per-page processing, completion.
    Duration calculations for each phase.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run profiled sync and collect performance data</name>
  <files>
    .planning/phases/20-prices-sync-optimization/PERF-DATA.json
  </files>
  <action>
    Execute profiled price sync and capture performance metrics:

    1. Ensure backend running with profiling instrumentation
    2. Trigger full price sync (force sync to bypass recent sync check)
    3. Monitor logs and collect timing data
    4. Create PERF-DATA.json with collected metrics:

    ```json
    {
      "testDate": "2026-01-18T...",
      "totalPrices": 200,
      "totalPages": 7,
      "phases": {
        "login": { "duration": 8500, "elapsed": "8.50s" },
        "navigation": { "duration": 3200, "elapsed": "3.20s" },
        "scraping": { "duration": 38000, "elapsed": "38.00s" }
      },
      "pageMetrics": [
        {
          "page": 1,
          "prices": 30,
          "duration": 5500,
          "avgPerPrice": "183ms"
        }
      ],
      "totals": {
        "totalDuration": 49700,
        "elapsed": "49.70s",
        "avgPerPage": "7.10s",
        "avgPerPrice": "249ms"
      },
      "bottlenecks": [
        "Page scraping: 38s (76.5% of total)",
        "Navigation overhead similar to customer/product sync"
      ]
    }
    ```

    Use actual values from log output. Price sync is typically faster than product sync (no images).

    Why JSON format: Structured data for comparison with customer/product sync metrics.
  </action>
  <verify>
    Manual check:
    1. Verify PERF-DATA.json exists with real timing data
    2. Check bottlenecks section identifies slowest operations
    3. Ensure metrics match log output
  </verify>
  <done>
    PERF-DATA.json created with baseline performance metrics.
    All timing phases documented.
    Bottlenecks identified from profiling data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create performance analysis report</name>
  <files>
    .planning/phases/20-prices-sync-optimization/ANALYSIS.md
  </files>
  <action>
    Create comprehensive performance analysis report:

    ```markdown
    # Price Sync Performance Analysis

    **Date**: 2026-01-18
    **File**: price-sync-service.ts
    **Method**: syncPrices()

    ## Baseline Metrics

    | Metric | Value |
    |--------|-------|
    | Total prices | 200 |
    | Total pages | 7 |
    | Total duration | 49.70s |
    | Avg per page | 7.10s |
    | Avg per price | 249ms |

    ## Phase Breakdown

    | Phase | Duration | % of Total | Notes |
    |-------|----------|-----------|-------|
    | Login | 8.50s | 17.1% | First-time browser initialization |
    | Navigation | 3.20s | 6.4% | Navigate to price list page |
    | Scraping | 38.00s | 76.5% | Main data extraction loop |

    ## Comparison with Other Syncs

    | Sync Type | Total Time | Items | Avg per Item |
    |-----------|-----------|-------|--------------|
    | Customers | 59.2s | 150 | 395ms |
    | Products | 98.7s | 200 | 494ms (incl images) |
    | **Prices** | **49.7s** | **200** | **249ms** |

    **Observation**: Price sync is fastest per-item (no images, simpler data structure).

    ## Bottlenecks Identified

    ### 1. Page Scraping (38s, 76.5%)
    - Similar to customer/product sync bottlenecks
    - Apply same optimizations: networkidle2 → domcontentloaded, reduce setTimeout

    ### 2. Navigation Overhead (3.2s, 6.4%)
    - Same as customer/product sync
    - Same optimizations apply

    ## Optimization Opportunities

    ### High Impact (>5s potential savings)
    1. **Optimize page navigation waits**: -3-5s (replace networkidle2 with specific selectors)
    2. **Reduce explicit setTimeout delays**: -5-8s (replace with dynamic waits)

    ### Medium Impact (1-5s potential savings)
    3. **Batch price data extraction**: -2-3s (single DOM query for all prices)

    ### Low Impact (<1s potential savings)
    4. **Database batch updates**: -0.5-1s (already batched, limited improvement)

    ## Estimated Optimization Potential

    | Scenario | Current | Optimized | Improvement |
    |----------|---------|-----------|-------------|
    | Conservative | 49.7s | 38s | -11.7s (-24%) |
    | Moderate | 49.7s | 32s | -17.7s (-36%) |
    | Aggressive | 49.7s | 28s | -21.7s (-44%) |

    ## Excel Listino Integration (ROADMAP Note)

    ROADMAP mentions "Excel listino integration" for Phase 20. Investigate:
    - Does price sync currently support Excel import?
    - If not, should Excel import be added as optimization strategy?
    - Excel import could bypass scraping entirely for bulk price updates

    **Recommendation**: Defer Excel integration to separate subtask if not currently implemented. Focus on scraping optimization first.

    ## Next Steps

    1. **Phase 20-02**: Add retry logic and health monitoring
    2. **Phase 20-03**: Implement incremental sync (delta only)
    3. **Phase 20-05**: Apply optimizations
       - Replace networkidle2 with domcontentloaded
       - Replace setTimeout with dynamic waits
       - Batch price data extraction
       - Optional: Excel import for bulk updates (if feasible)
    ```

    Adjust based on actual PERF-DATA.json results and whether Excel integration exists.

    Why detailed analysis: Provides clear optimization roadmap, compares with other sync types for context.
  </action>
  <verify>
    Manual check:
    1. Verify ANALYSIS.md exists with complete report
    2. Check comparison with customer/product sync metrics
    3. Ensure optimization recommendations are actionable
    4. Verify Excel integration note if mentioned in ROADMAP
  </verify>
  <done>
    ANALYSIS.md created with comprehensive performance report.
    Baseline metrics documented.
    Comparison with customer/product sync shows prices are fastest per-item.
    Bottlenecks identified with specific recommendations.
    Optimization potential: 24-44% improvement (49.7s → 28-38s).
    Excel integration noted for investigation.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] Performance profiling instrumentation added to syncPrices
- [ ] PERF-DATA.json created with real timing metrics
- [ ] ANALYSIS.md created with bottleneck analysis and recommendations
- [ ] Comparison with customer/product sync included
- [ ] No TypeScript errors
- [ ] Profiling logs appear in backend logs during sync
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Performance profiling instrumentation functional
- Baseline metrics collected and documented (~49.7s estimated)
- Bottlenecks identified with specific locations
- Optimization opportunities prioritized by impact (24-44% improvement potential)
- Comparison with customer/product sync provides context
- Analysis report provides clear roadmap for optimization
- Excel integration noted for future consideration
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/20-prices-sync-optimization/20-01-SUMMARY.md`:

# Phase 20 Plan 01: Price Sync Performance Analysis Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/price-sync-service.ts` - Description
- `.planning/phases/20-prices-sync-optimization/PERF-DATA.json` - Description
- `.planning/phases/20-prices-sync-optimization/ANALYSIS.md` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 20-02-PLAN.md (Background Sync Enhancement)
</output>
