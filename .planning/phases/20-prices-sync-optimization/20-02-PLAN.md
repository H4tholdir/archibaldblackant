---
phase: 20-prices-sync-optimization
plan: 02
type: execute
---

<objective>
Enhance background sync with retry logic, exponential backoff, and health monitoring for prices.

Purpose: Improve PriceSyncService reliability and observability, consistent with Phases 18-02 and 19-02.
Output: Enhanced background sync with retry logic, health statistics, and monitoring endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-02-PLAN.md
@.planning/phases/19-products-sync-optimization/19-02-PLAN.md

**Key files:**
@archibald-web-app/backend/src/price-sync-service.ts
@archibald-web-app/backend/src/index.ts

**Established patterns from Phase 18-02, 19-02:**
- Retry logic with exponential backoff (3 attempts: 5s, 10s, 20s)
- Health monitoring (success rate, consecutive failures)
- isHealthy flag (successRate >= 80% AND consecutiveFailures < 3)
- GET /api/sync/{type}/health endpoint

**Existing auto-sync implementation:**
- startAutoSync(intervalMinutes, skipInitialSync) method
- 60-minute default interval (vs 30min for customers/products)
- Basic error logging (no retry)
- No health tracking

**Implementation**: Apply identical pattern from Phases 18-02 and 19-02 to PriceSyncService.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry logic with exponential backoff to syncPrices</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
    Apply same pattern from Phase 18-02/19-02 to PriceSyncService:

    1. Add retry configuration:
    ```typescript
    private readonly MAX_RETRIES = 3;
    private readonly INITIAL_RETRY_DELAY = 5000;
    private retryCount = 0;
    ```

    2. Create syncPricesWithRetry wrapper (same logic as CustomerSyncService/ProductSyncService)

    3. Update startAutoSync to use retry wrapper

    See Phase 18-02 Task 1 for detailed implementation pattern.
  </action>
  <verify>
    npm run typecheck passes
    Test retry logic with simulated failures
  </verify>
  <done>
    Retry logic with exponential backoff added.
    syncPricesWithRetry wrapper created.
    startAutoSync uses retry wrapper.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sync health monitoring and statistics tracking</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
    Apply same pattern from Phase 18-02/19-02:

    1. Add syncStats object (same structure as CustomerSyncService/ProductSyncService)

    2. Update syncPricesWithRetry to track stats on success/failure

    3. Add getSyncHealth() method (same logic as other sync services)

    See Phase 18-02 Task 2 for detailed implementation pattern.
  </action>
  <verify>
    npm run typecheck passes
    getSyncHealth() returns accurate metrics
  </verify>
  <done>
    Sync health monitoring added.
    syncStats tracks attempts, successes, failures, consecutive failures.
    getSyncHealth() returns health status and metrics.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add health check API endpoint for prices monitoring</name>
  <files>
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Add GET /api/sync/prices/health endpoint (same pattern as customers/products):

    ```typescript
    app.get(
      '/api/sync/prices/health',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          const health = priceSyncService.getSyncHealth();

          res.json({
            success: true,
            data: {
              ...health,
              lastSuccessAt: health.lastSuccessAt?.toISOString() || null,
              lastFailureAt: health.lastFailureAt?.toISOString() || null
            },
            message: health.isHealthy
              ? 'Sync prezzi in salute'
              : '⚠️ Sync prezzi degradato'
          });
        } catch (error) {
          logger.error('Errore lettura health sync prezzi', { error });
          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore lettura health'
          });
        }
      }
    );
    ```

    See Phase 18-02 Task 3 for reference.
  </action>
  <verify>
    npm run typecheck passes
    Endpoint returns health metrics
  </verify>
  <done>
    GET /api/sync/prices/health endpoint added.
    Returns sync health statistics with isHealthy flag.
    Consistent with customers/products health endpoints.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
- [ ] Retry logic with exponential backoff implemented
- [ ] Health monitoring tracks statistics
- [ ] GET /api/sync/prices/health endpoint functional
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- Retry logic (3 attempts, 5s→10s→20s delays)
- Health monitoring tracks success rate and consecutive failures
- API endpoint exposes health metrics
- Consistent with Phases 18-02, 19-02
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/20-prices-sync-optimization/20-02-SUMMARY.md`
</output>
