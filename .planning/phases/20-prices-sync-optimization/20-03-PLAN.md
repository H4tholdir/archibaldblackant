---
phase: 20-prices-sync-optimization
plan: 03
type: execute
---

<objective>
Implement incremental sync strategy for prices with 3-page limit and optional Excel import.

Purpose: Reduce sync time via delta sync and explore Excel bulk import for price updates.
Output: Delta sync mode + optional Excel import endpoint, reducing sync time by 80-90% for incremental runs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-03-PLAN.md
@.planning/phases/19-products-sync-optimization/19-03-PLAN.md

**Key files:**
@archibald-web-app/backend/src/price-sync-service.ts
@archibald-web-app/backend/src/sync-checkpoint.ts

**Incremental sync strategy (same as Phase 18-03, 19-03):**
- Add syncMode parameter ('full' | 'incremental' | 'auto')
- Auto mode: full sync every 7 days, incremental between
- Incremental: first 3 pages only (most recent prices)
- SyncCheckpointManager already extended in Phase 18-03

**Excel listino integration (ROADMAP mentions):**
- Optional: Add endpoint for Excel price list upload
- Parse Excel file with price data (productId, price, effectiveDate)
- Bulk update ProductDatabase with prices
- Alternative to scraping for mass price updates

**Implementation priorities:**
- Incremental sync: HIGH (consistent with other syncs)
- Excel import: OPTIONAL (if time permits, otherwise defer to Phase 20-05)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add syncMode parameter to syncPrices</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
    Apply same pattern from Phase 18-03/19-03:

    1. Update method signature:
    ```typescript
    async syncPrices(syncMode: 'full' | 'incremental' | 'auto' = 'auto'): Promise<void> {
      // ... existing checks ...

      let actualSyncMode: 'full' | 'incremental' = syncMode === 'auto'
        ? (this.checkpointManager.needsFullSync('prices') ? 'full' : 'incremental')
        : syncMode;

      logger.info(`ðŸ”„ Price sync mode: ${actualSyncMode}`, {
        requested: syncMode,
        needsFullSync: this.checkpointManager.needsFullSync('prices'),
        lastFullSync: this.checkpointManager.getLastFullSyncAt('prices')
      });

      // ... rest of logic ...
    }
    ```

    2. Limit pages for incremental mode (first 3 pages)

    3. Mark sync type on completion (markFullSyncCompleted or markIncrementalSyncCompleted)

    See Phase 18-03 Task 2 for detailed pattern.
  </action>
  <verify>
    npm run typecheck passes
    Incremental mode scrapes only 3 pages
  </verify>
  <done>
    syncMode parameter added ('full', 'incremental', 'auto').
    Auto mode uses 7-day threshold.
    Incremental limits to first 3 pages.
    Checkpoint manager marks sync type.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update retry logic and auto-sync to support syncMode</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
    Apply same pattern from Phase 18-03/19-03 Task 3:

    1. Update syncPricesWithRetry to accept syncMode parameter

    2. Update startAutoSync to use 'auto' mode

    3. Add forceFullSync() and forceIncrementalSync() methods

    See Phase 18-03 Task 3 for detailed pattern.
  </action>
  <verify>
    npm run typecheck passes
    Auto mode chooses correct sync strategy
  </verify>
  <done>
    syncPricesWithRetry accepts syncMode parameter.
    startAutoSync uses 'auto' mode.
    forceFullSync() and forceIncrementalSync() methods added.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Excel import endpoint for bulk price updates (OPTIONAL)</name>
  <files>
    archibald-web-app/backend/src/index.ts,
    archibald-web-app/backend/src/price-import-service.ts
  </files>
  <action>
    Optional task - implement if Excel integration is needed for ROADMAP:

    1. Create PriceImportService for Excel parsing:
    ```typescript
    import * as XLSX from 'xlsx';

    export class PriceImportService {
      async importPricesFromExcel(filePath: string): Promise<{ updated: number; errors: string[] }> {
        const workbook = XLSX.readFile(filePath);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);

        let updated = 0;
        const errors: string[] = [];

        for (const row of data as any[]) {
          try {
            const { productId, price } = row;
            if (!productId || !price) continue;

            // Update product price in database
            this.productDb.updatePrice(productId, parseFloat(price));
            updated++;
          } catch (error) {
            errors.push(`Row error: ${error}`);
          }
        }

        return { updated, errors };
      }
    }
    ```

    2. Add POST /api/prices/import-excel endpoint with file upload (multer)

    3. If not implemented now, mark as TODO for Phase 20-05

    Why optional: Excel import is useful but not critical for sync optimization. Can defer if time-constrained.
  </action>
  <verify>
    If implemented:
    - npm run typecheck passes
    - Excel upload endpoint accepts .xlsx files
    - Price updates applied to database

    If deferred:
    - Add comment: "TODO: Excel import in Phase 20-05"
  </verify>
  <done>
    If implemented: Excel import endpoint functional.
    If deferred: TODO comment added for Phase 20-05.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
- [ ] syncPrices supports 'full', 'incremental', 'auto' modes
- [ ] Incremental mode limits to first 3 pages
- [ ] Auto mode uses 7-day threshold
- [ ] forceFullSync() and forceIncrementalSync() methods functional
- [ ] Excel import optional (implemented or deferred)
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- Incremental sync strategy implemented
- Auto mode intelligently chooses full vs incremental
- Manual control methods available
- Sync time reduced by 80-90% for incremental runs
- Consistent with Phases 18-03, 19-03
- Excel import optional (completed or planned for Phase 20-05)
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/20-prices-sync-optimization/20-03-SUMMARY.md`
</output>
