---
phase: 20-prices-sync-optimization
plan: 05
type: execute
---

<objective>
Apply identified performance optimizations and verify all price sync modes with comprehensive checkpoint.

Purpose: Implement optimization recommendations from 20-01 analysis and validate complete price sync functionality.
Output: Optimized sync performance (target: 30-40% faster), all sync modes functional, comprehensive verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-prices-sync-optimization/ANALYSIS.md
@.planning/phases/18-customers-sync-optimization/18-05-PLAN.md

**Optimizations identified (from 20-01 ANALYSIS.md)**:
1. Page navigation optimization (networkidle2 → domcontentloaded)
2. Reduce explicit setTimeout delays
3. Batch price data extraction
4. Optional: Excel import for bulk updates (if not done in 20-03)

**Performance baseline (from 20-01)**:
- Total duration: ~49.7s (estimated)
- Target optimized: ~32-38s (30-40% improvement)

**Sync modes to verify:**
- Full sync (all pages)
- Incremental sync (3 pages)
- Auto sync (intelligent mode selection)
- Background sync with retry logic
- Health monitoring and statistics
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply page navigation optimizations from Phase 18-05</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
    Apply same navigation optimizations from Phase 18-05 Task 1:

    1. Replace networkidle2 with domcontentloaded + explicit selectors
    2. Remove unnecessary setTimeout waits
    3. Optimize page load wait with dynamic checks

    See Phase 18-05 Task 1 for detailed pattern.
  </action>
  <verify>
    npm run typecheck passes
    Sync completes successfully with optimization
  </verify>
  <done>
    Page navigation optimized: networkidle2 → domcontentloaded.
    setTimeout delays replaced with dynamic waits.
    Estimated -5-8s improvement.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Excel import for bulk price updates (if deferred from 20-03)</name>
  <files>
    archibald-web-app/backend/src/price-import-service.ts,
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    If Excel import was deferred from Phase 20-03, implement now:

    1. Install xlsx library: npm install xlsx @types/xlsx
    2. Create PriceImportService (see Phase 20-03 Task 3)
    3. Add POST /api/prices/import-excel endpoint with multer file upload
    4. Parse Excel file and bulk update prices in ProductDatabase

    If already implemented in 20-03, skip this task.

    Why now: Excel import provides alternative to scraping for bulk updates, useful for price list changes.
  </action>
  <verify>
    If implemented:
    - npm run typecheck passes
    - Excel upload endpoint functional
    - Price updates applied correctly

    If skipped (already done):
    - Verify existing Excel import works
  </verify>
  <done>
    If implemented: Excel import endpoint functional.
    If skipped: Existing Excel import verified.
    TypeScript compilation passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete price sync optimization with all modes functional</what-built>
  <how-to-verify>
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Start frontend: cd archibald-web-app/frontend && npm run dev

    **Test 1: Full Sync Performance**
    3. Trigger full price sync via frontend dropdown: "Sync Completo"
    4. Monitor backend logs for [PERF] timing entries
    5. Verify completion time: Target 32-38s (baseline was ~49.7s)
    6. Check logs confirm:
       - Login phase: <10s
       - Navigation phase: <3s
       - Scraping phase: <28s (down from ~38s)
    7. Verify all prices synced successfully

    **Test 2: Incremental Sync Performance**
    8. Wait 1 minute, trigger incremental sync: "Sync Incrementale (veloce)"
    9. Verify logs show "Modalità: incremental"
    10. Verify only first 3 pages scraped
    11. Verify completion time: Target 7-10s (only 3 pages)
    12. Confirm checkpoint manager marks incremental sync

    **Test 3: Auto Mode (Intelligent Selection)**
    13. Immediately trigger auto sync: "Auto (consigliato)"
    14. Verify logs show incremental mode (last full sync < 7 days)
    15. Manually set lastFullSyncAt to 8 days ago in DB
    16. Trigger auto sync again
    17. Verify logs show full mode (last full sync > 7 days)

    **Test 4: Retry Logic and Health Monitoring**
    18. Simulate failure: stop Archibald server mid-sync
    19. Trigger full price sync
    20. Verify logs show 3 retry attempts with exponential backoff
    21. Verify error state after 3 failed attempts
    22. Check health endpoint: GET /api/sync/prices/health
    23. Verify health shows failedSyncs++, isHealthy = false

    **Test 5: Background Auto-Sync**
    24. Restart backend with auto-sync enabled
    25. Verify initial price sync runs after 10 seconds (price sync delay)
    26. Wait 60 minutes (or adjust interval)
    27. Verify periodic price sync runs automatically
    28. Check logs show auto mode selection

    **Test 6: Frontend Dropdown UI**
    29. Navigate to page with price sync button
    30. Click dropdown toggle
    31. Verify 3 options: Auto, Sync Completo, Sync Incrementale
    32. Select "Sync Completo": verify full sync starts
    33. Check progress shows "Modalità: Completa"
    34. Select "Sync Incrementale": verify incremental sync starts
    35. Check progress shows "Modalità: Incrementale (veloce)"

    **Test 7: Excel Import (if implemented)**
    36. Prepare test Excel file with price data (productId, price columns)
    37. Upload via POST /api/prices/import-excel endpoint
    38. Verify response shows number of prices updated
    39. Check database: verify prices updated correctly
    40. Verify Excel import faster than scraping for bulk updates

    **Test 8: Performance Baseline Comparison**
    41. Review performance logs from full sync
    42. Calculate total improvement: (baseline 49.7s - optimized time) / 49.7s
    43. Verify improvement >= 30% (target: 32-38s = 24-36% improvement)

    **Success Criteria:**
    - Full sync completes in 32-38s (30-40% improvement)
    - Incremental sync: 7-10s (85-90% faster)
    - Auto mode intelligently selects full/incremental based on 7-day threshold
    - Retry logic handles transient failures (3 attempts with backoff)
    - Health monitoring tracks success rate
    - Health API endpoint returns accurate statistics
    - Frontend dropdown UI functional with 3 modes
    - Progress messages show sync mode
    - All prices synced correctly
    - Excel import functional (if implemented)
    - No errors or crashes during any sync mode
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] Page navigation optimized
- [ ] Excel import implemented (if deferred from 20-03)
- [ ] No TypeScript errors
- [ ] Full sync performance improved by 30-40%
- [ ] All sync modes functional
- [ ] User verification approved (comprehensive checkpoint passed)
</verification>

<success_criteria>
- All tasks completed
- Performance optimizations applied
- Full sync target: 32-38s (30-40% improvement from 49.7s baseline)
- Incremental sync: 7-10s (only 3 pages)
- Auto mode intelligently selects sync strategy
- Retry logic with exponential backoff
- Health monitoring functional
- All sync modes verified by user
- Excel import functional (if implemented)
- Data integrity maintained
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/20-prices-sync-optimization/20-05-SUMMARY.md`:

# Phase 20 Plan 05: Sync Optimization & Checkpoint Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/price-sync-service.ts` - Description
- `archibald-web-app/backend/src/price-import-service.ts` - Description (if created)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Performance Results

| Metric | Baseline (20-01) | Optimized | Improvement |
|--------|-----------------|-----------|-------------|
| Full sync | 49.7s | [ACTUAL]s | [X]% |
| Incremental sync | N/A | [ACTUAL]s | N/A (new) |
| Scraping phase | 38.0s | [ACTUAL]s | [X]% |

## Next Step

Phase 20 complete. Ready for Phase 21 (Orders Sync Analysis & Optimization).
</output>
