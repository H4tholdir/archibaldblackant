---
phase: 27-bot-performance-profiling-v2
plan: 03
type: execute
---

<objective>
Orchestrate automated profiling execution across all 17 order creation steps and generate slowdown-config.json.

Purpose: Run binary search sequentially for each step, collecting optimal slowdown values into consumable configuration file.
Output: Complete slowdown-config.json with optimal values for all 17 steps + profiling metadata.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-bot-performance-profiling-v2/27-CONTEXT.md
@.planning/phases/27-bot-performance-profiling-v2/27-01-SUMMARY.md
@.planning/phases/27-bot-performance-profiling-v2/27-02-SUMMARY.md
@archibald-web-app/backend/src/archibald-bot.ts
@archibald-web-app/backend/src/slowdown-optimizer.ts

**From Plan 27-01:**
- Per-step slowdown infrastructure ready
- Direct paste optimization implemented

**From Plan 27-02:**
- SlowdownOptimizer with binary search ready
- Crash detection and restart logic working

**17 Steps to Profile:**
From 27-CONTEXT.md: login, click_ordini, click_nuovo, click_profilo_cliente_dropdown, paste_customer_search, select_customer, click_new_article, paste_article_direct, select_article, click_qty_field, paste_qty, click_update, click_salvare_dropdown, click_salva_chiudi
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profiling orchestrator script</name>
  <files>archibald-web-app/backend/src/scripts/run-profiling.ts</files>
  <action>
    Create orchestrator script that runs binary search for all 17 steps:

    **Script structure:**
    ```typescript
    import { ArchibaldBot } from '../archibald-bot';
    import { SlowdownOptimizer } from '../slowdown-optimizer';
    import { BrowserPool } from '../browser-pool';
    import { logger } from '../logger';
    import fs from 'fs/promises';

    async function runProfilingOrchestrator() {
      const steps = [
        'login',
        'click_ordini',
        'click_nuovo',
        'click_profilo_cliente_dropdown',
        'paste_customer_search',
        'select_customer',
        'click_new_article',
        'paste_article_direct',  // New optimized step
        'select_article',
        'click_qty_field',
        'paste_qty',
        'click_update',
        'click_salvare_dropdown',
        'click_salva_chiudi'
      ];

      const browserPool = BrowserPool.getInstance();
      const bot = new ArchibaldBot('profiling-service');
      const optimizer = new SlowdownOptimizer(bot, 'fresis', 'TD1272.314');

      const results: Record<string, number> = {};
      const metadata = {
        profiled_at: new Date().toISOString(),
        test_customer: 'fresis',
        test_article: 'TD1272.314',
        iterations_total: 0,
        crashes_total: 0
      };

      for (const stepName of steps) {
        logger.info(`[Profiling] Starting optimization for step: ${stepName}`);
        const optimalValue = await optimizer.optimizeStep(stepName);
        results[stepName] = optimalValue;
        logger.info(`[Profiling] Optimal value for ${stepName}: ${optimalValue}ms`);
      }

      // Collect metadata from optimizer
      const state = optimizer.getState();
      for (const [_, stepState] of state) {
        metadata.iterations_total += stepState.testedValues.length;
        metadata.crashes_total += stepState.crashes.length;
      }

      return { results, metadata };
    }
    ```

    **Execution flow:**
    1. Initialize bot with BrowserPool
    2. Create optimizer with test data (fresis, TD1272.314)
    3. Loop through 17 steps sequentially
    4. For each step: run binary search (optimizer.optimizeStep)
    5. Collect optimal values and metadata
    6. Return results object

    **Progress logging:**
    - Log before each step optimization starts
    - Log after each step completes (with optimal value)
    - Log overall progress (e.g., "Step 5/14 complete")

    **What to avoid:** Don't parallelize step optimizations - each must complete independently to avoid interference.
  </action>
  <verify>
    - TypeScript compiles without errors
    - Dry run with mock optimizer returns results object
    - Script logs show progress for each step
    - Results object has all 17 step names as keys
  </verify>
  <done>
    - run-profiling.ts script created
    - Sequential step optimization implemented
    - Progress logging working
    - Metadata collection working
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate slowdown-config.json output</name>
  <files>archibald-web-app/backend/src/scripts/run-profiling.ts</files>
  <action>
    Add JSON generation to orchestrator script:

    **JSON format (from 27-CONTEXT.md):**
    ```json
    {
      "version": "1.0.0",
      "baseline": 200,
      "optimized": {
        "login": 150,
        "click_ordini": 100,
        "click_nuovo": 120,
        ... (all 17 steps)
      },
      "metadata": {
        "profiled_at": "2026-01-22T...",
        "test_customer": "fresis",
        "test_article": "TD1272.314",
        "iterations_total": 147,
        "crashes_total": 23
      }
    }
    ```

    **Implementation:**
    ```typescript
    async function writeSlowdownConfig(results, metadata) {
      const config = {
        version: '1.0.0',
        baseline: 200,
        optimized: results,
        metadata
      };

      const outputPath = './slowdown-config.json';
      await fs.writeFile(
        outputPath,
        JSON.stringify(config, null, 2),
        'utf-8'
      );

      logger.info(`[Profiling] Config written to ${outputPath}`);
      return outputPath;
    }
    ```

    **Output location:**
    - Write to: archibald-web-app/backend/slowdown-config.json
    - Log file path after writing
    - Include timestamp in metadata

    **What to avoid:** Don't auto-apply the config yet - this is just output generation. Phase 28 will implement the config application.
  </action>
  <verify>
    - slowdown-config.json file created in backend directory
    - JSON is valid and properly formatted
    - All 17 steps present in "optimized" object
    - Metadata includes profiled_at, test data, iteration/crash counts
    - File readable by JSON.parse()
  </verify>
  <done>
    - writeSlowdownConfig function implemented
    - JSON generation working correctly
    - File written to correct location
    - All required fields present
    - JSON validation passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete automated profiling run for all 17 order creation steps with binary search optimization</what-built>
  <how-to-verify>
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Run profiling script: npx tsx src/scripts/run-profiling.ts
    3. Monitor logs for progress (expect ~30-90 minutes total runtime depending on crash frequency)
    4. Verify slowdown-config.json created in archibald-web-app/backend/
    5. Check config has 17 steps in "optimized" object
    6. Verify values are between 0-200ms
    7. Check metadata shows iterations_total and crashes_total
    8. Confirm test orders for fresis + TD1272.314 were created successfully
  </how-to-verify>
  <resume-signal>Type "approved" if profiling completed successfully and config looks correct, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation passes
- [ ] Orchestrator script runs without fatal errors
- [ ] slowdown-config.json generated successfully
- [ ] Config contains all 17 steps with valid values (0-200ms)
- [ ] Metadata shows profiling timestamp and test data
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>

- Profiling orchestrator script complete
- All 17 steps optimized sequentially
- slowdown-config.json generated with correct format
- Config includes metadata (timestamps, iterations, crashes)
- Human verification confirms successful profiling run
- Ready for Phase 27-04 (Dashboard Enhancement)
</success_criteria>

<output>
After completion, create .planning/phases/27-bot-performance-profiling-v2/27-03-SUMMARY.md
</output>
