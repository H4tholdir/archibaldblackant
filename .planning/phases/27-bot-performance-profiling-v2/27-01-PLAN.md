---
phase: 27-bot-performance-profiling-v2
plan: 01
type: execute
---

<objective>
Implement UI optimization (direct paste in article field) and add per-step slowdown tracking infrastructure.

Purpose: Eliminate dropdown → search → paste sequence for article insertion, and prepare bot for profiling with per-step slowdown parameters.
Output: Modified bot with direct paste optimization and slowdown tracking instrumentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-bot-performance-profiling-v2/27-CONTEXT.md
@archibald-web-app/backend/src/archibald-bot.ts

**From Phase 3.1:**
- Profiling infrastructure exists (performance-tracking.ts, PerformanceDashboardGenerator)
- Current baseline: ~82s per order
- Fixed 200ms slowdown used throughout bot

**From Phase 26:**
- Fast login via persistent context pooling (50% faster: 8-10s → ~4.5s)
- Browser pool architecture ready for profiling runs

**Key Constraint:**
- Customer: fresis (real customer)
- Article: TD1272.314 (single packaging, qty=1)
- Must preserve order creation stability while optimizing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement direct paste in article name field</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
    Modify article field filling logic (search for article dropdown/paste logic in createOrder method):

    **Current flow (3 steps):**
    1. Click article dropdown button
    2. Click "Enter text to search" input  
    3. Paste article code

    **New optimized flow (1 step):**
    1. Direct paste into article name field (triggers auto-filter dropdown)

    **Implementation:**
    - Locate the article name field selector (similar pattern to customer field)
    - Remove dropdown click and search field click steps
    - Paste directly into the article name cell/field
    - Wait for dropdown to auto-appear with filtered results
    - Select first filtered result (existing logic should work)

    **Why this works:** Archibald UI auto-triggers dropdown filter when text is pasted directly in the field (user discovered this shortcut).

    **What to avoid:** Don't remove the dropdown selection logic - only the pre-paste steps (dropdown click, search click). The selection after paste remains the same.
  </action>
  <verify>
    Create test order with customer "fresis" and article "TD1272.314":
    - Bot should paste directly in article field
    - Dropdown should auto-appear with filtered results
    - Order should complete successfully
    - Check logs for optimization confirmation
  </verify>
  <done>
    - Article field logic uses direct paste (no dropdown/search clicks)
    - Test order creation succeeds with new flow
    - Logs confirm new optimization path taken
  </done>
</task>

<task type="auto">
  <name>Task 2: Add per-step slowdown tracking infrastructure</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
    Add slowdown parameter system to enable per-step profiling:

    **1. Create slowdown configuration interface:**
    ```typescript
    interface SlowdownConfig {
      [stepName: string]: number; // step name -> slowdown ms
    }
    ```

    **2. Add optional slowdownConfig parameter to createOrder method:**
    - Default to current behavior (200ms everywhere)
    - If provided, use per-step values from config

    **3. Modify all page.waitForTimeout(200) calls to use slowdown from config:**
    - Identify all waitForTimeout(200) calls in createOrder flow
    - Replace with: await page.waitForTimeout(slowdownConfig[stepName] ?? 200)
    - Use descriptive step names matching 27-CONTEXT.md flow (e.g., "click_ordini", "paste_customer", "click_new_article", "paste_article_direct", "click_update", etc.)

    **4. Track which slowdown was used in performance metrics:**
    - Add slowdownUsed field to performance tracking events
    - Log slowdown config at start of order creation

    **Why separate from profiling:** This infrastructure enables Phase 27-02's SlowdownOptimizer to test different values without modifying bot code for each test.

    **What to avoid:** Don't change the 200ms default yet - this task only adds infrastructure. Binary search in 27-02 will find optimal values.
  </action>
  <verify>
    - TypeScript compiles without errors
    - Test order creation with default slowdownConfig (all 200ms) - should behave identically to before
    - Test order creation with custom config (e.g., {"click_ordini": 100}) - should use 100ms for that step
    - Performance logs show slowdownUsed values
  </verify>
  <done>
    - SlowdownConfig interface defined
    - createOrder accepts optional slowdownConfig parameter
    - All waitForTimeout calls use config values with 200ms fallback
    - Performance tracking includes slowdown values
    - Tests pass with both default and custom configs
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation passes (npm run build in backend)
- [ ] Test order creation with customer "fresis" + article "TD1272.314" succeeds
- [ ] Logs confirm direct paste optimization is used
- [ ] Custom slowdown config can be passed and affects timing
- [ ] No regression in order creation success rate
</verification>

<success_criteria>

- Direct paste in article field implemented (eliminates 2 steps)
- Per-step slowdown infrastructure added
- Test order creation succeeds with new flow
- Slowdown config parameter working
- All verification checks pass
- Ready for Phase 27-02 (Binary Search Optimizer)
</success_criteria>

<output>
After completion, create .planning/phases/27-bot-performance-profiling-v2/27-01-SUMMARY.md
</output>
