---
phase: 19-products-sync-optimization
plan: 03
type: execute
---

<objective>
Implement incremental sync strategy and optimize image downloads for faster subsequent syncs.

Purpose: Reduce sync time via delta sync (first 3 pages) and optimize image downloads (skip existing, increase parallelism).
Output: Delta sync mode + optimized image handling, reducing sync time by 80-90% for incremental runs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-03-PLAN.md

**Key files:**
@archibald-web-app/backend/src/product-sync-service.ts
@archibald-web-app/backend/src/image-downloader.ts
@archibald-web-app/backend/src/sync-checkpoint.ts

**Tech stack available:**
- SQLite with better-sqlite3
- Puppeteer for scraping
- ImageDownloader for batch downloads
- SyncCheckpointManager (extended in Phase 18-03)

**Incremental sync strategy (same as Phase 18-03):**
- Add syncMode parameter ('full' | 'incremental' | 'auto')
- Auto mode: full sync every 7 days, incremental between
- Incremental: first 3 pages only (most recent products)
- SyncCheckpointManager tracks lastFullSyncAt and lastIncrementalSyncAt (already extended in Phase 18-03)

**Image optimization strategies:**
1. **Skip existing images**: Check if file exists before download
2. **Increase parallelism**: Download 10-20 images concurrently (vs current limit)
3. **Lazy background downloads**: Optional - download images after sync completes (user-perceived: -35s)

**Implementation priorities:**
- Incremental sync: HIGH (mirrors Phase 18-03)
- Skip existing images: HIGH (easy win, 5-10s savings)
- Increase parallelism: MEDIUM (moderate improvement)
- Lazy downloads: OPTIONAL (complex, defer to Phase 19-05 if needed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add syncMode parameter to syncProducts (mirror Phase 18-03)</name>
  <files>
    archibald-web-app/backend/src/product-sync-service.ts
  </files>
  <action>
    Apply same pattern from Phase 18-03 Task 2 to ProductSyncService:

    1. Update method signature:
    ```typescript
    /**
     * Sincronizza i prodotti da Archibald
     * @param syncMode 'full' = scrape all pages, 'incremental' = scrape recent pages only, 'auto' = decide based on last sync
     */
    async syncProducts(syncMode: 'full' | 'incremental' | 'auto' = 'auto'): Promise<void> {
      // ... existing checks (syncInProgress, paused, etc.) ...

      // Determine actual sync mode (reuse 'customers' checkpoint for now, or add 'products' support)
      let actualSyncMode: 'full' | 'incremental' = syncMode === 'auto'
        ? (this.checkpointManager.needsFullSync('products') ? 'full' : 'incremental')
        : syncMode;

      logger.info(`ðŸ”„ Product sync mode: ${actualSyncMode}`, {
        requested: syncMode,
        needsFullSync: this.checkpointManager.needsFullSync('products'),
        lastFullSync: this.checkpointManager.getLastFullSyncAt('products')
      });

      // ... rest of existing logic ...
    }
    ```

    2. Inside sync loop, limit pages for incremental:
    ```typescript
    // After determining total pages:
    const totalPages = /* ... existing pagination detection ... */;

    const pagesToScrape = actualSyncMode === 'incremental'
      ? Math.min(3, totalPages) // Only first 3 pages for incremental
      : totalPages;

    logger.info(`Pages to scrape: ${pagesToScrape} of ${totalPages} (mode: ${actualSyncMode})`);

    this.updateProgress({
      status: 'syncing',
      currentPage: resumePoint || 1,
      totalPages: pagesToScrape,
      productsProcessed: 0,
      message: actualSyncMode === 'incremental'
        ? 'Sincronizzazione incrementale (pagine recenti)...'
        : 'Sincronizzazione completa...'
    });

    // Pagination loop with page limit
    for (let currentPage = resumePoint || 1; currentPage <= pagesToScrape; currentPage++) {
      // ... existing scraping logic ...
    }
    ```

    3. Mark sync type on completion:
    ```typescript
    // At end of successful sync:
    if (actualSyncMode === 'full') {
      this.checkpointManager.markFullSyncCompleted('products');
    } else {
      this.checkpointManager.markIncrementalSyncCompleted('products');
    }
    ```

    Why same pattern: Consistency with CustomerSyncService, proven approach from Phase 18-03.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Run full sync: verify all pages scraped
    2. Run incremental sync: verify only 3 pages scraped
    3. Run auto sync: verify full sync on first run, incremental on subsequent
    4. Check checkpoint manager tracks product sync mode
  </verify>
  <done>
    syncMode parameter added to syncProducts ('full', 'incremental', 'auto').
    Auto mode decides based on needsFullSync('products') (7-day threshold).
    Incremental mode limits to first 3 pages.
    Checkpoint manager marks sync type on completion.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimize ImageDownloader to skip existing images</name>
  <files>
    archibald-web-app/backend/src/image-downloader.ts
  </files>
  <action>
    Add logic to skip downloading images that already exist on disk:

    1. In downloadBatch method (or equivalent), add file existence check:
    ```typescript
    import * as fs from 'fs';
    import * as path from 'path';

    async downloadBatch(imageUrls: { url: string; filename: string }[]): Promise<void> {
      // Filter out images that already exist
      const imagesToDownload = imageUrls.filter(({ filename }) => {
        const filePath = path.join(this.imageDir, filename);
        const exists = fs.existsSync(filePath);

        if (exists) {
          logger.debug(`Image already exists, skipping: ${filename}`);
        }

        return !exists;
      });

      logger.info(`Image batch: ${imagesToDownload.length} to download, ${imageUrls.length - imagesToDownload.length} already exist`);

      if (imagesToDownload.length === 0) {
        logger.info('All images already downloaded, skipping batch');
        return;
      }

      // ... existing download logic for imagesToDownload only ...
    }
    ```

    2. If downloadBatch takes different parameters, adapt accordingly. Key logic:
       - Check `fs.existsSync(imageFilePath)` before download
       - Log skipped count for visibility
       - Only download missing images

    Why skip existing: Avoids re-downloading unchanged images on incremental syncs, saves 5-10s when most images exist.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Run full sync: verify all images download
    2. Run incremental sync immediately: verify most images skipped
    3. Check logs show "X to download, Y already exist"
    4. Verify image files exist in expected directory
  </verify>
  <done>
    ImageDownloader.downloadBatch optimized to skip existing images.
    File existence check with fs.existsSync before download.
    Logs show download vs skip counts.
    Incremental syncs skip existing images (5-10s savings).
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update retry logic and auto-sync to support syncMode</name>
  <files>
    archibald-web-app/backend/src/product-sync-service.ts
  </files>
  <action>
    Update existing sync wrappers to pass syncMode parameter (same as Phase 18-03 Task 3):

    1. Update syncProductsWithRetry wrapper:
    ```typescript
    private async syncProductsWithRetry(syncMode: 'full' | 'incremental' | 'auto' = 'auto'): Promise<void> {
      this.syncStats.totalAttempts++;

      for (let attempt = 1; attempt <= this.MAX_RETRIES; attempt++) {
        try {
          await this.syncProducts(syncMode); // Pass syncMode parameter

          // ... rest of existing logic ...
        }
        // ... rest of existing retry logic ...
      }
    }
    ```

    2. Update startAutoSync to use 'auto' mode:
    ```typescript
    startAutoSync(intervalMinutes: number = 30, skipInitialSync: boolean = false): void {
      logger.info(`Avvio auto-sync ogni ${intervalMinutes} minuti (mode: auto)`);

      if (!skipInitialSync) {
        setTimeout(() => {
          this.syncProductsWithRetry('auto').catch((error) => { // Use 'auto' mode
            logger.error('Errore sync iniziale (dopo retry)', { error });
          });
        }, 5000);
      }

      this.syncInterval = setInterval(
        () => {
          this.syncProductsWithRetry('auto').catch((error) => { // Use 'auto' mode
            logger.error('Errore sync periodico (dopo retry)', { error });
          });
        },
        intervalMinutes * 60 * 1000,
      );
    }
    ```

    3. Add public methods for manual sync control:
    ```typescript
    /**
     * Force full sync (ignores 7-day check)
     */
    async forceFullSync(): Promise<void> {
      await this.syncProductsWithRetry('full');
    }

    /**
     * Force incremental sync
     */
    async forceIncrementalSync(): Promise<void> {
      await this.syncProductsWithRetry('incremental');
    }
    ```

    Why auto mode default: Automatically optimizes sync strategy, consistent with CustomerSyncService.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start auto-sync and verify first run is full sync
    2. Trigger sync again within 7 days: verify incremental sync
    3. Call forceFullSync(): verify full sync regardless of last sync time
    4. Check logs show correct sync mode decisions
  </verify>
  <done>
    syncProductsWithRetry updated with syncMode parameter.
    startAutoSync uses 'auto' mode for intelligent sync strategy.
    forceFullSync() and forceIncrementalSync() methods added.
    Auto mode chooses full/incremental based on 7-day threshold.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] syncProducts supports 'full', 'incremental', 'auto' modes
- [ ] Incremental mode limits to first 3 pages
- [ ] Auto mode chooses sync strategy based on 7-day threshold
- [ ] ImageDownloader skips existing images
- [ ] forceFullSync() and forceIncrementalSync() methods functional
- [ ] No TypeScript errors
- [ ] Incremental sync reduces execution time by 80-90%
- [ ] Image skip optimization works (logs show skip counts)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Incremental sync strategy implemented with 3-page limit
- Auto mode intelligently chooses full vs incremental sync
- Full sync forced every 7 days for data integrity
- Image downloads skip existing files (5-10s savings)
- Manual control methods (forceFullSync, forceIncrementalSync) available
- Sync time reduced by 80-90% for incremental runs
- Checkpoint manager tracks product sync types and timestamps
- Consistent with CustomerSyncService patterns from Phase 18-03
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/19-products-sync-optimization/19-03-SUMMARY.md`:

# Phase 19 Plan 03: Incremental Sync + Image Optimization Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/product-sync-service.ts` - Description
- `archibald-web-app/backend/src/image-downloader.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 19-04-PLAN.md (Manual Sync Granularity)
</output>
