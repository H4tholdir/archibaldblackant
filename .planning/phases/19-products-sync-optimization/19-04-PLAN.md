---
phase: 19-products-sync-optimization
plan: 04
type: execute
---

<objective>
Add API endpoints and UI controls for granular manual product sync (full, incremental, single product).

Purpose: Give users explicit control over product sync strategy, consistent with customer sync controls from Phase 18-04.
Output: Three API endpoints for sync granularity + frontend UI dropdown for mode selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-04-PLAN.md

**Key files:**
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/product-sync-service.ts
@archibald-web-app/frontend/src/components/SyncButton.tsx

**Established patterns from Phase 18-04:**
- POST /api/sync/{type}/full - Force full sync
- POST /api/sync/{type}/incremental - Force incremental sync
- POST /api/sync/{type}/:id - Sync single item (placeholder)
- Dropdown UI with 3 modes (Auto, Full, Incremental)
- Sync progress messages show mode indicator

**New endpoints required:**
1. POST /api/sync/products/full - Force full product sync
2. POST /api/sync/products/incremental - Force incremental product sync
3. POST /api/sync/products/:productId - Sync single product (placeholder, 501)

**UI requirements:**
- Update SyncButton for products with same dropdown pattern
- Show sync mode in progress messages
- Display products processed count
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add granular product sync API endpoints to backend</name>
  <files>
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Add three new product sync endpoints (same pattern as Phase 18-04 Task 1):

    1. POST /api/sync/products/full:
    ```typescript
    // Force full product sync - POST /api/sync/products/full
    app.post(
      '/api/sync/products/full',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          logger.info('Force full product sync requested', { userId: req.userId });

          // Non-blocking: trigger sync in background
          productSyncService.forceFullSync().catch((error) => {
            logger.error('Error in force full product sync', { error, userId: req.userId });
          });

          res.json({
            success: true,
            data: null,
            message: 'Sincronizzazione completa prodotti avviata in background'
          });
        } catch (error) {
          logger.error('Error starting force full product sync', { error, userId: req.userId });

          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore avvio sync completo'
          });
        }
      }
    );
    ```

    2. POST /api/sync/products/incremental:
    ```typescript
    // Force incremental product sync - POST /api/sync/products/incremental
    app.post(
      '/api/sync/products/incremental',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          logger.info('Force incremental product sync requested', { userId: req.userId });

          productSyncService.forceIncrementalSync().catch((error) => {
            logger.error('Error in force incremental product sync', { error, userId: req.userId });
          });

          res.json({
            success: true,
            data: null,
            message: 'Sincronizzazione incrementale prodotti avviata (prime 3 pagine)'
          });
        } catch (error) {
          logger.error('Error starting force incremental product sync', { error, userId: req.userId });

          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore avvio sync incrementale'
          });
        }
      }
    );
    ```

    3. POST /api/sync/products/:productId (placeholder):
    ```typescript
    // Sync single product by ID - POST /api/sync/products/:productId
    app.post(
      '/api/sync/products/:productId',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          const { productId } = req.params;

          logger.info('Single product sync requested', { userId: req.userId, productId });

          res.status(501).json({
            success: false,
            data: null,
            message: 'Sync singolo prodotto non ancora implementato (Phase 19-05)'
          });
        } catch (error) {
          logger.error('Error syncing single product', { error, userId: req.userId });

          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore sync singolo prodotto'
          });
        }
      }
    );
    ```

    Why separate endpoints: Consistent with customer sync API from Phase 18-04, RESTful design.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend
    2. Test POST /api/sync/products/full: verify full sync starts
    3. Test POST /api/sync/products/incremental: verify incremental sync starts
    4. Test POST /api/sync/products/:productId: verify 501 response
    5. Check logs show correct sync mode
  </verify>
  <done>
    Three granular product sync endpoints added:
    - POST /api/sync/products/full (force full sync)
    - POST /api/sync/products/incremental (force incremental, 3 pages)
    - POST /api/sync/products/:productId (placeholder, returns 501)
    All endpoints require JWT authentication.
    Non-blocking background sync execution.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend SyncButton to support products with dropdown</name>
  <files>
    archibald-web-app/frontend/src/components/SyncButton.tsx
  </files>
  <action>
    If SyncButton is generic (supports different sync types via props), update to handle products:

    1. If SyncButton takes `syncType` prop ('customers' | 'products' | 'prices'), update endpoint mapping:
    ```typescript
    const handleSync = async () => {
      setSyncing(true);

      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          throw new Error('Token non trovato');
        }

        // Determine endpoint based on sync type and selected mode
        let endpoint = '';
        if (syncType === 'customers') {
          endpoint = selectedMode === 'full'
            ? 'http://localhost:3000/api/sync/customers/full'
            : selectedMode === 'incremental'
            ? 'http://localhost:3000/api/sync/customers/incremental'
            : 'http://localhost:3000/api/sync/customers';
        } else if (syncType === 'products') {
          endpoint = selectedMode === 'full'
            ? 'http://localhost:3000/api/sync/products/full'
            : selectedMode === 'incremental'
            ? 'http://localhost:3000/api/sync/products/incremental'
            : 'http://localhost:3000/api/sync/products';
        }
        // ... handle other sync types ...

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        // ... rest of existing logic ...
      }
      // ... error handling ...
    };
    ```

    2. If SyncButton is customer-specific, create separate ProductSyncButton component or make generic.

    Alternatively, if separate buttons exist per sync type, ensure products button has dropdown (same as customers from Phase 18-04 Task 2).

    Why consistent UI: Same dropdown pattern across all sync types, unified user experience.
  </action>
  <verify>
    npm run typecheck in frontend directory passes

    Manual check:
    1. Navigate to page with product sync button
    2. Click dropdown toggle: verify 3 options appear
    3. Select "Sync Completo": verify full product sync starts
    4. Select "Sync Incrementale": verify incremental product sync starts
    5. Check progress shows product sync mode
  </verify>
  <done>
    SyncButton updated to support product sync with dropdown (or ProductSyncButton created).
    Dropdown menu with 3 modes: Auto, Full, Incremental.
    handleSync calls correct product sync endpoint based on selectedMode.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update sync progress display to show product sync mode</name>
  <files>
    archibald-web-app/frontend/src/components/SyncBanner.tsx
  </files>
  <action>
    Update SyncBanner (or relevant progress display component) to show product sync mode:

    If SyncBanner shows progress for all sync types, update to display mode:
    ```typescript
    {progress.status === 'syncing' && progress.syncType === 'products' && (
      <div style={{ padding: '15px', background: '#3498db', color: 'white', textAlign: 'center' }}>
        Sincronizzazione prodotti in corso...
        <br />
        <small>
          Modalità: {progress.message.includes('incrementale') ? 'Incrementale (veloce)' : 'Completa'}
          {' | '}
          Pagina {progress.currentPage} di {progress.totalPages}
          {' | '}
          Prodotti: {progress.productsProcessed}
        </small>
      </div>
    )}
    ```

    Adapt based on existing progress display structure. Key: show mode indicator for products like customers.

    Why mode indicator: User feedback on sync strategy, consistency with customer sync from Phase 18-04.
  </action>
  <verify>
    npm run typecheck in frontend directory passes

    Manual check:
    1. Trigger full product sync: verify "Modalità: Completa" in progress
    2. Trigger incremental product sync: verify "Modalità: Incrementale (veloce)"
    3. Check progress updates show correct page counts and product counts
  </verify>
  <done>
    Sync progress display updated to show product sync mode.
    Shows "Completa" or "Incrementale (veloce)" based on sync type.
    Progress details include pages and products processed.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend and frontend directories
- [ ] Three granular product sync endpoints added to backend
- [ ] POST /api/sync/products/full triggers full sync
- [ ] POST /api/sync/products/incremental triggers incremental sync
- [ ] POST /api/sync/products/:productId returns 501 (not implemented)
- [ ] Frontend SyncButton supports product sync with dropdown
- [ ] Dropdown menu functional with 3 modes
- [ ] Sync progress shows product sync mode indicator
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Three granular product sync API endpoints functional
- Frontend dropdown UI for product sync mode selection
- Auto mode (default), Full mode, Incremental mode selectable
- Sync progress displays mode indicator for products
- Users have explicit control over product sync strategy
- Single product endpoint placeholder (501 Not Implemented)
- Consistent with customer sync patterns from Phase 18-04
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/19-products-sync-optimization/19-04-SUMMARY.md`:

# Phase 19 Plan 04: Manual Sync Granularity Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/index.ts` - Description
- `archibald-web-app/frontend/src/components/SyncButton.tsx` - Description
- `archibald-web-app/frontend/src/components/SyncBanner.tsx` - Description (if modified)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 19-05-PLAN.md (Sync Optimization & Checkpoint)
</output>
