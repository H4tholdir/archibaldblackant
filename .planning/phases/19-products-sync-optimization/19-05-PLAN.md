---
phase: 19-products-sync-optimization
plan: 05
type: execute
---

<objective>
Apply identified performance optimizations and verify all product sync modes with comprehensive checkpoint.

Purpose: Implement optimization recommendations from 19-01 analysis and validate complete product sync functionality with image handling.
Output: Optimized sync performance (target: 40-50% faster), all sync modes functional, image optimization verified.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-products-sync-optimization/ANALYSIS.md
@.planning/phases/18-customers-sync-optimization/18-05-PLAN.md

**Key files:**
@archibald-web-app/backend/src/product-sync-service.ts
@archibald-web-app/backend/src/image-downloader.ts

**Optimizations identified (from 19-01 ANALYSIS.md)**:
1. Image parallelism optimization (increase concurrent downloads)
2. Skip existing images (already done in 19-03)
3. Page navigation optimization (networkidle2 → domcontentloaded, same as Phase 18-05)
4. Reduce explicit setTimeout delays (same as Phase 18-05)
5. Optional: Lazy background image downloads (if significant gains)

**Performance baseline (from 19-01)**:
- Total duration: ~98.7s (estimated)
- Image downloads: ~35s (35.5%)
- Scraping: ~52s (52.7%)
- Target optimized: ~52-60s (40-50% improvement)

**Sync modes to verify:**
- Full sync (all pages with images)
- Incremental sync (3 pages, skip existing images)
- Auto sync (intelligent mode selection)
- Background sync with retry logic
- Health monitoring and statistics
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply page navigation optimizations from Phase 18-05</name>
  <files>
    archibald-web-app/backend/src/product-sync-service.ts
  </files>
  <action>
    Apply same navigation optimizations from Phase 18-05 Task 1 to ProductSyncService:

    1. Replace networkidle2 with domcontentloaded + explicit selectors:
    ```typescript
    // Initial navigation to product list:
    await page.goto(`${config.archibald.url}/PRODUCT_ListView/`, {
      waitUntil: 'domcontentloaded', // Faster than networkidle2
      timeout: 60000,
    });
    await page.waitForSelector('table tbody tr', { timeout: 10000 });
    ```

    2. Remove unnecessary setTimeout waits, replace with dynamic selectors:
    ```typescript
    // BEFORE:
    await new Promise((resolve) => setTimeout(resolve, 2000));

    // AFTER:
    await page.waitForSelector('table tbody tr', { visible: true, timeout: 5000 });
    ```

    3. Optimize page load wait (if exists):
    ```typescript
    // Replace "Loading..." wait with dynamic check:
    try {
      await page.waitForFunction(
        () => !document.body.textContent?.includes('Loading...'),
        { timeout: 5000 }
      );
    } catch (error) {
      logger.debug('No loading indicator or already cleared');
    }
    ```

    Why same optimizations: Product sync has identical navigation patterns to customer sync, same optimizations apply.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Run product sync with optimization
    2. Verify sync completes successfully
    3. Check logs for navigation phase timing improvement
    4. Ensure no frame detached errors
  </verify>
  <done>
    Page navigation optimized: networkidle2 → domcontentloaded + explicit selectors.
    setTimeout delays replaced with dynamic waits.
    Estimated -7-12s improvement in navigation/scraping phase.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Increase ImageDownloader parallelism for faster downloads</name>
  <files>
    archibald-web-app/backend/src/image-downloader.ts
  </files>
  <action>
    Optimize image download parallelism for faster batch downloads:

    1. Review current parallelism implementation:
       - If using Promise.all without limit: already parallel but may overwhelm server
       - If using sequential downloads: needs parallelism added
       - If using limited concurrency (e.g., p-limit): increase limit

    2. If sequential, add concurrency control:
    ```typescript
    import pLimit from 'p-limit';

    async downloadBatch(images: { url: string; filename: string }[]): Promise<void> {
      // Skip existing images (from 19-03)
      const imagesToDownload = images.filter(/* ... existing skip logic ... */);

      if (imagesToDownload.length === 0) return;

      // Limit to 10 concurrent downloads
      const limit = pLimit(10);

      const downloadPromises = imagesToDownload.map(({ url, filename }) =>
        limit(() => this.downloadSingleImage(url, filename))
      );

      await Promise.all(downloadPromises);

      logger.info(`Downloaded ${imagesToDownload.length} images in parallel`);
    }

    private async downloadSingleImage(url: string, filename: string): Promise<void> {
      // ... existing download logic for single image ...
    }
    ```

    3. If already using p-limit with low concurrency (e.g., 3), increase to 10-15:
    ```typescript
    const limit = pLimit(15); // Increase from 3 to 15
    ```

    4. If using unlimited Promise.all, add rate limiting to prevent overwhelming server:
    ```typescript
    const limit = pLimit(20); // Add reasonable limit
    ```

    Why 10-20 concurrent: Balance between performance and server load, typical web server can handle 10-20 concurrent image requests.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Run product sync and monitor image download timing
    2. Verify images download in parallel (check logs)
    3. Check no image download errors due to rate limiting
    4. Measure image download phase time improvement
  </verify>
  <done>
    ImageDownloader parallelism increased to 10-15 concurrent downloads.
    pLimit added for concurrency control (if not present).
    Batch downloads faster while respecting server limits.
    Estimated -10-15s improvement in image download phase.
    TypeScript compilation passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete product sync optimization with image handling and all modes</what-built>
  <how-to-verify>
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Start frontend: cd archibald-web-app/frontend && npm run dev

    **Test 1: Full Sync Performance with Images**
    3. Trigger full product sync via frontend dropdown: "Sync Completo"
    4. Monitor backend logs for [PERF] timing entries
    5. Verify completion time: Target 52-60s (baseline was ~98s)
    6. Check logs confirm:
       - Login phase: <10s
       - Navigation phase: <3s
       - Scraping phase: <35s (down from ~52s)
       - Image downloads: <20s (down from ~35s, with parallelism)
    7. Verify all products synced successfully
    8. Check images downloaded to disk (verify file count matches product count)

    **Test 2: Incremental Sync with Image Skip**
    9. Wait 1 minute, trigger incremental sync: "Sync Incrementale (veloce)"
    10. Verify logs show "Modalità: incremental"
    11. Verify only first 3 pages scraped
    12. Check logs show "X images skipped (already exist)"
    13. Verify completion time: Target 8-15s (only 3 pages, most images skipped)
    14. Confirm checkpoint manager marks incremental sync

    **Test 3: Auto Mode (Intelligent Selection)**
    15. Immediately trigger auto sync: "Auto (consigliato)"
    16. Verify logs show incremental mode (last full sync < 7 days)
    17. Manually set lastFullSyncAt to 8 days ago in DB
    18. Trigger auto sync again
    19. Verify logs show full mode (last full sync > 7 days)

    **Test 4: Image Optimization Verification**
    20. Delete 10 random product images from disk
    21. Run incremental sync
    22. Verify logs show "10 to download, X already exist"
    23. Check deleted images re-downloaded
    24. Verify incremental sync time still fast (~10-15s with 10 downloads)

    **Test 5: Retry Logic and Health Monitoring**
    25. Simulate failure: stop Archibald server mid-sync
    26. Trigger full product sync
    27. Verify logs show 3 retry attempts with exponential backoff
    28. Verify error state after 3 failed attempts
    29. Check health endpoint: GET /api/sync/products/health
    30. Verify health shows failedSyncs++, isHealthy = false

    **Test 6: Background Auto-Sync**
    31. Restart backend with auto-sync enabled
    32. Verify initial product sync runs after 5 seconds
    33. Wait 30 minutes (or adjust interval)
    34. Verify periodic product sync runs automatically
    35. Check logs show auto mode selection (full vs incremental)

    **Test 7: Frontend Dropdown UI**
    36. Navigate to page with product sync button
    37. Click dropdown toggle
    38. Verify 3 options: Auto, Sync Completo, Sync Incrementale
    39. Select "Sync Completo": verify full sync starts
    40. Check progress shows "Modalità: Completa"
    41. Select "Sync Incrementale": verify incremental sync starts
    42. Check progress shows "Modalità: Incrementale (veloce)"

    **Test 8: Performance Baseline Comparison**
    43. Review performance logs from full sync
    44. Calculate total improvement: (baseline 98.7s - optimized time) / 98.7s
    45. Verify improvement >= 40% (target: 52-60s = 39-48% improvement)
    46. Verify image download improvement >= 40% (target: ~20s from 35s)

    **Success Criteria:**
    - Full sync completes in 52-60s (40-48% improvement)
    - Image downloads: ~20s (43% faster, with parallelism + skip)
    - Incremental sync: 8-15s (85-92% faster)
    - Auto mode intelligently selects full/incremental based on 7-day threshold
    - Image skip optimization works (logs show skip counts)
    - Image parallelism increased (10-15 concurrent)
    - Retry logic handles transient failures (3 attempts with backoff)
    - Health monitoring tracks success rate
    - Health API endpoint returns accurate statistics
    - Frontend dropdown UI functional with 3 modes
    - Progress messages show sync mode
    - All products synced correctly with images
    - No errors or crashes during any sync mode
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] Page navigation optimized (networkidle2 → domcontentloaded)
- [ ] Image parallelism increased (10-15 concurrent downloads)
- [ ] Skip existing images working (from 19-03)
- [ ] No TypeScript errors
- [ ] Full sync performance improved by 40-50%
- [ ] Image download time reduced by 40-50%
- [ ] All sync modes functional (full, incremental, auto, background, manual)
- [ ] User verification approved (comprehensive checkpoint passed)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Performance optimizations applied:
  - Navigation waits optimized (-7-12s)
  - Image parallelism increased (-10-15s)
  - Skip existing images (from 19-03, -5-10s)
- Full sync target: 52-60s (40-48% improvement from 98.7s baseline)
- Image downloads: ~20s (43% faster from 35s)
- Incremental sync: 8-15s (only 3 pages, skip existing images)
- Auto mode intelligently selects sync strategy
- Retry logic with exponential backoff (3 attempts)
- Health monitoring functional
- All sync modes verified by user
- Image handling optimized (parallelism + skip existing)
- Data integrity maintained
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/19-products-sync-optimization/19-05-SUMMARY.md`:

# Phase 19 Plan 05: Sync Optimization & Checkpoint Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/product-sync-service.ts` - Description
- `archibald-web-app/backend/src/image-downloader.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Performance Results

| Metric | Baseline (19-01) | Optimized | Improvement |
|--------|-----------------|-----------|-------------|
| Full sync | 98.7s | [ACTUAL]s | [X]% |
| Image downloads | 35.0s | [ACTUAL]s | [X]% |
| Incremental sync | N/A | [ACTUAL]s | N/A (new) |
| Scraping phase | 52.0s | [ACTUAL]s | [X]% |

## Next Step

Phase 19 complete. Ready for Phase 20 (Prices Sync Analysis & Optimization).
</output>
