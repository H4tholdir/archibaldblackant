---
phase: 07-missing-features
plan: 02
type: execute
---

<objective>
Build the subclient data layer: PostgreSQL table, repository, Excel parser, and wire all subclient stubs to real implementations.

Purpose: Subclients are loaded from Excel in the admin section. The frontend (SubClientSelector, AdminPage) already calls these endpoints but receives empty arrays. Agents need subclient search/lookup to work for the order form (Fresis orders require subclient selection).
Output: Dedicated subclients table, repository with CRUD, Excel parser for admin import, all 5 subclient stubs eliminated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-missing-features/07-CONTEXT.md
@.planning/phases/07-missing-features/07-RESEARCH.md
@.planning/phases/07-missing-features/07-01-SUMMARY.md

# Key source files:
@archibald-web-app/backend/src/server.ts
@archibald-web-app/backend/src/routes/subclients.ts
@archibald-web-app/backend/src/routes/admin.ts
@archibald-web-app/backend/src/db/migrations/003-agent-tables.sql
@archibald-web-app/backend/src/db/repositories/pending-orders.ts
@archibald-web-app/backend/src/db/repositories/fresis-history.ts
@archibald-web-app/backend/src/warehouse-parser.ts
@archibald-web-app/backend/src/arca-import-service.ts
@archibald-web-app/frontend/src/types/sub-client.ts
@archibald-web-app/frontend/src/api/subclients.ts

**Established patterns:**
- Repository pattern: factory function returning object with async methods, accepts DbPool
- Migration pattern: numbered SQL files in src/db/migrations/ (next: 008)
- Excel parsing: xlsx library, XLSX.read(buffer, { type: "buffer" }), sheet_to_json (warehouse-parser.ts)
- Subclient code normalization: normalizeSubClientCode() in arca-import-service.ts

**Constraining decisions:**
- Subclients come from Excel upload in admin section (NOT from bot)
- Backend route Subclient type has 7 fields, frontend SubClient has 15 fields — align backend to support all fields the frontend expects
- Reuse normalizeSubClientCode from arca-import-service.ts for consistency

**CRITICAL from RESEARCH.md:**
- Don't hand-roll Excel parsing — use xlsx (already installed)
- Follow warehouse-parser.ts pattern for Excel parsing
- Follow existing repository pattern (pending-orders.ts, fresis-history.ts)
- Create dedicated agents.subclients table (don't query from fresis_history)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subclient migration and repository</name>
  <files>archibald-web-app/backend/src/db/migrations/008-subclients.sql, archibald-web-app/backend/src/db/repositories/subclients.ts</files>
  <action>
**Migration 008-subclients.sql:**
Create `agents.subclients` table matching the frontend SubClient type fields:
- codice TEXT PRIMARY KEY (the subclient code — unique identifier)
- ragione_sociale TEXT NOT NULL (business name)
- suppl_ragione_sociale TEXT (additional name)
- indirizzo TEXT
- cap TEXT
- localita TEXT
- prov TEXT (province, 2 chars)
- telefono TEXT
- fax TEXT
- email TEXT
- partita_iva TEXT
- cod_fiscale TEXT
- zona TEXT
- pers_da_contattare TEXT
- email_amministraz TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

Add index on ragione_sociale for search performance: `CREATE INDEX idx_subclients_nome ON agents.subclients(ragione_sociale)`.

**Repository subclients.ts:**
Follow existing repository pattern (pending-orders.ts). Create factory function `createSubclientsRepository(pool: DbPool)` returning:
- `getAll()`: SELECT all, ORDER BY ragione_sociale
- `search(query: string)`: WHERE ragione_sociale ILIKE or codice ILIKE `%query%`
- `getByCodice(codice: string)`: SELECT WHERE codice = $1
- `delete(codice: string)`: DELETE WHERE codice = $1, return boolean
- `upsertBatch(subclients: Subclient[])`: INSERT ... ON CONFLICT (codice) DO UPDATE for bulk import

Map snake_case DB columns to camelCase TypeScript properties. The Subclient type in the repository should match what routes/subclients.ts expects but extend it to include all 15 fields from frontend SubClient type (the route type only has 7 fields — either extend the route type or create a richer type in the repository that the route maps to the simpler type).

Use parameterized queries for all operations (no SQL injection).
  </action>
  <verify>npm run build --prefix archibald-web-app/backend succeeds. The migration file exists and is valid SQL. Repository file exports createSubclientsRepository with all 5 methods.</verify>
  <done>Migration 008-subclients.sql creates agents.subclients table with all 15 fields + index. Repository provides getAll, search, getByCodice, delete, upsertBatch with parameterized queries. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Create subclient Excel parser with TDD</name>
  <files>archibald-web-app/backend/src/subclient-parser.ts, archibald-web-app/backend/src/subclient-parser.spec.ts</files>
  <action>
Follow TDD (CLAUDE.md C-1 MUST): scaffold stub → write failing test → implement.

**Scaffold stub:**
Create `parseSubclientsExcel(buffer: Buffer): SubclientParseResult` that returns `{ subclients: [], totalRows: 0, imported: 0, skipped: 0, errors: [] }`.

**Write failing test (subclient-parser.spec.ts):**
Test cases:
- Valid Excel with typical columns (Codice, Ragione Sociale, Indirizzo, CAP, Località, Prov, etc.) → returns parsed subclients with correct field mapping
- Excel with header variations (case-insensitive, extra spaces) → still parses correctly
- Empty Excel → returns { subclients: [], totalRows: 0, imported: 0, skipped: 0, errors: [] }
- Row missing required codice → skipped with error message
- Row missing required ragione_sociale → skipped with error message

Use xlsx library to create test Excel buffers programmatically (`XLSX.utils.book_new()`, `XLSX.utils.json_to_sheet()`, `XLSX.write()`).

**Implement:**
Follow warehouse-parser.ts pattern:
1. `XLSX.read(buffer, { type: "buffer" })`
2. Take first sheet
3. `XLSX.utils.sheet_to_json<Record<string, unknown>>(sheet)`
4. Normalize column headers (trim, lowercase) for flexible matching
5. Map rows to subclient objects: column "codice" → codice, "ragione sociale" → ragioneSociale, etc.
6. Apply normalizeSubClientCode from arca-import-service.ts to codice field
7. Skip rows missing codice or ragione_sociale (add to errors)
8. Return SubclientParseResult with stats

Column mapping should be flexible (case-insensitive, handle common variations):
- codice / Codice / CODICE
- ragione sociale / Ragione Sociale / ragioneSociale / nome
- indirizzo / Indirizzo
- cap / CAP / Cap
- località / localita / Località / citta / città
- prov / Prov / provincia / Provincia
- telefono / Telefono / tel
- etc.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --grep "subclient-parser" passes all tests. npm run build --prefix archibald-web-app/backend succeeds.</verify>
  <done>parseSubclientsExcel function parses Excel buffers into typed subclient arrays. All test cases pass: valid input, header variations, empty file, missing required fields. Column mapping is flexible and case-insensitive.</done>
</task>

<task type="auto">
  <name>Task 3: Wire all subclient stubs in server.ts</name>
  <files>archibald-web-app/backend/src/server.ts, archibald-web-app/backend/src/routes/subclients.ts</files>
  <action>
Wire real subclient implementations to replace all 5 stubs in server.ts:

1. Import createSubclientsRepository and parseSubclientsExcel at top of server.ts
2. Create repository instance: `const subclientsRepo = createSubclientsRepository(pool)`
3. Replace subclient route stubs:
   - `getAllSubclients: async () => []` → `subclientsRepo.getAll()`
   - `searchSubclients: async (_query) => []` → `subclientsRepo.search(query)`
   - `getSubclientByCodice: async (_codice) => null` → `subclientsRepo.getByCodice(codice)`
   - `deleteSubclient: async (_codice) => false` → `subclientsRepo.delete(codice)`
4. Replace admin import stub:
   - `importSubclients: async (_buffer, _filename) => ({ success: true, imported: 0, skipped: 0 })` → parse Excel with parseSubclientsExcel, then upsertBatch into DB, return real stats

If the route Subclient type has fewer fields than what the repository returns, update the route type in subclients.ts to include all fields the frontend SubClient expects (ragioneSociale, indirizzo, cap, localita, prov, telefono, email, partitaIva, codFiscale, zona, persDaContattare, emailAmministraz, supplRagioneSociale, fax). The frontend SubClientSelector.tsx already expects these fields.

DO NOT change the route handler logic — only replace the injected dependency implementations.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend succeeds. npm test --prefix archibald-web-app/backend passes. Grep server.ts for "async () => []" confirms no subclient stubs remain.</verify>
  <done>All 5 subclient stubs eliminated. getAll returns real data from DB. search performs ILIKE query. getByCodice returns single subclient. delete removes from DB. importSubclients parses Excel and upserts to DB. TypeScript compiles, tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes
- [ ] Migration 008-subclients.sql exists and is valid SQL
- [ ] Repository has getAll, search, getByCodice, delete, upsertBatch
- [ ] Excel parser tests pass (valid, variations, empty, missing fields)
- [ ] All 5 subclient stubs in server.ts replaced with real implementations
- [ ] Route Subclient type matches frontend SubClient fields
- [ ] No new TypeScript errors
</verification>

<success_criteria>

- agents.subclients table created with all 15 SubClient fields
- Subclient repository provides full CRUD + batch upsert
- Excel parser handles column variations and validates required fields
- Excel parser has passing tests covering edge cases
- All subclient stubs eliminated from server.ts
- Frontend SubClientSelector will receive real data
- Admin import will parse real Excel files and persist to DB
</success_criteria>

<output>
After completion, create `.planning/phases/07-missing-features/07-02-SUMMARY.md`
</output>
