---
phase: 07-missing-features
plan: 01
type: execute
---

<objective>
Wire createCustomerBot factory to createApp and connect Arca export/import/FT number stubs to their existing service implementations.

Purpose: Eliminate 4 stubs (Group A from research) where backend code is fully implemented but not connected to API endpoints. These are the most impactful stubs — customer creation, Arca export, Arca import, and FT numbering all have complete implementations sitting idle.
Output: 4 previously-stub endpoints returning real data. Customer interactive routes enabled. Arca export produces real DBF ZIP files. FT numbering uses PostgreSQL persistence.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-missing-features/07-CONTEXT.md
@.planning/phases/07-missing-features/07-RESEARCH.md

# Key source files:
@archibald-web-app/backend/src/main.ts
@archibald-web-app/backend/src/server.ts
@archibald-web-app/backend/src/arca-export-service.ts
@archibald-web-app/backend/src/arca-import-service.ts
@archibald-web-app/backend/src/ft-counter.ts
@archibald-web-app/backend/src/bot/archibald-bot.ts
@archibald-web-app/backend/src/routes/customer-interactive.ts
@archibald-web-app/backend/src/operations/handlers/create-customer.ts

**Established patterns:**
- Dependency injection via factory deps in server.ts/main.ts
- Handler registration as type→handler map in main.ts
- OnEmitFn optional callback for domain events (from Phase 5)
- Bot factory pattern: (userId) => BotInstance

**Constraining decisions:**
- Phase 3: bot_results table with check-save-clear pattern for idempotent recovery
- Phase 5: onEmit optional in OperationHandler for backward compat with all 15 handlers
- Phase 6: PdfStoreLike from pdf-store.ts as single source of truth

**CRITICAL from RESEARCH.md — Don't hand-roll:**
- Arca DBF export → use existing arca-export-service.ts
- Arca DBF import → use existing arca-import-service.ts
- FT numbering → use existing ft-counter.ts
- Customer bot → use existing ArchibaldBot methods (createCustomer, navigateToNewCustomerForm, submitVatAndReadAutofill, completeCustomerCreation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire createCustomerBot factory to createApp</name>
  <files>archibald-web-app/backend/src/main.ts, archibald-web-app/backend/src/server.ts</files>
  <action>
In main.ts, create a bot factory function that matches the CustomerBotLike interface expected by customer-interactive.ts routes. The ArchibaldBot class already has all required methods: createCustomer, navigateToNewCustomerForm, submitVatAndReadAutofill, completeCustomerCreation, setProgressCallback.

1. In main.ts, construct the createCustomerBot factory: `(userId: string) => new ArchibaldBot(userId, botDeps)` where botDeps includes browserPool, productDb, getUserById as needed.
2. Pass this factory to createApp() call as the `createCustomerBot` dep.
3. In server.ts, verify createApp uses the createCustomerBot dep to enable the interactive customer routes (the conditional `if (deps.createCustomerBot)` block should now activate).

DO NOT reimplement bot methods — they already exist in archibald-bot.ts.
DO NOT change the ArchibaldBot class — it already conforms to the expected interface.
Check that the bot factory signature matches what customer-interactive.ts expects (CustomerBotLike type).
  </action>
  <verify>npm run build --prefix archibald-web-app/backend succeeds. Grep for "createCustomerBot" in main.ts confirms factory is passed to createApp. Grep server.ts confirms interactive routes are enabled (not gated behind missing dep).</verify>
  <done>createCustomerBot factory wired in main.ts, interactive customer routes enabled in server.ts, TypeScript compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Wire Arca export, import, and FT number stubs to existing services</name>
  <files>archibald-web-app/backend/src/server.ts</files>
  <action>
In server.ts, replace 3 stub implementations with calls to existing service functions:

1. **exportArca** (currently returns empty ZIP buffer): Wire to arca-export-service.ts. Import the service creator/function. Replace stub lambda with call to the real export function that takes userId and returns { zipBuffer, stats }.

2. **importArca** (currently returns empty success): Wire to arca-import-service.ts. Import the service. Replace stub lambda with call to real import function that takes userId, buffer, filename and returns { success, imported, errors }.

3. **getNextFtNumber** (currently always returns 1): Wire to ft-counter.ts. Import getNextFtNumber. Replace stub lambda with call to real function that takes pool/db, userId, esercizio and returns next sequential number from PostgreSQL.

For each wiring:
- Read the existing service file to understand the exact function signature
- Import the service/function at top of server.ts
- Replace the stub lambda with a call that passes the correct arguments (pool, userId, etc.)
- Ensure the return type matches what the route handler expects

DO NOT modify the service files (arca-export-service.ts, arca-import-service.ts, ft-counter.ts) — they are complete.
DO NOT change route handler signatures — only replace the injected dependency implementation.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend succeeds. npm test --prefix archibald-web-app/backend passes. Grep server.ts for "Buffer.from('')" and "=> 1" confirms stubs are replaced.</verify>
  <done>exportArca returns real DBF ZIP, importArca parses real DBF files, getNextFtNumber returns progressive PostgreSQL number. All 3 stubs eliminated. TypeScript compiles, existing tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes
- [ ] createCustomerBot factory passed to createApp in main.ts
- [ ] Interactive customer routes activated (not behind missing dep guard)
- [ ] exportArca stub replaced with real service call
- [ ] importArca stub replaced with real service call
- [ ] getNextFtNumber stub replaced with real service call
- [ ] No new TypeScript errors introduced
</verification>

<success_criteria>

- 4 Group A stubs eliminated (createCustomerBot, exportArca, importArca, getNextFtNumber)
- Customer interactive routes enabled end-to-end
- Arca export produces real DBF files in ZIP format
- FT numbering uses PostgreSQL persistence (not hardcoded 1)
- All existing tests pass
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-missing-features/07-01-SUMMARY.md`
</output>
