---
phase: 07-missing-features
plan: 03
type: execute
---

<objective>
Audit and wire remaining Group C stubs, then verify the entire Phase 7 — no 501 responses remain for actively-used endpoints.

Purpose: Complete the stub elimination by handling lower-priority stubs (warehouse importExcel, prices importExcel, sync clearSyncData, warehouse validateArticle). Then run full verification to confirm Phase 7 is complete.
Output: All actively-used stubs eliminated. Full type-check and test pass. Phase 7 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-missing-features/07-CONTEXT.md
@.planning/phases/07-missing-features/07-RESEARCH.md
@.planning/phases/07-missing-features/07-01-SUMMARY.md
@.planning/phases/07-missing-features/07-02-SUMMARY.md

# Key source files:
@archibald-web-app/backend/src/server.ts
@archibald-web-app/backend/src/routes/warehouse.ts
@archibald-web-app/backend/src/routes/sync-status.ts
@archibald-web-app/frontend/src/api/warehouse.ts
@archibald-web-app/frontend/src/api/prices.ts
@archibald-web-app/frontend/src/api/sync.ts

**From RESEARCH.md — Group C stubs:**
| # | Stub | Location | Notes |
|---|------|----------|-------|
| 10 | warehouse importExcel | server.ts:259 | Returns stub with 0 imports |
| 11 | prices importExcel | server.ts:211 | Returns stub with 0 matches |
| 12 | sync clearSyncData | sync-status.ts:245 | Returns 501 if dep not provided |
| 13 | warehouse validateArticle | warehouse.ts:377 | Returns 501 if dep not provided |

**Approach:**
These stubs use optional dependency injection — they return 501 only when the dep is not provided. The strategy is:
1. Check if the frontend actively calls these endpoints (grep frontend API files)
2. If actively used: implement the dependency and wire it
3. If not actively used: document as deferred (Phase 8+ or never needed)
4. For any that ARE wired: the implementation should follow existing patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and wire remaining Group C stubs</name>
  <files>archibald-web-app/backend/src/server.ts, archibald-web-app/backend/src/routes/warehouse.ts, archibald-web-app/backend/src/routes/sync-status.ts</files>
  <action>
**Step 1 — Audit frontend usage:**
Grep the frontend source for API calls to each Group C endpoint:
- `warehouse/upload` or `importExcel` in frontend API files
- `prices/import-excel` in frontend API files
- `sync/*/clear-db` or `clearSyncData` in frontend API files
- `warehouse/items/validate` in frontend API files

**Step 2 — For each actively-used endpoint, wire the implementation:**

For **warehouse importExcel** (if frontend calls it): The warehouse-parser.ts already exists and parses Excel files into WarehouseItem[]. Wire parseWarehouseFile to the importExcel dep. The implementation should: parse buffer with parseWarehouseFile, insert items into agents.warehouse_items table via existing warehouse repository, return stats { success, imported, skipped, errors }.

For **prices importExcel** (if frontend calls it): Check if there's an existing price Excel parser or if it needs creation. If it needs creation, follow warehouse-parser.ts pattern. Wire to the importExcel dep for prices routes.

For **sync clearSyncData** (if frontend calls it): Implement clearSyncData as a function that DELETEs data from the appropriate table based on sync type (customers, products, prices, orders, ddt, invoices). Use the pool to execute parameterized DELETE query on the agents schema table.

For **warehouse validateArticle** (if frontend calls it): Implement as a simple product DB lookup — check if article code exists in the products table and return validation result.

**Step 3 — For endpoints NOT actively used by frontend:**
Leave as optional deps (current behavior is acceptable — they return 501 only when explicitly called without the dep). Add a brief note in the summary about which stubs were deferred and why.

DO NOT implement stubs that the frontend never calls — that would be unnecessary work.
DO NOT change route handler logic — only provide the missing dependency implementations.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend succeeds. npm test --prefix archibald-web-app/backend passes. For any wired endpoint: grep confirms stub replaced. For deferred endpoints: documented in summary.</verify>
  <done>All actively-used Group C stubs wired to real implementations. Unused stubs documented as deferred. TypeScript compiles, tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Full Phase 7 verification</name>
  <files>archibald-web-app/backend/src/server.ts</files>
  <action>
Run comprehensive verification of all Phase 7 work:

1. **TypeScript check:**
   - `npm run build --prefix archibald-web-app/backend`
   - `npm run type-check --prefix archibald-web-app/frontend`

2. **Test suites:**
   - `npm test --prefix archibald-web-app/backend`
   - `npm test --prefix archibald-web-app/frontend`

3. **Stub audit:**
   Grep server.ts for remaining stub patterns:
   - `=> []` (empty array returns)
   - `=> null` (null returns)
   - `=> false` (false returns)
   - `=> 1` (hardcoded numbers)
   - `Buffer.from('')` (empty buffers)
   - `imported: 0` in stub context
   - `Not yet implemented`

   For each remaining stub found: verify it's either (a) in Group C and documented as deferred because frontend doesn't call it, or (b) a legitimate default value.

4. **Summary of all stubs resolved:**
   Create a final accounting: which stubs were wired (Plans 07-01, 07-02, 07-03), which were deferred, and why.

If any verification step fails, fix the issue before proceeding.
  </action>
  <verify>All 4 verification commands pass (backend build, frontend type-check, backend tests, frontend tests). Stub audit shows no actively-used stubs remaining.</verify>
  <done>Phase 7 fully verified. All actively-used stubs eliminated. TypeScript compiles on both frontend and backend. All tests pass. Final stub accounting documented.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm run type-check --prefix archibald-web-app/frontend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/frontend` passes
- [ ] No actively-used stubs remain in server.ts
- [ ] All Group A stubs wired (07-01)
- [ ] All Group B stubs wired (07-02)
- [ ] Group C stubs audited and either wired or documented as deferred (07-03)
- [ ] No new TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Phase 7 complete: every actively-used stub returns real data
- createCustomerBot wired (07-01)
- Arca export/import/FT wired (07-01)
- Subclients CRUD + Excel import wired (07-02)
- Remaining stubs audited and resolved (07-03)
- Final stub accounting documented
- Phase 7 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-missing-features/07-03-SUMMARY.md` with:
- Final accounting of all stubs: wired vs deferred
- Phase 7 complete status
- Ready for Phase 8: Unit & Integration Tests
</output>
