---
phase: 18-customers-sync-optimization
plan: 03
type: execute
---

<objective>
Implement incremental sync strategy to sync only customers changed since last successful sync.

Purpose: Reduce sync time for subsequent syncs by only fetching new or recently modified customer data.
Output: Delta sync mode in syncCustomers with lastModified tracking, reducing sync time by ~80-90% for incremental runs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@archibald-web-app/backend/src/customer-sync-service.ts
@archibald-web-app/backend/src/customer-db.ts
@archibald-web-app/backend/src/sync-checkpoint.ts

**Tech stack available:**
- SQLite with better-sqlite3
- Puppeteer for scraping
- SyncCheckpointManager for resume points

**Existing sync implementation:**
- Full sync: Scrapes all customers every time
- Checkpoint resume: Resumes from specific page on interruption
- No incremental/delta sync capability

**Incremental sync strategy:**
- Track lastSyncedAt timestamp in checkpoint manager
- On incremental sync: Compare Archibald "last modified" dates with lastSyncedAt
- Only process customers where lastModified > lastSyncedAt
- Fallback to full sync if no lastSyncedAt or if >7 days old

**Challenges:**
- Archibald may not expose lastModified dates in customer list
- Alternative: Use heuristic (check if customer data changed via hash comparison)
- If no reliable change detection: Make incremental sync scrape first N pages only

**Implementation approach:**
- Add syncMode parameter to syncCustomers ('full' | 'incremental')
- Incremental mode: Scrape first 2-3 pages only (most recent customers)
- Store lastFullSyncAt timestamp
- Force full sync every 7 days, incremental in between
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lastFullSyncAt tracking to SyncCheckpointManager</name>
  <files>
    archibald-web-app/backend/src/sync-checkpoint.ts
  </files>
  <action>
    Extend SyncCheckpointManager to track last full sync timestamp:

    1. Update checkpoint interface (if defined):
    ```typescript
    interface SyncCheckpoint {
      syncType: 'customers' | 'products' | 'prices';
      lastPage: number;
      lastFullSyncAt: number | null; // Unix timestamp
      lastIncrementalSyncAt: number | null; // Unix timestamp
      totalItems: number;
      updatedAt: number;
    }
    ```

    2. Add methods to track full sync completion:
    ```typescript
    /**
     * Mark full sync as completed
     */
    markFullSyncCompleted(syncType: 'customers' | 'products' | 'prices'): void {
      const now = Date.now();

      const stmt = this.db.prepare(`
        INSERT INTO sync_checkpoints (syncType, lastPage, lastFullSyncAt, lastIncrementalSyncAt, totalItems, updatedAt)
        VALUES (?, -1, ?, NULL, 0, ?)
        ON CONFLICT(syncType) DO UPDATE SET
          lastPage = -1,
          lastFullSyncAt = ?,
          updatedAt = ?
      `);

      stmt.run(syncType, now, now, now, now);

      logger.info(`Full sync marked complete for ${syncType}`, {
        timestamp: new Date(now).toISOString()
      });
    }

    /**
     * Mark incremental sync as completed
     */
    markIncrementalSyncCompleted(syncType: 'customers' | 'products' | 'prices'): void {
      const now = Date.now();

      const stmt = this.db.prepare(`
        INSERT INTO sync_checkpoints (syncType, lastPage, lastFullSyncAt, lastIncrementalSyncAt, totalItems, updatedAt)
        VALUES (?, -1, NULL, ?, 0, ?)
        ON CONFLICT(syncType) DO UPDATE SET
          lastPage = -1,
          lastIncrementalSyncAt = ?,
          updatedAt = ?
      `);

      stmt.run(syncType, now, now, now, now);

      logger.info(`Incremental sync marked complete for ${syncType}`, {
        timestamp: new Date(now).toISOString()
      });
    }

    /**
     * Get last full sync timestamp
     */
    getLastFullSyncAt(syncType: 'customers' | 'products' | 'prices'): number | null {
      const stmt = this.db.prepare(
        'SELECT lastFullSyncAt FROM sync_checkpoints WHERE syncType = ?'
      );

      const row = stmt.get(syncType) as { lastFullSyncAt: number | null } | undefined;
      return row?.lastFullSyncAt || null;
    }

    /**
     * Check if full sync is needed (>7 days since last full sync)
     */
    needsFullSync(syncType: 'customers' | 'products' | 'prices'): boolean {
      const lastFullSync = this.getLastFullSyncAt(syncType);

      if (!lastFullSync) {
        return true; // Never done full sync
      }

      const daysSinceLastFullSync = (Date.now() - lastFullSync) / (1000 * 60 * 60 * 24);
      return daysSinceLastFullSync >= 7;
    }
    ```

    3. Update schema in initSchema (add columns if not exist):
    ```typescript
    this.db.exec(`
      ALTER TABLE sync_checkpoints ADD COLUMN lastFullSyncAt INTEGER;
      ALTER TABLE sync_checkpoints ADD COLUMN lastIncrementalSyncAt INTEGER;
    `);
    ```

    Handle column already exists error gracefully (try/catch or IF NOT EXISTS if supported).

    Why 7-day threshold: Balances data freshness with sync efficiency, ensures full refresh weekly to catch edge cases.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend and verify schema migration runs
    2. Check sync_checkpoints table has lastFullSyncAt and lastIncrementalSyncAt columns
    3. Test needsFullSync() returns true for new syncs, false for recent syncs
  </verify>
  <done>
    SyncCheckpointManager extended with lastFullSyncAt and lastIncrementalSyncAt tracking.
    markFullSyncCompleted() and markIncrementalSyncCompleted() methods added.
    needsFullSync() checks 7-day threshold.
    Schema migration adds new columns.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add syncMode parameter to syncCustomers and implement incremental logic</name>
  <files>
    archibald-web-app/backend/src/customer-sync-service.ts
  </files>
  <action>
    Add syncMode parameter to syncCustomers for full vs incremental sync:

    1. Update method signature:
    ```typescript
    /**
     * Sincronizza i clienti da Archibald
     * @param syncMode 'full' = scrape all pages, 'incremental' = scrape recent pages only, 'auto' = decide based on last sync
     */
    async syncCustomers(syncMode: 'full' | 'incremental' | 'auto' = 'auto'): Promise<void> {
      // ... existing checks (syncInProgress, paused, etc.) ...

      // Determine actual sync mode
      let actualSyncMode: 'full' | 'incremental' = syncMode === 'auto'
        ? (this.checkpointManager.needsFullSync('customers') ? 'full' : 'incremental')
        : syncMode;

      logger.info(`ðŸ”„ Customer sync mode: ${actualSyncMode}`, {
        requested: syncMode,
        needsFullSync: this.checkpointManager.needsFullSync('customers'),
        lastFullSync: this.checkpointManager.getLastFullSyncAt('customers')
      });

      // ... rest of existing logic ...
    }
    ```

    2. Inside sync loop, implement incremental logic:
    ```typescript
    // After determining total pages (line ~450):
    const totalPages = /* ... existing pagination detection ... */;

    // Limit pages for incremental sync
    const pagesToScrape = actualSyncMode === 'incremental'
      ? Math.min(3, totalPages) // Only first 3 pages for incremental
      : totalPages;

    logger.info(`Pages to scrape: ${pagesToScrape} of ${totalPages} (mode: ${actualSyncMode})`);

    this.updateProgress({
      status: 'syncing',
      currentPage: resumePoint || 1,
      totalPages: pagesToScrape,
      customersProcessed: 0,
      message: actualSyncMode === 'incremental'
        ? 'Sincronizzazione incrementale (pagine recenti)...'
        : 'Sincronizzazione completa...'
    });

    // Pagination loop with page limit
    for (let currentPage = resumePoint || 1; currentPage <= pagesToScrape; currentPage++) {
      // ... existing scraping logic ...
    }
    ```

    3. Mark sync type on completion:
    ```typescript
    // At end of successful sync (finally block or completion):
    if (actualSyncMode === 'full') {
      this.checkpointManager.markFullSyncCompleted('customers');
    } else {
      this.checkpointManager.markIncrementalSyncCompleted('customers');
    }
    ```

    Why 3-page limit for incremental: Most recent customers appear on first pages, covers ~90% of changes, reduces sync time by 85-90%.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Run full sync: verify all pages scraped
    2. Run incremental sync: verify only 3 pages scraped
    3. Run auto sync: verify full sync on first run, incremental on subsequent runs
    4. Check checkpoint manager tracks sync mode correctly
  </verify>
  <done>
    syncMode parameter added to syncCustomers ('full', 'incremental', 'auto').
    Auto mode decides based on needsFullSync() (7-day threshold).
    Incremental mode limits to first 3 pages.
    Checkpoint manager marks sync type on completion.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update auto-sync and retry logic to use auto mode</name>
  <files>
    archibald-web-app/backend/src/customer-sync-service.ts
  </files>
  <action>
    Update existing sync calls to use 'auto' mode by default:

    1. Update syncCustomersWithRetry wrapper:
    ```typescript
    private async syncCustomersWithRetry(syncMode: 'full' | 'incremental' | 'auto' = 'auto'): Promise<void> {
      this.syncStats.totalAttempts++;

      for (let attempt = 1; attempt <= this.MAX_RETRIES; attempt++) {
        try {
          await this.syncCustomers(syncMode); // Pass syncMode parameter

          // ... rest of existing logic ...
        }
        // ... rest of existing retry logic ...
      }
    }
    ```

    2. Update startAutoSync:
    ```typescript
    startAutoSync(intervalMinutes: number = 30, skipInitialSync: boolean = false): void {
      logger.info(
        `Avvio auto-sync ogni ${intervalMinutes} minuti (mode: auto)`,
      );

      if (!skipInitialSync) {
        setTimeout(() => {
          this.syncCustomersWithRetry('auto').catch((error) => { // Use 'auto' mode
            logger.error('Errore sync iniziale (dopo retry)', { error });
          });
        }, 5000);
      }

      this.syncInterval = setInterval(
        () => {
          this.syncCustomersWithRetry('auto').catch((error) => { // Use 'auto' mode
            logger.error('Errore sync periodico (dopo retry)', { error });
          });
        },
        intervalMinutes * 60 * 1000,
      );
    }
    ```

    3. Add public method for manual full sync:
    ```typescript
    /**
     * Force full sync (ignores 7-day check)
     */
    async forceFullSync(): Promise<void> {
      await this.syncCustomersWithRetry('full');
    }

    /**
     * Force incremental sync
     */
    async forceIncrementalSync(): Promise<void> {
      await this.syncCustomersWithRetry('incremental');
    }
    ```

    Why auto mode default: Automatically optimizes sync strategy, reduces load on Archibald server, maintains weekly full refresh for data integrity.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start auto-sync and verify first run is full sync
    2. Trigger sync again within 7 days: verify incremental sync
    3. Call forceFullSync(): verify full sync regardless of last sync time
    4. Check logs show correct sync mode decisions
  </verify>
  <done>
    syncCustomersWithRetry updated with syncMode parameter.
    startAutoSync uses 'auto' mode for intelligent sync strategy.
    forceFullSync() and forceIncrementalSync() methods added for manual control.
    Auto mode automatically chooses full/incremental based on 7-day threshold.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] SyncCheckpointManager tracks lastFullSyncAt and lastIncrementalSyncAt
- [ ] needsFullSync() returns correct result based on 7-day threshold
- [ ] syncCustomers supports 'full', 'incremental', 'auto' modes
- [ ] Incremental mode limits to first 3 pages
- [ ] Auto mode chooses sync strategy automatically
- [ ] forceFullSync() and forceIncrementalSync() methods functional
- [ ] No TypeScript errors
- [ ] Incremental sync reduces execution time by 80-90%
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Incremental sync strategy implemented with 3-page limit
- Auto mode intelligently chooses full vs incremental sync
- Full sync forced every 7 days for data integrity
- Manual control methods (forceFullSync, forceIncrementalSync) available
- Sync time reduced by 80-90% for incremental runs
- Checkpoint manager tracks sync types and timestamps
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/18-customers-sync-optimization/18-03-SUMMARY.md`:

# Phase 18 Plan 03: Incremental Sync Implementation Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/customer-sync-service.ts` - Description
- `archibald-web-app/backend/src/sync-checkpoint.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 18-04-PLAN.md (Manual Sync Granularity)
</output>
