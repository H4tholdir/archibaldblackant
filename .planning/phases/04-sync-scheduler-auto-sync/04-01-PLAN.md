---
phase: 04-sync-scheduler-auto-sync
plan: 01
type: execute
---

<objective>
Create persistent storage for sync interval configuration so intervals survive server restarts and can be managed via admin API.

Purpose: The sync scheduler currently has no persistence — intervals are in-memory only and lost on restart. A DB-backed settings layer is the foundation for the bootstrap (Plan 02) and admin UI wiring.
Output: Migration `007-sync-settings.sql`, repository `sync-settings.ts` with tests, seeded default intervals.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sync-scheduler-auto-sync/04-CONTEXT.md
@.planning/phases/04-sync-scheduler-auto-sync/04-RESEARCH.md

# Key source files:
@archibald-web-app/backend/src/db/migrations/004-system-tables.sql
@archibald-web-app/backend/src/db/migrations/006-bot-results.sql
@archibald-web-app/backend/src/db/repositories/users.ts
@archibald-web-app/backend/src/db/repositories/users.spec.ts

**Established patterns:**
- DB repositories use `DbPool` parameter (from pg pool) — see users.ts
- Migrations use `CREATE TABLE IF NOT EXISTS` with schema prefix (system.*, agents.*, shared.*)
- Repository tests use `vi.fn()` mocks for pool.query — see users.spec.ts
- Branded types for IDs (CLAUDE.md C-5)
- `import type { ... }` for type-only imports (CLAUDE.md C-6)

**Constraining decisions:**
- Phase 2: BullMQ deduplication already handles duplicate syncs — repository just persists intervals
- Phase 3: bot-result-store.ts is the most recent repository pattern (006 migration, pure functions)

**From RESEARCH.md:**
- Next migration number: 007
- Default intervals from test expectations: orders=10, customers=15, products=30, prices=60, ddt=20, invoices=20 (minutes)
- Table goes in `system` schema (infrastructure config, not agent data)
- `sync_type TEXT PRIMARY KEY` with CHECK constraint for valid types
- `interval_minutes INTEGER` with CHECK between 5 and 1440
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync_settings DB migration</name>
  <files>archibald-web-app/backend/src/db/migrations/007-sync-settings.sql</files>
  <action>
Create migration 007-sync-settings.sql in the system schema:

```sql
CREATE TABLE IF NOT EXISTS system.sync_settings (
  sync_type TEXT PRIMARY KEY
    CHECK (sync_type IN ('orders', 'customers', 'products', 'prices', 'ddt', 'invoices')),
  interval_minutes INTEGER NOT NULL DEFAULT 30
    CHECK (interval_minutes BETWEEN 5 AND 1440),
  enabled BOOLEAN NOT NULL DEFAULT TRUE,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Seed with default values matching the test expectations in sync-status.spec.ts:
- orders: 10 min
- customers: 15 min
- ddt: 20 min
- invoices: 20 min
- products: 30 min
- prices: 60 min

Use INSERT ... ON CONFLICT DO NOTHING to be idempotent.

Follow the migration pattern from 006-bot-results.sql (simple, no migration tracking table — app runs all migrations on startup via IF NOT EXISTS).
  </action>
  <verify>
Check migration SQL is valid by reviewing it manually. Verify it follows the pattern of existing migrations (IF NOT EXISTS, schema prefix, indexes where needed).
  </verify>
  <done>Migration file 007-sync-settings.sql exists with CREATE TABLE + seed INSERT, follows existing migration patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create sync-settings repository with integration tests</name>
  <files>
archibald-web-app/backend/src/db/repositories/sync-settings.ts,
archibald-web-app/backend/src/db/repositories/sync-settings.spec.ts
  </files>
  <action>
Create `sync-settings.ts` repository following the pattern from `users.ts`:
- Accept `DbPool` as first parameter
- Export functions (not a class — CLAUDE.md C-3, C-4):

1. `getAllIntervals(pool: DbPool): Promise<Record<SyncType, number>>` — returns all 6 intervals as `{ orders: 10, customers: 15, ... }` in minutes
2. `getInterval(pool: DbPool, syncType: SyncType): Promise<number>` — returns single interval in minutes, throws if not found
3. `updateInterval(pool: DbPool, syncType: SyncType, intervalMinutes: number): Promise<void>` — UPDATE ... SET interval_minutes = $2, updated_at = NOW() WHERE sync_type = $1
4. `isEnabled(pool: DbPool, syncType: SyncType): Promise<boolean>` — returns enabled flag
5. `setEnabled(pool: DbPool, syncType: SyncType, enabled: boolean): Promise<void>` — UPDATE enabled flag

Define `SyncType` as a union type: `'orders' | 'customers' | 'products' | 'prices' | 'ddt' | 'invoices'`.

Create `sync-settings.spec.ts` following the pattern from `users.spec.ts`:
- Mock `pool.query` with `vi.fn()`
- Test getAllIntervals: verify SQL query and mapping of rows to Record
- Test updateInterval: verify parameterized query with correct values
- Test getInterval: verify single-row query and throw on not-found
- Test edge cases: empty result set for getAllIntervals returns empty object

Follow CLAUDE.md rules:
- T-1: Colocate tests in same directory
- T-6: Test entire structure in one assertion
- C-6: Use `import type` for type-only imports
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run sync-settings</verify>
  <done>Repository exports 5 functions, all tests pass, TypeScript compiles (npm run build --prefix archibald-web-app/backend).</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend -- --run sync-settings` passes
- [ ] Migration file follows existing patterns (IF NOT EXISTS, system schema, seed data)
- [ ] Repository uses DbPool parameter pattern (consistent with users.ts)
</verification>

<success_criteria>

- Migration 007-sync-settings.sql created with table + seed defaults
- sync-settings.ts repository with 5 exported functions
- sync-settings.spec.ts with passing unit tests
- TypeScript compiles without errors
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-sync-scheduler-auto-sync/04-01-SUMMARY.md`
</output>
