---
phase: 04-sync-scheduler-auto-sync
plan: 03
type: execute
---

<objective>
Protect customer sync from parser failures that could delete valid data, and surface sync warnings in the admin monitoring API.

Purpose: If a PDF download is incomplete or the parser fails, the current sync deletes all existing customers and replaces them with the (incomplete) parsed data — causing data loss. This plan adds validation to prevent data loss and surfaces warnings to the admin.
Output: Protected customer sync handler with count validation, warning logging in sync events, warnings visible in monitoring API.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sync-scheduler-auto-sync/04-CONTEXT.md
@.planning/phases/04-sync-scheduler-auto-sync/04-RESEARCH.md
@.planning/phases/04-sync-scheduler-auto-sync/04-01-SUMMARY.md
@.planning/phases/04-sync-scheduler-auto-sync/04-02-SUMMARY.md

# Key source files:
@archibald-web-app/backend/src/operations/handlers/sync-customers.ts
@archibald-web-app/backend/src/routes/sync-status.ts
@archibald-web-app/backend/src/db/migrations/004-system-tables.sql

**Established patterns:**
- Sync handlers receive (data, deps) and return OperationResult
- shouldStop polling every 10 records in DB loops (Phase 2)
- system.sync_events table exists for audit logging (004 migration)
- SyncMonitoringDashboard already reads history with warnings field (HistoryEntry.warnings?: string[])
- sync-status routes already serve monitoring data with health/history

**Constraining decisions:**
- CONTEXT.md: Skip + alert admin on parser failure (don't touch existing data)
- RESEARCH.md pitfall: "delete all + re-insert" pattern is the risk. Validate BEFORE committing.
- RESEARCH.md: If customer count drops >50% vs last known count, flag as suspicious

**From RESEARCH.md - Don't hand-roll:**
- system.sync_events already exists for logging — use it for warnings
- SyncMonitoringDashboard already has warnings display (HistoryEntry.warnings field)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parser validation to customer sync handler</name>
  <files>
archibald-web-app/backend/src/operations/handlers/sync-customers.ts,
archibald-web-app/backend/src/operations/handlers/sync-customers.spec.ts
  </files>
  <action>
Add customer count validation to the sync-customers handler to prevent data loss from incomplete PDF parsing.

**Validation logic:**

1. BEFORE the sync starts its DB transaction, query the current customer count for this agent:
   ```sql
   SELECT COUNT(*) FROM agents.customers WHERE user_id = $1
   ```

2. After the bot downloads and parses the PDF, count the parsed customers.

3. **Validation rules:**
   - If `currentCount > 0` AND `parsedCount === 0`: SKIP sync entirely. Log warning: "Parser returned 0 customers, existing {currentCount} preserved."
   - If `currentCount > 10` AND `parsedCount < currentCount * 0.5`: SKIP sync. Log warning: "Customer count dropped from {currentCount} to {parsedCount} (>{50}% drop), possible incomplete PDF."
   - If `parsedCount >= currentCount * 0.5` OR `currentCount <= 10` OR `currentCount === 0`: PROCEED normally.

4. When skipping, return an OperationResult with `success: true` but include a `warnings` array in the result:
   ```typescript
   return { success: true, warnings: ['Customer count dropped...'] };
   ```
   Do NOT throw an error — this is a protective skip, not a failure.

5. Log the warning to system.sync_events with event_type = 'parser_warning' and details containing the warning message, currentCount, parsedCount.

**Write tests in sync-customers.spec.ts:**
- Test: 0 parsed customers with existing data → skip + warning
- Test: >50% drop with >10 existing → skip + warning
- Test: normal count (no significant drop) → proceed
- Test: first sync (currentCount=0) → always proceed regardless of parsedCount
- Test: small dataset (currentCount <= 10) → always proceed

Mock the DB count query and parser output. Do NOT mock the actual sync logic — just verify the validation gate.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run sync-customers</verify>
  <done>
Customer sync validates parser output before committing.
Zero-result and >50% drop triggers protective skip with warning.
First-time sync and small datasets always proceed.
Warning logged to sync_events.
All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Surface sync warnings in monitoring API</name>
  <files>
archibald-web-app/backend/src/routes/sync-status.ts,
archibald-web-app/backend/src/routes/sync-status.spec.ts
  </files>
  <action>
Ensure sync warnings from parser validation are visible in the admin monitoring dashboard.

**1. Check if warnings already flow through:**

The SyncMonitoringDashboard frontend already expects `warnings?: string[]` in HistoryEntry. Check if the monitoring status API (GET /monitoring/status) already includes warnings from job results. If it does, the frontend should display them automatically.

If warnings are NOT flowing through from job results to the monitoring API:

**2. Add warnings to monitoring status response:**

In the GET /monitoring/status route, when building the response for each sync type, include warnings from the most recent sync_events where event_type = 'parser_warning':

```sql
SELECT details->>'warning' as warning, created_at
FROM system.sync_events
WHERE user_id = $1 AND sync_type = $2 AND event_type = 'parser_warning'
ORDER BY created_at DESC
LIMIT 5
```

Include these in the response under each sync type's status.

**3. Add a warnings summary endpoint (optional):**

If the existing monitoring structure doesn't accommodate per-type warnings naturally, add a simple endpoint:

```
GET /api/sync/warnings?since=<timestamp>
```

Returns recent parser warnings grouped by sync type.

**4. Update tests:**
- Test monitoring status includes warnings when parser_warning events exist
- Test no warnings when no parser_warning events

Keep it simple — the frontend already has the UI to display warnings (HistoryEntry.warnings field with warning icon). The backend just needs to populate the data.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run sync-status</verify>
  <done>
Parser warnings visible in monitoring API response.
SyncMonitoringDashboard can display warnings without frontend changes.
Tests pass for warning scenarios.
TypeScript compiles.
Phase 4 complete.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes ALL tests
- [ ] Customer sync skips on 0-result parse (doesn't delete existing data)
- [ ] Customer sync skips on >50% count drop (doesn't delete existing data)
- [ ] Customer sync proceeds normally when count is valid
- [ ] Warnings logged to system.sync_events
- [ ] Warnings visible in monitoring API response
- [ ] Phase 4 complete: scheduler boots, intervals persist, customer sync protected
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Customer data protected from parser failures
- Admin can see sync warnings in monitoring dashboard
- No regressions in existing tests
- Phase 4: Sync Scheduler & Auto-Sync complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-sync-scheduler-auto-sync/04-03-SUMMARY.md`

This is the final plan for Phase 4. Update:
- ROADMAP.md: Mark Phase 4 as complete
- STATE.md: Update current position to Phase 5
</output>
