---
phase: 09-offline-queue
plan: 03
type: execute
---

<objective>
Add detailed conflict resolution UI for reviewing and re-confirming orders before sync.

Purpose: Allow users to review specific conflicts (price changes, discontinued products) and make informed decisions per-order.
Output: Order review modal with conflict details and re-confirmation workflow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior Phase Context:
@.planning/phases/09-offline-queue/09-01-SUMMARY.md
@.planning/phases/09-offline-queue/09-02-SUMMARY.md

# Existing Infrastructure:
@archibald-web-app/frontend/src/services/conflict-detection.ts
@archibald-web-app/frontend/src/services/cache-service.ts
@archibald-web-app/frontend/src/pages/PendingOrdersView.tsx

**Tech Stack Available:**
- CacheService for fetching current prices/products
- ConflictDetectionService for staleness detection
- PendingOrder contains full order data for comparison

**Established Patterns:**
- Banking app UX with modal confirmations
- Status badges with semantic colors
- Inline styles for components

**Constraining Decisions:**
- Phase 8-07: PendingOrder stores complete API-compliant data
- Phase 9-02: User can choose to continue despite conflicts
- Phase 8: Banking app aesthetic for serious decisions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderConflictReview component for detailed conflict display</name>
  <files>archibald-web-app/frontend/src/components/OrderConflictReview.tsx</files>
  <action>
Create OrderConflictReview modal component:
- Props: order (PendingOrder), currentCache (products/prices), onConfirm, onCancel
- Display order summary: customer name, items, total
- For each item, compare queued data vs current cache:
  - Price changed: show old price (strikethrough) ‚Üí new price (red if higher, green if lower)
  - Product not found: show "‚ö†Ô∏è Prodotto non disponibile" warning
  - Product name changed: show old name ‚Üí new name
- Show total price difference if prices changed: "Totale originale: ‚Ç¨X ‚Üí Nuovo totale: ‚Ç¨Y (¬±Z%)"
- Bottom actions: "Conferma Modifiche" (blue, submits with current data) | "Annulla" (gray, goes back)
- Banking app modal style: centered, white background, 16px padding, shadow
Use inline styles consistent with Phase 8-06 patterns.
  </action>
  <verify>OrderConflictReview displays order details with conflict highlights</verify>
  <done>Modal shows detailed conflicts with old vs new data comparison</done>
</task>

<task type="auto">
  <name>Task 2: Add conflict resolution flow to pending orders sync</name>
  <files>archibald-web-app/frontend/src/pages/PendingOrdersView.tsx</files>
  <action>
Modify PendingOrdersView sync flow to use OrderConflictReview:
- After conflict detection shows modal with "Continua Comunque", proceed with resolution flow:
  - For each pending order with conflicts, open OrderConflictReview modal sequentially
  - Fetch current cache data for comparison (products/prices)
  - Show conflict review modal, wait for user confirmation
  - If confirmed: sync order with current data (update pending order in IndexedDB first)
  - If cancelled: skip order, mark as error with message "Non sincronizzato - modifiche rifiutate"
  - Continue to next order with conflicts
- Add conflict resolution progress: "Revisione ordini... ({N}/{total})"
- After all reviews: sync confirmed orders normally
Reuse sequential processing pattern from Phase 8-07 sync logic.
  </action>
  <verify>Sync flow shows conflict review for each affected order, allows per-order decisions</verify>
  <done>Users can review and confirm each conflicted order before syncing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete offline queue with conflict detection and resolution UI</what-built>
  <how-to-verify>
    1. Run: npm run dev (frontend + backend)
    2. Test offline queue:
       a. Create order while online (add to DB, not queue)
       b. Go offline (browser DevTools ‚Üí Network ‚Üí Offline)
       c. Create another order ‚Üí should go to pending queue
       d. Navigate to "üìã Coda" ‚Üí see pending order
    3. Test manual sync:
       a. Go online again
       b. Click "Sincronizza Ora" ‚Üí order syncs successfully
    4. Test conflict detection:
       a. Create order offline with old cache (> 3 days old if possible)
       b. Try manual sync ‚Üí see conflict warning modal
       c. Choose "Aggiorna Dati Prima" ‚Üí redirects to cache refresh
       d. Try again with "Continua Comunque" ‚Üí see per-order conflict review
    5. Test conflict resolution:
       a. Review order with conflicts ‚Üí see price changes highlighted
       b. Confirm or cancel ‚Üí order syncs or skips accordingly
    6. Verify UI:
       a. Banking app aesthetic (white cards, shadows, blue/yellow/red badges)
       b. Empty state when no pending orders
       c. Pending count badge in navigation header
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] OrderConflictReview displays detailed conflict comparison
- [ ] Sync flow shows per-order conflict resolution modals
- [ ] Users can confirm or cancel each conflicted order
- [ ] Manual UAT verification complete (see checkpoint)
- [ ] No new TypeScript errors introduced
</verification>

<success_criteria>

- All tasks completed
- OrderConflictReview modal displays conflict details
- Per-order conflict resolution integrated into sync flow
- User can review prices/availability before confirming
- Manual UAT verification passed
- Phase 9 Offline Queue feature complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-offline-queue/09-03-SUMMARY.md`:

# Phase 9 Plan 03: Conflict Resolution UI Summary

**Implemented detailed conflict resolution UI for reviewing and confirming orders with data conflicts.**

## Accomplishments

- Created OrderConflictReview modal for detailed conflict display
- Integrated per-order conflict resolution into sync flow
- Added price change highlighting and product availability warnings
- Manual UAT verification complete

## Files Created/Modified

- `archibald-web-app/frontend/src/components/OrderConflictReview.tsx` - New conflict review modal
- `archibald-web-app/frontend/src/pages/PendingOrdersView.tsx` - Added conflict resolution flow

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

**Phase 9 COMPLETE** - All offline queue functionality delivered:
- ‚úÖ Pending orders UI with manual sync
- ‚úÖ Conflict detection for stale data
- ‚úÖ Conflict resolution with per-order review
- ‚úÖ Banking app UX throughout

Ready for Phase 10 (Order History) or Phase 11 (Order Management)
</output>
