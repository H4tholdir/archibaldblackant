---
phase: 09-offline-queue
plan: 02
type: execute
---

<objective>
Implement conflict detection for stale cached data before syncing pending orders.

Purpose: Prevent order submission with outdated prices/products that changed since order was queued offline.
Output: Stale data detection in sync flow with warnings before submission.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior Phase Context:
@.planning/phases/09-offline-queue/09-01-SUMMARY.md
@.planning/phases/08-offline-capability/08-03-SUMMARY.md

# Existing Infrastructure:
@archibald-web-app/frontend/src/services/cache-service.ts
@archibald-web-app/frontend/src/services/pending-orders-service.ts
@archibald-web-app/frontend/src/db/schema.ts

**Tech Stack Available:**
- CacheService with getCacheAge()
- Phase 8-08: 3-day stale threshold (72 hours) already defined
- IndexedDB cacheMetadata table tracking last sync times

**Established Patterns:**
- Phase 8-08: Stale data warning modal with explicit confirmation
- Phase 8-03: Cache age checking with thresholds
- Phase 8: Banking app UX for warnings (yellow banner style)

**Constraining Decisions:**
- Phase 8-08: 3-day threshold balances freshness vs workflow interruption
- Phase 8-08: User choice not blocking, informed decision with "Continua comunque"
- Phase 8-07: PendingOrder contains complete orderData for validation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conflict detection utility to check cache staleness</name>
  <files>archibald-web-app/frontend/src/services/conflict-detection.ts</files>
  <action>
Create ConflictDetectionService with detectStaleData() method:
- Check cacheMetadata for customers, products, prices last sync times
- Compare against 3-day threshold (72 hours) from Phase 8-08
- Return conflict report: { hasConflicts: boolean, staleEntities: string[], cacheAge: { customers: Date, products: Date, prices: Date } }
- Stale if ANY entity exceeds 72 hours
- Log detection results for debugging
Use singleton pattern (consistent with PendingOrdersService, CacheService).
  </action>
  <verify>ConflictDetectionService detects when cache age > 72 hours</verify>
  <done>Conflict detection utility returns accurate staleness report</done>
</task>

<task type="auto">
  <name>Task 2: Integrate conflict detection into manual sync flow</name>
  <files>archibald-web-app/frontend/src/pages/PendingOrdersView.tsx</files>
  <action>
Modify manual sync in PendingOrdersView:
- Before calling syncPendingOrders(), call ConflictDetectionService.detectStaleData()
- If hasConflicts = true, show warning modal (similar to Phase 8-08 StaleDataWarning)
- Modal content:
  - Title: "⚠️ Dati Non Aggiornati"
  - Message: "I dati di {staleEntities} non sono aggiornati da {N} giorni. Gli ordini potrebbero contenere prezzi o prodotti obsoleti."
  - Buttons: "Aggiorna Dati Prima" (recommended, triggers cache refresh) | "Continua Comunque" (proceeds with sync)
- If "Aggiorna Dati Prima": redirect to cache refresh flow (/settings or force refresh)
- If "Continua Comunque": proceed with sync as normal
- Add isCheckingConflicts loading state during detection
Reuse modal styling from Phase 8-08 StaleDataWarning pattern.
  </action>
  <verify>Sync shows conflict warning when cache is stale, allows user choice</verify>
  <done>Users warned about stale data before syncing with option to update cache first</done>
</task>

<task type="auto">
  <name>Task 3: Add conflict warnings to individual pending orders in list</name>
  <files>archibald-web-app/frontend/src/pages/PendingOrdersView.tsx</files>
  <action>
Add per-order conflict indicators to PendingOrdersView:
- For each pending order, compare order.createdAt against cache last sync time
- If order created BEFORE last cache sync: no warning (data was fresh when queued)
- If order created AFTER last cache sync AND cache now stale: show warning badge "⚠️ Verifica" (yellow)
- Badge tooltip: "Questo ordine potrebbe contenere dati obsoleti, verifica prima di sincronizzare"
- Visual indicator: yellow badge next to status badge
- Count stale orders in summary: "⚠️ {N} ordini con dati obsoleti"
This provides proactive visibility without blocking workflow.
  </action>
  <verify>Pending orders show conflict badges when cache is stale</verify>
  <done>Individual orders display conflict warnings when applicable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ConflictDetectionService accurately detects cache staleness
- [ ] Manual sync shows conflict warning modal when data is stale
- [ ] User can choose to update cache first or continue anyway
- [ ] Individual orders show conflict badges when applicable
- [ ] No new TypeScript errors introduced
</verification>

<success_criteria>

- All tasks completed
- Conflict detection integrated into sync flow
- Users warned before syncing with stale data
- Per-order conflict indicators visible in queue list
- User can update cache before syncing
- Banking app UX consistent with Phase 8 patterns
</success_criteria>

<output>
After completion, create `.planning/phases/09-offline-queue/09-02-SUMMARY.md`:

# Phase 9 Plan 02: Conflict Detection for Stale Data Summary

**Implemented conflict detection to warn users before syncing orders with stale cached data.**

## Accomplishments

- Created ConflictDetectionService to detect cache staleness
- Integrated conflict warning modal into manual sync flow
- Added per-order conflict badges in queue list
- User choice to update cache or continue anyway

## Files Created/Modified

- `archibald-web-app/frontend/src/services/conflict-detection.ts` - New conflict detection service
- `archibald-web-app/frontend/src/pages/PendingOrdersView.tsx` - Added conflict warnings

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 09-03 (Conflict Resolution UI Enhancements)
</output>
