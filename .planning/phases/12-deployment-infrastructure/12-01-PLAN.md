---
phase: 12-deployment-infrastructure
type: execute
---

<objective>
Setup VPS hosting with Docker foundation and domain configuration.

Purpose: Establish the production hosting environment and basic Docker infrastructure for deployment.
Output: Running VPS with Docker installed, domain DNS configured, SSH access secured, basic monitoring.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-deployment-infrastructure/12-CONTEXT.md
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Which VPS provider should we use for production hosting?</decision>
  <context>Budget: €10-20/month, Requirements: 2 vCPU / 4 GB RAM minimum, Docker support, reliable uptime, SSH access</context>
  <options>
    <option id="digitalocean">
      <name>DigitalOcean Droplet ($12/month)</name>
      <pros>Well-documented, excellent API, 1-click Docker image, reliable network, simple pricing, good community support, datacenter in Frankfurt/Amsterdam (low latency to Italy)</pros>
      <cons>Slightly more expensive than alternatives, backups cost extra (+20%)</cons>
    </option>
    <option id="linode">
      <name>Linode (now Akamai) Shared CPU ($12/month)</name>
      <pros>Competitive pricing, included backups, good performance, reliable, datacenter in Milan (best latency), owned by Akamai (infrastructure expertise)</pros>
      <cons>Less popular than DigitalOcean (smaller community), slightly older interface</cons>
    </option>
    <option id="hetzner">
      <name>Hetzner Cloud CPX11 (€4.51/month)</name>
      <pros>Cheapest option by far (2x cheaper), datacenter in Germany (good latency), excellent value, includes backups</pros>
      <cons>Smaller company, less English documentation, payment via SEPA/PayPal only (no credit card), Terms in German</cons>
    </option>
  </options>
  <resume-signal>Select: digitalocean, linode, or hetzner</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what>Provision VPS instance and save SSH credentials</what>
  <instructions>
    1. Create account on chosen provider (if not exists)
    2. Provision new VPS instance:
       - Plan: 2 vCPU / 4 GB RAM minimum
       - OS: Ubuntu 24.04 LTS (latest LTS)
       - Region: Closest to Italy (Milan/Frankfurt/Amsterdam depending on provider)
       - Enable automated backups if available
    3. Note down:
       - Server IP address (will use for DNS)
       - Root password or SSH key (save securely)
       - Server hostname
    4. Verify SSH access: `ssh root@<IP_ADDRESS>`
  </instructions>
  <resume-signal>Provide: IP address, confirm SSH access works</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Install Docker and Docker Compose on VPS</name>
  <files>None (remote VPS commands)</files>
  <action>
    SSH to VPS and install Docker:
    1. Update packages: `apt update && apt upgrade -y`
    2. Install Docker using official script: `curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh`
    3. Install Docker Compose plugin: `apt install docker-compose-plugin -y`
    4. Verify: `docker --version` and `docker compose version`
    5. Start Docker: `systemctl enable docker && systemctl start docker`

    Security hardening:
    - Create non-root user with sudo: `adduser deploy && usermod -aG sudo deploy && usermod -aG docker deploy`
    - Configure SSH key-only auth (disable password): Edit `/etc/ssh/sshd_config` → `PasswordAuthentication no` → `systemctl restart sshd`
    - Setup UFW firewall: `ufw allow 22/tcp && ufw allow 80/tcp && ufw allow 443/tcp && ufw enable`
  </action>
  <verify>
    - `docker --version` returns Docker 24.0+
    - `docker compose version` returns Compose 2.20+
    - `docker ps` runs without sudo
    - SSH with password fails, SSH with key succeeds
    - `ufw status` shows ports 22, 80, 443 allowed
  </verify>
  <done>
    - Docker installed and running
    - Docker Compose plugin ready
    - Non-root deploy user with Docker access
    - SSH hardened (key-only auth)
    - Firewall configured with only necessary ports
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>DNS configuration approach for archibaldblackant.it</decision>
  <context>Domain already registered. Need to point to VPS IP address for HTTPS setup with Let's Encrypt.</context>
  <options>
    <option id="a-record">
      <name>Simple A Record (Recommended)</name>
      <pros>Simplest setup, direct IP mapping, no third-party dependencies, works immediately, Let's Encrypt compatible</pros>
      <cons>IP change requires manual DNS update (rare with VPS)</cons>
    </option>
    <option id="cloudflare">
      <name>Cloudflare Proxy (Free CDN)</name>
      <pros>Free CDN, DDoS protection, automatic HTTPS, analytics included, IP obfuscation</pros>
      <cons>Extra complexity, SSL termination at Cloudflare (need origin certificates), potential latency for Italian users, Let's Encrypt setup different</cons>
    </option>
  </options>
  <resume-signal>Select: a-record or cloudflare</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what>Configure DNS for archibaldblackant.it</what>
  <instructions>
    Based on choice above:

    **If A Record (Recommended):**
    1. Access domain registrar DNS settings (Namecheap/GoDaddy/etc)
    2. Add A record: `@ → <VPS_IP_ADDRESS>` (TTL: 300)
    3. Add A record: `www → <VPS_IP_ADDRESS>` (TTL: 300)
    4. Wait 5-10 minutes for DNS propagation
    5. Verify: `dig archibaldblackant.it` and `dig www.archibaldblackant.it` return VPS IP

    **If Cloudflare:**
    1. Add site to Cloudflare (free plan)
    2. Update nameservers at registrar to Cloudflare NS
    3. Add DNS records in Cloudflare: `@ → <VPS_IP_ADDRESS>` (proxied), `www → <VPS_IP_ADDRESS>` (proxied)
    4. Set SSL mode to "Full (strict)"
    5. Wait 10-30 minutes for nameserver propagation
    6. Verify: `dig archibaldblackant.it` returns Cloudflare IP
  </instructions>
  <resume-signal>Confirm: DNS resolves to VPS IP (or Cloudflare proxy)</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create deployment directory structure on VPS</name>
  <files>None (remote VPS commands)</files>
  <action>
    SSH as deploy user and create directory structure:
    ```bash
    mkdir -p ~/archibald-app/{frontend,backend,nginx,scripts,data,logs,backups}
    cd ~/archibald-app

    # Create placeholder for environment variables
    cat > .env.example <<'EOF'
# Archibald Black Ant Production Environment Variables
# Copy to .env and fill with actual values

# Database
DATABASE_PATH=/app/data

# JWT Secret (generate with: openssl rand -base64 32)
JWT_SECRET=

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Puppeteer
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# Archibald ERP (DO NOT COMMIT REAL CREDENTIALS)
ARCHIBALD_BASE_URL=https://4.231.124.90/Archibald
EOF

    # Set permissions
    chmod 755 ~/archibald-app
    chmod 700 ~/archibald-app/data  # Sensitive - DB files
    chmod 700 ~/archibald-app/logs  # Sensitive - may contain user IDs
    ```

    DO NOT create .env file with real credentials yet - will be done in Plan 12-02 after securing secrets management.
  </action>
  <verify>
    - `ls -la ~/archibald-app` shows all directories
    - `.env.example` exists with template variables
    - Permissions: data/ and logs/ are 700 (owner-only), others 755
  </verify>
  <done>
    - Directory structure created
    - .env.example template documented
    - Proper permissions set for sensitive directories
  </done>
</task>

<task type="auto">
  <name>Task 3: Install basic monitoring tools</name>
  <files>None (remote VPS commands)</files>
  <action>
    Install htop, ncdu, and setup basic disk space monitoring:
    ```bash
    sudo apt install -y htop ncdu

    # Create simple disk space alert script
    sudo tee /usr/local/bin/check-disk-space.sh > /dev/null <<'EOF'
#!/bin/bash
THRESHOLD=80
USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

if [ "$USAGE" -gt "$THRESHOLD" ]; then
  echo "WARNING: Disk usage is ${USAGE}% (threshold: ${THRESHOLD}%)"
  # In future: send alert to monitoring dashboard
fi
EOF

    sudo chmod +x /usr/local/bin/check-disk-space.sh

    # Add to cron (check daily at 9 AM)
    (crontab -l 2>/dev/null; echo "0 9 * * * /usr/local/bin/check-disk-space.sh") | crontab -
    ```

    Note: Full monitoring dashboard will be implemented in Plan 12-04. This is basic infrastructure monitoring only.
  </action>
  <verify>
    - `htop` command works
    - `ncdu` command works
    - `/usr/local/bin/check-disk-space.sh` exists and is executable
    - `crontab -l` shows daily disk check
  </verify>
  <done>
    - Basic system monitoring tools installed
    - Disk space alert script configured
    - Daily cron job scheduled
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] VPS provisioned and accessible via SSH
- [ ] Docker and Docker Compose installed and working
- [ ] Non-root deploy user created with Docker access
- [ ] SSH hardened (key-only authentication)
- [ ] Firewall configured (ports 22, 80, 443 only)
- [ ] DNS resolves archibaldblackant.it to VPS IP
- [ ] Directory structure created in ~/archibald-app
- [ ] Basic monitoring tools installed
</verification>

<success_criteria>

- All tasks completed
- VPS accessible and secured
- Docker ready for container deployment
- Domain DNS configured and resolving
- Directory structure prepared
- No errors in verification checks
</success_criteria>

<output>
After completion, create `.planning/phases/12-deployment-infrastructure/12-01-SUMMARY.md`:

# Phase 12 Plan 1: VPS Setup & Docker Foundation Summary

**VPS provisioned on [provider] with Docker ready and domain DNS configured**

## Accomplishments

- VPS instance provisioned ([provider], [region], [IP])
- Docker and Docker Compose installed
- SSH access secured with key-only authentication
- Firewall configured with minimal ports (22, 80, 443)
- DNS configured for archibaldblackant.it → [IP]
- Deployment directory structure created
- Basic monitoring tools installed

## Files Created/Modified

- Remote VPS: `/etc/ssh/sshd_config` - SSH hardening
- Remote VPS: `/etc/ufw/` - Firewall configuration
- Remote VPS: `~/archibald-app/` - Deployment directory structure
- Remote VPS: `~/archibald-app/.env.example` - Environment template
- Remote VPS: `/usr/local/bin/check-disk-space.sh` - Disk monitoring script

## Decisions Made

- VPS Provider: [chosen provider] - [rationale]
- DNS Strategy: [A record or Cloudflare] - [rationale]
- Security: Key-only SSH, UFW firewall, non-root deploy user

## Issues Encountered

[Document any issues during VPS setup or DNS configuration, or "None"]

## Next Step

Ready for 12-02-PLAN.md (Docker Orchestration & SSL)
</output>
