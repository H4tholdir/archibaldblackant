---
phase: 12-deployment-infrastructure
type: execute
---

<objective>
Deploy application to production VPS and verify all systems operational.

Purpose: Complete end-to-end deployment with smoke tests and rollback validation.
Output: Live production deployment at archibaldblackant.it with verified functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-deployment-infrastructure/12-CONTEXT.md
@docker-compose.yml
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <what>Push repository to GitHub and clone to VPS</what>
  <instructions>
    Prepare repository for deployment:

    1. **Commit all Phase 12 changes locally:**
       ```bash
       git add .
       git commit -m "feat(12): complete deployment infrastructure (Docker, CI/CD, monitoring, backups)"
       ```

    2. **Push to GitHub:**
       ```bash
       git push origin master
       ```

    3. **Clone repository to VPS:**
       ```bash
       ssh deploy@<VPS_IP>
       cd ~
       git clone https://github.com/<username>/archibald-black-ant.git archibald-app
       cd archibald-app
       git checkout master
       ```

    4. **Verify files present on VPS:**
       ```bash
       ls -la
       # Should see: docker-compose.yml, scripts/, nginx/, .github/, archibald-web-app/
       ```

    5. **Make scripts executable:**
       ```bash
       chmod +x scripts/*.sh
       ```
  </instructions>
  <resume-signal>Confirm: Repository cloned to VPS at ~/archibald-app, scripts executable</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what>Setup environment and SSL certificates on VPS</what>
  <instructions>
    Complete setup steps from Plan 12-02 if not already done:

    1. **Create .env file with production credentials:**
       ```bash
       cd ~/archibald-app
       cp .env.example .env
       nano .env  # Fill in production values
       chmod 600 .env
       ```

    2. **Generate SSL certificates (if not done in 12-02):**
       ```bash
       sudo apt install -y certbot
       sudo certbot certonly --standalone \
         -d archibaldblackant.it \
         -d www.archibaldblackant.it \
         --non-interactive --agree-tos --email <YOUR_EMAIL>

       # Copy certificates
       sudo mkdir -p ~/archibald-app/nginx/ssl
       sudo cp /etc/letsencrypt/live/archibaldblackant.it/fullchain.pem ~/archibald-app/nginx/ssl/
       sudo cp /etc/letsencrypt/live/archibaldblackant.it/privkey.pem ~/archibald-app/nginx/ssl/
       sudo chown -R deploy:deploy ~/archibald-app/nginx/ssl
       sudo chmod 600 ~/archibald-app/nginx/ssl/*.pem
       ```

    3. **Generate DH parameters (if not done in 12-02):**
       ```bash
       sudo openssl dhparam -out ~/archibald-app/nginx/dhparam.pem 2048
       sudo chown deploy:deploy ~/archibald-app/nginx/dhparam.pem
       ```

    4. **Setup backup cron job:**
       ```bash
       cd ~/archibald-app
       ./scripts/setup-backup-cron.sh
       ```

    5. **Verify setup:**
       ```bash
       # Check .env exists and has correct permissions
       ls -l .env  # Should show -rw------- (600)

       # Check SSL certificates
       ls -l nginx/ssl/  # Should show fullchain.pem and privkey.pem

       # Check cron job
       crontab -l  # Should show daily backup at 2 AM
       ```
  </instructions>
  <resume-signal>Confirm: .env created, SSL certificates configured, backup cron job scheduled</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Build and start Docker containers</name>
  <files>None (remote VPS commands)</files>
  <action>
    SSH to VPS and build/start all containers:

    ```bash
    ssh deploy@<VPS_IP>
    cd ~/archibald-app

    # Build containers (no cache for clean build)
    echo "Building Docker containers..."
    docker compose build --no-cache

    # Start all services
    echo "Starting services..."
    docker compose up -d

    # Wait for services to start
    echo "Waiting for services to initialize (60 seconds)..."
    sleep 60

    # Check container status
    docker compose ps

    # Check logs for errors
    docker compose logs --tail=50 backend
    docker compose logs --tail=50 frontend
    docker compose logs --tail=50 nginx-proxy

    # Verify health checks
    echo "Checking health endpoints..."
    curl -v http://localhost:3000/health  # Backend health check
    curl -v http://localhost/health  # Through Nginx
    ```

    Expected output:
    - All 4 containers running (frontend, backend, redis, nginx-proxy)
    - Health check returns HTTP 200 with JSON
    - No critical errors in logs

    If build fails:
    - Check Dockerfile syntax
    - Check docker-compose.yml syntax
    - Check .env file is present
    - Check network connectivity
  </action>
  <verify>
    - `docker compose ps` shows 4/4 containers running
    - `curl http://localhost:3000/health` returns 200
    - `curl http://localhost/health` returns 200 (through Nginx)
    - Container logs show no critical errors
  </verify>
  <done>
    Docker containers built and running, health checks passing
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify HTTPS and SSL certificate</name>
  <files>None (verification commands)</files>
  <action>
    Verify SSL certificate and HTTPS access:

    ```bash
    # From VPS or local machine:

    # 1. Check SSL certificate validity
    echo | openssl s_client -servername archibaldblackant.it -connect archibaldblackant.it:443 2>/dev/null | openssl x509 -noout -dates

    # 2. Verify HTTPS redirect (HTTP → HTTPS)
    curl -I http://archibaldblackant.it  # Should return 301 redirect to https://

    # 3. Test HTTPS endpoint
    curl -I https://archibaldblackant.it  # Should return 200 OK

    # 4. Check SSL Labs rating (optional, thorough check)
    # Visit: https://www.ssllabs.com/ssltest/analyze.html?d=archibaldblackant.it
    # Should get A or A+ rating

    # 5. Verify security headers
    curl -I https://archibaldblackant.it | grep -E "(Strict-Transport-Security|X-Frame-Options|X-Content-Type-Options)"
    # Should see HSTS, X-Frame-Options, X-Content-Type-Options headers
    ```

    Expected results:
    - Certificate valid (not expired, correct domain)
    - HTTP redirects to HTTPS (301)
    - HTTPS returns 200 OK
    - Security headers present (HSTS, X-Frame-Options, etc.)
  </action>
  <verify>
    - SSL certificate valid and not expired
    - HTTP → HTTPS redirect working (301)
    - HTTPS returns 200 OK
    - Security headers present in response
  </verify>
  <done>
    HTTPS working with valid SSL certificate and security headers
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete production deployment with frontend, backend, database, and monitoring</what-built>
  <how-to-verify>
    **Smoke Tests - Manual Verification:**

    1. **Frontend Access:**
       - Visit: https://archibaldblackant.it
       - Verify: Login page loads without errors
       - Verify: No console errors in browser DevTools

    2. **Authentication:**
       - Login with production credentials (admin user)
       - Verify: JWT stored in localStorage
       - Verify: Redirects to dashboard/order form

    3. **Order Form:**
       - Try to create a test order:
         - Search for customer (autocomplete should work)
         - Search for product (autocomplete should work)
         - Enter quantity
         - Add to order
       - Verify: Form fields populate correctly
       - Verify: No JavaScript errors
       - Do NOT submit (testing only)

    4. **Admin Monitoring Dashboard:**
       - Visit: https://archibaldblackant.it/admin/monitoring
       - Verify: Metrics display (uptime, active users, response time, etc.)
       - Verify: No errors, metrics update every 30 seconds
       - Check: Recent errors section (should be empty or show only test data)

    5. **Health Check:**
       - Visit: https://archibaldblackant.it/health
       - Verify: Returns JSON with status "healthy"

    6. **PWA Install:**
       - On mobile: Tap browser menu → "Add to Home Screen"
       - On desktop Chrome: Look for install icon in address bar
       - Verify: PWA installs successfully
       - Test: Open installed PWA, should work offline (after initial load)

    7. **Performance Check:**
       - Open browser DevTools → Network tab
       - Reload page
       - Check: Page load time < 3 seconds
       - Check: No failed requests (4xx/5xx)

    **Expected Behaviors:**
    - All pages load without errors
    - Authentication works end-to-end
    - API endpoints respond within reasonable time (< 2s)
    - Monitoring dashboard displays real metrics
    - PWA installable and works offline
  </how-to-verify>
  <resume-signal>Type "approved" if all smoke tests pass, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test GitHub Actions CI/CD pipeline</name>
  <files>None (GitHub Actions trigger)</files>
  <action>
    Trigger manual deployment via GitHub Actions to verify CI/CD:

    ```bash
    # From local machine:

    # 1. Make a trivial change (add comment or whitespace)
    echo "# CI/CD test deployment" >> README.md
    git add README.md
    git commit -m "test(ci): verify GitHub Actions deployment pipeline"
    git push origin master

    # 2. Monitor GitHub Actions
    # Visit: https://github.com/<username>/archibald-black-ant/actions
    # Watch "Deploy to Production" workflow run

    # 3. Wait for completion (5-10 minutes)
    # Expected: Workflow succeeds with green checkmark

    # 4. Verify deployment
    curl -I https://archibaldblackant.it/health
    # Should return 200 OK after deployment completes

    # 5. Check VPS logs
    ssh deploy@<VPS_IP>
    cd ~/archibald-app
    docker compose logs --tail=50 backend
    # Should show recent restart (new containers deployed)
    ```

    If workflow fails:
    - Check GitHub Secrets are configured correctly (VPS_IP, VPS_SSH_KEY)
    - Check SSH key has access to VPS
    - Check deploy.sh script is executable on VPS
    - Review GitHub Actions logs for specific error
  </action>
  <verify>
    - GitHub Actions workflow completes successfully (green checkmark)
    - Health check returns 200 after deployment
    - Docker containers restarted with new code
    - No errors in workflow logs
  </verify>
  <done>
    GitHub Actions CI/CD pipeline verified working end-to-end
  </done>
</task>

<task type="auto">
  <name>Task 4: Test manual rollback procedure</name>
  <files>None (rollback script execution)</files>
  <action>
    Test rollback script to ensure it works in emergency:

    ```bash
    ssh deploy@<VPS_IP>
    cd ~/archibald-app

    # Note: This is a test - will rollback and then roll forward

    # 1. Capture current state
    docker compose ps > /tmp/before_rollback.txt

    # 2. Run rollback script
    echo "yes" | ./scripts/rollback.sh

    # 3. Wait for rollback to complete (2-3 minutes)
    sleep 120

    # 4. Verify rollback succeeded
    docker compose ps
    curl http://localhost:3000/health

    # 5. Roll forward (deploy current version again)
    ./scripts/deploy.sh

    # 6. Wait for deployment
    sleep 120

    # 7. Verify back to current state
    docker compose ps > /tmp/after_rollforward.txt
    curl http://localhost:3000/health

    # 8. Compare states
    diff /tmp/before_rollback.txt /tmp/after_rollforward.txt
    # Should be similar (container IDs may differ)
    ```

    Expected results:
    - Rollback script executes without errors
    - Health checks pass after rollback
    - Roll forward succeeds
    - Application returns to working state

    Document rollback RTO (time from starting script to health check pass).
  </action>
  <verify>
    - Rollback script executes successfully
    - Health checks pass after rollback
    - Roll forward succeeds
    - RTO measured and < 5 minutes
    - No data loss during rollback/rollforward
  </verify>
  <done>
    Manual rollback procedure tested and verified working
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete production deployment with verified rollback and CI/CD</what-built>
  <how-to-verify>
    **Final Production Verification:**

    1. **Uptime Check:**
       - Visit: https://archibaldblackant.it
       - Confirm: Site accessible and responsive

    2. **End-to-End Order Test:**
       - Login as production user
       - Create actual test order (small quantity, test customer)
       - Submit order
       - Verify: Order appears in Archibald ERP
       - Verify: Order visible in order history

    3. **Monitoring Dashboard:**
       - Visit: /admin/monitoring
       - Verify: All metrics green
       - Verify: No critical errors logged

    4. **Backup Verification:**
       - SSH to VPS
       - Check backup directory: `ls -lh ~/archibald-app/backups/`
       - Verify: At least one backup exists
       - Verify: Backup size reasonable (5-50 MB)

    5. **Performance Test:**
       - Use browser DevTools or Lighthouse
       - Run performance audit
       - Target: Performance score > 80

    6. **Documentation Check:**
       - Review: `.planning/phases/12-deployment-infrastructure/DISASTER-RECOVERY.md`
       - Confirm: All procedures documented
       - Confirm: Emergency contacts listed

    **Acceptance Criteria:**
    - [ ] Site accessible at archibaldblackant.it (HTTPS)
    - [ ] Authentication working
    - [ ] Order creation end-to-end working
    - [ ] Monitoring dashboard functional
    - [ ] Backups automated and working
    - [ ] CI/CD pipeline functional
    - [ ] Rollback tested and working
    - [ ] Performance acceptable (< 3s page load)
    - [ ] No critical errors in logs
    - [ ] Disaster recovery procedures documented
  </how-to-verify>
  <resume-signal>Type "production-ready" to confirm all criteria met, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Repository cloned to VPS
- [ ] .env file configured with production credentials
- [ ] SSL certificates installed and valid
- [ ] Backup cron job scheduled
- [ ] Docker containers built and running
- [ ] HTTPS working with security headers
- [ ] All smoke tests passed (login, order form, monitoring, health check, PWA)
- [ ] GitHub Actions CI/CD pipeline tested and working
- [ ] Manual rollback tested successfully
- [ ] Final production verification completed
- [ ] All acceptance criteria met
</verification>

<success_criteria>

- All tasks completed
- Production deployment live at archibaldblackant.it
- All smoke tests passed
- CI/CD pipeline working
- Rollback procedure verified
- Monitoring dashboard operational
- Backups automated
- No critical errors
- Performance acceptable
- Documentation complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-deployment-infrastructure/12-06-SUMMARY.md`:

# Phase 12 Plan 6: Production Deployment & Verification Summary

**Production deployment live at archibaldblackant.it with zero-downtime CI/CD**

## Accomplishments

- Repository deployed to VPS at ~/archibald-app
- Production environment configured (.env, SSL, backups)
- Docker containers built and running (4/4 healthy)
- HTTPS working with A/A+ SSL Labs rating
- All smoke tests passed (login, order form, monitoring, PWA)
- GitHub Actions CI/CD pipeline functional
- Manual rollback tested (RTO: [X] minutes)
- Automated daily backups confirmed
- Monitoring dashboard operational
- Performance metrics acceptable (page load < 3s)

## Decisions Made

- [Document any production-specific decisions made during deployment]

## Issues Encountered

[Document any deployment issues and resolutions, or "None"]

## Production URLs

- Main App: https://archibaldblackant.it
- Admin Monitoring: https://archibaldblackant.it/admin/monitoring
- Health Check: https://archibaldblackant.it/health

## Next Steps

Phase 12 complete. Production deployment successful. Next: Phase 11 execution (Order Management features) or Phase 13 (Security Audit).
</output>
