---
phase: 35-monitoring-observability
plan: 01
type: execute
---

<objective>
Implementare sistema di monitoring e observability per WebSocket real-time sync: health metrics, connection tracking, latency measurement, admin dashboard.

Purpose: Fornire visibilitÃ  completa sullo stato WebSocket real-time, diagnosticare problemi di connessione, monitorare performance sync, e supportare operazioni amministrative.
Output: WebSocket health endpoint, metrics collection, monitoring dashboard UI, connection latency tracking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph:
@.planning/phases/29-websocket-server-infrastructure/29-01-SUMMARY.md
@.planning/phases/30-websocket-client-reconnect/30-01-SUMMARY.md
@.planning/phases/25-sync-monitoring-dashboard/25-03-SUMMARY.md
@.planning/phases/34-e2e-testing-multidevice/34-01-SUMMARY.md

# Key files from frontmatter:
@archibald-web-app/backend/src/websocket-server.ts
@archibald-web-app/frontend/src/hooks/useWebSocket.ts
@archibald-web-app/frontend/src/components/SyncMonitoringDashboard.tsx

**Tech stack available:** @playwright/test, ws library, Express health endpoints, React monitoring patterns
**Established patterns:**
- WebSocket connection pool management (Map<userId, Set<WebSocket>>)
- ConnectionStats interface giÃ  esistente (totalConnections, activeUsers)
- Health check endpoint pattern (/api/health/*)
- 5-second polling monitoring dashboard (Phase 25)
- Ping/pong heartbeat (30s interval)

**Constraining decisions:**
- Phase 29: WebSocket server con connection pool, ping/pong heartbeat, getStats() method
- Phase 25: SyncMonitoringDashboard pattern con polling 5s, color coding (green/red/blue/gray)
- Phase 34: E2E tests con latency measurement utilities

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend WebSocket Health & Metrics API</name>
  <files>archibald-web-app/backend/src/websocket-server.ts, archibald-web-app/backend/src/types.ts, archibald-web-app/backend/src/index.ts</files>
  <action>
  Estendere ConnectionStats interface in types.ts con metriche avanzate:
  - uptime: number (millisecondi da quando il server WebSocket Ã¨ stato inizializzato)
  - reconnectionCount: number (contatore riconnessioni totali)
  - messagesSent: number (contatore messaggi broadcast inviati)
  - messagesReceived: number (contatore messaggi ricevuti dai client)
  - averageLatency: number (latency media in millisecondi, calcolata da ping/pong)
  - connectionsPerUser: { [userId: string]: number } (mappa utente â†’ numero connessioni)

  Aggiungere tracking in WebSocketServerService:
  - Campo private initTimestamp: number per calcolare uptime
  - Campo private metrics per tracking counters (reconnectionCount, messagesSent, messagesReceived)
  - Estendere registerConnection() per incrementare reconnectionCount
  - Estendere broadcast() e broadcastToAll() per contare messagesSent
  - Aggiungere listener 'message' per contare messagesReceived
  - Calcolare averageLatency da isAlive tracking nel ping/pong handler
  - Estendere getStats() per restituire tutti i nuovi campi

  Creare endpoint GET /api/websocket/health in index.ts:
  - Chiama WebSocketServerService.getInstance().getStats()
  - Restituisce health status: "healthy" se activeUsers > 0, "idle" se 0, "offline" se wss null
  - Response: { success: true, status: "healthy"|"idle"|"offline", stats: ConnectionStats }
  - Richiede autenticazione JWT (requireAuth middleware)
  - Admin-only endpoint (requireAdmin middleware)

  AVOID: Non modificare logica esistente di ping/pong, solo aggiungere tracking metriche.
  </action>
  <verify>npm run typecheck && curl http://localhost:3000/api/websocket/health mostra stats con tutti i campi</verify>
  <done>ConnectionStats interface estesa, metrics tracking implementato, endpoint GET /api/websocket/health funzionante, TypeScript compila senza errori</done>
</task>

<task type="auto">
  <name>Task 2: Frontend WebSocket Connection Monitor Component</name>
  <files>archibald-web-app/frontend/src/components/WebSocketMonitor.tsx, archibald-web-app/frontend/src/types/websocket.ts</files>
  <action>
  Creare WebSocketMonitor component in frontend/src/components/WebSocketMonitor.tsx:
  - Interfaccia WebSocketHealthStats in frontend/src/types/websocket.ts (mirror di backend ConnectionStats)
  - useState per health data: WebSocketHealthStats | null
  - useEffect con polling 5s che chiama GET /api/websocket/health
  - Card layout simile a SyncMonitoringDashboard (riusa pattern Phase 25):
    - Header "WebSocket Real-Time Sync" con status badge (ðŸŸ¢ Healthy, ðŸ”´ Offline, ðŸŸ¡ Idle)
    - Stats grid con 6 metriche:
      1. Connessioni Attive (totalConnections badge blu)
      2. Utenti Connessi (activeUsers badge verde)
      3. Uptime (calcolato da uptime ms â†’ ore/minuti)
      4. Latency Media (averageLatency ms con badge arancione se >100ms, verde se â‰¤100ms)
      5. Messaggi Inviati (messagesSent contatore)
      6. Riconnessioni (reconnectionCount contatore)
    - Lista "Connessioni per Utente" con tabella userId â†’ connection count
    - Color coding: Green (#4caf50) healthy, Red (#f44336) offline, Orange (#ff9800) idle
  - Error handling: try/catch con fallback UI se API fallisce
  - Loading state durante primo fetch

  Riutilizzare pattern Phase 25 (SyncMonitoringDashboard):
  - Inline styles consistenti con codebase
  - 5-second polling interval (setInterval + cleanup)
  - Badge styling uniforme
  - Responsive layout

  AVOID: Non creare nuovo pattern, riutilizzare SyncMonitoringDashboard come riferimento per stile e struttura.
  </action>
  <verify>Component renderizza senza errori, polling 5s funziona, badge colors corretti, TypeScript compila</verify>
  <done>WebSocketMonitor component creato, polling implementato, UI mostra 6 metriche, error handling presente, styles consistenti con Phase 25</done>
</task>

<task type="auto">
  <name>Task 3: Integration in AdminPage & Comprehensive Testing</name>
  <files>archibald-web-app/frontend/src/pages/AdminPage.tsx, archibald-web-app/frontend/src/components/WebSocketMonitor.tsx</files>
  <action>
  Integrare WebSocketMonitor in AdminPage:
  - Import WebSocketMonitor component
  - Aggiungere nuova sezione "WebSocket Real-Time" SOPRA "Monitoring Sync" (prioritÃ  piÃ¹ alta)
  - Rendering condizionale: mostra solo se utente Ã¨ admin (giÃ  gestito da AdminPage routing)

  Testing manuale (da documentare in SUMMARY.md):
  1. Verificare GET /api/websocket/health restituisce metriche corrette
  2. Aprire AdminPage, verificare WebSocketMonitor renderizza
  3. Verificare polling 5s (DevTools Network tab)
  4. Connettere 2+ dispositivi (browser diversi), verificare activeUsers aumenta
  5. Disconnettere dispositivi, verificare activeUsers diminuisce
  6. Verificare latency badge: verde se â‰¤100ms, arancione se >100ms
  7. Verificare uptime incrementa correttamente
  8. Verificare messagesSent incrementa quando draft/pending operations avvengono
  9. Simulare WebSocket server offline (stop backend), verificare badge rosso "Offline"
  10. Restart backend, verificare auto-recovery con reconnectionCount incrementato

  Eseguire npm run typecheck e npm run prettier --write sui file modificati.

  AVOID: Non aggiungere test automatici (E2E giÃ  coperto da Phase 34), solo testing manuale e documentazione.
  </action>
  <verify>AdminPage mostra WebSocketMonitor, tutte le metriche aggiornano correttamente, npm run typecheck passa, prettier applicato</verify>
  <done>WebSocketMonitor integrato in AdminPage, testing manuale completato (10 scenari), TypeScript e Prettier OK, documentazione in SUMMARY.md</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run typecheck passa senza errori TypeScript
- [ ] npm run prettier --write applicato a tutti i file modificati
- [ ] GET /api/websocket/health restituisce JSON con stats completi
- [ ] WebSocketMonitor renderizza in AdminPage
- [ ] Polling 5s funziona (verificato in DevTools Network)
- [ ] Multi-device connection tracking funziona (activeUsers incrementa/decrementa)
- [ ] Latency badge color coding corretto (verde â‰¤100ms, arancione >100ms)
- [ ] Uptime, messagesSent, reconnectionCount incrementano correttamente
- [ ] Offline scenario gestito (badge rosso quando backend down)
- [ ] Auto-recovery dopo reconnect verificato
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ConnectionStats interface estesa con 6 nuove metriche
- Backend tracking metrics implementato senza regressions
- GET /api/websocket/health endpoint funzionante
- WebSocketMonitor component creato con 6 stat cards
- Polling 5s implementato con cleanup
- Integration in AdminPage completata
- Color coding semantico (green/red/orange) applicato
- 10 scenari di testing manuale documentati
- No TypeScript errors
- Prettier formatting applicato
  </success_criteria>

<output>
After completion, create `.planning/phases/35-monitoring-observability/35-01-SUMMARY.md`:

# Phase 35 Plan 01: Monitoring & Observability Summary

**WebSocket health monitoring con metrics backend, admin dashboard UI, e real-time connection tracking**

## Accomplishments

- Esteso ConnectionStats interface con 6 nuove metriche (uptime, reconnectionCount, messagesSent, messagesReceived, averageLatency, connectionsPerUser)
- Implementato metrics tracking in WebSocketServerService senza modificare logica core
- Creato GET /api/websocket/health endpoint per admin monitoring
- Creato WebSocketMonitor component con 6 stat cards e polling 5s
- Integrato in AdminPage sopra SyncMonitoringDashboard
- Color coding semantico: ðŸŸ¢ Healthy, ðŸ”´ Offline, ðŸŸ¡ Idle
- Testing manuale completato: 10 scenari (multi-device, offline recovery, latency tracking)

## Files Created/Modified

- `archibald-web-app/backend/src/types.ts` - Esteso ConnectionStats interface
- `archibald-web-app/backend/src/websocket-server.ts` - Metrics tracking implementato
- `archibald-web-app/backend/src/index.ts` - GET /api/websocket/health endpoint
- `archibald-web-app/frontend/src/types/websocket.ts` - WebSocketHealthStats interface
- `archibald-web-app/frontend/src/components/WebSocketMonitor.tsx` - Monitoring component
- `archibald-web-app/frontend/src/pages/AdminPage.tsx` - Integration

## Decisions Made

[Documentare decisioni chiave prese durante implementazione]

## Issues Encountered

[Documentare problemi incontrati e soluzioni]

## Next Phase Readiness

Ready for **Phase 36: Performance Tuning & Optimization**

### What's ready:
- âœ… WebSocket health monitoring in production
- âœ… Real-time metrics dashboard per admin
- âœ… Connection tracking multi-device
- âœ… Latency measurement infrastructure
- âœ… Observability baseline per performance tuning

### What Phase 36 needs:
- Load testing con 10+ concurrent users
- Latency optimization (<100ms target)
- Stress testing WebSocket server
- Performance bottleneck identification
- Scalability testing
</output>
