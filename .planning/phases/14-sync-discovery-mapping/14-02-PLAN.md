---
phase: 14-sync-discovery-mapping
plan: 02
type: execute
---

<objective>
Analizzare completamente il product sync (shared 1:1) e risolvere problemi critici identificati.

Purpose: Comprendere come funziona il product sync shared tra tutti gli utenti, identificare race conditions e problemi di concorrenza multi-user, e fixarli per garantire affidabilità.
Output: Documento `products-sync.md` completo + codice refactorato con problemi risolti
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sync-discovery-mapping/14-CONTEXT.md
@.planning/phases/14-sync-discovery-mapping/14-01-SUMMARY.md
@.planning/phases/14-sync-discovery-mapping/customers-sync.md
@archibald-web-app/backend/src/product-sync-service.ts
@archibald-web-app/backend/src/sync-scheduler.ts
@archibald-web-app/backend/src/priority-manager.ts

**Differenza critica da customer sync:**
- Product sync è SHARED 1:1 (un solo products.db condiviso da tutti gli utenti)
- Questo introduce problemi di concorrenza multi-user più complessi
- Race conditions sono più probabili (multipli user triggerano sync contemporaneamente)

**Decisioni pregresse rilevanti:**
- Phase 4.1-01: PriorityManager per pause/resume
- Phase 8: IndexedDB cache frontend (6 MB, ~14k prodotti)
- Phase 4.1-02: Multi-level price matching (ID → name exact → name normalized)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analisi profonda product-sync-service.ts</name>
  <files>archibald-web-app/backend/src/product-sync-service.ts</files>
  <action>
Analizzare completamente il file product-sync-service.ts con focus su **shared sync**:

1. **Trigger Points**: Identificare TUTTI i modi in cui il sync può essere attivato
   - Chi triggera il product sync? (tutti gli utenti o uno solo?)
   - Come viene gestito il fatto che è shared (lock? queue?)
   - Cosa succede se User A e User B triggerano contemporaneamente?

2. **Step-by-Step Flow**: Mappare la sequenza completa
   - Come acquista BrowserContext (userId o shared?)
   - Come scrape Archibald prodotti
   - Come processa prodotti con variants
   - Come scrive in products.db shared
   - Come notifica tutti i frontend (multi-user)

3. **Concurrency Scenarios** - FOCUS CRITICO per shared sync
   - **Multi-user race**: 5 utenti fanno login contemporaneamente → 5 product sync triggerati?
   - **Lock mechanism**: C'è un lock per evitare sync concorrenti sullo stesso DB?
   - **Shared BrowserContext**: Può causare conflicts?
   - **Database write conflicts**: SQLite può gestire writes concorrenti?
   - **Stale data during sync**: User B legge mentre User A sta scrivendo?

4. **Dependencies**: Analizzare dipendenze
   - Product sync dipende da customer sync? (probabilmente no)
   - Price sync dipende da product sync? (probabilmente sì - need products first)

5. **Issues/Bottlenecks**: Identificare problemi SHARED-SPECIFIC
   - Race conditions su database writes
   - Lock contention (troppi user aspettano)
   - Sync ridondanti (5 user → 5 sync uguali invece di 1)
   - Memory issues con shared data
   - Notifica frontend non sincronizzata

**Focus principale**: Race conditions multi-user e gestione shared resource.
  </action>
  <verify>grep -r "syncProducts\|product-sync" archibald-web-app/backend/src/ trova tutti i trigger e lock points</verify>
  <done>Analisi completa con focus critico su concorrenza multi-user e shared resource management</done>
</task>

<task type="auto">
  <name>Task 2: Creare documento products-sync.md narrativo</name>
  <files>.planning/phases/14-sync-discovery-mapping/products-sync.md</files>
  <action>
Creare documento narrativo (stile storia) per product sync SHARED:

**Struttura:**

```markdown
# Product Sync - Shared 1:1 Database

**Type**: **SHARED 1:1** (un solo products.db condiviso da tutti gli utenti)

**Impatto shared sync**: Questa caratteristica rende la gestione della concorrenza CRITICA. Se 10 utenti fanno login contemporaneamente, potrebbero triggerare 10 sync sullo stesso database → race conditions, lock contention, data corruption.

## Trigger Points

Quando viene attivato il sync (da qualsiasi utente):
- **Login automatico**: Ogni utente che fa login triggera...
- **Reconnect automatico**: Quando qualsiasi utente riconnette...
- **Stale data (3-day)**: Qualsiasi frontend con dati stale triggera...
- **Force refresh manuale**: Qualsiasi utente può triggerare...

**Gestione shared trigger**: {come viene gestito il fatto che multipli user triggerano sync?}

## Step-by-Step Flow

"Quando viene triggerato il product sync (da uno o più utenti), succede quanto segue..."

1. **Lock acquisition**: {c'è un lock? Come funziona? Cosa succede se già locked?}
2. **Acquisizione context**: BrowserContext shared o per-user?...
3. **Scraping**: Archibald prodotti con variants...
4. **Processing**: ~14k prodotti processati...
5. **Database write**: products.db SHARED viene aggiornato... {lock? transaction?}
6. **Notifica multi-user**: TUTTI i frontend connessi ricevono notifica...

## Concurrency Scenarios

**Single-user scenario**:
- Login triggera customers+products+prices insieme → {OK, stesso user}

**Multi-user scenario - CRITICO**:
- 5 utenti fanno login contemporaneamente:
  - Scenario attuale: {descrivere cosa succede oggi}
  - Race conditions: {identificare possibili race}
  - Lock contention: {utenti aspettano o fallisce?}
  - Sync ridondanti: {5 sync identici o 1 sync shared?}

**Shared resource conflicts**:
- User A scrive products.db mentre User B sta leggendo → {cosa succede?}
- Database locked durante write → {altri sync aspettano o falliscono?}

## Dependencies

- **Dipende da**: Nessuno (può partire per primo)
- **Altri dipendono da lui**: Price sync ha bisogno che products.db sia popolato

## Issues Found

**Issue 1: {Nome problema - focus su multi-user}**
- **Descrizione**: {race condition multi-user, lock issues, etc.}
- **Impatto**: HIGH (può causare data corruption con multipli user)
- **Evidenze**: {codice, scenario riproduzione}

**Issue 2: {Nome problema}**
...

## Fixes Needed

Lista problemi critici SHARED-SPECIFIC da risolvere.
```

**Enfasi**: Documento deve chiarire impatto "shared 1:1" su concorrenza.
  </action>
  <verify>cat .planning/phases/14-sync-discovery-mapping/products-sync.md mostra documento con sezione shared concurrency</verify>
  <done>Documento narrativo completo con focus critico su problemi shared sync e multi-user concurrency</done>
</task>

<task type="auto">
  <name>Task 3: Fix problemi critici shared sync</name>
  <files>archibald-web-app/backend/src/product-sync-service.ts, archibald-web-app/backend/src/sync-scheduler.ts</files>
  <action>
Per ogni problema critico SHARED-SPECIFIC identificato:

**Workflow per ogni fix:**

1. **Backup**: Creare .backup dei file modificati
2. **Implement fix**: Soluzioni per shared sync (lock, deduplication, etc.)
3. **Test multi-user**: Verificare che fix funzioni con multipli user
4. **Commit atomico**: Un commit per fix
5. **Update doc**: Aggiornare products-sync.md sezione "Fixes Implemented"

**Fix patterns comuni per shared sync:**

**Pattern 1: Lock/Semaphore per evitare sync concorrenti**
```typescript
// Esempio (non implementare ciecamente, analizzare prima)
private static syncLock: boolean = false;

async syncProducts() {
  if (ProductSyncService.syncLock) {
    logger.info('Product sync already running, skipping');
    return;
  }

  ProductSyncService.syncLock = true;
  try {
    // ... sync logic
  } finally {
    ProductSyncService.syncLock = false;
  }
}
```

**Pattern 2: Deduplication (evita sync ridondanti)**
```typescript
// Se 5 user triggerano sync, esegui 1 solo sync e notifica tutti
```

**Pattern 3: Queue con single worker**
```typescript
// Accoda richieste, processa sequenzialmente
```

**Priorità fix:**
- Prima: Race conditions multi-user (data corruption)
- Secondo: Sync ridondanti (performance waste)
- Terzo: Lock contention (UX - user aspetta troppo)

**IMPORTANTE**: Shared sync fixes sono più delicati di per-user fixes. Testare attentamente.

Se NON ci sono problemi critici → Skip e documentare "Shared sync already handles concurrency correctly"
  </action>
  <verify>git log --oneline -5 mostra commit atomici; npm test passa; manual multi-user test OK</verify>
  <done>Problemi critici shared sync risolti, testati con scenari multi-user, committati atomicamente</done>
</task>

</tasks>

<verification>
Prima di dichiarare il plan completo:
- [ ] products-sync.md completo con tutte le sezioni
- [ ] Sezione "Shared 1:1" ben documentata con impatto concorrenza
- [ ] Scenari multi-user analizzati in dettaglio
- [ ] Problemi shared-specific identificati (se presenti)
- [ ] Fix applicati e testati con scenari multi-user
- [ ] Commit atomici per ogni fix
</verification>

<success_criteria>

- products-sync.md documento narrativo completo
- Caratteristica "shared 1:1" ben spiegata e impatti documentati
- Scenari multi-user concurrency analizzati
- Trigger points, flow, dependencies documentati
- Problemi critici shared-specific (se trovati) risolti
- Test multi-user scenari verificati
  </success_criteria>

<output>
Dopo il completamento, creare `.planning/phases/14-sync-discovery-mapping/14-02-SUMMARY.md`:

# Phase 14 Plan 02: Product Sync Analysis & Fixes

**Product sync (shared 1:1) analizzato, problemi concorrenza multi-user risolti**

## Accomplishments

- Complete product sync analysis with shared resource focus
- products-sync.md narrative documentation created
- Multi-user concurrency scenarios analyzed in detail
- [N] critical shared-sync issues identified and fixed
- [N] atomic commits for shared-sync fixes

## Files Created/Modified

- `.planning/phases/14-sync-discovery-mapping/products-sync.md` - Complete narrative doc with shared focus
- `archibald-web-app/backend/src/product-sync-service.ts` - [If fixed]
- `archibald-web-app/backend/src/sync-scheduler.ts` - [If fixed for coordination]

## Decisions Made

[Key decisions for shared sync concurrency management]

## Issues Encountered

[Shared-specific problems and resolutions]

## Next Step

Ready for 14-03-PLAN.md (Price Sync Analysis & Fixes)
</output>
