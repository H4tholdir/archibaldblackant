---
phase: 14-sync-discovery-mapping
plan: 01
type: execute
---

<objective>
Analizzare completamente il customer sync (per-user) e risolvere problemi critici identificati.

Purpose: Comprendere come funziona il customer sync, identificare race conditions, blocking UI e altri problemi, e fixarli immediatamente per garantire affidabilità.
Output: Documento `customers-sync.md` completo + codice refactorato con problemi risolti
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sync-discovery-mapping/14-CONTEXT.md
@archibald-web-app/backend/src/customer-sync-service.ts
@archibald-web-app/backend/src/sync-scheduler.ts
@archibald-web-app/backend/src/user-specific-sync-service.ts
@archibald-web-app/backend/src/priority-manager.ts

**Stato attuale:**
- Customer sync è per-user (ogni utente ha il proprio database SQLite)
- Trigger automatici: login, reconnect, stale data (3-day threshold)
- Trigger manuali: force refresh button
- PriorityManager già implementato (Phase 4.1-01) per coordinazione con order creation

**Focus Phase 14:**
- Discovery + documentazione narrativa
- Identificazione e FIX problemi critici (race conditions, blocking UI, bottleneck)
- Testing dei fix implementati
- Codice refactorato e ottimizzato
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analisi profonda customer-sync-service.ts</name>
  <files>archibald-web-app/backend/src/customer-sync-service.ts</files>
  <action>
Analizzare completamente il file customer-sync-service.ts:

1. **Trigger Points**: Identificare TUTTI i modi in cui il sync può essere attivato
   - Cercare chiamate a syncCustomers() nel codebase
   - Analizzare sync-scheduler.ts per trigger automatici
   - Verificare trigger manuali (API endpoints)

2. **Step-by-Step Flow**: Mappare la sequenza completa
   - Cosa fa syncCustomers() internamente step-by-step
   - Come acquista BrowserContext
   - Come scrape Archibald (URL, selettori, paginazione)
   - Come processa i dati (trasformazioni, validazioni)
   - Come scrive in SQLite
   - Come notifica frontend

3. **Concurrency Scenarios**: Identificare scenari concorrenti
   - Può girare mentre product/price sync sono attivi?
   - Cosa succede se triggherato due volte contemporaneamente (stesso user)?
   - Cosa succede con multi-user (shared browser)?

4. **Dependencies**: Analizzare dipendenze
   - Dipende da altri sync prima di partire?
   - Altri sync dipendono da customer sync?

5. **Issues/Bottlenecks**: Identificare problemi evidenti
   - Operazioni lente (scraping, database writes)
   - Blocking operations
   - Race conditions possibili
   - Errori di gestione errori
   - Memory leaks potenziali

Documentare findings in formato strutturato.
  </action>
  <verify>grep -r "syncCustomers" archibald-web-app/backend/src/ trova tutti i trigger points</verify>
  <done>Analisi completa con tutti i 5 aspetti documentati in dettaglio</done>
</task>

<task type="auto">
  <name>Task 2: Creare documento customers-sync.md narrativo</name>
  <files>.planning/phases/14-sync-discovery-mapping/customers-sync.md</files>
  <action>
Creare documento narrativo (non tabelle) che racconta la storia di come funziona il customer sync:

**Struttura:**

```markdown
# Customer Sync - Per-User Database

**Type**: Per-User (ogni utente ha il proprio customers-{userId}.db)

## Trigger Points

Quando viene attivato il sync:
- **Login automatico**: Quando l'utente fa login...
- **Reconnect automatico**: Quando la rete torna online...
- **Stale data (3-day)**: Quando i dati hanno più di 72 ore...
- **Force refresh manuale**: Quando l'utente clicca il pulsante refresh...

## Step-by-Step Flow

"Quando viene triggerato il customer sync, succede quanto segue..."

1. **Acquisizione context**: Il sync chiama browserPool.acquire(userId)...
2. **Navigazione Archibald**: Puppeteer naviga a {URL}...
3. **Scraping dati**: Per ogni pagina (fino a MAX_PAGES)...
4. **Processing**: I dati vengono trasformati da HTML a CustomerRow...
5. **Database write**: SQLite customers-{userId}.db viene aggiornato con...
6. **Notifica frontend**: WebSocket invia progress updates...

## Concurrency Scenarios

**Single-user concurrency**:
- Login triggera customers+products+prices insieme → {analisi}
- Se triggerato due volte dallo stesso user → {analisi}

**Multi-user concurrency**:
- User A e User B triggerano sync contemporaneamente → {analisi}
- Shared browser instance con BrowserContext separati → {analisi}

## Dependencies

- **Dipende da**: Nessun altro sync (può partire per primo)
- **Altri dipendono da lui**: Orders sync ha bisogno che customer database sia popolato

## Issues Found

**Issue 1: {Nome problema}**
- **Descrizione**: {cosa succede}
- **Impatto**: {HIGH/MEDIUM/LOW}
- **Evidenze**: {codice line numbers, screenshot, logs}

**Issue 2: {Nome problema}**
...

## Fixes Needed

Lista dei problemi che vanno risolti nel Task 3.
```

Stile narrativo: racconta una storia, non elenco arido. Usa paragrafi e spiegazioni.
  </action>
  <verify>cat .planning/phases/14-sync-discovery-mapping/customers-sync.md mostra documento completo</verify>
  <done>Documento narrativo completo con tutte le sezioni, problemi identificati con evidenze</done>
</task>

<task type="auto">
  <name>Task 3: Fix problemi critici identificati</name>
  <files>archibald-web-app/backend/src/customer-sync-service.ts</files>
  <action>
Per ogni problema critico (HIGH impact) identificato nel Task 2:

**Workflow per ogni fix:**

1. **Backup**: Creare customer-sync-service.ts.backup prima di modificare
2. **Implement fix**: Risolvere il problema con la soluzione ottimale
3. **Test immediato**: Eseguire test esistenti + manual test se necessario
4. **Commit atomico**: Un commit per ogni problema risolto
5. **Update doc**: Aggiornare customers-sync.md sezione "Fixes Implemented"

**Priorità fix:**
- Prima: Race conditions (possono causare data corruption)
- Secondo: Blocking UI (UX critica)
- Terzo: Performance bottleneck evidenti

**Anti-pattern da evitare:**
- Non introdurre nuova complessità per risolvere problemi semplici
- Non fixare problemi LOW impact se richiedono refactor massicci
- Non cambiare architettura senza necessità (fix chirurgici, non rebuild)

**Test dei fix:**
- Eseguire npm test per verificare che test esistenti passino
- Se c'è test per customer-sync-service, deve passare
- Se necessario, fare manual test con real sync

Se NON ci sono problemi critici (HIGH impact) → Skip questo task e documentare "No critical issues found"
  </action>
  <verify>git log --oneline -5 mostra commit atomici per i fix; npm test passa</verify>
  <done>Tutti i problemi critici identificati sono stati risolti, testati e committati atomicamente</done>
</task>

</tasks>

<verification>
Prima di dichiarare il plan completo:
- [ ] customers-sync.md esiste ed è completo (tutte le sezioni presenti)
- [ ] Tutti i 5 aspetti critici sono documentati (Triggers, Flow, Concurrency, Dependencies, Issues)
- [ ] Se problemi critici trovati → fixati e testati
- [ ] Commit atomici creati per ogni fix
- [ ] customers-sync.md include sezione "Fixes Implemented" se fix applicati
</verification>

<success_criteria>

- customers-sync.md documento narrativo completo
- Tutti i trigger points identificati
- Step-by-step flow mappato completamente
- Scenari concorrenza analizzati (single-user focus)
- Dipendenze documentate
- Problemi critici (se trovati) risolti con commit atomici
- Test passano (no regressioni)
  </success_criteria>

<output>
Dopo il completamento, creare `.planning/phases/14-sync-discovery-mapping/14-01-SUMMARY.md`:

# Phase 14 Plan 01: Customer Sync Analysis & Fixes

**Customer sync (per-user) analizzato, documentato e problemi critici risolti**

## Accomplishments

- Complete customer sync analysis (triggers, flow, concurrency, dependencies, issues)
- customers-sync.md narrative documentation created
- [N] critical issues identified and fixed
- [N] atomic commits for fixes

## Files Created/Modified

- `.planning/phases/14-sync-discovery-mapping/customers-sync.md` - Complete narrative doc
- `archibald-web-app/backend/src/customer-sync-service.ts` - [If fixed]
- `archibald-web-app/backend/src/customer-sync-service.ts.backup` - [If fixed]

## Decisions Made

[Key decisions and rationale for fixes, or "No critical issues found"]

## Issues Encountered

[Problems found and how resolved, or "None"]

## Next Step

Ready for 14-02-PLAN.md (Product Sync Analysis & Fixes)
</output>
