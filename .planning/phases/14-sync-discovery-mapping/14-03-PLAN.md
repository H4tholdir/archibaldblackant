---
phase: 14-sync-discovery-mapping
plan: 03
type: execute
---

<objective>
Analizzare completamente il price sync (shared 1:1) e risolvere problemi critici identificati.

Purpose: Comprendere come funziona il price sync shared, identificare dipendenze da product sync e problemi di concorrenza, e fixarli per garantire affidabilità.
Output: Documento `prices-sync.md` completo + codice refactorato con problemi risolti
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sync-discovery-mapping/14-CONTEXT.md
@.planning/phases/14-sync-discovery-mapping/14-01-SUMMARY.md
@.planning/phases/14-sync-discovery-mapping/14-02-SUMMARY.md
@.planning/phases/14-sync-discovery-mapping/customers-sync.md
@.planning/phases/14-sync-discovery-mapping/products-sync.md
@archibald-web-app/backend/src/price-sync-service.ts
@archibald-web-app/backend/src/product-sync-service.ts
@archibald-web-app/backend/src/sync-scheduler.ts

**Caratteristiche price sync:**
- SHARED 1:1 come product sync (prices.db condiviso)
- Dipende fortemente da product sync (need products.db popolato first)
- Phase 4.1-02 implementò multi-level matching per 100% coverage

**Focus:**
- Dipendenza da product sync (sequenza corretta?)
- Concorrenza multi-user (come product sync)
- Matching logic affidabilità
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analisi profonda price-sync-service.ts</name>
  <files>archibald-web-app/backend/src/price-sync-service.ts</files>
  <action>
Analizzare completamente price-sync-service.ts con focus su **dependency + shared**:

1. **Trigger Points**: Identificare trigger e dependency check
   - Quando viene triggerato price sync?
   - Verifica che products.db sia popolato prima di partire?
   - Cosa succede se triggerato prima di product sync?

2. **Step-by-Step Flow**: Mappare sequenza con dependency awareness
   - Pre-check: Verifica products.db esistente?
   - Acquisizione context (shared o per-user?)
   - Scraping prezzi da Archibald
   - Matching con products (multi-level: ID → name → normalized)
   - Database write prices.db shared
   - Notifica multi-user frontend

3. **Concurrency Scenarios** - Shared + Dependency
   - **Dependency race**: User A product sync + User B price sync contemporanei?
   - **Multi-user race**: 5 utenti triggerano price sync contemporaneamente?
   - **Shared resource**: Come product sync, race su prices.db writes?
   - **Sync ordering**: Login triggera customers+products+prices → ordine garantito?

4. **Dependencies** - FOCUS CRITICO
   - **Hard dependency**: Price sync DEVE aspettare product sync?
   - **Dependency check**: C'è validation che products.db è ready?
   - **Failure mode**: Cosa succede se products.db vuoto/missing?
   - **Cascade sync**: Product sync triggera automaticamente price sync dopo?

5. **Issues/Bottlenecks**: Problemi dependency + shared
   - Race condition: price sync parte prima che product sync finisce
   - Matching failures se products.db incomplete
   - Shared resource conflicts (come product sync)
   - Performance: ~4,500 prices + matching algorithm

**Focus**: Dependency management + shared resource concurrency.
  </action>
  <verify>grep -r "syncPrices\|price-sync" archibald-web-app/backend/src/ trova trigger e dependency checks</verify>
  <done>Analisi completa con focus su dependency chain e shared resource management</done>
</task>

<task type="auto">
  <name>Task 2: Creare documento prices-sync.md narrativo</name>
  <files>.planning/phases/14-sync-discovery-mapping/prices-sync.md</files>
  <action>
Creare documento narrativo per price sync SHARED con DEPENDENCY:

**Struttura:**

```markdown
# Price Sync - Shared 1:1 Database with Product Dependency

**Type**: **SHARED 1:1** (un solo prices.db condiviso da tutti gli utenti)

**Critical Dependency**: Price sync **REQUIRES** product sync to complete first. Cannot match prices without products.db populated.

**Impatto dependency + shared**: Questa combinazione introduce complessità:
- Se User A triggera product+price contemporaneamente → ordine garantito?
- Se User B triggera price mentre User A sta facendo product → race condition?
- Se product sync fallisce → price sync deve abortire?

## Trigger Points

Quando viene attivato (da qualsiasi utente):
- **Login automatico**: Ogni utente triggera customers+products+prices in sequenza?
- **Reconnect automatico**: Triggera anche dependencies?
- **Stale data (3-day)**: Triggera solo price o anche product?
- **Force refresh manuale**: User può triggerare price senza product?

**Dependency check**: {c'è validazione che products.db è ready? Cosa succede se non lo è?}

## Step-by-Step Flow

"Quando viene triggerato il price sync..."

1. **Dependency check**: Verifica che products.db sia populated... {analisi}
2. **Lock acquisition**: {shared sync lock come product sync?}
3. **Acquisizione context**: BrowserContext per scraping...
4. **Scraping**: Archibald prezzi (~4,500 prices)...
5. **Matching con products**: Multi-level matching (ID → name → normalized)...
   - Lettura products.db (dependency!)
   - Matching algorithm Phase 4.1-02
   - Fallback a group averages per missing prices
6. **Database write**: prices.db SHARED aggiornato...
7. **Notifica multi-user**: TUTTI i frontend ricevono notifica...

## Concurrency Scenarios

**Single-user with dependency**:
- Login triggera products+prices → {sequenza garantita? Parallel o sequential?}
- Products sync 30s, prices sync 20s → overlapping? Race?

**Multi-user with shared dependency**:
- User A: product sync running (30s)
- User B: price sync triggered → {aspetta A? Procede? Fallisce?}
- 5 utenti login contemporaneamente → {10 sync o orchestrazione intelligente?}

**Dependency race conditions - CRITICO**:
- Price sync parte prima che product sync finisce → matching failures
- Products.db partially written durante price sync → inconsistent matches
- Product sync fallisce → price sync deve abortire o continua?

## Dependencies

- **Dipende da**: **Product sync (HARD DEPENDENCY)** - DEVE completare prima
- **Altri dipendono da lui**: Nessuno (price è ultimo in catena)

**Dependency chain**: customers (indipendente) → products (indipendente) → **prices (dipende da products)**

## Issues Found

**Issue 1: {Nome problema - focus su dependency race}**
- **Descrizione**: Price sync può partire prima che product sync finisce...
- **Impatto**: HIGH (matching failures, inconsistent data)
- **Evidenze**: {codice, scenario}

**Issue 2: {Nome problema - shared sync}**
- **Descrizione**: Come product sync, race multi-user...
- **Impatto**: HIGH (data corruption, sync ridondanti)

**Issue 3: {Performance con matching}**
- **Descrizione**: ~4,500 prices + matching algorithm...
- **Impatto**: MEDIUM (potrebbe bloccare altri sync)

## Fixes Needed

Problemi critici dependency + shared sync.
```

**Enfasi**: Documento deve spiegare chiaramente dependency chain e impatti.
  </action>
  <verify>cat .planning/phases/14-sync-discovery-mapping/prices-sync.md mostra documento con dependency analysis</verify>
  <done>Documento narrativo completo con focus su dependency management e shared concurrency</done>
</task>

<task type="auto">
  <name>Task 3: Fix problemi critici dependency + shared sync</name>
  <files>archibald-web-app/backend/src/price-sync-service.ts, archibald-web-app/backend/src/sync-scheduler.ts</files>
  <action>
Per ogni problema critico identificato (dependency + shared):

**Workflow per ogni fix:**

1. **Backup**: Creare .backup dei file modificati
2. **Implement fix**: Soluzioni per dependency + shared issues
3. **Test dependency scenarios**: Verificare ordine sync corretto
4. **Test multi-user**: Verificare shared resource handling
5. **Commit atomico**: Un commit per fix
6. **Update doc**: Aggiornare prices-sync.md "Fixes Implemented"

**Fix patterns comuni per dependency + shared:**

**Pattern 1: Dependency check before sync**
```typescript
// Esempio
async syncPrices() {
  const productsReady = await this.checkProductsDbPopulated();
  if (!productsReady) {
    logger.warn('Cannot sync prices: products.db not ready');
    throw new Error('Product sync must complete first');
  }
  // ... proceed with sync
}
```

**Pattern 2: Cascade sync (product → price automatico)**
```typescript
// In product-sync-service.ts after sync completes
await this.priceSyncService.syncPrices(); // Cascade
```

**Pattern 3: Shared lock (come product sync)**
```typescript
// Evita race multi-user su prices.db
```

**Pattern 4: Sync orchestration con dependency graph**
```typescript
// In sync-scheduler.ts
// Esegui in ordine: products → wait → prices
```

**Priorità fix:**
- Prima: Dependency race (price senza products → data corruption)
- Secondo: Shared resource race (multi-user conflicts)
- Terzo: Performance bottleneck matching

**IMPORTANTE**: Fix dependency race è CRITICO - può causare matching failures silenti.

Se NON ci sono problemi critici → Skip e documentare "Dependency + shared sync handled correctly"
  </action>
  <verify>git log --oneline -5 mostra commit; npm test passa; manual dependency test OK</verify>
  <done>Problemi critici dependency + shared risolti, testati con scenari dependency chain, committati atomicamente</done>
</task>

</tasks>

<verification>
Prima di dichiarare il plan completo:
- [ ] prices-sync.md completo con tutte le sezioni
- [ ] Dependency da product sync chiaramente documentata
- [ ] Shared 1:1 characteristics documentate
- [ ] Scenari dependency race analizzati
- [ ] Problemi critici dependency + shared identificati
- [ ] Fix applicati e testati (dependency chain + multi-user)
- [ ] Commit atomici per ogni fix
</verification>

<success_criteria>

- prices-sync.md documento narrativo completo
- Hard dependency da product sync ben documentata
- Shared 1:1 characteristics spiegate
- Dependency race scenarios analizzati
- Trigger points, flow, concurrency documentati
- Problemi critici dependency + shared (se trovati) risolti
- Dependency chain tested (products → prices)
  </success_criteria>

<output>
Dopo il completamento, creare `.planning/phases/14-sync-discovery-mapping/14-03-SUMMARY.md`:

# Phase 14 Plan 03: Price Sync Analysis & Fixes

**Price sync (shared 1:1 with product dependency) analizzato, dependency race risolti**

## Accomplishments

- Complete price sync analysis with dependency chain focus
- prices-sync.md narrative documentation created
- Product dependency clearly mapped and documented
- Multi-user + dependency race scenarios analyzed
- [N] critical dependency + shared issues identified and fixed
- [N] atomic commits for fixes

## Files Created/Modified

- `.planning/phases/14-sync-discovery-mapping/prices-sync.md` - Complete narrative doc with dependency focus
- `archibald-web-app/backend/src/price-sync-service.ts` - [If fixed]
- `archibald-web-app/backend/src/sync-scheduler.ts` - [If orchestration fixed]

## Decisions Made

[Key decisions for dependency management and shared sync]

## Issues Encountered

[Dependency race problems and resolutions]

## Next Step

Ready for 14-04-PLAN.md (Orders Sync Analysis & Fixes)
</output>
