---
phase: 14-sync-discovery-mapping
plan: 04
type: execute
---

<objective>
Analizzare completamente il orders sync (per-user) e creare sintesi finale del sistema di sync.

Purpose: Comprendere come funziona l'orders sync per-user, creare documento finale che unifica la visione completa dei 4 sync con le loro interazioni, e produrre raccomandazioni per le fasi successive.
Output: Documento `orders-sync.md` + `sync-system-overview.md` (sintesi finale)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sync-discovery-mapping/14-CONTEXT.md
@.planning/phases/14-sync-discovery-mapping/14-01-SUMMARY.md
@.planning/phases/14-sync-discovery-mapping/14-02-SUMMARY.md
@.planning/phases/14-sync-discovery-mapping/14-03-SUMMARY.md
@.planning/phases/14-sync-discovery-mapping/customers-sync.md
@.planning/phases/14-sync-discovery-mapping/products-sync.md
@.planning/phases/14-sync-discovery-mapping/prices-sync.md
@archibald-web-app/backend/src/order-state-sync-service.ts
@archibald-web-app/backend/src/user-specific-sync-service.ts
@archibald-web-app/backend/src/sync-scheduler.ts

**Caratteristiche orders sync:**
- Per-user (ogni utente ha il proprio order state cache)
- Meno critico di altri sync (orders read-only, non creation)
- Phase 11: Order tracking con 2-hour TTL cache

**Focus finale:**
- Completare documentazione orders sync
- Creare sintesi unificata del sistema
- Identificare pattern comuni e problemi sistemici
- Raccomandazioni per Phase 15-21
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analisi order-state-sync-service.ts e documentazione</name>
  <files>archibald-web-app/backend/src/order-state-sync-service.ts, .planning/phases/14-sync-discovery-mapping/orders-sync.md</files>
  <action>
Analizzare order-state-sync-service.ts e creare orders-sync.md:

1. **Analisi codice**: 5 aspetti standard (Triggers, Flow, Concurrency, Dependencies, Issues)
   - Orders sync è per-user come customer sync
   - Dipende da customers.db (need customer data for orders)
   - Ha cache TTL 2-hour (Phase 11)
   - On-demand sync (non automatico login?)

2. **Creare orders-sync.md** con struttura standard:

```markdown
# Orders Sync - Per-User Cache

**Type**: Per-User (ogni utente ha il proprio order state cache)

**Caratteristiche uniche**:
- Read-only sync (no order creation, solo tracking)
- 2-hour TTL cache (più breve di altri sync)
- On-demand trigger (chiamato quando user visualizza order history)
- Dipende da customers.db per customer data

## Trigger Points

Quando viene attivato:
- **On-demand**: User apre order history page...
- **Stale cache (2-hour)**: Cache scaduta triggera re-sync...
- **Manual refresh**: User clicca refresh in order history...

**NON triggherato automaticamente su login** (a differenza di customers/products/prices).

## Step-by-Step Flow

{Sequenza completa}

## Concurrency Scenarios

**Single-user**:
- Order history aperta + manual refresh → {analisi}

**Multi-user**:
- Meno critico (per-user, non shared)
- Ogni user ha cache separata

## Dependencies

- **Dipende da**: Customers sync (need customer data for order mapping)
- **Altri dipendono da lui**: Nessuno

## Issues Found

{Identificare problemi se presenti}

## Fixes Implemented

{Se fix applicati}
```

**Note**: Orders sync è meno complesso degli altri, documentazione può essere più breve se appropriato.
  </action>
  <verify>cat .planning/phases/14-sync-discovery-mapping/orders-sync.md mostra documento completo</verify>
  <done>orders-sync.md creato, analisi completa, eventuali fix applicati</done>
</task>

<task type="auto">
  <name>Task 2: Creare sintesi unificata sync-system-overview.md</name>
  <files>.planning/phases/14-sync-discovery-mapping/sync-system-overview.md</files>
  <action>
Creare documento di sintesi che unifica la visione dei 4 sync:

**Struttura:**

```markdown
# Sync System Overview - Complete Map

Documento di sintesi che unifica la comprensione dei 4 sync systems analizzati in Phase 14.

## I Quattro Sync

### Per-User Sync (2)
1. **Customer Sync** - Ogni utente ha customers-{userId}.db
2. **Orders Sync** - Ogni utente ha order cache separata

### Shared 1:1 Sync (2)
1. **Product Sync** - Un solo products.db condiviso da tutti
2. **Price Sync** - Un solo prices.db condiviso da tutti

## Dependency Chain

```
Login Trigger
├── Customers Sync (per-user, indipendente)
├── Products Sync (shared, indipendente)
│   └── Price Sync (shared, DIPENDE da products)
└── Orders Sync (per-user, on-demand non su login)
```

**Critical dependencies**:
- Price sync MUST wait for products sync
- Orders sync needs customers.db data

## Trigger Matrix

| Sync | Login | Reconnect | Stale (3d) | Force Refresh | On-Demand |
|------|-------|-----------|------------|---------------|-----------|
| Customers | ✅ Auto | ✅ Auto | ✅ Auto | ✅ Manual | - |
| Products | ✅ Auto | ✅ Auto | ✅ Auto | ✅ Manual | - |
| Prices | ✅ Auto | ✅ Auto | ✅ Auto | ✅ Manual | - |
| Orders | ❌ No | ❌ No | ✅ 2h TTL | ✅ Manual | ✅ Page open |

## Concurrency Patterns

### Single-User Concurrency
**Login scenario** (1 user, 3 sync contemporanei):
- Customers + Products + Prices triggerati insieme
- {Analisi: come sono orchestrati oggi? Parallel? Sequential? Issues?}

### Multi-User Concurrency
**Shared sync race** (5 users login contemporaneamente):
- 5x customers sync: OK (per-user databases, no conflicts)
- 5x products sync: {analisi: race su products.db? Lock? Dedup?}
- 5x prices sync: {analisi: race su prices.db? Lock? Dependency race?}

**Critical race scenarios identified**:
1. {Race scenario 1 da plans 14-01/02/03}
2. {Race scenario 2}
3. {Race scenario 3}

## Issues Summary

### Critical Issues Fixed in Phase 14
1. **{Issue from 14-01}** - Customer sync: {problema} → Fixed with {soluzione}
2. **{Issue from 14-02}** - Product sync: {problema} → Fixed with {soluzione}
3. **{Issue from 14-03}** - Price sync: {problema} → Fixed with {soluzione}
4. **{Issue from 14-04}** - Orders sync: {problema} → Fixed with {soluzione}

### Open Issues for Future Phases
1. **{Issue deferred}** - {descrizione} → Defer to Phase {N}
2. **{Issue deferred}** - {descrizione} → Defer to Phase {N}

## System-Level Patterns

**Pattern 1: Shared sync needs orchestration**
- Products e prices sono shared → need lock/dedup per multi-user
- {Stato attuale vs ideale}

**Pattern 2: Dependency chain needs enforcement**
- Price dipende da products → need ordering guarantee
- {Stato attuale vs ideale}

**Pattern 3: Trigger explosion su login**
- 5 users × 3 sync = 15 operations
- Potenziale optimization: {idea}

## Architecture Insights

**Current State**:
- {Descrizione architettura attuale basata su analisi}
- Punti di forza: {lista}
- Punti deboli: {lista}

**Ideal State** (target per Phase 15-21):
- {Visione architettura ideale}
- Miglioramenti necessari: {lista}

## Recommendations for Phase 15-21

### Phase 15: Individual Sync Testing
- Test isolation per ogni sync
- Performance baselines
- Failure mode testing

### Phase 16: Concurrent Sync Scenarios
- Test multi-user race conditions
- Validate shared sync orchestration
- Load testing (10, 50, 100 concurrent users)

### Phase 17: Auto vs Manual Differentiation
- {Raccomandazioni basate su analisi triggers}

### Phase 18: Sync Scheduler
- {Raccomandazioni architettura scheduler}
- Priority management
- Deduplication logic
- Dependency enforcement

### Phase 19-21: Monitoring, Reliability, Optimization
- {Raccomandazioni high-level}

## Conclusion

Phase 14 ha prodotto:
- ✅ 4 documenti narrativi atomici (customers, products, prices, orders)
- ✅ Comprensione completa trigger points e flow
- ✅ Identificazione scenari concorrenza single-user e multi-user
- ✅ Dependency chain mappata
- ✅ {N} problemi critici identificati e risolti
- ✅ Visione unificata sistema sync completo

Ready per Phase 15 (Testing) con comprensione profonda del sistema.
```

**Obiettivo**: Questo documento serve come "mappa del tesoro" per le fasi 15-21. Deve essere chiaro, actionable, e basato su evidenze concrete dall'analisi.
  </action>
  <verify>cat .planning/phases/14-sync-discovery-mapping/sync-system-overview.md mostra sintesi completa</verify>
  <done>Sintesi unificata creata, raccomandazioni per Phase 15-21 documentate, visione completa sistema sync</done>
</task>

<task type="auto">
  <name>Task 3: Commit finale e preparazione Phase 15</name>
  <files>.planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
Finalizz are Phase 14:

1. **Git commit per sintesi**:
```bash
git add .planning/phases/14-sync-discovery-mapping/orders-sync.md
git add .planning/phases/14-sync-discovery-mapping/sync-system-overview.md
git commit -m "docs(14-04): complete sync system overview and recommendations"
```

2. **Aggiornare STATE.md**:
- Aggiungere decisioni chiave dalla Phase 14
- Documentare problemi risolti
- Aggiornare "Current Position" a Phase 14 complete

3. **Verificare deliverables Phase 14**:
```bash
ls -la .planning/phases/14-sync-discovery-mapping/*.md
```

Deve contenere:
- 14-CONTEXT.md ✓
- customers-sync.md ✓
- products-sync.md ✓
- prices-sync.md ✓
- orders-sync.md ✓
- sync-system-overview.md ✓
- 14-01-PLAN.md ✓
- 14-02-PLAN.md ✓
- 14-03-PLAN.md ✓
- 14-04-PLAN.md ✓
- 14-01-SUMMARY.md (dopo esecuzione)
- 14-02-SUMMARY.md (dopo esecuzione)
- 14-03-SUMMARY.md (dopo esecuzione)
- 14-04-SUMMARY.md (dopo esecuzione)

4. **Verificare fix committati**:
```bash
git log --oneline --grep="14-0" | head -20
```

Tutti i fix dei plans 14-01/02/03/04 devono essere committati atomicamente.

5. **Preparare Phase 15**:
- Nessuna azione necessaria, la sintesi include raccomandazioni
  </action>
  <verify>git log mostra commit, STATE.md aggiornato, tutti 6 .md docs presenti</verify>
  <done>Phase 14 finalizzata, STATE.md aggiornato, sistema completamente documentato, ready per Phase 15</done>
</task>

</tasks>

<verification>
Prima di dichiarare il plan completo:
- [ ] orders-sync.md completo
- [ ] sync-system-overview.md creato con sintesi unificata
- [ ] Raccomandazioni per Phase 15-21 documentate
- [ ] STATE.md aggiornato con decisioni Phase 14
- [ ] Tutti i 6 documenti .md presenti nella directory
- [ ] Commit atomici per tutti i fix applicati
- [ ] Git log mostra storia completa Phase 14
</verification>

<success_criteria>

- orders-sync.md documento narrativo completo
- sync-system-overview.md sintesi unificata creata
- Dependency chain completa documentata
- Trigger matrix per tutti i 4 sync
- Concurrency patterns single-user + multi-user analizzati
- Raccomandazioni actionable per Phase 15-21
- STATE.md aggiornato
- Phase 14 completa con visione sistemica chiara
  </success_criteria>

<output>
Dopo il completamento, creare `.planning/phases/14-sync-discovery-mapping/14-04-SUMMARY.md`:

# Phase 14 Plan 04: Orders Sync & System Overview

**Orders sync analizzato, sintesi unificata del sistema completo creata**

## Accomplishments

- Complete orders sync analysis and documentation
- orders-sync.md narrative documentation created
- **sync-system-overview.md** unified system synthesis created
- Dependency chain fully mapped (4 sync)
- Trigger matrix documented (all trigger types)
- Concurrency patterns analyzed (single + multi-user)
- Recommendations for Phase 15-21 documented
- STATE.md updated with Phase 14 decisions

## Files Created/Modified

- `.planning/phases/14-sync-discovery-mapping/orders-sync.md` - Orders sync doc
- `.planning/phases/14-sync-discovery-mapping/sync-system-overview.md` - **Unified synthesis**
- `.planning/STATE.md` - Updated with Phase 14 decisions

## Decisions Made

**System-level understanding achieved**:
- 2 per-user sync (customers, orders)
- 2 shared 1:1 sync (products, prices)
- Hard dependency: prices → products
- Trigger explosion on login (customers+products+prices)
- Multi-user race conditions identified and documented

## Phase 14 Complete Summary

**Total deliverables**:
- ✅ 4 narrative documents (customers, products, prices, orders)
- ✅ 1 unified synthesis (sync-system-overview)
- ✅ {N total} critical issues identified
- ✅ {N total} critical issues fixed
- ✅ {N total} atomic commits

**Key insights**:
- Shared sync (products, prices) need orchestration for multi-user
- Dependency chain (products → prices) needs enforcement
- Per-user sync (customers, orders) have fewer concurrency issues
- Login trigger causes sync explosion (optimization opportunity)

## Next Step

Phase 14 complete. Ready for **Phase 15: Individual Sync Testing & Validation**

Recommendations from sync-system-overview.md ready to guide Phase 15-21.
</output>
