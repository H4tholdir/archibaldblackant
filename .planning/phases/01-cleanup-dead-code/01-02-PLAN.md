---
phase: 01-cleanup-dead-code
plan: 02
type: execute
---

<objective>
Fix the sentToMilanoAt → sentToVeronaAt naming inconsistency, remove legacy localStorage keys, rename remaining .test.ts files, and clean up unused exports found by Knip.

Purpose: Eliminate naming confusion and dead code patterns that would complicate fix phases 2-7.
Output: Consistent naming across code+DB, zero legacy localStorage refs, all tests following .spec.ts convention, unused exports removed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-cleanup-dead-code/1-CONTEXT.md
@.planning/phases/01-cleanup-dead-code/01-01-SUMMARY.md

**Naming inconsistency (from codebase exploration):**
The operation is "send to Verona" but code uses Milano:
- `sentToMilanoAt` variable → should be `sentToVeronaAt`
- `sent_to_milano_at` DB column → should be `sent_to_verona_at`
- `inviato_milano` state value → should be `inviato_verona`

**Files affected:**
- `archibald-web-app/backend/src/operations/handlers/send-to-verona.ts` (lines 21, 33, 41, 46)
- `archibald-web-app/backend/src/db/repositories/orders.ts` (lines 69, 143, 380)
- `archibald-web-app/backend/src/db/migrations/003-agent-tables.sql` (line 182 — reference only, don't modify)
- `archibald-web-app/backend/src/operations/handlers/send-to-verona.spec.ts`
- `archibald-web-app/backend/src/db/repositories/orders.spec.ts`

**Legacy localStorage keys (from frontend exploration):**
- `archibald_fullName` in ProfilePage.tsx line 27
- `archibald_username` in ProfilePage.tsx line 28

**Test file to rename:**
- `archibald-web-app/frontend/src/services/warehouse-matching.test.ts` → `.spec.ts`

**Knip findings for unused exports:**
Reference `knip-report.txt` from Plan 01-01 for the list of unused exports to remove.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix sentToMilanoAt → sentToVeronaAt naming</name>
  <files>
  archibald-web-app/backend/src/operations/handlers/send-to-verona.ts,
  archibald-web-app/backend/src/db/repositories/orders.ts,
  archibald-web-app/backend/src/operations/handlers/send-to-verona.spec.ts,
  archibald-web-app/backend/src/db/repositories/orders.spec.ts,
  archibald-web-app/backend/src/db/migrations/
  </files>
  <action>
  **Step 1 — Create DB migration:**
  Create a new migration file (use next available number, check `ls archibald-web-app/backend/src/db/migrations/`):
  ```sql
  -- Rename Milano to Verona (naming was incorrect from the start)
  ALTER TABLE pending_orders RENAME COLUMN sent_to_milano_at TO sent_to_verona_at;
  UPDATE pending_orders SET status = 'inviato_verona' WHERE status = 'inviato_milano';
  ```

  **Step 2 — Update TypeScript code:**
  In `send-to-verona.ts`:
  - Rename all `sentToMilanoAt` → `sentToVeronaAt`
  - Change state `'inviato_milano'` → `'inviato_verona'`
  - Update column reference `sent_to_milano_at` → `sent_to_verona_at`

  In `orders.ts` repository:
  - Rename all `sent_to_milano_at` column references → `sent_to_verona_at`
  - Rename all `sentToMilanoAt` property references → `sentToVeronaAt`

  **Step 3 — Update tests:**
  In `send-to-verona.spec.ts` and `orders.spec.ts`:
  - Update all assertions referencing `sentToMilanoAt` → `sentToVeronaAt`
  - Update all assertions referencing `sent_to_milano_at` → `sent_to_verona_at`
  - Update all assertions referencing `inviato_milano` → `inviato_verona`

  **Step 4 — Search for any remaining references:**
  Run `grep -r "milano" archibald-web-app/backend/src/ --include="*.ts"` to catch any missed references.
  Also check frontend: `grep -r "milano" archibald-web-app/frontend/src/ --include="*.ts" --include="*.tsx"`

  **What to avoid:** Do NOT modify the original migration file 003-agent-tables.sql — it's historical. The new migration handles the rename. Do NOT modify scripts/archive/ files — they're archived for reference.

  **Verify:** `npm run build --prefix archibald-web-app/backend` passes. `npm test --prefix archibald-web-app/backend` passes.
  Commit: `refactor(01-02): rename sentToMilanoAt to sentToVeronaAt`
  </action>
  <verify>
  `npm run build --prefix archibald-web-app/backend` passes.
  `npm test --prefix archibald-web-app/backend` passes.
  `grep -r "sentToMilano" archibald-web-app/backend/src/ --include="*.ts"` returns 0 results (excluding archive/).
  </verify>
  <done>All Milano→Verona renames complete. DB migration created. Build and tests pass. Zero remaining Milano references in active code.</done>
</task>

<task type="auto">
  <name>Task 2: Remove legacy localStorage keys, rename test file, clean dead exports</name>
  <files>
  archibald-web-app/frontend/src/pages/ProfilePage.tsx,
  archibald-web-app/frontend/src/services/warehouse-matching.test.ts
  </files>
  <action>
  **Step 1 — Remove legacy localStorage keys:**
  In `ProfilePage.tsx`, find and remove the lines reading `archibald_fullName` and `archibald_username` from localStorage (lines ~27-28). These are legacy keys from before the backend-as-source-of-truth refactoring. If they are displayed in the profile, replace with data from the auth context or API instead. If they're just reads with no UI impact, simply remove them.

  Search all frontend code for any other references to these keys:
  `grep -r "archibald_fullName\|archibald_username" archibald-web-app/frontend/src/ --include="*.ts" --include="*.tsx"`

  **Step 2 — Rename test file:**
  `mv archibald-web-app/frontend/src/services/warehouse-matching.test.ts archibald-web-app/frontend/src/services/warehouse-matching.spec.ts`
  Verify the test still runs after rename.

  **Step 3 — Remove unused exports from Knip report:**
  Reference the knip-report.txt from Plan 01-01. For each unused export:
  1. Verify it's truly unused (not a false positive from barrel files or dynamic imports)
  2. If confirmed unused, remove the export keyword (if the function/type is still used locally) or delete the entire declaration (if nothing references it)
  3. After each batch of removals, run build+test to verify

  **What to avoid:** Do NOT remove exports that are part of public API contracts (e.g., types that may be used by consumers). Do NOT remove exports from barrel files (index.ts) without checking all re-export chains. When in doubt, keep the export.

  **Verify and commit:**
  - `npm run type-check --prefix archibald-web-app/frontend` passes
  - `npm run build --prefix archibald-web-app/backend` passes
  - `npm test --prefix archibald-web-app/frontend` passes
  - `npm test --prefix archibald-web-app/backend` passes
  Commit: `refactor(01-02): remove legacy localStorage keys, rename test, clean dead exports`
  </action>
  <verify>
  `npm run type-check --prefix archibald-web-app/frontend` passes.
  `npm test --prefix archibald-web-app/frontend` passes.
  `npm test --prefix archibald-web-app/backend` passes.
  `grep -r "archibald_fullName\|archibald_username" archibald-web-app/frontend/src/` returns 0 results.
  warehouse-matching.spec.ts exists, warehouse-matching.test.ts does not.
  </verify>
  <done>Legacy localStorage keys removed. Test file renamed to .spec.ts. Dead exports cleaned. All builds and tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Zero `sentToMilano` references in active backend code (excluding archive/)
- [ ] DB migration file created for column rename
- [ ] Zero `archibald_fullName` / `archibald_username` references in frontend
- [ ] `warehouse-matching.spec.ts` exists, `.test.ts` removed
- [ ] Unused exports from Knip report addressed
- [ ] `npm run type-check --prefix archibald-web-app/frontend` passes
- [ ] `npm run build --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/frontend` passes
- [ ] `npm test --prefix archibald-web-app/backend` passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Naming consistency: Verona everywhere, Milano nowhere (in active code)
- Zero legacy localStorage references
- All test files follow .spec.ts convention
- Dead exports cleaned per Knip findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-cleanup-dead-code/01-02-SUMMARY.md`:

# Phase 1 Plan 02: Dead Exports, Naming Fix & Legacy Cleanup Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 01-03-PLAN.md (Root Directory & Project Structure Cleanup)
</output>
