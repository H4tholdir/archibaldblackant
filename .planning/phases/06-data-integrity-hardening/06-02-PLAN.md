---
phase: 06-data-integrity-hardening
plan: 02
type: execute
---

<objective>
Standardize all change-detection hashing to SHA-256, eliminating MD5.

Purpose: MD5 is cryptographically broken and inconsistent with the rest of the codebase (customer-sync and image-downloader already use SHA-256). Standardizing to SHA-256 improves data integrity and consistency. The first sync after migration will re-hash all records (one-time full sync — user-approved and acceptable).
Output: All sync hashing uses SHA-256. No MD5 in codebase. Duplicated hash logic consolidated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-integrity-hardening/06-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/sync/services/price-sync.ts
@archibald-web-app/backend/src/sync/services/order-sync.ts
@archibald-web-app/backend/src/db/repositories/orders.ts
@archibald-web-app/backend/src/db/repositories/orders.spec.ts

**MD5 locations (3 files, all change to SHA-256):**
1. `price-sync.ts` line ~75: `require('crypto').createHash('md5')` hashing 6 price fields → stored in `shared.prices.hash` (TEXT NOT NULL UNIQUE)
2. `order-sync.ts` line ~85: `require('crypto').createHash('md5')` hashing 6 order fields → stored in `agents.order_records.hash`
3. `orders.ts` repo line ~435: `crypto.createHash('md5')` hashing same 6 order fields → stored in `agents.order_records.hash`

**SHA-256 already used in:**
- `customer-sync.ts` (9 customer fields)
- `customers.ts` repository (29 customer fields)
- `image-downloader.ts` (image binary content)

**Key observations:**
- `order-sync.ts` and `orders.ts` repository DUPLICATE the same hash logic (same 6 fields, same join)
- `price-sync.ts` and `order-sync.ts` use inline `require('crypto')` instead of top-level import
- `shared.prices.hash` has UNIQUE constraint — SHA-256 produces 64-char hex (vs MD5's 32) but column is TEXT, no schema change needed
- First sync after migration triggers full re-sync (all hashes change) — user approved this

**Constraining decisions:**
- One-time full sync acceptable (no transitional dual-hash period needed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace MD5 with SHA-256 in all sync hash computations</name>
  <files>
    archibald-web-app/backend/src/sync/services/price-sync.ts,
    archibald-web-app/backend/src/sync/services/order-sync.ts,
    archibald-web-app/backend/src/db/repositories/orders.ts
  </files>
  <action>
In all 3 files, change `'md5'` to `'sha256'` in createHash calls:

1. `price-sync.ts`: Change `require('crypto').createHash('md5')` to use `'sha256'`. Also replace inline `require('crypto')` with a top-level `import crypto from 'crypto'` (or `import { createHash } from 'crypto'`). Follow the same import style used in `customer-sync.ts` for consistency.

2. `order-sync.ts`: Same changes — `'md5'` → `'sha256'`, inline `require('crypto')` → top-level import.

3. `orders.ts` repository: `computeHash` function at line ~435 already uses top-level `import crypto from 'crypto'`. Just change `'md5'` → `'sha256'`.

Do NOT change the hash input format (field selection, join character '|') — only the algorithm changes.
Do NOT add a migration or transitional period — the first sync will naturally re-hash everything.
Do NOT touch customer-sync.ts or image-downloader.ts — they already use SHA-256.
  </action>
  <verify>
npm run build --prefix archibald-web-app/backend
grep -r "createHash.*md5" archibald-web-app/backend/src/ (should return 0 results)
  </verify>
  <done>
All 3 files use SHA-256. No MD5 usage remains in backend. Inline require('crypto') replaced with top-level imports. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract shared computeOrderHash to eliminate duplication</name>
  <files>
    archibald-web-app/backend/src/sync/services/order-sync.ts,
    archibald-web-app/backend/src/db/repositories/orders.ts,
    archibald-web-app/backend/src/db/repositories/orders.spec.ts
  </files>
  <action>
The order hash computation is duplicated:
- `order-sync.ts` has inline `computeHash(o: ParsedOrder)` hashing [id, orderNumber, salesStatus, documentStatus, transferStatus, totalAmount]
- `orders.ts` repo has `computeHash(order: OrderInput)` hashing the exact same 6 fields

Consolidate by making `orders.ts` repository's `computeHash` the canonical version:
1. Export `computeHash` from `orders.ts` repository (rename to `computeOrderHash` for clarity)
2. In `order-sync.ts`, import and use `computeOrderHash` from the repository instead of the local inline version
3. Remove the local `computeHash` from `order-sync.ts`
4. Verify the input type compatibility — `ParsedOrder` and `OrderInput` should both have the 6 required fields. If types differ, use a minimal interface `{ id: string; orderNumber: string; salesStatus: string; documentStatus: string; transferStatus: string; totalAmount: number }` as the parameter type.

Update `orders.spec.ts` if it tests `computeHash` directly — update function name to `computeOrderHash`.

Do NOT change the field list or join character — only consolidate the duplication.
  </action>
  <verify>
npm run build --prefix archibald-web-app/backend
npm test --prefix archibald-web-app/backend -- --run orders
  </verify>
  <done>
Single canonical `computeOrderHash` in orders.ts repository. order-sync.ts imports it. No duplicated hash logic. Build and tests pass.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/backend` passes (all tests)
- [ ] `grep -r "createHash.*md5" archibald-web-app/backend/src/` returns 0 results
- [ ] No inline `require('crypto')` remaining in sync services
- [ ] Order hash computed in exactly one place (orders.ts repository)
</verification>

<success_criteria>

- All change-detection hashing uses SHA-256
- Zero MD5 usage in codebase
- No inline `require('crypto')` in sync services
- Order hash logic consolidated (single source of truth)
- All backend tests pass
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-integrity-hardening/06-02-SUMMARY.md`
</output>
