---
phase: 06-data-integrity-hardening
plan: 04
type: execute
---

<objective>
Migrate PDF storage from in-memory Map to filesystem with TTL-based cleanup.

Purpose: The current PDF store holds all PDFs in Node.js heap memory with no size cap, no TTL, and no cleanup. With 60+ agents uploading/generating PDFs, this will exhaust process memory. PDFs must be stored on the filesystem with automatic cleanup — they can always be recreated.
Output: Filesystem-based PDF store with configurable TTL and scheduled cleanup. Phase 6 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-integrity-hardening/06-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/main.ts
@archibald-web-app/backend/src/server.ts
@archibald-web-app/backend/src/routes/share.ts

**Current PDF store (in main.ts lines 50-63):**
```ts
function createPdfStore() {
  const store = new Map<string, { buffer: Buffer; originalName: string }>();
  return {
    save: (buffer, originalName, _req) => { store.set(id, { buffer, originalName }); return { id, url }; },
    get: (id) => store.get(id) ?? null,
    delete: (id) => { store.delete(id); },
  };
}
```
- Pure in-memory Map, no TTL, no cleanup, no size cap
- `delete()` exists but is NEVER called anywhere
- PDF serving is unauthenticated (GET /api/share/pdf/:id bypasses JWT)

**PdfStoreLike interface (declared inline in server.ts and share.ts):**
```ts
interface PdfStoreLike {
  save(buffer: Buffer, originalName: string, req: unknown): { id: string; url: string };
  get(id: string): { buffer: Buffer; originalName: string } | null;
  delete(id: string): void;
}
```

**PDF categories (from user context):**
1. Sync PDFs (parsing data extraction): need only seconds, then delete
2. Share PDFs (mail, WhatsApp, Dropbox): keep for reasonable time (hours), then delete — always recreatable

**Bot-generated PDFs (invoice, DDT):**
Separate system — stored as base64 in Redis job results, NOT through pdfStore. Do NOT touch these.

**Constraining decisions:**
- PDFs can always be recreated — no need for long-term persistence
- VPS has limited disk space — TTL cleanup is essential
- Single-process deployment — no distributed storage needed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filesystem-based PdfStore with configurable TTL</name>
  <files>
    archibald-web-app/backend/src/pdf-store.ts,
    archibald-web-app/backend/src/pdf-store.spec.ts,
    archibald-web-app/backend/src/main.ts
  </files>
  <action>
Create a new `pdf-store.ts` module that implements `PdfStoreLike` using filesystem storage:

1. **Storage directory**: Use a configurable base directory (default: `data/pdfs/` relative to project root, or from env `PDF_STORE_DIR`). Create directory on startup if it doesn't exist.

2. **save(buffer, originalName, _req)**:
   - Generate ID: `pdf-${Date.now()}-${crypto.randomBytes(4).toString('hex')}`
   - Write buffer to `{storeDir}/{id}.pdf`
   - Write metadata JSON to `{storeDir}/{id}.meta.json` with: `{ originalName, createdAt: Date.now() }`
   - Return `{ id, url }` (same URL format as current: `${baseUrl}/api/share/pdf/${id}`)

3. **get(id)**:
   - Read `{storeDir}/{id}.pdf` and `{storeDir}/{id}.meta.json`
   - Return `{ buffer, originalName }` or `null` if file doesn't exist
   - Use sync reads (fs.readFileSync) to match the current synchronous-like interface, or refactor to async if PdfStoreLike allows it

4. **delete(id)**:
   - Remove both `{id}.pdf` and `{id}.meta.json`
   - Silently succeed if files don't exist (no error on missing files)

5. **cleanup(maxAgeMs)**:
   - Scan storeDir for `.meta.json` files
   - For each: read `createdAt`, if `Date.now() - createdAt > maxAgeMs`, delete both files
   - Return count of deleted PDFs
   - Log deletions at info level

6. **startCleanupScheduler(intervalMs, maxAgeMs)**:
   - setInterval calling cleanup(maxAgeMs) every intervalMs
   - Default: run every 30 minutes, delete PDFs older than 2 hours
   - Return the interval handle for cleanup in tests/shutdown

Update `main.ts`:
- Replace `createPdfStore()` with the new filesystem-based store
- Call `startCleanupScheduler()` after store creation
- Pass `config.share.baseUrl` for URL generation

Write unit tests in `pdf-store.spec.ts`:
- Test save/get/delete lifecycle
- Test cleanup removes old files
- Test cleanup preserves recent files
- Test get returns null for missing ID
- Use a temp directory (os.tmpdir + random subfolder) for test isolation

Do NOT change the PdfStoreLike interface — the new store must be a drop-in replacement.
Do NOT touch bot-generated PDFs (invoice/DDT via Redis job results).
  </action>
  <verify>
npm test --prefix archibald-web-app/backend -- --run pdf-store
npm run build --prefix archibald-web-app/backend
  </verify>
  <done>
Filesystem PDF store created with save/get/delete/cleanup. Cleanup scheduler runs on configurable interval. Unit tests pass. Build clean. Drop-in replacement for in-memory Map store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate filesystem store and verify end-to-end</name>
  <files>
    archibald-web-app/backend/src/server.ts,
    archibald-web-app/backend/src/routes/share.ts,
    archibald-web-app/backend/src/main.ts
  </files>
  <action>
1. In `server.ts`, consolidate the `PdfStoreLike` interface:
   - The interface is declared inline in both `server.ts` (line ~47) and `share.ts` (line ~15)
   - Export it from `pdf-store.ts` instead and import it in both files
   - Remove duplicate declarations

2. In `main.ts`, ensure the old `createPdfStore()` function is fully replaced:
   - Import the new filesystem store
   - Pass it to createApp() same as before
   - Start the cleanup scheduler with configurable intervals:
     - `PDF_CLEANUP_INTERVAL_MS` env var (default: 30 * 60 * 1000 = 30 min)
     - `PDF_MAX_AGE_MS` env var (default: 2 * 60 * 60 * 1000 = 2 hours)

3. Ensure `share.ts` routes work unchanged:
   - GET /pdf/:id still serves PDFs from the store (now from filesystem)
   - POST /upload-pdf still saves via pdfStore.save (now to filesystem)

4. Handle graceful shutdown: clear the cleanup interval when process exits (if there's existing shutdown handling in main.ts, add it there).

5. Add `.gitignore` entry for `data/pdfs/` if not already ignored.

Run the full backend test suite to confirm no regressions.

Do NOT change the unauthenticated GET /pdf/:id behavior — that's by design (shareable links).
Do NOT add PDF compression or transformation — keep it simple, store raw buffers.
  </action>
  <verify>
npm run build --prefix archibald-web-app/backend
npm test --prefix archibald-web-app/backend
  </verify>
  <done>
Filesystem PDF store integrated. PdfStoreLike interface consolidated (single source). Cleanup scheduler running. data/pdfs/ in .gitignore. All backend tests pass. Build clean. Phase 6 complete.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/backend` passes (all tests)
- [ ] `npm run type-check --prefix archibald-web-app/frontend` passes
- [ ] `npm test --prefix archibald-web-app/frontend` passes (all tests)
- [ ] No in-memory PDF storage remaining
- [ ] Cleanup scheduler configured and running
- [ ] data/pdfs/ directory created and gitignored
</verification>

<success_criteria>

- PDF storage on filesystem, not in memory
- Automatic TTL-based cleanup (default: 2 hours max age, 30 min interval)
- Configurable via environment variables
- PdfStoreLike interface is single source (not duplicated)
- All tests pass (frontend + backend)
- Phase 6 complete — all 4 plans executed
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-integrity-hardening/06-04-SUMMARY.md`

Update `.planning/STATE.md`:
- Phase: 6 of 10
- Status: Phase complete
- Progress: update percentage

Update `.planning/ROADMAP.md`:
- Mark Phase 6 as complete with date
</output>
