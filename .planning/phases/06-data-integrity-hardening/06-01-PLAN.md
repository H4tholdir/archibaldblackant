---
phase: 06-data-integrity-hardening
plan: 01
type: execute
---

<objective>
Fix the critical IVA data flow bug and remove dead order-calculation code.

Purpose: Product VAT data must flow correctly from backend DB to frontend order calculations. Currently, a response shape mismatch causes all product lookups to return null, making VAT fall back to 0% instead of the real per-product rate. Also, three exported calculation functions using hardcoded VAT_RATE=0.22 are dead code (never imported) and should be removed.
Output: Working product VAT data flow + cleaner order-calculations module.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-integrity-hardening/06-CONTEXT.md
@.planning/phases/04-sync-scheduler-auto-sync/04-03-SUMMARY.md

**Key files:**
@archibald-web-app/frontend/src/services/products.service.ts
@archibald-web-app/frontend/src/services/prices.service.ts
@archibald-web-app/frontend/src/utils/order-calculations.ts
@archibald-web-app/frontend/src/utils/order-calculations.spec.ts
@archibald-web-app/frontend/src/services/products.service.spec.ts
@archibald-web-app/backend/src/routes/products.ts

**Critical bug context:**
The backend `GET /api/products` returns `{ success: true, data: ProductRow[] }` — `data` is a flat array.
But `products.service.ts` and `prices.service.ts` both access `data.data?.products` expecting `data` to be `{ products: [...] }`.
Result: `data.data?.products` → `undefined` → `|| []` → every product lookup returns null/empty.
This causes OrderFormSimple to fall back to 0% VAT when adding items (with a warning toast).

**Dead code context:**
Only `calculateShippingCosts` and `roundUp` are imported from `order-calculations.ts` (by OrderFormSimple, PendingOrdersPage, pdf-export.service.ts).
`calculateItemTotals`, `calculateOrderTotals`, `reverseCalculateGlobalDiscount`, and `VAT_RATE` are exported but never imported by any component or service — they are dead code.
`SHIPPING_TAX_RATE = 0.22` inside `calculateShippingCosts` is correct (Italian shipping is always standard 22% rate).

**Constraining decisions:**
- Per-product VAT stored as percentage integer in DB (e.g., 22 = 22%), not decimal
- normalizeVatRate in vat-utils.ts handles validation/snapping to [0, 4, 5, 10, 22]
- OrderFormSimple already calculates per-item VAT correctly via `item.vatRate / 100`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix product API response shape mismatch in frontend services</name>
  <files>
    archibald-web-app/frontend/src/services/products.service.ts,
    archibald-web-app/frontend/src/services/products.service.spec.ts,
    archibald-web-app/frontend/src/services/prices.service.ts
  </files>
  <action>
Fix the response shape mismatch in 4 locations where `data.data?.products || []` should be `data.data || []`:

1. `products.service.ts` line 68 in `searchProducts()`: change `data.data?.products || []` to `data.data || []`
2. `products.service.ts` line 105 in `getProductById()`: change `data.data?.products || []` to `data.data || []`
3. `prices.service.ts` line 14 in `getPriceByArticleId()`: change `data.data?.products || []` to `data.data || []`
4. `prices.service.ts` line 34 in `getPriceAndVat()`: change `data.data?.products || []` to `data.data || []`

Update `products.service.spec.ts` mocks to match the actual backend response shape:
- Mock response should return `{ success: true, data: [...products] }` not `{ success: true, data: { products: [...] } }`
- Verify all existing tests still pass after the fix

Do NOT change the backend response format — the backend is correct. The bug is in the frontend parsing.
Do NOT change OrderFormSimple — it already handles per-product VAT correctly once products.service returns real data.
  </action>
  <verify>
npm test --prefix archibald-web-app/frontend -- --run products.service
npm run type-check --prefix archibald-web-app/frontend
  </verify>
  <done>
All 4 shape mismatches fixed. products.service.spec.ts tests pass with correct mock shape. getProductById returns real product data (including vat field) instead of always null. Type-check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove dead order-calculation functions and hardcoded VAT_RATE</name>
  <files>
    archibald-web-app/frontend/src/utils/order-calculations.ts,
    archibald-web-app/frontend/src/utils/order-calculations.spec.ts,
    archibald-web-app/frontend/src/types/order.ts
  </files>
  <action>
Remove dead code from order-calculations.ts:
1. Remove `export const VAT_RATE = 0.22` constant
2. Remove `calculateItemTotals` function (lines ~21-56)
3. Remove `calculateOrderTotals` function (lines ~93-144)
4. Remove `reverseCalculateGlobalDiscount` function (lines ~149-180)

Keep:
- `calculateShippingCosts` (imported by OrderFormSimple, PendingOrdersPage, pdf-export.service.ts)
- `roundUp` (imported by OrderFormSimple)
- `SHIPPING_TAX_RATE = 0.22` (correct — Italian shipping tax is always standard rate, used inside calculateShippingCosts)

Update order-calculations.spec.ts:
- Remove all test blocks for `calculateItemTotals`, `calculateOrderTotals`, `reverseCalculateGlobalDiscount`
- Remove the `VAT_RATE` import
- Keep tests for `calculateShippingCosts` and `roundUp`
- Keep any property-based tests that test the remaining functions

Update types/order.ts line 16: remove the `// subtotalAfterDiscount × VAT_RATE` comment from the `vat` field since VAT_RATE no longer exists.

Do NOT remove SHIPPING_TAX_RATE — shipping tax in Italy is correctly always 22%.
Do NOT modify OrderFormSimple — it doesn't import the removed functions.
  </action>
  <verify>
npm test --prefix archibald-web-app/frontend -- --run order-calculations
npm run type-check --prefix archibald-web-app/frontend
  </verify>
  <done>
Dead code removed. No component references broken. Remaining tests pass (calculateShippingCosts, roundUp). Type-check clean. No import errors anywhere in frontend.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check --prefix archibald-web-app/frontend` passes
- [ ] `npm test --prefix archibald-web-app/frontend` passes (all tests)
- [ ] No broken imports in frontend codebase
- [ ] products.service.ts correctly parses backend response shape
- [ ] VAT_RATE constant and dead functions no longer exported
</verification>

<success_criteria>

- Product VAT data flows correctly from backend to frontend
- getProductById returns real product data (including vat field)
- getPriceAndVat returns real price and VAT from DB
- Dead order-calculation code removed (calculateItemTotals, calculateOrderTotals, reverseCalculateGlobalDiscount, VAT_RATE)
- All frontend tests pass
- Type-check clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-integrity-hardening/06-01-SUMMARY.md`
</output>
