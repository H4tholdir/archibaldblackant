---
phase: 06-data-integrity-hardening
plan: 03
type: execute
---

<objective>
Add input validation to all route parseInt calls and install rate limiting on expensive routes.

Purpose: With 60+ agents on multiple devices, the system must be robust against malformed input (NaN from parseInt) and excessive request volume on costly operations (bot/Puppeteer, sync, PDF). Currently, 5 route files have unguarded parseInt that passes NaN to DB queries, and zero rate limiting exists.
Output: All route integer params validated with proper 400 responses. Tiered rate limiting on expensive routes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-integrity-hardening/06-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/routes/orders.ts
@archibald-web-app/backend/src/routes/admin.ts
@archibald-web-app/backend/src/routes/warehouse.ts
@archibald-web-app/backend/src/routes/prices.ts
@archibald-web-app/backend/src/server.ts
@archibald-web-app/backend/package.json

**Validation gaps (5 route files, 7 locations):**
| File | Line(s) | Input | Issue |
|------|---------|-------|-------|
| orders.ts | 55-56 | ?limit= / ?offset= | No isNaN check |
| admin.ts | 233 | ?limit= | No isNaN check |
| warehouse.ts | 190 | PUT /items/:id | No isNaN check on itemId |
| warehouse.ts | 205 | DELETE /items/:id | No isNaN check on itemId |
| prices.ts | 83, 95 | ?limit= | No isNaN check |

**Already safe (for reference):**
- widget.ts: has isNaN + range check on year/month
- prices.ts line 68: has isNaN + range check on days
- products.ts line 116: has isNaN + range check on days

**Rate limiting status:**
- Zero middleware exists. No express-rate-limit in package.json.
- Login route, PDF upload, admin endpoints all unprotected.
- Internal slowdownConfig in archibald-bot.ts is Puppeteer automation delay, unrelated.

**Constraining decisions:**
- System serves 60+ agents on multi-devices simultaneously
- Rate limiting is preventive (no current abuse), but needed for robustness
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isNaN validation to all route parseInt calls</name>
  <files>
    archibald-web-app/backend/src/routes/orders.ts,
    archibald-web-app/backend/src/routes/admin.ts,
    archibald-web-app/backend/src/routes/warehouse.ts,
    archibald-web-app/backend/src/routes/prices.ts
  </files>
  <action>
Add isNaN validation after every parseInt call that processes user input from query params or route params. Follow the pattern already established in widget.ts and products.ts:

1. **orders.ts** (lines 55-56): After parsing `limit` and `offset`, add isNaN checks. If NaN, return 400 with descriptive error. Also add reasonable upper bounds (limit max 500, offset >= 0).

2. **admin.ts** (line 233): After parsing `limit`, add isNaN check. If NaN, default to 50 (matching existing `|| '50'` intent). Add upper bound (max 500).

3. **warehouse.ts** (line 190, PUT /items/:id): After `parseInt(req.params.id, 10)`, check isNaN. If NaN, return 400 `{ success: false, error: 'Invalid item ID' }`.

4. **warehouse.ts** (line 205, DELETE /items/:id): Same pattern as PUT — validate itemId is a number before calling deleteItem.

5. **prices.ts** (lines 83 and 95): Both `?limit=` params. Add isNaN check, default to reasonable value (e.g., 100).

Pattern to follow (from widget.ts):
```ts
const limit = parseInt(req.query.limit as string, 10);
if (isNaN(limit) || limit < 1) {
  return res.status(400).json({ success: false, error: 'Invalid limit parameter' });
}
```

Do NOT change routes that already have proper validation (widget.ts, prices.ts days, products.ts days).
Do NOT add validation to internal-only code (services, repositories) — only HTTP boundary.
Always use radix 10 in parseInt calls that don't already specify it.
  </action>
  <verify>
npm run build --prefix archibald-web-app/backend
npm test --prefix archibald-web-app/backend -- --run orders
npm test --prefix archibald-web-app/backend -- --run admin
npm test --prefix archibald-web-app/backend -- --run warehouse
npm test --prefix archibald-web-app/backend -- --run prices
  </verify>
  <done>
All 7 parseInt locations validated with isNaN checks. Invalid input returns 400 with descriptive error. Build passes. Existing route tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install express-rate-limit and configure tiered rate limits</name>
  <files>
    archibald-web-app/backend/package.json,
    archibald-web-app/backend/src/server.ts
  </files>
  <action>
1. Install express-rate-limit:
```bash
npm install --prefix archibald-web-app/backend express-rate-limit
```

2. In server.ts, create tiered rate limiters:

**Global baseline** (generous — most routes are lightweight):
- windowMs: 1 minute
- max: 200 requests per IP per window
- standardHeaders: true, legacyHeaders: false
- message: `{ success: false, error: 'Too many requests, please try again later' }`

**Strict limiter** for expensive routes (bot operations, sync, PDF):
- windowMs: 1 minute
- max: 20 requests per IP per window
- Applied to: `/api/operations`, `/api/sync`, `/api/share/upload-pdf`

**Auth limiter** for login:
- windowMs: 15 minutes
- max: 15 attempts per IP per window
- Applied to: `/api/auth/login`

3. Apply global limiter as middleware in server.ts (after cors, helmet, before routes).
4. Apply strict limiter to specific route groups.
5. Apply auth limiter to login route.

Use `keyGenerator: (req) => req.ip || req.socket.remoteAddress || 'unknown'` for key generation.

Do NOT use distributed store (MemoryStore is fine for single-process VPS deployment).
Do NOT rate limit health check or static asset routes.
Do NOT make rate limits too aggressive — 60+ agents on multi-devices means legitimate high traffic.
  </action>
  <verify>
npm run build --prefix archibald-web-app/backend
npm test --prefix archibald-web-app/backend
  </verify>
  <done>
express-rate-limit installed. Three tiers configured: global (200/min), strict (20/min for bot/sync/PDF), auth (15/15min for login). Build and all tests pass.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/backend` passes (all tests)
- [ ] All parseInt calls in routes have isNaN validation
- [ ] express-rate-limit in package.json dependencies
- [ ] Rate limiting middleware applied in server.ts
</verification>

<success_criteria>

- All route parseInt calls validated — NaN input returns 400
- express-rate-limit installed and configured with 3 tiers
- No regression in existing tests
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-integrity-hardening/06-03-SUMMARY.md`
</output>
