# Phase 3.1 ‚Äî Plan 02: Performance Dashboard & Visualization

## Status: Ready for execution (blocked by 03.1-01)

<objective>
Create HTML performance dashboard with Gantt chart timeline visualization, bottleneck analysis with actionable recommendations, trend comparison charts, and export capabilities (JSON/CSV) for external analysis tools.
</objective>

---

## Context

### What exists (after 03.1-01)
- @archibald-web-app/backend/src/archibald-bot.ts has enhanced profiling with `exportProfilingData()` returning structured JSON
- Operation records include: category, duration, memory, retries, timestamps, gaps
- Percentile statistics (p50, p95, p99) calculated per category
- Basic markdown report with category breakdown

### What we're building
HTML dashboard that visualizes profiling data with:
1. **Gantt chart** showing operation timeline (when each operation started/ended)
2. **Bottleneck analysis** identifying slowest categories with optimization recommendations
3. **Trend charts** comparing multiple profiling runs over time
4. **Interactive filtering** by category, status, duration threshold
5. **Export functionality** (JSON, CSV, HTML) for external tools

### Design goals
- Self-contained HTML file (inline CSS/JS) for easy distribution
- No external dependencies (use vanilla JS + CSS)
- Responsive design (mobile-friendly for viewing on device)
- Fast loading (< 500KB total size)

---

## Tasks

```xml
<tasks>
  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Create new file with `PerformanceDashboardGenerator` class.

      Class structure:
      ```typescript
      import type { ProfilingData } from './types';

      export class PerformanceDashboardGenerator {
        /**
         * Generate HTML dashboard from profiling data
         */
        static generateHTML(
          profilingData: ProfilingData,
          options?: {
            title?: string;
            comparisonData?: ProfilingData[]; // For trend comparison
          }
        ): string {
          // Returns complete HTML string
        }

        /**
         * Export profiling data as CSV
         */
        static exportCSV(profilingData: ProfilingData): string {
          // Returns CSV string
        }

        /**
         * Save dashboard to file
         */
        static async saveDashboard(
          profilingData: ProfilingData,
          outputPath: string,
          options?: { format: 'html' | 'json' | 'csv' }
        ): Promise<void> {
          // Writes to filesystem
        }
      }
      ```

      Implement skeleton with method stubs.
    </action>
    <verification>
      File created with TypeScript class structure.
      Imports compile without errors.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/types.ts</file>
    <action>
      Add `ProfilingData` type to match the structure returned by `exportProfilingData()`:

      ```typescript
      export interface ProfilingData {
        summary: {
          totalOperations: number;
          successful: number;
          failed: number;
          totalDurationMs: number;
          totalGapMs: number;
          averageOperationMs: number;
          peakMemoryBytes: number;
        };
        categories: Record<string, {
          count: number;
          totalDurationMs: number;
          avgDurationMs: number;
          p50Ms: number;
          p95Ms: number;
          p99Ms: number;
          avgMemoryBytes: number;
        }>;
        retries: Array<{
          operationId: number;
          name: string;
          category: string;
          attempts: number;
          finalStatus: "ok" | "error";
        }>;
        operations: Array<{
          id: number;
          name: string;
          status: "ok" | "error";
          category: string;
          startIso: string;
          endIso: string;
          durationMs: number;
          gapMs: number;
          retryAttempt: number;
          memoryBefore: number;
          memoryAfter: number;
          meta: Record<string, unknown>;
          errorMessage?: string;
        }>;
      }
      ```
    </action>
    <verification>
      Type defined in types.ts.
      Can be imported from performance-dashboard-generator.ts.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Implement `exportCSV()` method to generate CSV with columns:
      - Operation ID
      - Name
      - Category
      - Status
      - Duration (ms)
      - Gap (ms)
      - Retry Attempt
      - Memory Before (MB)
      - Memory After (MB)
      - Start Time
      - End Time
      - Error Message

      Use CSV format with proper escaping for commas and quotes.
      Include header row.

      Return CSV string.
    </action>
    <verification>
      Method returns valid CSV string.
      CSV can be opened in Excel/Google Sheets.
      All operations included with proper formatting.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Implement `generateHTML()` method to create self-contained HTML dashboard.

      HTML structure:
      ```html
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>Performance Dashboard - {timestamp}</title>
          <style>
            /* Inline CSS for dashboard styling */
            /* Use CSS Grid for responsive layout */
            /* Include dark mode support (prefers-color-scheme) */
          </style>
        </head>
        <body>
          <header>
            <h1>ü§ñ Archibald Bot Performance Dashboard</h1>
            <p class="timestamp">Generated: {timestamp}</p>
          </header>

          <main>
            <section id="summary">
              <!-- Summary cards: total time, operations, success rate, peak memory -->
            </section>

            <section id="bottlenecks">
              <!-- Bottleneck analysis with recommendations -->
            </section>

            <section id="gantt">
              <!-- Gantt chart timeline visualization -->
            </section>

            <section id="categories">
              <!-- Category breakdown table with percentiles -->
            </section>

            <section id="timeline">
              <!-- Detailed operation timeline table -->
            </section>
          </main>

          <script>
            // Embed profiling data as JSON
            const profilingData = {dataJson};

            // Interactive filtering functions
            // Chart rendering functions
            // Export button handlers
          </script>
        </body>
      </html>
      ```

      Focus on clean, professional design with clear hierarchy.
    </action>
    <verification>
      Method returns complete HTML string.
      HTML validates and renders correctly in browser.
      Profiling data embedded as JSON in script tag.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Implement Gantt chart visualization in the HTML template.

      Use vanilla JavaScript to render SVG Gantt chart showing:
      - X-axis: Timeline from first operation start to last operation end
      - Y-axis: Operation categories (grouped)
      - Bars: Each operation as colored rectangle (green=success, red=error)
      - Tooltip: On hover, show operation name, duration, memory usage

      Chart features:
      - Zoom/pan controls
      - Category filtering
      - Time scale (show seconds or minutes based on duration)
      - Legend showing color mapping

      Use SVG for crisp rendering at any zoom level.
      Keep implementation < 200 lines of JS.
    </action>
    <verification>
      Gantt chart renders in browser.
      All operations visible as bars on timeline.
      Hover tooltips work correctly.
      Zoom/pan controls functional.
      Chart is responsive (adapts to viewport width).
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Implement bottleneck analysis section in HTML template.

      Analyze profiling data to identify bottlenecks:
      1. Rank categories by total duration (descending)
      2. For top 3 slowest categories, generate recommendations:

      **Recommendation logic:**

      - If category is `"form.customer"` and p95 > 20s:
        ‚Üí "Customer selection is slow. Consider: pre-caching common customers, testing direct API access instead of dropdown, reducing wait times between operations."

      - If category is `"form.article"` and p95 > 8s:
        ‚Üí "Article search is slow. Consider: caching recently searched articles, batch searching for multi-article orders, optimizing dropdown search method."

      - If category is `"form.quantity"` or `"form.discount"` and p95 > 8s:
        ‚Üí "Field editing is slow. Consider: testing alternatives to Ctrl+A + Backspace pattern, using JavaScript setValue with event triggers, reducing wait times between keypress."

      - If category is `"login"` and p95 > 20s:
        ‚Üí "Login is slow. Session cache may not be working. Verify cache expiration and cookie persistence."

      - If any category has high p99/p95 ratio (> 2x):
        ‚Üí "High variance detected. Some operations are much slower than others. Investigate network latency, page load times, or element wait timeouts."

      Display as cards with:
      - Category name
      - Current performance (p50, p95, p99)
      - Impact (% of total time)
      - Priority (High/Medium/Low based on impact)
      - Recommended optimizations (bullet list)
    </action>
    <verification>
      Bottleneck analysis section renders in dashboard.
      Top 3 bottlenecks identified correctly.
      Recommendations are actionable and specific.
      Priority levels assigned based on impact.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Add trend comparison support to `generateHTML()` when `comparisonData` is provided.

      If multiple profiling runs are passed, add a "Trends" section showing:
      - Line chart comparing total duration across runs
      - Line chart comparing category durations across runs
      - Percentage improvement/regression indicators
      - Run metadata table (timestamp, total time, success rate)

      Use SVG for charts (no external libraries).
      Support up to 10 comparison runs.
    </action>
    <verification>
      Trend section renders when comparison data provided.
      Line charts show duration trends correctly.
      Percentage changes calculated accurately.
      Supports multiple runs without performance issues.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/performance-dashboard-generator.ts</file>
    <action>
      Implement `saveDashboard()` method to write output to filesystem.

      Support three formats:
      - `'html'`: Call `generateHTML()` and write to file
      - `'json'`: Write `profilingData` as formatted JSON
      - `'csv'`: Call `exportCSV()` and write to file

      Use Node.js `fs.promises.writeFile()`.
      Create parent directories if they don't exist.
      Log success message with file path.
    </action>
    <verification>
      Method creates files in specified formats.
      Parent directories created if missing.
      Files contain correct data.
      No errors on write.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Integrate dashboard generation into ArchibaldBot.

      Add public method `generatePerformanceDashboard()`:
      ```typescript
      public async generatePerformanceDashboard(
        outputDir: string = './profiling-reports'
      ): Promise<{
        htmlPath: string;
        jsonPath: string;
        csvPath: string;
      }> {
        const profilingData = this.exportProfilingData();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const baseName = `profiling-${timestamp}`;

        const generator = new PerformanceDashboardGenerator();

        await generator.saveDashboard(
          profilingData,
          path.join(outputDir, `${baseName}.html`),
          { format: 'html' }
        );

        await generator.saveDashboard(
          profilingData,
          path.join(outputDir, `${baseName}.json`),
          { format: 'json' }
        );

        await generator.saveDashboard(
          profilingData,
          path.join(outputDir, `${baseName}.csv`),
          { format: 'csv' }
        );

        return {
          htmlPath: path.join(outputDir, `${baseName}.html`),
          jsonPath: path.join(outputDir, `${baseName}.json`),
          csvPath: path.join(outputDir, `${baseName}.csv`),
        };
      }
      ```

      Make `exportProfilingData()` public (was private).
    </action>
    <verification>
      Method added to ArchibaldBot.
      TypeScript compilation passes.
      Method callable from external code.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/test-complete-flow.ts</file>
    <action>
      Update test script to generate and save performance dashboard.

      After order creation completes, add:
      ```typescript
      console.log('\nüìä Generating performance dashboard...');
      const paths = await bot.generatePerformanceDashboard('./profiling-reports');
      console.log('‚úÖ Dashboard generated:');
      console.log(`   üìÑ HTML: ${paths.htmlPath}`);
      console.log(`   üìä JSON: ${paths.jsonPath}`);
      console.log(`   üìà CSV: ${paths.csvPath}`);
      console.log(`\nüåê Open HTML dashboard in browser to view results`);
      ```

      Remove the manual JSON export code from 03.1-01 (replaced by dashboard generator).
    </action>
    <verification>
      Test script calls dashboard generation method.
      Files created in profiling-reports/ directory.
      Console output shows file paths.
    </verification>
  </task>

  <task>
    <action>
      Run the test script to verify dashboard generation:

      ```bash
      cd archibald-web-app/backend
      npx tsx src/test-complete-flow.ts
      ```

      Verify:
      - Three files generated (HTML, JSON, CSV)
      - HTML dashboard opens in browser
      - Gantt chart renders correctly
      - Bottleneck analysis shows recommendations
      - All sections populated with data
      - Dashboard is responsive (test on mobile viewport)
    </action>
    <verification>
      Test completes successfully.
      Dashboard files generated in profiling-reports/.
      HTML dashboard opens and renders correctly.
      All visualizations work (Gantt chart, bottleneck cards, tables).
      No JavaScript console errors.
      Responsive design works on mobile viewport.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/.gitignore</file>
    <action>
      Add profiling output directories to .gitignore:
      ```
      # Performance profiling reports
      profiling-reports/
      profiling-output.json
      ```

      Prevent committing large profiling reports to git.
    </action>
    <verification>
      Lines added to .gitignore.
      Git ignores profiling-reports/ directory.
    </verification>
  </task>
</tasks>
```

---

## Success Criteria

- [ ] `PerformanceDashboardGenerator` class created with HTML/JSON/CSV export methods
- [ ] `ProfilingData` type defined in types.ts
- [ ] HTML dashboard generated with all sections (summary, Gantt, bottlenecks, categories, timeline)
- [ ] Gantt chart visualizes operation timeline with hover tooltips
- [ ] Bottleneck analysis identifies top 3 slowest categories with actionable recommendations
- [ ] Trend comparison supported (when multiple profiling runs provided)
- [ ] CSV export contains all operation data in tabular format
- [ ] ArchibaldBot integrated with `generatePerformanceDashboard()` method
- [ ] Test script generates dashboard files successfully
- [ ] HTML dashboard opens in browser with no errors
- [ ] Dashboard is responsive (mobile-friendly)
- [ ] No TypeScript compilation errors

---

## Scope: 3 hours

**Breakdown:**
- Create PerformanceDashboardGenerator class skeleton + types: 15 min
- Implement CSV export: 15 min
- Create HTML template structure with inline CSS: 30 min
- Implement Gantt chart SVG visualization: 45 min
- Implement bottleneck analysis with recommendation logic: 30 min
- Add trend comparison support: 30 min
- Implement saveDashboard() file writing: 15 min
- Integrate with ArchibaldBot and update test script: 15 min
- Test and verify dashboard rendering: 15 min

**Confidence:** Medium-High (straightforward data visualization, no external dependencies, clear requirements)
