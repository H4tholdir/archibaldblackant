# Phase 3.1 — Plan 01: Enhanced Profiling System

## Status: Ready for execution

<objective>
Extend the existing `runOp()` timing system in ArchibaldBot to provide comprehensive performance profiling with hierarchical operation categorization, percentile tracking (p50, p95, p99), retry/failure counting, and memory leak detection.
</objective>

---

## Context

### What exists
- @archibald-web-app/backend/src/archibald-bot.ts implements basic operation timing via `runOp()` (lines 35-89)
- Current tracking: operation ID, name, status (ok/error), start/end timestamps, duration, gap between operations, metadata
- `opRecords` array stores all operation data (line 18-28)
- `buildOperationReport()` generates markdown report with slowest operations and timeline (lines 92-204)

### Current limitations
- No hierarchical categorization of operations (login, navigation, form filling, etc.)
- Only tracks averages, not percentiles (p50, p95, p99)
- No retry attempt tracking (when operations fail and are retried)
- No memory profiling for leak detection
- Report is basic markdown - no structured JSON export for analysis

### Performance baseline from recent tests
- Total order creation: ~82s (with cache) / ~108s (without cache)
- Customer selection: 24.8s (30% of total time) - MAJOR BOTTLENECK
- Article search: 9.1s per article
- Quantity setting: 9.5s
- Discount setting: 9.1s
- Login: 26s (without cache) / 4s (with cache)

---

## What we're building

Enhanced profiling system that extends `runOp()` to provide:

1. **Hierarchical operation categories** (e.g., `login`, `navigation`, `form.customer`, `form.article`, `form.quantity`)
2. **Percentile statistics** (p50, p95, p99) calculated per operation type
3. **Retry tracking** (count attempts, track which operations needed retries)
4. **Memory profiling** (heap usage before/after each operation)
5. **Structured JSON export** in addition to markdown report

---

## Tasks

```xml
<tasks>
  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Extend the `opRecords` array type definition (lines 18-28) to include:
      - `category: string` field for hierarchical categorization (e.g., "login", "navigation.ordini", "form.customer")
      - `retryAttempt: number` field to track retry count (0 for first attempt)
      - `memoryBefore: number` field for heap usage in bytes before operation
      - `memoryAfter: number` field for heap usage in bytes after operation
    </action>
    <verification>
      TypeScript compilation passes with updated opRecords type
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Update the `runOp()` method signature (line 35-39) to accept a `category` parameter:
      ```
      private async runOp<T>(
        name: string,
        fn: () => Promise<T>,
        category: string,
        meta: Record<string, unknown> = {},
      ): Promise<T>
      ```

      Add memory profiling inside `runOp()`:
      - Capture `process.memoryUsage().heapUsed` before executing `fn()`
      - Capture `process.memoryUsage().heapUsed` after executing `fn()`
      - Store both values in the opRecords entry

      Add retry attempt tracking:
      - Check if `meta.retryAttempt` exists, default to 0
      - Store retry attempt in opRecords entry
    </action>
    <verification>
      `runOp()` method captures category, memory usage, and retry attempt.
      TypeScript compilation passes.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Create new private method `calculatePercentiles()` to compute p50, p95, p99:

      ```typescript
      private calculatePercentiles(
        values: number[]
      ): { p50: number; p95: number; p99: number } {
        if (values.length === 0) {
          return { p50: 0, p95: 0, p99: 0 };
        }

        const sorted = [...values].sort((a, b) => a - b);
        const p50Index = Math.floor(sorted.length * 0.50);
        const p95Index = Math.floor(sorted.length * 0.95);
        const p99Index = Math.floor(sorted.length * 0.99);

        return {
          p50: sorted[p50Index],
          p95: sorted[p95Index],
          p99: sorted[p99Index],
        };
      }
      ```

      Add this method after `buildOperationReport()`.
    </action>
    <verification>
      Method correctly calculates percentiles for test arrays.
      TypeScript compilation passes.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Create new private method `buildEnhancedReport()` that generates enhanced markdown report with:

      1. **Summary section** (existing) with added memory stats:
         - Peak memory usage
         - Total memory allocated/deallocated
         - Average memory per operation

      2. **Category breakdown** (new):
         - Group operations by category
         - Show count, total duration, avg duration, p50/p95/p99 per category
         - Show memory usage per category

      3. **Retry analysis** (new):
         - List operations that required retries
         - Show retry counts and success rate

      4. **Slowest operations** (existing - keep as is)

      5. **Longest gaps** (existing - keep as is)

      6. **Errors** (existing - keep as is)

      7. **Detailed timeline** (existing - extend with category and memory columns)

      Format as markdown table similar to existing `buildOperationReport()`.
    </action>
    <verification>
      New report includes all sections with proper markdown formatting.
      TypeScript compilation passes.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Create new private method `exportProfilingData()` that returns structured JSON:

      ```typescript
      private exportProfilingData(): {
        summary: {
          totalOperations: number;
          successful: number;
          failed: number;
          totalDurationMs: number;
          totalGapMs: number;
          averageOperationMs: number;
          peakMemoryBytes: number;
        };
        categories: Record<string, {
          count: number;
          totalDurationMs: number;
          avgDurationMs: number;
          p50Ms: number;
          p95Ms: number;
          p99Ms: number;
          avgMemoryBytes: number;
        }>;
        retries: Array<{
          operationId: number;
          name: string;
          category: string;
          attempts: number;
          finalStatus: "ok" | "error";
        }>;
        operations: typeof this.opRecords;
      }
      ```

      This method processes `opRecords` to generate structured profiling data.
      Add this method after `buildEnhancedReport()`.
    </action>
    <verification>
      Method returns properly structured JSON with all required fields.
      TypeScript compilation passes.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Update all existing `runOp()` calls throughout archibald-bot.ts to include the new `category` parameter.

      Use these category conventions:
      - `"login"` - for login operations
      - `"login.cache"` - for session cache load/save
      - `"navigation.ordini"` - for navigating to orders menu
      - `"navigation.form"` - for navigating to order form
      - `"form.customer"` - for customer selection operations
      - `"form.article"` - for article search operations
      - `"form.quantity"` - for quantity field operations
      - `"form.discount"` - for discount field operations
      - `"form.package"` - for package selection operations
      - `"form.submit"` - for order submission
      - `"form.multi_article"` - for multi-article "New" button clicks

      Search for all instances of `this.runOp(` and add appropriate category.
    </action>
    <verification>
      All `runOp()` calls include category parameter.
      No TypeScript compilation errors.
      Categories follow the hierarchical naming convention.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Replace the `buildOperationReport()` method call with `buildEnhancedReport()` in the public API.

      The report is likely returned/logged somewhere after order creation completes.
      Update to use the new enhanced report.

      Keep the old `buildOperationReport()` method for backwards compatibility if needed elsewhere.
    </action>
    <verification>
      Enhanced report is generated and logged/returned after order creation.
      No compilation errors.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/test-complete-flow.ts</file>
    <action>
      Add JSON export to the test script to verify profiling data structure.

      After order creation completes, call the new `exportProfilingData()` method (via reflection or make it public temporarily) and write to file:

      ```typescript
      const profilingData = (bot as any).exportProfilingData();
      await fs.promises.writeFile(
        path.join(__dirname, '../../profiling-output.json'),
        JSON.stringify(profilingData, null, 2),
        'utf-8'
      );
      console.log('✅ Profiling data exported to profiling-output.json');
      ```
    </action>
    <verification>
      Test script generates profiling-output.json with structured data.
    </verification>
  </task>

  <task>
    <file>archibald-web-app/backend/src/archibald-bot.ts</file>
    <action>
      Add JSDoc comments to the new methods:
      - `calculatePercentiles()`
      - `buildEnhancedReport()`
      - `exportProfilingData()`

      Document the purpose, parameters, and return values.
      Include examples of category naming conventions in the JSDoc.
    </action>
    <verification>
      JSDoc comments added to all new methods.
      Comments are clear and follow existing style in the file.
    </verification>
  </task>

  <task>
    <action>
      Run the test script to verify enhanced profiling:

      ```bash
      cd archibald-web-app/backend
      npx tsx src/test-complete-flow.ts
      ```

      Verify output includes:
      - Enhanced markdown report with category breakdown
      - Percentile statistics (p50, p95, p99) per category
      - Memory profiling data
      - JSON file (profiling-output.json) with structured data
    </action>
    <verification>
      Test completes successfully.
      Enhanced report shows category breakdown with percentiles.
      Memory profiling data is captured.
      JSON export contains all expected fields.
      No runtime errors.
    </verification>
  </task>
</tasks>
```

---

## Success Criteria

- [ ] `runOp()` extended with category, memory profiling, and retry tracking
- [ ] Percentile calculation method (`calculatePercentiles()`) implemented
- [ ] Enhanced markdown report includes category breakdown, percentiles, memory stats, retry analysis
- [ ] Structured JSON export method (`exportProfilingData()`) implemented
- [ ] All existing `runOp()` calls updated with category parameter
- [ ] Test script generates enhanced report and JSON export successfully
- [ ] No TypeScript compilation errors
- [ ] No runtime errors during test execution

---

## Scope: 1.5 hours

**Breakdown:**
- Extend `runOp()` and opRecords type: 20 min
- Implement `calculatePercentiles()`: 15 min
- Implement `buildEnhancedReport()` with category breakdown: 30 min
- Implement `exportProfilingData()` JSON export: 20 min
- Update all `runOp()` call sites with categories: 15 min
- Update test script and verify output: 10 min

**Confidence:** Medium (existing profiling infrastructure simplifies extension, but category assignment requires careful review of all operations)
