# Phase 3.1 — Plan 03: Optimization Plan Documentation

## Status: Ready for execution (blocked by 03.1-01, 03.1-02)

<objective>
Analyze profiling data from real order creation runs to document a comprehensive, data-driven optimization plan with specific targets, effort estimates, expected impact, implementation complexity, and ROI-based prioritization. Define Service Level Objectives (SLOs) for order creation performance.
</objective>

---

## Context

### What exists (after 03.1-01, 03.1-02)
- @archibald-web-app/backend/src/archibald-bot.ts has comprehensive profiling with category breakdown and percentiles
- Performance dashboard generates HTML reports with bottleneck analysis
- Current baseline metrics from recent tests (documented in Phase 3.1 README)
- Automated recommendations for top bottlenecks

### Current performance baseline
- Total order creation: ~82s (with cache) / ~108s (without cache)
- Customer selection: 24.8s (30% of total time) - MAJOR BOTTLENECK
- Article search: 9.1s per article
- Quantity setting: 9.5s
- Discount setting: 9.1s
- Login: 26s (without cache) / 4s (with cache)

### What we're building
Structured optimization plan document that:
1. Identifies all optimization opportunities from profiling data
2. Estimates effort (hours) and expected impact (% improvement) for each
3. Assigns implementation complexity (Low/Medium/High)
4. Calculates ROI (impact / effort) to prioritize optimizations
5. Defines SLO targets (e.g., "P95 order creation < 60s")
6. Creates step-by-step implementation roadmap ordered by priority

---

## Tasks

```xml
<tasks>
  <task>
    <action>
      Run the profiling test script 3 times to gather consistent baseline data:

      ```bash
      cd archibald-web-app/backend
      npx tsx src/test-complete-flow.ts
      # Wait for completion, then run again
      npx tsx src/test-complete-flow.ts
      # Wait for completion, then run again
      npx tsx src/test-complete-flow.ts
      ```

      This will generate 3 profiling reports in profiling-reports/ directory.
      We need multiple runs to identify variance and ensure recommendations are stable.
    </action>
    <verification>
      Three profiling reports generated successfully.
      All three runs completed without errors.
      Reports show similar performance patterns (not outliers).
    </verification>
  </task>

  <task>
    <action>
      Analyze the three profiling reports to extract consistent baseline metrics.

      Open each HTML dashboard and record:
      - Total order creation time (average of 3 runs)
      - Category breakdown (p50, p95, p99 for each category, averaged)
      - Bottleneck recommendations (consistent across runs)
      - Memory usage patterns
      - Retry rates (if any operations failed and retried)

      Create summary spreadsheet or document with consolidated metrics.
    </action>
    <verification>
      Baseline metrics documented with averages from 3 runs.
      Variance calculated (standard deviation) for each metric.
      Clear picture of consistent bottlenecks vs. outliers.
    </verification>
  </task>

  <task>
    <file>.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md</file>
    <action>
      Create comprehensive optimization plan document.

      Structure:
      ```markdown
      # Archibald Bot Optimization Plan

      **Created**: 2026-01-12
      **Baseline**: ~82s order creation (with cache), ~108s (without cache)
      **Target SLO**: < 60s P95 order creation time (with cache)

      ## Executive Summary

      [Overview of findings, total potential improvement, recommended priority order]

      ## Baseline Performance

      ### Current Metrics (Average of 3 runs)

      | Metric | Value | Notes |
      |--------|-------|-------|
      | Total order time (cached) | {avg}s ± {stddev}s | With session cache |
      | Total order time (cold) | {avg}s ± {stddev}s | Without cache |
      | Customer selection (p95) | {avg}s | Largest bottleneck |
      | Article search (p95) | {avg}s | Per article |
      | ... | ... | ... |

      ### Operation Category Breakdown

      [Table with all categories, counts, durations, percentiles]

      ## Optimization Opportunities

      ### OPT-01: Optimize Customer Selection [HIGH PRIORITY]

      **Current Performance:**
      - P50: {value}s
      - P95: {value}s
      - P99: {value}s
      - Proportion of total: ~30%

      **Target Performance:**
      - P50: 8s (-67%)
      - P95: 12s (-52%)
      - P99: 15s (-40%)

      **Estimated Effort:** 8 hours

      **Expected Impact:** -13s total order time (-16%)

      **Implementation Complexity:** Medium

      **ROI Score:** 1.63s per hour (High)

      **Proposed Optimizations:**
      1. Test direct customer ID submission (bypass dropdown search)
         - Check if Archibald API accepts direct customer ID in form POST
         - If yes, eliminate dropdown interaction entirely
         - Estimated impact: -15s (60% faster)

      2. Reduce wait times between operations
         - Current: conservative 1000ms waits
         - Test: adaptive wait based on element state
         - Estimated impact: -3s (12% faster)

      3. Pre-load customer list in background
         - Cache frequently used customers
         - Predictive pre-loading based on order history
         - Estimated impact: -6s (24% faster)

      **Implementation Steps:**
      1. Investigate Archibald form POST request structure
      2. Test direct customer ID submission
      3. Implement adaptive wait logic
      4. Add customer cache with LRU eviction

      **Dependencies:** None

      **Risks:** Low (can fallback to current dropdown method)

      ---

      ### OPT-02: Cache Article Search Results [MEDIUM PRIORITY]

      [Same structure as OPT-01]

      ---

      [Continue for each optimization opportunity...]

      ## Service Level Objectives (SLOs)

      ### Target Performance (with cache)

      | Metric | Current P95 | Target P95 | Gap |
      |--------|-------------|------------|-----|
      | Total order creation | 82s | 60s | -22s |
      | Customer selection | 24.8s | 12s | -12.8s |
      | Article search | 9.1s | 5s | -4.1s |
      | Form field editing | 9.5s | 5s | -4.5s |
      | Login (cached) | 4s | 3s | -1s |

      ### Reliability SLOs

      - Order creation success rate: > 99.5%
      - Operation retry rate: < 1%
      - Memory leak rate: 0 (no unbounded growth)

      ## Implementation Roadmap

      ### Phase 1: Quick Wins (Week 1)
      - OPT-03: Reduce field edit wait times (2 hours, -4.5s impact)
      - OPT-05: Optimize login cache TTL (1 hour, -2s impact)
      - Total impact: -6.5s (8% improvement)

      ### Phase 2: Major Optimizations (Week 2-3)
      - OPT-01: Optimize customer selection (8 hours, -13s impact)
      - OPT-02: Cache article search (6 hours, -4s impact)
      - Total impact: -17s (21% improvement)

      ### Phase 3: Advanced Optimizations (Week 4+)
      - OPT-04: Parallel article processing (12 hours, -8s impact)
      - OPT-06: Network latency optimization (4 hours, -3s impact)
      - Total impact: -11s (13% improvement)

      ### Cumulative Impact

      | Phase | Optimizations | Est. Effort | Total Impact | Order Time (P95) |
      |-------|---------------|-------------|--------------|------------------|
      | Baseline | - | - | - | 82s |
      | Phase 1 | 2 | 3h | -6.5s (8%) | 75.5s |
      | Phase 2 | 2 | 14h | -17s (21%) | 58.5s |
      | Phase 3 | 2 | 16h | -11s (13%) | 47.5s |
      | **Total** | **6** | **33h** | **-34.5s (42%)** | **47.5s** |

      **Note:** Impacts are additive but conservative estimates. Actual improvements may be higher.

      ## Monitoring & Validation

      After each optimization:
      1. Run profiling test 3 times to measure impact
      2. Compare against baseline metrics
      3. Update this document with actual vs. expected improvement
      4. Generate trend dashboard comparing before/after

      ## Open Questions

      - Can Archibald form accept direct customer/article IDs?
      - What is the network latency to Archibald server?
      - Are there rate limits on Archibald API calls?
      - Can multiple form fields be set in parallel?

      ## References

      - Baseline profiling reports: `profiling-reports/profiling-2026-01-12T*.html`
      - Phase 3.1 README: `.planning/phases/03.1-bot-performance-profiling-optimization/README.md`
      - ArchibaldBot implementation: `archibald-web-app/backend/src/archibald-bot.ts`
      ```

      Fill in the template with actual values from the baseline metrics analysis.
      Create optimization opportunities for all major bottlenecks identified.
    </action>
    <verification>
      OPTIMIZATION-PLAN.md created with complete structure.
      All optimization opportunities documented with effort/impact/ROI.
      Roadmap prioritized by ROI score.
      SLO targets defined.
      Baseline metrics populated from profiling reports.
    </verification>
  </task>

  <task>
    <file>.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md</file>
    <action>
      Identify and document at least 6 optimization opportunities covering:

      **OPT-01: Customer Selection Optimization**
      - Test direct customer ID submission (bypass dropdown)
      - Reduce wait times between operations
      - Pre-load customer cache

      **OPT-02: Article Search Caching**
      - Cache recently searched articles (LRU cache, 100 entries)
      - Pre-fetch common articles on bot init
      - Batch search for multi-article orders

      **OPT-03: Field Edit Optimization**
      - Test alternatives to Ctrl+A + Backspace (Triple-click + type, JavaScript setValue)
      - Reduce keypress delays (current 50ms → 20ms)
      - Adaptive wait based on field state instead of fixed delays

      **OPT-04: Parallel Article Processing**
      - Process article form fields in parallel where possible
      - Pre-calculate package selection while user searches
      - Overlap navigation with data fetching

      **OPT-05: Login Cache Enhancement**
      - Extend cache TTL from 24h to 48h (with validity check)
      - Implement cookie refresh without full login
      - Add session keepalive during idle periods

      **OPT-06: Network Latency Optimization**
      - Measure actual network latency to Archibald
      - Implement request pipelining where safe
      - Reduce screenshot frequency (only on errors)
      - Use faster selectors (ID > class > XPath)

      For each optimization, include:
      - Current vs. target performance
      - Estimated effort (hours)
      - Expected impact (seconds saved, % improvement)
      - Implementation complexity (Low/Medium/High)
      - ROI score (impact / effort)
      - Proposed implementation steps
      - Dependencies on other optimizations
      - Risks and mitigation strategies
    </action>
    <verification>
      All 6+ optimizations documented in detail.
      Each has effort estimate, impact estimate, and ROI.
      Implementation steps are specific and actionable.
      Risks identified for each optimization.
    </verification>
  </task>

  <task>
    <file>.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md</file>
    <action>
      Calculate ROI scores for all optimizations and create prioritized roadmap.

      ROI calculation:
      ```
      ROI = Expected Impact (seconds) / Estimated Effort (hours)
      ```

      Sort optimizations by ROI (descending) to create priority order.

      Group into phases:
      - **Phase 1 (Quick Wins)**: ROI > 1.0, complexity = Low
      - **Phase 2 (Major Impact)**: ROI > 0.5, complexity = Medium
      - **Phase 3 (Long-term)**: All remaining optimizations

      Create cumulative impact table showing progressive improvement.
    </action>
    <verification>
      ROI scores calculated for all optimizations.
      Optimizations grouped into 3 phases by ROI and complexity.
      Cumulative impact table shows path to target SLO.
      Roadmap is realistic and achievable.
    </verification>
  </task>

  <task>
    <file>.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md</file>
    <action>
      Define Service Level Objectives (SLOs) for order creation performance.

      SLOs should cover:
      1. **Order creation time**:
         - P50 target: 45s (with cache)
         - P95 target: 60s (with cache)
         - P99 target: 75s (with cache)

      2. **Category-specific targets**:
         - Customer selection P95: < 12s
         - Article search P95: < 5s per article
         - Field editing P95: < 5s per field
         - Login (cached) P95: < 3s

      3. **Reliability targets**:
         - Success rate: > 99.5%
         - Retry rate: < 1%
         - Memory stability: No leaks (< 10MB growth per order)

      Justify targets based on:
      - Current baseline metrics
      - Identified optimization potential
      - Business requirements (agent usage patterns)
      - Technical constraints (Archibald server response times)

      Include measurement methodology:
      - How to measure compliance (profiling reports)
      - Frequency of measurement (per release, monthly)
      - Alerting thresholds (when to investigate)
    </action>
    <verification>
      SLO targets defined for all key metrics.
      Targets are ambitious but achievable (based on optimization plan).
      Measurement methodology documented.
      Business justification provided for each target.
    </verification>
  </task>

  <task>
    <file>.planning/phases/03.1-bot-performance-profiling-optimization/BASELINE-METRICS.json</file>
    <action>
      Save the consolidated baseline metrics as JSON for future comparison.

      Structure:
      ```json
      {
        "timestamp": "2026-01-12T...",
        "runs": 3,
        "summary": {
          "totalOrderTimeMs": {
            "mean": 82000,
            "stddev": 1200,
            "p50": 81500,
            "p95": 84000,
            "p99": 85000
          },
          "successRate": 1.0,
          "retryRate": 0.0
        },
        "categories": {
          "form.customer": {
            "count": 1,
            "totalDurationMs": 24800,
            "avgDurationMs": 24800,
            "p50": 24500,
            "p95": 24800,
            "p99": 25000
          },
          ...
        },
        "profilingReportPaths": [
          "profiling-reports/profiling-2026-01-12T14-30-00.html",
          "profiling-reports/profiling-2026-01-12T14-35-00.html",
          "profiling-reports/profiling-2026-01-12T14-40-00.html"
        ]
      }
      ```

      This baseline file will be used for trend comparison after optimizations are implemented.
    </action>
    <verification>
      BASELINE-METRICS.json created with consolidated data.
      JSON is valid and well-formatted.
      All key metrics included.
      Profiling report paths reference actual generated files.
    </verification>
  </task>

  <task>
    <file>.planning/STATE.md</file>
    <action>
      Update STATE.md to reflect Phase 3.1 completion preparation.

      Update the "Roadmap Evolution" section to add:
      ```markdown
      - **2026-01-12**: Phase 3.1 planning completed
        - **Baseline established**: 3 profiling runs averaging 82s order creation
        - **Bottlenecks quantified**: Customer selection (30%), article search (11%), field editing (12%)
        - **Optimization plan**: 6 optimizations identified, 42% improvement potential (-34.5s)
        - **SLO targets defined**: P95 < 60s order creation (vs. current 82s)
        - **Next**: Execute optimization roadmap in Phases 1-3
      ```
    </action>
    <verification>
      STATE.md updated with Phase 3.1 summary.
      Key findings documented for future reference.
    </verification>
  </task>

  <task>
    <file>.planning/ROADMAP.md</file>
    <action>
      Update ROADMAP.md Phase 3.1 section to mark as complete and add results summary.

      Update line 75-105 Phase 3.1 section to add at the end:
      ```markdown
      **Results (2026-01-12)**:
      - Profiling system implemented with category tracking and percentiles
      - Performance dashboard with Gantt charts and bottleneck analysis
      - Optimization plan documented: 6 optimizations, 42% improvement potential
      - SLO targets: P95 < 60s (vs. current 82s baseline)
      - Major bottlenecks: Customer selection (24.8s), article search (9.1s), field editing (9.5s)
      ```

      Update Progress table to mark Phase 3.1 as complete:
      ```markdown
      | 3.1. Bot Performance Profiling & Optimization (INSERTED) | 3/3 | ✅ Complete | 2026-01-12 |
      ```
    </action>
    <verification>
      ROADMAP.md updated with Phase 3.1 results.
      Progress table shows completion.
      Results summary documents key findings.
    </verification>
  </task>

  <task>
    <action>
      Create summary output for user review.

      Generate console output showing:
      - Baseline metrics summary
      - Top 3 bottlenecks with current performance
      - Top 3 optimizations by ROI with expected impact
      - Path to SLO target (phases and cumulative improvement)
      - Next steps (begin Phase 1 quick wins)

      Format as clear, readable text output.
    </action>
    <verification>
      Summary output generated showing key findings.
      Output is clear and actionable.
      User can easily understand optimization priorities.
    </verification>
  </task>
</tasks>
```

---

## Success Criteria

- [ ] Baseline metrics established from 3 profiling test runs
- [ ] Variance calculated (standard deviation) for key metrics
- [ ] Optimization plan document (OPTIMIZATION-PLAN.md) created with 6+ opportunities
- [ ] Each optimization includes: current/target performance, effort, impact, complexity, ROI
- [ ] ROI-based prioritization complete with 3-phase roadmap
- [ ] SLO targets defined for order creation time and key categories
- [ ] Baseline metrics saved as JSON for future comparison
- [ ] STATE.md and ROADMAP.md updated with Phase 3.1 completion
- [ ] Clear path to target SLO (< 60s P95) documented
- [ ] Implementation steps are specific and actionable

---

## Scope: 2 hours

**Breakdown:**
- Run 3 profiling tests and analyze reports: 30 min
- Extract baseline metrics and calculate statistics: 20 min
- Document 6 optimization opportunities with effort/impact: 40 min
- Calculate ROI and create prioritized roadmap: 15 min
- Define SLO targets and measurement methodology: 15 min
- Save baseline metrics JSON and update STATE/ROADMAP: 10 min

**Confidence:** High (data analysis and documentation task, no code implementation)

**Note:** This plan assumes profiling system (03.1-01) and dashboard (03.1-02) are already complete and working.
