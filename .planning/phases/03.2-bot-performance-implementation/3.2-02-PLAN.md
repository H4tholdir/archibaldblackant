---
phase: 03.2-bot-performance-implementation
type: execute
---

<objective>
Complete quick wins: Login cache enhancement (OPT-05) and fix missing profiling category parameters (BUG-FIX).

Purpose: Improve cached login performance by -0.8s and fix profiling data gaps to ensure accurate performance tracking.
Output: Enhanced session management with extended TTL and optimized cache restore, all profiling operations correctly categorized.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md
@archibald-web-app/backend/src/archibald-bot.ts
@archibald-web-app/backend/data/archibald-session.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Missing Profiling Category Parameters (BUG-FIX)</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Bug discovered in Phase 3.1**: 5 operations missing category parameter in runOp() calls, preventing proper profiling categorization.

**Locations to fix** (from OPTIMIZATION-PLAN.md):
- Line 2290: Add category parameter
- Line 2362: Add category parameter
- Line 2380: Add category parameter
- Line 2591: Add category parameter
- Line 2640: Add category parameter

**Implementation**:
1. Read archibald-bot.ts and locate these 5 runOp() calls
2. Identify the operation type for each call from surrounding context
3. Add appropriate category parameter to each call:
   - Navigation operations: 'navigation'
   - Field editing: 'field-editing'
   - Customer/article selection: 'customer-selection' or 'article-search'
   - Form submission: 'form-submission'
4. Verify all runOp() calls now have category parameter (search for `runOp(` without category)
5. Update profiling to capture these operations correctly

**What to avoid and WHY**:
- Don't add generic 'other' category - be specific to enable targeted optimization
- Don't skip verification - missing categories prevent accurate bottleneck identification
- Don't change operation names - maintain consistency with existing profiling reports
  </action>
  <verify>
1. Search for runOp calls without category: `cd archibald-web-app/backend && grep -n "runOp(" src/archibald-bot.ts | grep -v "category:"`
2. Verify no results (all calls have category parameter)
3. Run profiling once to confirm operations are categorized: `npx tsx src/test-complete-flow.ts`
4. Check dashboard to confirm all operations show in category breakdown
  </verify>
  <done>
- All 5 missing category parameters added
- All runOp() calls include category parameter
- Profiling dashboard shows complete category breakdown
- No "uncategorized" operations in profiling reports
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimize Login Cache & Session Management (OPT-05)</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts, archibald-web-app/backend/.cache/session.json</files>
  <action>
**Current performance**: Cached login 2.3s, cold login 29.1s, cache hit rate ~67%

**Target**: Cached login 1.5s (-35%), cache hit rate 90%+

**Implementation**:

1. **Extend Cache TTL** (currently 24h):
   - Update session cache TTL to 48 hours
   - Add session validity check before using cached session
   - Implement lightweight ping to Archibald to verify session is still valid
   - If invalid, trigger fresh login and update cache

2. **Optimize Cache Restore**:
   - Current: Load cookies + navigate to homepage (2.3s)
   - Proposed: Direct navigation to "Ordini" menu (skip homepage redirect)
   - Modify restoreSession() to navigate directly to target page
   - Estimated impact: -0.8s (35% faster)

3. **Session Keepalive** (optional enhancement):
   - Add periodic background request during idle (every 30 min)
   - Prevents session expiration between orders
   - Implement as optional feature (can be enabled for high-volume usage)
   - Estimated impact: +5% cache hit rate

4. **Parallel Cookie Loading**:
   - Current: Sequential (launch browser → load cookies)
   - Proposed: Load cookie data from file while browser launches
   - Apply cookies immediately after page context created
   - Estimated impact: -0.5s (22% faster)

**What to avoid and WHY**:
- Don't extend TTL beyond 48h without validity check - stale sessions cause failed orders
- Don't skip homepage entirely if Archibald requires it for session initialization
- Don't implement aggressive keepalive (< 15 min interval) - may impact server performance
- Don't cache credentials in memory - only session tokens, for security

**Testing approach**:
1. Test with expired cache (force cold login)
2. Test with valid cache (restore should be faster)
3. Test with 48h old cache (validity check should work)
4. Run 10 consecutive profiling runs to measure cache hit rate improvement
  </action>
  <verify>
1. Run 10 consecutive profiling tests: `for i in {1..10}; do npx tsx src/test-complete-flow.ts; done`
2. Check first run (cold login) vs subsequent runs (cached login)
3. Verify cached login ≤ 1.8s P95 (target: 1.5s ±20%)
4. Calculate cache hit rate: (runs with cached login / total runs) - should be ≥ 80%
5. Check that 48h old cache triggers validity check and re-login if needed
  </verify>
  <done>
- Session cache TTL extended to 48 hours
- Session validity check implemented (ping before use)
- Cache restore optimized with direct navigation (skip homepage)
- Parallel cookie loading implemented
- Cached login time ≤ 1.8s P95 (vs 2.3s baseline, -0.5s minimum)
- Cache hit rate ≥ 80% (vs 67% baseline)
- Optional keepalive feature available (can be enabled)
- All tests pass (npm test)
  </done>
</task>

<task type="auto">
  <name>Task 3: Final Profiling Validation & Phase 1 Summary</name>
  <files>.planning/phases/03.2-bot-performance-implementation/3.2-02-SUMMARY.md, .planning/STATE.md</files>
  <action>
**Phase 1 completion validation**:

1. **Run comprehensive profiling**:
   - 10 consecutive runs to measure cache hit rate
   - Document P50/P95/P99 for all operations
   - Compare against baseline (81.5s P95)
   - Expected Phase 1 total: ~73s P95 (-8.5s from baseline)

2. **Cumulative impact calculation**:
   - Plan 3.2-01: -7.5s (field editing + multi-article button)
   - Plan 3.2-02: -1.0s (login cache optimization)
   - Phase 1 total: -8.5s (-10% improvement)
   - Validate actual within ±20% of expected

3. **Document Phase 1 completion**:
   - Create comprehensive 3.2-02-SUMMARY.md
   - Update .planning/STATE.md with Phase 1 metrics
   - Document all 4 optimizations completed (OPT-03, OPT-04, OPT-05, BUG-FIX)
   - Record actual vs expected impact for each optimization
   - Note any surprises or learnings

4. **Prepare for Phase 2**:
   - Confirm baseline for Phase 2: ~73s P95
   - Phase 2 target: 56s P95 (additional -17s)
   - Next optimizations: OPT-01 (customer selection) and OPT-02 (article caching)
  </action>
  <verify>
1. Check 10 profiling runs completed successfully
2. Verify cumulative improvement documented in SUMMARY
3. Confirm STATE.md updated with Phase 3.2 progress
4. Verify actual improvement within expected range: -8.5s ±1.7s
  </verify>
  <done>
- 10 profiling runs completed and analyzed
- Phase 1 cumulative improvement documented: -8.5s ±1.7s
- SUMMARY.md documents all optimizations and actual impact
- STATE.md updated with Phase 3.2 Plan 01-02 completion
- Baseline established for Phase 2: ~73s P95
- All profiling categories working correctly (bug fix validated)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `cd archibald-web-app/backend && npm test`
- [ ] All runOp() calls have category parameter (grep verification)
- [ ] Cached login time ≤ 1.8s P95 (vs 2.3s baseline)
- [ ] Cache hit rate ≥ 80% over 10 runs (vs 67% baseline)
- [ ] Phase 1 total improvement: -8.5s ±1.7s (73s P95 vs 81.5s baseline)
- [ ] SUMMARY.md documents actual vs expected for all optimizations
- [ ] STATE.md updated with Phase 1 completion metrics
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Bug fix: All profiling operations correctly categorized
- Login cache optimization: -0.8s to -1.2s achieved (cached login)
- Cache hit rate improvement: 67% → 80%+ achieved
- Phase 1 total: -8.5s ±1.7s (10% improvement, 73s P95)
- Documentation complete and accurate
- Ready for Phase 2 (Major Optimizations)
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-bot-performance-implementation/3.2-02-SUMMARY.md`:

# Phase 3.2 Plan 02: Quick Wins Part 2 Summary

**Phase 1 complete: -8.5s total improvement via quick wins and bug fixes**

## Phase 1 Accomplishments (Plans 01-02)

### Plan 01 (Quick Wins Part 1):
- Field editing: 9.5s → ~5s (-47%)
- Multi-article button: 7.0s → ~4s (-43%)
- Subtotal: -7.5s

### Plan 02 (Quick Wins Part 2):
- Cached login: 2.3s → ~1.5s (-35%)
- Cache hit rate: 67% → 80%+
- Profiling bug fix: 5 operations now categorized
- Subtotal: -1.0s

### Phase 1 Total:
- Baseline: 81.5s P95
- After Phase 1: ~73s P95
- Improvement: -8.5s (-10%)
- Target achieved: ✅ (expected -8.5s)

## Files Modified

- `archibald-web-app/backend/src/archibald-bot.ts` - Bug fixes + login cache optimization

## Key Techniques

- Extended cache TTL with validity check (48h)
- Direct navigation to target page (skip homepage)
- Parallel cookie loading during browser launch
- Session validity ping before cache use
- All profiling operations now categorized

## Actual vs Expected Impact

[Document real numbers across 10 profiling runs]

## Cache Hit Rate Analysis

[Document cache hit rate over 10 consecutive runs]

## Next Step

Ready for Phase 3.2 Plan 03 (Major Optimization: Customer Selection - OPT-01)
Target: Additional -13s improvement (73s → 60s)
</output>
