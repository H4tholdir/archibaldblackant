---
phase: 03.2-bot-performance-implementation
type: execute
---

<objective>
Implement quick wins for bot performance: Field editing optimization (OPT-03) and multi-article "New" button optimization (OPT-04).

Purpose: Achieve immediate -7.5s improvement (-9% total) with low-complexity, high-ROI optimizations that reduce field editing latency and button click overhead.
Output: Optimized field editing using JavaScript setValue, event-driven multi-article button waiting, profiling validation showing ~73s P95 baseline improvement.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md
@.planning/phases/03.1-bot-performance-profiling-optimization/BASELINE-METRICS.json
@archibald-web-app/backend/src/archibald-bot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Optimize Field Editing (OPT-03)</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Current bottleneck**: Quantity field editing takes 9.5s (11.7%), discount field 9.1s. Currently uses keyboard simulation (type, clear, type again).

**Implementation**:
1. Locate field editing operations in setItemQuantity() and setItemDiscount() methods
2. Replace keyboard simulation with JavaScript setValue approach:
   - Use page.evaluate() to set input.value directly
   - Trigger 'change' and 'input' events to notify DevExpress
   - Example: `await page.evaluate((selector, value) => { const el = document.querySelector(selector); el.value = value; el.dispatchEvent(new Event('change', {bubbles: true})); el.dispatchEvent(new Event('input', {bubbles: true})); }, selector, newValue);`
3. Test BOTH approaches with profiling to confirm JavaScript is faster
4. Reduce post-edit wait times from current values to 500ms (just enough for DevExpress to process)
5. Update runOp() calls with 'field-editing' category for profiling tracking

**What to avoid and WHY**:
- Don't remove keyboard simulation entirely - keep as fallback if JavaScript approach fails
- Don't skip event dispatching - DevExpress needs change/input events to update internal state
- Don't reduce wait times below 300ms - DevExpress needs time to validate and update grid state
- Don't edit quantity and discount fields in parallel yet - focus on single-field optimization first

**Testing**:
- Run profiling 3x before changes (baseline)
- Run profiling 3x after changes (validation)
- Confirm quantity field editing reduced from 9.5s → ~5s (target: -47%)
  </action>
  <verify>
1. Run profiling: `cd archibald-web-app/backend && npx tsx src/test-complete-flow.ts`
2. Generate dashboard: Automatic HTML report created in profiling-reports/
3. Check field editing times in dashboard (Gantt chart + Operations table)
4. Confirm P95 field editing < 6s (target: 5s ±20%)
  </verify>
  <done>
- Field editing operations use JavaScript setValue with event dispatching
- Post-edit wait times optimized (500ms or less)
- Profiling shows quantity field editing ≤ 6s P95 (vs 9.5s baseline)
- Fallback to keyboard simulation on JavaScript failure
- All existing tests pass (npm test)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Optimized field editing with JavaScript setValue approach</what-built>
  <how-to-verify>
1. Review profiling dashboard HTML report in archibald-web-app/backend/profiling-reports/
2. Check Gantt chart for "Set Quantity" and "Set Discount" operations - should show shorter bars
3. Verify Operations table shows field editing operations < 6s P95
4. Confirm overall order time reduced by ~4-5s from previous baseline
5. Check console output for any "JavaScript setValue failed, falling back" messages
  </how-to-verify>
  <resume-signal>Type "approved" to continue with Task 2, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Optimize Multi-Article "New" Button (OPT-04)</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Current bottleneck**: Multi-article "New" button click takes 7.0s (8.6% of total). Currently uses fixed wait times after clicking button.

**Implementation**:
1. Locate multi-article "New" button click in createOrder() method (multi-item loop)
2. Replace fixed wait with event-driven waiting:
   - After clicking "New" button, wait for grid row insertion event
   - Use page.waitForFunction() to detect new row in DevExpress grid
   - Example: `await page.waitForFunction(() => document.querySelectorAll('.dx-data-row').length > previousRowCount, {timeout: 5000})`
3. Cache button selector to avoid re-querying DOM each iteration
4. Overlap operations where safe: Start next article search while grid stabilizes (if possible)
5. Reduce wait time from current value to event-based (estimated 4s target)
6. Update runOp() calls with 'multi-article-navigation' category

**What to avoid and WHY**:
- Don't remove timeout entirely - event may not fire reliably, need fallback
- Don't check row count immediately after click - DevExpress needs time to insert row (~100-200ms)
- Don't overlap operations that modify grid state - race conditions will break order creation
- Don't cache selectors aggressively if DevExpress regenerates IDs - use text-based selectors as documented in .planning/archibald-ui-selectors.md

**Testing**:
- Create multi-article test order (2-3 articles)
- Run profiling with multi-article order
- Confirm "New" button operation reduced from 7.0s → ~4s (target: -43%)
  </action>
  <verify>
1. Run profiling with multi-article test: `cd archibald-web-app/backend && npx tsx src/test-complete-flow.ts` (modify fixtures to include 2+ articles)
2. Check profiling dashboard for "Multi-article New Button" or similar operations
3. Verify operation time < 5s P95 (target: 4s ±20%)
4. Confirm no "waitForFunction timeout" errors in console
5. Verify multi-article orders create successfully (all articles present in Archibald)
  </verify>
  <done>
- Multi-article "New" button uses event-driven waiting (grid row insertion detection)
- Button selector cached for performance
- Operation time reduced to ≤ 5s P95 (vs 7.0s baseline)
- Fallback timeout prevents infinite waits
- Multi-article orders tested and working
- All existing tests pass (npm test)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Optimized multi-article navigation with event-driven waiting</what-built>
  <how-to-verify>
1. Review latest profiling dashboard (after multi-article test run)
2. Check that multi-article "New" button operations show reduced time (~4s vs 7s)
3. Verify overall order time further reduced (cumulative with Task 1)
4. Compare before/after dashboards to see cumulative improvement
5. Expected total improvement: -7.5s (9.5s → 5s field editing, 7.0s → 4s button)
  </how-to-verify>
  <resume-signal>Type "approved" to complete plan, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Final Profiling Validation & Documentation</name>
  <files>archibald-web-app/backend/profiling-reports/, .planning/phases/03.2-bot-performance-implementation/3.2-01-SUMMARY.md</files>
  <action>
**Final validation**:
1. Run 3 consecutive profiling runs: `npx tsx src/test-complete-flow.ts` (run 3x)
2. Generate performance dashboard for all 3 runs
3. Calculate average P95 order time across 3 runs
4. Compare against baseline (81.5s) - expect ~73-74s (-8.5s to -7.5s improvement)
5. Document actual vs expected impact in SUMMARY.md

**Metrics to capture**:
- Baseline: 81.5s P95 order time
- Field editing: 9.5s → ~5s (expected)
- Multi-article button: 7.0s → ~4s (expected)
- Total order time: 81.5s → ~73s (expected)
- Actual improvements: [document real numbers]

**What to document**:
- Exact performance gains achieved
- Any deviations from expected impact (±20% is acceptable)
- Techniques that worked best (JavaScript setValue, event-driven waiting)
- Any fallback scenarios triggered
- Recommendations for next optimization phase
  </action>
  <verify>
1. Check that 3 profiling runs completed successfully
2. Verify all 3 HTML dashboards generated in profiling-reports/
3. Confirm SUMMARY.md exists and documents actual improvements
4. Verify actual improvements within ±20% of expected (-7.5s ±1.5s)
  </verify>
  <done>
- 3 profiling runs completed and documented
- Performance dashboards show consistent improvements
- SUMMARY.md documents actual vs expected impact
- Actual improvement: -7.5s ±1.5s (target: -7.5s)
- Recommendations for Phase 3.2 Plan 02 documented
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `cd archibald-web-app/backend && npm test`
- [ ] Type checking passes: `cd archibald-web-app/backend && npm run typecheck` (if available)
- [ ] Field editing operations ≤ 6s P95 (vs 9.5s baseline)
- [ ] Multi-article button operations ≤ 5s P95 (vs 7.0s baseline)
- [ ] Overall order time ~73s P95 (vs 81.5s baseline, -8.5s improvement)
- [ ] 3 profiling runs documented in SUMMARY.md with actual metrics
- [ ] No new errors or warnings introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Field editing optimization: -4.5s ±0.9s achieved
- Multi-article button optimization: -3s ±0.6s achieved
- Total improvement: -7.5s ±1.5s (target: 73s P95)
- Profiling infrastructure validates improvements
- No regressions in order creation functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-bot-performance-implementation/3.2-01-SUMMARY.md`:

# Phase 3.2 Plan 01: Quick Wins Part 1 Summary

**Quick wins achieved: -7.5s order time improvement via field editing and button optimizations**

## Accomplishments

- Field editing optimized from 9.5s → ~5s using JavaScript setValue (-47%)
- Multi-article "New" button optimized from 7.0s → ~4s using event-driven waiting (-43%)
- Total order time reduced from 81.5s → ~73s P95 (-10% improvement)
- Profiling validates improvements across 3 consecutive runs

## Files Modified

- `archibald-web-app/backend/src/archibald-bot.ts` - Optimized field editing and button operations

## Key Techniques

- JavaScript setValue with event dispatching for DevExpress compatibility
- Event-driven waiting for grid row insertion (replaces fixed delays)
- Selector caching for reduced DOM queries
- Fallback mechanisms for reliability

## Actual vs Expected Impact

[Document real numbers here]

## Next Step

Ready for Phase 3.2 Plan 02 (Quick Wins Part 2: Login cache + bug fixes)
</output>
