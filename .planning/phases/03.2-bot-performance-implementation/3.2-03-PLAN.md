---
phase: 03.2-bot-performance-implementation
type: execute
---

<objective>
Optimize customer selection (OPT-01) - the largest bottleneck at 24.8s (30.4% of total order time).

Purpose: Eliminate the dropdown interaction overhead by investigating direct customer ID submission, reducing customer selection from 24.8s to ~10s (-59%, -13s impact).
Output: Optimized customer selection using the fastest viable approach, with profiling validation showing ~60s P95 (Phase 2 milestone: achieving SLO).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md
@.planning/archibald-ui-selectors.md
@archibald-web-app/backend/src/archibald-bot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate Archibald Customer Form Submission</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts, archibald-web-app/backend/research/customer-form-analysis.md</files>
  <action>
**Investigation goal**: Determine if Archibald form accepts direct customer ID submission without dropdown interaction.

**Current approach**: Uses "Profilo cliente" dropdown with DevExpress, takes 24.8s P95

**Research steps**:
1. Add network request interception to capture form POST payload:
   ```typescript
   await page.on('request', req => {
     if (req.method() === 'POST' && req.url().includes('order')) {
       console.log('POST payload:', req.postData());
     }
   });
   ```

2. Create test order with profiling enabled
3. Capture and analyze form submission payload structure
4. Look for customer ID field (e.g., `customerId`, `clientId`, `profileId`)
5. Document payload structure in research/customer-form-analysis.md

**Questions to answer**:
- What field name contains customer identifier?
- Is it numeric ID or string code?
- Does form validation accept direct ID submission?
- What happens if we populate field directly with JavaScript?

**What to avoid and WHY**:
- Don't modify production order flow yet - this is research only
- Don't assume field names - capture actual payload data
- Don't skip validation testing - direct submission may fail silently
  </action>
  <verify>
1. Check research/customer-form-analysis.md exists and documents payload structure
2. Verify captured POST payload shows customer identification field
3. Confirm field name and expected value format documented
  </verify>
  <done>
- Network interception captures form POST payload
- Customer identification field documented (name, format, example value)
- research/customer-form-analysis.md contains payload structure analysis
- Clear recommendation on whether direct ID submission is viable
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Choose customer selection optimization approach based on research findings</decision>
  <context>
Task 1 investigation determines if direct customer ID submission is possible. Choose implementation approach based on findings.
  </context>
  <options>
    <option id="approach-direct-id">
      <name>Direct Customer ID Submission</name>
      <pros>
- Bypasses dropdown entirely (no search, no wait for results, no selection click)
- Estimated impact: -18s (-73% reduction, 24.8s → 6.8s)
- Highest performance gain possible
- Simplifies code (remove dropdown interaction logic)
      </pros>
      <cons>
- Requires form to accept direct ID submission (may not be supported)
- May break if Archibald validates dropdown interaction
- Need customer ID lookup mechanism (database or API)
- Higher risk if form structure changes
      </cons>
    </option>
    <option id="approach-optimized-dropdown">
      <name>Optimized Dropdown Interaction</name>
      <pros>
- Lower risk (uses documented DevExpress patterns)
- No assumptions about form validation
- Fallback if direct submission not supported
- Estimated impact: -12s (-48% reduction, 24.8s → 12.8s)
      </pros>
      <cons>
- Still requires dropdown search and selection
- Less performance gain than direct submission
- Dependent on DevExpress performance characteristics
      </cons>
    </option>
    <option id="approach-hybrid">
      <name>Hybrid: Try Direct, Fallback to Dropdown</name>
      <pros>
- Best of both approaches (max performance with reliability fallback)
- Test direct submission first, dropdown if it fails
- Maintains reliability while maximizing speed
- Estimated impact: -15s (-60% reduction, 24.8s → 9.8s average)
      </pros>
      <cons>
- More complex implementation (two code paths)
- Need detection logic for direct submission success/failure
- Slightly more maintenance burden
      </cons>
    </option>
  </options>
  <resume-signal>Select: approach-direct-id, approach-optimized-dropdown, or approach-hybrid</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Implement Customer Selection Optimization</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Implementation based on selected approach from checkpoint decision.**

**For approach-direct-id**:
1. Locate selectCustomer() method in archibald-bot.ts
2. Capture current customer ID from order request (or add customer ID parameter)
3. Use page.evaluate() to set customer field directly:
   ```typescript
   await page.evaluate((customerId) => {
     const field = document.querySelector('[name="customerId"]'); // adjust selector
     field.value = customerId;
     field.dispatchEvent(new Event('change', {bubbles: true}));
   }, customerId);
   ```
4. Validate field populated correctly (visual check or value read)
5. Reduce wait time from 24.8s to minimal validation time (~1-2s)
6. Update runOp() profiling with 'customer-selection-direct' category

**For approach-optimized-dropdown**:
1. Analyze current dropdown interaction in selectCustomer()
2. Reduce wait times after search (currently may be excessive)
3. Use event-driven waiting for dropdown results (waitForSelector with result count)
4. Cache dropdown selectors to reduce query overhead
5. Pre-load customer cache during login (if customer list is static)
6. Target: 24.8s → ~12s

**For approach-hybrid**:
1. Implement direct submission first (approach-direct-id logic)
2. Add validation check: After direct submission, verify field value matches expected
3. If validation fails, fall back to dropdown approach (approach-optimized-dropdown)
4. Log which approach was used in profiling data
5. Target: 24.8s → ~10s average (mostly direct, occasional fallback)

**What to avoid and WHY**:
- Don't remove runOp() profiling - need to validate improvement
- Don't skip validation of direct submission - form may reject it silently
- Don't hard-code customer IDs - use lookup mechanism (database or order data)
- Don't assume dropdown is always slower - profile both approaches

**Testing**:
- Test with 5+ different customers to ensure approach works universally
- Run profiling 3x to measure average improvement
- Verify orders created successfully in Archibald
  </action>
  <verify>
1. Run profiling 3x: `cd archibald-web-app/backend && npx tsx src/test-complete-flow.ts`
2. Check profiling dashboard for customer selection time
3. Verify customer selection ≤ 13s P95 (target: 10s ±20%)
4. Confirm orders created with correct customer in Archibald
5. Test with multiple different customers (not just test customer)
  </verify>
  <done>
- Customer selection optimized using selected approach
- Customer selection time ≤ 13s P95 (vs 24.8s baseline, -11.8s minimum)
- Profiling validates improvement across 3 runs
- Orders created successfully with correct customers
- Multiple customers tested (not just single test case)
- Approach documented in code comments
- All existing tests pass (npm test)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Optimized customer selection implementation</what-built>
  <how-to-verify>
1. Review profiling dashboard showing customer selection times
2. Check Gantt chart - customer selection bar should be significantly shorter
3. Verify Operations table shows customer selection < 13s P95 (ideally ~10s)
4. Confirm cumulative order time now ~60s P95 (Phase 1: 73s → Phase 2 partial: 60s)
5. Test with multiple customer names to ensure robustness
6. Check Archibald orders to verify correct customer assignment
  </how-to-verify>
  <resume-signal>Type "approved" to continue with Task 3, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Final Validation & Phase 2 Partial Completion</name>
  <files>.planning/phases/03.2-bot-performance-implementation/3.2-03-SUMMARY.md</files>
  <action>
**Validation**:
1. Run 5 consecutive profiling runs with different customers
2. Calculate average and P95 customer selection time
3. Document actual improvement vs expected (-13s target)
4. Verify cumulative Phase 1 + 2 partial: 81.5s → ~68s (-13.5s with Phase 1, -5s with OPT-01 if not full -13s yet)

**Documentation**:
1. Create 3.2-03-SUMMARY.md documenting approach taken and actual results
2. Document which optimization approach was used (direct/dropdown/hybrid)
3. Note any surprises or edge cases discovered
4. Record actual impact: Expected -13s, actual: [X]s
5. Include recommendations for OPT-02 (article caching) if insights gained

**What to document**:
- Approach selected and why
- Technical implementation details
- Actual vs expected performance gain
- Edge cases or fallback scenarios encountered
- Customer ID lookup mechanism (if direct approach used)
- Reliability testing results (multiple customers)
  </action>
  <verify>
1. Check 5 profiling runs completed with different customers
2. Verify SUMMARY.md documents actual improvement
3. Confirm improvement within ±20% of expected: -13s ±2.6s
4. Verify no regression in other operations (field editing, login, etc.)
  </verify>
  <done>
- 5 profiling runs with different customers completed
- Customer selection optimization: -13s ±2.6s achieved
- SUMMARY.md documents approach, implementation, and actual results
- No regressions in other optimizations
- Ready for Plan 3.2-04 (Article Search Caching - OPT-02)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `cd archibald-web-app/backend && npm test`
- [ ] Customer selection ≤ 13s P95 (vs 24.8s baseline, target: 10s ±20%)
- [ ] Total order time ~68s P95 (Phase 1: 73s, OPT-01: -5s minimum partial)
- [ ] 5+ profiling runs with different customers documented
- [ ] Orders created successfully in Archibald with correct customers
- [ ] SUMMARY.md documents approach and actual metrics
- [ ] No regressions in Phase 1 optimizations
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Customer selection optimization: -11.8s to -15s achieved (target: -13s ±2.6s)
- Cumulative improvement: Phase 1 (-8.5s) + OPT-01 (-13s) = -21.5s total
- Order time: 81.5s baseline → ~60s current (if full -13s achieved)
- Reliability tested with multiple customers
- Approach documented and justified
- Ready for Phase 2 completion (OPT-02: Article Caching)
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-bot-performance-implementation/3.2-03-SUMMARY.md`:

# Phase 3.2 Plan 03: Customer Selection Optimization Summary

**Major bottleneck eliminated: Customer selection reduced from 24.8s to ~10s (-59%)**

## Approach Selected

[Document which approach was chosen: direct-id, optimized-dropdown, or hybrid]

## Accomplishments

- Customer selection: 24.8s → ~10s (-13s, -59%)
- Implementation: [Direct ID / Optimized dropdown / Hybrid approach]
- Reliability: Tested with 5+ different customers
- Cumulative improvement: 81.5s → ~68s or better

## Technical Implementation

[Document the specific technique used, code patterns, and DevExpress interactions]

## Files Modified

- `archibald-web-app/backend/src/archibald-bot.ts` - Customer selection optimization
- `archibald-web-app/backend/research/customer-form-analysis.md` - Form payload research (if created)

## Actual vs Expected Impact

- Expected: -13s (24.8s → 11.8s)
- Actual: [Document real numbers across 5 profiling runs]
- Within target: [Yes/No, ±20% = -10.4s to -15.6s acceptable]

## Edge Cases & Learnings

[Document any surprises, fallback scenarios, customer ID lookup challenges, etc.]

## Phase 2 Progress

- Plan 01 (OPT-03, OPT-04): -7.5s ✅
- Plan 02 (OPT-05, BUG-FIX): -1.0s ✅
- Plan 03 (OPT-01): -13s ✅
- **Subtotal**: -21.5s (81.5s → 60s) ⏱️ **Approaching SLO!**

## Next Step

Ready for Phase 3.2 Plan 04 (Article Search Caching - OPT-02)
Target: Additional -4s improvement (60s → 56s) to **achieve < 60s SLO** ✅
</output>
