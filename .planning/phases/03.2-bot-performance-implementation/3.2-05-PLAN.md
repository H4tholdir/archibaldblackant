---
phase: 03.2-bot-performance-implementation
type: execute
---

<objective>
Implement network and request optimizations (OPT-06) to reduce I/O overhead and improve selector performance.

Purpose: Measure and optimize network latency, reduce screenshot frequency, optimize selector strategy, and explore request pipelining for -5s improvement.
Output: Network timing instrumentation, optimized debugging overhead, faster selectors, profiling validation showing ~51s P95.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md
@archibald-web-app/backend/src/archibald-bot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Network Timing Instrumentation</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Goal**: Separate network time from processing time in profiling to identify high-latency endpoints.

**Current state**: Total operation time measured, but network vs processing time not distinguished.

**Implementation**:

1. **Add network timing to runOp()**:
   ```typescript
   interface OperationMetrics {
     // ... existing fields
     networkTime?: number; // Time spent waiting for network requests
     processingTime?: number; // Time spent in browser/DOM operations
   }
   ```

2. **Intercept network requests**:
   - Use page.on('request') and page.on('response') to track request timing
   - Measure time from request start to response complete
   - Accumulate network time for each operation
   - Store in operation metrics

3. **Enhance profiling dashboard**:
   - Add network time column to operations table
   - Show network time as percentage of total operation time
   - Highlight operations with >50% network time (optimization candidates)
   - Add network time to Gantt chart (stacked bar: network vs processing)

4. **Measure baseline**:
   - Run profiling to capture current network characteristics
   - Identify slowest network requests (endpoints, payload sizes)
   - Document typical network time per operation type

**What to avoid and WHY**:
- Don't block operations for network tracking - use async listeners
- Don't track every micro-request - focus on significant requests (> 100ms)
- Don't modify request headers/payload - purely observational
- Don't assume network time can be eliminated - identify optimization opportunities only

**Testing**:
- Run profiling and verify network time captured
- Check dashboard shows network vs processing breakdown
- Identify which operations are network-bound
  </action>
  <verify>
1. Run profiling: `cd archibald-web-app/backend && npx tsx src/test-complete-flow.ts`
2. Check profiling dashboard shows network time breakdown
3. Verify operations table has network time column with data
4. Identify 2-3 operations with highest network time percentage
5. Document findings in research notes
  </verify>
  <done>
- Network timing instrumentation added to runOp()
- Request/response listeners capture network latency
- Profiling dashboard enhanced with network time visualization
- Baseline network characteristics documented
- High-latency operations identified
- All tests pass (npm test)
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimize Debugging Overhead & Selectors</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Optimization 1: Reduce Screenshot Frequency**

Current: Screenshots captured on many operations (debugging overhead)
Target: Only on errors and retries

Implementation:
1. Locate screenshot capture calls (likely page.screenshot())
2. Add conditional logic: Only capture if operation fails or is retried
3. Keep screenshots for critical checkpoints (login, form submission)
4. Estimated impact: -2s (-2.5% overall)

**Optimization 2: Optimize Selector Strategy**

Current: Mix of XPath, class selectors, ID selectors
Target: Prefer ID > class > XPath (performance order)

Implementation:
1. Audit all selectors in archibald-bot.ts (search for waitForSelector, querySelector, $, $$)
2. Identify slow selectors (XPath, complex CSS)
3. Convert to faster patterns where possible:
   - XPath `//div[@class='foo']` → CSS `.foo`
   - Complex CSS → ID selector if available
4. Pre-cache frequently used selectors (store selector strings as constants)
5. Reference .planning/archibald-ui-selectors.md for documented DevExpress patterns
6. Estimated impact: -1s (-1.2% overall)

**Optimization 3: Pre-cache Selector Results** (where safe)

- Cache selectors that don't change during session (menu buttons, form structure)
- Don't cache dynamic content (dropdown results, form field values)
- Store selector results in bot instance variables
- Reduces repeated DOM queries

**What to avoid and WHY**:
- Don't remove ALL screenshots - keep for critical errors (need debugging info)
- Don't cache selectors that DevExpress regenerates - use text-based selectors instead
- Don't optimize selectors that are already fast (< 10ms) - not worth maintenance burden
- Don't use generic selectors (div, span) - too broad, unreliable

**Testing**:
- Run profiling before and after
- Verify screenshot count reduced significantly (check profiling output logs)
- Confirm selectors still reliable (no timeout errors)
  </action>
  <verify>
1. Run profiling 3x: `npx tsx src/test-complete-flow.ts`
2. Compare screenshot count: Before vs After (check logs or profiling output)
3. Verify no selector timeout errors
4. Check operation times improved by ~3s total (screenshots + selectors)
5. Confirm orders still created successfully
  </verify>
  <done>
- Screenshot frequency reduced (only errors and critical checkpoints)
- Selectors optimized: XPath → CSS, complex → simple where possible
- Selector constants defined for frequently used patterns
- Profiling shows ~3s improvement from debugging/selector optimization
- No increase in selector timeout errors
- All tests pass (npm test)
  </done>
</task>

<task type="auto">
  <name>Task 3: Request Pipelining Investigation & Final Validation</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts, .planning/phases/03.2-bot-performance-implementation/3.2-05-SUMMARY.md</files>
  <action>
**Request Pipelining (Advanced)**:

Goal: Send next request before previous completes (where safe)

**Investigation**:
1. Review network timing data from Task 1
2. Identify safe points for pipelining:
   - Read operations only (no state modification)
   - Example: Start loading next form section while submitting current
   - Example: Pre-fetch dropdown data while previous field validates
3. Assess risk vs reward:
   - Potential: -2s improvement
   - Risk: Race conditions, state inconsistency
   - Complexity: Requires careful state management

**Decision point**: Implement only if:
- Network time is significant (> 15s total from Task 1 findings)
- Safe pipelining opportunities identified (read-only operations)
- State management can be validated without excessive complexity

**If implementing**:
- Start with single pipelining opportunity (lowest risk)
- Add state validation checks
- Test thoroughly with profiling
- Document pipelining points in code

**If deferring**:
- Document why (insufficient network time, high risk, complexity)
- Note as future optimization opportunity
- Focus on validating gains from Tasks 1-2

**Final Validation**:
1. Run 5 consecutive profiling tests
2. Calculate cumulative impact: Screenshots (-2s) + Selectors (-1s) + Pipelining (0-2s)
3. Expected total: -3s to -5s improvement
4. Document actual vs expected in SUMMARY
5. Verify no regressions in reliability

**What to document**:
- Network timing analysis results
- Screenshot reduction impact
- Selector optimization impact
- Pipelining decision (implement or defer) and rationale
- Total OPT-06 impact: Expected -5s, actual: [X]s
  </action>
  <verify>
1. Check 5 profiling runs completed
2. Verify total improvement ~5s ±1s from baseline before this plan
3. Confirm network timing dashboard provides useful insights
4. Verify SUMMARY.md documents actual impact and decisions
5. Check no regression in order success rate
  </verify>
  <done>
- Network timing provides visibility into latency bottlenecks
- Screenshot optimization: -2s ±0.4s achieved
- Selector optimization: -1s ±0.2s achieved
- Pipelining decision documented (implemented or deferred with rationale)
- Total OPT-06 impact: -5s ±1s (target met)
- SUMMARY.md documents all findings and decisions
- 5 profiling runs validate improvements
- Order time: ~56s → ~51s P95
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `cd archibald-web-app/backend && npm test`
- [ ] Network timing instrumentation working (dashboard shows network time)
- [ ] Screenshot frequency reduced (check logs for count reduction)
- [ ] Selectors optimized (no timeout errors)
- [ ] Total improvement: -5s ±1s (56s → 51s P95)
- [ ] SUMMARY.md documents network analysis and optimization decisions
- [ ] No regressions in order creation reliability
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Network timing instrumentation provides actionable insights
- Debugging overhead reduced: -2s ±0.4s
- Selector optimization: -1s ±0.2s
- Pipelining: 0-2s (implemented or deferred with rationale)
- Total OPT-06 impact: -5s ±1s
- Order time: ~51s P95 (cumulative: -30s from 81.5s baseline, -37%)
- Profiling dashboard enhanced with network visibility
- Ready for Phase 3 final plan (OPT-07: Parallel Article Processing)
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-bot-performance-implementation/3.2-05-SUMMARY.md`:

# Phase 3.2 Plan 05: Network & Request Optimization Summary

**Network visibility achieved + debugging overhead eliminated: -5s improvement**

## Accomplishments

- Network timing instrumentation: Visibility into network vs processing time
- Screenshot optimization: Only on errors/critical points (-2s, -2.5%)
- Selector optimization: XPath → CSS, pre-cached constants (-1s, -1.2%)
- Request pipelining: [Implemented/Deferred - document decision and impact]
- Total OPT-06 impact: -5s (-6% improvement)

## Files Modified

- `archibald-web-app/backend/src/archibald-bot.ts` - Network timing + optimizations

## Network Analysis Findings

[Document network time breakdown from Task 1]:
- Total network time: [X]s per order
- High-latency operations: [List top 3]
- Network-bound vs processing-bound: [Breakdown]

## Optimization Impact

| Optimization | Expected | Actual | Status |
|--------------|----------|--------|--------|
| Screenshot reduction | -2s | [X]s | ✅/⚠️ |
| Selector optimization | -1s | [X]s | ✅/⚠️ |
| Request pipelining | -2s | [X]s | ✅/⚠️/➖ |
| **Total OPT-06** | **-5s** | **[X]s** | **±20%** |

## Request Pipelining Decision

[Document whether pipelining was implemented or deferred]:
- **If implemented**: Which operations pipelined, safety validation, measured impact
- **If deferred**: Why (risk, complexity, insufficient benefit), future opportunity

## Cumulative Progress

| Phase | Plans | Impact | Order Time (P95) |
|-------|-------|--------|------------------|
| Baseline | - | - | 81.5s |
| Phase 1 | 01-02 | -8.5s | 73s |
| Phase 2 | 03-04 | -17s | 56s ✅ SLO |
| Phase 3 (partial) | 05 | -5s | **51s** |
| **Total** | **5 plans** | **-30.5s (-37%)** | **51s** |

## Next Step

Ready for Phase 3.2 Plan 06 (OPT-07: Parallel Article Processing)
Target: Additional -8s improvement (51s → 43s) for multi-article orders
Final Phase 3 target: 49s P95 (-40% from baseline)
</output>
