---
phase: 03.2-bot-performance-implementation
type: execute
---

<objective>
Implement article search caching (OPT-02) to reduce repeated article lookups from 9.1s to ~5s.

Purpose: Eliminate redundant article searches across multiple orders by implementing LRU cache with 24h TTL, achieving -4s improvement and crossing the < 60s SLO threshold.
Output: Article search cache with persistence, pre-fetch mechanism for top articles, profiling validation showing ~56s P95 (SLO achieved âœ…).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md
@archibald-web-app/backend/src/archibald-bot.ts
@archibald-web-app/backend/src/product-db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Article Search LRU Cache</name>
  <files>archibald-web-app/backend/src/article-cache.ts, archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Current performance**: Article search takes 9.1s P95 per article, no caching (repeated searches identical cost)

**Target**: 5s cached (-45%), 8s uncached (-12%)

**Implementation**:

1. **Create ArticleCache class** (new file: src/article-cache.ts):
   ```typescript
   interface ArticleCacheEntry {
     variantId: string;
     articleName: string;
     searchResult: any; // DevExpress dropdown result data
     timestamp: number;
   }

   class ArticleCache {
     private cache: Map<string, ArticleCacheEntry>;
     private maxSize = 100; // LRU limit
     private ttl = 24 * 60 * 60 * 1000; // 24 hours

     constructor() {
       this.cache = new Map();
       this.loadFromDisk(); // Persist across sessions
     }

     get(variantId: string): ArticleCacheEntry | null;
     set(variantId: string, entry: ArticleCacheEntry): void;
     evictExpired(): void;
     loadFromDisk(): void;
     saveToDisk(): void;
   }
   ```

2. **Integrate cache into ArchibaldBot**:
   - Add articleCache instance to bot
   - Modify searchArticle() method to check cache first
   - On cache hit: Use cached result, skip dropdown search (-45% time)
   - On cache miss: Perform search, store in cache for next time
   - Update runOp() with 'article-search-cached' vs 'article-search-uncached' categories

3. **Persistence mechanism**:
   - Save cache to `.cache/article-cache.json` after each update
   - Load cache on bot initialization
   - Evict expired entries on load (TTL > 24h)

4. **LRU eviction**:
   - When cache size > 100, remove least recently used entry
   - Update access timestamp on cache hit (for LRU tracking)

**What to avoid and WHY**:
- Don't cache indefinitely - articles may change (price, availability) - use 24h TTL
- Don't cache if search failed - only cache successful results
- Don't skip article search validation - cache may be stale, verify result exists
- Don't use in-memory only cache - persist to disk for cross-session benefit
- Don't cache dropdown UI state - only cache article identification data (variant ID, name)

**Testing**:
- First order: Article search uncached (~9s)
- Second order (same article): Article search cached (~5s expected)
- Verify cache persists across bot restarts
  </action>
  <verify>
1. Run profiling 3x with SAME article: `npx tsx src/test-complete-flow.ts`
2. Check first run: article search ~9s (uncached)
3. Check runs 2-3: article search ~5s (cached, -45%)
4. Verify .cache/article-cache.json exists and contains cached entries
5. Restart bot and verify cache loaded (check logs or cache hit on first search)
  </verify>
  <done>
- ArticleCache class implemented with LRU eviction and TTL
- Cache integrated into article search flow
- Cache persistence to .cache/article-cache.json working
- Cached searches â‰¤ 6s P95 (target: 5s Â±20%)
- Uncached searches â‰¤ 9s P95 (minimal overhead from cache check)
- Cache survives bot restarts
- All tests pass (npm test)
  </done>
</task>

<task type="auto">
  <name>Task 2: Pre-fetch Top Articles & Optimize Cache Warming</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts, archibald-web-app/backend/src/product-db.ts</files>
  <action>
**Enhancement**: Pre-fetch frequently used articles during login to maximize cache hits.

**Implementation**:

1. **Identify top articles**:
   - Query ProductDatabase for articles with highest order frequency
   - Use existing getProducts() and filter/sort by usage patterns
   - Alternative: Hard-code top 20 most common articles (simpler, faster)
   - Example: TD1272 (Thunnus), TD1274 (Albacore), etc.

2. **Background cache warming** (optional, during idle):
   - After login completes, trigger background article searches for top 20 articles
   - Run searches in background without blocking order creation
   - Populate cache proactively before first order
   - Estimated impact: +30-40% cache hit rate for typical orders

3. **Optimize article search wait times**:
   - Current: May have excessive wait after dropdown search
   - Use event-driven waiting for search results (waitForSelector on dropdown results)
   - Reduce wait time from current to minimal validation (~500ms)
   - Applies to both cached and uncached paths

4. **Cache analytics**:
   - Track cache hit rate in profiling data
   - Log cache size and eviction count
   - Document which articles are most frequently cached
   - Use data to validate LRU size (100) and TTL (24h) are appropriate

**What to avoid and WHY**:
- Don't pre-fetch ALL articles - too slow, defeats purpose (only top 20)
- Don't block order creation for pre-fetch - run in background/async
- Don't pre-fetch during high-load periods - may impact server performance
- Don't hard-code article list without fallback - use database query if possible

**Testing**:
- Test with top 20 articles after cache warming
- Expect high cache hit rate (70-80%+)
- Verify pre-fetch doesn't delay order creation
  </action>
  <verify>
1. Run profiling 5x with typical articles (top 20 if available)
2. Calculate cache hit rate: (cached searches / total searches)
3. Verify cache hit rate â‰¥ 70% (vs 0% baseline without cache)
4. Check that pre-fetch (if implemented) completes in background
5. Confirm order creation not delayed by pre-fetch
  </verify>
  <done>
- Top articles identified and documented
- Pre-fetch mechanism implemented (background warming)
- Article search wait times optimized (event-driven)
- Cache hit rate â‰¥ 70% over 5 typical orders
- Cache analytics tracking hit/miss rates
- Pre-fetch doesn't block order creation
- All tests pass (npm test)
  </done>
</task>

<task type="auto">
  <name>Task 3: Phase 2 Completion Validation & SLO Achievement</name>
  <files>.planning/phases/03.2-bot-performance-implementation/3.2-04-SUMMARY.md, .planning/STATE.md</files>
  <action>
**Phase 2 completion - achieving < 60s SLO target**:

1. **Comprehensive profiling**:
   - Run 10 consecutive profiling tests with variety of articles
   - Calculate P50/P95/P99 across all runs
   - Expected: ~56s P95 (Phase 1: 73s, OPT-01: -13s, OPT-02: -4s)
   - Target SLO: P95 < 60s âœ…

2. **Cumulative impact validation**:
   - Phase 1 (Plans 01-02): -8.5s (81.5s â†’ 73s)
   - OPT-01 Customer Selection (Plan 03): -13s (73s â†’ 60s)
   - OPT-02 Article Caching (Plan 04): -4s (60s â†’ 56s)
   - **Total Phase 1+2**: -25.5s (-31% improvement)
   - **SLO Status**: 56s P95 < 60s target âœ…

3. **Cache effectiveness analysis**:
   - Document cache hit rate over 10 runs
   - Calculate average improvement per cached search
   - Identify any articles with low cache effectiveness
   - Validate LRU size (100) is sufficient (track eviction rate)

4. **Documentation**:
   - Create comprehensive 3.2-04-SUMMARY.md
   - Update .planning/STATE.md with Phase 2 completion metrics
   - Document SLO achievement (< 60s P95)
   - Record all Phase 1+2 optimizations and cumulative impact
   - Prepare baseline for Phase 3 (Advanced Optimizations): ~56s P95

**Success criteria**:
- P95 order time â‰¤ 60s (SLO achieved)
- Cache hit rate â‰¥ 70%
- Article search improvement: -4s Â±0.8s
- Cumulative improvement: -25.5s Â±5s

**What to document**:
- Actual vs expected impact for OPT-02
- Cache hit rate statistics
- SLO achievement confirmation
- Recommendations for Phase 3 optimizations
- Any surprising insights about article search patterns
  </action>
  <verify>
1. Check 10 profiling runs completed
2. Verify P95 â‰¤ 60s across runs (SLO achieved)
3. Confirm cache hit rate â‰¥ 70%
4. Verify SUMMARY.md documents SLO achievement
5. Check STATE.md updated with Phase 2 completion
  </verify>
  <done>
- 10 profiling runs completed and analyzed
- **SLO ACHIEVED**: P95 â‰¤ 60s âœ… (target: 56s Â±2s)
- Article caching improvement: -4s Â±0.8s
- Cache hit rate: â‰¥ 70% documented
- Phase 1+2 cumulative: -25.5s Â±5s (-31% improvement)
- SUMMARY.md documents all metrics and SLO achievement
- STATE.md updated with Phase 2 completion
- Baseline established for Phase 3: ~56s P95
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `cd archibald-web-app/backend && npm test`
- [ ] Article cache implemented with LRU + TTL + persistence
- [ ] Cached article searches â‰¤ 6s P95 (target: 5s Â±20%)
- [ ] Cache hit rate â‰¥ 70% over 10 runs
- [ ] **SLO ACHIEVED**: P95 order time â‰¤ 60s (target: ~56s)
- [ ] Phase 2 cumulative improvement: -25.5s Â±5s
- [ ] SUMMARY.md documents SLO achievement
- [ ] STATE.md updated with Phase 2 completion metrics
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Article search optimization: -4s Â±0.8s achieved
- Cache hit rate: 70%+ achieved
- **PRIMARY GOAL ACHIEVED**: P95 < 60s SLO âœ…
- Phase 1+2 total: -25.5s Â±5s (81.5s baseline â†’ 56s current, -31%)
- Cache persistence and LRU working correctly
- Documentation complete and accurate
- Ready for Phase 3 (Advanced Optimizations - optional)
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-bot-performance-implementation/3.2-04-SUMMARY.md`:

# Phase 3.2 Plan 04: Article Search Caching Summary

**ðŸŽ‰ SLO ACHIEVED: Order creation < 60s P95 (56s achieved, -31% from baseline) ðŸŽ‰**

## Phase 2 Accomplishments (Plans 03-04)

### Plan 03 (OPT-01 Customer Selection):
- Customer selection: 24.8s â†’ ~10s (-59%)
- Impact: -13s

### Plan 04 (OPT-02 Article Caching):
- Article search (cached): 9.1s â†’ ~5s (-45%)
- Article search (uncached): 9.1s â†’ ~8s (-12%)
- Cache hit rate: 0% â†’ 70%+
- Impact: -4s average

### Phase 2 Total:
- Baseline (after Phase 1): 73s P95
- After Phase 2: ~56s P95
- Improvement: -17s (-23%)

## Cumulative Achievement (Phase 1 + Phase 2)

| Metric | Baseline | Phase 1 | Phase 2 | Total Improvement |
|--------|----------|---------|---------|-------------------|
| **Order Time (P95)** | 81.5s | 73s | **56s** | **-25.5s (-31%)** |
| **SLO Status** | âŒ | âŒ | **âœ… < 60s** | **ACHIEVED** |

## Files Created/Modified

- `archibald-web-app/backend/src/article-cache.ts` - LRU cache with TTL and persistence
- `archibald-web-app/backend/src/archibald-bot.ts` - Cache integration + search optimization
- `archibald-web-app/backend/.cache/article-cache.json` - Persistent cache storage

## Key Techniques

- LRU cache with 100-entry limit and 24h TTL
- Persistent cache across bot sessions
- Pre-fetch top 20 articles during idle periods
- Event-driven search result waiting
- Cache analytics (hit rate tracking)

## Cache Performance

[Document cache hit rate over 10 runs, eviction statistics, top cached articles]

## Actual vs Expected Impact

- Expected: -4s (9.1s â†’ 5.1s average)
- Actual: [Document real numbers]
- Within target: Â±20% = -3.2s to -4.8s acceptable

## SLO Achievement

âœ… **PRIMARY MILESTONE ACHIEVED**: P95 < 60s
- Target: 60s P95
- Achieved: ~56s P95 (with 4s safety margin)
- Agent productivity: 22 orders/hour â†’ 32 orders/hour (+45%)

## Next Step

**Phase 2 COMPLETE - SLO achieved!**

Optional Phase 3 (Advanced Optimizations) available:
- Plan 3.2-05 (OPT-06 Network Optimization): -5s â†’ 51s P95
- Plan 3.2-06 (OPT-07 Parallel Article Processing): -8s â†’ 43s P95
- **Phase 3 Total**: -13s additional â†’ 49s P95 (-40% from baseline)

Recommend: Pause for business validation of 56s performance before pursuing Phase 3.
</output>
