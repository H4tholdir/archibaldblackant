---
phase: 03.2-bot-performance-implementation
type: execute
---

<objective>
Implement parallel article processing (OPT-07) for multi-article orders to reduce per-article overhead from 18.5s to 10s.

Purpose: Optimize multi-article order performance by pre-fetching article data, overlapping operations, and exploring batch validation, achieving -8s per additional article.
Output: Parallel article processing system, state machine for safe operation overlap, profiling validation with 2+ article orders showing ~43-49s P95 for multi-article scenarios.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-bot-performance-profiling-optimization/OPTIMIZATION-PLAN.md
@archibald-web-app/backend/src/archibald-bot.ts
@archibald-web-app/backend/src/article-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Article Processing into State Machine</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Current**: Sequential article processing (Article 1 complete â†’ Article 2 start â†’ Article 2 complete)

**Target**: Parallel where safe (overlap search, pre-fetch, background operations)

**State Machine Design**:

```typescript
enum ArticleProcessingState {
  IDLE,
  SEARCHING,        // Article search in progress
  SELECTING,        // Variant selection
  EDITING_QUANTITY, // Field editing
  EDITING_DISCOUNT, // Field editing
  VALIDATING,       // Click Update button
  COMPLETE
}

interface ArticleTask {
  article: OrderItem;
  state: ArticleProcessingState;
  cacheEntry?: ArticleCacheEntry;
  startTime: number;
}
```

**Refactoring Steps**:

1. **Extract article processing into separate method**:
   - Current: Inline loop in createOrder()
   - New: processArticle(article: OrderItem, isFirst: boolean): Promise<void>
   - Enables reusable state transitions

2. **Implement state machine transitions**:
   - IDLE â†’ SEARCHING: Begin article search
   - SEARCHING â†’ SELECTING: Search complete, select variant
   - SELECTING â†’ EDITING_QUANTITY: Variant selected, edit quantity
   - EDITING_QUANTITY â†’ EDITING_DISCOUNT: Quantity set, edit discount
   - EDITING_DISCOUNT â†’ VALIDATING: Discount set, click Update
   - VALIDATING â†’ COMPLETE: Update confirmed

3. **Track state for multiple articles**:
   - Maintain array of ArticleTask for multi-article orders
   - Allows checking which articles can proceed in parallel
   - Example: While Article 1 is EDITING_QUANTITY, Article 2 can start SEARCHING

4. **Identify safe parallel opportunities**:
   - SEARCHING (read-only): Can run for Article N+1 while Article N edits fields
   - EDITING_QUANTITY + EDITING_DISCOUNT: Sequential (same form, race conditions)
   - VALIDATING: Must be sequential (DevExpress one update at a time)

**What to avoid and WHY**:
- Don't parallelize field editing - DevExpress form state conflicts
- Don't skip state transitions - needed for safe concurrency
- Don't parallelize validation clicks - DevExpress processes updates serially
- Don't assume all operations can overlap - analyze dependencies first

**Testing**:
- Test with 2-article order (simplest multi-article case)
- Verify state transitions occur correctly
- Ensure no race conditions (both articles complete successfully)
  </action>
  <verify>
1. Create 2-article test order: `npx tsx src/test-complete-flow.ts` (modify fixtures)
2. Check console logs show state transitions for both articles
3. Verify both articles appear in Archibald order
4. Confirm no errors or race condition warnings
5. Profile to establish baseline for parallel processing
  </verify>
  <done>
- Article processing refactored into state machine
- processArticle() method extracts article handling logic
- State transitions tracked and logged
- 2-article test order completes successfully
- State machine validated with profiling
- All tests pass (npm test)
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Choose parallel processing approach based on complexity and risk assessment</decision>
  <context>
State machine enables parallel operations, but implementation complexity varies by approach. Choose based on risk tolerance and expected impact.
  </context>
  <options>
    <option id="parallel-search-only">
      <name>Parallel Search Only (Conservative)</name>
      <pros>
- Lowest risk: Search is read-only operation
- Simplest implementation: Pre-fetch Article N+1 while Article N edits
- Estimated impact: -4s per additional article (vs -8s target)
- Uses existing ArticleCache from OPT-02
- No DevExpress race conditions possible
      </pros>
      <cons>
- Lower performance gain (50% of target)
- Doesn't optimize field editing or validation overlap
- Still sequential for most operations
      </cons>
    </option>
    <option id="parallel-search-and-overlap">
      <name>Parallel Search + Operation Overlap (Moderate)</name>
      <pros>
- Moderate risk: Overlap safe operations (search + field editing different articles)
- Good performance gain: -6s per additional article (75% of target)
- Example: Article N+1 searches while Article N validates
- Carefully managed state prevents conflicts
      </pros>
      <cons>
- More complex state management
- Need validation of DevExpress concurrent operations
- Potential for timing-dependent bugs
      </cons>
    </option>
    <option id="batch-validation">
      <name>Batch Validation (Aggressive)</name>
      <pros>
- Highest performance potential: -8s per additional article (100% of target)
- Fill all articles, validate once at end
- Eliminates per-article Update button latency
- Maximum parallelization possible
      </pros>
      <cons>
- Highest risk: Unknown if Archibald/DevExpress supports batch validation
- May require extensive testing to validate
- If not supported, fallback to sequential needed
- Could break existing order creation if validation fails
      </cons>
    </option>
  </options>
  <resume-signal>Select: parallel-search-only, parallel-search-and-overlap, or batch-validation</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Implement Parallel Article Processing</name>
  <files>archibald-web-app/backend/src/archibald-bot.ts</files>
  <action>
**Implementation based on selected approach from checkpoint.**

**For parallel-search-only**:
1. While Article N is in EDITING_QUANTITY or EDITING_DISCOUNT state:
   - Start Article N+1 search in background
   - Pre-fetch from ArticleCache or trigger Archibald search
   - Cache result for immediate use when Article N completes
2. Estimated impact: -4s per additional article
3. Implementation: Background async task, non-blocking

**For parallel-search-and-overlap**:
1. Implement parallel-search-only (above)
2. Additionally overlap:
   - Article N+1 SEARCHING while Article N VALIDATING (safe, different operations)
   - Article N+1 SELECTING while Article N EDITING_DISCOUNT (if DevExpress allows)
3. Add state validation: Prevent concurrent field edits on same form
4. Estimated impact: -6s per additional article
5. Implementation: Promise.all() for independent operations, await for dependencies

**For batch-validation**:
1. Refactor article loop to fill all articles WITHOUT clicking Update:
   - Article 1: Search â†’ Select â†’ Edit fields (no Update)
   - Article 2: Search â†’ Select â†’ Edit fields (no Update)
   - ...
   - All articles: Click Update once at end
2. Test if DevExpress validates all articles in grid
3. Add extensive validation: Verify all articles saved correctly in Archibald
4. Implement fallback: If batch validation fails, revert to sequential
5. Estimated impact: -8s per additional article (if supported)
6. Implementation: Conditional logic with feature flag

**What to avoid and WHY**:
- Don't parallelize operations that modify same DOM elements - race conditions
- Don't skip validation after parallel operations - ensure consistency
- Don't assume DevExpress handles concurrency - test thoroughly
- Don't remove sequential fallback - reliability > performance

**Testing**:
- Test with 2-article order (baseline for multi-article)
- Test with 3-article order (validate scalability)
- Test with 5-article order (stress test, validate per-article overhead)
- Compare against baseline: Current 18.5s per additional article
  </action>
  <verify>
1. Run profiling with 2-article order: `npx tsx src/test-complete-flow.ts`
2. Run profiling with 3-article order: Same test, more articles
3. Calculate per-article overhead: (Total time - Single article time) / (Article count - 1)
4. Target: â‰¤ 12s per additional article (vs 18.5s baseline, -6.5s minimum)
5. Verify all articles present in Archibald order
6. Check no race condition errors in console
  </verify>
  <done>
- Parallel processing implemented using selected approach
- Per-article overhead reduced: 18.5s â†’ â‰¤ 12s (target: 10s Â±2s)
- Multi-article orders tested (2, 3, 5 articles)
- State management prevents race conditions
- All articles created successfully in Archibald
- Profiling validates improvement across all test cases
- All tests pass (npm test)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Parallel article processing for multi-article orders</what-built>
  <how-to-verify>
1. Review profiling dashboards for 2, 3, 5-article orders
2. Calculate per-article overhead from profiling data
3. Verify improvement: 18.5s baseline â†’ ~10s achieved (target: -8.5s, -46%)
4. Check Gantt chart shows overlapping operations (if parallel approach used)
5. Confirm all articles present in Archibald orders (verify in Archibald UI)
6. Test edge case: Order with mixed package types, quantities
  </how-to-verify>
  <resume-signal>Type "approved" to continue with final validation, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Phase 3 Completion & Final Performance Validation</name>
  <files>.planning/phases/03.2-bot-performance-implementation/3.2-06-SUMMARY.md, .planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
**Phase 3 completion - achieving 49s P95 target (-40% improvement)**:

1. **Comprehensive profiling validation**:
   - Single article order: 10 runs (validate no regression)
   - 2-article order: 5 runs (common case)
   - 3-article order: 3 runs (typical multi-article)
   - 5-article order: 2 runs (stress test)
   - Calculate P50/P95/P99 across all scenarios

2. **Cumulative impact validation**:
   - Phase 1 (Plans 01-02): -8.5s (81.5s â†’ 73s)
   - Phase 2 (Plans 03-04): -17s (73s â†’ 56s) âœ… SLO
   - Phase 3 (Plans 05-06): -13s (56s â†’ 43-49s)
     - OPT-06 Network: -5s (56s â†’ 51s)
     - OPT-07 Parallel: -8s multi-article per-article overhead
   - **Total**: -32.5s to -38.5s (-40% to -47% improvement)

3. **Performance milestone achievement**:
   - Baseline: 81.5s P95
   - Phase 1 target: 73s âœ…
   - Phase 2 target (SLO): 56s âœ…
   - Phase 3 target: 49s (validate achieved)
   - Single article: ~43-49s P95
   - Multi-article: Per-article overhead ~10s (vs 18.5s baseline)

4. **Documentation**:
   - Create comprehensive 3.2-06-SUMMARY.md with all Phase 3 results
   - Update .planning/STATE.md with Phase 3.2 completion
   - Update .planning/ROADMAP.md to mark Phase 3.2 complete
   - Document all 7 optimizations and cumulative impact
   - Record business impact: Orders/hour improvement (22 â†’ 36+)

5. **Recommendations for future work**:
   - Monitoring and alerting setup (weekly profiling, SLO tracking)
   - Production rollout strategy (gradual, with rollback plan)
   - Future optimization opportunities discovered during implementation
   - Potential for further multi-article optimization if usage data shows demand

**Success criteria**:
- Single article P95 â‰¤ 50s (target: 49s Â±2s)
- Multi-article per-article overhead â‰¤ 12s (target: 10s Â±2s)
- Total improvement â‰¥ 30s (-37% minimum)
- All 7 optimizations documented and validated

**What to document**:
- Actual vs expected for OPT-07
- Multi-article scaling characteristics (2, 3, 5+ articles)
- Parallel processing approach effectiveness
- Edge cases or limitations discovered
- Production readiness assessment
- Future optimization roadmap
  </action>
  <verify>
1. Check all profiling runs completed (20 total across scenarios)
2. Verify single article P95 â‰¤ 50s
3. Verify multi-article per-article overhead â‰¤ 12s
4. Confirm cumulative improvement â‰¥ -30s
5. Check SUMMARY.md comprehensive (all 7 optimizations documented)
6. Verify STATE.md and ROADMAP.md updated
  </verify>
  <done>
- 20 profiling runs completed across all scenarios
- **PHASE 3 TARGET ACHIEVED**: Single article ~49s P95 âœ…
- Multi-article optimization: Per-article overhead 18.5s â†’ ~10s âœ…
- Total improvement: -32.5s to -38.5s (-40% to -47%)
- All 7 optimizations implemented and validated
- SUMMARY.md comprehensively documents Phase 3.2 achievement
- STATE.md and ROADMAP.md updated with completion
- Production readiness assessed and documented
- Future optimization roadmap provided
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `cd archibald-web-app/backend && npm test`
- [ ] State machine refactoring complete and reliable
- [ ] Parallel processing reduces per-article overhead: 18.5s â†’ â‰¤ 12s
- [ ] Single article orders: P95 â‰¤ 50s (target: 49s Â±2s)
- [ ] Multi-article orders tested (2, 3, 5 articles)
- [ ] Phase 3.2 complete: All 6 plans executed
- [ ] Total improvement: â‰¥ -30s (-37% minimum)
- [ ] SUMMARY.md comprehensively documents all achievements
- [ ] STATE.md and ROADMAP.md updated
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Parallel article processing: -8s per additional article Â±2s achieved
- State machine enables safe concurrency
- Multi-article orders scale efficiently (per-article overhead -46%)
- **PRIMARY GOAL**: Single article ~49s P95 âœ… (-40% from baseline)
- **CUMULATIVE ACHIEVEMENT**: -32.5s minimum (-40%)
- All 7 optimizations implemented, tested, and documented
- Production-ready with monitoring recommendations
- Phase 3.2 (Bot Performance Implementation) COMPLETE
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-bot-performance-implementation/3.2-06-SUMMARY.md`:

# Phase 3.2 Plan 06: Parallel Article Processing Summary

**ðŸŽ‰ PHASE 3.2 COMPLETE: 40% performance improvement achieved (81.5s â†’ 49s) ðŸŽ‰**

## Accomplishments

- Article processing state machine implemented
- Parallel article search and operation overlap: -8s per additional article
- Multi-article per-article overhead: 18.5s â†’ ~10s (-46%)
- Single article orders: 81.5s â†’ ~49s P95 (-40%)

## Phase 3.2 Complete Achievement (All 6 Plans)

| Phase | Plans | Optimizations | Impact | Order Time (P95) | Status |
|-------|-------|---------------|--------|------------------|--------|
| **Baseline** | - | - | - | **81.5s** | - |
| **Phase 1** | 01-02 | OPT-03, 04, 05, BUG | -8.5s | **73s** | âœ… |
| **Phase 2** | 03-04 | OPT-01, 02 | -17s | **56s** | âœ… **SLO** |
| **Phase 3** | 05-06 | OPT-06, 07 | -13s | **49s** | âœ… **TARGET** |
| **TOTAL** | **6** | **7 optimizations** | **-32.5s (-40%)** | **49s** | **âœ…** |

## All Optimizations Implemented

1. âœ… **OPT-03**: Field editing optimization (-4.5s) - JavaScript setValue
2. âœ… **OPT-04**: Multi-article button (-3s) - Event-driven waiting
3. âœ… **OPT-05**: Login cache (-1s) - Extended TTL, direct navigation
4. âœ… **BUG-FIX**: Profiling categories (5 operations)
5. âœ… **OPT-01**: Customer selection (-13s) - [Direct ID / Optimized dropdown / Hybrid]
6. âœ… **OPT-02**: Article caching (-4s) - LRU cache with 70%+ hit rate
7. âœ… **OPT-06**: Network optimization (-5s) - Screenshot reduction, selector optimization
8. âœ… **OPT-07**: Parallel articles (-8s per additional) - State machine + parallel processing

## Multi-Article Performance

| Scenario | Baseline | Optimized | Improvement |
|----------|----------|-----------|-------------|
| **Single article** | 81.5s | ~49s | -32.5s (-40%) |
| **2 articles** | ~100s | ~59s | -41s (-41%) |
| **3 articles** | ~118.5s | ~69s | -49.5s (-42%) |
| **5 articles** | ~155.5s | ~89s | -66.5s (-43%) |

**Per-article overhead**: 18.5s â†’ ~10s (-46%)

## Files Created/Modified

- `archibald-web-app/backend/src/archibald-bot.ts` - State machine + parallel processing
- All optimization code from Plans 01-06

## Technical Implementation

[Document the parallel processing approach used: search-only, search-and-overlap, or batch-validation]
[Document state machine design and safe concurrency patterns]

## Business Impact

- **Agent productivity**: 22 orders/hour â†’ 36+ orders/hour (+64%)
- **Time savings**: 32.5s per order = 9+ hours saved per 1000 orders
- **SLO achievement**: P95 < 60s âœ… (49s with 11s safety margin)
- **Scalability**: Multi-article orders scale efficiently

## Production Readiness

- All optimizations tested and validated
- No regressions in order creation reliability
- Profiling infrastructure in place for ongoing monitoring
- Rollback possible (each optimization independent)

## Recommendations

1. **Monitoring**: Weekly profiling runs to track SLO compliance
2. **Alerting**: Set up alerts if P95 > 60s for 2 consecutive days
3. **Rollout**: Gradual production deployment with monitoring
4. **Future work**: Additional optimizations possible if business demands (target: 43s with all Phase 3 enhancements)

## Next Steps

**Phase 3.2 COMPLETE** - Ready for Phase 4 or milestone completion review

Performance optimization cycle complete. System ready for production validation.
</output>
