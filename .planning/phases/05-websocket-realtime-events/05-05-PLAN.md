---
phase: 05-websocket-realtime-events
plan: 05
type: execute
---

<objective>
Complete Phase 5 by: (1) adding WebSocket events to fresis-history routes, (2) migrating frontend sync progress from SSE to WebSocket, and (3) removing the SSE progress endpoint.

Purpose: Close all remaining event gaps and consolidate real-time on a single WebSocket channel, eliminating the unused SSE dual-channel complexity.
Output: Fresis history CRUD emits WS events, UnifiedSyncProgress + useSyncProgress use WebSocket, sse-progress.ts removed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-websocket-realtime-events/05-RESEARCH.md
@.planning/phases/05-websocket-realtime-events/05-CONTEXT.md

# Prior plan summaries:
@.planning/phases/05-websocket-realtime-events/05-04-SUMMARY.md

# Key files:
@archibald-web-app/backend/src/routes/fresis-history.ts
@archibald-web-app/backend/src/server.ts
@archibald-web-app/backend/src/realtime/sse-progress.ts
@archibald-web-app/frontend/src/hooks/useSyncProgress.ts
@archibald-web-app/frontend/src/components/UnifiedSyncProgress.tsx
@archibald-web-app/frontend/src/contexts/WebSocketContext.tsx

**Constraining decisions:**
- [Research]: Consolidate on WebSocket, remove SSE. SSE stub is disconnected (onJobEvent returns no-op)
- [Plan 05-02]: JOB_PROGRESS events now broadcast via WebSocket with `{ type: 'JOB_PROGRESS', payload: { jobId, operationType, progress, label }, timestamp }`
- [Research]: UnifiedSyncProgress expects SyncProgress interface with syncType, mode, status, percentage, etc. JOB_PROGRESS carries progress + label. For MVP, use JOB_PROGRESS data and infer syncType from operationType

**Frontend files expecting SSE:**
- useSyncProgress.ts: EventSource on /api/sync/progress?token=jwt
- UnifiedSyncProgress.tsx: EventSource on /api/sync/progress?token=jwt

**Events emitted but frontend not yet wired:**
- FRESIS_HISTORY_CREATED/UPDATED/DELETED: Frontend FresisHistoryRealtimeService already subscribes, just needs backend to emit
- Note: FRESIS_HISTORY_EDIT_PROGRESS, FRESIS_HISTORY_DELETE_PROGRESS, FRESIS_HISTORY_BULK_IMPORTED require operation types that don't exist yet (Phase 7) — skip for now
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add broadcast to fresis-history routes and emit CRUD events</name>
  <files>archibald-web-app/backend/src/routes/fresis-history.ts, archibald-web-app/backend/src/server.ts</files>
  <action>
1. In `routes/fresis-history.ts`:
   - Add `broadcast: (userId: string, msg: { type: string; payload: unknown; timestamp: string }) => void` to `FresisHistoryRouterDeps` type
   - In POST `/` handler (upsertRecords, ~line 214-226): after `res.json(result)`, emit:
     ```
     deps.broadcast(userId, {
       type: 'FRESIS_HISTORY_UPDATED',
       payload: { inserted: result.inserted, updated: result.updated },
       timestamp: new Date().toISOString(),
     });
     ```
     Use FRESIS_HISTORY_UPDATED as the event type for upserts (covers both create and update). If result.inserted > 0, also emit:
     ```
     deps.broadcast(userId, {
       type: 'FRESIS_HISTORY_CREATED',
       payload: { count: result.inserted },
       timestamp: new Date().toISOString(),
     });
     ```
   - In DELETE `/:id` handler (~line 228-238): after successful delete response, emit:
     ```
     deps.broadcast(userId, {
       type: 'FRESIS_HISTORY_DELETED',
       payload: { recordId: req.params.id },
       timestamp: new Date().toISOString(),
     });
     ```
   - Extract userId from `(req as AuthRequest).user!.userId` for all broadcast calls

2. In `server.ts`:
   - In the `createFresisHistoryRouter({...})` call (~line 232-248), add `broadcast: broadcastFn` to the deps object

Avoid: Emitting events for read-only operations (GET endpoints). Only emit on mutations (POST upsert, DELETE).
  </action>
  <verify>npm run build --prefix archibald-web-app/backend</verify>
  <done>fresis-history routes emit FRESIS_HISTORY_CREATED/UPDATED/DELETED on mutations, server.ts wires broadcast, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Migrate frontend sync progress from SSE to WebSocket</name>
  <files>archibald-web-app/frontend/src/hooks/useSyncProgress.ts, archibald-web-app/frontend/src/components/UnifiedSyncProgress.tsx</files>
  <action>
1. In `hooks/useSyncProgress.ts`:
   - Remove all EventSource/SSE connection logic
   - Import `useWebSocket` (or the appropriate hook/context) from WebSocketContext
   - Subscribe to JOB_PROGRESS and JOB_COMPLETED events via WebSocket
   - Map JOB_PROGRESS to sync progress state:
     - Extract `operationType` from payload to determine syncType (e.g., 'sync-customers' → 'customers', 'sync-orders' → 'orders', 'sync-products' → 'products', 'sync-prices' → 'prices')
     - Map `progress` to percentage
     - Map `label` to status description
     - Filter events: only handle sync operation types (operationType starts with 'sync-')
   - On JOB_COMPLETED for sync operations: set status to 'completed'
   - On JOB_FAILED for sync operations: set status to 'error' with error message from payload
   - Keep the existing force-sync and reset-and-sync trigger logic (these use HTTP endpoints, not SSE)
   - Keep the same return type/interface so consuming components don't break

2. In `components/UnifiedSyncProgress.tsx`:
   - Remove all EventSource/SSE connection logic
   - If this component creates its own SSE connection (separate from useSyncProgress), replace with WebSocket subscription
   - If it uses useSyncProgress hook, it may already work after the hook is migrated — verify and adjust
   - Keep the same UI rendering (banner/badge modes, progress display)
   - The SyncProgress interface can be simplified since WS events carry less data than SSE. For fields not available from JOB_PROGRESS (currentPage, totalPages, itemsProcessed, itemsChanged, estimatedCompletion):
     - Set to undefined/0 — these were populated by the SSE endpoint which was itself a stub (onJobEvent returns no-op)
     - The UI should handle undefined gracefully (optional chaining, fallback display)

Avoid: Removing the entire SyncProgress interface — keep it for type compatibility. Just populate what's available from WS events and leave the rest optional.
  </action>
  <verify>npm run type-check --prefix archibald-web-app/frontend</verify>
  <done>useSyncProgress uses WebSocket instead of SSE, UnifiedSyncProgress renders with WS data, no SSE references remain in these files, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 3: Remove SSE progress endpoint and clean up</name>
  <files>archibald-web-app/backend/src/realtime/sse-progress.ts, archibald-web-app/backend/src/realtime/sse-progress.spec.ts, archibald-web-app/backend/src/server.ts</files>
  <action>
1. In `server.ts`:
   - Remove the SSE progress route mount (~line 271): `app.use('/api/sync', authenticateJWT, createSseProgressRouter({...}))` — delete the entire block
   - Remove the import of `createSseProgressRouter` from the imports section
   - If there are any deps passed to the SSE router (getActiveJob, getQueueStats, onJobEvent), verify they're not used elsewhere before removing

2. Delete `realtime/sse-progress.ts` — the entire file. It's a stub that:
   - Has an onJobEvent that returns no-op unsubscribe
   - Is not connected to the actual broadcast system
   - SSE is now fully replaced by WebSocket

3. Delete `realtime/sse-progress.spec.ts` — tests for the removed file

4. Verify no other files import from sse-progress.ts:
   - Search for imports of `sse-progress` or `createSseProgressRouter` across the codebase
   - If any remaining references, update them

5. Search the frontend for any remaining SSE references:
   - Check for `EventSource` usage in any file besides the ones migrated in Task 2
   - Check for `/api/sync/progress` URL references
   - Remove any orphaned SSE utility code

Avoid: Leaving dead SSE imports or references. Clean removal — git history is the safety net.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend && npm run type-check --prefix archibald-web-app/frontend && npm test --prefix archibald-web-app/backend && npm test --prefix archibald-web-app/frontend</verify>
  <done>sse-progress.ts deleted, sse-progress.spec.ts deleted, server.ts SSE mount removed, no remaining SSE references in codebase, all builds and tests pass, Phase 5 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm run type-check --prefix archibald-web-app/frontend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes all tests
- [ ] `npm test --prefix archibald-web-app/frontend` passes all tests
- [ ] No references to EventSource or /api/sync/progress in frontend
- [ ] No imports of sse-progress in backend
- [ ] Fresis history CRUD emits WebSocket events
- [ ] Sync progress UI uses WebSocket
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors in frontend or backend
- SSE completely removed from codebase
- All real-time events consolidated on WebSocket
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-websocket-realtime-events/05-05-SUMMARY.md`:

# Phase 5 Plan 5: SSE → WS Migration + Fresis History Events Summary

**[One-liner summary]**

## Accomplishments

- Fresis history routes emit CREATED/UPDATED/DELETED events
- Frontend sync progress migrated from SSE to WebSocket
- SSE endpoint removed, single real-time channel (WebSocket)

## Files Created/Modified

- [list all files]

## Decisions Made

[Decisions]

## Issues Encountered

[Issues]

## Next Step

Phase 5 complete, ready for Phase 6: Data Integrity & Hardening
</output>
