---
phase: 05-websocket-realtime-events
plan: 03
type: execute
---

<objective>
Extend the OperationHandler type with an optional `onEmit` callback to allow handlers to emit operation-specific WebSocket events, then use it in submit-order to emit PENDING_SUBMITTED and ORDER_NUMBERS_RESOLVED.

Purpose: Enable handlers to emit domain-specific events beyond generic JOB_STARTED/PROGRESS/COMPLETED. The submit-order handler is the first and most critical consumer — it needs to notify when an order is submitted and when Archibald order numbers are resolved.
Output: OperationHandler type extended, broadcast wired through processor to handlers, submit-order emits PENDING_SUBMITTED and ORDER_NUMBERS_RESOLVED.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-websocket-realtime-events/05-RESEARCH.md

# Prior plan summary (from this phase):
@.planning/phases/05-websocket-realtime-events/05-02-SUMMARY.md

# Key files:
@archibald-web-app/backend/src/operations/operation-processor.ts
@archibald-web-app/backend/src/operations/handlers/submit-order.ts
@archibald-web-app/backend/src/operations/handlers/submit-order.spec.ts

**Constraining decisions:**
- [Plan 05-02]: Processor broadcasts use `{ type, payload, timestamp }` format
- [Phase 3-03]: submit-order uses check-save-clear pattern for idempotent recovery
- OperationHandler signature: `(context, data, userId, onProgress, signal?) => Promise<Record<string, unknown>>`
- All 15 handlers import OperationHandler type and must remain compatible

**Key insight from research:** Only the handler knows domain-specific details (pendingOrderId → real orderId mapping). The processor can emit generic events (JOB_*), but operation-specific events MUST come from the handler.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend OperationHandler type with onEmit callback and wire through processor</name>
  <files>archibald-web-app/backend/src/operations/operation-processor.ts</files>
  <action>
1. **Define OnEmitFn type** — Add near the OperationHandler type definition:
   ```
   type OnEmitFn = (event: { type: string; payload: unknown; timestamp: string }) => void;
   ```

2. **Extend OperationHandler** — Add optional `onEmit` as the last parameter:
   ```
   type OperationHandler = (
     context: BrowserContext,
     data: Record<string, unknown>,
     userId: string,
     onProgress: (progress: number, label?: string) => void,
     signal?: AbortSignal,
     onEmit?: OnEmitFn,
   ) => Promise<Record<string, unknown>>;
   ```
   Making it optional ensures backward compatibility — existing handlers that don't use it won't break.

3. **Create onEmit in processJob** — Before the handler call (~line 128), create the onEmit function:
   ```
   const onEmit: OnEmitFn = (event) => {
     broadcast(userId, event);
   };
   ```
   This wraps broadcast to hide userId from the handler (handler already receives userId but this keeps the emit API clean — handler just says "emit this event" and the processor routes it to the right user).

4. **Pass onEmit to handler** — In the Promise.race call (~line 128-129), add onEmit:
   ```
   handler(context, handlerData, userId, onProgress, timeoutController.signal, onEmit),
   ```

5. **Export OnEmitFn type** — Add to the export block at the bottom.

Avoid: Making onEmit required — this would force all 15 handlers to update their signatures simultaneously. Keep it optional so handlers can opt-in incrementally.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend (all handlers still compile with optional onEmit)</verify>
  <done>OnEmitFn type defined, OperationHandler extended with optional onEmit, processor creates onEmit and passes to handler, all existing handlers compile without changes</done>
</task>

<task type="auto">
  <name>Task 2: Emit PENDING_SUBMITTED and ORDER_NUMBERS_RESOLVED from submit-order handler</name>
  <files>archibald-web-app/backend/src/operations/handlers/submit-order.ts, archibald-web-app/backend/src/operations/handlers/submit-order.spec.ts</files>
  <action>
1. In `handlers/submit-order.ts`:
   - Import `OnEmitFn` from `../operation-processor`
   - Add `onEmit?: OnEmitFn` parameter to `handleSubmitOrder` function signature (after onProgress)
   - After the `pool.withTransaction(...)` block completes (~line 170, before clearBotResult), emit two events:

   **PENDING_SUBMITTED** — signals that the pending order has been submitted to Archibald:
   ```
   onEmit?.({
     type: 'PENDING_SUBMITTED',
     payload: { pendingOrderId: data.pendingOrderId, orderId },
     timestamp: new Date().toISOString(),
   });
   ```

   **ORDER_NUMBERS_RESOLVED** — maps the pending order to the real Archibald order ID:
   ```
   onEmit?.({
     type: 'ORDER_NUMBERS_RESOLVED',
     payload: {
       pendingOrderId: data.pendingOrderId,
       orderId,
       orderNumber: isWarehouseOnly ? orderId : `PENDING-${orderId}`,
       customerId: data.customerId,
       customerName: data.customerName,
     },
     timestamp: new Date().toISOString(),
   });
   ```

   - Update `createSubmitOrderHandler` factory to pass onEmit through:
   ```
   return async (context, data, userId, onProgress, signal, onEmit) => {
     const bot = createBot(userId);
     const typedData = data as unknown as SubmitOrderData;
     const result = await handleSubmitOrder(pool, bot, typedData, userId, onProgress, onEmit);
     return result as unknown as Record<string, unknown>;
   };
   ```

2. In `handlers/submit-order.spec.ts`:
   - Add test: **"emits PENDING_SUBMITTED after transaction"** — provide mock onEmit, verify called with correct pendingOrderId and orderId
   - Add test: **"emits ORDER_NUMBERS_RESOLVED with order mapping"** — verify payload contains pendingOrderId, orderId, orderNumber, customerId, customerName
   - Add test: **"does not throw if onEmit is undefined"** — call handleSubmitOrder without onEmit, verify no error (backward compat)
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run submit-order</verify>
  <done>submit-order emits PENDING_SUBMITTED and ORDER_NUMBERS_RESOLVED after transaction, 3 new tests pass, backward compatibility maintained</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes all tests
- [ ] OperationHandler type has optional onEmit parameter
- [ ] Existing handlers compile without changes (onEmit is optional)
- [ ] submit-order emits both events AFTER successful transaction
- [ ] Events use `{ type, payload, timestamp }` format
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- OnEmitFn type exported and usable by any handler
- submit-order emits PENDING_SUBMITTED + ORDER_NUMBERS_RESOLVED
- All 15 existing handlers still compile (backward compat)
</success_criteria>

<output>
After completion, create `.planning/phases/05-websocket-realtime-events/05-03-SUMMARY.md`
</output>
