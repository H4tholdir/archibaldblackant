---
phase: 05-websocket-realtime-events
plan: 02
type: execute
---

<objective>
Emit JOB_STARTED and JOB_PROGRESS WebSocket events from the operation processor, and standardize all processor broadcasts to the WebSocketMessage format `{ type, payload, timestamp }`.

Purpose: Give all connected devices real-time visibility into job lifecycle — when a job starts and its progress as it executes.
Output: Processor emits JOB_STARTED before handler invocation, JOB_PROGRESS on every onProgress call, and all existing JOB_COMPLETED/FAILED events use standardized format.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-websocket-realtime-events/05-RESEARCH.md

# Prior summaries (dependency graph):
@.planning/phases/02-operation-queue-core-fixes/02-01-SUMMARY.md
@.planning/phases/02-operation-queue-core-fixes/02-02-SUMMARY.md
@.planning/phases/03-browser-pool-concurrency/03-02-SUMMARY.md

# Key files:
@archibald-web-app/backend/src/operations/operation-processor.ts
@archibald-web-app/backend/src/operations/operation-processor.spec.ts
@archibald-web-app/backend/src/realtime/websocket-server.ts
@archibald-web-app/backend/src/operations/operation-types.ts

**Constraining decisions:**
- [Phase 2-01]: AbortSignal flows through processJob to handlers via timeoutController
- [Phase 2-02]: Preemption via cancelJob + polling, handler timeout via Promise.race
- [Phase 3-02]: Worker concurrency 10, re-enqueue with exponential backoff

**Current broadcast calls in processor:**
- Line 145-150: JOB_COMPLETED — `{ event: 'JOB_COMPLETED', jobId, type, result }` (flat, wrong format)
- Line 160-165: JOB_FAILED (timeout) — `{ event: 'JOB_FAILED', jobId, type, error }` (flat, wrong format)
- Line 169-174: JOB_FAILED (error) — same flat format

**Format problem:** Processor uses `{ event: 'JOB_COMPLETED', type: operationType }` where `type` is the operation type (e.g., 'submit-order'), NOT the event type. Frontend routes on the `type` field. This causes routing to the wrong handler. Must standardize to `{ type: 'JOB_COMPLETED', payload: { jobId, operationType, result }, timestamp }`.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Emit JOB_STARTED and JOB_PROGRESS, standardize broadcast format</name>
  <files>archibald-web-app/backend/src/operations/operation-processor.ts</files>
  <action>
1. **Add JOB_STARTED emission** — After lock is acquired and before browser context acquisition (~line 120, before `context = await browserPool.acquireContext`):
   ```
   broadcast(userId, {
     type: 'JOB_STARTED',
     payload: { jobId: job.id, operationType: type },
     timestamp: new Date().toISOString(),
   });
   ```

2. **Extend onProgress to broadcast JOB_PROGRESS** — In the onProgress callback (~line 124-126), after `job.updateProgress(...)`, add:
   ```
   broadcast(userId, {
     type: 'JOB_PROGRESS',
     payload: { jobId: job.id, operationType: type, progress, label },
     timestamp: new Date().toISOString(),
   });
   ```

3. **Standardize JOB_COMPLETED** (~line 145-150) — Change from flat format to WebSocketMessage:
   ```
   broadcast(userId, {
     type: 'JOB_COMPLETED',
     payload: { jobId: job.id, operationType: type, result },
     timestamp: new Date().toISOString(),
   });
   ```

4. **Standardize JOB_FAILED** (both catch blocks ~line 160-165 and ~line 169-174) — Change to:
   ```
   broadcast(userId, {
     type: 'JOB_FAILED',
     payload: { jobId: job.id, operationType: type, error: errorMessage },
     timestamp: new Date().toISOString(),
   });
   ```

Note: Use `operationType` (not `type`) in the payload to avoid confusion with the message's `type` field which is the event name.

Avoid: Breaking the BroadcastFn type signature — it accepts `Record<string, unknown>` which is compatible with `{ type: string, payload: unknown, timestamp: string }`. No type change needed.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend</verify>
  <done>JOB_STARTED emitted before handler, JOB_PROGRESS emitted on every onProgress call, JOB_COMPLETED/FAILED use standardized { type, payload, timestamp } format, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Update TRANSIENT_EVENT_TYPES and processor tests</name>
  <files>archibald-web-app/backend/src/realtime/websocket-server.ts, archibald-web-app/backend/src/operations/operation-processor.spec.ts</files>
  <action>
1. In `realtime/websocket-server.ts`:
   - The TRANSIENT_EVENT_TYPES set currently contains `['JOB_PROGRESS', 'CUSTOMER_UPDATE_PROGRESS']`
   - These are checked against the event object. Since we changed the format, verify that the transient check works with the new format. The bufferEvent function checks `event.type` (from WebSocketMessage type). Since we now set `type: 'JOB_PROGRESS'`, this should work correctly.
   - No changes needed IF the check is on the `type` field. If it checks `event.event` (old flat format), update it to check `event.type`.

2. In `operation-processor.spec.ts`:
   - Update ALL existing broadcast assertions to match the new WebSocketMessage format
   - Existing tests check for `{ event: 'JOB_COMPLETED', jobId, type, result }` — update to `{ type: 'JOB_COMPLETED', payload: { jobId, operationType, result }, timestamp: expect.any(String) }`
   - Same for JOB_FAILED assertions
   - Add new test: **"emits JOB_STARTED before handler execution"** — verify broadcast called with JOB_STARTED before handler is invoked (check call order)
   - Add new test: **"emits JOB_PROGRESS when handler calls onProgress"** — set up handler that calls onProgress(50, 'Working'), verify broadcast called with JOB_PROGRESS containing progress: 50, label: 'Working'
   - Add new test: **"JOB_STARTED includes correct operationType"** — verify payload.operationType matches the job's operation type
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run operation-processor</verify>
  <done>All existing tests updated to new format and passing, 3 new tests for JOB_STARTED/JOB_PROGRESS added and passing, transient event check verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes all tests (not just processor tests)
- [ ] All 4 event types use `{ type, payload, timestamp }` format
- [ ] JOB_STARTED emitted BEFORE handler invocation
- [ ] JOB_PROGRESS emitted on EVERY onProgress call
- [ ] JOB_PROGRESS remains in TRANSIENT_EVENT_TYPES (not buffered for replay)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Processor emits 4 event types in correct order: JOB_STARTED → JOB_PROGRESS* → JOB_COMPLETED/FAILED
- All events use standardized WebSocketMessage format
</success_criteria>

<output>
After completion, create `.planning/phases/05-websocket-realtime-events/05-02-SUMMARY.md`
</output>
