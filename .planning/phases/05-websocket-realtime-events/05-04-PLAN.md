---
phase: 05-websocket-realtime-events
plan: 04
type: execute
---

<objective>
Emit operation-specific progress and completion events from edit-order, delete-order, and send-to-verona handlers using the onEmit callback established in Plan 05-03.

Purpose: Give the frontend real-time progress feedback for order edit, delete, and send-to-verona operations — currently the frontend subscribes to these events but never receives them.
Output: Three handlers emit progress/complete events, all progress events added to TRANSIENT_EVENT_TYPES.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-websocket-realtime-events/05-RESEARCH.md

# Prior plan summaries (from this phase):
@.planning/phases/05-websocket-realtime-events/05-03-SUMMARY.md

# Key files:
@archibald-web-app/backend/src/operations/handlers/edit-order.ts
@archibald-web-app/backend/src/operations/handlers/delete-order.ts
@archibald-web-app/backend/src/operations/handlers/send-to-verona.ts
@archibald-web-app/backend/src/realtime/websocket-server.ts

**Constraining decisions:**
- [Plan 05-03]: OperationHandler has optional onEmit: OnEmitFn parameter
- [Plan 05-02]: TRANSIENT_EVENT_TYPES set controls which events are buffered for replay
- [Research]: Progress events should be transient (not buffered) — they're ephemeral, client can refetch current state

**Frontend expectations (from FresisHistoryRealtimeService + OrderCardNew):**
- ORDER_EDIT_PROGRESS: `{ recordId: string; progress: number; operation: string; timestamp: string }`
- ORDER_EDIT_COMPLETE: `{ recordId: string; timestamp: string }`
- ORDER_DELETE_PROGRESS: `{ recordId: string; progress: number; operation: string; timestamp: string }`
- ORDER_DELETE_COMPLETE: `{ recordId: string; timestamp: string }`
- ORDER_SEND_TO_VERONA_PROGRESS: `{ recordId: string; progress: number; operation: string; timestamp: string }`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Emit ORDER_EDIT and ORDER_DELETE events from handlers</name>
  <files>archibald-web-app/backend/src/operations/handlers/edit-order.ts, archibald-web-app/backend/src/operations/handlers/delete-order.ts</files>
  <action>
1. In `handlers/edit-order.ts`:
   - Import `OnEmitFn` from `../operation-processor`
   - Add `onEmit?: OnEmitFn` to `handleEditOrder` function signature (after onProgress)
   - Emit ORDER_EDIT_PROGRESS at key points (matching the existing onProgress calls):
     - After `onProgress(10, ...)` (~line 41): `onEmit?.({ type: 'ORDER_EDIT_PROGRESS', payload: { recordId: data.orderId, progress: 10, operation: 'edit-order' }, timestamp: new Date().toISOString() })`
     - After `onProgress(70, ...)` (~line 49): same with progress: 70
   - Emit ORDER_EDIT_COMPLETE after `onProgress(100, ...)` (~line 95):
     `onEmit?.({ type: 'ORDER_EDIT_COMPLETE', payload: { recordId: data.orderId }, timestamp: new Date().toISOString() })`
   - Update `createEditOrderHandler` factory to pass onEmit through to handleEditOrder

2. In `handlers/delete-order.ts`:
   - Import `OnEmitFn` from `../operation-processor`
   - Add `onEmit?: OnEmitFn` to `handleDeleteOrder` function signature (after onProgress)
   - Emit ORDER_DELETE_PROGRESS at key points:
     - After `onProgress(10, ...)` (~line 27): `onEmit?.({ type: 'ORDER_DELETE_PROGRESS', payload: { recordId: data.orderId, progress: 10, operation: 'delete-order' }, timestamp: new Date().toISOString() })`
     - After `onProgress(70, ...)` (~line 42): same with progress: 70
   - Emit ORDER_DELETE_COMPLETE after `onProgress(100, ...)` (~line 61):
     `onEmit?.({ type: 'ORDER_DELETE_COMPLETE', payload: { recordId: data.orderId }, timestamp: new Date().toISOString() })`
   - Update `createDeleteOrderHandler` factory to pass onEmit through

Avoid: Replacing onProgress calls — keep them for BullMQ job progress tracking. onEmit adds WebSocket events ON TOP of existing onProgress, not instead of.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend</verify>
  <done>edit-order emits ORDER_EDIT_PROGRESS/COMPLETE, delete-order emits ORDER_DELETE_PROGRESS/COMPLETE, both factories pass onEmit, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Emit ORDER_SEND_TO_VERONA_PROGRESS and update transient event types</name>
  <files>archibald-web-app/backend/src/operations/handlers/send-to-verona.ts, archibald-web-app/backend/src/realtime/websocket-server.ts</files>
  <action>
1. In `handlers/send-to-verona.ts`:
   - Import `OnEmitFn` from `../operation-processor`
   - Add `onEmit?: OnEmitFn` to `handleSendToVerona` function signature (after onProgress)
   - Emit ORDER_SEND_TO_VERONA_PROGRESS at key points:
     - After `onProgress(10, ...)` (~line 27): `onEmit?.({ type: 'ORDER_SEND_TO_VERONA_PROGRESS', payload: { recordId: data.orderId, progress: 10, operation: 'send-to-verona' }, timestamp: new Date().toISOString() })`
     - After `onProgress(70, ...)` (~line 44): same with progress: 70
     - After `onProgress(100, ...)` (~line 55): same with progress: 100
   - Update `createSendToVeronaHandler` factory to pass onEmit through

2. In `realtime/websocket-server.ts`:
   - Add the following event types to TRANSIENT_EVENT_TYPES set (these are progress events that should NOT be buffered for replay):
     - 'ORDER_EDIT_PROGRESS'
     - 'ORDER_DELETE_PROGRESS'
     - 'ORDER_SEND_TO_VERONA_PROGRESS'
   - The TRANSIENT_EVENT_TYPES check in bufferEvent must work with the new WebSocketMessage format (check `event.type` not `event.event`). Verify this is correct — if bufferEvent currently checks a different field, fix it.

Avoid: Adding COMPLETE events to transient types — ORDER_EDIT_COMPLETE and ORDER_DELETE_COMPLETE should be BUFFERED (replayed on reconnect) because they represent state changes.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend && npm test --prefix archibald-web-app/backend -- --run websocket</verify>
  <done>send-to-verona emits progress events, TRANSIENT_EVENT_TYPES updated with 3 new progress types, transient check works with WebSocketMessage format, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` passes all tests
- [ ] edit-order: ORDER_EDIT_PROGRESS at 10/70, ORDER_EDIT_COMPLETE at end
- [ ] delete-order: ORDER_DELETE_PROGRESS at 10/70, ORDER_DELETE_COMPLETE at end
- [ ] send-to-verona: ORDER_SEND_TO_VERONA_PROGRESS at 10/70/100
- [ ] Progress events are in TRANSIENT_EVENT_TYPES (not buffered)
- [ ] Complete events are NOT in TRANSIENT_EVENT_TYPES (buffered for replay)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- 3 handlers emit operation-specific events via onEmit
- Progress events marked transient, complete events buffered
- Payload format matches frontend expectations (recordId, progress, operation)
</success_criteria>

<output>
After completion, create `.planning/phases/05-websocket-realtime-events/05-04-SUMMARY.md`
</output>
