---
phase: 19-products-sync-analysis-optimization
plan: 03
title: Manual Sync UI & API Endpoint
subsystem: frontend, api
complexity: low
estimated_duration: 45min
tags: [ui, api, manual-sync, jwt-protected, react]
---

# Plan 19-03: Manual Sync UI & API Endpoint

## Objective

Add manual sync button to products page with JWT-protected API endpoint, progress feedback banner, and success/error notifications, following Phase 18-03 patterns.

## Execution Context

**Phase 18-03 Proven Patterns:**
- üîÑ button with spinner during sync
- ManualSyncBanner component (yellow ‚è≥, green ‚úÖ, red ‚ùå)
- JWT-protected POST /api/{resource}/sync endpoint
- Progress callback integration
- 3-second auto-hide success banner
- Error banner with retry button

**User Requirements:**
- Manual sync button on products page
- Same UX as customers sync (Phase 18-03)
- Progress feedback during ~60s sync
- Italian messages

**Key Files:**
- Reference: `.planning/phases/18-customers-sync-analysis-optimization/18-03-PLAN.md`
- Reference: `archibald-web-app/frontend/src/pages/Clienti.tsx` (manual sync UI)
- Target: `archibald-web-app/frontend/src/pages/Articoli.tsx`
- Target: `archibald-web-app/backend/src/index.ts` (add POST /api/products/sync)

## Context

**Dependencies:**
- Phase 19-02 complete (ProductSyncService with progress callbacks)
- JWT middleware available
- ManualSyncBanner component exists (reusable from Phase 18-03)

**Current Articoli Page:**
@archibald-web-app/frontend/src/pages/Articoli.tsx

Needs:
- Manual sync button in header
- ManualSyncBanner integration
- API client method for POST /api/products/sync

## Tasks

### Task 1: Create API Endpoint POST /api/products/sync
**Duration:** 15min

Add JWT-protected endpoint in `archibald-web-app/backend/src/index.ts`.

**Implementation:**
```typescript
// Manual products sync endpoint (JWT-protected)
app.post("/api/products/sync", jwtMiddleware, async (req: AuthRequest, res) => {
  try {
    const startTime = Date.now();
    logger.info("[API] Manual products sync requested", { userId: req.user?.userId });

    const service = ProductSyncService.getInstance();

    const result = await service.syncProducts((progress) => {
      // Progress callback (can be extended with WebSockets in future)
      logger.info("[API] Sync progress", { stage: progress.stage, message: progress.message });
    });

    const duration = Date.now() - startTime;

    logger.info("[API] Products sync completed", {
      userId: req.user?.userId,
      result,
      durationMs: duration,
    });

    res.json({
      success: true,
      ...result,
    });
  } catch (error) {
    logger.error("[API] Products sync failed", {
      userId: req.user?.userId,
      error,
    });

    if (error instanceof Error && error.message === "Sync already in progress") {
      res.status(409).json({
        success: false,
        error: "Sincronizzazione gi√† in corso",
      });
    } else {
      res.status(500).json({
        success: false,
        error: error instanceof Error ? error.message : "Errore sconosciuto",
      });
    }
  }
});
```

**Acceptance Criteria:**
- POST /api/products/sync requires JWT
- Returns 409 if sync in progress
- Returns 500 on error
- Returns 200 with result on success
- Logs userId for audit trail

**Commit:** `feat(19-03): add JWT-protected POST /api/products/sync endpoint`

---

### Task 2: Add API Client Method
**Duration:** 5min

Add `syncProducts()` to `archibald-web-app/frontend/src/api/products.ts`.

**Implementation:**
```typescript
export interface SyncProductsResult {
  success: boolean;
  productsProcessed?: number;
  newProducts?: number;
  updatedProducts?: number;
  duration?: number;
  error?: string;
}

/**
 * Trigger manual products sync from Archibald
 */
export async function syncProducts(): Promise<SyncProductsResult> {
  const response = await fetch('/api/products/sync', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('archibald_jwt')}`,
    },
  });

  if (!response.ok) {
    if (response.status === 409) {
      throw new Error('Sincronizzazione gi√† in corso');
    }
    if (response.status === 401) {
      throw new Error('Sessione scaduta');
    }
    throw new Error(`Errore sincronizzazione: ${response.status}`);
  }

  return response.json();
}
```

**Acceptance Criteria:**
- Method sends JWT token
- Handles 409 (sync in progress)
- Handles 401 (session expired)
- Returns typed result
- Throws on error

**Commit:** `feat(19-03): add syncProducts API client method`

---

### Task 3: Add Manual Sync Button to Articoli Page
**Duration:** 15min

Update `archibald-web-app/frontend/src/pages/Articoli.tsx`.

**Implementation:**
```typescript
import React, { useState } from 'react';
import { syncProducts } from '../api/products';
import { ManualSyncBanner } from '../components/ManualSyncBanner';

export function Articoli() {
  const [syncStatus, setSyncStatus] = useState<'idle' | 'syncing' | 'success' | 'error'>('idle');
  const [syncMessage, setSyncMessage] = useState<string>('');
  const [isSyncing, setIsSyncing] = useState(false);

  const handleManualSync = async () => {
    setIsSyncing(true);
    setSyncStatus('syncing');
    setSyncMessage('‚è≥ Aggiornamento articoli in corso...');

    try {
      const result = await syncProducts();

      setSyncStatus('success');
      setSyncMessage(
        `‚úÖ Sincronizzazione completata: ${result.newProducts} nuovi, ${result.updatedProducts} aggiornati`
      );

      // Auto-hide success banner after 3s
      setTimeout(() => {
        setSyncStatus('idle');
        setSyncMessage('');
      }, 3000);

      // Refresh products list
      // ... existing code to refresh products ...
    } catch (error) {
      setSyncStatus('error');
      setSyncMessage(
        error instanceof Error
          ? `‚ùå Errore: ${error.message}`
          : '‚ùå Errore durante la sincronizzazione'
      );
    } finally {
      setIsSyncing(false);
    }
  };

  return (
    <div>
      {/* Manual sync banner */}
      <ManualSyncBanner
        status={syncStatus}
        message={syncMessage}
        onRetry={syncStatus === 'error' ? handleManualSync : undefined}
      />

      {/* Page header with sync button */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '20px',
      }}>
        <h1>Articoli</h1>

        {/* Manual sync button */}
        <button
          onClick={handleManualSync}
          disabled={isSyncing}
          style={{
            padding: '10px 20px',
            fontSize: '16px',
            cursor: isSyncing ? 'not-allowed' : 'pointer',
            opacity: isSyncing ? 0.6 : 1,
          }}
        >
          {isSyncing ? '‚è≥ Aggiornamento...' : 'üîÑ Aggiorna Articoli'}
        </button>
      </div>

      {/* ... rest of products list ... */}
    </div>
  );
}
```

**Acceptance Criteria:**
- üîÑ button shows spinner during sync
- ManualSyncBanner displays progress
- Yellow banner during sync
- Green banner on success (3s auto-hide)
- Red banner on error with retry
- Products list refreshes on success
- Button disabled during sync

**Commit:** `feat(19-03): add manual sync button and banner to Articoli page`

---

### Task 4: Test Manual Sync UI
**Duration:** 10min

Manual testing checklist.

**Test Steps:**
1. Navigate to Articoli page
2. Click "üîÑ Aggiorna Articoli" button
3. Observe yellow banner: "‚è≥ Aggiornamento articoli in corso..."
4. Wait ~60s for sync to complete
5. Observe green banner: "‚úÖ Sincronizzazione completata: X nuovi, Y aggiornati"
6. Verify banner auto-hides after 3s
7. Verify products list refreshed
8. Test error scenario (disconnect network)
9. Observe red banner with retry button
10. Test concurrent sync (409 error)

**Expected Results:**
- ‚úÖ Button shows spinner during sync
- ‚úÖ Yellow ‚Üí green ‚Üí auto-hide flow works
- ‚úÖ Red banner shows on error with retry
- ‚úÖ 409 error handled gracefully
- ‚úÖ Products list refreshes on success

**Documentation:**
Create `.planning/phases/19-products-sync-analysis-optimization/19-03-TEST-RESULTS.md` documenting test results.

**Commit:** `docs(19-03): add manual sync UI test results`

---

## Verification

### Manual Checkpoint

**Test Procedure:**
1. Start backend: `cd archibald-web-app/backend && npm run dev`
2. Start frontend: `cd archibald-web-app/frontend && npm run dev`
3. Login to app
4. Navigate to Articoli page
5. Click "üîÑ Aggiorna Articoli"
6. Observe sync flow

**Expected Behavior:**
- Button shows "‚è≥ Aggiornamento..." with spinner
- Yellow banner appears: "‚è≥ Aggiornamento articoli in corso..."
- Sync completes in ~60s
- Green banner appears: "‚úÖ X nuovi, Y aggiornati"
- Banner auto-hides after 3s
- Products list refreshed

**Error Scenarios:**
- Network error ‚Üí red banner with retry
- Concurrent sync ‚Üí "Sincronizzazione gi√† in corso"
- Session expired ‚Üí 401, redirect to login

## Success Criteria

- [ ] POST /api/products/sync endpoint created (JWT-protected)
- [ ] API client syncProducts() method added
- [ ] Manual sync button added to Articoli page
- [ ] ManualSyncBanner integrated
- [ ] Yellow ‚Üí green ‚Üí auto-hide flow working
- [ ] Red banner shows on error with retry
- [ ] 409 concurrent sync handled
- [ ] Products list refreshes on success
- [ ] Test results documented
- [ ] All commits atomic with proper messages

## Output

**Files Created:**
- `.planning/phases/19-products-sync-analysis-optimization/19-03-TEST-RESULTS.md`

**Files Modified:**
- `archibald-web-app/backend/src/index.ts` (add POST /api/products/sync)
- `archibald-web-app/frontend/src/api/products.ts` (add syncProducts method)
- `archibald-web-app/frontend/src/pages/Articoli.tsx` (add manual sync UI)

**Commits:** 4 atomic commits

**Next:** Plan 19-04 (Background Sync Scheduler & Monitoring)
