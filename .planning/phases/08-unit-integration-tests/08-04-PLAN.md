---
phase: 08-unit-integration-tests
plan: 04
type: execute
---

<objective>
Create integration tests for WebSocket events using a real HTTP server and WebSocket clients — verifying broadcast delivery, event replay on reconnect, transient event filtering, and multi-user isolation.

Purpose: Verify the WebSocket server (from Phase 5) delivers all event types correctly over real network connections, not just through mock objects.
Output: WebSocket integration test file with real server/client tests covering broadcast, replay, and isolation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-unit-integration-tests/08-CONTEXT.md
@.planning/phases/08-unit-integration-tests/08-RESEARCH.md

**Source files:**
@archibald-web-app/backend/src/realtime/websocket-server.ts
@archibald-web-app/backend/src/realtime/websocket-server.spec.ts

**Prior decisions:**
- Events emitted after res.json() to guarantee DB write confirmed before notification
- Broadcast calls wrapped in try/catch — failures never affect HTTP responses
- operationType (not type) in WebSocketMessage payload to avoid collision
- JOB_STARTED emitted before browser context acquisition
- EVENT_BUFFER_MAX_SIZE = 200, EVENT_BUFFER_MAX_AGE_MS = 5 min
- TRANSIENT_EVENT_TYPES = Set(['JOB_PROGRESS', 'CUSTOMER_UPDATE_PROGRESS'])
- Token extracted from ?token= query param or Authorization: Bearer header

**RESEARCH.md guidance:**
- Use real HTTP server on port 0 (random) — avoid hardcoded ports
- Use ws library as client (already in dependencies)
- Close ALL client connections in afterAll/afterEach with ws.terminate() (not ws.close())
- Wrap WS events in Promises for clean async/await test flow
- Watch for connection leaks causing process hang
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocket integration test with real server — broadcast delivery</name>
  <files>archibald-web-app/backend/src/realtime/websocket-server.integration.spec.ts</files>
  <action>
Create a new integration test file. Use real http.createServer + real WebSocket.Server + real ws client connections.

**Test infrastructure (in describe block):**
- beforeAll: create http.createServer(), create wsServer via createWebSocketServer with real WebSocket.Server and mock verifyToken
- Listen on port 0 (random)
- Helper: connectClient(userId, token?) returns Promise&lt;WebSocket&gt; that resolves on 'open'
- Helper: waitForMessage(ws) returns Promise&lt;WebSocketMessage&gt; that resolves on next 'message'
- afterAll: terminate all clients, shutdown wsServer, close http server
- afterEach: clean up any clients created during test

**Test cases:**

1. **Authenticated connection:**
   - Connect with valid token via ?token=valid-token query param
   - Verify connection is established (ws.readyState === OPEN)
   - Verify verifyToken was called with the token

2. **Broadcast to single user:**
   - Connect client as user-1
   - Call wsServer.broadcast('user-1', { type: 'JOB_COMPLETED', payload: { jobId: 'j1', operationType: 'SUBMIT_ORDER' }, timestamp })
   - Verify client receives message with correct shape
   - Assert: received.type === 'JOB_COMPLETED', received.payload.jobId === 'j1'

3. **All 4 processor event types delivered:**
   - Test JOB_STARTED, JOB_PROGRESS, JOB_COMPLETED, JOB_FAILED
   - For each: broadcast → verify client receives with correct type and payload shape

4. **Broadcast to non-existent user — no error:**
   - broadcast('non-existent-user', event) does not throw
   - No client receives the message

5. **broadcastToAll:**
   - Connect 2 clients (user-1, user-2)
   - Call wsServer.broadcastToAll(event)
   - Both clients receive the message
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/realtime/websocket-server.integration.spec.ts</verify>
  <done>Integration test file created. Authenticated connection tested. Broadcast delivery to single user works over real WS. All 4 event types delivered. broadcastToAll reaches all clients. No connection leaks (process exits cleanly).</done>
</task>

<task type="auto">
  <name>Task 2: Test event replay, transient filtering, and multi-user isolation</name>
  <files>archibald-web-app/backend/src/realtime/websocket-server.integration.spec.ts</files>
  <action>
Add the following test scenarios to the integration test file:

**Event replay on reconnect:**
- Connect client as user-1
- Broadcast 3 events to user-1 (JOB_STARTED, JOB_COMPLETED, another JOB_COMPLETED)
- Record timestamp of first event
- Disconnect client
- Reconnect with ?lastEventTs={timestamp of 1st event}
- Verify client receives only events AFTER the timestamp (2 events, not 3)

**Transient event filtering:**
- Broadcast a JOB_PROGRESS event (transient type) to user-1
- Disconnect and reconnect with ?lastEventTs before the event
- Verify JOB_PROGRESS is NOT replayed (it's in TRANSIENT_EVENT_TYPES)
- Contrast: broadcast a JOB_COMPLETED (non-transient), verify it IS replayed

**Multi-user broadcast isolation:**
- Connect client-A as user-1 and client-B as user-2
- Broadcast event targeted at user-1
- Verify client-A receives the event
- Verify client-B does NOT receive it (use a short timeout with Promise.race)

**Multiple clients same user:**
- Connect 2 clients both as user-1
- Broadcast event to user-1
- Both clients receive the event

**Connection cleanup:**
- Ensure afterAll terminates all ws clients with ws.terminate()
- Verify the test process exits cleanly (no hanging connections)

For "does NOT receive" assertions, use Promise.race with a short setTimeout (100ms) that resolves to a sentinel value, vs the message promise. If timeout wins, no message was received.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/realtime/websocket-server.integration.spec.ts</verify>
  <done>Event replay on reconnect tested (only newer events replayed). Transient events not replayed. Multi-user isolation verified. Multiple clients same user both receive. No connection leaks.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test --prefix archibald-web-app/backend -- --run src/realtime/websocket-server.integration.spec.ts` — all tests pass
- [ ] `npm run build --prefix archibald-web-app/backend` — TypeScript compiles
- [ ] Process exits cleanly after tests (no hanging connections)
- [ ] No test regressions: `npm test --prefix archibald-web-app/backend` — full suite passes
</verification>

<success_criteria>

- WebSocket integration test file created with real server/client
- Authenticated connection over real network works
- All 4 event types delivered correctly
- Event replay on reconnect works (filters by timestamp)
- Transient events not replayed
- Multi-user isolation verified
- Multiple clients same user both receive
- No connection leaks, process exits cleanly
- No regressions in full test suite
- TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/08-unit-integration-tests/08-04-SUMMARY.md`
</output>
