---
phase: 08-unit-integration-tests
plan: 02
type: execute
---

<objective>
Expand unit test coverage for the agent lock — acquisition logic, preemptable detection, release ownership verification, setStopCallback wiring, and getAllActive copy semantics.

Purpose: Verify the core concurrency control mechanism works correctly in all combinations, especially the preemptable detection logic that gates write-over-sync preemption.
Output: Comprehensive agent-lock.spec.ts with parametrized preemptable tests and edge case coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-unit-integration-tests/08-CONTEXT.md
@.planning/phases/08-unit-integration-tests/08-RESEARCH.md

**Source files:**
@archibald-web-app/backend/src/operations/agent-lock.ts
@archibald-web-app/backend/src/operations/agent-lock.spec.ts
@archibald-web-app/backend/src/operations/operation-types.ts

**Prior decisions:**
- release returns boolean synchronously (no async race in finally)
- inUseContexts as in-memory Set (single-process, no distributed lock)
- Preemptable: isScheduledSync(existing) && isWriteOperation(incoming)
- markInUse/markIdle optional in BrowserPoolLike for backward compat

**RESEARCH.md guidance:**
- Use test.each for parametrized preemptable combos
- Follow existing DI patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand lock acquisition and preemptable detection tests</name>
  <files>archibald-web-app/backend/src/operations/agent-lock.spec.ts</files>
  <action>
Read the existing spec file. Add the following test scenarios if missing:

**Acquire — basic flow:**
- Empty slot → acquired: true (happy path)
- Slot occupied → acquired: false with activeJob details
- Different userId → independent slots, both acquired: true
- Same userId, same jobId → should return acquired: true (re-entrant, already holding)

**Preemptable detection — parametrized with test.each:**
Use ALL relevant OperationType values from operation-types.ts. Test matrix:

| Active Type | Incoming Type | Expected preemptable |
|-------------|--------------|---------------------|
| SYNC_CUSTOMERS | SUBMIT_ORDER | true |
| SYNC_ORDERS | EDIT_ORDER | true |
| SYNC_PRODUCTS | DELETE_ORDER | true |
| SYNC_PRICES | SEND_TO_VERONA | true |
| SUBMIT_ORDER | SYNC_CUSTOMERS | false |
| SUBMIT_ORDER | EDIT_ORDER | false |
| SYNC_CUSTOMERS | SYNC_ORDERS | false |
| SYNC_DDT | CREATE_CUSTOMER | true |

Use test.each with the table above. Each row creates a lock with active type, then attempts acquire with incoming type, and asserts preemptable value.

Verify the AcquireResult shape:
- acquired: false → must have activeJob: { jobId, type } and preemptable: boolean
- acquired: true → must be exactly { acquired: true } (no extra fields)
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/operations/agent-lock.spec.ts</verify>
  <done>All preemptable combinations tested via test.each. Acquire happy path, multi-user independence, and result shapes verified.</done>
</task>

<task type="auto">
  <name>Task 2: Expand release, setStopCallback, getActive, getAllActive tests</name>
  <files>archibald-web-app/backend/src/operations/agent-lock.spec.ts</files>
  <action>
Read the existing spec and add the following test scenarios if missing:

**Release:**
- release with correct userId+jobId → returns true, slot freed
- release with wrong jobId → returns false, slot NOT freed (ownership check)
- release with non-existent userId → returns false (no-op)
- After release, acquire succeeds for same userId

**setStopCallback:**
- setStopCallback attaches requestStop to ActiveJob
- After setStopCallback, acquire (preemptable) returns activeJob with requestStop function
- setStopCallback on non-existent userId → no error (silent no-op)
- setStopCallback overwrites previous callback

**getActive:**
- getActive returns ActiveJob for occupied slot
- getActive returns undefined for empty slot
- getActive returns same reference as internal state (not a copy)

**getAllActive:**
- getAllActive returns a Map copy (modifying returned map doesn't affect internal state)
- getAllActive reflects current state (after acquire/release cycles)
- getAllActive returns empty Map when no locks held

Verify getAllActive copy semantics: modify returned Map, then call getAllActive again — original should be unchanged.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/operations/agent-lock.spec.ts</verify>
  <done>Release ownership check tested (correct/wrong/missing jobId). setStopCallback wiring tested (attach, overwrite, no-op). getAllActive copy semantics verified.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test --prefix archibald-web-app/backend -- --run src/operations/agent-lock.spec.ts` — all tests pass
- [ ] `npm run build --prefix archibald-web-app/backend` — TypeScript compiles
- [ ] No test regressions: `npm test --prefix archibald-web-app/backend` — full suite passes
</verification>

<success_criteria>

- All new and existing agent-lock tests pass
- Preemptable detection tested for all relevant type combinations via test.each
- Release ownership verification tested (correct, wrong, missing jobId)
- setStopCallback wiring tested (attach, overwrite, no-op)
- getAllActive copy semantics verified
- No regressions in full test suite
- TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/08-unit-integration-tests/08-02-SUMMARY.md`
</output>
