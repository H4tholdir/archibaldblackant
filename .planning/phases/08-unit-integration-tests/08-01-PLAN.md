---
phase: 08-unit-integration-tests
plan: 01
type: execute
---

<objective>
Expand unit test coverage for the operation processor — preemption flow, timeout handling, shouldStop bridge, and WebSocket event broadcasting.

Purpose: Verify that the critical fixes from Phase 2 (preemption, timeout, shouldStop) and Phase 5 (broadcast events) work correctly in the processor.
Output: Comprehensive operation-processor.spec.ts covering all edge cases of the preemption/timeout/broadcast logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-unit-integration-tests/08-CONTEXT.md
@.planning/phases/08-unit-integration-tests/08-RESEARCH.md

**Source files:**
@archibald-web-app/backend/src/operations/operation-processor.ts
@archibald-web-app/backend/src/operations/operation-processor.spec.ts
@archibald-web-app/backend/src/operations/operation-types.ts
@archibald-web-app/backend/src/operations/agent-lock.ts

**Prior decisions:**
- preemptionConfig and getTimeout injectable in ProcessorDeps for testability without fake timers
- cancelJob + polling loop (max 30s) for reliable preemption
- Promise.race between handler and AbortController timeout
- UnrecoverableError on AbortError to prevent BullMQ retry
- Exponential backoff: Math.min(2000 * 2^(count-1), 30000) for re-enqueue
- JOB_STARTED emitted before browser context acquisition
- operationType (not type) in WebSocket payload to avoid collision
- onEmit optional in OperationHandler for backward compat

**RESEARCH.md guidance:**
- Use vi.useFakeTimers() for all timer-related tests (avoid flaky async races)
- Use existing DI patterns (createMockDeps, vi.fn()) — don't introduce new helpers
- Test shouldStop with datasets >10 items if testing DB loop checkpoint
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand preemption flow and re-enqueue tests</name>
  <files>archibald-web-app/backend/src/operations/operation-processor.spec.ts</files>
  <action>
Read the existing spec file to identify what's already tested. Add the following test scenarios if missing:

**Preemption flow (lock contention → preemptable → acquire on retry):**
- Lock not acquired, preemptable=true → calls cancelJob on active job, calls requestStop, polls acquire with pollIntervalMs, succeeds on 2nd attempt → runs handler → success
- Lock not acquired, preemptable=true → polls but timeout exceeds → re-enqueues with exponential backoff delay
- Lock not acquired, preemptable=false → immediately re-enqueues with backoff (no polling)

**Re-enqueue with exponential backoff:**
- First re-enqueue: delay = 2000ms (2s × 2^0)
- Second re-enqueue (_requeueCount=1): delay = 4000ms (2s × 2^1)
- Verify _requeueCount is incremented in re-enqueued job data
- Verify backoff caps at 30000ms

**Lock release in finally block:**
- Handler success → lock released with correct userId+jobId
- Handler throws → lock still released in finally
- Lock release with mismatched jobId returns false (no-op)

Use vi.useFakeTimers() and vi.advanceTimersByTimeAsync() for polling tests. Use injectable preemptionConfig: { pollIntervalMs: 10, timeoutMs: 50 } for fast tests.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/operations/operation-processor.spec.ts</verify>
  <done>All preemption/re-enqueue tests pass. Cover: preemptable acquire-on-retry, timeout re-enqueue, non-preemptable re-enqueue, backoff calculation, lock release in finally.</done>
</task>

<task type="auto">
  <name>Task 2: Expand timeout + shouldStop + broadcast event tests</name>
  <files>archibald-web-app/backend/src/operations/operation-processor.spec.ts</files>
  <action>
Read the existing spec and add the following test scenarios if missing:

**Handler timeout:**
- Handler takes longer than getTimeout(type) → AbortController fires → UnrecoverableError thrown
- Broadcast JOB_FAILED event on timeout with correct payload shape { type: 'JOB_FAILED', payload: { jobId, operationType, error }, timestamp }
- Lock released after timeout

**shouldStop bridge (AbortSignal → boolean):**
- Signal not aborted → handler receives shouldStop returning false
- Signal aborted during handler → shouldStop returns true
- Verify addEventListener called with { once: true } to prevent memory leaks

**Broadcast events through processor lifecycle:**
- JOB_STARTED emitted BEFORE browser context acquisition (before acquireContext)
- JOB_PROGRESS emitted on each onProgress callback from handler
- JOB_COMPLETED emitted after successful handler with result data
- JOB_FAILED emitted on handler error
- All events have { type, payload: { jobId, operationType, ... }, timestamp } shape

**onEmit callback:**
- Handler with onEmit → processor wraps broadcast(userId, event) and passes to handler
- Handler without onEmit → no error (backward compat)

Use vi.useFakeTimers() for timeout tests. Verify broadcast mock called with correct event shapes using expect.objectContaining.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/operations/operation-processor.spec.ts</verify>
  <done>All timeout/shouldStop/broadcast tests pass. Cover: timeout fires UnrecoverableError, JOB_FAILED on timeout, shouldStop bridge, all 4 broadcast event types with correct shapes, onEmit callback wiring.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test --prefix archibald-web-app/backend -- --run src/operations/operation-processor.spec.ts` — all tests pass
- [ ] `npm run build --prefix archibald-web-app/backend` — TypeScript compiles
- [ ] No test regressions: `npm test --prefix archibald-web-app/backend` — full suite passes
</verification>

<success_criteria>

- All new and existing operation-processor tests pass
- Preemption flow fully tested (preemptable + non-preemptable + timeout)
- Re-enqueue with exponential backoff tested
- Handler timeout → UnrecoverableError tested
- shouldStop AbortSignal bridge tested
- All 4 broadcast event types tested with correct shapes
- onEmit callback tested
- No regressions in full test suite
- TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/08-unit-integration-tests/08-01-SUMMARY.md`
</output>
