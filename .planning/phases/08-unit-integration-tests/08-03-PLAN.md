---
phase: 08-unit-integration-tests
plan: 03
type: execute
---

<objective>
Expand unit test coverage for sync handlers — shouldStop interruption at all 4 checkpoints, shouldSkipSync validation, progress callbacks, and error handling across all sync handler types.

Purpose: Verify the shouldStop flow (from Phase 2) and count validation gate (from Phase 4) work correctly in all sync handlers.
Output: Comprehensive handler spec files covering interruption, progress, and error paths.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-unit-integration-tests/08-CONTEXT.md
@.planning/phases/08-unit-integration-tests/08-RESEARCH.md

**Source files:**
@archibald-web-app/backend/src/operations/handlers/sync-customers.ts
@archibald-web-app/backend/src/operations/handlers/sync-customers.spec.ts
@archibald-web-app/backend/src/operations/handlers/sync-orders.ts
@archibald-web-app/backend/src/operations/handlers/sync-orders.spec.ts
@archibald-web-app/backend/src/operations/handlers/sync-products.ts
@archibald-web-app/backend/src/operations/handlers/sync-products.spec.ts
@archibald-web-app/backend/src/operations/handlers/sync-prices.ts
@archibald-web-app/backend/src/operations/handlers/sync-prices.spec.ts
@archibald-web-app/backend/src/sync/services/customer-sync.ts

**Prior decisions:**
- AbortSignal-to-boolean bridge via addEventListener with { once: true }
- shouldStop checked at 4 checkpoints: start, download, parse, every 10th record in DB loop
- shouldSkipSync as pure function: 0-result skip, >50% drop skip when >10 existing
- Protective skip returns success: true with warnings (not error) to avoid BullMQ retry
- SyncStoppedError defined in customer-sync.ts, re-imported by all other sync services

**RESEARCH.md guidance:**
- Use datasets of 15-20 records to trigger DB loop shouldStop checkpoint (every 10 records)
- Test shouldSkipSync as pure function with parametrized edge cases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand sync-customers handler tests</name>
  <files>archibald-web-app/backend/src/operations/handlers/sync-customers.spec.ts</files>
  <action>
Read the existing spec file. Add the following test scenarios if missing:

**shouldStop interruption via AbortSignal:**
- Create an AbortController, pass signal to handler context
- Abort the signal at different timing points and verify handler returns early with success: false
- Test that signal.addEventListener is called with { once: true } (verify via mock signal)

**shouldSkipSync pure function tests (parametrized with test.each):**
These test the exported shouldSkipSync function directly:

| currentCount | parsedCount | Expected |
|-------------|-------------|----------|
| 0 | 0 | { skip: true, warning: contains "0 results" } |
| 0 | 10 | { skip: false } (first sync, always proceed) |
| 20 | 5 | { skip: true, warning: contains "drop" } (>50% drop with >10 existing) |
| 20 | 15 | { skip: false } (only 25% drop, within tolerance) |
| 5 | 2 | { skip: false } (<10 existing, no drop check) |
| 10 | 4 | { skip: true, warning: contains "drop" } (exactly 10 existing, >50% drop) |

**Progress callbacks:**
- onProgress called with incremental counts during sync
- Verify onProgress receives { customersProcessed, ... } shape

**Error handling:**
- parsePdf throws → handler returns success: false with error message
- downloadPdf throws → handler returns success: false with error message
- cleanupFile always called (even on error)
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/operations/handlers/sync-customers.spec.ts</verify>
  <done>shouldStop interruption tested with AbortSignal. shouldSkipSync edge cases parametrized (6+ cases). Progress callback shape verified. Error paths tested with cleanup guarantee.</done>
</task>

<task type="auto">
  <name>Task 2: Expand sync-orders, sync-products, sync-prices handler tests</name>
  <files>archibald-web-app/backend/src/operations/handlers/sync-orders.spec.ts, archibald-web-app/backend/src/operations/handlers/sync-products.spec.ts, archibald-web-app/backend/src/operations/handlers/sync-prices.spec.ts</files>
  <action>
Read the existing spec files for all 3 handlers. Add the following test scenarios where missing:

**For each handler (sync-orders, sync-products, sync-prices):**

1. **shouldStop interruption:**
   - Create AbortController, abort during handler execution
   - Verify handler returns success: false (not an error/throw)
   - Verify SyncStoppedError is caught internally (not propagated)

2. **Error handling:**
   - parsePdf/downloadPdf throws → handler catches and returns success: false with error
   - cleanupFile called in all paths (success, error, stop)

3. **Handler-specific tests:**

   **sync-orders:**
   - userId passed through to syncOrders (user-scoped, not service-account)
   - Verify result shape includes ordersProcessed, ordersInserted, ordersUpdated, ordersDeleted

   **sync-products:**
   - Uses 'service-account' as userId (not user-scoped)
   - Verify result shape includes productsProcessed, newProducts, updatedProducts

   **sync-prices:**
   - Uses 'service-account' as userId (not user-scoped)
   - Verify result shape includes pricesProcessed, pricesInserted, pricesUpdated, pricesSkipped

Follow the same mock pattern used in sync-customers handler tests. Each handler's factory accepts (deps, createBot) — mock createBot to return a mock bot that resolves downloadPdf.
  </action>
  <verify>npm test --prefix archibald-web-app/backend -- --run src/operations/handlers/sync-orders.spec.ts && npm test --prefix archibald-web-app/backend -- --run src/operations/handlers/sync-products.spec.ts && npm test --prefix archibald-web-app/backend -- --run src/operations/handlers/sync-prices.spec.ts</verify>
  <done>All 3 handler specs pass. shouldStop interruption tested. Error handling with cleanup verified. Handler-specific result shapes verified. userId scoping tested (user-scoped vs service-account).</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 sync handler spec files pass individually
- [ ] `npm run build --prefix archibald-web-app/backend` — TypeScript compiles
- [ ] No test regressions: `npm test --prefix archibald-web-app/backend` — full suite passes
</verification>

<success_criteria>

- All sync handler tests pass
- shouldStop interruption tested in all 4 handlers
- shouldSkipSync edge cases parametrized (6+ cases)
- Progress callbacks tested
- Error handling with cleanup guarantee tested
- Handler-specific result shapes and userId scoping verified
- No regressions in full test suite
- TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/08-unit-integration-tests/08-03-SUMMARY.md`
</output>
