---
phase: 08-unit-integration-tests
plan: 05
type: execute
---

<objective>
Create integration tests for all 4 sync services against a real PostgreSQL database — verifying insert, update, delete, hash-based change detection, composite keys, and shouldStop interruption with actual DB state.

Purpose: Verify sync services (from Phases 2-4) work correctly with real PostgreSQL, not just mock pool. Confirm data integrity, hash detection, and cascade deletes against real DB constraints.
Output: Test DB infrastructure + integration tests for customer-sync, order-sync, product-sync, price-sync.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-unit-integration-tests/08-CONTEXT.md
@.planning/phases/08-unit-integration-tests/08-RESEARCH.md

**Source files:**
@archibald-web-app/backend/src/sync/services/customer-sync.ts
@archibald-web-app/backend/src/sync/services/order-sync.ts
@archibald-web-app/backend/src/sync/services/product-sync.ts
@archibald-web-app/backend/src/sync/services/price-sync.ts
@archibald-web-app/backend/src/db/pool.ts
@archibald-web-app/backend/src/db/migrate.ts
@archibald-web-app/backend/src/db/migrations/

**Prior decisions:**
- PostgreSQL via pg pool (D-1 from CLAUDE.md)
- SHA-256 hashing for change detection (Phase 6)
- computeOrderHash uses minimal OrderHashInput type
- shouldStop checked every 10 records in DB loop
- SyncStoppedError thrown on stop, caught by handler
- Customer sync: upsert by customer_profile + user_id, hash-based
- Order sync: delete stale orders, cascade to order_articles + order_state_history
- Product sync: upsert by id, no deletion
- Price sync: composite key (product_id, price_valid_from, COALESCE(price_qty_from, 0))

**RESEARCH.md guidance:**
- Use real local PostgreSQL with dedicated test DB (archibald_test)
- TRUNCATE CASCADE between test suites (not transaction rollback)
- Run real migrations via runMigrations() from migrate.ts
- Add npm script test:integration for separate execution
- Use datasets of 15-20 records to trigger shouldStop DB loop checkpoint
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test DB infrastructure and npm script</name>
  <files>archibald-web-app/backend/src/db/integration/test-db-setup.ts, archibald-web-app/backend/package.json</files>
  <action>
Create test DB setup infrastructure for integration tests against real PostgreSQL.

**1. Create src/db/integration/test-db-setup.ts:**

Export 3 functions:
- `setupTestDb()`: Creates a pool connected to TEST_DATABASE_URL (default: postgresql://localhost:5432/archibald_test). Runs all migrations via runMigrations(pool, loadMigrationFiles(migrationsDir)). Returns pool.
- `truncateAllTables(pool)`: Runs TRUNCATE CASCADE on all tables in shared, agents, system schemas EXCEPT system.migrations. This preserves migration state between tests while clearing data.
- `destroyTestDb(pool)`: Calls pool.end().

The TEST_DATABASE_URL env var allows overriding for CI. Default assumes local PG with archibald_test database already created.

**2. Add npm scripts to package.json:**
- `"test:integration": "vitest run src/**/*.integration.spec.ts"` — runs only integration tests
- `"test:unit": "vitest run --exclude '**/*.integration.spec.ts'"` — runs only unit tests
- Keep existing `"test": "vitest run"` unchanged (runs ALL tests)

**3. Add setup note:**
Integration tests require a local PostgreSQL database named `archibald_test`. Create it with:
`createdb archibald_test` (or `CREATE DATABASE archibald_test;` in psql).

Do NOT modify vitest.config.ts — use filename convention (.integration.spec.ts) and npm scripts for separation. This works with Vitest v1.x without needing the v2.x projects feature.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend (TypeScript compiles test-db-setup.ts)</verify>
  <done>test-db-setup.ts created with setupTestDb, truncateAllTables, destroyTestDb. npm scripts test:integration and test:unit added. No vitest.config.ts changes needed.</done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for all 4 sync services</name>
  <files>archibald-web-app/backend/src/sync/services/customer-sync.integration.spec.ts, archibald-web-app/backend/src/sync/services/order-sync.integration.spec.ts, archibald-web-app/backend/src/sync/services/product-sync.integration.spec.ts, archibald-web-app/backend/src/sync/services/price-sync.integration.spec.ts</files>
  <action>
Create 4 integration test files, one per sync service. All use real PostgreSQL via test-db-setup.ts.

**Common pattern for each file:**
```
beforeAll: pool = await setupTestDb()
beforeEach: await truncateAllTables(pool)
afterAll: await destroyTestDb(pool)
```
Mock only downloadPdf (returns fake path), parsePdf (returns controlled data), cleanupFile (no-op). The pool is REAL.

**customer-sync.integration.spec.ts:**
1. First sync inserts new customers — verify rows in agents.customers with correct fields
2. Second sync with same data — no updates (hash unchanged), verify updatedCustomers=0
3. Sync with modified customer data — hash changes, verify updatedCustomers>0
4. Sync with fewer customers — deletedCustomers count matches removed records
5. shouldStop interruption with 15+ parsed customers — abort signal mid-loop, verify partial insert (some records exist, not all)

**order-sync.integration.spec.ts:**
1. Sync inserts orders — verify rows in agents.orders
2. Second sync with same data — no updates (hash match via computeOrderHash)
3. Sync with missing order — deletes stale order + cascades to order_articles
4. Hash-based update detection — modify order field, verify ordersUpdated count

**product-sync.integration.spec.ts:**
1. Sync inserts products — verify rows in shared.products
2. Second sync with same data — no updates (hash match)
3. Sync with modified product — verify upsert updates the row
4. Verify no deletion logic (products are never deleted, only upserted)

**price-sync.integration.spec.ts:**
1. Sync inserts prices — verify rows in shared.prices
2. Second sync with same data — pricesSkipped count matches (hash unchanged)
3. Sync with modified price — verify upsert on composite key (product_id, price_valid_from, COALESCE(price_qty_from, 0))
4. Multiple prices for same product (different valid_from) — all inserted as separate rows

For all tests: use realistic ParsedCustomer/ParsedOrder/ParsedProduct/ParsedPrice objects with required fields populated. Assert on DB state by querying real tables after sync.

IMPORTANT: These tests require a running local PostgreSQL with archibald_test database. If the database doesn't exist, tests should fail with a clear error message (not hang).
  </action>
  <verify>createdb archibald_test 2>/dev/null; npm test --prefix archibald-web-app/backend -- --run src/sync/services/customer-sync.integration.spec.ts src/sync/services/order-sync.integration.spec.ts src/sync/services/product-sync.integration.spec.ts src/sync/services/price-sync.integration.spec.ts</verify>
  <done>All 4 integration test files created and pass against real PostgreSQL. Customer: insert/update/delete/hash/shouldStop. Order: insert/update/delete/cascade. Product: upsert/no-delete. Price: composite key/skip-on-hash. All tests clean up via TRUNCATE between runs.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:integration --prefix archibald-web-app/backend` — all integration tests pass
- [ ] `npm run test:unit --prefix archibald-web-app/backend` — all unit tests still pass (no regressions)
- [ ] `npm run build --prefix archibald-web-app/backend` — TypeScript compiles
- [ ] Integration tests clean up properly (no leftover data between runs)
</verification>

<success_criteria>

- Test DB infrastructure created (setup, truncate, destroy)
- npm scripts added (test:integration, test:unit)
- 4 integration test files pass against real PostgreSQL
- Customer sync: insert, update (hash change), delete, shouldStop interruption tested
- Order sync: insert, update, delete with cascade tested
- Product sync: upsert, no-delete tested
- Price sync: composite key, skip-on-hash tested
- All unit tests still pass (no regressions)
- TypeScript compiles
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-unit-integration-tests/08-05-SUMMARY.md`
</output>
