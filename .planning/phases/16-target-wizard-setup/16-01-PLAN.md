---
phase: 16-target-wizard-setup
plan: 01
type: execute
---

<objective>
Create backend storage and API for agent monthly targets.

Purpose: Enable persistent storage of agent monthly sales targets with secure user-scoped access, supporting dashboard metrics and wizard setup.
Output: SQLite schema extension with monthlyTarget field + REST API endpoints for reading and updating targets.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-dashboard-homepage-ui/15-01-SUMMARY.md
@.planning/phases/15-dashboard-homepage-ui/15-02-SUMMARY.md
@.planning/phases/15-dashboard-homepage-ui/15-03-SUMMARY.md
@.planning/phases/15-dashboard-homepage-ui/15-04-SUMMARY.md

**Key files:**
@archibald-web-app/backend/src/user-database.ts
@archibald-web-app/backend/src/index.ts

**Tech stack available:**
- better-sqlite3 for user database (users.db)
- Express.js with JWT authentication middleware
- TypeScript strict mode
- Zod for request validation

**Established patterns:**
- Phase 06-02: UserDatabase singleton with schema versioning
- Phase 06-03: JWT authenticateJWT middleware with AuthRequest interface
- Phase 06-02: Admin endpoints pattern (POST/GET/PATCH/DELETE)
- Singleton pattern with getInstance() for database access
- Database migrations via version checks in constructor

**Constraining decisions:**
- JWT required for all user-specific API endpoints (Phase 06-06)
- User data stored in users.db SQLite (Phase 06-02)
- Currency stored as string (e.g., "EUR") for flexibility
- No admin authentication for target endpoints (user-scoped only)

**Current data availability:**
- UserDatabase has: id, username, fullName, whitelisted, createdAt, updatedAt
- JWT payload includes: userId, username, iat, exp
- Dashboard widgets expect: monthlyTarget (number), currency (string)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend users table schema with target fields</name>
  <files>
    archibald-web-app/backend/src/user-database.ts
  </files>
  <action>
    Add schema migration to UserDatabase for target storage:

    **Schema version 2:**
    - Add column: monthlyTarget REAL DEFAULT 0 (stores target as number, 0 means not set)
    - Add column: currency TEXT DEFAULT 'EUR' (ISO currency code)
    - Add column: targetUpdatedAt TEXT (ISO 8601 timestamp, null if never set)

    **Migration logic in constructor:**
    ```typescript
    const currentVersion = db.pragma('user_version', { simple: true });
    if (currentVersion < 2) {
      // Migrate to version 2: add target fields
      db.exec(`
        ALTER TABLE users ADD COLUMN monthlyTarget REAL DEFAULT 0;
        ALTER TABLE users ADD COLUMN currency TEXT DEFAULT 'EUR';
        ALTER TABLE users ADD COLUMN targetUpdatedAt TEXT;
        PRAGMA user_version = 2;
      `);
      logger.info('[UserDatabase] Migrated to schema v2 (target fields)');
    }
    ```

    **Update User interface:**
    ```typescript
    interface User {
      id: string;
      username: string;
      fullName: string;
      whitelisted: boolean;
      createdAt: string;
      updatedAt: string;
      monthlyTarget: number; // 0 = not set
      currency: string;
      targetUpdatedAt: string | null;
    }
    ```

    **Update rowToUser() method:**
    Include new fields in conversion, handle null targetUpdatedAt.

    Why REAL not INTEGER: Targets can be fractional (e.g., €12,500.50), REAL provides precision.
    Why 0 default: Distinguishes "not set" (0) from "set to zero" (explicit user choice), wizard checks monthlyTarget === 0.
  </action>
  <verify>
    npm run typecheck passes in backend directory

    Manual check:
    1. Delete backend/data/users.db (force fresh migration)
    2. Start backend: npm run dev
    3. Check logs for "Migrated to schema v2 (target fields)"
    4. Verify schema: sqlite3 backend/data/users.db ".schema users" shows new columns
  </verify>
  <done>
    UserDatabase schema v2 created with monthlyTarget, currency, targetUpdatedAt.
    User interface updated with new fields.
    rowToUser() includes target fields in conversion.
    Migration logic executes on startup.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create target API endpoints with JWT authentication</name>
  <files>
    archibald-web-app/backend/src/user-database.ts,
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Create CRUD methods in UserDatabase and API endpoints for target management:

    **UserDatabase methods:**

    ```typescript
    // Get user's target
    getUserTarget(userId: string): { monthlyTarget: number; currency: string; targetUpdatedAt: string | null } | null {
      const user = this.getUserById(userId);
      if (!user) return null;
      return {
        monthlyTarget: user.monthlyTarget,
        currency: user.currency,
        targetUpdatedAt: user.targetUpdatedAt
      };
    }

    // Update user's target
    updateUserTarget(userId: string, monthlyTarget: number, currency: string): boolean {
      const stmt = this.db.prepare(`
        UPDATE users
        SET monthlyTarget = ?, currency = ?, targetUpdatedAt = ?, updatedAt = ?
        WHERE id = ?
      `);
      const now = new Date().toISOString();
      const result = stmt.run(monthlyTarget, currency, now, now, userId);
      return result.changes > 0;
    }
    ```

    **API endpoints in index.ts:**

    ```typescript
    // GET /api/users/me/target - Get current user's target
    app.get('/api/users/me/target', authenticateJWT, (req: AuthRequest, res) => {
      const userId = req.userId!;
      const userDb = UserDatabase.getInstance();
      const target = userDb.getUserTarget(userId);

      if (!target) {
        return res.status(404).json({ error: 'User not found' });
      }

      res.json(target);
    });

    // PUT /api/users/me/target - Update current user's target
    app.put('/api/users/me/target', authenticateJWT, (req: AuthRequest, res) => {
      const userId = req.userId!;
      const { monthlyTarget, currency } = req.body;

      // Validation
      if (typeof monthlyTarget !== 'number' || monthlyTarget < 0) {
        return res.status(400).json({ error: 'monthlyTarget must be a non-negative number' });
      }
      if (typeof currency !== 'string' || currency.length !== 3) {
        return res.status(400).json({ error: 'currency must be a 3-letter ISO code (e.g., EUR)' });
      }

      const userDb = UserDatabase.getInstance();
      const success = userDb.updateUserTarget(userId, monthlyTarget, currency);

      if (!success) {
        return res.status(404).json({ error: 'User not found' });
      }

      logger.info('[API] User target updated', { userId, monthlyTarget, currency });
      res.json({ monthlyTarget, currency, targetUpdatedAt: new Date().toISOString() });
    });
    ```

    **Validation rules:**
    - monthlyTarget: non-negative number (0 allowed for "not set")
    - currency: 3-letter ISO code (e.g., "EUR", "USD")
    - JWT required (authenticateJWT middleware)

    Why GET not included in User object: Separation of concerns, target is optional metadata, separate endpoint cleaner API.
    Why PUT not POST: Idempotent operation (repeated calls same result), RESTful semantics for resource update.
  </action>
  <verify>
    npm run typecheck passes

    Manual API tests with curl:
    1. Login to get JWT:
       curl -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"username":"ikiA0930","password":"[password]"}'
       → Extract JWT from response

    2. GET target (should be default 0):
       curl http://localhost:3000/api/users/me/target -H "Authorization: Bearer [JWT]"
       → Returns {"monthlyTarget":0,"currency":"EUR","targetUpdatedAt":null}

    3. PUT target (set to 10000):
       curl -X PUT http://localhost:3000/api/users/me/target -H "Authorization: Bearer [JWT]" -H "Content-Type: application/json" -d '{"monthlyTarget":10000,"currency":"EUR"}'
       → Returns {"monthlyTarget":10000,"currency":"EUR","targetUpdatedAt":"2026-01-18T..."}

    4. GET target again (verify persistence):
       curl http://localhost:3000/api/users/me/target -H "Authorization: Bearer [JWT]"
       → Returns {"monthlyTarget":10000,"currency":"EUR","targetUpdatedAt":"2026-01-18T..."}

    5. Test validation (negative target):
       curl -X PUT http://localhost:3000/api/users/me/target -H "Authorization: Bearer [JWT]" -H "Content-Type: application/json" -d '{"monthlyTarget":-100,"currency":"EUR"}'
       → Returns 400 with error message

    6. Test validation (invalid currency):
       curl -X PUT http://localhost:3000/api/users/me/target -H "Authorization: Bearer [JWT]" -H "Content-Type: application/json" -d '{"monthlyTarget":10000,"currency":"EURO"}'
       → Returns 400 with error message
  </verify>
  <done>
    getUserTarget() and updateUserTarget() methods added to UserDatabase.
    GET /api/users/me/target endpoint created with JWT auth.
    PUT /api/users/me/target endpoint created with validation.
    Validation enforces non-negative number and 3-letter currency code.
    Manual curl tests pass for GET, PUT, validation errors.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] UserDatabase schema v2 migration executes on startup
- [ ] User interface includes monthlyTarget, currency, targetUpdatedAt fields
- [ ] GET /api/users/me/target returns user's target with JWT auth
- [ ] PUT /api/users/me/target updates target with validation
- [ ] Validation rejects negative targets and invalid currency codes
- [ ] Manual curl tests confirm API functionality
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- UserDatabase schema extended with target fields
- API endpoints functional with JWT authentication
- Validation prevents invalid target data
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/16-target-wizard-setup/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Target Setup Storage & API Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/user-database.ts` - Description
- `archibald-web-app/backend/src/index.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 16-02-PLAN.md (First-Time Wizard UI)
</output>
