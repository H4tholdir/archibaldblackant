---
phase: 16-target-wizard-setup
plan: 02
type: execute
---

<objective>
Create first-time wizard modal for mandatory target setup on initial login.

Purpose: Guide new users through monthly target setup with banking app-style onboarding flow, ensuring every agent has a configured target before using the dashboard.
Output: TargetWizard modal component with 3-step flow + trigger logic in App.tsx checking hasTarget flag.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-target-wizard-setup/16-01-SUMMARY.md

**Key files:**
@archibald-web-app/frontend/src/App.tsx
@archibald-web-app/frontend/src/components/BudgetWidget.tsx

**Tech stack available:**
- React 19 with hooks
- TypeScript strict mode
- Inline styles (Phase 10-06 decision)
- fetch API for backend communication
- localStorage for JWT (Phase 06-04)

**Established patterns:**
- Phase 06-04: Login modal with overlay blocking app access
- Phase 07-03: PIN wizard with 2-step confirmation (create â†’ confirm)
- Phase 15: Inline styles with smooth transitions
- Banking app UX patterns (step-by-step onboarding)

**Constraining decisions:**
- Wizard is blocking modal (full-screen overlay)
- Trigger condition: monthlyTarget === 0 (from GET /api/users/me/target)
- Currency options: EUR, USD, GBP (common European currencies)
- Input validation: positive number only (> 0)
- Wizard appears after successful login, before dashboard loads
- Target format: Intl.NumberFormat for currency display

**Current authentication flow:**
- App.tsx calls GET /api/auth/me on mount (restores session)
- If valid JWT, loads user context (username, fullName)
- Then renders Dashboard
- Need to insert: check target, show wizard if monthlyTarget === 0
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TargetWizard modal component with 3-step flow</name>
  <files>
    archibald-web-app/frontend/src/components/TargetWizard.tsx
  </files>
  <action>
    Create TargetWizard.tsx component with banking app-style wizard flow:

    **Props interface:**
    ```typescript
    interface TargetWizardProps {
      isOpen: boolean;
      onComplete: (target: number, currency: string) => void;
    }
    ```

    **Component structure (3 steps):**

    **Step 1: Welcome & Introduction**
    - Title: "Benvenuto in Archibald Black Ant! ðŸ‘‹"
    - Description: "Imposta il tuo obiettivo mensile per monitorare i tuoi progressi e raggiungere i tuoi traguardi."
    - Illustration: Target icon (ðŸŽ¯) large
    - Button: "Inizia" â†’ next step

    **Step 2: Target Input**
    - Title: "Qual Ã¨ il tuo obiettivo mensile?"
    - Currency dropdown: EUR (default), USD, GBP
    - Number input: placeholder "10000", min="1", step="100"
    - Helper text: "Questo obiettivo ti aiuterÃ  a visualizzare i tuoi progressi nella dashboard."
    - Buttons: "Indietro" (â† step 1), "Continua" (â†’ step 3, disabled if input invalid)

    **Step 3: Confirmation**
    - Title: "Conferma il tuo obiettivo"
    - Summary card showing:
      - "Obiettivo mensile: â‚¬10,000" (formatted with Intl.NumberFormat)
      - "Valuta: EUR"
      - Calendar icon: "A partire da oggi"
    - Description: "Potrai sempre modificare questo obiettivo dal tuo profilo."
    - Buttons: "Indietro" (â† step 2), "Conferma" (â†’ call onComplete)

    **Validation:**
    - Target must be positive number (> 0)
    - Currency must be one of: EUR, USD, GBP
    - Show inline error if validation fails: "L'obiettivo deve essere maggiore di zero"

    **Styling (inline, banking app pattern):**
    - Overlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 9999, display: 'flex', alignItems: 'center', justifyContent: 'center' }
    - Modal: { backgroundColor: '#fff', borderRadius: '16px', padding: '40px', maxWidth: '500px', width: '90%', boxShadow: '0 10px 40px rgba(0,0,0,0.2)' }
    - Title: { fontSize: '24px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '16px', textAlign: 'center' }
    - Description: { fontSize: '16px', color: '#7f8c8d', lineHeight: '1.6', textAlign: 'center', marginBottom: '32px' }
    - Input: { width: '100%', padding: '12px', fontSize: '18px', borderRadius: '8px', border: '2px solid #e0e0e0', marginBottom: '8px', transition: 'border 0.2s' }
    - Input focus: { border: '2px solid #3498db' }
    - Button primary: { backgroundColor: '#3498db', color: '#fff', padding: '12px 24px', borderRadius: '8px', border: 'none', fontSize: '16px', fontWeight: '600', cursor: 'pointer', transition: 'background 0.2s' }
    - Button primary hover: { backgroundColor: '#2980b9' }
    - Button secondary: { backgroundColor: 'transparent', color: '#7f8c8d', padding: '12px 24px', border: '1px solid #e0e0e0', borderRadius: '8px', fontSize: '16px', cursor: 'pointer' }
    - Step indicator (dots): 3 dots at top, current step highlighted (blue), past steps green, future steps gray

    **Currency formatting:**
    ```typescript
    const formatCurrency = (amount: number, currency: string) => {
      return new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: currency
      }).format(amount);
    };
    ```

    Why 3 steps not 1: Banking app pattern (Intesa, UniCredit) breaks complex setup into digestible chunks, reduces cognitive load, confirms intention (step 3 preview).
    Why blocking overlay: Critical setup must complete before dashboard access, prevents incomplete state.
  </action>
  <verify>
    npm run typecheck passes in frontend directory

    Manual check:
    1. Component renders without errors
    2. Step 1: Welcome screen displays with icon and "Inizia" button
    3. Step 2: Input fields for target and currency, validation works
    4. Step 3: Confirmation screen shows formatted target preview
    5. Navigation: "Indietro" goes back, "Continua" advances only if valid
    6. Currency dropdown shows EUR, USD, GBP options
    7. Number input rejects negative/zero values
    8. "Conferma" button calls onComplete with (target, currency)
  </verify>
  <done>
    TargetWizard component created with 3-step flow.
    Welcome, input, and confirmation steps implemented.
    Banking app-style UI with inline styles.
    Validation enforces positive target and valid currency.
    Step indicator shows progress (dots).
    Currency formatting with Intl.NumberFormat.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add wizard trigger logic in App.tsx on login</name>
  <files>
    archibald-web-app/frontend/src/App.tsx
  </files>
  <action>
    Integrate TargetWizard into App.tsx authentication flow:

    **Add state for wizard:**
    ```typescript
    const [showTargetWizard, setShowTargetWizard] = useState(false);
    const [hasTarget, setHasTarget] = useState(true); // assume true, check on mount
    ```

    **Check target after login (modify existing useEffect):**
    ```typescript
    useEffect(() => {
      const checkAuth = async () => {
        const token = localStorage.getItem('archibald_jwt');
        if (!token) {
          setIsAuthenticated(false);
          return;
        }

        try {
          // Existing: GET /api/auth/me
          const meResponse = await fetch('http://localhost:3000/api/auth/me', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!meResponse.ok) {
            // Token invalid, show login
            localStorage.removeItem('archibald_jwt');
            setIsAuthenticated(false);
            return;
          }

          const userData = await meResponse.json();
          setUser(userData);
          setIsAuthenticated(true);

          // NEW: Check if user has set target
          const targetResponse = await fetch('http://localhost:3000/api/users/me/target', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (targetResponse.ok) {
            const targetData = await targetResponse.json();
            const hasConfiguredTarget = targetData.monthlyTarget > 0;
            setHasTarget(hasConfiguredTarget);
            setShowTargetWizard(!hasConfiguredTarget); // Show wizard if target not set
          }
        } catch (error) {
          console.error('[App] Auth check failed:', error);
          setIsAuthenticated(false);
        }
      };

      checkAuth();
    }, []);
    ```

    **Add wizard handler:**
    ```typescript
    const handleTargetComplete = async (target: number, currency: string) => {
      const token = localStorage.getItem('archibald_jwt');
      if (!token) return;

      try {
        const response = await fetch('http://localhost:3000/api/users/me/target', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ monthlyTarget: target, currency })
        });

        if (response.ok) {
          console.log('[App] Target set successfully:', { target, currency });
          setHasTarget(true);
          setShowTargetWizard(false);
        } else {
          console.error('[App] Failed to set target:', await response.text());
          alert('Errore nel salvare l\'obiettivo. Riprova.');
        }
      } catch (error) {
        console.error('[App] Target set error:', error);
        alert('Errore di connessione. Riprova.');
      }
    };
    ```

    **Render wizard before dashboard:**
    ```typescript
    return (
      <div>
        {!isAuthenticated && <LoginModal onLoginSuccess={handleLoginSuccess} />}

        {isAuthenticated && showTargetWizard && (
          <TargetWizard
            isOpen={showTargetWizard}
            onComplete={handleTargetComplete}
          />
        )}

        {isAuthenticated && !showTargetWizard && (
          <Dashboard />
        )}
      </div>
    );
    ```

    **Flow:**
    1. User logs in â†’ GET /api/auth/me â†’ authenticated
    2. App checks GET /api/users/me/target â†’ monthlyTarget === 0
    3. App shows TargetWizard (blocking overlay)
    4. User completes wizard â†’ PUT /api/users/me/target
    5. App hides wizard, shows Dashboard

    Why check on every mount: User might logout/login on different device, target check ensures consistent state.
    Why blocking: Target is prerequisite for dashboard metrics (BudgetWidget, TargetVisualizationWidget require target prop).
  </action>
  <verify>
    npm run typecheck passes

    Manual test flow:
    1. Delete users.db to reset (force fresh user with target = 0)
    2. Start frontend: npm run dev
    3. Login with ikiA0930
    4. Verify: TargetWizard modal appears immediately after login
    5. Complete wizard: Enter target 10000, currency EUR, confirm
    6. Verify: Wizard disappears, Dashboard loads
    7. Logout and login again
    8. Verify: Wizard does NOT appear (target already set)
    9. Check backend logs: "User target updated" log present
    10. Check database: sqlite3 backend/data/users.db "SELECT monthlyTarget, currency FROM users WHERE username='ikiA0930';"
        â†’ Should show 10000, EUR
  </verify>
  <done>
    TargetWizard integrated in App.tsx authentication flow.
    useEffect checks target after login success.
    Wizard appears if monthlyTarget === 0.
    handleTargetComplete saves target via PUT /api/users/me/target.
    Wizard blocks dashboard access until target set.
    Logout/login flow respects existing target (no re-prompt).
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in frontend directory
- [ ] TargetWizard component renders with 3-step flow
- [ ] Step navigation works (Indietro/Continua buttons)
- [ ] Validation prevents zero/negative targets
- [ ] Currency dropdown shows EUR, USD, GBP
- [ ] Confirmation step shows formatted target preview
- [ ] App.tsx checks target on login
- [ ] Wizard appears if monthlyTarget === 0
- [ ] Wizard saves target and transitions to dashboard
- [ ] Returning users with target skip wizard
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- TargetWizard modal functional with banking app UX
- Wizard triggers automatically for users without target
- Target saved successfully via API
- Dashboard accessible only after target setup
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/16-target-wizard-setup/16-02-SUMMARY.md`:

# Phase 16 Plan 02: First-Time Wizard UI Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/frontend/src/components/TargetWizard.tsx` - Description
- `archibald-web-app/frontend/src/App.tsx` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 16-03-PLAN.md (Profile Target Editor)
</output>
