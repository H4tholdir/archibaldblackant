---
phase: 22-sync-orchestration-layer
plan: 03
type: checkpoint
---

<objective>
Verify complete sync orchestration with comprehensive testing including Smart Customer Sync.

Purpose: Validate mutex locking, priority queueing, staggered scheduling, health monitoring, and Smart Customer Sync multi-order workflow.
Output: Comprehensive checkpoint confirming orchestration layer functional with all 6 sync types and smart sync capabilities.
</objective>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete sync orchestration layer with coordination, scheduling, and Smart Customer Sync</what-built>
  <how-to-verify>
    ## Core Orchestration Tests

    1. Start backend
    2. Trigger multiple syncs simultaneously via API
    3. Verify only one sync runs at a time (mutex working)
    4. Verify queued syncs execute in priority order (orders=6 > customers=5 > ddt=4 > invoices=3 > prices=2 > products=1)
    5. Test staggered auto-sync with approved frequencies:
       - Orders: 10min (T+0)
       - Customers: 30min (T+5)
       - Prices: 30min (T+10)
       - Invoices: 30min (T+15)
       - DDT: 45min (T+20)
       - Products: 90min (T+30)
    6. Check GET /api/sync/status shows:
       - Current sync statuses for all 6 types
       - Aggregated health monitoring
       - Smart sync status (activeSessions, syncsPaused, safetyTimeoutActive)
    7. Verify all 6 sync types functional (customers, products, prices, orders, ddt, invoices)
    8. Simulate overlapping sync requests, confirm queueing
    9. Check logs show sync coordination messages

    ## Smart Customer Sync Tests

    10. **Single Order Workflow:**
        a. Navigate to /orders/new (order form)
        b. Verify Smart Customer Sync triggers automatically (check logs)
        c. Verify sync completes in 3-5 seconds (not 15-20s)
        d. Verify other syncs are paused during smart sync
        e. Fill out order form and save as draft
        f. Verify page stays on order form (does NOT navigate to /drafts)
        g. Verify success banner shows: "✅ Bozza salvata! (X bozze totali)"
        h. Click "Done" button
        i. Verify navigation to /drafts
        j. Verify other syncs resume after leaving order form

    11. **Multi-Order Workflow (Critical Test):**
        a. Navigate to /orders/new
        b. Create and save Order #1 as draft
        c. Verify stays on order form (page does NOT reload or navigate)
        d. Clear form or continue editing
        e. Create and save Order #2 as draft
        f. Verify stays on order form again
        g. Repeat for Orders #3, #4, #5
        h. Verify syncs remain paused throughout entire workflow
        i. Click "Done" button after 5th order
        j. Verify navigation to /drafts with all 5 drafts visible
        k. Verify other syncs resume only after clicking "Done"

    12. **Multi-Tab Session Tracking:**
        a. Open /orders/new in Tab 1
        b. Verify orderFormActiveSessions = 1
        c. Open /orders/new in Tab 2
        d. Verify orderFormActiveSessions = 2
        e. Close Tab 1
        f. Verify orderFormActiveSessions = 1 (syncs still paused)
        g. Close Tab 2
        h. Verify orderFormActiveSessions = 0 (syncs resume)

    13. **Safety Timeout Test:**
        a. Open /orders/new
        b. Leave page open without activity
        c. Wait 11 minutes
        d. Verify safety timeout triggers (check logs)
        e. Verify syncs auto-resume despite order form still being open
        f. Verify orderFormActiveSessions reset to 0

    14. **API Endpoint Tests:**
        a. POST /api/customers/smart-sync → verify fast customer sync
        b. POST /api/customers/resume-syncs → verify syncs resume
        c. GET /api/sync/schedule → verify returns approved frequencies
        d. GET /api/sync/status → verify includes smartSync status

    Success Criteria:
    - Mutex prevents overlaps
    - Priority queueing works (orders highest priority)
    - Staggered scheduling functional with approved frequencies
    - All 6 sync types managed
    - Smart Customer Sync completes in 3-5s
    - Draft save stays on page (no navigation)
    - Multi-order workflow smooth (create 5+ orders sequentially)
    - Session reference counting works across tabs
    - Safety timeout auto-resumes after 10 minutes
    - "Done" button provides explicit exit
    - Status API accurate and includes smart sync info
  </how-to-verify>
  <resume-signal>Type "approved" to continue</resume-signal>
</task>

</tasks>

<success_criteria>
- Mutex locking prevents overlapping syncs
- Priority queueing functional (orders=6 > customers=5 > ddt=4 > invoices=3 > prices=2 > products=1)
- Staggered scheduling works with approved frequencies (10min to 90min)
- All 6 sync types functional (customers, products, prices, orders, ddt, invoices)
- Smart Customer Sync triggers on order form entry
- Smart Customer Sync completes in 3-5 seconds (vs 15-20s full sync)
- Draft save stays on order form (enables multi-order workflow)
- Multi-order workflow verified (create 5+ orders sequentially without navigation)
- Session reference counting tracks multiple tabs correctly
- Safety timeout auto-resumes syncs after 10 minutes
- "Done" button provides explicit exit to /drafts
- Aggregated health monitoring accurate for all services
- Smart sync status exposed via API
- User verification passed for all scenarios
</success_criteria>

<output>
Create `.planning/phases/22-sync-orchestration-layer/22-03-SUMMARY.md`
</output>
