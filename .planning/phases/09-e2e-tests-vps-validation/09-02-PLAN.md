---
phase: 09-e2e-tests-vps-validation
plan: 02
type: execute
---

<objective>
Create E2E tests for login flow and page navigation.

Purpose: Verify that the authentication flow and all main pages are accessible and functional on the deployed PWA. This covers the most critical user entry point.
Output: `e2e/login-flow.spec.ts` and `e2e/navigation.spec.ts` test files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-tests-vps-validation/09-RESEARCH.md
@.planning/phases/09-e2e-tests-vps-validation/09-01-SUMMARY.md

# Auth and navigation components:
@archibald-web-app/frontend/src/components/LoginModal.tsx
@archibald-web-app/frontend/src/components/DashboardNav.tsx
@archibald-web-app/frontend/src/AppRouter.tsx
@archibald-web-app/frontend/playwright.vps.config.ts
@archibald-web-app/frontend/e2e/auth.setup.ts

**Selectors reference:**
- LoginModal: `#username`, `#password`, `button[type="submit"]` (text "Accedi" / "Autenticazione...")
- Error: `.error-message`
- Dashboard nav links by text: "Home", "Nuovo Ordine", "Ordini in Attesa", "Storico", "Clienti", "Articoli", "Profilo"
- Logout: link text "Logout" (calls `auth.logout()` then `window.location.href = '/'`)
- UnlockScreen: `.unlock-screen`, greeting `h2` in `.unlock-greeting`
- JWT: `localStorage.getItem('archibald_jwt')`
- Mobile: viewport < 768px uses hamburger menu

**Auth flow states (from AppRouter.tsx):**
1. Loading → LiquidLoader
2. UnlockScreen (has lastUser, not authenticated)
3. LoginModal (no lastUser or showLoginForm=true)
4. PinSetupWizard (needsPinSetup + tempCredentials)
5. TargetWizard (authenticated, no target set)
6. Authenticated app with BrowserRouter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login-flow.spec.ts — login verification</name>
  <files>archibald-web-app/frontend/e2e/login-flow.spec.ts</files>
  <action>
Create E2E test file for login flow verification. Tests use the auth storageState from setup (already logged in).

Test cases:

1. **"authenticated user sees dashboard"** — Navigate to `/`, verify dashboard page loads:
   - DashboardNav is visible (`nav` element)
   - Page title or heading contains "Dashboard" or "Home"-related content
   - No login modal visible (`.login-modal` should NOT exist)
   - JWT exists in localStorage: `page.evaluate(() => localStorage.getItem('archibald_jwt') !== null)`

2. **"login form works with valid credentials"** — Test fresh login (use a new context WITHOUT storageState):
   - Create new context via `test.use({ storageState: { cookies: [], origins: [] } })` or use a describe block with its own browser context
   - Use `browser.newContext()` to get a fresh context without storageState
   - Clear localStorage via `page.addInitScript(() => localStorage.clear())`
   - Navigate to `/`
   - Verify login modal appears: `#username` visible
   - Fill `#username` with env var `TEST_USER_USERNAME`
   - Fill `#password` with env var `TEST_USER_PASSWORD`
   - Click submit button: `button[type="submit"]`
   - Button text should change to "Autenticazione..." during loading
   - Wait for navigation to complete: `await page.waitForFunction(() => localStorage.getItem('archibald_jwt') !== null, { timeout: 60_000 })`
   - Verify dashboard loads (nav visible)

3. **"login form shows error for invalid credentials"** — Use fresh context without storageState:
   - Navigate to `/`
   - Fill `#username` with "invalid_user_test"
   - Fill `#password` with "wrong_password_test"
   - Click submit
   - Verify error message appears: `.error-message` becomes visible
   - Verify user stays on login form (`#username` still visible)

IMPORTANT:
- Use `test.describe.serial()` if tests must run in order
- Each test that needs unauthenticated state must use `browser.newContext()` to get a fresh browser context (NOT the one with storageState)
- Timeout for login should be 60s (Puppeteer backend)
- Do NOT use `waitForTimeout()` — use proper waits
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/e2e/login-flow.spec.ts`
- No `waitForTimeout()` calls (use proper waits)
- No hardcoded credentials
- TypeScript compiles
  </verify>
  <done>
- 3 test cases: authenticated dashboard, valid login, invalid login error
- All use proper selectors and waits
- Fresh contexts for unauthenticated tests
  </done>
</task>

<task type="auto">
  <name>Task 2: Create navigation.spec.ts — page accessibility verification</name>
  <files>archibald-web-app/frontend/e2e/navigation.spec.ts</files>
  <action>
Create E2E test file verifying all main pages are accessible and render correctly. These tests use the default storageState (already authenticated).

Test cases:

1. **"all main pages load without errors"** — Parameterized test visiting each route and verifying basic rendering:
   ```
   Routes to test:
   - / (Dashboard) — verify nav visible
   - /pending-orders — verify heading "Ordini in Attesa" or "Nessun ordine in attesa"
   - /orders — verify page renders (heading or table visible)
   - /customers — verify page renders
   - /products — verify page renders
   - /profile — verify page renders
   - /order — verify order form renders
   ```
   For each route: `page.goto(route)` → verify no error state → verify key element visible.
   Use `test.describe` with a loop or parameterized test for each route.

2. **"navigation links work from dashboard"** — From dashboard, click each nav link and verify correct page loads:
   - Navigate to `/`
   - Click link by text "Ordini in Attesa"
   - Verify URL changed to `/pending-orders`
   - Verify page content loaded
   - Navigate back to `/`
   - Click "Clienti" → verify `/customers`
   - Click "Articoli" → verify `/products`

3. **"logout redirects to login"** — Test logout flow:
   - Navigate to `/`
   - Verify authenticated (nav visible)
   - Handle `window.confirm()` dialog if logout triggers one: `page.on('dialog', d => d.accept())`
   - Click "Logout" link in navigation
   - Verify login form appears: `#username` visible after redirect
   - Verify JWT cleared: `localStorage.getItem('archibald_jwt')` is null

IMPORTANT:
- For navigation test, use desktop viewport (default) — links are directly visible
- Use `page.getByText()` or `page.locator('a', { hasText: '...' })` for nav links
- Some pages may show "loading" state first — wait for content, not just URL change
- Logout test needs a fresh login after (or run last in serial mode)
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/e2e/navigation.spec.ts`
- All 7+ routes tested
- Navigation clicks verified
- Logout flow tested
- No hardcoded credentials
  </verify>
  <done>
- Parameterized test covers all main routes
- Navigation from dashboard verified
- Logout flow verified with JWT clearance
- All tests use proper selectors and waits
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `login-flow.spec.ts` exists with 3 test cases
- [ ] `navigation.spec.ts` exists with 3 test cases
- [ ] No `waitForTimeout()` used (proper waits only)
- [ ] No hardcoded credentials
- [ ] All selectors match actual DOM (verified against component source)
- [ ] TypeScript type-check passes: `npm run type-check --prefix archibald-web-app/frontend`
</verification>

<success_criteria>

- All tasks completed
- Login flow E2E tests cover: authenticated state, fresh login, invalid credentials
- Navigation tests cover: all main routes, nav link clicks, logout
- Tests are robust with proper waits and timeouts
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-tests-vps-validation/09-02-SUMMARY.md`
</output>
