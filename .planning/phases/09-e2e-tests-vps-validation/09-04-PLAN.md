---
phase: 09-e2e-tests-vps-validation
plan: 04
type: execute
---

<objective>
Create multi-device sync E2E test and execute all tests on VPS.

Purpose: Verify real-time WebSocket sync between two devices and execute the entire E2E suite against the production VPS, reporting results.
Output: `e2e/multi-device-sync.spec.ts` test file + complete test execution report.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-tests-vps-validation/09-RESEARCH.md
@.planning/phases/09-e2e-tests-vps-validation/09-03-SUMMARY.md

# Multi-device helpers (existing pattern, but needs DOM-based updates):
@archibald-web-app/frontend/e2e/helpers/multi-device.ts

# Pending orders page (for sync verification):
@archibald-web-app/frontend/src/pages/PendingOrdersPage.tsx

# VPS access:
@VPS-ACCESS-CREDENTIALS.md

# VPS config:
@archibald-web-app/frontend/playwright.vps.config.ts

**Multi-device testing pattern (from RESEARCH.md):**
- Two independent browser contexts = two "devices"
- Both authenticated with same user (different deviceId)
- One creates/modifies data, other should see update via WebSocket
- Verify via DOM assertions (NOT IndexedDB — eliminated in Phase 1)

**WebSocket events (from Phase 5):**
- `PENDING_CREATED`, `PENDING_UPDATED`, `PENDING_DELETED`, `PENDING_SUBMITTED`
- Format: `{ type, payload, timestamp }`

**VPS details:**
- Host: formicanera.com (91.98.136.198)
- SSH key in VPS-ACCESS-CREDENTIALS.md
- Docker Compose stack: frontend (Nginx), backend (Node+Puppeteer), PostgreSQL, Redis, Nginx proxy, Prometheus, Grafana
- App accessible at: https://formicanera.com

**Execution approach:**
- SSH into VPS
- Option A: Docker Playwright image (recommended) — `docker run --rm --network archibald_archibald-net ...`
- Option B: Native install on VPS — `npx playwright install chromium --with-deps`
- Run tests with env vars for credentials
- Collect results and report
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-device-sync.spec.ts — real-time WebSocket sync</name>
  <files>archibald-web-app/frontend/e2e/multi-device-sync.spec.ts</files>
  <action>
Create E2E test file verifying real-time sync between two browser contexts (simulating two devices). Tests use storageState.

Test cases:

1. **"two devices see pending orders list"** — Both devices load pending orders page:
   - Create two browser contexts via `browser.newContext()`, both with same storageState
   - Set different deviceIds via `page.addInitScript()`: `localStorage.setItem('archibald_device_id', 'e2e-device-a')` and `e2e-device-b`
   - Both navigate to `/pending-orders`
   - Both wait for page to load
   - Verify both see the same count/content (heading text matches)

2. **"order created on device A appears on device B via WebSocket"** — Real-time sync test:
   - Device A and Device B both on `/pending-orders`
   - Get initial pending count on Device B (from heading text "Ordini in Attesa (N)" or by counting visible cards)
   - Device A creates a pending order via API: `pageA.request.post('/api/pending-orders', { data: {...} })`
   - Device A reloads or waits for its own page to update
   - Device B should receive WebSocket event and update UI — wait for:
     - Either: heading count increases (poll with `waitForFunction`)
     - Or: new order card appears in the list
   - Timeout: 10 seconds for WebSocket propagation
   - Verify Device B shows the new order WITHOUT manual refresh

3. **"order deleted on device A disappears from device B"** — Deletion sync:
   - Continue from test 2 (serial mode)
   - Device A deletes the order created above via API: `pageA.request.delete('/api/pending-orders/' + orderId)`
   - Device B should see the order disappear via WebSocket event
   - Wait for: count decreases or specific order card disappears
   - Timeout: 10 seconds
   - Clean up: close both contexts

IMPORTANT:
- Use `test.describe.serial()` for ordered execution
- Use `browser.newContext()` for each device (NOT the default `page` fixture)
- Set unique deviceIds to differentiate devices
- Both contexts need auth — load storageState: `browser.newContext({ storageState: 'playwright/.auth/user.json' })`
- Verify via DOM (heading text, visible cards), NOT via IndexedDB
- Clean up created orders in afterAll
- WebSocket sync may take 1-5 seconds — use reasonable timeouts
- If WebSocket is not working (sync doesn't happen), the test fails — that's exactly what we want to detect
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/e2e/multi-device-sync.spec.ts`
- Two separate browser contexts used
- Verification via DOM, NOT IndexedDB
- Test data cleaned up
- No waitForTimeout (proper waits for sync)
  </verify>
  <done>
- 3 test cases: parallel view, create sync, delete sync
- DOM-based verification (no IndexedDB)
- Serial execution, proper cleanup
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute all E2E tests on VPS and collect results</name>
  <files>N/A (execution task)</files>
  <action>
Execute the entire E2E test suite against the deployed PWA on VPS.

Steps:
1. Read VPS-ACCESS-CREDENTIALS.md for SSH key
2. Save SSH key to /tmp/archibald_vps with chmod 600
3. Check VPS connectivity: `ssh -i /tmp/archibald_vps deploy@91.98.136.198 'echo connected'`
4. Check app is running: `ssh ... 'curl -s -o /dev/null -w "%{http_code}" https://formicanera.com'` → should return 200

5. Copy test files to VPS:
   - `scp -i /tmp/archibald_vps -r archibald-web-app/frontend/e2e/ deploy@91.98.136.198:/tmp/e2e-tests/e2e/`
   - `scp -i /tmp/archibald_vps archibald-web-app/frontend/playwright.vps.config.ts deploy@91.98.136.198:/tmp/e2e-tests/`
   - `scp -i /tmp/archibald_vps archibald-web-app/frontend/package.json deploy@91.98.136.198:/tmp/e2e-tests/`

6. On VPS, set up Playwright and run tests:
   ```bash
   ssh -i /tmp/archibald_vps deploy@91.98.136.198 'bash -s' << 'REMOTE'
   cd /tmp/e2e-tests

   # Install Node.js if needed (check first)
   node --version || { echo "Node.js not available"; exit 1; }

   # Install Playwright
   npm install @playwright/test
   npx playwright install chromium --with-deps

   # Create auth directory
   mkdir -p playwright/.auth

   # Run tests with credentials
   TEST_USER_USERNAME="..." \
   TEST_USER_PASSWORD="..." \
   BASE_URL="https://formicanera.com" \
   npx playwright test --config=playwright.vps.config.ts 2>&1
   REMOTE
   ```

   NOTE: Get actual test credentials from VPS-ACCESS-CREDENTIALS.md or from the user. Do NOT hardcode — pass via env vars in the SSH command.

7. Collect and analyze results:
   - Parse test output for pass/fail counts
   - If failures: identify which tests failed and why
   - Copy HTML report back if useful: `scp -i /tmp/archibald_vps deploy@91.98.136.198:/tmp/e2e-tests/playwright-report/ ./`

8. Clean up VPS:
   - `ssh -i /tmp/archibald_vps deploy@91.98.136.198 'rm -rf /tmp/e2e-tests'`
   - `rm /tmp/archibald_vps`

IMPORTANT:
- If Docker approach is easier (Playwright Docker image available), use that instead of native install
- If Node.js is not available on VPS, use Docker approach
- Credentials must come from VPS-ACCESS-CREDENTIALS.md — NEVER hardcode
- If tests fail, report detailed failure information including screenshots/traces
- If VPS doesn't have enough resources, report the issue rather than retrying
  </action>
  <verify>
- All E2E tests executed on VPS
- Results collected and analyzed
- Pass/fail summary available
- VPS cleaned up after execution
- No credentials left on VPS
  </verify>
  <done>
- Complete E2E test suite executed against production VPS
- Results reported: X passed, Y failed, Z skipped
- Failures analyzed with root cause
- VPS cleaned up, no test artifacts left
- /tmp/archibald_vps SSH key cleaned up
  </done>
</task>

<task type="auto">
  <name>Task 3: Create execution report and update project state</name>
  <files>.planning/phases/09-e2e-tests-vps-validation/09-04-SUMMARY.md, .planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
Based on test execution results, create comprehensive report and update project state.

1. Create 09-04-SUMMARY.md with:
   - Test execution results (pass/fail per test file)
   - Failures analyzed: which flows work, which don't
   - Any bugs discovered during E2E testing
   - Recommendations for Phase 10 (Final Review)

2. Update STATE.md:
   - Current position: Phase 9 complete (or note remaining issues)
   - Add any new decisions or deferred issues from E2E testing
   - Update progress percentage

3. Update ROADMAP.md:
   - Mark Phase 9 plans as complete (checkboxes)
   - Update progress table
   - Note any findings that affect Phase 10

4. If tests found real bugs:
   - Document them in the summary
   - Assess severity: blocking Phase 10 or deferrable?
   - Add to deferred issues in STATE.md if not blocking

The report should give a clear picture of: "Is the PWA ready for production use after the 8 phases of refactoring?"
  </action>
  <verify>
- 09-04-SUMMARY.md created with test results
- STATE.md updated with Phase 9 status
- ROADMAP.md updated with Phase 9 progress
- Clear assessment of PWA readiness
  </verify>
  <done>
- Complete execution report with pass/fail analysis
- Project state updated
- Roadmap progress updated
- Clear next step for Phase 10
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `multi-device-sync.spec.ts` exists with 3 test cases
- [ ] All E2E tests executed on VPS
- [ ] Results documented
- [ ] STATE.md and ROADMAP.md updated
- [ ] VPS cleaned up (no test artifacts, no SSH keys in /tmp)
- [ ] Clear pass/fail report for all flows: login, navigation, orders, multi-device sync
</verification>

<success_criteria>

- All tasks completed
- Multi-device sync test verifies WebSocket works
- Full E2E suite executed against production VPS
- Results documented and analyzed
- Project state updated for Phase 10
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-tests-vps-validation/09-04-SUMMARY.md`

This is the LAST plan of Phase 9. Success criteria includes "Phase 9 complete."
</output>
