---
phase: 09-e2e-tests-vps-validation
plan: 03
type: execute
---

<objective>
Create E2E tests for order flow and data pages.

Purpose: Verify the core business flow — pending orders CRUD operations and data page accessibility (customers, products, sync status).
Output: `e2e/order-flow.spec.ts` and `e2e/data-pages.spec.ts` test files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-tests-vps-validation/09-RESEARCH.md
@.planning/phases/09-e2e-tests-vps-validation/09-02-SUMMARY.md

# Key pages for order flow:
@archibald-web-app/frontend/src/pages/PendingOrdersPage.tsx
@archibald-web-app/frontend/src/AppRouter.tsx
@archibald-web-app/frontend/playwright.vps.config.ts

# Backend API for pending orders:
@archibald-web-app/backend/src/routes/pending-orders.ts

**PendingOrdersPage selectors:**
- Page heading: `h1` text "Ordini in Attesa (N)" or `h2` text "Nessun ordine in attesa"
- Loading: text "Caricamento ordini in attesa..."
- Per-order card: customer name in `fontWeight: "600"` div
- Status badge: text "In Attesa" / "Errore" / "Da Magazzino" / "In Elaborazione"
- Action buttons by `title`:
  - Delete: `title="Elimina ordine"`
  - Edit: `title="Modifica ordine"`
  - PDF: `title="Scarica PDF"`
- Select all checkbox: `span` text "Seleziona Tutti"
- Submit selected: button text "Invia Ordini Selezionati (N)"
- `window.confirm()` on delete/archive — intercept with `page.on('dialog', d => d.accept())`

**API endpoints:**
- `GET /api/pending-orders` — list all pending orders
- `POST /api/pending-orders` — create pending order
- `DELETE /api/pending-orders/:id` — delete pending order

**Key constraint:** Do NOT create real orders via bot submission (triggers Archibald ERP interaction). Only test frontend CRUD of pending orders and verify page data loads.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order-flow.spec.ts — pending orders CRUD</name>
  <files>archibald-web-app/frontend/e2e/order-flow.spec.ts</files>
  <action>
Create E2E test file verifying pending orders page and CRUD operations. Tests use storageState (authenticated).

Test cases:

1. **"pending orders page loads and shows data"** — Navigate to `/pending-orders`:
   - Wait for page to finish loading (loading text disappears)
   - Verify either heading "Ordini in Attesa" with count OR "Nessun ordine in attesa"
   - If orders exist: verify at least one order card is visible with customer name
   - If no orders: verify empty state message

2. **"can create a pending order via API and see it in list"** — Use Playwright `page.request` to create a pending order directly via API:
   - First, get current count from page (or via API `GET /api/pending-orders`)
   - Create a pending order via `page.request.post('/api/pending-orders', { data: { ... } })`:
     - Use minimal valid payload: customerId, customerName, items array with at least one item
     - Check the actual API contract from the backend route to get correct payload shape
   - Reload `/pending-orders` page
   - Verify new order appears (count increased or new customer name visible)
   - Save the created order ID for cleanup

3. **"can delete a pending order"** — Delete the order created in test 2:
   - Navigate to `/pending-orders`
   - Find the order created above (by customer name or position)
   - Intercept `window.confirm()`: `page.on('dialog', d => d.accept())`
   - Click delete button: `button[title="Elimina ordine"]` on the matching order card
   - Wait for order to disappear from the list
   - Verify count decreased or order no longer visible
   - Alternatively: use API `DELETE /api/pending-orders/:id` if UI deletion is complex, then verify UI reflects the change

IMPORTANT:
- If the pending-orders API requires specific payload shape, read the route file to determine it
- Clean up created test data — delete any orders created during testing
- Use `test.describe.serial()` so tests run in order (create → verify → delete)
- Do NOT trigger real bot submission (enqueue operation) — only test pending order CRUD
- Handle the `window.confirm()` dialog that appears on delete
- If creating via API, extract JWT from storageState or page context for Authorization header
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/e2e/order-flow.spec.ts`
- Tests clean up after themselves (delete created orders)
- No bot submissions triggered
- `window.confirm()` intercepted
- Proper waits (no waitForTimeout)
  </verify>
  <done>
- 3 test cases: page load, create via API + verify in UI, delete
- Test data cleaned up
- Serial execution for dependent tests
  </done>
</task>

<task type="auto">
  <name>Task 2: Create data-pages.spec.ts — data page verification</name>
  <files>archibald-web-app/frontend/e2e/data-pages.spec.ts</files>
  <action>
Create E2E test file verifying that data-heavy pages load correctly and display actual data from the backend sync. Tests use storageState.

Test cases:

1. **"customers page loads with data"** — Navigate to `/customers`:
   - Wait for loading to complete
   - Verify customer list renders (at least one customer visible, or appropriate empty state)
   - Verify page is not stuck in error state

2. **"products page loads with data"** — Navigate to `/products`:
   - Wait for loading to complete
   - Verify products/articles list renders
   - Verify page is not stuck in error state

3. **"order history page loads"** — Navigate to `/orders`:
   - Wait for loading to complete
   - Verify order history renders (table/list visible or appropriate empty state)

4. **"dashboard loads with widgets"** — Navigate to `/`:
   - Verify dashboard widgets/KPIs render
   - No error states visible
   - Navigation is functional

5. **"API health check responds"** — Verify backend is healthy:
   - `page.request.get('/api/health')` returns 200
   - This confirms the backend API layer is functional

Each test should:
- Navigate to the route
- Wait for loading indicators to disappear (e.g., text "Caricamento" gone)
- Verify content is present (not just that page loaded, but that data rendered)
- Check for error states (no red error banners visible)

IMPORTANT:
- These are smoke tests verifying data pages work, not deep functional tests
- Some pages may legitimately show empty data — that's OK, verify no errors
- Use `expect(page.locator('...')).toBeVisible()` with reasonable timeout
- The `/api/health` endpoint was added in Phase 6 (health check before rate limiting)
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/e2e/data-pages.spec.ts`
- All 5 test cases cover different pages
- Loading states properly handled
- Error states checked
- Health check verified
  </verify>
  <done>
- 5 test cases covering: customers, products, order history, dashboard, API health
- Each verifies page loads AND data renders (not just URL change)
- No false positives from loading states
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `order-flow.spec.ts` exists with 3 test cases
- [ ] `data-pages.spec.ts` exists with 5 test cases
- [ ] Test data cleanup in order flow tests
- [ ] No bot submissions triggered
- [ ] No `waitForTimeout()` used
- [ ] TypeScript type-check passes: `npm run type-check --prefix archibald-web-app/frontend`
</verification>

<success_criteria>

- All tasks completed
- Pending orders CRUD verified end-to-end
- All data pages verified as loading with data
- Backend health check confirmed
- Test data cleaned up after order flow tests
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-tests-vps-validation/09-03-SUMMARY.md`
</output>
