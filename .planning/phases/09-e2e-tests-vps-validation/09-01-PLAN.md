---
phase: 09-e2e-tests-vps-validation
plan: 01
type: execute
---

<objective>
Setup Playwright configuration for VPS testing and create auth fixture.

Purpose: Create the infrastructure needed to run E2E tests against the deployed PWA on formicanera.com — VPS-specific config (no webServer, Chromium-only, storageState) and reusable auth setup.
Output: `playwright.vps.config.ts` and `e2e/auth.setup.ts` ready for test execution.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-tests-vps-validation/09-RESEARCH.md
@.planning/phases/09-e2e-tests-vps-validation/09-CONTEXT.md

# Existing Playwright setup (reference for patterns, NOT to modify):
@archibald-web-app/frontend/playwright.config.ts
@archibald-web-app/frontend/e2e/helpers/multi-device.ts

# Auth flow (for login selectors):
@archibald-web-app/frontend/src/components/LoginModal.tsx

**Constraining decisions:**
- Phase 1: IndexedDB eliminated for app data — test verifications via DOM/API only
- Phase 5: WebSocket events standardized `{ type, payload, timestamp }` format
- RESEARCH.md: Use storageState for auth persistence (login triggers Puppeteer backend ~10-30s)
- RESEARCH.md: Docker Playwright image or native install on VPS
- RESEARCH.md: workers:1, fullyParallel:false due to VPS resource constraints
- CONTEXT.md: Tests run directly on VPS, one-time verification, no permanent suite

**Auth selectors (from codebase analysis):**
- Username: `#username`
- Password: `#password`
- Submit: `button[type="submit"]` (text "Accedi", changes to "Autenticazione..." while loading)
- JWT stored in `localStorage` as `archibald_jwt`
- Device ID in `localStorage` as `archibald_device_id`
- UnlockScreen appears if `localStorage` has `archibald_last_user` — tests must clear this
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create playwright.vps.config.ts for VPS testing</name>
  <files>archibald-web-app/frontend/playwright.vps.config.ts</files>
  <action>
Create a new Playwright config file dedicated to VPS testing. Do NOT modify the existing `playwright.config.ts` (that's for local dev).

Settings:
- `testDir: './e2e'`
- `fullyParallel: false` — VPS has limited resources (7 Docker services already running)
- `retries: 0` — one-time verification, we want real results, not retry-masked flakiness
- `workers: 1` — single worker to avoid overloading VPS
- `reporter: [['list'], ['html', { open: 'never' }]]` — terminal output + HTML report for review
- `timeout: 60_000` — generous timeout (backend login triggers Puppeteer)
- `use.baseURL: process.env.BASE_URL || 'https://formicanera.com'` — configurable, defaults to production
- `use.trace: 'on'` — always trace for remote debugging
- `use.screenshot: 'on'` — screenshot every test for verification
- `use.headless: true`
- `use.ignoreHTTPSErrors: true` — VPS may have self-signed cert
- Only ONE project: `chromium` with `storageState: 'playwright/.auth/user.json'` and `dependencies: ['setup']`
- Add `setup` project: `testMatch: /.*\.setup\.ts/`
- NO `webServer` section — app is already deployed on VPS
- `expect.timeout: 15_000` — generous assertion timeout for VPS latency

Do NOT add `serviceWorkers: 'block'` — we test the real PWA behavior including service worker.

Also add npm script: in `archibald-web-app/frontend/package.json`, add `"test:e2e:vps": "playwright test --config=playwright.vps.config.ts"` to scripts.
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/playwright.vps.config.ts`
- TypeScript compiles: `npx tsc --noEmit --esModuleInterop archibald-web-app/frontend/playwright.vps.config.ts` (or just verify syntax)
- npm script exists: `grep 'test:e2e:vps' archibald-web-app/frontend/package.json`
  </verify>
  <done>
- `playwright.vps.config.ts` created with VPS-specific settings
- Existing `playwright.config.ts` NOT modified
- npm script `test:e2e:vps` added to package.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth.setup.ts with storageState login</name>
  <files>archibald-web-app/frontend/e2e/auth.setup.ts</files>
  <action>
Create auth setup file that performs login once and saves storageState for all subsequent tests.

Implementation:
1. Import `test as setup, expect` from `@playwright/test`
2. Define `authFile` path as `path.join(__dirname, '../playwright/.auth/user.json')`
3. Create `.gitignore` entry in `archibald-web-app/frontend/playwright/.auth/.gitignore` with `*` and `!.gitignore` (avoid committing auth state)
4. Create setup named 'authenticate':
   a. Navigate to `'/'` (baseURL from config)
   b. Clear localStorage first to avoid UnlockScreen: `await page.addInitScript(() => localStorage.clear())`
   c. Wait for login form: `await page.waitForSelector('#username', { timeout: 30_000 })`
   d. Fill `#username` with `process.env.TEST_USER_USERNAME` — throw error if env var missing
   e. Fill `#password` with `process.env.TEST_USER_PASSWORD` — throw error if env var missing
   f. Click `button[type="submit"]`
   g. Wait for JWT with generous timeout (login triggers Puppeteer backend, can take 10-30s):
      `await page.waitForFunction(() => localStorage.getItem('archibald_jwt') !== null, { timeout: 60_000 })`
   h. Verify dashboard loaded: `await expect(page.locator('nav')).toBeVisible({ timeout: 10_000 })` (DashboardNav appears when authenticated)
   i. Save storage state: `await page.context().storageState({ path: authFile })`

IMPORTANT: Use `process.env.TEST_USER_USERNAME` and `process.env.TEST_USER_PASSWORD` — NEVER hardcode credentials. Throw descriptive error if missing: `throw new Error('TEST_USER_USERNAME env var required for E2E tests')`

Create directory `archibald-web-app/frontend/playwright/.auth/` if it doesn't exist.
  </action>
  <verify>
- File exists: `archibald-web-app/frontend/e2e/auth.setup.ts`
- Gitignore exists: `archibald-web-app/frontend/playwright/.auth/.gitignore`
- No hardcoded credentials in the file
- Auth file path matches config's storageState path
  </verify>
  <done>
- `auth.setup.ts` performs login and saves storageState
- Credentials from env vars, never hardcoded
- `.gitignore` prevents committing auth state
- Auth setup project referenced by VPS config
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `playwright.vps.config.ts` exists with correct settings
- [ ] `auth.setup.ts` exists with login flow
- [ ] `playwright/.auth/.gitignore` exists
- [ ] npm script `test:e2e:vps` in package.json
- [ ] No hardcoded credentials anywhere
- [ ] Existing `playwright.config.ts` NOT modified
- [ ] TypeScript type-check passes: `npm run type-check --prefix archibald-web-app/frontend`
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- VPS config ready for remote testing
- Auth setup ready to perform login and cache state
- No credentials committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-tests-vps-validation/09-01-SUMMARY.md`
</output>
