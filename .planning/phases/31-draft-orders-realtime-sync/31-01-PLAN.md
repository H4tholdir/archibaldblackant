---
phase: 31-draft-orders-realtime-sync
plan: 01
type: execute
---

<objective>
Migrare draft orders da HTTP polling (15s) a WebSocket real-time per latency <100ms, eliminando complessità UnifiedSyncService polling.

Purpose: Sostituire polling con eventi real-time (DRAFT_CREATED, DRAFT_UPDATED, DRAFT_DELETED, DRAFT_CONVERTED) per sync multi-device istantaneo, ridurre traffico HTTP, semplificare architettura.

Output: Draft orders sincronizzati via WebSocket con latency <100ms, eliminato polling per drafts, tombstones preservati (rimozione differita a Phase 33).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# WebSocket Infrastructure (Phase 29-30)
@.planning/phases/29-websocket-server-infrastructure/29-01-SUMMARY.md
@.planning/phases/30-websocket-client-reconnect/30-01-SUMMARY.md

# Key files
@archibald-web-app/frontend/src/hooks/useWebSocket.ts
@archibald-web-app/frontend/src/services/websocket-queue.ts
@archibald-web-app/frontend/src/db/schema.ts
@archibald-web-app/frontend/src/services/unified-sync-service.ts
@archibald-web-app/backend/src/index.ts

**Tech stack available (Phase 29-30):**
- WebSocket server at ws://localhost:3000/ws/realtime with JWT auth
- Frontend useWebSocket() hook con auto-reconnect, exponential backoff (1s→30s)
- Offline queue con localStorage persistence (max 100 items, 24h cleanup)
- Event subscription pattern: subscribe(eventType, callback) returns unsubscribe
- Connection pool: Map<userId, Set<WebSocket>> for per-user multi-device broadcast

**Established patterns:**
- Server: Connection manager con JWT validation via query param
- Server: Broadcast methods per user: broadcastToUser(userId, event)
- Client: Event-driven subscriptions con cleanup automatico
- Client: Offline queue automatic replay on reconnect
- Schema: UUID-based drafts con deviceId, needsSync, serverUpdatedAt, deleted (tombstone)

**Constraining decisions:**
- Phase 30-01: Event subscription callback pattern (React-friendly, unsubscribe function return)
- Phase 30-01: Browser native WebSocket API (no external library)
- Phase 30-01: Offline queue with localStorage persistence for resilience
- Phase 29-01: Connection pool Map<userId, Set<WebSocket>> for efficient multi-device broadcast
- Phase 29-01: JWT auth via query param or header for flexibility

**Current implementation:**
- UnifiedSyncService: HTTP polling ogni 15s per draft/pending orders
- Draft schema: DraftOrder interface con UUID, deviceId, needsSync, serverUpdatedAt, deleted
- Tombstone pattern: deleted flag preservato fino Phase 33 (direct delete)
- IndexedDB: db.draftOrders table con Dexie

**Migration goal:**
- Eliminate HTTP polling for drafts (preserve for pending in Phase 32)
- Real-time events: DRAFT_CREATED, DRAFT_UPDATED, DRAFT_DELETED, DRAFT_CONVERTED
- Preserve tombstone pattern (deleted flag) per Phase 33 removal
- Latency target: <100ms per multi-device sync
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend Draft Events & WebSocket Broadcast</name>
  <files>archibald-web-app/backend/src/draft-realtime.service.ts, archibald-web-app/backend/src/index.ts</files>
  <action>
    Create DraftRealtimeService singleton class:

    **Service responsibilities:**
    - Manage draft WebSocket broadcasts to all user devices
    - Emit events: DRAFT_CREATED, DRAFT_UPDATED, DRAFT_DELETED, DRAFT_CONVERTED
    - Integration con existing REST endpoints (/api/drafts)

    **Implementation details:**
    - Import connection manager da Phase 29 (broadcastToUser method)
    - Event payload format: { draftId, draft, timestamp, deviceId }
    - DRAFT_CREATED: full draft object (inviato da device creatore)
    - DRAFT_UPDATED: full draft object updated (delta merge client-side)
    - DRAFT_DELETED: { draftId, deleted: true } per tombstone
    - DRAFT_CONVERTED: { draftId, pendingOrderId } quando draft → pending

    **REST endpoint integration:**
    Modify existing /api/drafts endpoints to emit WebSocket events:
    - POST /api/drafts → emit DRAFT_CREATED after DB insert
    - PUT /api/drafts/:id → emit DRAFT_UPDATED after DB update
    - DELETE /api/drafts/:id → emit DRAFT_DELETED after tombstone mark
    - POST /api/drafts/:id/convert → emit DRAFT_CONVERTED after conversion

    **JWT userId extraction:**
    Use authenticateJWT middleware to extract userId from request
    Broadcast only to user's connected devices (not global broadcast)

    **Error handling:**
    - Log broadcast errors but don't fail REST request
    - Graceful handling if no WebSocket connections for user
    - TypeScript strict types for all event payloads

    **AVOID:**
    - Do NOT remove REST endpoints (needed for HTTP fallback)
    - Do NOT implement server-side draft storage yet (deferred to Phase 32)
    - Do NOT remove tombstone pattern (Phase 33 scope)
  </action>
  <verify>
    npm run build in backend succeeds

    Verify DraftRealtimeService exports:
    - getInstance() method
    - emitDraftCreated(userId, draft)
    - emitDraftUpdated(userId, draft)
    - emitDraftDeleted(userId, draftId, deviceId)
    - emitDraftConverted(userId, draftId, pendingOrderId)

    Check /api/drafts REST endpoints still compile
  </verify>
  <done>
    - DraftRealtimeService created with singleton pattern
    - All 4 event types defined (CREATED/UPDATED/DELETED/CONVERTED)
    - REST endpoints integrated to emit events
    - JWT userId extraction working
    - TypeScript compilation passes
    - No breaking changes to REST API
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend Draft WebSocket Subscription & Real-Time Updates</name>
  <files>archibald-web-app/frontend/src/services/draft-realtime.service.ts, archibald-web-app/frontend/src/hooks/useDraftSync.ts</files>
  <action>
    Create frontend draft real-time service and React hook:

    **1. DraftRealtimeService (frontend service):**

    Class responsibilities:
    - Subscribe to DRAFT_* events from WebSocket
    - Apply updates to IndexedDB (db.draftOrders)
    - Handle conflicts using Last-Write-Wins (serverUpdatedAt comparison)
    - Emit UI update events for React components

    Conflict resolution strategy (LWW):
    - Compare incoming serverUpdatedAt with local draft updatedAt
    - If incoming serverUpdatedAt > local → accept server version
    - If incoming serverUpdatedAt ≤ local → ignore (local is newer)
    - Tombstone (deleted: true) always wins regardless of timestamp

    Event handlers:
    - DRAFT_CREATED: Insert draft into IndexedDB if not exists
    - DRAFT_UPDATED: Upsert draft if serverUpdatedAt > local.updatedAt
    - DRAFT_DELETED: Mark draft.deleted = true (tombstone pattern)
    - DRAFT_CONVERTED: Remove draft, mark as converted (UI feedback)

    IndexedDB operations:
    - Use db.draftOrders.put() for upsert (preserves UUID key)
    - Filter own deviceId to prevent echo (local changes already applied)
    - Log all operations with [DraftRealtime] prefix for debugging

    **2. useDraftSync() custom React hook:**

    Hook responsibilities:
    - Initialize WebSocket subscription on mount
    - Provide real-time draft list updates to components
    - Handle connection state (connecting/connected/disconnected)
    - Cleanup subscriptions on unmount

    Hook API:
    ```typescript
    const { drafts, isConnected, isSyncing } = useDraftSync();
    ```

    Implementation:
    - Use useWebSocket() hook from Phase 30
    - Subscribe to all DRAFT_* events on mount
    - useState for drafts array (auto-updates on events)
    - useEffect cleanup to unsubscribe on unmount
    - Load initial drafts from IndexedDB on mount

    **Integration with existing components:**
    - Replace UnifiedSyncService draft polling in components
    - Preserve REST API calls for mutations (POST/PUT/DELETE)
    - Use hook in OrderFormSimple, DashboardNav for real-time counts

    **AVOID:**
    - Do NOT remove UnifiedSyncService yet (Phase 32 removes it)
    - Do NOT implement optimistic UI updates (REST → WebSocket flow sufficient)
    - Do NOT bypass IndexedDB (always persist locally first)
  </action>
  <verify>
    npm run build in frontend succeeds

    Check exports:
    - DraftRealtimeService.getInstance()
    - useDraftSync() hook with correct return type

    Verify IndexedDB integration:
    - db.draftOrders.put() used for upsert
    - Conflict resolution with serverUpdatedAt comparison

    Check WebSocket subscription:
    - subscribe() called for all 4 event types
    - unsubscribe() cleanup on unmount
  </verify>
  <done>
    - DraftRealtimeService created with event handlers
    - Conflict resolution LWW implemented with serverUpdatedAt
    - IndexedDB operations correct (put/upsert)
    - useDraftSync() hook created with drafts/isConnected state
    - WebSocket subscription lifecycle managed correctly
    - TypeScript compilation passes
    - No breaking changes to existing REST flows
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove Draft Polling from UnifiedSyncService</name>
  <files>archibald-web-app/frontend/src/services/unified-sync-service.ts, archibald-web-app/frontend/src/hooks/useAutomaticSync.ts</files>
  <action>
    Disable draft polling in UnifiedSyncService while preserving pending orders polling:

    **Modifications to UnifiedSyncService:**

    1. Update syncAll() method:
       - Remove pullDrafts() call
       - Remove pushDrafts() call
       - Preserve pullPendingOrders() and pushPendingOrders()
       - Preserve pullWarehouse() and pushWarehouse()

    2. Update pullAll() method:
       - Remove pullDrafts() call
       - Keep pending orders and warehouse pulls

    3. Update pushAll() method:
       - Remove pushDrafts() call
       - Keep pending orders and warehouse pushes

    4. Comment explanation:
       Add comment explaining why drafts removed:
       "// Draft sync handled by WebSocket real-time (Phase 31)"
       "// Pending orders still use HTTP polling (until Phase 32)"

    **Preserve for Phase 32:**
    - Keep pullPendingOrders() and pushPendingOrders() methods intact
    - Keep periodic sync running (15s interval) for pending orders
    - Keep all event listeners (online, visibilitychange)
    - Keep warehouse sync methods

    **Update useAutomaticSync hook:**
    - No changes needed (hook agnostic to sync internals)
    - Verify hook still calls UnifiedSyncService.syncAll()

    **Verification steps:**
    - Ensure no drafts polling in network tab (only WebSocket traffic)
    - Verify pending orders still poll every 15s
    - Check console logs confirm draft WebSocket active

    **AVOID:**
    - Do NOT remove UnifiedSyncService class (Phase 32 removes it)
    - Do NOT touch pending orders sync logic
    - Do NOT remove periodic sync timer
    - Do NOT modify warehouse sync
  </action>
  <verify>
    npm run build succeeds

    Grep verification:
    - grep -n "pullDrafts" unified-sync-service.ts should return 0 results
    - grep -n "pushDrafts" unified-sync-service.ts should return 0 results
    - grep -n "pullPendingOrders" unified-sync-service.ts should return >0 results (preserved)

    Check periodic sync still exists:
    - startPeriodicSync() method intact
    - syncInterval timer still active

    Verify comment added about Phase 31
  </verify>
  <done>
    - pullDrafts() and pushDrafts() calls removed from syncAll()
    - pullAll() and pushAll() updated to skip drafts
    - Comment explaining WebSocket migration added
    - Pending orders polling preserved intact
    - Periodic sync (15s) still running for pending/warehouse
    - TypeScript compilation passes
    - No breaking changes to pending orders or warehouse sync
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds in both backend and frontend
- [ ] Backend DraftRealtimeService exports all 4 emit methods
- [ ] Frontend DraftRealtimeService handles all 4 event types
- [ ] useDraftSync() hook returns drafts array and connection state
- [ ] WebSocket events broadcast to all user devices
- [ ] IndexedDB updates applied with LWW conflict resolution
- [ ] Draft polling removed from UnifiedSyncService
- [ ] Pending orders polling still active (15s interval)
- [ ] No TypeScript errors or warnings
- [ ] WebSocket connection shows in browser DevTools
</verification>

<success_criteria>

- All 3 tasks completed
- Backend emits DRAFT_CREATED/UPDATED/DELETED/CONVERTED events via WebSocket
- Frontend subscribes to draft events and updates IndexedDB in real-time
- Conflict resolution with Last-Write-Wins using serverUpdatedAt
- Draft polling eliminated from UnifiedSyncService (pending orders preserved)
- Tombstone pattern preserved (deleted flag, Phase 33 removes it)
- REST API endpoints preserved for HTTP fallback
- TypeScript strict mode passes without errors
- No breaking changes to existing draft management flows
- Real-time latency <100ms verified in manual testing
</success_criteria>

<output>
After completion, create `.planning/phases/31-draft-orders-realtime-sync/31-01-SUMMARY.md`:

# Phase 31 Plan 01: Draft Orders Real-Time Sync Summary

**Draft orders migrati a WebSocket real-time con latency <100ms, eliminato polling HTTP per drafts, 75% riduzione traffico sync**

## Accomplishments

- Backend DraftRealtimeService con 4 eventi (CREATED/UPDATED/DELETED/CONVERTED)
- Frontend real-time subscription con LWW conflict resolution
- useDraftSync() React hook per UI updates automatiche
- Polling HTTP rimosso per drafts (75% meno richieste vs 15s polling)
- Pending orders polling preservato (rimosso in Phase 32)
- Tombstone pattern mantenuto (Phase 33 removal)

## Files Created/Modified

- `backend/src/draft-realtime.service.ts` - WebSocket broadcast service
- `backend/src/index.ts` - REST endpoint integration con events
- `frontend/src/services/draft-realtime.service.ts` - Event handlers + IndexedDB sync
- `frontend/src/hooks/useDraftSync.ts` - React hook per real-time updates
- `frontend/src/services/unified-sync-service.ts` - Rimosso draft polling

## Decisions Made

- LWW conflict resolution con serverUpdatedAt timestamp comparison
- Tombstone pattern preserved (deleted flag) per backward compatibility
- REST endpoints preserved per HTTP fallback se WebSocket unavailable
- Event payload format: { draftId, draft, timestamp, deviceId }
- IndexedDB upsert con db.draftOrders.put() preserva UUID keys

## Issues Encountered

[Documentare eventuali problemi e risoluzioni]

## Next Phase Readiness

Ready for Phase 32: Pending Orders Real-Time Sync

**What's ready:**
- WebSocket infrastructure proven con draft real-time sync
- Conflict resolution pattern (LWW) validato e funzionante
- React hook pattern stabilito per real-time updates
- Offline queue replay automatico già testato

**What Phase 32 needs:**
- Apply same pattern to pending orders (PENDING_CREATED/UPDATED/DELETED)
- Complete elimination of UnifiedSyncService HTTP polling
- Server-side pending orders storage (currently client-only)
- Coordinated bot execution via WebSocket events

</output>
