---
phase: 34-e2e-testing-multidevice
plan: 01
type: execute
---

<objective>
Creare test suite E2E completa con Playwright per validare sync real-time multi-device, direct deletion, e scenari offline→online.

Purpose: Garantire che WebSocket real-time sync funzioni correttamente su 2+ devices simultanei, con latency <100ms, gestione offline, e direct deletion senza tombstones.
Output: Test suite Playwright con scenari multi-device, CI/CD integration, documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase context:**
@.planning/phases/29-websocket-server-infrastructure/29-01-SUMMARY.md
@.planning/phases/30-websocket-client-reconnect/30-01-SUMMARY.md
@.planning/phases/31-draft-orders-realtime-sync/31-01-SUMMARY.md
@.planning/phases/32-pending-orders-realtime-sync/32-01-SUMMARY.md
@.planning/phases/33-direct-delete-tombstone-removal/33-01-SUMMARY.md

**Tech stack available:**
- Frontend: Vitest 4.0.17, @testing-library/react 16.3.1, fake-indexeddb 6.2.5
- Test tools: jsdom 27.4.0, @vitest/ui 4.0.17
- WebSocket: Native Browser API (Phase 30)
- Real-time: Draft + Pending sync established (Phase 31-32)
- Direct DELETE: Tombstone removal complete (Phase 33)

**Established patterns:**
- WebSocket connection via useRealtimeConnection hook
- LWW conflict resolution (serverUpdatedAt comparison)
- Echo prevention (deviceId filtering)
- Direct deletion (db.delete() invece di tombstone put)
- React hooks: useDraftSync(), usePendingSync()

**Constraining decisions:**
- Playwright for E2E (multi-browser, multi-device support)
- Test real-time sync latency <100ms target
- Validate direct deletion across devices
- Test offline queue → online sync scenarios
- No tombstone filtering (Phase 33 removed it)

**Key files:**
@archibald-web-app/frontend/src/hooks/useRealtimeConnection.ts
@archibald-web-app/frontend/src/services/draft-realtime.service.ts
@archibald-web-app/frontend/src/services/pending-realtime.service.ts
@archibald-web-app/frontend/src/hooks/useDraftSync.ts
@archibald-web-app/frontend/src/hooks/usePendingSync.ts
@archibald-web-app/backend/src/draft-realtime.service.ts
@archibald-web-app/backend/src/pending-realtime.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Playwright Setup & Multi-Device Test Infrastructure</name>
  <files>archibald-web-app/frontend/package.json, archibald-web-app/frontend/playwright.config.ts, archibald-web-app/frontend/e2e/helpers/multi-device.ts</files>
  <action>
    Install Playwright: `npm install -D @playwright/test` in frontend directory.
    Create playwright.config.ts con:
    - Projects: chromium, firefox, webkit (multi-browser testing)
    - Base URL: http://localhost:5173
    - fullyParallel: true per test concorrenti
    - Use webServer per auto-start Vite dev server

    Create e2e/helpers/multi-device.ts utility:
    - createDeviceContext(browser, deviceId): crea BrowserContext con deviceId in localStorage
    - setupTwoDevices(): helper per inizializzare Device A e Device B simultaneamente
    - waitForRealtimeSync(page, timeout=2000): attende WebSocket connection e sync completion
    - measureLatency(device1, device2, action): misura sync latency tra devices

    Add npm scripts in package.json:
    - "test:e2e": "playwright test"
    - "test:e2e:ui": "playwright test --ui"
    - "test:e2e:debug": "playwright test --debug"

    AVOID: Non usare puppeteer (già in stack per bot, ma Playwright è migliore per E2E). Non creare test nel backend (E2E solo frontend).
  </action>
  <verify>npx playwright --version succeeds, playwright.config.ts exists, e2e/helpers/multi-device.ts exists with required helpers</verify>
  <done>Playwright installato, config creata, multi-device helpers funzionanti, npm scripts disponibili</done>
</task>

<task type="auto">
  <name>Task 2: Draft Orders Real-Time Sync E2E Tests</name>
  <files>archibald-web-app/frontend/e2e/draft-realtime.spec.ts</files>
  <action>
    Create e2e/draft-realtime.spec.ts con test scenarios:

    Test 1: "Two devices see draft creation in real-time"
    - Device A: crea draft order
    - Device B: verifica draft appare in lista entro 2s
    - Measure latency Device A → Device B (assert <100ms)

    Test 2: "Two devices see draft update in real-time"
    - Device A: crea draft, aggiunge articolo
    - Device B: verifica update appare entro 2s
    - Verify LWW: B update sovrascrive A se timestamp più recente

    Test 3: "Two devices see direct deletion in real-time"
    - Device A: crea draft
    - Device B: verifica draft esiste
    - Device A: DELETE draft (db.delete(), NO tombstone)
    - Device B: verifica draft scompare da lista entro 2s
    - Device B: verifica IndexedDB non contiene deleted record

    Test 4: "Echo prevention works correctly"
    - Device A: crea draft
    - Device A: verifica non riceve proprio evento (deviceId filter)
    - Device B: verifica riceve evento normalmente

    Test 5: "Offline device syncs on reconnection"
    - Device A: vai offline (navigator.onLine = false)
    - Device B: crea draft
    - Device A: torna online
    - Device A: verifica draft appare dopo reconnection

    Use helpers from multi-device.ts. Assertions specifiche (not generic "it works").
    AVOID: Non testare tombstones (Phase 33 li ha rimossi). Non usare setTimeout generico (use waitForRealtimeSync).
  </action>
  <verify>npx playwright test e2e/draft-realtime.spec.ts passes all 5 tests, latency <100ms verified, direct deletion confirmed</verify>
  <done>5 test E2E per draft real-time sync passing, scenarios multi-device validati, latency target rispettato</done>
</task>

<task type="auto">
  <name>Task 3: Pending Orders Real-Time Sync E2E Tests</name>
  <files>archibald-web-app/frontend/e2e/pending-realtime.spec.ts</files>
  <action>
    Create e2e/pending-realtime.spec.ts con test scenarios:

    Test 1: "Two devices see pending order creation in real-time"
    - Device A: converti draft → pending order
    - Device B: verifica pending order appare in lista entro 2s
    - Measure latency (assert <100ms)

    Test 2: "Bot status updates propagate to all devices"
    - Device A: crea pending order
    - Backend: simula PENDING_SUBMITTED event (status: "syncing")
    - Device A + B: verificano status update simultaneamente
    - Backend: simula status: "completed"
    - Device A + B: verificano completion

    Test 3: "Direct deletion works for pending orders"
    - Device A: crea pending order
    - Device B: DELETE pending order (db.delete())
    - Device A: verifica pending scompare entro 2s
    - Verify NO tombstone in IndexedDB

    Test 4: "Conflict resolution with bot updates"
    - Device A: modifica pending order locale
    - Backend: invia bot status update (authoritative)
    - Device A: verifica bot update sovrascrive local change

    Test 5: "Cascade deletion draft→pending verified"
    - Device A: crea draft
    - Device A: converti draft → pending
    - Device B: verifica draft scompare, pending appare
    - Device A: DELETE pending
    - Device B: verifica pending scompare (NO draft resurrection)

    AVOID: Non testare warehouse sync (HTTP polling, not in v3.0 scope). Non testare tombstone filtering (rimosso Phase 33).
  </action>
  <verify>npx playwright test e2e/pending-realtime.spec.ts passes all 5 tests, bot coordination verified, cascade deletion working</verify>
  <done>5 test E2E per pending real-time sync passing, bot coordination validata, cascade deletion verificata</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run test:e2e` in frontend directory passes all tests
- [ ] Multi-device scenarios (2+ browsers) working correctly
- [ ] Latency measurements <100ms for all sync operations
- [ ] Direct deletion (NO tombstones) verified across devices
- [ ] Offline→online sync working correctly
- [ ] Bot coordination events propagating to all devices
- [ ] No TypeScript errors in E2E tests
</verification>

<success_criteria>

- All tasks completed
- Playwright installato e configurato correttamente
- 10 test E2E total (5 drafts + 5 pending) passing
- Multi-device real-time sync validato
- Latency target <100ms verificato
- Direct deletion senza tombstones funzionante
- Offline queue sync testato
- Bot coordination validata
- CI/CD ready (playwright test command)
  </success_criteria>

<output>
After completion, create `.planning/phases/34-e2e-testing-multidevice/34-01-SUMMARY.md`:

# Phase 34 Plan 01: E2E Testing & Multi-Device Validation Summary

**[One-liner substantive summary]**

## Accomplishments

- Playwright setup with multi-browser support (chromium, firefox, webkit)
- Multi-device test infrastructure with helpers for parallel device testing
- 10 E2E tests (5 drafts + 5 pending) validating real-time sync
- Latency measurements <100ms verified for all operations
- Direct deletion (NO tombstones) tested across devices
- Offline→online sync scenarios validated
- Bot coordination events tested

## Files Created/Modified

- `frontend/package.json` - Added Playwright dependencies and scripts
- `frontend/playwright.config.ts` - Playwright configuration
- `frontend/e2e/helpers/multi-device.ts` - Multi-device test helpers
- `frontend/e2e/draft-realtime.spec.ts` - Draft real-time E2E tests
- `frontend/e2e/pending-realtime.spec.ts` - Pending real-time E2E tests

## Decisions Made

[Key testing decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 35: Monitoring & Observability

**What's ready:**
- E2E test suite validating all real-time sync scenarios
- Multi-device sync proven working with <100ms latency
- Direct deletion verified (no tombstone issues)
- Test infrastructure ready for regression testing

**What Phase 35 needs:**
- WebSocket health metrics collection
- Connection monitoring dashboard
- Latency tracking and alerting
- Error rate monitoring
- Admin observability UI
</output>
