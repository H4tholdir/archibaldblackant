# Phase 3 Plan 06: Frontend Quantity Validation & User Feedback

**Type**: execute
**Dependencies**: 03-04 (validation function), 03-05 (package display)
**Estimated Complexity**: Medium
**Files Modified**: 2-3

---

## Objective

Add frontend validation to prevent invalid quantities from being submitted, with clear error messages and suggestions.

**Success Criteria**:
- ✅ Real-time validation as user types quantity
- ✅ Error messages show below quantity field
- ✅ Suggested valid quantities clickable
- ✅ Submit button disabled if validation fails
- ✅ Validation logic matches backend

---

## Tasks

### Task 1: Create Validation Hook - AUTO

**File**: `archibald-web-app/frontend/src/hooks/useQuantityValidation.ts` (new)

```typescript
import { useMemo } from 'react';
import type { Product } from '../types/product';

export interface ValidationResult {
  valid: boolean;
  errors: string[];
  suggestions?: number[];
}

export function useQuantityValidation(
  variant: Product | null,
  quantity: number
): ValidationResult {
  return useMemo(() => {
    if (!variant) {
      return { valid: true, errors: [] };
    }

    const errors: string[] = [];

    // Check minQty
    if (variant.minQty && quantity < variant.minQty) {
      errors.push(`Minimum quantity: ${variant.minQty}`);
    }

    // Check multipleQty
    if (variant.multipleQty && quantity % variant.multipleQty !== 0) {
      errors.push(`Must be multiple of ${variant.multipleQty}`);
    }

    // Check maxQty
    if (variant.maxQty && quantity > variant.maxQty) {
      errors.push(`Maximum quantity: ${variant.maxQty}`);
    }

    // Generate suggestions
    let suggestions: number[] | undefined;
    if (errors.length > 0 && variant.multipleQty) {
      const minQty = variant.minQty || variant.multipleQty;
      const maxQty = variant.maxQty || minQty * 10;

      const lower = Math.floor(quantity / variant.multipleQty) * variant.multipleQty;
      const higher = Math.ceil(quantity / variant.multipleQty) * variant.multipleQty;

      suggestions = [
        Math.max(lower, minQty),
        Math.min(higher, maxQty),
      ].filter((v, i, arr) => arr.indexOf(v) === i);
    }

    return { valid: errors.length === 0, errors, suggestions };
  }, [variant, quantity]);
}
```

---

### Task 2: Create Validation UI Component - AUTO

**File**: `archibald-web-app/frontend/src/components/QuantityValidation.tsx` (new)

```typescript
import React from 'react';
import type { ValidationResult } from '../hooks/useQuantityValidation';

interface QuantityValidationProps {
  validation: ValidationResult;
  onSuggestionClick: (value: number) => void;
}

export function QuantityValidation({
  validation,
  onSuggestionClick,
}: QuantityValidationProps) {
  if (validation.valid) {
    return null;
  }

  return (
    <div className="quantity-validation error">
      <ul className="validation-errors">
        {validation.errors.map((error, i) => (
          <li key={i}>{error}</li>
        ))}
      </ul>

      {validation.suggestions && validation.suggestions.length > 0 && (
        <div className="validation-suggestions">
          <span className="label">Try:</span>
          {validation.suggestions.map((value) => (
            <button
              key={value}
              type="button"
              className="suggestion-button"
              onClick={() => onSuggestionClick(value)}
            >
              {value}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}
```

---

### Task 3: Integrate Validation in OrderForm - AUTO

**File**: `archibald-web-app/frontend/src/components/OrderForm.tsx`

Add validation state:

```typescript
const [validationResults, setValidationResults] = useState<Record<number, ValidationResult>>({});

// Validate quantities when variant or quantity changes
useEffect(() => {
  const newValidations: Record<number, ValidationResult> = {};

  for (const [index, item] of items.entries()) {
    const variant = selectedVariants[index];
    if (variant && item.quantity) {
      newValidations[index] = validateQuantity(variant, item.quantity);
    } else {
      newValidations[index] = { valid: true, errors: [] };
    }
  }

  setValidationResults(newValidations);
}, [items, selectedVariants]);

// Check if form is valid
const isFormValid = useMemo(() => {
  return Object.values(validationResults).every((v) => v.valid);
}, [validationResults]);

// Helper: validateQuantity (same logic as hook)
function validateQuantity(variant: Product, quantity: number): ValidationResult {
  // ... same implementation as useQuantityValidation ...
}
```

Add validation UI to order item:

```typescript
{items.map((item, index) => (
  <div key={index} className="order-item">
    <input
      value={item.articleCode}
      onChange={(e) => handleArticleChange(index, e.target.value)}
      placeholder="Article code"
    />

    <input
      type="number"
      value={item.quantity}
      onChange={(e) => handleQuantityChange(index, parseInt(e.target.value))}
      placeholder="Quantity"
      className={validationResults[index]?.valid === false ? 'invalid' : ''}
    />

    <PackageInfo
      variants={packageVariants[index] || []}
      selectedVariant={selectedVariants[index] || null}
      quantity={item.quantity}
    />

    {/* NEW: Validation feedback */}
    <QuantityValidation
      validation={validationResults[index] || { valid: true, errors: [] }}
      onSuggestionClick={(value) => handleQuantityChange(index, value)}
    />

    {/* ... rest of fields */}
  </div>
))}

{/* Disable submit if validation fails */}
<button type="submit" disabled={!isFormValid || items.length === 0}>
  Create Order
</button>
```

---

### Task 4: Add Styling - AUTO

**File**: `archibald-web-app/frontend/src/components/QuantityValidation.css`

```css
.quantity-validation.error {
  margin-top: 0.5rem;
  padding: 0.75rem;
  background-color: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 4px;
}

.validation-errors {
  list-style: none;
  padding: 0;
  margin: 0 0 0.5rem 0;
  color: #dc2626;
  font-size: 0.875rem;
}

.validation-errors li {
  margin-bottom: 0.25rem;
}

.validation-errors li:last-child {
  margin-bottom: 0;
}

.validation-suggestions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid #fecaca;
}

.validation-suggestions .label {
  font-size: 0.875rem;
  color: #6b7280;
  font-weight: 500;
}

.suggestion-button {
  padding: 0.25rem 0.75rem;
  background-color: #2563eb;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
  transition: background-color 0.2s;
}

.suggestion-button:hover {
  background-color: #1d4ed8;
}

input.invalid {
  border-color: #dc2626;
  background-color: #fef2f2;
}

button[type="submit"]:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

---

### Task 5: Test UX Flow - CHECKPOINT:human-verify

**Manual testing**:

1. Open OrderForm
2. Enter article "H129FSQ.104.023"
3. Enter quantity 7 (invalid: not multiple of 5)
4. **Verify**:
   - Red border on quantity field
   - Error message: "Must be multiple of 5"
   - Suggestions: "5" and "10" buttons visible
   - Submit button disabled
5. Click "5" suggestion
6. **Verify**:
   - Quantity updates to 5
   - Error message disappears
   - Submit button enabled
7. Enter quantity 2 (invalid: below minQty of 5)
8. **Verify**:
   - Error message: "Minimum quantity: 5"
   - Suggestion: "5" button
9. Enter quantity 1000 (invalid: above maxQty)
10. **Verify**:
    - Error message: "Maximum quantity: 500"
    - Suggestions adjust to valid range

---

## Files Changed

- `archibald-web-app/frontend/src/hooks/useQuantityValidation.ts` - New validation hook (create)
- `archibald-web-app/frontend/src/components/QuantityValidation.tsx` - New validation UI (create)
- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Integrate validation
- Styles (CSS file or inline)

---

## Dependencies

**Requires**:
- 03-04 (validation logic defined)
- 03-05 (package display in place)

**Blocks**:
- None (this completes frontend work)

---

## Acceptance Criteria

- ✅ Real-time validation feedback as user types
- ✅ Error messages clear and actionable
- ✅ Suggestion buttons work correctly
- ✅ Submit button disabled on validation error
- ✅ Validation logic matches backend exactly
- ✅ No false positives/negatives
- ✅ Responsive design

---

## Notes

- Validation is **frontend-only** for UX - backend still validates
- Prevents unnecessary API calls with invalid data
- Suggestions improve user experience significantly
- Consider debouncing validation for performance if needed
