# Phase 3 Plan 05: Frontend Package Display in OrderForm

**Type**: execute
**Dependencies**: 03-03 (bot implements package selection)
**Estimated Complexity**: Medium
**Files Modified**: 2-3

---

## Objective

Update OrderForm.tsx to display selected package information and provide better UX when entering article/quantity.

**Success Criteria**:
- ✅ User sees which package will be selected based on quantity
- ✅ Package info updates dynamically as quantity changes
- ✅ Clear indication of min/multiple/max rules
- ✅ No breaking changes to existing order creation flow

---

## Tasks

### Task 1: Fetch Package Variants from API - AUTO

**File**: `archibald-web-app/frontend/src/api/products.ts` (or similar)

Add API endpoint to fetch package variants:

```typescript
export async function getProductVariants(articleName: string): Promise<Product[]> {
  const response = await fetch(`/api/products/variants?name=${encodeURIComponent(articleName)}`);
  if (!response.ok) {
    throw new Error('Failed to fetch product variants');
  }
  return response.json();
}
```

**Backend endpoint** (if doesn't exist):

**File**: `archibald-web-app/backend/src/index.ts` (or routes file)

```typescript
app.get('/api/products/variants', (req, res) => {
  const { name } = req.query;

  if (!name || typeof name !== 'string') {
    return res.status(400).json({ error: 'Article name required' });
  }

  const variants = productDb.getProductVariants(name);
  res.json(variants);
});
```

---

### Task 2: Add Package Info Component - AUTO

**File**: `archibald-web-app/frontend/src/components/PackageInfo.tsx` (new)

```typescript
import React from 'react';
import type { Product } from '../types/product';

interface PackageInfoProps {
  variants: Product[];
  selectedVariant: Product | null;
  quantity: number;
}

export function PackageInfo({ variants, selectedVariant, quantity }: PackageInfoProps) {
  if (variants.length === 0) {
    return null;
  }

  if (variants.length === 1) {
    const variant = variants[0];
    return (
      <div className="package-info single-variant">
        <span className="label">Package:</span>
        <span className="value">{variant.packageContent || '1'}-piece</span>
        {variant.multipleQty && (
          <span className="rule">
            (multiples of {variant.multipleQty})
          </span>
        )}
      </div>
    );
  }

  // Multiple variants
  return (
    <div className="package-info multi-variant">
      <span className="label">Selected package:</span>
      {selectedVariant ? (
        <span className="value selected">
          {selectedVariant.packageContent}-piece
          {selectedVariant.multipleQty && ` (multiples of ${selectedVariant.multipleQty})`}
        </span>
      ) : (
        <span className="value">Enter quantity to see package</span>
      )}

      <details className="package-options">
        <summary>Available packages</summary>
        <ul>
          {variants.map((variant) => (
            <li key={variant.id}>
              <strong>{variant.packageContent}-piece</strong>
              {' - '}
              min: {variant.minQty || 'N/A'},
              multiple: {variant.multipleQty || 'N/A'},
              max: {variant.maxQty || 'N/A'}
            </li>
          ))}
        </ul>
      </details>
    </div>
  );
}
```

---

### Task 3: Update OrderForm to Show Package Info - AUTO

**File**: `archibald-web-app/frontend/src/components/OrderForm.tsx`

Add state for package variants:

```typescript
const [packageVariants, setPackageVariants] = useState<Record<number, Product[]>>({});
const [selectedVariants, setSelectedVariants] = useState<Record<number, Product | null>>({});

// Fetch variants when article code changes
useEffect(() => {
  for (const [index, item] of items.entries()) {
    if (item.articleCode && !packageVariants[index]) {
      getProductVariants(item.articleCode)
        .then((variants) => {
          setPackageVariants((prev) => ({ ...prev, [index]: variants }));
        })
        .catch((error) => {
          console.error('Failed to fetch variants:', error);
        });
    }
  }
}, [items]);

// Update selected variant when quantity changes
useEffect(() => {
  for (const [index, item] of items.entries()) {
    const variants = packageVariants[index];
    if (variants && item.quantity) {
      const selected = selectPackageVariant(variants, item.quantity);
      setSelectedVariants((prev) => ({ ...prev, [index]: selected }));
    }
  }
}, [items, packageVariants]);

// Helper function (mirrors backend logic)
function selectPackageVariant(variants: Product[], quantity: number): Product | null {
  if (variants.length === 0) return null;
  if (variants.length === 1) return variants[0];

  const sorted = [...variants].sort((a, b) =>
    (b.multipleQty || 0) - (a.multipleQty || 0)
  );

  const highestMultiple = sorted[0].multipleQty || 1;

  if (quantity >= highestMultiple) {
    return sorted[0];
  } else {
    return sorted[sorted.length - 1];
  }
}
```

Add PackageInfo component to order item:

```typescript
{items.map((item, index) => (
  <div key={index} className="order-item">
    {/* Existing fields: articleCode, quantity, price, discount */}
    <input
      value={item.articleCode}
      onChange={(e) => handleArticleChange(index, e.target.value)}
      placeholder="Article code"
    />

    <input
      type="number"
      value={item.quantity}
      onChange={(e) => handleQuantityChange(index, parseInt(e.target.value))}
      placeholder="Quantity"
    />

    {/* NEW: Package info */}
    <PackageInfo
      variants={packageVariants[index] || []}
      selectedVariant={selectedVariants[index] || null}
      quantity={item.quantity}
    />

    {/* ... rest of fields */}
  </div>
))}
```

---

### Task 4: Add Styling - AUTO

**File**: `archibald-web-app/frontend/src/components/PackageInfo.css` (or inline styles)

```css
.package-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background-color: #f5f5f5;
  border-radius: 4px;
  font-size: 0.9rem;
}

.package-info .label {
  font-weight: 500;
  color: #666;
}

.package-info .value {
  color: #333;
}

.package-info .value.selected {
  font-weight: 600;
  color: #2563eb;
}

.package-info .rule {
  font-size: 0.85rem;
  color: #888;
  font-style: italic;
}

.package-options {
  margin-left: auto;
}

.package-options summary {
  cursor: pointer;
  color: #2563eb;
  text-decoration: underline;
}

.package-options ul {
  list-style: none;
  padding: 0.5rem;
  margin: 0.5rem 0 0 0;
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.package-options li {
  padding: 0.25rem 0;
}
```

---

### Task 5: Test UX Flow - CHECKPOINT:human-verify

**Manual testing**:

1. Open OrderForm
2. Enter article "H129FSQ.104.023"
3. **Verify**: Package info shows "Enter quantity to see package"
4. Enter quantity 10
5. **Verify**: Package info shows "5-piece (multiples of 5)"
6. Change quantity to 3
7. **Verify**: Package info updates to "1-piece (multiples of 1)"
8. Click "Available packages" dropdown
9. **Verify**: Shows both 5-piece and 1-piece options with rules
10. Test with single-package article "TD1272.314"
11. **Verify**: Shows "1-piece (multiples of 1)" without dropdown

---

## Files Changed

- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Add package display logic
- `archibald-web-app/frontend/src/components/PackageInfo.tsx` - New component (create)
- `archibald-web-app/frontend/src/api/products.ts` - Add getProductVariants() (or create)
- `archibald-web-app/backend/src/index.ts` - Add /api/products/variants endpoint
- Styles (inline or separate CSS file)

---

## Dependencies

**Requires**:
- 03-02 (getProductVariants function in backend)
- 03-03 (backend can return variant info)

**Blocks**:
- 03-06 (validation UI builds on this)

---

## Acceptance Criteria

- ✅ PackageInfo component displays correctly
- ✅ Selected package updates dynamically with quantity
- ✅ Single-variant and multi-variant articles handled
- ✅ API endpoint returns package variants
- ✅ No breaking changes to existing form
- ✅ Responsive design (mobile friendly)

---

## Notes

- This is **display only** - no validation yet (that's 03-06)
- Helps users understand which package will be selected
- Mirrors backend logic in frontend for preview
- Can be enhanced with icons/colors later
