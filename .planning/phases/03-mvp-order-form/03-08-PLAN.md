# Phase 3 Plan 08: CRITICAL - Refactor Archibald Bot Order Flow

**Type**: refactor + integration
**Priority**: ðŸ”´ CRITICAL - BLOCKS ALL PHASE 3 WORK
**Dependencies**: 03-03 (package selection logic ready)
**Estimated Complexity**: Very High
**Files Modified**: 1 major file
**Duration Estimate**: 3-4 hours

---

## Objective

**CRITICAL FIX**: Refactor `archibald-bot.ts` to match actual Archibald UI flow discovered from screenshots. Current bot uses wrong menu names, wrong field selectors, and wrong workflow. Without this fix, no order can be created.

**Success Criteria**:
- âœ… Bot successfully navigates to order creation form
- âœ… Bot selects customer via "Profilo cliente" dropdown
- âœ… Bot inserts articles with correct package variant selection
- âœ… Bot handles multi-article orders with Update button
- âœ… Bot saves order with "Salva e chiudi"
- âœ… Real order created end-to-end in production Archibald

---

## Problem Statement

Current bot flow is **completely misaligned** with actual Archibald UI:

| Step | Current Bot (WRONG) | Actual Archibald UI |
|------|---------------------|---------------------|
| Menu | "Inserimento ordini" | "Ordini" |
| Customer | Text input "Account esterno" | Dropdown "Profilo cliente" â†’ search â†’ select row |
| Article | Single search | Dropdown "Nome articolo" â†’ search â†’ select variant |
| Save | Direct save button | Dropdown "Salvare" â†’ "Salva e chiudi" |
| Multi-article | Unknown/broken | Click "New" + "Update" per article |

**Impact**: Bot cannot create any orders. Phase 3 blocked.

---

## Implementation Strategy

### Approach: Incremental Refactor with Checkpoints

1. **Backup current implementation** (safety)
2. **Create helper methods** for reusable patterns
3. **Refactor step-by-step** with intermediate tests
4. **Verify each checkpoint** with real Archibald
5. **Integrate package selection logic** (already working from 03-03)

### Risk Mitigation

- Keep old code commented for reference
- Test each step before proceeding
- Screenshot every major step for debugging
- Use operation reports to track timing

---

## Tasks

### CHECKPOINT 0: Preparation (MANUAL)

**Goal**: Set up testing environment and backup

**Actions**:
1. Commit current state (clean working tree)
2. Create backup branch `backup/pre-bot-refactor`
3. Verify Archibald test credentials work
4. Ensure test customer "Fresis Soc Cooperativa" exists
5. Identify 2 test articles (1 single-package, 1 multi-package)

**Verification**:
- [ ] Git status clean
- [ ] Backup branch created
- [ ] Can login to Archibald manually
- [ ] Test customer exists
- [ ] Test articles in database

---

### Task 1: Document UI Selectors from Screenshots (AUTO)

**File**: Create `.planning/archibald-ui-selectors.md`

**Goal**: Extract all UI element patterns from 17 screenshots

**Actions**:
1. Read all 17 screenshots in order
2. Document text patterns for each step:
   - #1: "Ordini" menu link
   - #2: "Nuovo" button in orders list
   - #3: "Profilo cliente" dropdown (or "PROFILO CLIENTE")
   - #4: "Enter text to search" input in dropdown
   - #5: Customer row in filtered table
   - #6: "New" button in "Linee di vendita"
   - #7: "Nome articolo" dropdown
   - #8: "Enter text to search" for articles
   - #9-10: Article rows with package variants
   - #11: "QtÃ  ordinata" cell
   - #12: "Applica sconto %" cell
   - #13: "Update" button (floppy icon)
   - #16: "Salvare" dropdown
   - #17: "Salva e chiudi" option
3. Document DevExpress class patterns (dxe, dx-, dxgv, etc.)
4. Note structural relationships (parent-child, siblings)

**Output**: Selector strategy document

**Verification**:
- [ ] All 17 steps documented
- [ ] Class patterns identified
- [ ] Fallback selectors listed

**Commit**: `docs(03-08): document archibald ui selectors from screenshots`

---

### Task 2: Create Helper Methods (TDD) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Extract reusable patterns into testable helper methods

**Helpers to create**:

```typescript
/**
 * Find and click element by text content
 * @returns true if clicked, false if not found
 */
private async clickElementByText(
  text: string,
  options?: {
    exact?: boolean;
    selectors?: string[];
    timeout?: number;
  }
): Promise<boolean>

/**
 * Find DevExpress dropdown by label text and click arrow
 * @returns true if dropdown opened
 */
private async openDevExpressDropdown(
  labelText: string,
  options?: { timeout?: number }
): Promise<boolean>

/**
 * Type in dropdown search and wait for filtering
 */
private async searchInDropdown(
  searchText: string,
  options?: { timeout?: number }
): Promise<void>

/**
 * Select row in dropdown table by text match
 */
private async selectDropdownRow(
  matchText: string,
  options?: { exact?: boolean }
): Promise<boolean>

/**
 * Double-click cell and type value (for quantity, discount)
 */
private async editTableCell(
  cellText: string,
  value: string | number
): Promise<void>

/**
 * Wait for DevExpress loading indicator to disappear
 */
private async waitForDevExpressReady(
  options?: { timeout?: number }
): Promise<void>
```

**Actions**:
1. Create each helper method with inline documentation
2. Use consistent error handling
3. Add detailed logging
4. Make methods reusable across different UI elements

**Verification**:
- [ ] 6 helper methods created
- [ ] TypeScript compiles without errors
- [ ] All methods have JSDoc comments

**Commit**: `refactor(03-08): add helper methods for devexpress ui interaction`

---

### Task 3: Refactor Navigation (Steps 1-3) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Fix menu navigation from Announcements â†’ Orders â†’ New

**Current code** (lines ~522-718):
- Searches for "Inserimento ordini" âŒ
- Searches for "Nuovo" âœ… (correct)

**New implementation**:

```typescript
// STEP 1: Click "Ordini" in left menu
await this.runOp("order.menu.ordini", async () => {
  logger.debug('Clicking "Ordini" menu item...');

  const clicked = await this.clickElementByText("Ordini", {
    exact: true,
    selectors: ["a", "span", "div"],
  });

  if (!clicked) {
    throw new Error('Menu "Ordini" not found');
  }

  // Wait for orders list page to load
  await this.page!.waitForFunction(
    () => document.querySelector('span')?.textContent?.includes('Nuovo'),
    { timeout: 5000 }
  );

  logger.info('âœ… Navigated to orders list');
});

// STEP 2: Click "Nuovo" button
await this.runOp("order.click_nuovo", async () => {
  logger.debug('Clicking "Nuovo" button...');

  const clicked = await this.clickElementByText("Nuovo", {
    exact: true,
    selectors: ["button", "a", "span"],
  });

  if (!clicked) {
    throw new Error('Button "Nuovo" not found');
  }

  // Wait for order form to load (check for input fields)
  await this.waitForDevExpressReady({ timeout: 5000 });

  logger.info('âœ… Order form loaded');
});
```

**Verification**:
- [ ] Code compiles
- [ ] Navigation reaches order form
- [ ] Screenshots saved at each step

**Test** (manual with TEST_CREATE_ORDER=true):
```bash
# Should navigate successfully, then fail at customer selection (expected)
TEST_CREATE_ORDER=true npx tsx src/test-package-selection.ts
```

**Expected**: Bot reaches order form, fails at customer (not yet implemented)

**Commit**: `fix(03-08): update navigation to use 'ordini' menu`

---

### CHECKPOINT 1: Navigation Verification (MANUAL)

**Verification Steps**:
1. Run test script: `TEST_CREATE_ORDER=true npx tsx src/test-package-selection.ts`
2. Check operation report in `logs/`
3. Verify screenshots show:
   - âœ… Orders list page (after clicking Ordini)
   - âœ… Order creation form (after clicking Nuovo)
4. Verify error is "customer not found" (next step)

**If checkpoint fails**: Debug navigation before proceeding

---

### Task 4: Refactor Customer Selection (Steps 4-7) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Implement "Profilo cliente" dropdown workflow

**Current code** (lines ~750-900):
- Searches for text input "Account esterno" âŒ
- Types directly âŒ

**New implementation**:

```typescript
// STEP 3: Select customer via "Profilo cliente" dropdown
await this.runOp("order.customer.select", async () => {
  logger.debug('Opening "Profilo cliente" dropdown...');

  // 3.1: Find and click dropdown arrow
  const dropdownOpened = await this.openDevExpressDropdown("PROFILO CLIENTE", {
    timeout: 3000,
  });

  if (!dropdownOpened) {
    throw new Error('Dropdown "Profilo cliente" not found');
  }

  logger.debug('Dropdown opened, waiting for search input...');
  await this.wait(500); // Let dropdown render

  // 3.2: Find "Enter text to search" input
  await this.searchInDropdown(orderData.customerName, { timeout: 2000 });

  logger.debug(`Searching for customer: ${orderData.customerName}`);
  await this.wait(1000); // Wait for table filtering

  // 3.3: Select matching row in filtered table
  const rowSelected = await this.selectDropdownRow(orderData.customerName, {
    exact: false, // Allow partial match
  });

  if (!rowSelected) {
    throw new Error(`Customer "${orderData.customerName}" not found in dropdown`);
  }

  logger.info(`âœ… Customer selected: ${orderData.customerName}`);

  // Wait for customer data to load
  await this.waitForDevExpressReady({ timeout: 3000 });
});
```

**Implementation details for helpers**:

```typescript
private async openDevExpressDropdown(labelText: string): Promise<boolean> {
  return await this.page!.evaluate((label) => {
    // Find label by text
    const allElements = Array.from(document.querySelectorAll("span, td, div, label"));
    const labelEl = allElements.find(el =>
      el.textContent?.toUpperCase().trim() === label.toUpperCase()
    );

    if (!labelEl) return false;

    // Find dropdown arrow near label (sibling or parent's sibling)
    const parent = labelEl.parentElement;
    if (!parent) return false;

    // Look for DevExpress dropdown image (arrow icon)
    const dropdownArrow = parent.querySelector('img[id*="DDD"], img[id*="_B-1"]');
    if (dropdownArrow) {
      (dropdownArrow as HTMLElement).click();
      return true;
    }

    // Fallback: look for clickable parent
    const clickable = parent.closest('[id*="DDD"], [onclick], a, button');
    if (clickable) {
      (clickable as HTMLElement).click();
      return true;
    }

    return false;
  }, labelText);
}

private async searchInDropdown(searchText: string): Promise<void> {
  // Find "Enter text to search" input in visible dropdown
  const searchInput = await this.page!.$('input[type="text"]:not([style*="display: none"])');

  if (!searchInput) {
    throw new Error('Search input not found in dropdown');
  }

  // Clear and type
  await searchInput.click({ clickCount: 3 }); // Select all
  await searchInput.type(searchText);
  await this.page!.keyboard.press('Enter'); // Trigger filter
}

private async selectDropdownRow(matchText: string): Promise<boolean> {
  return await this.page!.evaluate((text) => {
    // Find all visible table rows in dropdown
    const rows = Array.from(document.querySelectorAll('tr[class*="dxgvDataRow"]'));

    const matchedRow = rows.find(row => {
      const htmlRow = row as HTMLElement;
      const isVisible = htmlRow.offsetParent !== null;
      const rowText = row.textContent?.trim() || "";
      return isVisible && rowText.includes(text);
    });

    if (matchedRow) {
      const firstCell = matchedRow.querySelector('td');
      if (firstCell) {
        (firstCell as HTMLElement).click();
        return true;
      }
    }

    return false;
  }, matchText);
}
```

**Verification**:
- [ ] Code compiles
- [ ] Helper methods created
- [ ] Customer selection logic complete

**Commit**: `feat(03-08): implement profilo cliente dropdown selection`

---

### CHECKPOINT 2: Customer Selection Verification (MANUAL)

**Verification Steps**:
1. Run test script with valid customer
2. Check operation report
3. Verify screenshots show:
   - âœ… Dropdown opened
   - âœ… Search input filled
   - âœ… Customer selected
   - âœ… Customer data loaded (anagrafica visible)
4. Verify error is "article not found" (next step)

**If checkpoint fails**: Debug customer dropdown before proceeding

---

### Task 5: Refactor Article Selection with Variant Logic (Steps 8-10) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Implement "Nome articolo" dropdown with package variant selection (03-03 logic)

**Current code** (lines ~1550-1700):
- Has variant selection logic âœ… (from 03-03)
- Wrong dropdown interaction âŒ

**New implementation**:

```typescript
// STEP 4: Click "New" button in Linee di vendita
await this.runOp("order.lineditems.click_new", async () => {
  logger.debug('Clicking "New" in Linee di vendita...');

  const clicked = await this.clickElementByText("New", {
    exact: true,
    selectors: ["button", "a", "img", "span"],
  });

  if (!clicked) {
    throw new Error('Button "New" in line items not found');
  }

  await this.wait(500); // Let new row appear
  logger.info('âœ… New line item row created');
});

// STEP 5: For each item, select article with variant logic
for (let i = 0; i < orderData.items.length; i++) {
  const item = orderData.items[i];

  await this.runOp(`order.item.${i}.select_article`, async () => {
    logger.info(`Processing item ${i + 1}/${orderData.items.length}`, {
      articleCode: item.articleCode,
      quantity: item.quantity,
    });

    // 5.1: Query database for correct package variant
    const selectedVariant = this.productDb.selectPackageVariant(
      item.articleCode,
      item.quantity
    );

    if (!selectedVariant) {
      throw new Error(
        `Article ${item.articleCode} not found in database. ` +
        `Ensure product sync has run.`
      );
    }

    logger.info(`Selected package variant for ${item.articleCode}`, {
      variantId: selectedVariant.id,
      packageContent: selectedVariant.packageContent,
      multipleQty: selectedVariant.multipleQty,
      quantity: item.quantity,
    });

    // 5.2: Open "Nome articolo" dropdown
    const dropdownOpened = await this.openDevExpressDropdown("NOME ARTICOLO");

    if (!dropdownOpened) {
      throw new Error('Dropdown "Nome articolo" not found');
    }

    await this.wait(500);

    // 5.3: Search by VARIANT ID (not article name)
    await this.searchInDropdown(selectedVariant.id);
    logger.debug(`Searching for variant ID: ${selectedVariant.id}`);

    await this.wait(1000); // Wait for filtering

    // 5.4: Select matching row (should be unique by variant ID)
    const rowSelected = await this.selectDropdownRow(selectedVariant.id, {
      exact: false,
    });

    if (!rowSelected) {
      throw new Error(
        `Variant ID ${selectedVariant.id} not found in dropdown. ` +
        `Article: ${item.articleCode}, package: ${selectedVariant.packageContent}`
      );
    }

    logger.info(`âœ… Article variant selected`, {
      variantId: selectedVariant.id,
      packageContent: selectedVariant.packageContent,
    });

    // Populate metadata
    item.articleId = selectedVariant.id;
    item.packageContent = selectedVariant.packageContent
      ? parseInt(selectedVariant.packageContent)
      : undefined;

    // Wait for article to load
    await this.waitForDevExpressReady({ timeout: 3000 });
  });
}
```

**Verification**:
- [ ] Code compiles
- [ ] Package variant logic integrated
- [ ] Dropdown workflow implemented

**Commit**: `feat(03-08): integrate variant selection in article dropdown`

---

### Task 6: Implement Quantity and Discount Input (Steps 11-12) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Double-click cells and type values

**New implementation**:

```typescript
// STEP 6: Set quantity
await this.runOp(`order.item.${i}.set_quantity`, async () => {
  logger.debug(`Setting quantity: ${item.quantity}`);

  await this.editTableCell("QtÃ  ordinata", item.quantity);

  logger.info(`âœ… Quantity set: ${item.quantity}`);
  await this.wait(300);
});

// STEP 7: Set discount (optional)
if (item.discount && item.discount > 0) {
  await this.runOp(`order.item.${i}.set_discount`, async () => {
    logger.debug(`Setting discount: ${item.discount}%`);

    await this.editTableCell("Applica sconto", item.discount);

    logger.info(`âœ… Discount set: ${item.discount}%`);
    await this.wait(300);
  });
}
```

**Implementation of editTableCell**:

```typescript
private async editTableCell(
  cellLabelText: string,
  value: string | number
): Promise<void> {
  // Find cell by nearby label text
  const cellFound = await this.page!.evaluate(
    (label, val) => {
      // Find all table cells
      const cells = Array.from(document.querySelectorAll('td'));

      // Find cell with label matching
      const labelCell = cells.find(cell =>
        cell.textContent?.toLowerCase().includes(label.toLowerCase())
      );

      if (!labelCell) return false;

      // Find input in same row or next cell
      const row = labelCell.closest('tr');
      if (!row) return false;

      const input = row.querySelector('input[type="text"]') as HTMLInputElement;
      if (!input) return false;

      // Double-click to edit
      input.focus();
      input.click();

      // Clear and set value
      input.value = String(val);

      // Trigger change event
      input.dispatchEvent(new Event('input', { bubbles: true }));
      input.dispatchEvent(new Event('change', { bubbles: true }));

      return true;
    },
    cellLabelText,
    value
  );

  if (!cellFound) {
    throw new Error(`Cell "${cellLabelText}" not found`);
  }
}
```

**Verification**:
- [ ] Code compiles
- [ ] Quantity input implemented
- [ ] Discount input implemented (conditional)

**Commit**: `feat(03-08): implement quantity and discount cell editing`

---

### Task 7: Implement Update Button Click (Step 13) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Click Update (floppy icon) after each article

**New implementation**:

```typescript
// STEP 8: Click "Update" button to save line item
await this.runOp(`order.item.${i}.click_update`, async () => {
  logger.debug('Clicking "Update" button...');

  // Find Update button (floppy disk icon)
  const clicked = await this.page!.evaluate(() => {
    // Look for button with title/alt "Update" or image with floppy icon
    const buttons = Array.from(document.querySelectorAll('a, button, img'));

    const updateBtn = buttons.find(btn => {
      const title = (btn as HTMLElement).title?.toLowerCase() || "";
      const alt = (btn as HTMLImageElement).alt?.toLowerCase() || "";
      const id = (btn as HTMLElement).id?.toLowerCase() || "";

      return (
        title.includes('update') ||
        alt.includes('update') ||
        id.includes('update') ||
        title.includes('salva') ||
        alt.includes('salva')
      );
    });

    if (updateBtn) {
      (updateBtn as HTMLElement).click();
      return true;
    }

    return false;
  });

  if (!clicked) {
    throw new Error('Button "Update" not found');
  }

  logger.info(`âœ… Line item ${i + 1} saved`);

  // Wait for save to complete
  await this.waitForDevExpressReady({ timeout: 2000 });
});
```

**Verification**:
- [ ] Code compiles
- [ ] Update button click implemented

**Commit**: `feat(03-08): add update button click after each article`

---

### Task 8: Implement Multi-Article Loop (Step 14-15) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Click "New" again for additional articles

**New implementation**:

```typescript
// After first article, click "New" for each additional article
if (i < orderData.items.length - 1) {
  await this.runOp(`order.item.${i}.click_new_for_next`, async () => {
    logger.debug('Clicking "New" for next article...');

    const clicked = await this.clickElementByText("New", {
      exact: true,
      selectors: ["button", "a", "img", "span"],
    });

    if (!clicked) {
      throw new Error('Button "New" not found for next article');
    }

    await this.wait(500);
    logger.info(`âœ… Ready for article ${i + 2}`);
  });
}
```

**Verification**:
- [ ] Code compiles
- [ ] Multi-article loop implemented

**Commit**: `feat(03-08): implement multi-article loop with new button`

---

### CHECKPOINT 3: Article Flow Verification (MANUAL)

**Verification Steps**:
1. Create test order with 2 articles (different packages)
2. Check operation report
3. Verify screenshots show:
   - âœ… First article selected correctly
   - âœ… Quantity set
   - âœ… Update clicked
   - âœ… New clicked for second article
   - âœ… Second article selected
4. Verify error is "save not found" (next step)

**If checkpoint fails**: Debug article flow before proceeding

---

### Task 9: Implement Final Save (Steps 16-17) (AUTO)

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Goal**: Click "Salvare" dropdown â†’ "Salva e chiudi"

**New implementation**:

```typescript
// STEP 9: Save and close order
await this.runOp("order.save_and_close", async () => {
  logger.debug('Opening "Salvare" dropdown...');

  // 9.1: Find "Salvare" button/dropdown
  const dropdownOpened = await this.page!.evaluate(() => {
    const allElements = Array.from(document.querySelectorAll('span, button, a'));

    const salvareBtn = allElements.find(el => {
      const text = el.textContent?.trim() || "";
      return text.toLowerCase().includes('salvare');
    });

    if (!salvareBtn) return false;

    // Click dropdown arrow (usually next sibling or child img)
    const parent = salvareBtn.parentElement;
    if (!parent) return false;

    const arrow = parent.querySelector('img[id*="_B-1"], img[alt*="down"]');
    if (arrow) {
      (arrow as HTMLElement).click();
      return true;
    }

    // Fallback: click the button itself
    (salvareBtn as HTMLElement).click();
    return true;
  });

  if (!dropdownOpened) {
    throw new Error('Button "Salvare" not found');
  }

  await this.wait(500); // Wait for dropdown menu

  // 9.2: Click "Salva e chiudi" option
  const saveClicked = await this.clickElementByText("Salva e chiudi", {
    exact: true,
    selectors: ["a", "span", "div"],
  });

  if (!saveClicked) {
    throw new Error('Option "Salva e chiudi" not found in dropdown');
  }

  logger.info('âœ… Clicked "Salva e chiudi"');

  // Wait for save to complete and redirect
  await this.wait(3000);
});

// STEP 10: Extract order ID from URL or success message
await this.runOp("order.extract_id", async () => {
  const currentUrl = this.page!.url();
  logger.debug(`Current URL after save: ${currentUrl}`);

  // Try to extract order ID from URL
  // Pattern: /SALESTABLE_DetailViewAgent/?ObjectKey=...
  const urlMatch = currentUrl.match(/ObjectKey=([^&]+)/);
  if (urlMatch) {
    orderId = decodeURIComponent(urlMatch[1]);
    logger.info(`âœ… Order created with ID: ${orderId}`);
    return;
  }

  // Fallback: look for success message
  const successMessage = await this.page!.evaluate(() => {
    const messages = Array.from(document.querySelectorAll('div, span'));
    const success = messages.find(el =>
      el.textContent?.toLowerCase().includes('salvato') ||
      el.textContent?.toLowerCase().includes('creato')
    );
    return success?.textContent?.trim() || null;
  });

  if (successMessage) {
    logger.info(`Success message: ${successMessage}`);
    orderId = successMessage; // Use message as ID
  } else {
    logger.warn('Order ID not found, using timestamp');
    orderId = `ORDER-${Date.now()}`;
  }
});
```

**Verification**:
- [ ] Code compiles
- [ ] Save dropdown implemented
- [ ] Order ID extraction attempted

**Commit**: `feat(03-08): implement salva e chiudi final save`

---

### Task 10: Integration Testing (AUTO + MANUAL)

**Goal**: Verify complete end-to-end flow with real Archibald

**Test Cases**:

1. **Single article, no discount**
   ```typescript
   {
     customerName: "Fresis Soc Cooperativa",
     items: [
       { articleCode: "TD1272.314", quantity: 5, price: 0, description: "" }
     ]
   }
   ```

2. **Single article with discount**
   ```typescript
   {
     customerName: "Fresis Soc Cooperativa",
     items: [
       { articleCode: "TD1272.314", quantity: 5, price: 0, description: "", discount: 10 }
     ]
   }
   ```

3. **Multi-package article, low quantity**
   ```typescript
   {
     customerName: "Fresis Soc Cooperativa",
     items: [
       { articleCode: "10839.314.016", quantity: 3, price: 0, description: "" }
     ]
   }
   ```
   **Expected**: Selects 1-piece package (005159K3)

4. **Multi-package article, high quantity**
   ```typescript
   {
     customerName: "Fresis Soc Cooperativa",
     items: [
       { articleCode: "10839.314.016", quantity: 10, price: 0, description: "" }
     ]
   }
   ```
   **Expected**: Selects 5-piece package (005159K2)

5. **Two articles, mixed packages**
   ```typescript
   {
     customerName: "Fresis Soc Cooperativa",
     items: [
       { articleCode: "TD1272.314", quantity: 5, price: 0, description: "" },
       { articleCode: "10839.314.016", quantity: 8, price: 0, description: "" }
     ]
   }
   ```

**Test Script**:

```bash
# Run each test case
TEST_CREATE_ORDER=true TEST_CASE=1 npx tsx src/test-package-selection.ts
TEST_CREATE_ORDER=true TEST_CASE=2 npx tsx src/test-package-selection.ts
TEST_CREATE_ORDER=true TEST_CASE=3 npx tsx src/test-package-selection.ts
TEST_CREATE_ORDER=true TEST_CASE=4 npx tsx src/test-package-selection.ts
TEST_CREATE_ORDER=true TEST_CASE=5 npx tsx src/test-package-selection.ts
```

**Verification**:
- [ ] All 5 test cases pass
- [ ] Orders visible in Archibald
- [ ] Correct packages selected
- [ ] Quantities correct
- [ ] Discounts applied (where specified)

**Commit**: `test(03-08): add end-to-end integration tests for bot`

---

### CHECKPOINT 4: Final Verification (MANUAL)

**Complete Verification Checklist**:

1. **Functionality**:
   - [ ] Single article orders work
   - [ ] Multi-article orders work
   - [ ] Package selection correct (high/low quantity)
   - [ ] Discounts applied correctly
   - [ ] Order IDs extracted

2. **Code Quality**:
   - [ ] TypeScript compiles (even with pre-existing DOM errors)
   - [ ] Prettier formatted
   - [ ] No eslint errors
   - [ ] All helper methods documented

3. **Performance**:
   - [ ] Order creation < 5 min
   - [ ] No unnecessary waits
   - [ ] Dynamic waits used where possible

4. **Reliability**:
   - [ ] Handles missing articles gracefully
   - [ ] Handles missing customers gracefully
   - [ ] Screenshots on errors
   - [ ] Operation reports generated

5. **Documentation**:
   - [ ] UI selectors documented
   - [ ] All commits follow conventional format
   - [ ] SUMMARY.md created

---

## Files Changed

### Modified
- `archibald-web-app/backend/src/archibald-bot.ts` - Complete refactor (~500 lines changed)

### Created
- `.planning/archibald-ui-selectors.md` - UI selector documentation
- `.planning/bot-refactor-analysis.md` - Analysis and strategy (already exists)

---

## Acceptance Criteria

- âœ… Bot navigates correctly: Announcements â†’ Ordini â†’ Nuovo
- âœ… Customer selected via "Profilo cliente" dropdown
- âœ… Articles selected via "Nome articolo" dropdown
- âœ… Package variant selection logic works (from 03-03)
- âœ… Quantity and discount input work
- âœ… Update button clicked after each article
- âœ… Multi-article orders work (New button loop)
- âœ… Order saved via "Salva e chiudi"
- âœ… Order ID extracted
- âœ… All 5 test cases pass
- âœ… Code quality maintained (formatting, types, docs)

---

## Risks & Mitigations

**Risk**: DevExpress dynamic IDs change between sessions
**Mitigation**: Use text-based selectors + class patterns + structural fallbacks

**Risk**: Timing issues with async operations
**Mitigation**: Use `waitForFunction` instead of fixed waits

**Risk**: Breaking existing functionality
**Mitigation**: Keep old code commented, backup branch, incremental testing

**Risk**: Selector not found errors
**Mitigation**: Multiple fallback selectors, detailed error messages, screenshots

---

## Rollback Plan

If refactor fails:
1. Revert commits: `git reset --hard backup/pre-bot-refactor`
2. Restore from backup branch
3. Document blocking issues
4. Create smaller, more focused plan

---

## Success Metrics

- **Orders created**: â‰¥ 5 test orders in production Archibald
- **Success rate**: 100% (all test cases pass)
- **Duration**: Order creation < 5 min
- **Code coverage**: All new helper methods used
- **Documentation**: UI selectors fully documented

---

## Notes

- This is a **CRITICAL** refactor - blocks all Phase 3 work
- Must be tested thoroughly before proceeding
- Package selection logic from 03-03 is preserved and integrated
- Use operation reports for performance optimization
- Keep screenshots of every major step for debugging
