# Phase 3 Plan 02: Package Variant Database Functions

**Type**: tdd
**Dependencies**: 03-01 (discovery complete)
**Estimated Complexity**: Medium
**Files Modified**: 2-3

---

## Objective

Implement database functions to query and select package variants based on article name and quantity.

**Success Criteria**:
- ✅ `getProductVariants()` returns all package variants for an article
- ✅ `selectPackageVariant()` returns correct variant based on quantity logic
- ✅ Functions have comprehensive unit tests
- ✅ Edge cases handled (no variants, single variant, multiple variants)

---

## Tasks

### Task 1: Write Unit Tests (TDD) - AUTO

**File**: `archibald-web-app/backend/src/product-db.test.ts`

Create test cases for new functions:

```typescript
describe('getProductVariants', () => {
  test('returns all variants for multi-package article', () => {
    // Given: H129FSQ.104.023 has 2 variants (5-piece and 1-piece)
    // When: getProductVariants('H129FSQ.104.023')
    // Then: returns 2 products ordered by multipleQty DESC
  });

  test('returns single variant for single-package article', () => {
    // Given: TD1272.314 has 1 variant
    // When: getProductVariants('TD1272.314')
    // Then: returns 1 product
  });

  test('returns empty array for non-existent article', () => {
    // Given: Article 'NONEXISTENT' does not exist
    // When: getProductVariants('NONEXISTENT')
    // Then: returns []
  });
});

describe('selectPackageVariant', () => {
  test('selects highest package when quantity >= highest multiple', () => {
    // Given: H129FSQ.104.023 variants [5-piece, 1-piece]
    // When: selectPackageVariant('H129FSQ.104.023', 10)
    // Then: returns 5-piece variant (016869K2)
  });

  test('selects lowest package when quantity < highest multiple', () => {
    // Given: H129FSQ.104.023 variants [5-piece, 1-piece]
    // When: selectPackageVariant('H129FSQ.104.023', 3)
    // Then: returns 1-piece variant (016869K3)
  });

  test('selects only variant when single package', () => {
    // Given: TD1272.314 has 1 variant
    // When: selectPackageVariant('TD1272.314', 5)
    // Then: returns that variant
  });

  test('returns null when article not found', () => {
    // Given: Article does not exist
    // When: selectPackageVariant('NONEXISTENT', 5)
    // Then: returns null
  });

  test('handles edge case: quantity equals highest multiple', () => {
    // Given: H129FSQ.104.023 variants [5-piece, 1-piece]
    // When: selectPackageVariant('H129FSQ.104.023', 5)
    // Then: returns 5-piece variant (exactly at threshold)
  });

  test('handles edge case: quantity = 1', () => {
    // Given: H129FSQ.104.023 variants [5-piece, 1-piece]
    // When: selectPackageVariant('H129FSQ.104.023', 1)
    // Then: returns 1-piece variant
  });
});
```

**Acceptance Criteria**:
- All tests written following TDD principles
- Tests use parameterized inputs (no magic numbers)
- Test descriptions match assertions
- Edge cases covered

---

### Task 2: Implement `getProductVariants()` - AUTO

**File**: `archibald-web-app/backend/src/product-db.ts`

```typescript
/**
 * Get all package variants for an article.
 * Variants are products with same name but different ID ARTICOLO.
 *
 * @param articleName - Article name (e.g., "H129FSQ.104.023")
 * @returns Array of products ordered by multipleQty DESC (highest package first)
 */
getProductVariants(articleName: string): Product[] {
  const query = `
    SELECT * FROM products
    WHERE name = ?
    ORDER BY multipleQty DESC NULLS LAST, id ASC
  `;

  return this.db.prepare(query).all(articleName) as Product[];
}
```

**Implementation Notes**:
- Order by `multipleQty DESC` to get highest package first
- `NULLS LAST` handles products without multipleQty
- Secondary sort by `id ASC` for deterministic ordering

**Acceptance Criteria**:
- Function returns correct variants for multi-package articles
- Returns single item for single-package articles
- Returns empty array for non-existent articles
- All unit tests pass

---

### Task 3: Implement `selectPackageVariant()` - AUTO

**File**: `archibald-web-app/backend/src/product-db.ts`

```typescript
/**
 * Select correct package variant based on quantity ordered.
 *
 * Logic:
 * - If quantity >= highest multipleQty → select highest package
 * - Else → select lowest package
 * - Single package → select that package
 *
 * @param articleName - Article name (e.g., "H129FSQ.104.023")
 * @param quantity - Quantity to order
 * @returns Selected product variant, or null if article not found
 */
selectPackageVariant(articleName: string, quantity: number): Product | null {
  const variants = this.getProductVariants(articleName);

  if (variants.length === 0) {
    return null;
  }

  if (variants.length === 1) {
    return variants[0];
  }

  // Multiple variants: apply selection logic
  // variants already sorted by multipleQty DESC (highest first)
  const highestMultiple = variants[0].multipleQty || 1;

  if (quantity >= highestMultiple) {
    return variants[0]; // Highest package
  } else {
    return variants[variants.length - 1]; // Lowest package
  }
}
```

**Implementation Notes**:
- Leverages `getProductVariants()` for sorted variants
- Handles null/undefined multipleQty with default value 1
- Simple if/else logic per user specification

**Acceptance Criteria**:
- Function returns correct variant based on quantity
- Edge cases handled (0 variants, 1 variant, multiple variants)
- All unit tests pass
- Logic matches user specification exactly

---

### Task 4: Add Type Safety & Validation - AUTO

**File**: `archibald-web-app/backend/src/product-db.ts`

Add input validation:

```typescript
selectPackageVariant(articleName: string, quantity: number): Product | null {
  // Validation
  if (!articleName || articleName.trim() === '') {
    throw new Error('Article name is required');
  }

  if (quantity <= 0 || !Number.isFinite(quantity)) {
    throw new Error('Quantity must be a positive number');
  }

  // ... rest of implementation
}
```

Add tests for validation:

```typescript
describe('selectPackageVariant validation', () => {
  test('throws error for empty article name', () => {
    expect(() => selectPackageVariant('', 5)).toThrow('Article name is required');
  });

  test('throws error for negative quantity', () => {
    expect(() => selectPackageVariant('H129FSQ.104.023', -5)).toThrow('Quantity must be positive');
  });

  test('throws error for zero quantity', () => {
    expect(() => selectPackageVariant('H129FSQ.104.023', 0)).toThrow('Quantity must be positive');
  });
});
```

**Acceptance Criteria**:
- Invalid inputs throw descriptive errors
- Validation tests pass
- Type safety enforced

---

### Task 5: Run Tests & Fix Issues - AUTO

Run test suite:

```bash
npm test -- product-db.test.ts
```

**Acceptance Criteria**:
- All tests pass (green)
- No TypeScript errors
- No linting errors
- Test coverage adequate

---

## Files Changed

- `archibald-web-app/backend/src/product-db.ts` - Add 2 new functions
- `archibald-web-app/backend/src/product-db.test.ts` - Add test cases

---

## Dependencies

**Requires**:
- 03-01 DISCOVERY.md (package selection logic defined)
- Existing `Product` interface (already has packageContent, multipleQty fields)
- Existing product database with test data

**Blocks**:
- 03-03 (needs these functions to select variants)

---

## Acceptance Criteria (Overall)

- ✅ `getProductVariants()` implemented and tested
- ✅ `selectPackageVariant()` implemented and tested
- ✅ All unit tests pass
- ✅ Input validation added
- ✅ Edge cases handled
- ✅ No breaking changes to existing code
- ✅ Code follows CLAUDE.md best practices

---

## Notes

- This is a **pure logic layer** - no UI or bot changes yet
- Functions are deterministic and easily testable
- No database schema changes needed (fields already exist)
- Can be tested independently without Archibald connection
