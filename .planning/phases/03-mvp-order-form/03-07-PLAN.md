# Phase 3 Plan 07: Integration Tests for Package Selection

**Type**: tdd
**Dependencies**: 03-02, 03-03, 03-04 (all backend implementation complete)
**Estimated Complexity**: Medium
**Files Modified**: 1-2

---

## Objective

Create comprehensive integration tests for package selection scenarios, verifying end-to-end functionality with real Archibald connection.

**Success Criteria**:
- ✅ Integration tests cover single-package and multi-package articles
- ✅ Tests verify correct variant selection at different quantity thresholds
- ✅ Tests verify validation errors for invalid quantities
- ✅ Tests verify successful order creation with correct package
- ✅ Tests can run against live Archibald (or mocked)

---

## Tasks

### Task 1: Create Test Fixtures - AUTO

**File**: `archibald-web-app/backend/src/test-fixtures/orders.ts` (create if doesn't exist)

```typescript
export const singlePackageOrderFixture = {
  customerName: 'Fresis Soc Cooperativa',
  items: [
    {
      articleCode: 'TD1272.314',
      quantity: 5,
      price: 0, // Bot will fetch
    },
  ],
};

export const multiPackageHighQuantityFixture = {
  customerName: 'Fresis Soc Cooperativa',
  items: [
    {
      articleCode: 'H129FSQ.104.023',
      quantity: 10, // Should select 5-piece package
      price: 0,
    },
  ],
};

export const multiPackageLowQuantityFixture = {
  customerName: 'Fresis Soc Cooperativa',
  items: [
    {
      articleCode: 'H129FSQ.104.023',
      quantity: 3, // Should select 1-piece package
      price: 0,
    },
  ],
};

export const multiPackageThresholdFixture = {
  customerName: 'Fresis Soc Cooperativa',
  items: [
    {
      articleCode: 'H129FSQ.104.023',
      quantity: 5, // Exactly at threshold, should select 5-piece
      price: 0,
    },
  ],
};

export const invalidQuantityBelowMinFixture = {
  customerName: 'Fresis Soc Cooperativa',
  items: [
    {
      articleCode: 'H129FSQ.104.023',
      quantity: 2, // Below minQty of selected variant
      price: 0,
    },
  ],
};

export const invalidQuantityNotMultipleFixture = {
  customerName: 'Fresis Soc Cooperativa',
  items: [
    {
      articleCode: 'H129FSQ.104.023',
      quantity: 7, // Not multiple of multipleQty
      price: 0,
    },
  ],
};
```

---

### Task 2: Write Integration Tests - AUTO

**File**: `archibald-web-app/backend/src/archibald-bot.integration.test.ts` (new)

```typescript
import { describe, test, expect, beforeAll, afterAll } from 'vitest';
import { ArchibaldBot } from './archibald-bot';
import { ProductDb } from './product-db';
import * as fixtures from './test-fixtures/orders';

describe('Package Selection Integration Tests', () => {
  let bot: ArchibaldBot;
  let productDb: ProductDb;

  beforeAll(async () => {
    // Initialize bot and DB
    productDb = new ProductDb('./data/products.db');
    bot = new ArchibaldBot(productDb);

    await bot.init();
  });

  afterAll(async () => {
    await bot.close();
  });

  test('creates order with single-package article', async () => {
    // Given: Order with TD1272.314 (1 variant)
    const orderData = fixtures.singlePackageOrderFixture;

    // When: Create order
    const orderId = await bot.createOrder(orderData);

    // Then: Order created successfully
    expect(orderId).toBeTruthy();
    expect(orderId).toMatch(/^\d+$/); // Numeric order ID
  });

  test('selects highest package when quantity >= max multiple', async () => {
    // Given: Order with H129FSQ.104.023, quantity 10
    const orderData = fixtures.multiPackageHighQuantityFixture;

    // When: Create order
    const orderId = await bot.createOrder(orderData);

    // Then: Order created with 5-piece package
    expect(orderId).toBeTruthy();

    // Verify in Archibald (manual check or API query)
    // Expected: Variant ID 016869K2 (5-piece) was selected
  });

  test('selects lowest package when quantity < max multiple', async () => {
    // Given: Order with H129FSQ.104.023, quantity 3
    const orderData = fixtures.multiPackageLowQuantityFixture;

    // When: Create order
    const orderId = await bot.createOrder(orderData);

    // Then: Order created with 1-piece package
    expect(orderId).toBeTruthy();

    // Verify in Archibald (manual check or API query)
    // Expected: Variant ID 016869K3 (1-piece) was selected
  });

  test('selects highest package when quantity equals threshold', async () => {
    // Given: Order with H129FSQ.104.023, quantity 5 (exactly at threshold)
    const orderData = fixtures.multiPackageThresholdFixture;

    // When: Create order
    const orderId = await bot.createOrder(orderData);

    // Then: Order created with 5-piece package (>= rule)
    expect(orderId).toBeTruthy();
  });

  test('throws error for quantity below minQty', async () => {
    // Given: Order with quantity 2 (below minQty)
    const orderData = fixtures.invalidQuantityBelowMinFixture;

    // When/Then: CreateOrder throws validation error
    await expect(bot.createOrder(orderData)).rejects.toThrow(
      /Quantity must be at least/
    );
  });

  test('throws error for quantity not multiple of multipleQty', async () => {
    // Given: Order with quantity 7 (not multiple of 5)
    const orderData = fixtures.invalidQuantityNotMultipleFixture;

    // When/Then: CreateOrder throws validation error
    await expect(bot.createOrder(orderData)).rejects.toThrow(
      /Quantity must be a multiple of/
    );
  });

  test('provides suggestions in error message', async () => {
    // Given: Order with invalid quantity
    const orderData = fixtures.invalidQuantityNotMultipleFixture;

    // When/Then: Error includes suggestions
    await expect(bot.createOrder(orderData)).rejects.toThrow(
      /Suggested quantities: 5, 10/
    );
  });

  test('handles multi-item order with different package types', async () => {
    // Given: Order with multiple items, different package scenarios
    const orderData = {
      customerName: 'Fresis Soc Cooperativa',
      items: [
        {
          articleCode: 'TD1272.314',
          quantity: 5, // Single package
          price: 0,
        },
        {
          articleCode: 'H129FSQ.104.023',
          quantity: 10, // Multi-package, high qty
          price: 0,
        },
        {
          articleCode: 'H129FSQ.104.023',
          quantity: 3, // Multi-package, low qty
          price: 0,
        },
      ],
    };

    // When: Create order
    const orderId = await bot.createOrder(orderData);

    // Then: Order created with correct packages for each item
    expect(orderId).toBeTruthy();
  });

  test('throws error when article not found in database', async () => {
    // Given: Order with non-existent article
    const orderData = {
      customerName: 'Fresis Soc Cooperativa',
      items: [
        {
          articleCode: 'NONEXISTENT999',
          quantity: 5,
          price: 0,
        },
      ],
    };

    // When/Then: CreateOrder throws error
    await expect(bot.createOrder(orderData)).rejects.toThrow(
      /Article NONEXISTENT999 not found in database/
    );
  });
});
```

---

### Task 3: Add Test Configuration - AUTO

**File**: `vitest.config.ts` (update if needed)

```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    // Integration tests can be slow - increase timeout
    testTimeout: 30000, // 30 seconds per test
    hookTimeout: 10000, // 10 seconds for beforeAll/afterAll

    // Run integration tests separately
    include: ['**/*.integration.test.ts'],

    // Environment variables for Archibald connection
    env: {
      ARCHIBALD_URL: process.env.ARCHIBALD_URL || '',
      ARCHIBALD_USERNAME: process.env.ARCHIBALD_USERNAME || '',
      ARCHIBALD_PASSWORD: process.env.ARCHIBALD_PASSWORD || '',
    },
  },
});
```

---

### Task 4: Run Integration Tests - CHECKPOINT:human-verify

```bash
# Run integration tests
npm test -- archibald-bot.integration.test.ts

# Or run all tests
npm test
```

**Manual verification needed**:

After tests run, check Archibald manually:
1. Log into Archibald
2. Navigate to Orders (Ordini)
3. Find test orders (customer = "Fresis Soc Cooperativa")
4. **Verify**: Correct package variants selected
5. **Verify**: Quantities match expected values
6. **Verify**: No orders with quantity = 0

**Expected results**:
- Order with TD1272.314: Shows 1-piece package
- Order with H129FSQ.104.023 qty 10: Shows 5-piece package
- Order with H129FSQ.104.023 qty 3: Shows 1-piece package
- Order with H129FSQ.104.023 qty 5: Shows 5-piece package (threshold case)

---

### Task 5: Document Test Coverage - AUTO

**File**: `archibald-web-app/backend/TEST-COVERAGE.md` (create or update)

```markdown
# Test Coverage: Package Selection

## Unit Tests (03-02)
- ✅ `getProductVariants()` - returns correct variants
- ✅ `selectPackageVariant()` - applies correct selection logic
- ✅ Input validation - handles edge cases

## Unit Tests (03-04)
- ✅ `validateQuantity()` - checks min/multiple/max rules
- ✅ Validation errors - descriptive messages
- ✅ Validation suggestions - correct values

## Integration Tests (03-07)
- ✅ Single-package article order creation
- ✅ Multi-package high quantity (selects highest package)
- ✅ Multi-package low quantity (selects lowest package)
- ✅ Threshold quantity (quantity = max multiple)
- ✅ Validation error: below minQty
- ✅ Validation error: not multiple of multipleQty
- ✅ Multi-item order with mixed packages
- ✅ Error: article not found

## Manual Testing Required
- [ ] Verify correct package in Archibald UI after order creation
- [ ] Verify quantity does not become 0
- [ ] Verify price calculation correct for each package
- [ ] Verify discount applies correctly

## Coverage Statistics
- Unit test coverage: ~90% (estimated)
- Integration test coverage: 8 scenarios
- Edge cases covered: 6 (threshold, min, max, missing, invalid, multi-item)
```

---

## Files Changed

- `archibald-web-app/backend/src/archibald-bot.integration.test.ts` - New integration tests (create)
- `archibald-web-app/backend/src/test-fixtures/orders.ts` - Test data fixtures (create)
- `archibald-web-app/backend/TEST-COVERAGE.md` - Documentation (create/update)
- `vitest.config.ts` - Test configuration (update if needed)

---

## Dependencies

**Requires**:
- 03-02 (DB functions implemented)
- 03-03 (Bot package selection implemented)
- 03-04 (Validation implemented)
- Archibald connection credentials
- Test customer "Fresis" exists

**Blocks**:
- None (this completes Phase 3)

---

## Acceptance Criteria

- ✅ All integration tests written
- ✅ Tests run successfully (green)
- ✅ Manual verification confirms correct behavior
- ✅ Test coverage documented
- ✅ No flaky tests (tests are deterministic)
- ✅ Tests can be run in CI/CD pipeline

---

## Notes

- Integration tests require live Archibald connection
- Tests may leave test orders in Archibald (cleanup manually if needed)
- Consider adding cleanup logic in afterAll() to delete test orders
- Tests validate E2E flow from user input to Archibald order creation
- Consider adding screenshot capture on test failure for debugging
