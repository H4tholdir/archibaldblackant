# Phase 3 Plan 03: Package Selection in Archibald Bot

**Type**: tdd
**Dependencies**: 03-02 (DB functions implemented)
**Estimated Complexity**: High
**Files Modified**: 3-4

---

## Objective

Update `archibald-bot.ts` to select correct package variant when creating orders, searching by specific variant ID instead of article name.

**Success Criteria**:
- ✅ Bot queries database for correct variant before searching Archibald
- ✅ Bot searches Archibald popup by variant ID (not article name)
- ✅ Bot selects correct row based on ID match
- ✅ Integration tests verify correct package selection
- ✅ Simple case (1 variant) and complex case (2+ variants) both work

---

## Tasks

### Task 1: Write Integration Tests (TDD) - AUTO

**File**: `archibald-web-app/backend/src/archibald-bot.test.ts` (create if doesn't exist)

```typescript
describe('createOrder with package selection', () => {
  test('selects single package variant correctly', async () => {
    // Given: Order with TD1272.314 (1 variant), quantity 5
    const orderData = {
      customerName: 'Fresis Soc Cooperativa',
      items: [
        {
          articleCode: 'TD1272.314',
          quantity: 5,
          price: 0, // Bot will fetch price
        },
      ],
    };

    // When: createOrder()
    const orderId = await bot.createOrder(orderData);

    // Then: Order created successfully with correct variant
    expect(orderId).toBeTruthy();
  });

  test('selects highest package when quantity >= max multiple', async () => {
    // Given: Order with H129FSQ.104.023, quantity 10 (>= 5)
    const orderData = {
      customerName: 'Fresis Soc Cooperativa',
      items: [
        {
          articleCode: 'H129FSQ.104.023',
          quantity: 10,
          price: 0,
        },
      ],
    };

    // When: createOrder()
    const orderId = await bot.createOrder(orderData);

    // Then: Bot should have searched for variant ID 016869K2 (5-piece)
    // Manual verification: check Archibald order shows 5-piece package
    expect(orderId).toBeTruthy();
  });

  test('selects lowest package when quantity < max multiple', async () => {
    // Given: Order with H129FSQ.104.023, quantity 3 (< 5)
    const orderData = {
      customerName: 'Fresis Soc Cooperativa',
      items: [
        {
          articleCode: 'H129FSQ.104.023',
          quantity: 3,
          price: 0,
        },
      ],
    };

    // When: createOrder()
    const orderId = await bot.createOrder(orderData);

    // Then: Bot should have searched for variant ID 016869K3 (1-piece)
    expect(orderId).toBeTruthy();
  });

  test('throws error when article not found in database', async () => {
    // Given: Order with non-existent article
    const orderData = {
      customerName: 'Fresis Soc Cooperativa',
      items: [
        {
          articleCode: 'NONEXISTENT123',
          quantity: 5,
          price: 0,
        },
      ],
    };

    // When/Then: createOrder() throws error
    await expect(bot.createOrder(orderData)).rejects.toThrow(
      'Article NONEXISTENT123 not found in database'
    );
  });
});
```

**Note**: These are **integration tests** that require:
- Archibald connection
- Product database synced
- Test customer "Fresis" exists

---

### Task 2: Refactor Article Selection Logic - AUTO

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

**Current location**: Lines ~1614-1741 (article selection in createOrder loop)

**Changes needed**:

1. **BEFORE opening article dropdown**:

```typescript
// OLD CODE (removed):
// const searchQuery = item.productName || item.articleCode;

// NEW CODE:
// Query database for correct variant
const selectedVariant = this.productDb.selectPackageVariant(
  item.articleCode,
  item.quantity
);

if (!selectedVariant) {
  throw new Error(
    `Article ${item.articleCode} not found in database. ` +
    `Ensure product sync has run and article exists in Archibald.`
  );
}

logger.info(
  `Selected package variant for ${item.articleCode}:`,
  {
    variantId: selectedVariant.id,
    packageContent: selectedVariant.packageContent,
    multipleQty: selectedVariant.multipleQty,
    quantity: item.quantity,
  }
);

// Search by VARIANT ID instead of article name
const searchQuery = selectedVariant.id; // e.g., "016869K2"
```

2. **Update row selection logic**:

```typescript
// Find row matching variant ID (not just article name)
let selectedRow = null;
let matchedText = "";

for (const row of rows) {
  const text = await row.evaluate((el) =>
    (el.textContent ?? "").toString()
  );

  // NEW: Match by variant ID (more precise)
  if (text.includes(selectedVariant.id)) {
    selectedRow = row;
    matchedText = text.substring(0, 50);
    break;
  }
}

if (!selectedRow) {
  throw new Error(
    `Variant ID ${selectedVariant.id} not found in Archibald popup. ` +
    `Expected article: ${item.articleCode}, package: ${selectedVariant.packageContent}`
  );
}

logger.debug(
  `Selected row for variant ${selectedVariant.id} (match: ${matchedText})`
);
```

**Key Changes**:
- Search by **variant ID** (unique) instead of article name (ambiguous)
- Add detailed logging for debugging
- Better error messages with context

---

### Task 3: Update OrderItem Interface - AUTO

**File**: `archibald-web-app/backend/src/types/order.ts` (or wherever OrderItem is defined)

```typescript
export interface OrderItem {
  articleCode: string; // USER INPUT: Article name (e.g., "H129FSQ.104.023")
  articleId?: string; // NEW: Selected variant ID (e.g., "016869K2") - populated by bot
  productName?: string;
  description: string;
  quantity: number;
  price: number;
  discount?: number;
  packageContent?: number; // NEW: Selected package content (e.g., 5) - populated by bot
}
```

**Usage in bot**:

```typescript
// After successful article selection, populate metadata:
item.articleId = selectedVariant.id;
item.packageContent = selectedVariant.packageContent
  ? parseInt(selectedVariant.packageContent)
  : undefined;
```

---

### Task 4: Add Logging & Error Handling - AUTO

**File**: `archibald-web-app/backend/src/archibald-bot.ts`

Enhanced logging:

```typescript
logger.info(`Processing item ${i + 1}/${orderData.items.length}`, {
  articleCode: item.articleCode,
  quantity: item.quantity,
});

// After variant selection:
logger.info(`Package variant selected`, {
  articleCode: item.articleCode,
  variantId: selectedVariant.id,
  packageContent: selectedVariant.packageContent,
  multipleQty: selectedVariant.multipleQty,
  minQty: selectedVariant.minQty,
  maxQty: selectedVariant.maxQty,
});

// After successful row click:
logger.info(`Article variant selected in Archibald`, {
  variantId: selectedVariant.id,
  matchedText: matchedText.substring(0, 100),
});
```

Error handling:

```typescript
try {
  // Article selection logic
} catch (error) {
  logger.error(`Failed to select article ${item.articleCode}`, {
    variantId: selectedVariant?.id,
    quantity: item.quantity,
    error: error.message,
  });

  await this.page.screenshot({
    path: `logs/error-article-selection-${i}.png`,
    fullPage: true,
  });

  throw error;
}
```

---

### Task 5: Test with Real Archibald - CHECKPOINT:human-verify

**Manual testing required**:

1. **Test Case 1: Single package article**
   - Article: TD1272.314
   - Quantity: 5
   - Expected: Bot searches "TD1272.314" variant ID, selects only row
   - **Verify**: Order created successfully

2. **Test Case 2: Multi-package, high quantity**
   - Article: H129FSQ.104.023
   - Quantity: 10
   - Expected: Bot searches variant ID "016869K2" (5-piece), selects correct row
   - **Verify**: Order shows 5-piece package, quantity 10

3. **Test Case 3: Multi-package, low quantity**
   - Article: H129FSQ.104.023
   - Quantity: 3
   - Expected: Bot searches variant ID "016869K3" (1-piece), selects correct row
   - **Verify**: Order shows 1-piece package, quantity 3

4. **Test Case 4: Edge case - quantity = threshold**
   - Article: H129FSQ.104.023
   - Quantity: 5 (exactly at threshold)
   - Expected: Bot selects 5-piece package (>= rule)
   - **Verify**: Order shows 5-piece package

**User verification needed**:
- Check Archibald orders manually to confirm correct package selected
- Verify quantity doesn't become 0 (validation issue indicator)
- Check screenshots in `logs/` directory if errors occur

---

### Task 6: Fix Issues & Iterate - AUTO

Based on test results:
- Fix any selector issues
- Adjust error messages
- Handle edge cases discovered during testing

---

## Files Changed

- `archibald-web-app/backend/src/archibald-bot.ts` - Update article selection logic (~50 lines changed)
- `archibald-web-app/backend/src/types/order.ts` - Extend OrderItem interface (+2 fields)
- `archibald-web-app/backend/src/archibald-bot.test.ts` - Add integration tests (new file or extended)

---

## Dependencies

**Requires**:
- 03-02 completed (`selectPackageVariant()` available)
- Product database synced with Archibald
- Test customer "Fresis" exists in Archibald

**Blocks**:
- 03-05 (frontend needs articleId/packageContent fields)

---

## Acceptance Criteria

- ✅ Bot selects correct package variant based on quantity
- ✅ Searches Archibald by variant ID (not article name)
- ✅ Single-variant articles work correctly
- ✅ Multi-variant articles work correctly
- ✅ Edge case (quantity = threshold) handled
- ✅ Error messages are descriptive
- ✅ Logging provides debugging information
- ✅ Integration tests pass (or manual verification successful)
- ✅ No breaking changes to existing order creation

---

## Risks & Mitigations

**Risk**: Variant ID search doesn't match rows in popup
**Mitigation**: Fallback to article name search + cell parsing if needed

**Risk**: Multiple rows match variant ID
**Mitigation**: Log warning and select first match

**Risk**: Product database not synced
**Mitigation**: Clear error message prompting sync

---

## Notes

- This is **the core implementation** for package selection
- Requires careful testing with real Archibald connection
- Fallback strategy can be added if ID search fails
- Consider adding retry logic for robustness
