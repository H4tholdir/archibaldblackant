# Implementation Roadmap - OrderForm Rewrite

**Roadmap Date:** 2026-01-23
**Phase:** 28.2 (Rewrite OrderForm with Proper Architecture)
**Plan:** 01 (Codebase Analysis & Architecture Design)

---

## Executive Summary

This document provides the **step-by-step implementation roadmap** for Plans 02-06 of Phase 28.2. Each plan is broken down into concrete, executable tasks with:

- **Clear scope** (what's in, what's out)
- **Dependencies** (what must be done first)
- **Success criteria** (how to know it's done)
- **Atomic commits** (one commit per task)
- **Testing requirements** (what to test)

**Total Estimated Duration:** 4-5 weeks (Plans 02-06)

---

## Plan Breakdown Overview

```
Plan 02: Data Layer & Services (fix IndexedDB)           [Week 1]
    â†“
Plan 03: Customer & Product Selection                    [Week 2]
    â†“
Plan 04: Multi-Article & Discounts                       [Week 2-3]
    â†“
Plan 05: Pending Queue & Offline                         [Week 3-4]
    â†“
Plan 06: Integration & Testing                           [Week 4-5]
```

---

## Plan 02: Data Layer & Services

**Duration:** 5-7 days
**Priority:** ðŸ”´ CRITICAL (Blocks all other plans)
**Goal:** Fix IndexedDB empty issue + establish solid data layer

### Scope

**In Scope:**
- SyncService implementation
- IndexedDB population from API
- DraftManager consolidation
- Cache freshness tracking
- Background sync on app startup

**Out of Scope:**
- Delta sync (future optimization)
- Service Worker (future optimization)
- Voice input (Phase 28.3)

### Tasks

#### Task 2.1: Create SyncService
**File:** `frontend/src/services/sync-service.ts`

**Implementation:**
```typescript
export class SyncService {
  async syncProducts(): Promise<SyncResult> {
    // 1. Fetch products from API
    // 2. Clear old IndexedDB data
    // 3. Bulk insert products
    // 4. Extract and insert variants
    // 5. Extract and insert prices
    // 6. Update cacheMetadata
  }

  async syncCustomers(): Promise<SyncResult> {
    // Similar to syncProducts
  }

  async needsSync(type: 'products' | 'customers'): Promise<boolean> {
    // Check if cache age > 72 hours
  }
}
```

**Success Criteria:**
- [ ] IndexedDB populated with 5000+ products
- [ ] cacheMetadata table updated with lastSynced timestamp
- [ ] Unit tests pass (mock API responses)

**Commit Message:**
```
feat(28.2-02): add SyncService for IndexedDB population

- Create SyncService class with syncProducts/syncCustomers methods
- Implement cache freshness checking (> 72 hours = stale)
- Add IndexedDB bulk insert operations
- Extract and save variants/prices from API response
- Update cacheMetadata table with sync timestamp
```

---

#### Task 2.2: Integrate SyncService in App Startup
**File:** `frontend/src/App.tsx`

**Implementation:**
```typescript
useEffect(() => {
  async function initializeCache() {
    const syncService = new SyncService(db, api);

    // Check if sync needed
    if (await syncService.needsSync('products')) {
      console.log('[App] Syncing products...');
      await syncService.syncProducts();
    }

    if (await syncService.needsSync('customers')) {
      console.log('[App] Syncing customers...');
      await syncService.syncCustomers();
    }

    console.log('[App] Cache initialized');
  }

  initializeCache();
}, []);
```

**Success Criteria:**
- [ ] Sync runs on app startup
- [ ] Console logs show sync completion
- [ ] DevTools IndexedDB shows populated products table
- [ ] No errors in console

**Commit Message:**
```
feat(28.2-02): integrate SyncService on app startup

- Add useEffect in App.tsx to trigger sync on mount
- Check cache freshness before syncing
- Log sync progress to console
- Ensure non-blocking (app loads while syncing in background)
```

---

#### Task 2.3: Create DraftManager (Unified)
**File:** `frontend/src/services/draft-manager.ts`

**Implementation:**
```typescript
export class DraftManager {
  async saveDraft(draft: DraftOrderData): Promise<DraftOrder>
  async loadDraft(id: string): Promise<DraftOrder | null>
  async listDrafts(): Promise<DraftOrder[]>
  async deleteDraft(id: string): Promise<boolean>
  async migrate(): Promise<void> // IndexedDB â†’ localStorage
  async cleanup(): Promise<number> // Remove drafts > 30 days
}
```

**Success Criteria:**
- [ ] Can save/load/list/delete drafts
- [ ] Migration from IndexedDB to localStorage works
- [ ] Cleanup removes expired drafts (> 30 days)
- [ ] Unit tests pass

**Commit Message:**
```
feat(28.2-02): create unified DraftManager service

- Consolidate DraftService (IndexedDB) + DraftOrderStorage (localStorage)
- Support both storage backends (configurable)
- Add migration method to move IndexedDB drafts to localStorage
- Add cleanup method to remove expired drafts (> 30 days)
- Add comprehensive unit tests
```

---

#### Task 2.4: Extract PricingService
**File:** `frontend/src/services/pricing-service.ts`

**Implementation:**
```typescript
export class PricingService {
  constructor(config: PricingConfig)

  calculate(items: OrderItem[], targetTotal?: string): PricingResult
  validateDiscount(percent: number): boolean
  formatPrice(amount: number): string
}
```

**Success Criteria:**
- [ ] 99-line calculatePricing logic extracted from OrderForm
- [ ] Unit tests cover all calculation branches
- [ ] Edge cases tested (negative discount, > 100% discount, etc.)

**Commit Message:**
```
refactor(28.2-02): extract pricing logic to PricingService

- Move 99-line calculatePricing from OrderForm.tsx to PricingService
- Add configurable VAT rate, shipping cost, shipping threshold
- Implement reverse discount calculation (target total â†’ discount %)
- Add validation for discount percentage (0-100%)
- Add comprehensive unit tests with edge cases
```

---

#### Task 2.5: Create ValidationService
**File:** `frontend/src/services/validation-service.ts`

**Implementation:**
```typescript
export class ValidationService {
  validateOrderItem(item: OrderItem): ValidationResult
  validatePackageConstraints(qty: number, constraints: PackageConstraints): ValidationResult
}
```

**Success Criteria:**
- [ ] Package constraints validated (min, max, multiple)
- [ ] Order item validation (required fields)
- [ ] Unit tests pass

**Commit Message:**
```
feat(28.2-02): add ValidationService for order constraints

- Create ValidationService class
- Implement package constraints validation (min, max, multiple qty)
- Implement order item validation (required fields)
- Add helpful error messages and suggestions
- Add unit tests
```

---

### Plan 02 Success Criteria

- [ ] IndexedDB populated with products (> 5000 records)
- [ ] IndexedDB populated with customers (> 1500 records)
- [ ] SyncService working and tested
- [ ] DraftManager consolidated
- [ ] PricingService extracted and tested
- [ ] ValidationService created and tested
- [ ] All services have > 80% test coverage

### Plan 02 Commits

Expected: 5 commits (one per task)

---

## Plan 03: Customer & Product Selection

**Duration:** 5-7 days
**Dependencies:** Plan 02 complete
**Goal:** Build autocomplete components and selection logic

### Scope

**In Scope:**
- useCustomerSelection hook
- useProductSelection hook
- AutocompleteDropdown<T> generic component
- CustomerSection component
- ProductSection component

**Out of Scope:**
- Voice input integration
- Barcode scanner

### Tasks

#### Task 3.1: Create AutocompleteDropdown<T> Component
**File:** `frontend/src/components/common/AutocompleteDropdown.tsx`

**Implementation:**
```typescript
interface AutocompleteDropdownProps<T> {
  items: T[];
  value: string;
  onChange: (value: string) => void;
  onSelect: (item: T) => void;
  renderItem: (item: T) => ReactNode;
  getItemKey: (item: T) => string;
  loading?: boolean;
  placeholder?: string;
}

export function AutocompleteDropdown<T>(props: AutocompleteDropdownProps<T>)
```

**Features:**
- Click outside to close
- Keyboard navigation (Arrow keys, Enter, Escape)
- Loading state
- No results message
- Limit to 10 visible items

**Success Criteria:**
- [ ] Generic component works with any type T
- [ ] Click outside closes dropdown
- [ ] Keyboard navigation works
- [ ] Renders items correctly

**Commit Message:**
```
feat(28.2-03): create generic AutocompleteDropdown component

- Create reusable autocomplete component with TypeScript generics
- Implement click-outside-to-close behavior
- Add keyboard navigation (Arrow keys, Enter, Esc)
- Add loading state and no-results message
- Limit visible items to 10 for performance
```

---

#### Task 3.2: Create useCustomerSelection Hook
**File:** `frontend/src/hooks/useCustomerSelection.ts`

**Implementation:**
```typescript
export function useCustomerSelection(options?: UseCustomerSelectionOptions) {
  // Load customers from cache on mount
  // Trigger smart sync
  // Filter customers based on search query
  // Handle customer selection
}
```

**Success Criteria:**
- [ ] Loads customers from IndexedDB (now populated!)
- [ ] Triggers smart customer sync on mount
- [ ] Filters customers based on search
- [ ] Resumes normal syncs on unmount

**Commit Message:**
```
feat(28.2-03): create useCustomerSelection hook

- Load customers from IndexedDB cache (5000+ records)
- Trigger smart customer sync on mount (3-5s fast sync)
- Resume normal syncs on unmount
- Filter customers by name/code as user types
- Return clean API for components
```

---

#### Task 3.3: Create useProductSelection Hook
**File:** `frontend/src/hooks/useProductSelection.ts`

**Implementation:**
```typescript
export function useProductSelection(options?: UseProductSelectionOptions) {
  // Load products from cache on mount
  // Filter products based on search query
  // Parse package constraints when product selected
  // Handle product selection
}
```

**Success Criteria:**
- [ ] Loads products from IndexedDB
- [ ] Filters by name/article/description
- [ ] Parses package constraints from selected product
- [ ] Returns clean API for components

**Commit Message:**
```
feat(28.2-03): create useProductSelection hook

- Load products from IndexedDB cache (5000+ records)
- Filter products by name/article/description
- Parse package constraints (min/max/multiple qty)
- Extract pricing from cached product data
- Return clean API for components
```

---

#### Task 3.4: Create CustomerSection Component
**File:** `frontend/src/components/OrderFormNew/CustomerSection.tsx`

**Implementation:**
```tsx
export function CustomerSection() {
  const {
    filteredCustomers,
    searchQuery,
    loading,
    setSearchQuery,
    selectCustomer,
  } = useCustomerSelection({
    onSelect: (customer) => {
      const { setCustomer } = useOrderForm();
      setCustomer(customer.id, customer.name);
    }
  });

  return (
    <div className="card">
      <h2>ðŸ‘¤ Cliente</h2>
      <AutocompleteDropdown
        items={filteredCustomers}
        value={searchQuery}
        onChange={setSearchQuery}
        onSelect={selectCustomer}
        renderItem={(c) => (
          <>
            <div className="name">{c.name}</div>
            <div className="id">ID: {c.id}</div>
          </>
        )}
        getItemKey={(c) => c.id}
        loading={loading}
        placeholder="Cerca cliente..."
      />
    </div>
  );
}
```

**Success Criteria:**
- [ ] Renders customer autocomplete
- [ ] Shows filtered customers
- [ ] Updates context on selection
- [ ] Shows selected customer badge

**Commit Message:**
```
feat(28.2-03): create CustomerSection component

- Build CustomerSection using AutocompleteDropdown
- Integrate useCustomerSelection hook
- Update OrderFormContext on selection
- Show selected customer badge
- Keep component < 100 lines
```

---

#### Task 3.5: Create ProductSection Component
**File:** `frontend/src/components/OrderFormNew/ProductSection.tsx`

**Implementation:**
```tsx
export function ProductSection() {
  const {
    filteredProducts,
    searchQuery,
    loading,
    selectedProduct,
    packageConstraints,
    setSearchQuery,
    selectProduct,
  } = useProductSelection();

  const [quantity, setQuantity] = useState(1);
  const [price, setPrice] = useState(0);
  const [discount, setDiscount] = useState(0);

  const handleAddItem = () => {
    const { addItem } = useOrderForm();
    addItem({
      articleCode: selectedProduct.name,
      productName: selectedProduct.name,
      description: selectedProduct.description || "",
      quantity,
      price,
      discount,
    });
    // Reset form
  };

  return (
    <div className="card">
      <h2>ðŸ“¦ Nuovo Articolo</h2>
      <AutocompleteDropdown ... />
      {selectedProduct && <ProductDetails ... />}
      <QuantityInput ... />
      <PriceInput ... />
      <DiscountInput ... />
      <button onClick={handleAddItem}>âž• Aggiungi</button>
    </div>
  );
}
```

**Success Criteria:**
- [ ] Renders product autocomplete
- [ ] Shows package constraints
- [ ] Validates quantity before adding
- [ ] Adds item to context
- [ ] Resets form after adding

**Commit Message:**
```
feat(28.2-03): create ProductSection component

- Build ProductSection using AutocompleteDropdown
- Integrate useProductSelection hook
- Show product details and package constraints
- Add quantity/price/discount inputs
- Validate and add item to order
- Keep component < 150 lines
```

---

### Plan 03 Success Criteria

- [ ] AutocompleteDropdown<T> generic component working
- [ ] useCustomerSelection hook tested
- [ ] useProductSelection hook tested
- [ ] CustomerSection renders and functions correctly
- [ ] ProductSection renders and functions correctly
- [ ] Integration test: Select customer + product + add item

### Plan 03 Commits

Expected: 5 commits (one per task)

---

## Plan 04: Multi-Article & Discounts

**Duration:** 5-7 days
**Dependencies:** Plan 03 complete
**Goal:** Build order items list, pricing summary, discount features

### Scope

**In Scope:**
- useOrderItems hook
- usePricingCalculation hook
- OrderItemsList component
- OrderItemCard component
- PricingSummary component
- Global discount
- Reverse discount calculation

**Out of Scope:**
- Voice input
- Barcode scanner

### Tasks

#### Task 4.1: Create useOrderItems Hook
**File:** `frontend/src/hooks/useOrderItems.ts`

**Implementation:**
```typescript
export function useOrderItems(validationService: ValidationService) {
  const [items, setItems] = useState<OrderItem[]>([]);

  const addItem = (item: OrderItem) => {
    const validation = validationService.validateOrderItem(item);
    if (!validation.valid) throw new Error(validation.error);
    setItems(prev => [...prev, item]);
  };

  const editItem = (index: number, item: OrderItem) => { ... };
  const removeItem = (index: number) => { ... };
  const clearItems = () => { ... };

  return { items, addItem, editItem, removeItem, clearItems };
}
```

**Success Criteria:**
- [ ] Can add items
- [ ] Can edit items
- [ ] Can remove items
- [ ] Validates items before adding
- [ ] Unit tests pass

**Commit Message:**
```
feat(28.2-04): create useOrderItems hook

- Implement add/edit/remove/clear operations
- Integrate ValidationService for item validation
- Add error handling for invalid items
- Add unit tests
```

---

#### Task 4.2: Create usePricingCalculation Hook
**File:** `frontend/src/hooks/usePricingCalculation.ts`

**Implementation:**
```typescript
export function usePricingCalculation(items: OrderItem[]) {
  const [globalDiscount, setGlobalDiscount] = useState(0);
  const [targetTotal, setTargetTotal] = useState("");

  const pricingService = useMemo(() => new PricingService(config), []);

  const pricing = useMemo(() => {
    return pricingService.calculate(items, targetTotal);
  }, [items, targetTotal, pricingService]);

  return { pricing, setGlobalDiscount, setTargetTotal };
}
```

**Success Criteria:**
- [ ] Recalculates pricing when items change
- [ ] Recalculates pricing when targetTotal changes
- [ ] Returns pricing result with error messages
- [ ] Unit tests pass

**Commit Message:**
```
feat(28.2-04): create usePricingCalculation hook

- Integrate PricingService for calculations
- Auto-recalculate on items/targetTotal change
- Use useMemo for performance
- Handle pricing errors gracefully
- Add unit tests
```

---

#### Task 4.3: Create OrderItemCard Component
**File:** `frontend/src/components/OrderFormNew/OrderItemCard.tsx`

**Implementation:**
```tsx
interface OrderItemCardProps {
  item: OrderItem;
  index: number;
  onEdit: () => void;
  onRemove: () => void;
}

export function OrderItemCard(props: OrderItemCardProps) {
  return (
    <div className="item-card">
      <div className="item-header">
        <span>{props.item.productName}</span>
        <button onClick={props.onRemove}>Ã—</button>
      </div>
      <div className="item-details">
        <div>QuantitÃ : {props.item.quantity}</div>
        <div>Prezzo: â‚¬{props.item.price.toFixed(2)}</div>
        {props.item.discount > 0 && (
          <div>Sconto: {props.item.discount}%</div>
        )}
      </div>
    </div>
  );
}
```

**Success Criteria:**
- [ ] Renders item details
- [ ] Shows edit/remove buttons
- [ ] Calculates line total
- [ ] Component < 80 lines

**Commit Message:**
```
feat(28.2-04): create OrderItemCard component

- Display item name, quantity, price, discount
- Show edit/remove action buttons
- Calculate and display line total
- Keep component < 80 lines
```

---

#### Task 4.4: Create OrderItemsList Component
**File:** `frontend/src/components/OrderFormNew/OrderItemsList.tsx`

**Implementation:**
```tsx
export function OrderItemsList() {
  const { orderItems, removeItem } = useOrderForm();

  if (orderItems.length === 0) return null;

  return (
    <div className="card">
      <h2>ðŸ“‹ Articoli ({orderItems.length})</h2>
      <div className="items-list">
        {orderItems.map((item, index) => (
          <OrderItemCard
            key={index}
            item={item}
            index={index}
            onEdit={() => {/* TODO */}}
            onRemove={() => removeItem(index)}
          />
        ))}
      </div>
    </div>
  );
}
```

**Success Criteria:**
- [ ] Renders list of items
- [ ] Shows item count in title
- [ ] Handles remove action
- [ ] Component < 60 lines

**Commit Message:**
```
feat(28.2-04): create OrderItemsList component

- Display all order items in list
- Show item count in header
- Delegate rendering to OrderItemCard
- Handle remove action
- Keep component < 60 lines
```

---

#### Task 4.5: Create PricingSummary Component
**File:** `frontend/src/components/OrderFormNew/PricingSummary.tsx`

**Implementation:**
```tsx
interface PricingSummaryProps {
  items: OrderItem[];
  discountPercent: number;
  targetTotal: string;
  onDiscountChange: (percent: number) => void;
  onTargetTotalChange: (total: string) => void;
}

export function PricingSummary(props: PricingSummaryProps) {
  const { pricing, error } = usePricingCalculation(props.items);

  return (
    <div className="card">
      <h2>ðŸ’° Riepilogo</h2>

      {/* Pricing Breakdown */}
      <div className="pricing-breakdown">
        <div className="row">
          <span>Subtotale (senza IVA):</span>
          <span>â‚¬{pricing.subtotalItems.toFixed(2)}</span>
        </div>
        {pricing.discountPercent > 0 && (
          <div className="row">
            <span>Sconto ({pricing.discountPercent.toFixed(2)}%):</span>
            <span>-â‚¬{(pricing.subtotalItems - pricing.subtotalAfterDiscount).toFixed(2)}</span>
          </div>
        )}
        <div className="row">
          <span>IVA (22%):</span>
          <span>â‚¬{(pricing.subtotalAfterDiscount * 0.22).toFixed(2)}</span>
        </div>
        <div className="row">
          <span>Spedizione:</span>
          <span>â‚¬{pricing.shippingWithVAT.toFixed(2)}</span>
        </div>
        <div className="row total">
          <strong>Totale con IVA:</strong>
          <strong>â‚¬{pricing.totalWithVAT.toFixed(2)}</strong>
        </div>
      </div>

      {/* Optional: Reverse Discount */}
      <div className="discount-input">
        <label>Totale desiderato (con IVA):</label>
        <input
          type="number"
          value={props.targetTotal}
          onChange={(e) => props.onTargetTotalChange(e.target.value)}
          placeholder="es. 25.00"
        />
        {error && <div className="error">{error}</div>}
      </div>
    </div>
  );
}
```

**Success Criteria:**
- [ ] Shows pricing breakdown
- [ ] Shows VAT calculation
- [ ] Shows shipping cost
- [ ] Handles reverse discount input
- [ ] Displays pricing errors
- [ ] Component < 120 lines

**Commit Message:**
```
feat(28.2-04): create PricingSummary component

- Display itemized pricing breakdown
- Show VAT and shipping calculations
- Add reverse discount feature (target total input)
- Display pricing errors from PricingService
- Keep component < 120 lines
```

---

### Plan 04 Success Criteria

- [ ] Can add multiple items to order
- [ ] Can edit/remove items
- [ ] Pricing recalculates automatically
- [ ] Global discount working
- [ ] Reverse discount working
- [ ] All edge cases tested
- [ ] Integration test: Create order with 3 items + discount

### Plan 04 Commits

Expected: 5 commits (one per task)

---

## Plan 05: Pending Queue & Offline

**Duration:** 5-7 days
**Dependencies:** Plan 04 complete
**Goal:** Draft management, offline support, pending queue

### Scope

**In Scope:**
- OrderFormContext (state management)
- OrderActions component (Save Draft, Finish)
- Draft editing workflow
- IndexedDB â†’ localStorage migration
- ConfirmationModal component

**Out of Scope:**
- Batch submission to Archibald (separate /drafts page)
- Service Worker (future)

### Tasks

#### Task 5.1: Create OrderFormContext
**File:** `frontend/src/contexts/OrderFormContext.tsx`

**Implementation:**
```typescript
interface OrderFormState {
  customerId: string;
  customerName: string;
  orderItems: OrderItem[];
  globalDiscount: number;
  targetTotal: string;
  loading: boolean;
  saving: boolean;
}

interface OrderFormActions {
  setCustomer: (id: string, name: string) => void;
  addItem: (item: OrderItem) => void;
  editItem: (index: number, item: OrderItem) => void;
  removeItem: (index: number) => void;
  saveDraft: () => Promise<void>;
  loadDraft: (id: string) => Promise<void>;
}

export function OrderFormProvider({ children }) {
  const [state, setState] = useState<OrderFormState>(initialState);
  const draftManager = useMemo(() => new DraftManager(), []);

  const actions: OrderFormActions = {
    setCustomer: (id, name) => { ... },
    addItem: (item) => { ... },
    editItem: (index, item) => { ... },
    removeItem: (index) => { ... },
    saveDraft: async () => {
      setState(prev => ({ ...prev, saving: true }));
      await draftManager.saveDraft({
        customerId: state.customerId,
        customerName: state.customerName,
        items: state.orderItems,
        discountPercent: state.globalDiscount,
        targetTotalWithVAT: state.targetTotal,
      });
      setState(prev => ({ ...prev, saving: false }));
    },
    loadDraft: async (id) => { ... },
  };

  return (
    <OrderFormContext.Provider value={{ ...state, ...actions }}>
      {children}
    </OrderFormContext.Provider>
  );
}
```

**Success Criteria:**
- [ ] Context provides state + actions
- [ ] saveDraft saves to localStorage
- [ ] loadDraft populates form
- [ ] Component < 200 lines

**Commit Message:**
```
feat(28.2-05): create OrderFormContext for state management

- Centralize all OrderForm state in context
- Provide actions for customer, items, pricing
- Integrate DraftManager for save/load operations
- Avoid prop drilling
- Keep provider < 200 lines
```

---

#### Task 5.2: Create OrderActions Component
**File:** `frontend/src/components/OrderFormNew/OrderActions.tsx`

**Implementation:**
```tsx
export function OrderActions() {
  const { orderItems, saving, saveDraft } = useOrderForm();
  const navigate = useNavigate();

  const handleSave = async () => {
    await saveDraft();
    alert('âœ… Bozza salvata!');
    // Stay on form for multi-order workflow
  };

  const handleFinish = () => {
    navigate('/drafts');
  };

  if (orderItems.length === 0) return null;

  return (
    <div className="card">
      <div className="actions">
        <button
          className="btn btn-primary"
          onClick={handleSave}
          disabled={saving}
        >
          {saving ? 'Salvataggio...' : 'ðŸ’¾ Salva Bozza'}
        </button>
        <button
          className="btn btn-secondary"
          onClick={handleFinish}
        >
          âœ“ Fine
        </button>
      </div>
    </div>
  );
}
```

**Success Criteria:**
- [ ] Save button saves draft
- [ ] Finish button navigates to /drafts
- [ ] Buttons disabled when no items
- [ ] Loading state shown during save
- [ ] Component < 60 lines

**Commit Message:**
```
feat(28.2-05): create OrderActions component

- Add Save Draft button (saves to localStorage)
- Add Finish button (navigates to /drafts)
- Disable buttons when no items
- Show loading state during save
- Keep component < 60 lines
```

---

#### Task 5.3: Implement Draft Editing
**File:** `frontend/src/components/OrderFormNew/OrderFormPage.tsx`

**Implementation:**
```tsx
export function OrderFormPage() {
  const { loadDraft } = useOrderForm();
  const [searchParams] = useSearchParams();

  // Load draft on mount if draftId in URL
  useEffect(() => {
    const draftId = searchParams.get('draftId');
    if (draftId) {
      loadDraft(draftId);
    }
  }, [searchParams, loadDraft]);

  return (
    <OrderFormProvider>
      {/* ... rest of form */}
    </OrderFormProvider>
  );
}
```

**Success Criteria:**
- [ ] Detects ?draftId=xyz query param
- [ ] Loads draft from localStorage
- [ ] Populates form with draft data
- [ ] User can edit and re-save

**Commit Message:**
```
feat(28.2-05): implement draft editing workflow

- Detect draftId query parameter on mount
- Load draft from localStorage using DraftManager
- Populate form with draft data (customer, items, discount)
- Allow user to edit and re-save draft
```

---

#### Task 5.4: Migrate IndexedDB Drafts to localStorage
**File:** `frontend/src/services/draft-manager.ts` (method already planned)

**Implementation:**
```typescript
// In OrderFormProvider useEffect
useEffect(() => {
  async function migrateDrafts() {
    if (localStorage.getItem('drafts_migrated') === 'true') return;

    const draftManager = new DraftManager();
    await draftManager.migrate(); // Copies IndexedDB â†’ localStorage
    localStorage.setItem('drafts_migrated', 'true');

    console.log('[Migration] IndexedDB drafts migrated to localStorage');
  }

  migrateDrafts();
}, []);
```

**Success Criteria:**
- [ ] Migration runs once on first load
- [ ] Old drafts copied to localStorage
- [ ] IndexedDB drafts cleared after migration
- [ ] Flag prevents re-migration

**Commit Message:**
```
feat(28.2-05): migrate IndexedDB drafts to localStorage

- Add migration logic in OrderFormProvider
- Copy legacy IndexedDB drafts to localStorage format
- Clear IndexedDB after successful migration
- Set flag to prevent duplicate migrations
```

---

#### Task 5.5: Create ConfirmationModal Component
**File:** `frontend/src/components/common/ConfirmationModal.tsx`

**Implementation:**
```tsx
interface ConfirmationModalProps {
  isOpen: boolean;
  title: string;
  children: ReactNode;
  onConfirm: () => void;
  onCancel: () => void;
  confirmText?: string;
  cancelText?: string;
  loading?: boolean;
}

export function ConfirmationModal(props: ConfirmationModalProps) {
  if (!props.isOpen) return null;

  return (
    <div className="modal-overlay" onClick={props.onCancel}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <h2>{props.title}</h2>
        <div className="modal-body">{props.children}</div>
        <div className="modal-footer">
          <button onClick={props.onCancel} disabled={props.loading}>
            {props.cancelText || 'Annulla'}
          </button>
          <button onClick={props.onConfirm} disabled={props.loading}>
            {props.loading ? 'Caricamento...' : props.confirmText || 'Conferma'}
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Success Criteria:**
- [ ] Modal opens/closes correctly
- [ ] Click outside closes modal
- [ ] Buttons trigger correct callbacks
- [ ] Loading state disables buttons
- [ ] Component < 80 lines

**Commit Message:**
```
feat(28.2-05): create ConfirmationModal component

- Build reusable confirmation modal
- Support custom title, body, buttons
- Handle loading state
- Click outside to close
- Keep component < 80 lines
```

---

### Plan 05 Success Criteria

- [ ] OrderFormContext manages all state
- [ ] Can save draft to localStorage
- [ ] Can load and edit existing draft
- [ ] IndexedDB drafts migrated to localStorage
- [ ] ConfirmationModal reusable component
- [ ] Integration test: Create order â†’ Save draft â†’ Edit draft â†’ Re-save

### Plan 05 Commits

Expected: 5 commits (one per task)

---

## Plan 06: Integration & Testing

**Duration:** 7-10 days
**Dependencies:** Plans 02-05 complete
**Goal:** End-to-end testing, bug fixes, UAT, feature flag setup

### Scope

**In Scope:**
- Feature flag implementation
- Integration tests
- UAT testing
- Bug fixes
- Documentation
- Migration strategy setup

**Out of Scope:**
- Voice input (Phase 28.3)
- Production rollout (separate phase)

### Tasks

#### Task 6.1: Implement Feature Flag
**Files:**
- `frontend/src/config/features.ts`
- `frontend/src/App.tsx`

**Implementation:**
```typescript
// features.ts
export function getFeatureFlags(): FeatureFlags {
  const localOverride = localStorage.getItem('feature_flags');
  if (localOverride) return JSON.parse(localOverride);

  return {
    newOrderForm: import.meta.env.VITE_FEATURE_NEW_ORDER_FORM === 'true',
  };
}

// App.tsx
<Route
  path="/order-form"
  element={
    isFeatureEnabled('newOrderForm')
      ? <OrderFormNew />
      : <OrderFormOld />
  }
/>
```

**Success Criteria:**
- [ ] Feature flag toggles between old/new form
- [ ] Environment variable controls default
- [ ] localStorage override works
- [ ] Can test both forms

**Commit Message:**
```
feat(28.2-06): implement feature flag for gradual rollout

- Create feature flag infrastructure
- Support environment variable default
- Support localStorage override for testing
- Update router to conditionally render old/new form
```

---

#### Task 6.2: Write Integration Tests
**File:** `frontend/src/components/OrderFormNew/OrderForm.integration.test.tsx`

**Test Cases:**
1. **Create simple order:**
   - Select customer
   - Add 1 item
   - Save draft

2. **Create multi-item order:**
   - Select customer
   - Add 3 items
   - Apply global discount
   - Save draft

3. **Edit existing draft:**
   - Load draft
   - Edit quantity
   - Re-save

4. **Package constraints validation:**
   - Select product with constraints
   - Try invalid quantity
   - Verify error message

5. **Reverse discount calculation:**
   - Add items
   - Enter target total
   - Verify discount calculated

**Success Criteria:**
- [ ] All 5 test cases pass
- [ ] Tests use React Testing Library
- [ ] Mock IndexedDB and API calls
- [ ] Tests run in < 5 seconds

**Commit Message:**
```
test(28.2-06): add integration tests for OrderForm

- Test simple order creation (1 item)
- Test multi-item order (3 items + discount)
- Test draft editing workflow
- Test package constraints validation
- Test reverse discount calculation
- Mock IndexedDB and API calls
```

---

#### Task 6.3: UAT Testing Checklist
**File:** `.planning/phases/28.2-rewrite-orderform-with-proper-architecture/UAT-CHECKLIST.md`

**Create comprehensive UAT checklist:**

```markdown
# UAT Testing Checklist - OrderForm Rewrite

## Customer Selection
- [ ] Can type in customer search box
- [ ] Dropdown shows filtered results
- [ ] Can select customer from dropdown
- [ ] Selected customer displays correctly
- [ ] Can clear selection and re-select

## Product Selection
- [ ] Can type in product search box
- [ ] Dropdown shows filtered results (by name, article, description)
- [ ] Can select product from dropdown
- [ ] Product details show (price, package info)
- [ ] Package constraints displayed

## Add Item
- [ ] Can enter quantity (keyboard)
- [ ] Can adjust price
- [ ] Can enter discount
- [ ] Quantity validation works (min, max, multiple)
- [ ] Add button adds item to list

## Order Items List
- [ ] Items display correctly
- [ ] Can remove item
- [ ] Item count updates
- [ ] Line totals calculated correctly

## Pricing
- [ ] Subtotal calculated correctly
- [ ] VAT calculated correctly (22%)
- [ ] Shipping calculated correctly (free > â‚¬200)
- [ ] Total calculated correctly

## Discount
- [ ] Can enter global discount %
- [ ] Discount applied to pricing
- [ ] Can enter target total (reverse calculation)
- [ ] Discount % calculated from target total
- [ ] Error messages for invalid inputs

## Draft Management
- [ ] Can save draft
- [ ] Draft appears in /drafts page
- [ ] Can edit draft (?draftId=xyz)
- [ ] Changes persisted on re-save
- [ ] Can delete draft

## Offline Support
- [ ] Can load form offline (IndexedDB populated)
- [ ] Customer dropdown works offline
- [ ] Product dropdown works offline
- [ ] Can save draft offline (localStorage)

## Performance
- [ ] Page loads in < 500ms
- [ ] Autocomplete responds quickly (< 100ms)
- [ ] No lag when typing
- [ ] Works smoothly on mobile

## Edge Cases
- [ ] Can create order with 1 item
- [ ] Can create order with 10+ items
- [ ] Can save empty draft (customer only, no items)
- [ ] Cache staleness warning shows (if > 3 days)
```

**Success Criteria:**
- [ ] All checkboxes completed
- [ ] No critical bugs found
- [ ] Performance targets met

**Commit Message:**
```
docs(28.2-06): create UAT testing checklist

- Comprehensive checklist for user acceptance testing
- Cover all features and edge cases
- Include performance criteria
- Document expected behavior
```

---

#### Task 6.4: Bug Fixing Sprint
**Duration:** 2-3 days
**Goal:** Fix all bugs found during integration tests and UAT

**Process:**
1. Run integration tests
2. Run UAT checklist manually
3. Document bugs
4. Prioritize (P0-P3)
5. Fix in priority order
6. Re-test after fixes

**Success Criteria:**
- [ ] All P0 bugs fixed
- [ ] All P1 bugs fixed
- [ ] P2 bugs documented (may defer)
- [ ] All tests passing

**Commit Messages:** (per bug)
```
fix(28.2-06): fix customer selection race condition

- Use setTimeout workaround for dropdown close
- Ensures state updates complete before dropdown closes
- Resolves intermittent selection loss issue
```

---

#### Task 6.5: Documentation
**Files:**
- `README-OrderForm.md` (user guide)
- `ARCHITECTURE.md` (developer guide)

**User Guide Contents:**
- How to create an order
- How to use autocomplete
- How to add multiple items
- How to apply discounts
- How to save/edit drafts
- Offline mode explanation
- Troubleshooting

**Developer Guide Contents:**
- Architecture overview (3 layers)
- Component tree
- State management (Context API)
- Custom hooks
- Services
- Testing approach
- How to add features

**Success Criteria:**
- [ ] User guide complete
- [ ] Developer guide complete
- [ ] Screenshots included
- [ ] Code examples included

**Commit Message:**
```
docs(28.2-06): add user and developer documentation

- Create user guide with step-by-step instructions
- Create developer guide with architecture overview
- Add screenshots and code examples
- Document testing approach
```

---

### Plan 06 Success Criteria

- [ ] Feature flag working
- [ ] All integration tests passing
- [ ] UAT checklist 100% complete
- [ ] All critical bugs fixed
- [ ] Documentation complete
- [ ] Ready for internal testing (Phase 1 of rollout)

### Plan 06 Commits

Expected: 5+ commits (1 per task + bug fixes)

---

## Summary Timeline

| Week | Plan | Focus | Output |
|------|------|-------|--------|
| 1 | Plan 02 | Data Layer & Services | SyncService, DraftManager, PricingService, ValidationService |
| 2 | Plan 03 | Customer & Product Selection | AutocompleteDropdown, useCustomerSelection, useProductSelection, CustomerSection, ProductSection |
| 2-3 | Plan 04 | Multi-Article & Discounts | useOrderItems, usePricingCalculation, OrderItemsList, PricingSummary |
| 3-4 | Plan 05 | Pending Queue & Offline | OrderFormContext, OrderActions, Draft editing, Migration |
| 4-5 | Plan 06 | Integration & Testing | Feature flag, Tests, UAT, Bug fixes, Documentation |

**Total:** 4-5 weeks for Plans 02-06

---

## Rollout Timeline (After Plan 06)

| Week | Phase | Audience | Size |
|------|-------|----------|------|
| 6 | Phase 1 | Internal (Admins) | 2-5 users |
| 7 | Phase 2 | Beta (10%) | 5-10 users |
| 8 | Phase 3 | Gradual (25â†’50â†’75â†’100%) | All users |
| 9 | Phase 4 | Cleanup | Remove old form |

**Total Project:** 9 weeks (design â†’ production)

---

## Next Steps

1. **User Approval:** Review this roadmap
2. **Start Plan 02:** Create SyncService (Task 2.1)
3. **Daily Progress:** Commit per task, update STATE.md
4. **Weekly Check-ins:** Review progress, adjust timeline
5. **Celebrate Wins:** ðŸŽ‰ Each plan completion

---

**End of Implementation Roadmap**
