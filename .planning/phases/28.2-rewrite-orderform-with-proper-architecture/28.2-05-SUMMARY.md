# Phase 28.2 Plan 05: Pending Queue & Offline - Summary

**Pending orders queue, offline support, and batch submission complete**

## Accomplishments

- Built PendingOrdersPage with multi-select and batch submission (9 tests passing)
- Built offline detection hook (useOnlineStatus)
- Built OfflineSyncBanner with auto-prompt when coming online
- Created bot API endpoint for batch order submission
- Integrated components into AppRouter
- Created seed script for manual testing
- All 9 component tests passing
- Backend bot API endpoint working

## Files Created

### Frontend Components
- `archibald-web-app/frontend/src/pages/PendingOrdersPage.tsx`
- `archibald-web-app/frontend/src/pages/PendingOrdersPage.spec.tsx`
- `archibald-web-app/frontend/src/hooks/useOnlineStatus.ts`
- `archibald-web-app/frontend/src/components/OfflineSyncBanner.tsx`
- `archibald-web-app/frontend/src/scripts/seed-pending-orders.ts`

### Backend API
- `archibald-web-app/backend/src/routes/bot.ts`

## Files Modified

- `archibald-web-app/backend/src/index.ts` - Registered bot routes
- `archibald-web-app/frontend/src/AppRouter.tsx` - Added /pending-orders route, integrated OfflineSyncBanner

## Component Features

**PendingOrdersPage:**
- ✅ Displays pending orders with customer, items, totals
- ✅ Multi-select with individual checkboxes
- ✅ "Select All" functionality
- ✅ Batch submission button (enabled when ≥1 selected)
- ✅ Status badges (In Attesa / Errore / In Elaborazione)
- ✅ Error message display for failed orders
- ✅ Empty state when no orders
- ✅ Real-time loading states

**useOnlineStatus Hook:**
- ✅ Detects network state changes (navigator.onLine)
- ✅ Listens to online/offline events
- ✅ Console logging for debugging

**OfflineSyncBanner:**
- ✅ Appears automatically when coming online
- ✅ Checks for pending orders (status='pending')
- ✅ Shows pending order count
- ✅ "Vai agli Ordini" button → navigates to /pending-orders
- ✅ "Dopo" button → dismisses banner
- ✅ Fixed position bottom-center with blue background

**Bot API (POST /api/bot/submit-orders):**
- ✅ Accepts array of order data
- ✅ Queues each order to QueueManager
- ✅ Returns array of job IDs
- ✅ Authentication required (JWT)
- ✅ Comprehensive logging

**Integration:**
- ✅ Route /pending-orders added to AppRouter
- ✅ OfflineSyncBanner mounted at app root level
- ✅ Works alongside existing OfflineBanner

## Test Results

- ✅ PendingOrdersPage.spec.tsx: 9/9 tests passing
  - Empty state, order display, multi-select, batch submission
  - Status badges, error messages, button states

**Total: 9/9 tests passing**

## Commits Made

1. `9889d02` - feat(28.2-05): add PendingOrdersPage with multi-select and batch submission
2. `5670cf5` - feat(28.2-05): add offline detection and auto-sync banner
3. `5007ead` - feat(28.2-05): add bot API for batch order submission
4. `52892f8` - feat(28.2-05): integrate PendingOrdersPage and OfflineSyncBanner into app
5. `abc94dc` - feat(28.2-05): add seed script for testing pending orders

## Checkpoint: Manual Verification

**Status**: Ready for manual testing

**How to Test:**

### 1. Seed Test Data
Open browser console:
```javascript
seedPendingOrders()
```

This creates 3 test orders (2 pending, 1 error)

### 2. Test PendingOrdersPage
Navigate to `/pending-orders`:
- ✅ Verify 3 orders displayed
- ✅ Verify status badges (2 "In Attesa", 1 "Errore")
- ✅ Verify error message shown for error order
- ✅ Test individual checkbox selection
- ✅ Test "Seleziona Tutti" checkbox
- ✅ Test "Invia Ordini Selezionati" button enabled/disabled

### 3. Test Batch Submission
- ✅ Select 2 orders
- ✅ Click "Invia Ordini Selezionati"
- ✅ Verify alert with job IDs
- ✅ Verify orders status changed to "In Elaborazione"
- ✅ Check backend logs for bot processing

### 4. Test Offline Detection
- ✅ Go offline (DevTools → Network → Offline)
- ✅ Create seed orders (they'll be pending)
- ✅ Go online
- ✅ Verify OfflineSyncBanner appears
- ✅ Verify correct count displayed
- ✅ Click "Vai agli Ordini" → navigate to /pending-orders
- ✅ Test "Dopo" button → banner dismissed

### 5. Test Error Retry
- ✅ Select an order with status "Errore"
- ✅ Click "Invia Ordini Selezionati"
- ✅ Verify can retry

**Limitations:**
- Full offline order creation NOT implemented yet (requires OrderForm integration in Plan 28.2-06)
- Bot processing will fail if orders have invalid data (expected - test data is minimal)
- For now, use seed script to populate pending orders

## Architecture Decisions

1. **Separate PendingOrdersPage from PendingOrdersView**: Kept existing PendingOrdersView (/pending) for backward compatibility, created new PendingOrdersPage (/pending-orders) with enhanced features
2. **Bot API receives full order data**: Frontend IndexedDB can't be accessed by backend, so frontend sends complete order data instead of just IDs
3. **Banner at app root**: OfflineSyncBanner mounted at BrowserRouter level for global visibility
4. **Seed script for testing**: Temporary solution for manual testing until OrderForm integration (Plan 28.2-06)

## Issues Encountered

None - all tasks completed successfully

## Next Step

Ready for 28.2-06-PLAN.md (OrderForm Integration & State Management)

**Integration Required**: Plan 28.2-06 will:
- Build complete OrderForm with all components from Plans 28.2-03, 28.2-04, 28.2-05
- Integrate CustomerSelector, ProductSelector, QuantityInput, OrderItemsList, DiscountSystem, OrderSummary
- Implement state management with real-time calculations
- Connect to PriceService for pricing
- Save orders to pendingOrders table (both online and offline)
- Complete offline-first order creation flow

**Execute**: `/gsd:execute-plan .planning/phases/28.2-rewrite-orderform-with-proper-architecture/28.2-06-PLAN.md`
