# Migration Strategy - OrderForm Rewrite

**Strategy Date:** 2026-01-23
**Phase:** 28.2 (Rewrite OrderForm with Proper Architecture)
**Plan:** 01 (Codebase Analysis & Architecture Design)

---

## Executive Summary

This document defines the **safe migration strategy** from the old monolithic OrderForm (2,705 lines) to the new modular architecture. The strategy uses:

- **Feature Flag:** Side-by-side deployment with instant rollback
- **Gradual Rollout:** Internal â†’ Beta â†’ Full production
- **Zero Downtime:** Old form stays active during migration
- **Data Compatibility:** Both systems share same draft format
- **Testing Gates:** UAT required before each rollout phase

**Timeline:** 4-6 weeks for complete migration

---

## 1. Migration Principles

### 1.1 Core Principles

1. **Zero Downtime:** Users never blocked from creating orders
2. **Instant Rollback:** Can revert to old form in < 1 minute
3. **Data Safety:** No data loss during migration
4. **Gradual Rollout:** Test with small user groups first
5. **Monitoring:** Track errors and performance continuously

### 1.2 Risk Mitigation

**Risks:**
- New form has bugs not caught in testing
- Performance issues with large datasets
- User confusion with new UI
- Data incompatibility between old/new systems

**Mitigations:**
- Feature flag for instant rollback
- Load testing with 10,000+ products
- User training/documentation
- Shared draft format between systems

---

## 2. Feature Flag Implementation

### 2.1 Feature Flag Setup

**File:** `frontend/src/config/features.ts`

```typescript
export interface FeatureFlags {
  newOrderForm: boolean;
  // Future flags...
}

export function getFeatureFlags(): FeatureFlags {
  // Check localStorage first (for testing)
  const localOverride = localStorage.getItem('feature_flags');
  if (localOverride) {
    try {
      return JSON.parse(localOverride);
    } catch (e) {
      console.error('Invalid feature flags in localStorage:', e);
    }
  }

  // Check environment variables
  const flags: FeatureFlags = {
    newOrderForm: import.meta.env.VITE_FEATURE_NEW_ORDER_FORM === 'true',
  };

  return flags;
}

export function isFeatureEnabled(feature: keyof FeatureFlags): boolean {
  const flags = getFeatureFlags();
  return flags[feature] ?? false;
}
```

### 2.2 Router Configuration

**File:** `frontend/src/App.tsx`

```typescript
import { OrderFormOld } from './components/OrderForm';
import { OrderFormNew } from './components/OrderFormNew/OrderFormPage';
import { isFeatureEnabled } from './config/features';

function App() {
  return (
    <Routes>
      {/* Other routes... */}

      <Route
        path="/order-form"
        element={
          isFeatureEnabled('newOrderForm')
            ? <OrderFormNew />
            : <OrderFormOld />
        }
      />

      {/* Other routes... */}
    </Routes>
  );
}
```

### 2.3 Testing Override (Development)

**Console Command:**
```javascript
// Enable new form
localStorage.setItem('feature_flags', JSON.stringify({ newOrderForm: true }));
location.reload();

// Disable new form (rollback)
localStorage.setItem('feature_flags', JSON.stringify({ newOrderForm: false }));
location.reload();

// Clear override (use environment default)
localStorage.removeItem('feature_flags');
location.reload();
```

**Admin UI (Future):**
```tsx
// Admin Settings Page
<FeatureFlagToggle
  flag="newOrderForm"
  label="New Order Form"
  description="Enable redesigned order form with improved architecture"
  onToggle={(enabled) => {
    localStorage.setItem('feature_flags', JSON.stringify({
      ...getFeatureFlags(),
      newOrderForm: enabled
    }));
    location.reload();
  }}
/>
```

---

## 3. Phased Rollout Plan

### Phase 0: Pre-Migration (Week 1)

**Goal:** Prepare infrastructure and baseline metrics

**Tasks:**
1. âœ… Complete architecture design (this plan)
2. Set up feature flag infrastructure
3. Configure monitoring (error tracking, performance)
4. Document baseline metrics:
   - Current error rate
   - Average page load time
   - Average order creation time
   - User satisfaction score (if available)
5. Create rollback runbook
6. Train support team on new form

**Success Criteria:**
- [ ] Feature flag working (test in dev)
- [ ] Monitoring dashboards created
- [ ] Baseline metrics recorded
- [ ] Rollback procedure tested

---

### Phase 1: Internal Testing (Week 2-3)

**Goal:** Validate new form with internal users (developers, QA, admin)

**Rollout:**
- **Audience:** Admin users only (`isAdmin === true`)
- **Method:** Code check in OrderFormPage
- **Size:** 2-5 users

**Configuration:**
```typescript
// OrderFormPage.tsx
const user = useAuth();
const shouldUseNewForm = isFeatureEnabled('newOrderForm') || user.isAdmin;

if (shouldUseNewForm) {
  return <OrderFormNew />;
} else {
  return <OrderFormOld />;
}
```

**Testing Checklist:**
- [ ] Customer selection (autocomplete)
- [ ] Product selection (autocomplete)
- [ ] Add multiple items (2-10 items)
- [ ] Edit item (quantity, price, discount)
- [ ] Remove item
- [ ] Global discount calculation
- [ ] Reverse discount (target total)
- [ ] Save draft
- [ ] Edit existing draft
- [ ] Delete draft
- [ ] Cache staleness warning
- [ ] Offline mode (disconnect network)
- [ ] IndexedDB populated (check DevTools)
- [ ] Performance (< 500ms load time)

**Exit Criteria:**
- [ ] All features working
- [ ] No critical bugs
- [ ] IndexedDB populated correctly
- [ ] Performance meets targets
- [ ] Admin approval to proceed

**Rollback Trigger:**
- Any critical bug blocking order creation
- Data loss or corruption
- Performance degradation > 50%

---

### Phase 2: Beta Testing (Week 3-4)

**Goal:** Validate with real users in production environment

**Rollout:**
- **Audience:** 10% of users (random selection)
- **Method:** User ID hash-based selection
- **Size:** ~5-10 users (assuming 50-100 total users)

**Configuration:**
```typescript
// frontend/src/utils/rollout.ts
export function shouldUseNewOrderForm(userId: string): boolean {
  // Check feature flag first
  if (!isFeatureEnabled('newOrderForm')) {
    return false;
  }

  // Admins always get new form
  const user = getCurrentUser();
  if (user.isAdmin) {
    return true;
  }

  // 10% rollout: hash user ID and check if < 10
  const hash = simpleHash(userId);
  const bucket = hash % 100; // 0-99
  return bucket < 10; // 10% of users
}

function simpleHash(str: string): number {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash);
}
```

**Monitoring:**
- Error rate (target: < 1%)
- Page load time (target: < 500ms)
- Order creation time (target: < 30s end-to-end)
- User feedback (surveys, support tickets)

**Success Metrics:**
- [ ] Error rate â‰¤ old form
- [ ] Performance â‰¥ old form
- [ ] No data loss incidents
- [ ] Positive user feedback (â‰¥ 80%)

**Exit Criteria:**
- [ ] 1 week of stable operation
- [ ] No critical bugs
- [ ] Error rate < 1%
- [ ] User satisfaction â‰¥ 80%

**Rollback Trigger:**
- Error rate > 5%
- Data loss incident
- Multiple user complaints
- Performance regression > 2x

---

### Phase 3: Gradual Rollout (Week 5)

**Goal:** Expand to majority of users

**Rollout Schedule:**
- **Day 1:** 25% of users
- **Day 2:** 50% of users
- **Day 3:** 75% of users
- **Day 5:** 100% of users

**Configuration:**
```typescript
// Adjust bucket size based on day
const rolloutPercentage = getRolloutPercentage(); // 25, 50, 75, 100
return bucket < rolloutPercentage;
```

**Monitoring (Continuous):**
- Real-time error tracking
- Performance metrics
- User behavior analytics
- Support ticket volume

**Pause Criteria:**
- Error rate spike (> 3%)
- Performance degradation (> 1s load time)
- Critical bug discovered
- Support ticket spike (> 5 tickets/day)

**Rollback at Any Stage:**
- Instant: Change environment variable
- Propagates: Within 5 minutes (app refresh)

---

### Phase 4: Full Production (Week 6)

**Goal:** Complete migration, remove old form

**Tasks:**
1. Enable new form for 100% of users
2. Monitor for 1 week
3. Announce deprecation of old form
4. Remove old OrderForm.tsx code
5. Remove feature flag
6. Update documentation
7. Celebrate! ðŸŽ‰

**Cleanup Checklist:**
- [ ] Delete `OrderForm.tsx` (old monolith)
- [ ] Remove feature flag checks
- [ ] Update imports/routes
- [ ] Remove legacy DraftService (IndexedDB)
- [ ] Migrate remaining IndexedDB drafts to localStorage
- [ ] Update user documentation
- [ ] Update training materials

**Final Verification:**
- [ ] All users on new form
- [ ] No old form references in codebase
- [ ] All drafts migrated
- [ ] Documentation updated
- [ ] Support team trained

---

## 4. Data Migration Strategy

### 4.1 Draft Compatibility

**Challenge:** Old and new forms must share draft data during rollout

**Solution:** Unified draft format

**Shared Schema:**
```typescript
// Both systems use this format
interface DraftOrder {
  id: string;
  customerId: string;
  customerName: string;
  items: Array<{
    articleCode: string;
    quantity: number;
    price: number;
    productName?: string;
    description?: string;
    discount?: number;
  }>;
  discountPercent?: number;
  targetTotalWithVAT?: number;
  createdAt: string;
  updatedAt: string;
}
```

**Storage Location:** `localStorage['archibald_draft_orders']`

**Compatibility:**
- âœ… Old form can read drafts created by new form
- âœ… New form can read drafts created by old form
- âœ… No data loss during rollout

### 4.2 IndexedDB Draft Migration

**Problem:** Old system uses IndexedDB, new uses localStorage

**Solution:** One-time migration on first new form load

```typescript
// OrderFormProvider.tsx
useEffect(() => {
  async function migrateIndexedDBDrafts() {
    // Check if migration already done
    if (localStorage.getItem('drafts_migrated') === 'true') {
      return;
    }

    // Get drafts from IndexedDB (legacy system)
    const legacyDraft = await draftService.getDraft();

    if (legacyDraft && legacyDraft.items.length > 0) {
      // Convert to new format
      const newDraft: DraftOrder = {
        id: `draft-${Date.now()}-migrated`,
        customerId: legacyDraft.customerId,
        customerName: legacyDraft.customerName,
        items: legacyDraft.items.map(item => ({
          articleCode: item.article,
          quantity: item.quantity,
          price: 0,
          productName: item.productName,
        })),
        createdAt: legacyDraft.createdAt,
        updatedAt: legacyDraft.updatedAt,
      };

      // Save to localStorage
      const existingDrafts = getDraftOrders();
      existingDrafts.push(newDraft);
      localStorage.setItem('archibald_draft_orders', JSON.stringify(existingDrafts));

      // Clear IndexedDB draft
      await draftService.clearDraft();

      console.log('[Migration] IndexedDB draft migrated to localStorage');
    }

    // Mark migration as complete
    localStorage.setItem('drafts_migrated', 'true');
  }

  migrateIndexedDBDrafts();
}, []);
```

### 4.3 Rollback Data Safety

**If Rollback Needed:**

Old form still works because:
- âœ… Drafts in localStorage are compatible
- âœ… Old form reads localStorage first
- âœ… Falls back to IndexedDB if localStorage empty
- âœ… No data loss

---

## 5. Rollback Procedures

### 5.1 Instant Rollback (< 1 minute)

**Scenario:** Critical bug discovered, need immediate rollback

**Steps:**
1. **Change environment variable:**
   ```bash
   # In deployment config or .env
   VITE_FEATURE_NEW_ORDER_FORM=false
   ```

2. **Deploy change:**
   ```bash
   # If using Vercel/Netlify
   git commit -m "Rollback: disable new order form"
   git push origin main

   # Auto-deploys in < 1 minute
   ```

3. **Verify:**
   - Open app in browser
   - Navigate to `/order-form`
   - Confirm old form is shown
   - Test order creation

4. **Notify users:**
   - Post in team chat: "Rolled back to old order form due to [issue]"
   - No user action required (automatic on next page refresh)

**Result:** All users back on old form within 5 minutes (as they refresh)

### 5.2 Selective Rollback (Specific Users)

**Scenario:** Issue affecting only some users

**Steps:**
1. **Identify affected users:**
   - Check error logs
   - Filter by user ID

2. **Add user IDs to exclusion list:**
   ```typescript
   // frontend/src/utils/rollout.ts
   const EXCLUDED_USERS = [
     'user-123',
     'user-456',
   ];

   export function shouldUseNewOrderForm(userId: string): boolean {
     if (EXCLUDED_USERS.includes(userId)) {
       return false; // Force old form
     }
     // ... rest of logic
   }
   ```

3. **Deploy change**

4. **Notify affected users:**
   - Email: "We've temporarily reverted your order form. We're investigating the issue."

### 5.3 Permanent Rollback (Project Cancellation)

**Scenario:** Major architectural issue, cannot proceed

**Steps:**
1. Disable feature flag (instant rollback)
2. Delete new form code:
   ```bash
   rm -rf frontend/src/components/OrderFormNew
   rm -rf frontend/src/hooks/useCustomerSelection.ts
   rm -rf frontend/src/hooks/useProductSelection.ts
   rm -rf frontend/src/services/sync-service.ts
   # etc.
   ```
3. Remove feature flag code
4. Update documentation
5. Post-mortem: What went wrong? Lessons learned?

---

## 6. Monitoring & Alerting

### 6.1 Key Metrics

**Error Tracking:**
- JavaScript errors (Sentry, LogRocket)
- API errors (4xx, 5xx responses)
- Network timeouts

**Performance:**
- Page load time (Web Vitals)
- IndexedDB query time
- API response time

**User Behavior:**
- Order creation success rate
- Draft save rate
- Feature usage (autocomplete, discount, etc.)

**Business Metrics:**
- Orders created per day
- Average order value
- Draft abandonment rate

### 6.2 Alerting Rules

**Critical (Page Immediately):**
- Error rate > 5% (sustained for 5 minutes)
- API response time > 5s (95th percentile)
- Order creation failing for all users

**High (Notify Within 1 Hour):**
- Error rate > 2% (sustained for 15 minutes)
- Performance regression > 2x baseline
- Draft save failures > 10%

**Medium (Daily Digest):**
- Error rate > 1%
- Performance regression > 1.5x baseline
- User feedback (negative reviews)

### 6.3 Dashboard Setup

**Tools:**
- **Sentry:** Error tracking, stack traces
- **Google Analytics:** User behavior, conversion funnels
- **Vercel Analytics:** Web Vitals, page load metrics
- **Custom Dashboard:** Business metrics (orders/day, draft conversion)

**Key Views:**
1. **Real-time Overview:**
   - Current error rate
   - Active users on new vs old form
   - Orders created today

2. **Performance:**
   - Page load time (p50, p95, p99)
   - API response time
   - IndexedDB query time

3. **Errors:**
   - Error rate over time
   - Top errors by frequency
   - Affected users

4. **Rollout:**
   - % of users on new form
   - Rollout timeline
   - Pause/resume controls

---

## 7. User Communication Plan

### 7.1 Pre-Launch Communication

**Audience:** All users
**Timing:** 1 week before Phase 1

**Message:**
> **Subject:** Upcoming Improvement: New Order Form
>
> We're excited to announce a redesigned order form coming soon!
>
> **What's New:**
> - Faster product search (now works offline!)
> - Improved autocomplete for customers and products
> - Better performance and reliability
> - Same familiar workflow
>
> **When:**
> - Internal testing: Week of [Date]
> - Beta testing: Week of [Date]
> - Full rollout: Week of [Date]
>
> **What You Need to Do:**
> - Nothing! The new form will be enabled automatically
> - Your existing drafts will continue to work
>
> **Questions?**
> - Contact support: support@formicanera.com
> - Read the guide: [Link to documentation]

### 7.2 Phase 1 Announcement (Internal)

**Audience:** Admin users
**Timing:** Day 1 of Phase 1

**Message:**
> **Subject:** [INTERNAL] New Order Form - Testing Phase
>
> The new order form is now live for admin users!
>
> **Your Mission:**
> - Test all features (see checklist: [link])
> - Report any bugs: [bug tracker link]
> - Provide feedback: [survey link]
>
> **Known Differences:**
> - Product search now uses IndexedDB (faster!)
> - Layout slightly adjusted for better mobile UX
> - Voice input temporarily disabled (returning in Phase 28.3)
>
> **Rollback:**
> - If you encounter issues, we can switch you back instantly
> - Just message in #support channel

### 7.3 Phase 2 Announcement (Beta)

**Audience:** 10% beta users
**Timing:** Day 1 of Phase 2

**Message:**
> **Subject:** You're Part of Our Beta Test!
>
> You've been selected to try our new order form! ðŸŽ‰
>
> **What's Different:**
> - Faster product search (works offline)
> - Improved autocomplete
> - Better performance
>
> **Your Feedback Matters:**
> - Take our quick survey: [link]
> - Report bugs: [link]
> - Need help? Contact support
>
> **Having Issues?**
> - We can switch you back to the old form instantly
> - No data will be lost

### 7.4 Phase 3 Announcement (Full Rollout)

**Audience:** All users
**Timing:** Day 1 of Phase 3

**Message:**
> **Subject:** New Order Form is Here!
>
> The new and improved order form is rolling out to everyone!
>
> **You'll See:**
> - Faster loading (especially on mobile)
> - Better autocomplete
> - Offline support
>
> **Your Action Required:**
> - None! Just refresh your browser
> - Existing drafts will work automatically
>
> **Training:**
> - Watch our 2-minute video: [link]
> - Read the guide: [link]
>
> **Questions?**
> - FAQs: [link]
> - Support: support@formicanera.com

---

## 8. Success Criteria

### 8.1 Technical Metrics

| Metric | Baseline (Old) | Target (New) | Pass/Fail |
|--------|---------------|--------------|-----------|
| Error Rate | < 2% | < 1% | Must pass |
| Page Load Time | ~2s | < 500ms | Must pass |
| IndexedDB Products | 0 | > 5,000 | Must pass |
| Order Creation Success | 95% | > 98% | Must pass |
| API Fallback Rate | 100% | < 10% | Should pass |
| Mobile Performance | Poor | Good | Should pass |

### 8.2 User Satisfaction

| Metric | Target | Pass/Fail |
|--------|--------|-----------|
| User Survey Rating | â‰¥ 4/5 | Should pass |
| Support Tickets | â‰¤ Baseline | Must pass |
| Order Creation Time | â‰¤ Baseline | Should pass |
| Feature Adoption | â‰¥ 90% | Should pass |

### 8.3 Go/No-Go Decision Points

**After Phase 1 (Internal Testing):**
- **GO:** No critical bugs + all features working
- **NO-GO:** Any data loss or critical bug

**After Phase 2 (Beta Testing):**
- **GO:** Error rate < 1% + positive feedback
- **NO-GO:** Error rate > 2% or negative feedback

**Before Phase 3 (Full Rollout):**
- **GO:** 1 week stable operation in beta
- **NO-GO:** Any unresolved critical issues

**Before Phase 4 (Remove Old Form):**
- **GO:** 100% users on new form + 1 week stable
- **NO-GO:** Any outstanding issues

---

## 9. Rollback Decision Matrix

| Severity | Criteria | Action | Timeline |
|----------|----------|--------|----------|
| **P0 - Critical** | Data loss, all users blocked | Instant rollback | < 5 min |
| **P1 - High** | Error rate > 5%, major feature broken | Rollback during business hours | < 1 hour |
| **P2 - Medium** | Error rate 2-5%, minor feature broken | Pause rollout, fix, resume | < 1 day |
| **P3 - Low** | Error rate 1-2%, cosmetic issues | Continue rollout, fix in next release | < 1 week |

---

## 10. Timeline Summary

```
Week 1: Pre-Migration
  â”œâ”€ Setup feature flag
  â”œâ”€ Configure monitoring
  â””â”€ Document baseline

Week 2-3: Phase 1 (Internal Testing)
  â”œâ”€ Enable for admins
  â”œâ”€ Test all features
  â””â”€ Fix critical bugs

Week 3-4: Phase 2 (Beta Testing)
  â”œâ”€ Enable for 10% users
  â”œâ”€ Monitor metrics
  â””â”€ Collect feedback

Week 5: Phase 3 (Gradual Rollout)
  â”œâ”€ Day 1: 25% users
  â”œâ”€ Day 2: 50% users
  â”œâ”€ Day 3: 75% users
  â””â”€ Day 5: 100% users

Week 6: Phase 4 (Cleanup)
  â”œâ”€ Remove old form
  â”œâ”€ Remove feature flag
  â””â”€ Update documentation
```

**Total Duration:** 6 weeks
**Critical Path:** Phase 2 beta testing (quality gate)

---

## 11. Risk Register

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Critical bug in production | Medium | High | Feature flag + instant rollback |
| Performance regression | Low | Medium | Load testing before rollout |
| User confusion | Medium | Low | Training + documentation |
| Data loss | Low | Critical | Shared draft format + backups |
| IndexedDB still empty | Medium | High | SyncService + monitoring |
| Rollout takes too long | Low | Low | Gradual rollout by percentage |

---

## 12. Post-Migration Review

**After Week 6 (Full Production):**

**Review Questions:**
1. Did we meet all success criteria?
2. What went well?
3. What could be improved?
4. Were there any surprises?
5. Lessons learned for future migrations?

**Metrics Review:**
- Error rate: Actual vs Target
- Performance: Actual vs Target
- User satisfaction: Survey results
- Time to completion: 6 weeks (target) vs Actual

**Action Items:**
- Document lessons learned
- Update migration playbook
- Celebrate team success! ðŸŽ‰

---

**End of Migration Strategy**
