---
phase: 28.2-rewrite-orderform-with-proper-architecture
plan: 05
type: execute
---

<objective>
Build PendingOrdersPage with multi-select and batch submission, implement offline detection and auto-sync, integrate with bot for order creation in Archibald.

Purpose: Complete offline-first functionality allowing users to create orders offline and submit in batches when online.
Output: PendingOrdersPage component, offline sync service, bot integration, all tested and working.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28.2-rewrite-orderform-with-proper-architecture/28.2-CONTEXT.md
@.planning/phases/28.2-rewrite-orderform-with-proper-architecture/28.2-04-PLAN.md
@archibald-web-app/frontend/src/services/orders.service.ts
@archibald-web-app/frontend/src/db/schema.ts

**Dependencies:**
- Plan 28.2-02 completed (OrderService with pending queue)
- Plan 28.2-04 completed (Order creation functionality)
- IndexedDB pendingOrders table exists
- Bot integration exists (Phase 9 - background bot)

**Requirements from CONTEXT.md:**

**Pending Orders Queue:**
- Queue Page: Schermata separata che raggruppa ordini da inviare
- Multi-Select: Selettore per marcare ordini da inviare
- Batch Submission: Pulsante per avviare bot e creare tutti gli ordini selezionati su Archibald

**Offline Support (CRITICAL):**
- Create Offline: Utente può creare ordini anche senza connessione
- Local Queue: Ordini salvati localmente in "pending" state
- Auto-Sync: Quando connessione torna, chiedere se inviare ordini pending
- Status Tracking: Utente vede chiaramente quali ordini sono offline vs synced

**User Workflows (from CONTEXT.md):**

**Happy Path - Offline Order:**
1. User offline (airplane mode, no network)
2. Follow normal order creation flow
3. Click "Crea Ordine"
4. Order saved to Pending Queue with status "pending_offline"
5. Message: "Ordine salvato. Verrà inviato quando torni online."
6. User goes online → Network detected
7. Banner/notification: "Hai 3 ordini da inviare. Vuoi inviarli ora?"
8. User confirms → orders sent to bot queue

**Batch Submission Flow:**
1. User navigates to "Ordini Pending" page
2. Sees list of orders awaiting submission
3. Checkboxes allow multi-select
4. User selects orders to submit (or "Select All")
5. Click "Invia Ordini Selezionati"
6. Bot processes orders in queue
7. Status updates in real-time (processing → completed/error)

**Technical Implementation:**

**Offline Detection:**
```typescript
// Use navigator.onLine + online/offline events
const [isOnline, setIsOnline] = useState(navigator.onLine);

useEffect(() => {
  const handleOnline = () => setIsOnline(true);
  const handleOffline = () => setIsOnline(false);

  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);

  return () => {
    window.removeEventListener('online', handleOnline);
    window.removeEventListener('offline', handleOffline);
  };
}, []);
```

**Pending Order Status:**
- `pending`: Created, waiting for submission
- `syncing`: Currently being processed by bot
- `error`: Bot encountered error, needs retry
- Completed orders are removed from queue

**Bot Integration:**
- Existing: Phase 9 background bot (browser-based Archibald automation)
- API endpoint: POST /api/bot/submit-orders
- Payload: Array of PendingOrder IDs
- Response: Job ID for tracking

**Data Structures (from schema.ts):**
```typescript
interface PendingOrder {
  id?: number; // Auto-increment
  customerId: string;
  customerName: string;
  items: Array<{
    articleCode: string;
    productName?: string;
    description?: string;
    quantity: number;
    price: number;
    discount?: number;
  }>;
  discountPercent?: number;
  targetTotalWithVAT?: number;
  createdAt: string;
  status: 'pending' | 'syncing' | 'error';
  errorMessage?: string;
  retryCount: number;
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build PendingOrdersPage with multi-select UI</name>
  <files>archibald-web-app/frontend/src/pages/PendingOrdersPage.tsx (new), archibald-web-app/frontend/src/pages/PendingOrdersPage.spec.tsx (new)</files>
  <action>
Build the pending orders queue page:

1. **Create test file first**: `PendingOrdersPage.spec.tsx`

Tests:
- Renders empty state when no pending orders
- Displays list of pending orders with details
- Checkbox for each order (multi-select)
- "Select All" checkbox
- "Invia Ordini Selezionati" button enabled when ≥1 selected
- Shows order status badges (pending/error)
- Shows error messages for failed orders
- Retry button for error orders

2. **Implement PendingOrdersPage**: `PendingOrdersPage.tsx`

```typescript
import { useState, useEffect } from 'react';
import { orderService } from '../services/orders.service';
import type { PendingOrder } from '../db/schema';

export function PendingOrdersPage() {
  const [orders, setOrders] = useState<PendingOrder[]>([]);
  const [selectedOrderIds, setSelectedOrderIds] = useState<Set<number>>(new Set());
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);

  // Load pending orders on mount
  useEffect(() => {
    loadOrders();
  }, []);

  const loadOrders = async () => {
    setLoading(true);
    try {
      const pendingOrders = await orderService.getPendingOrders();
      setOrders(pendingOrders);
    } catch (error) {
      console.error('[PendingOrdersPage] Failed to load orders:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSelectOrder = (orderId: number) => {
    setSelectedOrderIds((prev) => {
      const updated = new Set(prev);
      if (updated.has(orderId)) {
        updated.delete(orderId);
      } else {
        updated.add(orderId);
      }
      return updated;
    });
  };

  const handleSelectAll = () => {
    if (selectedOrderIds.size === orders.length) {
      setSelectedOrderIds(new Set());
    } else {
      setSelectedOrderIds(new Set(orders.map((o) => o.id!)));
    }
  };

  const handleSubmitOrders = async () => {
    if (selectedOrderIds.size === 0) return;

    setSubmitting(true);

    try {
      // Call bot API to submit orders
      const response = await fetch('/api/bot/submit-orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          orderIds: Array.from(selectedOrderIds),
        }),
      });

      if (!response.ok) throw new Error('Bot submission failed');

      const { jobId } = await response.json();

      // Update order status to 'syncing'
      for (const orderId of selectedOrderIds) {
        await orderService.updatePendingOrderStatus(orderId, 'syncing');
      }

      alert(`Ordini inviati al bot. Job ID: ${jobId}`);

      // Reload orders and clear selection
      await loadOrders();
      setSelectedOrderIds(new Set());
    } catch (error) {
      console.error('[PendingOrdersPage] Submission failed:', error);
      alert('Errore durante l\'invio degli ordini. Riprova.');
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div style={{ padding: '2rem', textAlign: 'center' }}>
        Caricamento ordini in attesa...
      </div>
    );
  }

  if (orders.length === 0) {
    return (
      <div
        style={{
          padding: '2rem',
          textAlign: 'center',
          color: '#6b7280',
          backgroundColor: '#f9fafb',
          borderRadius: '8px',
          border: '1px dashed #d1d5db',
          margin: '2rem',
        }}
      >
        <h2 style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>
          Nessun ordine in attesa
        </h2>
        <p>Gli ordini creati appariranno qui prima dell'invio.</p>
      </div>
    );
  }

  return (
    <div style={{ padding: '2rem' }}>
      <div
        style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '1.5rem',
        }}
      >
        <h1 style={{ fontSize: '1.875rem', fontWeight: '700' }}>
          Ordini in Attesa ({orders.length})
        </h1>

        <button
          onClick={handleSubmitOrders}
          disabled={selectedOrderIds.size === 0 || submitting}
          style={{
            padding: '0.75rem 1.5rem',
            backgroundColor:
              selectedOrderIds.size === 0 ? '#d1d5db' : '#22c55e',
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            fontSize: '1rem',
            fontWeight: '600',
            cursor: selectedOrderIds.size === 0 ? 'not-allowed' : 'pointer',
          }}
        >
          {submitting
            ? 'Invio in corso...'
            : `Invia Ordini Selezionati (${selectedOrderIds.size})`}
        </button>
      </div>

      {/* Select All Checkbox */}
      <div
        style={{
          padding: '1rem',
          backgroundColor: '#f9fafb',
          borderRadius: '8px',
          marginBottom: '1rem',
        }}
      >
        <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          <input
            type="checkbox"
            checked={selectedOrderIds.size === orders.length}
            onChange={handleSelectAll}
            style={{ width: '1.25rem', height: '1.25rem', cursor: 'pointer' }}
          />
          <span style={{ fontWeight: '500' }}>Seleziona Tutti</span>
        </label>
      </div>

      {/* Orders List */}
      <div
        style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '1rem',
        }}
      >
        {orders.map((order) => (
          <div
            key={order.id}
            style={{
              border: '1px solid #e5e7eb',
              borderRadius: '8px',
              padding: '1.5rem',
              backgroundColor: 'white',
            }}
          >
            <div
              style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start',
                marginBottom: '1rem',
              }}
            >
              {/* Checkbox + Customer */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                <input
                  type="checkbox"
                  checked={selectedOrderIds.has(order.id!)}
                  onChange={() => handleSelectOrder(order.id!)}
                  style={{ width: '1.25rem', height: '1.25rem', cursor: 'pointer' }}
                />
                <div>
                  <div style={{ fontWeight: '600', fontSize: '1.125rem' }}>
                    {order.customerName}
                  </div>
                  <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>
                    Creato: {new Date(order.createdAt).toLocaleString('it-IT')}
                  </div>
                </div>
              </div>

              {/* Status Badge */}
              <div
                style={{
                  padding: '0.25rem 0.75rem',
                  borderRadius: '9999px',
                  fontSize: '0.875rem',
                  fontWeight: '600',
                  backgroundColor:
                    order.status === 'pending'
                      ? '#fef3c7'
                      : order.status === 'error'
                      ? '#fee2e2'
                      : '#dbeafe',
                  color:
                    order.status === 'pending'
                      ? '#92400e'
                      : order.status === 'error'
                      ? '#991b1b'
                      : '#1e40af',
                }}
              >
                {order.status === 'pending'
                  ? 'In Attesa'
                  : order.status === 'error'
                  ? 'Errore'
                  : 'In Elaborazione'}
              </div>
            </div>

            {/* Items List */}
            <div
              style={{
                backgroundColor: '#f9fafb',
                padding: '1rem',
                borderRadius: '4px',
                marginBottom: '1rem',
              }}
            >
              <div style={{ fontWeight: '600', marginBottom: '0.5rem' }}>
                Articoli ({order.items.length})
              </div>
              {order.items.map((item, index) => (
                <div
                  key={index}
                  style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    padding: '0.5rem 0',
                    borderBottom:
                      index < order.items.length - 1
                        ? '1px solid #e5e7eb'
                        : 'none',
                  }}
                >
                  <div>
                    <div>{item.productName || item.articleCode}</div>
                    <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>
                      Quantità: {item.quantity}
                    </div>
                  </div>
                  <div style={{ fontWeight: '500' }}>
                    €{(item.price * item.quantity).toFixed(2)}
                  </div>
                </div>
              ))}
            </div>

            {/* Error Message (if error status) */}
            {order.status === 'error' && order.errorMessage && (
              <div
                style={{
                  padding: '0.75rem',
                  backgroundColor: '#fee2e2',
                  border: '1px solid #dc2626',
                  borderRadius: '4px',
                  color: '#991b1b',
                  fontSize: '0.875rem',
                }}
              >
                <strong>Errore:</strong> {order.errorMessage}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
```

3. **Run tests**: Ensure component behavior correct

Key features:
- ✅ Multi-select with checkboxes
- ✅ "Select All" functionality
- ✅ Batch submission button
- ✅ Status badges (pending/error/syncing)
- ✅ Error messages displayed
- ✅ Order details shown (customer, items, date)
  </action>
  <verify>
1. `npm test PendingOrdersPage.spec.tsx` passes
2. Empty state renders correctly
3. Orders list displays correctly
4. Multi-select working (individual + select all)
5. Submit button enabled/disabled based on selection
6. Status badges correct colors
  </verify>
  <done>PendingOrdersPage component implemented and tested</done>
</task>

<task type="auto">
  <name>Task 2: Implement offline detection and auto-sync prompt</name>
  <files>archibald-web-app/frontend/src/hooks/useOnlineStatus.ts (new), archibald-web-app/frontend/src/components/OfflineSyncBanner.tsx (new)</files>
  <action>
Build offline detection hook and sync prompt banner:

1. **Create useOnlineStatus hook**: `useOnlineStatus.ts`

```typescript
import { useState, useEffect } from 'react';

export function useOnlineStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  useEffect(() => {
    const handleOnline = () => {
      console.log('[OnlineStatus] Network connected');
      setIsOnline(true);
    };

    const handleOffline = () => {
      console.log('[OnlineStatus] Network disconnected');
      setIsOnline(false);
    };

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
}
```

2. **Create OfflineSyncBanner component**: `OfflineSyncBanner.tsx`

```typescript
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useOnlineStatus } from '../hooks/useOnlineStatus';
import { orderService } from '../services/orders.service';

export function OfflineSyncBanner() {
  const isOnline = useOnlineStatus();
  const navigate = useNavigate();
  const [pendingCount, setPendingCount] = useState(0);
  const [showBanner, setShowBanner] = useState(false);

  // Check for pending orders when coming online
  useEffect(() => {
    if (isOnline) {
      checkPendingOrders();
    }
  }, [isOnline]);

  const checkPendingOrders = async () => {
    try {
      const orders = await orderService.getPendingOrders();
      const pendingOrders = orders.filter((o) => o.status === 'pending');

      if (pendingOrders.length > 0) {
        setPendingCount(pendingOrders.length);
        setShowBanner(true);
      }
    } catch (error) {
      console.error('[OfflineSyncBanner] Failed to check orders:', error);
    }
  };

  const handleNavigateToQueue = () => {
    setShowBanner(false);
    navigate('/pending-orders');
  };

  const handleDismiss = () => {
    setShowBanner(false);
  };

  if (!showBanner || !isOnline) {
    return null;
  }

  return (
    <div
      style={{
        position: 'fixed',
        bottom: '2rem',
        left: '50%',
        transform: 'translateX(-50%)',
        backgroundColor: '#3b82f6',
        color: 'white',
        padding: '1rem 1.5rem',
        borderRadius: '8px',
        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
        zIndex: 1000,
        display: 'flex',
        alignItems: 'center',
        gap: '1rem',
      }}
    >
      <div>
        <div style={{ fontWeight: '600', marginBottom: '0.25rem' }}>
          Sei di nuovo online!
        </div>
        <div style={{ fontSize: '0.875rem' }}>
          Hai {pendingCount} {pendingCount === 1 ? 'ordine' : 'ordini'} da
          inviare. Vuoi inviarli ora?
        </div>
      </div>
      <div style={{ display: 'flex', gap: '0.5rem' }}>
        <button
          onClick={handleNavigateToQueue}
          style={{
            padding: '0.5rem 1rem',
            backgroundColor: 'white',
            color: '#3b82f6',
            border: 'none',
            borderRadius: '4px',
            fontWeight: '600',
            cursor: 'pointer',
          }}
        >
          Vai agli Ordini
        </button>
        <button
          onClick={handleDismiss}
          style={{
            padding: '0.5rem 1rem',
            backgroundColor: 'transparent',
            color: 'white',
            border: '1px solid white',
            borderRadius: '4px',
            cursor: 'pointer',
          }}
        >
          Dopo
        </button>
      </div>
    </div>
  );
}
```

3. **Integrate OfflineSyncBanner in App**:

Add to main App component:
```typescript
import { OfflineSyncBanner } from './components/OfflineSyncBanner';

function App() {
  return (
    <>
      {/* Existing routes */}
      <OfflineSyncBanner />
    </>
  );
}
```

4. **Test offline/online transitions**:
- Test hook with online/offline events
- Test banner appears when coming online with pending orders
- Test navigation to pending orders page
  </action>
  <verify>
1. useOnlineStatus hook works (toggles with network changes)
2. OfflineSyncBanner appears when coming online with pending orders
3. Banner shows correct count of pending orders
4. "Vai agli Ordini" button navigates to /pending-orders
5. "Dopo" button dismisses banner
6. Banner doesn't appear when already online or no pending orders
  </verify>
  <done>Offline detection and sync prompt implemented</done>
</task>

<task type="auto">
  <name>Task 3: Integrate bot submission with backend</name>
  <files>archibald-web-app/backend/src/routes/bot.ts (update or create)</files>
  <action>
Create or update bot API endpoint:

1. **Backend endpoint**: POST /api/bot/submit-orders

```typescript
// bot.ts
import { Router } from 'express';
import type { Request, Response } from 'express';

const router = Router();

router.post('/submit-orders', async (req: Request, res: Response) => {
  try {
    const { orderIds } = req.body;

    if (!Array.isArray(orderIds) || orderIds.length === 0) {
      return res.status(400).json({ error: 'orderIds required' });
    }

    // Queue orders for bot processing
    // Existing bot infrastructure from Phase 9
    const jobId = await queueBotJob({
      type: 'submit-orders',
      orderIds,
    });

    res.json({
      success: true,
      jobId,
      message: `${orderIds.length} orders queued for submission`,
    });
  } catch (error) {
    console.error('[Bot] Submit orders failed:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

export default router;
```

2. **Bot worker processing**:

Existing bot worker (Phase 9) should:
- Fetch pending orders from IndexedDB by IDs
- For each order:
  - Log into Archibald
  - Navigate to order creation
  - Fill form fields (customer, items, quantities, discounts)
  - Submit order
  - On success: Mark order as completed, remove from queue
  - On error: Mark order status as 'error', increment retryCount, save errorMessage

3. **Error handling and retry logic**:

If bot fails:
- Update PendingOrder status to 'error'
- Save error message
- Increment retryCount
- User can retry from PendingOrdersPage

4. **Test integration**:
- Create test pending orders
- Call POST /api/bot/submit-orders
- Verify bot worker processes orders
- Verify status updates in real-time
  </action>
  <verify>
1. POST /api/bot/submit-orders endpoint working
2. Returns jobId for tracking
3. Bot worker processes queued orders
4. Status updates correctly (syncing → completed/error)
5. Error messages saved for failed orders
6. Completed orders removed from queue
  </verify>
  <done>Bot integration complete, orders submitting to Archibald</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pending orders queue with offline support and batch submission</what-built>
  <how-to-verify>
1. **Test Offline Order Creation**:
   a. Go offline (DevTools → Network → Offline)
   b. Create a new order (customer + products)
   c. Click "Crea Ordine"
   d. Verify success message: "Ordine salvato. Verrà inviato quando torni online."
   e. Navigate to /pending-orders
   f. Verify order appears with status "In Attesa"

2. **Test Online Detection**:
   a. With pending orders in queue, go online
   b. Verify banner appears: "Sei di nuovo online! Hai X ordini da inviare."
   c. Click "Vai agli Ordini" → verify navigates to /pending-orders
   d. OR click "Dopo" → verify banner dismisses

3. **Test Multi-Select**:
   a. Create 3+ pending orders (can be online)
   b. Navigate to /pending-orders
   c. Select individual orders with checkboxes
   d. Verify "Invia Ordini Selezionati" button shows count
   e. Test "Seleziona Tutti" checkbox
   f. Verify all orders selected

4. **Test Batch Submission**:
   a. Select 2+ orders
   b. Click "Invia Ordini Selezionati"
   c. Verify orders submitted to bot (check console logs)
   d. Verify status changes to "In Elaborazione"
   e. Wait for bot to process
   f. Verify completed orders removed from queue
   g. If any errors, verify status "Errore" with error message

5. **Test Error Retry**:
   a. If an order fails (error status)
   b. Select that order
   c. Click "Invia Ordini Selezionati" again
   d. Verify retryCount increments
   e. Verify can retry multiple times

**Expected Results:**
- ✅ Offline order creation working
- ✅ Orders saved to pending queue
- ✅ Online detection banner appears
- ✅ Multi-select working correctly
- ✅ Batch submission working
- ✅ Bot processes orders successfully
- ✅ Status updates in real-time
- ✅ Error handling working (retry, error messages)
  </how-to-verify>
  <resume-signal>Type "approved" if offline support working correctly, or describe specific issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PendingOrdersPage implemented with multi-select
- [ ] Offline detection working (useOnlineStatus hook)
- [ ] OfflineSyncBanner appears when coming online
- [ ] Bot integration working (POST /api/bot/submit-orders)
- [ ] Batch submission working
- [ ] Status updates correctly (pending → syncing → completed/error)
- [ ] Error messages displayed and retry working
- [ ] User verified offline workflow end-to-end
</verification>

<success_criteria>
- PendingOrdersPage displays all pending orders clearly
- Multi-select and "Select All" working correctly
- Offline order creation working (no network errors)
- Online detection banner appears automatically
- Batch submission sends orders to bot successfully
- Bot processes orders and creates them in Archibald
- Status tracking accurate in real-time
- Error handling robust (retry, error messages)
- User satisfied with offline-first experience
</success_criteria>

<output>
After completion, create `.planning/phases/28.2-rewrite-orderform-with-proper-architecture/28.2-05-SUMMARY.md`
</output>
