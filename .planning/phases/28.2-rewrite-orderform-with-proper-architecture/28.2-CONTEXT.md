# Phase 28.2 Context: Rewrite OrderForm with Proper Architecture

**Phase**: 28.2 (INSERTED - URGENT)
**Type**: Complete rewrite with comprehensive planning
**Priority**: ðŸ”´ URGENT - Business impact (time/money waste)
**Created**: 2026-01-23
**Status**: Planning phase

## Business Context

**Problem Statement**: OrderForm Ã¨ instabile con bug critici ricorrenti. Tempo e soldi persi su problematiche che indicano un problema architetturale fondamentale piuttosto che bug isolati.

**User Quote**: _"Sto perdendo tempo e soldi su questa problematica ed Ã¨ inaccettabile. Possiamo rinominare orderform e riscriverlo da capo?"_

## Discovered Root Issues

Durante il tentativo di fix di Phase 28.1, sono emersi problemi strutturali:

1. **IndexedDB Vuoto**: Products table completamente vuota (0 records) nonostante sync control panel mostri sync attivi
2. **Sync Disconnection**: Disconnessione tra sync orchestrator e popolazione IndexedDB
3. **Data Flow Unclear**: Flusso dati tra backend DB â†’ IndexedDB â†’ OrderForm non chiaro
4. **Race Conditions**: Customer selection ha race conditions difficili da debuggare
5. **Complex State**: Form ha troppo stato locale senza gestione centralizzata

## Requirements (User-Provided)

### 1. Customer Selection
- **Match Field**: NOME cliente (non ID)
- **UX**: Sistema veloce, preciso, intelligente per selezione rapida
- **Autocomplete**: Filtraggio live mentre l'utente digita
- **Data Source**: Database ufficiale clienti (~1500 records)

### 2. Product Selection
- **Match Field**: NOME ARTICOLO (non ID o codice)
- **UX**: Stesse indicazioni di customer selection - veloce, preciso, intelligente
- **Autocomplete**: Filtraggio live mentre l'utente digita
- **Data Source**: Database ufficiale prodotti (~5000 records con varianti)

### 3. Multi-Article Support
- **Quantity**: Da 1 a N articoli per ordine
- **Add Items**: Utente puÃ² continuare ad aggiungere articoli
- **Review List**: Lista articoli inseriti sempre visibile durante editing

### 4. Quantity & Variants
- **Variant Selection**: Sistema deve selezionare variante corretta basandosi su quantitÃ 
- **Multiples**: Gestire multipli di colli automaticamente
- **Validation**: Prevenire quantitÃ  invalide rispetto ai vincoli variante

### 5. Discount System (Dual)
- **Inline Discount**: Sconto per singolo articolo (percentuale o importo)
- **Global Discount**: Sconto globale su ordine intero
- **Reverse Calculation**: Utente inserisce "totale con IVA desiderato" â†’ sistema calcola sconto globale necessario

### 6. Real-time Summary
Durante inserimento articoli, mostrare:
- **Item List**: NOME ARTICOLO, DESCRIZIONE, prezzo unitario
- **Item Totals**: Totale riga (prezzo Ã— quantitÃ )
- **VAT Display**: IVA per articolo
- **Order Totals**:
  - Totale senza IVA
  - Totale con IVA

### 7. Edit/Delete Items
- **Modify**: PossibilitÃ  di modificare articoli giÃ  inseriti (quantitÃ , sconto)
- **Remove**: Cancellare articoli dalla lista
- **Validation**: Ricalcolare totali dopo ogni modifica

### 8. Pending Orders Queue
- **Queue Page**: Schermata separata che raggruppa ordini da inviare
- **Multi-Select**: Selettore per marcare ordini da inviare
- **Batch Submission**: Pulsante per avviare bot e creare tutti gli ordini selezionati su Archibald

### 9. Offline Support (CRITICAL)
- **Create Offline**: Utente puÃ² creare ordini anche senza connessione
- **Local Queue**: Ordini salvati localmente in "pending" state
- **Auto-Sync**: Quando connessione torna, chiedere se inviare ordini pending
- **Status Tracking**: Utente vede chiaramente quali ordini sono offline vs synced

## Data Architecture

### Official Data Sources
- **Customers DB**: Pagina `/customers` - sempre aggiornata da sync orchestrator
- **Products DB**: Pagina `/products` - sempre aggiornata da sync orchestrator
- **Sync Mechanism**: Automatico tramite orchestrator + sync control panel (Phase 22-25)

### IndexedDB Role
- **Purpose**: Cache locale per offline-first functionality
- **Population**: Deve essere sempre popolato dal sync automatico orchestrator
- **Current Issue**: IndexedDB products table vuota - sync non popola correttamente

### Data Flow (Expected)
```
Archibald ERP
  â†“ (sync orchestrator)
Backend SQLite DBs (customers.db, products.db, prices.db)
  â†“ (API endpoints)
Frontend Cache (IndexedDB)
  â†“ (OrderForm reads)
User creates order
  â†“ (submit)
Pending Orders Queue (IndexedDB)
  â†“ (sync when online)
Bot creates order in Archibald
```

## Performance Requirements

**Scale**:
- ~1500 clienti
- ~5000 prodotti (comprese varianti)

**Target UX**:
- Ricerca autocomplete: < 100ms latency
- Form interactions: Instant feedback
- Summary calculations: Real-time
- Overall experience: "Ottimale, veloce, responsive"

## Technical Constraints

### Must Use
- **React** (existing stack)
- **TypeScript** (existing stack)
- **IndexedDB + Dexie.js** (Phase 8 architecture)
- **Inline styles** (project convention)
- **Existing API endpoints** (customers, products, prices)

### Must Integrate With
- **Sync Orchestrator** (Phase 22)
- **Background Sync** (Phase 24)
- **BrowserPool + Bot** (order submission)
- **PendingOrders** (Phase 8-9 queue system)

### Offline-First Architecture
- PWA with Service Worker (Phase 8)
- IndexedDB for persistent cache (Phase 8)
- Network detection (Phase 8)
- Sync queue pattern (Phase 9)

## User Workflow (Expected)

### Happy Path - Online Order
1. User opens "Nuovo Ordine" page
2. **Customer Selection**:
   - Click/tap customer input
   - Start typing customer name
   - Dropdown shows filtered results instantly
   - Click customer â†’ name populates, dropdown closes
3. **Add First Article**:
   - Click "Aggiungi Articolo" button
   - Article input appears
   - Start typing article name
   - Dropdown shows filtered products
   - Click product â†’ name populates
   - Quantity input appears with constraints (min/max/multiples)
   - Enter quantity (validated against variant rules)
   - Optional: Add discount for this item
   - Click "Aggiungi"
4. **Article Added to List**:
   - Article appears in summary list below
   - Shows: Name, Description, Qty, Unit Price, Line Total, VAT
   - Order totals update (subtotal + total with VAT)
5. **Add More Articles** (optional):
   - Repeat step 3 for each additional article
   - Summary list grows, totals update
6. **Review & Edit** (optional):
   - Click edit icon on article â†’ modify qty/discount
   - Click delete icon â†’ remove article
   - Totals recalculate automatically
7. **Apply Global Discount** (optional):
   - Option A: Enter discount percentage â†’ totals recalculate
   - Option B: Enter "target total with VAT" â†’ system calculates discount needed
8. **Submit Order**:
   - Click "Crea Ordine" button
   - Order saved to Pending Queue
   - Success message shown
   - Form clears for next order

### Happy Path - Offline Order
1. User offline (airplane mode, no network)
2. Follow steps 1-7 from online flow
3. **Submit Order**:
   - Click "Crea Ordine"
   - Order saved to Pending Queue with status "pending_offline"
   - Message: "Ordine salvato. VerrÃ  inviato quando torni online."
4. **User Goes Online**:
   - Network detected
   - Banner/notification: "Hai 3 ordini da inviare. Vuoi inviarli ora?"
   - User confirms â†’ orders sent to bot queue

### Batch Submission Flow
1. User navigates to "Ordini Pending" page
2. Sees list of orders awaiting submission
3. Checkboxes allow multi-select
4. User selects orders to submit (or "Select All")
5. Click "Invia Ordini Selezionati"
6. Bot processes orders in queue
7. Status updates in real-time (processing â†’ completed/error)

## Architecture Principles (To Follow)

### 1. Separation of Concerns
- **Data Layer**: Dedicated services for customers, products, orders
- **State Management**: Centralized (Context or custom hooks)
- **UI Components**: Pure, presentational, reusable
- **Business Logic**: Separate from UI rendering

### 2. Testability
- Pure functions for calculations (discounts, totals, VAT)
- Mockable service layer
- Unit tests for critical paths
- Integration tests for data flow

### 3. Performance
- **Debouncing**: Search inputs debounced (300ms)
- **Virtualization**: Large lists virtualized (if >1000 items)
- **Memoization**: Expensive calculations memoized
- **Lazy Loading**: Components code-split if beneficial

### 4. Error Handling
- **Graceful Degradation**: API failures don't crash app
- **User Feedback**: Clear error messages in Italian
- **Retry Logic**: Automatic retry for transient failures
- **Fallbacks**: Offline fallback always available

### 5. Accessibility
- **Keyboard Navigation**: Tab order logical
- **ARIA Labels**: Screen reader support
- **Focus Management**: Focus trapped in modals
- **Color Contrast**: WCAG AA compliance

## Open Questions (To Answer During Planning)

### Data Layer
1. **IndexedDB Population**: Chi Ã¨ responsabile di popolare IndexedDB? Sync orchestrator, OrderForm, o altro?
2. **Sync Triggers**: Quando viene triggerato il sync? Login, manuale, periodic?
3. **Cache Invalidation**: Come invalidare cache quando dati backend cambiano?
4. **Data Freshness**: Come mostrare all'utente se dati sono stale?

### Product Variants
1. **Variant Selection Logic**: Algoritmo preciso per selezionare variante da quantitÃ 
2. **Multiple Handling**: Come gestire quantitÃ  che non sono multipli esatti?
3. **Edge Cases**: Cosa fare se nessuna variante valida per quantitÃ ?

### Discount Calculation
1. **Reverse Discount Math**: Formula esatta per calcolare sconto da target total
2. **VAT Handling**: Sconto si applica pre-IVA o post-IVA?
3. **Precedence**: Se inline discount + global discount, come interagiscono?

### Offline Behavior
1. **Conflict Resolution**: Se ordine creato offline, dati cambiano online, poi sync â†’ come gestire?
2. **Merge Strategy**: Se utente crea ordini su 2 dispositivi offline, come merge?
3. **Sync Retry**: Strategia retry se sync fallisce (exponential backoff? manual?)

### UI/UX
1. **Form Layout**: Single page scroll, stepper wizard, or modal flow?
2. **Mobile UX**: Touch targets, virtual keyboard, responsive breakpoints?
3. **Validation Timing**: When to validate? onChange, onBlur, onSubmit?

## Next Steps

1. **Codebase Analysis**:
   - Read existing OrderForm.tsx comprehensively
   - Map data flow from API â†’ IndexedDB â†’ Form
   - Identify reusable components
   - Document pain points

2. **Architecture Design**:
   - Propose component tree
   - Define state management approach
   - Design service layer contracts
   - Plan testing strategy

3. **Migration Strategy**:
   - Rename old OrderForm â†’ OrderForm_OLD_BACKUP
   - Build new OrderForm incrementally
   - Feature flag to switch between old/new
   - Gradual rollout plan

4. **Implementation Plan**:
   - Break down into 5-8 executable plans
   - Each plan: 1-3 hours, atomic, testable
   - Checkpoints for user feedback
   - Commit strategy (per-feature commits)

## Success Criteria

### Must Have
- âœ… Customer selection works reliably (no race conditions)
- âœ… Product filtering works (IndexedDB populated correctly)
- âœ… Multi-article support functional
- âœ… Quantity + variant validation working
- âœ… Inline + global discount calculations correct
- âœ… Real-time summary displays correctly
- âœ… Edit/delete items functional
- âœ… Offline order creation works
- âœ… Pending orders queue displays correctly
- âœ… Batch submission to bot works

### Should Have
- âœ… Fast autocomplete (< 100ms perceived latency)
- âœ… Mobile-friendly UI (responsive, touch targets)
- âœ… Error messages clear and helpful
- âœ… Accessibility compliant (keyboard nav, ARIA)
- âœ… Form state persists across refreshes (drafts)

### Nice to Have
- Undo/redo for item edits
- Keyboard shortcuts for power users
- CSV import for bulk orders
- Order templates for recurring orders
- Analytics tracking (form abandonment, completion rate)

## References

**Related Phases**:
- Phase 3: MVP Order Form (original implementation)
- Phase 4: Voice Input Enhancement
- Phase 8: Offline Capability (IndexedDB, drafts, queue)
- Phase 9: Offline Queue (pending orders sync)
- Phase 22: Sync Orchestration
- Phase 24: Background Sync Service

**Key Files** (to analyze):
- `archibald-web-app/frontend/src/components/OrderForm.tsx` (current implementation)
- `archibald-web-app/frontend/src/services/cache-service.ts` (IndexedDB wrapper)
- `archibald-web-app/frontend/src/db/schema.ts` (Dexie schema)
- `archibald-web-app/backend/src/routes/products.ts` (API)
- `archibald-web-app/backend/src/routes/customers.ts` (API)

**Documentation**:
- `.planning/phases/08-offline-capability/` (Offline architecture)
- `.planning/phases/22-sync-orchestration-layer/` (Sync design)
- `.planning/PROJECT.md` (Overall project context)
