---
phase: 17-dashboard-metrics-backend
plan: 02
type: execute
---

<objective>
Create order count metrics API endpoint that provides order counts by time periods.

Purpose: Provide backend API to count agent's orders by various time periods (today, this week, this month, total).
Output: GET /api/metrics/orders endpoint returning order counts with optional date range filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@archibald-web-app/backend/src/metrics-service.ts
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/order-db.ts

**Tech stack available:**
- Express.js REST API
- SQLite with better-sqlite3
- JWT authentication (authenticateJWT middleware)
- TypeScript strict mode

**Established patterns:**
- MetricsService class from Plan 17-01
- JWT authentication via authenticateJWT middleware
- AuthRequest type with userId
- API responses with ApiResponse<T> type

**Existing order data:**
- OrderDatabase stores orders with creationDate (ISO 8601)
- userId foreign key for filtering user's orders
- getOrdersByUserId method available

**Time period definitions:**
- Today: creationDate matches current date (same day)
- This week: creationDate within current week (Monday-Sunday)
- This month: creationDate within current month
- Total: all orders for user
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add order count method to MetricsService</name>
  <files>
    archibald-web-app/backend/src/metrics-service.ts
  </files>
  <action>
    Add calculateOrderCounts method to MetricsService class:

    ```typescript
    /**
     * Calculate order counts by time period for user
     * @returns { today: number, thisWeek: number, thisMonth: number, total: number }
     */
    calculateOrderCounts(userId: string): {
      today: number;
      thisWeek: number;
      thisMonth: number;
      total: number;
    } {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Start of today

      // Calculate start of current week (Monday)
      const currentDay = now.getDay();
      const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // Sunday = 0, Monday = 1
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - daysFromMonday);

      // Calculate start of current month
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

      // Get all user orders
      const allOrders = this.orderDb.getOrdersByUserId(userId);

      // Count orders by time period
      let todayCount = 0;
      let weekCount = 0;
      let monthCount = 0;

      for (const order of allOrders) {
        const orderDate = new Date(order.creationDate);

        if (orderDate >= today) {
          todayCount++;
        }
        if (orderDate >= weekStart) {
          weekCount++;
        }
        if (orderDate >= monthStart) {
          monthCount++;
        }
      }

      return {
        today: todayCount,
        thisWeek: weekCount,
        thisMonth: monthCount,
        total: allOrders.length
      };
    }
    ```

    Why time period logic: Monday-based week aligns with business calendars, start-of-day comparisons avoid timezone issues.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Verify calculateOrderCounts compiles without errors
    2. Check week calculation handles Sunday correctly (0 â†’ 6 days back to Monday)
  </verify>
  <done>
    calculateOrderCounts method added to MetricsService.
    Time period logic implemented (today, this week, this month, total).
    Monday-based week calculation.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET /api/metrics/orders endpoint</name>
  <files>
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Add order count metrics endpoint in index.ts after /api/metrics/budget:

    ```typescript
    // Get order counts by time period - GET /api/metrics/orders
    app.get(
      '/api/metrics/orders',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          const userId = req.userId!;

          const orderCounts = metricsService.calculateOrderCounts(userId);

          logger.info('Order counts calculated', { userId, counts: orderCounts });

          res.json({
            success: true,
            data: orderCounts,
            message: 'Conteggio ordini calcolato con successo'
          });
        } catch (error) {
          logger.error('Errore conteggio ordini', { error, userId: req.userId });

          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore conteggio ordini'
          });
        }
      }
    );
    ```

    Why after budget endpoint: Groups metrics APIs together, consistent REST organization.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Login to get JWT token
    3. Test endpoint: curl -H "Authorization: Bearer TOKEN" http://localhost:3000/api/metrics/orders
    4. Verify response structure: { success, data: { today, thisWeek, thisMonth, total }, message }
    5. Place test order and verify counts increment correctly
  </verify>
  <done>
    GET /api/metrics/orders endpoint added to index.ts.
    JWT authentication required via authenticateJWT middleware.
    Returns order counts for today, this week, this month, and total.
    TypeScript compilation passes.
    Endpoint responds with proper ApiResponse structure.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] calculateOrderCounts method added to MetricsService
- [ ] GET /api/metrics/orders endpoint added to index.ts
- [ ] No TypeScript errors
- [ ] Endpoint returns correct order counts for all time periods
- [ ] Week calculation handles Monday-Sunday correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GET /api/metrics/orders endpoint functional with JWT auth
- Order counts calculated correctly for all time periods
- Week starts on Monday as expected
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-metrics-backend/17-02-SUMMARY.md`:

# Phase 17 Plan 02: Order Count Metrics API Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/metrics-service.ts` - Description
- `archibald-web-app/backend/src/index.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 17-03-PLAN.md (Progress Calculation API)
</output>
