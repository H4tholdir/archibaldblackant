---
phase: 17-dashboard-metrics-backend
plan: 03
type: execute
---

<objective>
Create progress calculation API endpoint that combines budget and target data to calculate progress percentage.

Purpose: Provide backend API to calculate agent's progress toward monthly target with status classification.
Output: GET /api/metrics/progress endpoint returning progress percentage, budget, target, and performance status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@archibald-web-app/backend/src/metrics-service.ts
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/user-db.ts

**Tech stack available:**
- Express.js REST API
- SQLite with better-sqlite3
- JWT authentication (authenticateJWT middleware)
- TypeScript strict mode

**Established patterns:**
- MetricsService class from Plans 17-01, 17-02
- calculateCurrentMonthBudget method (Plan 17-01)
- JWT authentication via authenticateJWT middleware
- ApiResponse<T> type for responses

**User target data (Phase 16-01)**:
- users.monthlyTarget REAL (default 0)
- users.currency TEXT (default 'EUR')
- users.targetUpdatedAt TEXT (ISO 8601)
- Available via UserDatabase.getUserById

**Progress status classification:**
- on_track: progress >= 80%
- at_risk: progress >= 50% and < 80%
- behind: progress < 50%
- no_target: monthlyTarget is 0 (not set)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress calculation method to MetricsService</name>
  <files>
    archibald-web-app/backend/src/metrics-service.ts
  </files>
  <action>
    Add calculateProgress method to MetricsService class:

    ```typescript
    type ProgressStatus = 'on_track' | 'at_risk' | 'behind' | 'no_target';

    /**
     * Calculate progress toward monthly target
     * @returns Progress data with percentage, budget, target, and status
     */
    calculateProgress(userId: string): {
      currentBudget: number;
      targetBudget: number;
      progress: number;
      currency: string;
      status: ProgressStatus;
      month: number;
      year: number;
    } {
      // Get current month budget
      const budgetData = this.calculateCurrentMonthBudget(userId);

      // Get user target
      const user = this.userDb.getUserById(userId);
      if (!user) {
        throw new Error('User not found');
      }

      const targetBudget = user.monthlyTarget || 0;

      // Handle no target set
      if (targetBudget === 0) {
        return {
          currentBudget: budgetData.currentBudget,
          targetBudget: 0,
          progress: 0,
          currency: budgetData.currency,
          status: 'no_target',
          month: budgetData.month,
          year: budgetData.year
        };
      }

      // Calculate progress percentage
      const progressPercent = (budgetData.currentBudget / targetBudget) * 100;

      // Determine status
      let status: ProgressStatus;
      if (progressPercent >= 80) {
        status = 'on_track';
      } else if (progressPercent >= 50) {
        status = 'at_risk';
      } else {
        status = 'behind';
      }

      return {
        currentBudget: budgetData.currentBudget,
        targetBudget,
        progress: Math.round(progressPercent * 100) / 100, // Round to 2 decimals
        currency: budgetData.currency,
        status,
        month: budgetData.month,
        year: budgetData.year
      };
    }
    ```

    Export ProgressStatus type at top of file for use in frontend.

    Why status classification: Matches color-coding thresholds from Phase 15-04 TargetVisualizationWidget (80% green, 50% yellow, <50% red).
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Verify calculateProgress compiles without errors
    2. Check status classification logic matches widget thresholds
    3. Verify no_target status when monthlyTarget is 0
  </verify>
  <done>
    calculateProgress method added to MetricsService.
    Progress percentage calculation implemented.
    Status classification: on_track (>=80%), at_risk (50-79%), behind (<50%), no_target (0).
    Matches Phase 15-04 color thresholds.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET /api/metrics/progress endpoint</name>
  <files>
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Add progress metrics endpoint in index.ts after /api/metrics/orders:

    ```typescript
    // Get progress toward monthly target - GET /api/metrics/progress
    app.get(
      '/api/metrics/progress',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          const userId = req.userId!;

          const progressData = metricsService.calculateProgress(userId);

          logger.info('Progress calculated', {
            userId,
            progress: progressData.progress,
            status: progressData.status
          });

          res.json({
            success: true,
            data: progressData,
            message: 'Progresso calcolato con successo'
          });
        } catch (error) {
          logger.error('Errore calcolo progresso', { error, userId: req.userId });

          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore calcolo progresso'
          });
        }
      }
    );
    ```

    Why after orders endpoint: Groups metrics APIs together (/api/metrics/*), consistent REST organization.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Login to get JWT token
    3. Test endpoint: curl -H "Authorization: Bearer TOKEN" http://localhost:3000/api/metrics/progress
    4. Verify response structure: { success, data: { currentBudget, targetBudget, progress, currency, status, month, year }, message }
    5. Test scenarios:
       - No target set: status = 'no_target'
       - Target set, 90% progress: status = 'on_track'
       - Target set, 60% progress: status = 'at_risk'
       - Target set, 30% progress: status = 'behind'
  </verify>
  <done>
    GET /api/metrics/progress endpoint added to index.ts.
    JWT authentication required via authenticateJWT middleware.
    Returns progress percentage, budget, target, currency, status, month, year.
    TypeScript compilation passes.
    Endpoint responds with proper ApiResponse structure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update UserDatabase schema to support monthlyTarget and currency</name>
  <files>
    archibald-web-app/backend/src/user-db.ts
  </files>
  <action>
    Verify User interface includes monthlyTarget and currency fields. If not present, add to interface and schema migration:

    1. Update User interface (around line 7):
    ```typescript
    export interface User {
      id: string;
      username: string;
      fullName: string;
      role: UserRole;
      whitelisted: boolean;
      createdAt: number;
      lastLoginAt: number | null;
      lastOrderSyncAt?: number | null;
      lastCustomerSyncAt?: number | null;
      monthlyTarget?: number; // EUR/USD/etc monthly target
      currency?: string; // ISO currency code (EUR, USD, GBP)
      targetUpdatedAt?: string; // ISO 8601 timestamp
    }
    ```

    2. Add schema migration in initSchema method (check PRAGMA user_version first):
    ```typescript
    // Check schema version
    const version = this.db.pragma('user_version', { simple: true }) as number;

    if (version < 2) {
      logger.info('Migrating user database schema to version 2');
      this.db.exec(`
        ALTER TABLE users ADD COLUMN monthlyTarget REAL DEFAULT 0;
        ALTER TABLE users ADD COLUMN currency TEXT DEFAULT 'EUR';
        ALTER TABLE users ADD COLUMN targetUpdatedAt TEXT;
        PRAGMA user_version = 2;
      `);
      logger.info('User database schema migrated to version 2');
    }
    ```

    NOTE: This should already be done by Phase 16-01. If schema is already v2, verify fields exist and skip migration.

    Why schema version: Follows established migration pattern from Phase 06-02, ensures backward compatibility.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend and verify schema migration runs (if needed)
    2. Check PRAGMA user_version = 2
    3. Verify monthlyTarget, currency, targetUpdatedAt columns exist in users table
  </verify>
  <done>
    User interface updated with monthlyTarget, currency, targetUpdatedAt fields (or verified existing).
    Schema migration to version 2 (if needed).
    PRAGMA user_version = 2 confirmed.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] calculateProgress method added to MetricsService
- [ ] GET /api/metrics/progress endpoint added to index.ts
- [ ] User interface includes monthlyTarget and currency fields
- [ ] Schema version 2 confirmed (monthlyTarget, currency, targetUpdatedAt columns)
- [ ] No TypeScript errors
- [ ] Endpoint returns correct progress calculation with status
- [ ] Status classification matches Phase 15-04 widget thresholds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GET /api/metrics/progress endpoint functional with JWT auth
- Progress calculation combines budget + target correctly
- Status classification working (on_track, at_risk, behind, no_target)
- User schema supports monthlyTarget and currency fields
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-metrics-backend/17-03-SUMMARY.md`:

# Phase 17 Plan 03: Progress Calculation API Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/metrics-service.ts` - Description
- `archibald-web-app/backend/src/index.ts` - Description
- `archibald-web-app/backend/src/user-db.ts` - Description (if modified)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 17-04-PLAN.md (Dashboard Integration & Checkpoint)
</output>
