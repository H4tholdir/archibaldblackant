---
phase: 17-dashboard-metrics-backend
plan: 01
type: execute
---

<objective>
Create budget calculation API endpoint that aggregates order totals for current month.

Purpose: Provide backend API to calculate agent's current monthly budget from placed orders in OrderDatabase.
Output: GET /api/metrics/budget endpoint returning current month budget sum with proper authentication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/order-db.ts
@archibald-web-app/backend/src/user-db.ts
@archibald-web-app/backend/src/middleware/auth.ts

**Tech stack available:**
- Express.js REST API
- SQLite with better-sqlite3
- JWT authentication (authenticateJWT middleware)
- TypeScript strict mode

**Established patterns:**
- Singleton pattern for database classes (getInstance())
- JWT authentication via authenticateJWT middleware
- AuthRequest type extends Request with userId
- API responses with ApiResponse<T> type
- Error logging with winston logger

**Existing order data:**
- OrderDatabase stores orders with totalAmount (string, e.g., "1.234,56")
- creationDate field (ISO 8601 string)
- userId foreign key for filtering user's orders
- Existing endpoint pattern: `/api/orders/*` with authenticateJWT

**Current month calculation:**
- Use JavaScript Date to get current year/month
- Filter orders where creationDate year/month matches current
- Sum totalAmount values (handle Italian number format: "1.234,56" → 1234.56)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create budget calculation helper function</name>
  <files>
    archibald-web-app/backend/src/metrics-service.ts
  </files>
  <action>
    Create new MetricsService class with budget calculation logic:

    ```typescript
    export class MetricsService {
      private orderDb: OrderDatabase;
      private userDb: UserDatabase;

      constructor() {
        this.orderDb = OrderDatabase.getInstance();
        this.userDb = UserDatabase.getInstance();
      }

      /**
       * Calculate current month budget for user
       * @returns { currentBudget: number, currency: string, month: number, year: number }
       */
      calculateCurrentMonthBudget(userId: string): {
        currentBudget: number;
        currency: string;
        month: number;
        year: number;
      } {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1; // 1-indexed

        // Get all user orders for current month
        const orders = this.orderDb.getOrdersByUserId(userId);
        const currentMonthOrders = orders.filter(order => {
          const orderDate = new Date(order.creationDate);
          return orderDate.getFullYear() === currentYear &&
                 orderDate.getMonth() + 1 === currentMonth;
        });

        // Sum totalAmount values (convert Italian format to number)
        let totalBudget = 0;
        for (const order of currentMonthOrders) {
          if (order.totalAmount) {
            // Convert "1.234,56" to 1234.56
            const cleanAmount = order.totalAmount.replace(/\./g, '').replace(',', '.');
            const numericAmount = parseFloat(cleanAmount);
            if (!isNaN(numericAmount)) {
              totalBudget += numericAmount;
            }
          }
        }

        // Get currency from user target (default EUR)
        const user = this.userDb.getUserById(userId);
        const currency = user?.currency || 'EUR';

        return {
          currentBudget: Math.round(totalBudget * 100) / 100, // Round to 2 decimals
          currency,
          month: currentMonth,
          year: currentYear
        };
      }
    }
    ```

    Why MetricsService: Separates business logic from API routes, reusable for multiple metric endpoints, testable in isolation.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Verify MetricsService compiles without errors
    2. Check Italian number format parsing logic (handles "1.234,56" correctly)
  </verify>
  <done>
    MetricsService.ts created with calculateCurrentMonthBudget method.
    Italian number format parsing implemented ("1.234,56" → 1234.56).
    Currency from user.currency with EUR fallback.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET /api/metrics/budget endpoint</name>
  <files>
    archibald-web-app/backend/src/index.ts
  </files>
  <action>
    Add budget metrics endpoint in index.ts:

    1. Import MetricsService at top:
    ```typescript
    import { MetricsService } from './metrics-service';
    ```

    2. Initialize service singleton after other services:
    ```typescript
    const metricsService = new MetricsService();
    ```

    3. Add endpoint after existing /api/orders/* endpoints (around line 3300):
    ```typescript
    // Get current month budget - GET /api/metrics/budget
    app.get(
      '/api/metrics/budget',
      authenticateJWT,
      async (req: AuthRequest, res: Response<ApiResponse>) => {
        try {
          const userId = req.userId!;

          const budgetData = metricsService.calculateCurrentMonthBudget(userId);

          logger.info('Budget metrics calculated', { userId, budget: budgetData.currentBudget });

          res.json({
            success: true,
            data: budgetData,
            message: 'Budget calcolato con successo'
          });
        } catch (error) {
          logger.error('Errore calcolo budget', { error, userId: req.userId });

          res.status(500).json({
            success: false,
            data: null,
            message: error instanceof Error ? error.message : 'Errore calcolo budget'
          });
        }
      }
    );
    ```

    Why after orders endpoints: Groups related metrics APIs together, consistent with REST API organization pattern.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Login to get JWT token
    3. Test endpoint: curl -H "Authorization: Bearer TOKEN" http://localhost:3000/api/metrics/budget
    4. Verify response structure: { success, data: { currentBudget, currency, month, year }, message }
    5. Verify currentBudget matches sum of current month orders
  </verify>
  <done>
    GET /api/metrics/budget endpoint added to index.ts.
    JWT authentication required via authenticateJWT middleware.
    Returns current month budget with currency, month, year.
    TypeScript compilation passes.
    Endpoint responds with proper ApiResponse structure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add getUserById method to UserDatabase if missing</name>
  <files>
    archibald-web-app/backend/src/user-db.ts
  </files>
  <action>
    Check if getUserById method exists in UserDatabase class. If not present, add it:

    ```typescript
    /**
     * Get user by ID
     */
    getUserById(userId: string): User | null {
      const stmt = this.db.prepare('SELECT * FROM users WHERE id = ?');
      const row = stmt.get(userId) as User | undefined;
      return row || null;
    }
    ```

    Add after existing getUserByUsername method (around line 100).

    Why needed: MetricsService needs to fetch user.currency for budget calculation. If method already exists, skip this task.
  </action>
  <verify>
    npm run typecheck in backend directory passes

    Manual check:
    1. Verify getUserById method exists in UserDatabase
    2. Check method returns User | null type
  </verify>
  <done>
    getUserById method added to UserDatabase (or verified existing).
    Method returns User | null for safe access to currency field.
    TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in backend directory
- [ ] MetricsService.ts created with calculateCurrentMonthBudget method
- [ ] GET /api/metrics/budget endpoint added to index.ts
- [ ] getUserById method exists in UserDatabase
- [ ] No TypeScript errors
- [ ] Endpoint returns correct budget sum for current month orders
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GET /api/metrics/budget endpoint functional with JWT auth
- Budget calculation sums current month orders correctly
- Italian number format handled ("1.234,56" → 1234.56)
- Currency from user.currency or EUR fallback
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-metrics-backend/17-01-SUMMARY.md`:

# Phase 17 Plan 01: Budget Calculation API Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/backend/src/metrics-service.ts` - Description
- `archibald-web-app/backend/src/index.ts` - Description
- `archibald-web-app/backend/src/user-db.ts` - Description (if modified)

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 17-02-PLAN.md (Order Count Metrics API)
</output>
