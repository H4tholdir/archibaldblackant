---
phase: 17-dashboard-metrics-backend
plan: 04
type: execute
---

<objective>
Integrate real metrics API into Dashboard components and verify end-to-end metrics flow.

Purpose: Connect Dashboard frontend widgets to new metrics backend, replacing hardcoded values with real data.
Output: Dashboard displays live budget, order counts, and progress from API with proper loading/error states. Checkpoint confirms complete flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@archibald-web-app/frontend/src/pages/Dashboard.tsx
@archibald-web-app/frontend/src/components/BudgetWidget.tsx
@archibald-web-app/frontend/src/components/OrderCountWidget.tsx
@archibald-web-app/frontend/src/components/TargetVisualizationWidget.tsx

**Tech stack available:**
- React 19 with hooks (useState, useEffect)
- TypeScript strict mode
- JWT token from AuthContext
- Fetch API for HTTP requests

**Established patterns:**
- Inline styles (Phase 10-06 decision)
- Banking app UX patterns (loading states, error handling)
- API calls in useEffect with token from AuthContext
- Toast notifications for errors

**New metrics endpoints (Plans 17-01, 17-02, 17-03):**
- GET /api/metrics/budget → { currentBudget, currency, month, year }
- GET /api/metrics/orders → { today, thisWeek, thisMonth, total }
- GET /api/metrics/progress → { currentBudget, targetBudget, progress, currency, status, month, year }

**Current Dashboard state (Phase 15):**
- Hardcoded values in BudgetWidget (currentBudget: 0, targetBudget from Phase 16)
- OrderCountWidget with placeholder counts
- TargetVisualizationWidget with targetBudget from Phase 16 but currentBudget: 0
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Dashboard to fetch all metrics on mount</name>
  <files>
    archibald-web-app/frontend/src/pages/Dashboard.tsx
  </files>
  <action>
    Update Dashboard.tsx to fetch metrics from all three endpoints:

    1. Add state for metrics data:
    ```typescript
    const [metricsData, setMetricsData] = useState<{
      budget: { currentBudget: number; currency: string; month: number; year: number } | null;
      orders: { today: number; thisWeek: number; thisMonth: number; total: number } | null;
      progress: { currentBudget: number; targetBudget: number; progress: number; currency: string; status: string } | null;
    }>({
      budget: null,
      orders: null,
      progress: null
    });
    const [metricsLoading, setMetricsLoading] = useState(true);
    const [metricsError, setMetricsError] = useState<string | null>(null);
    ```

    2. Add useEffect to fetch all metrics in parallel:
    ```typescript
    useEffect(() => {
      const fetchMetrics = async () => {
        setMetricsLoading(true);
        setMetricsError(null);

        try {
          const token = localStorage.getItem('authToken');
          if (!token) {
            throw new Error('Token non trovato');
          }

          // Fetch all metrics in parallel
          const [budgetRes, ordersRes, progressRes] = await Promise.all([
            fetch('http://localhost:3000/api/metrics/budget', {
              headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('http://localhost:3000/api/metrics/orders', {
              headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('http://localhost:3000/api/metrics/progress', {
              headers: { 'Authorization': `Bearer ${token}` }
            })
          ]);

          if (!budgetRes.ok || !ordersRes.ok || !progressRes.ok) {
            throw new Error('Errore caricamento metriche');
          }

          const [budgetData, ordersData, progressData] = await Promise.all([
            budgetRes.json(),
            ordersRes.json(),
            progressRes.json()
          ]);

          setMetricsData({
            budget: budgetData.data,
            orders: ordersData.data,
            progress: progressData.data
          });
        } catch (error) {
          console.error('Errore fetch metriche:', error);
          setMetricsError(error instanceof Error ? error.message : 'Errore caricamento metriche');
        } finally {
          setMetricsLoading(false);
        }
      };

      fetchMetrics();
    }, []);
    ```

    3. Pass metrics data to widgets (replace hardcoded props):
    ```typescript
    <BudgetWidget
      currentBudget={metricsData.progress?.currentBudget || 0}
      targetBudget={metricsData.progress?.targetBudget || 0}
      currency={metricsData.progress?.currency || 'EUR'}
      loading={metricsLoading}
    />

    <OrderCountWidget
      today={metricsData.orders?.today || 0}
      thisWeek={metricsData.orders?.thisWeek || 0}
      thisMonth={metricsData.orders?.thisMonth || 0}
      total={metricsData.orders?.total || 0}
      loading={metricsLoading}
    />

    <TargetVisualizationWidget
      currentBudget={metricsData.progress?.currentBudget || 0}
      targetBudget={metricsData.progress?.targetBudget || 0}
      currency={metricsData.progress?.currency || 'EUR'}
      loading={metricsLoading}
    />
    ```

    4. Show loading/error states above widgets:
    ```typescript
    {metricsLoading && (
      <div style={{ padding: '20px', textAlign: 'center', color: '#7f8c8d' }}>
        Caricamento metriche...
      </div>
    )}

    {metricsError && (
      <div style={{ padding: '20px', textAlign: 'center', color: '#e74c3c', background: '#fdeaea', borderRadius: '8px' }}>
        ⚠️ {metricsError}
      </div>
    )}
    ```

    Why parallel fetch: Optimizes load time, all metrics load simultaneously (no sequential waterfall).
  </action>
  <verify>
    npm run typecheck in frontend directory passes

    Manual check:
    1. Start dev server: cd archibald-web-app/frontend && npm run dev
    2. Login and navigate to dashboard
    3. Verify loading state appears briefly
    4. Verify all widgets display real metrics data
    5. Check browser console for any fetch errors
  </verify>
  <done>
    Dashboard.tsx updated to fetch metrics from all three endpoints.
    Parallel fetch with Promise.all for optimal performance.
    Loading and error states displayed.
    Widgets receive real metrics data via props.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add loading prop to BudgetWidget</name>
  <files>
    archibald-web-app/frontend/src/components/BudgetWidget.tsx
  </files>
  <action>
    Update BudgetWidget to support loading state:

    1. Add loading prop to interface:
    ```typescript
    interface BudgetWidgetProps {
      currentBudget: number;
      targetBudget: number;
      currency: string;
      loading?: boolean;
    }
    ```

    2. Show loading skeleton when loading:
    ```typescript
    export function BudgetWidget({ currentBudget, targetBudget, currency, loading = false }: BudgetWidgetProps) {
      if (loading) {
        return (
          <div style={{ border: '2px solid #ecf0f1', padding: '20px', borderRadius: '8px', minHeight: '200px' }}>
            <h3 style={{ margin: '0 0 20px 0', color: '#2c3e50' }}>Budget Mensile</h3>
            <div style={{ color: '#95a5a6', textAlign: 'center', padding: '40px 0' }}>
              Caricamento...
            </div>
          </div>
        );
      }

      // ... rest of component
    }
    ```

    Why loading skeleton: Provides visual feedback during API calls, matches banking app UX patterns.
  </action>
  <verify>
    npm run typecheck in frontend directory passes

    Manual check:
    1. Verify loading state renders properly
    2. Check transition from loading to data display is smooth
  </verify>
  <done>
    BudgetWidget supports loading prop.
    Loading skeleton displayed during metrics fetch.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add loading prop to OrderCountWidget and TargetVisualizationWidget</name>
  <files>
    archibald-web-app/frontend/src/components/OrderCountWidget.tsx,
    archibald-web-app/frontend/src/components/TargetVisualizationWidget.tsx
  </files>
  <action>
    Apply same loading pattern to OrderCountWidget and TargetVisualizationWidget:

    For OrderCountWidget:
    ```typescript
    interface OrderCountWidgetProps {
      today: number;
      thisWeek: number;
      thisMonth: number;
      total: number;
      loading?: boolean;
    }

    export function OrderCountWidget({ today, thisWeek, thisMonth, total, loading = false }: OrderCountWidgetProps) {
      if (loading) {
        return (
          <div style={{ border: '2px solid #ecf0f1', padding: '20px', borderRadius: '8px', minHeight: '200px' }}>
            <h3 style={{ margin: '0 0 20px 0', color: '#2c3e50' }}>Ordini</h3>
            <div style={{ color: '#95a5a6', textAlign: 'center', padding: '40px 0' }}>
              Caricamento...
            </div>
          </div>
        );
      }

      // ... rest of component
    }
    ```

    For TargetVisualizationWidget:
    ```typescript
    interface TargetVisualizationWidgetProps {
      currentBudget: number;
      targetBudget: number;
      currency: string;
      loading?: boolean;
    }

    export function TargetVisualizationWidget({ currentBudget, targetBudget, currency, loading = false }: TargetVisualizationWidgetProps) {
      if (loading) {
        return (
          <div style={{ border: '2px solid #ecf0f1', padding: '20px', borderRadius: '8px', minHeight: '300px' }}>
            <h3 style={{ margin: '0 0 20px 0', color: '#2c3e50' }}>Progresso Target</h3>
            <div style={{ color: '#95a5a6', textAlign: 'center', padding: '80px 0' }}>
              Caricamento...
            </div>
          </div>
        );
      }

      // ... rest of component
    }
    ```

    Why consistent pattern: All widgets have same loading UX, reduces cognitive load.
  </action>
  <verify>
    npm run typecheck in frontend directory passes

    Manual check:
    1. Verify all widgets show loading state during fetch
    2. Check loading states disappear when data loads
  </verify>
  <done>
    OrderCountWidget and TargetVisualizationWidget support loading prop.
    Loading skeletons displayed during metrics fetch.
    Consistent loading UX across all widgets.
    TypeScript compilation passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Dashboard metrics backend integration with real-time data</what-built>
  <how-to-verify>
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Start frontend: cd archibald-web-app/frontend && npm run dev
    3. Login to app

    Test complete metrics flow:
    4. Open Dashboard (/)
       - Verify loading state appears briefly for all widgets
       - Verify BudgetWidget shows currentBudget: 0 (no orders yet)
       - Verify OrderCountWidget shows all zeros
       - Verify TargetVisualizationWidget shows 0% progress

    5. Set monthly target:
       - Navigate to Profile (/profile)
       - Set target: 10000 EUR
       - Return to Dashboard
       - Verify BudgetWidget shows Target: €10.000,00
       - Verify TargetVisualizationWidget shows 0% progress with red zone

    6. Create test order:
       - Navigate to Order Form
       - Create order worth €2.500,00
       - Wait for order to complete
       - Return to Dashboard

    7. Verify real-time metrics:
       - BudgetWidget shows Current: €2.500,00, Target: €10.000,00
       - OrderCountWidget shows Today: 1, This Month: 1, Total: 1
       - TargetVisualizationWidget shows 25% progress (red zone, "Serve una spinta!" message)
       - Check browser DevTools Network tab: 3 API calls to /api/metrics/*

    8. Create second order:
       - Create order worth €5.500,00
       - Return to Dashboard
       - Verify BudgetWidget shows Current: €8.000,00 (sum of both orders)
       - Verify OrderCountWidget shows Today: 2, This Month: 2
       - Verify TargetVisualizationWidget shows 80% progress (green zone, "Ottimo lavoro!" message)

    9. Test error handling:
       - Stop backend server
       - Refresh Dashboard
       - Verify error message appears: "⚠️ Errore caricamento metriche"

    10. Test different time periods (if time available):
        - Create order yesterday (modify creationDate in DB)
        - Verify OrderCountWidget: Today: 2, This Week: 3, This Month: 3

    Success criteria:
    - All widgets load with real data from API
    - Loading states appear and disappear correctly
    - Budget calculation sums all orders correctly
    - Order counts match actual order history
    - Progress percentage accurate (currentBudget / targetBudget * 100)
    - Progress status and color match percentage thresholds
    - Error states displayed when backend unreachable
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes in frontend and backend directories
- [ ] Dashboard.tsx fetches metrics from all three endpoints
- [ ] All widgets support loading prop
- [ ] Loading states displayed during API calls
- [ ] Error states displayed on fetch failures
- [ ] No TypeScript errors
- [ ] User verification approved (end-to-end metrics flow works correctly)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Dashboard displays real metrics from backend API
- BudgetWidget shows current month budget sum
- OrderCountWidget shows accurate counts by time period
- TargetVisualizationWidget shows correct progress percentage
- Loading and error states work properly
- End-to-end flow verified by user (set target → create orders → see real-time progress)
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/17-dashboard-metrics-backend/17-04-SUMMARY.md`:

# Phase 17 Plan 04: Dashboard Integration & Checkpoint Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `archibald-web-app/frontend/src/pages/Dashboard.tsx` - Description
- `archibald-web-app/frontend/src/components/BudgetWidget.tsx` - Description
- `archibald-web-app/frontend/src/components/OrderCountWidget.tsx` - Description
- `archibald-web-app/frontend/src/components/TargetVisualizationWidget.tsx` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 17 complete. Ready for Phase 18 (Customers Sync Analysis & Optimization).
</output>
