---
phase: 20-prices-sync-analysis-optimization
plan: 05
title: Price Variations Dashboard & Notifications UI
subsystem: frontend
complexity: medium
estimated_duration: 60min
tags: [react, dashboard, notifications, toast, ui, prezzi-variazioni]
---

# Plan 20-05: Price Variations Dashboard & Notifications UI

## Objective

Create `/prezzi-variazioni` dashboard page showing recent price changes (30 days), implement post-sync toast notifications with red/green badges, add per-article history modal, and integrate with price history API endpoints.

## Execution Context

**User Requirements (from 20-CONTEXT.md):**
- **Badge/Toast after sync:** "15 articoli aumentati üî¥ / 8 articoli diminuiti üü¢" with link to dashboard
- **Dashboard page:** `/prezzi-variazioni` with 30-day price changes table
- **Features:** Sort by % variation, filter (increases/decreases/by group), click ‚Üí full history modal
- **Per-article modal:** Timeline with dates, old/new prices, % variation, CSV export (optional)

**Current State:**
- Dashboard homepage exists (Phase 15)
- No price variations page yet
- Toast system exists for orders
- ProductCard already has price badges (Phase 19.1-02)

**Key Files:**
- Reference: `archibald-web-app/frontend/src/pages/Dashboard.tsx` (Phase 15 pattern)
- Reference: `archibald-web-app/frontend/src/components/ProductCard.tsx` (badge patterns)
- Target: `archibald-web-app/frontend/src/pages/PriceVariationsPage.tsx` (new)
- Target: `archibald-web-app/frontend/src/components/PriceHistoryModal.tsx` (new)
- Target: `archibald-web-app/frontend/src/components/PriceSyncBanner.tsx` (new)

## Context

**Dependencies:**
- Plan 20-04 complete (price history API endpoints ready)
- Phase 15 complete (dashboard layout pattern)

**Design Specifications:**
- Toast: Auto-dismiss after 10s (longer than standard 3s)
- Color coding: üî¥ Red for increases, üü¢ Green for decreases
- Table sortable by percentage change (default: highest increases first)
- Filters: All / Increases Only / Decreases Only / By Product Group
- Modal: Chronological timeline, responsive layout

## Tasks

### Task 1: Create Price Variations Page Component
**Duration:** 25min

Create `archibald-web-app/frontend/src/pages/PriceVariationsPage.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';

interface PriceChange {
  id: number;
  productId: string;
  productName: string;
  variantId: string | null;
  oldPrice: number | null;
  newPrice: number;
  percentageChange: number;
  changeType: 'increase' | 'decrease' | 'new';
  syncDate: number;
}

export default function PriceVariationsPage() {
  const [changes, setChanges] = useState<PriceChange[]>([]);
  const [filteredChanges, setFilteredChanges] = useState<PriceChange[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'increases' | 'decreases'>('all');
  const [sortBy, setSortBy] = useState<'percentage' | 'date'>('percentage');
  const [selectedProduct, setSelectedProduct] = useState<PriceChange | null>(null);
  const navigate = useNavigate();

  useEffect(() => {
    fetchRecentChanges();
  }, []);

  useEffect(() => {
    applyFilters();
  }, [changes, filter, sortBy]);

  const fetchRecentChanges = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch('/api/prices/history/recent/30', {
        headers: { 'Authorization': `Bearer ${token}` },
      });

      const data = await response.json();
      if (data.success) {
        setChanges(data.changes || []);
      }
    } catch (error) {
      console.error('Failed to fetch price changes:', error);
    } finally {
      setLoading(false);
    }
  };

  const applyFilters = () => {
    let filtered = [...changes];

    // Apply change type filter
    if (filter === 'increases') {
      filtered = filtered.filter(c => c.changeType === 'increase');
    } else if (filter === 'decreases') {
      filtered = filtered.filter(c => c.changeType === 'decrease');
    }

    // Apply sorting
    if (sortBy === 'percentage') {
      filtered.sort((a, b) => Math.abs(b.percentageChange) - Math.abs(a.percentageChange));
    } else {
      filtered.sort((a, b) => b.syncDate - a.syncDate);
    }

    setFilteredChanges(filtered);
  };

  const formatDate = (timestamp: number) => {
    return new Date(timestamp * 1000).toLocaleDateString('it-IT');
  };

  const formatPrice = (price: number | null) => {
    return price !== null ? `‚Ç¨${price.toFixed(2)}` : 'N/A';
  };

  const getChangeColor = (changeType: string) => {
    if (changeType === 'increase') return '#c62828'; // Red
    if (changeType === 'decrease') return '#2e7d32'; // Green
    return '#666'; // Gray for new
  };

  const getChangeIcon = (changeType: string) => {
    if (changeType === 'increase') return 'üî¥';
    if (changeType === 'decrease') return 'üü¢';
    return 'üÜï';
  };

  if (loading) {
    return <div style={{ padding: '20px' }}>‚è≥ Caricamento variazioni prezzi...</div>;
  }

  return (
    <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
      <h1>üìä Variazioni Prezzi (Ultimi 30 giorni)</h1>

      {/* Statistics Summary */}
      <div style={{ display: 'flex', gap: '20px', marginTop: '20px' }}>
        <div style={{ padding: '15px', backgroundColor: '#ffebee', borderRadius: '8px' }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#c62828' }}>
            {changes.filter(c => c.changeType === 'increase').length}
          </div>
          <div style={{ fontSize: '14px', color: '#666' }}>Aumenti üî¥</div>
        </div>
        <div style={{ padding: '15px', backgroundColor: '#e8f5e9', borderRadius: '8px' }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#2e7d32' }}>
            {changes.filter(c => c.changeType === 'decrease').length}
          </div>
          <div style={{ fontSize: '14px', color: '#666' }}>Diminuzioni üü¢</div>
        </div>
        <div style={{ padding: '15px', backgroundColor: '#f5f5f5', borderRadius: '8px' }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#666' }}>
            {changes.filter(c => c.changeType === 'new').length}
          </div>
          <div style={{ fontSize: '14px', color: '#666' }}>Nuovi Prezzi üÜï</div>
        </div>
      </div>

      {/* Filters and Sorting */}
      <div style={{ marginTop: '30px', display: 'flex', gap: '15px', alignItems: 'center' }}>
        <label>
          Filtro:
          <select value={filter} onChange={(e) => setFilter(e.target.value as any)} style={{ marginLeft: '10px', padding: '8px' }}>
            <option value="all">Tutti</option>
            <option value="increases">Solo Aumenti üî¥</option>
            <option value="decreases">Solo Diminuzioni üü¢</option>
          </select>
        </label>

        <label>
          Ordina per:
          <select value={sortBy} onChange={(e) => setSortBy(e.target.value as any)} style={{ marginLeft: '10px', padding: '8px' }}>
            <option value="percentage">% Variazione</option>
            <option value="date">Data</option>
          </select>
        </label>
      </div>

      {/* Price Changes Table */}
      <div style={{ marginTop: '20px', overflowX: 'auto' }}>
        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
          <thead>
            <tr style={{ backgroundColor: '#f5f5f5' }}>
              <th style={{ padding: '12px', textAlign: 'left' }}>Articolo</th>
              <th style={{ padding: '12px', textAlign: 'left' }}>Variante</th>
              <th style={{ padding: '12px', textAlign: 'right' }}>Prezzo Vecchio</th>
              <th style={{ padding: '12px', textAlign: 'right' }}>Prezzo Nuovo</th>
              <th style={{ padding: '12px', textAlign: 'right' }}>Variazione %</th>
              <th style={{ padding: '12px', textAlign: 'left' }}>Data</th>
              <th style={{ padding: '12px', textAlign: 'center' }}>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {filteredChanges.map((change) => (
              <tr key={change.id} style={{ borderBottom: '1px solid #ddd' }}>
                <td style={{ padding: '12px' }}>{change.productName}</td>
                <td style={{ padding: '12px' }}>{change.variantId || '-'}</td>
                <td style={{ padding: '12px', textAlign: 'right' }}>{formatPrice(change.oldPrice)}</td>
                <td style={{ padding: '12px', textAlign: 'right' }}>{formatPrice(change.newPrice)}</td>
                <td style={{ padding: '12px', textAlign: 'right', color: getChangeColor(change.changeType), fontWeight: 'bold' }}>
                  {getChangeIcon(change.changeType)} {change.percentageChange.toFixed(2)}%
                </td>
                <td style={{ padding: '12px' }}>{formatDate(change.syncDate)}</td>
                <td style={{ padding: '12px', textAlign: 'center' }}>
                  <button
                    onClick={() => setSelectedProduct(change)}
                    style={{ padding: '5px 10px', cursor: 'pointer' }}
                  >
                    Storico
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {filteredChanges.length === 0 && (
          <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>
            Nessuna variazione trovata
          </div>
        )}
      </div>

      {/* Price History Modal */}
      {selectedProduct && (
        <PriceHistoryModal
          productId={selectedProduct.productId}
          productName={selectedProduct.productName}
          onClose={() => setSelectedProduct(null)}
        />
      )}
    </div>
  );
}

// Placeholder for modal (Task 2)
function PriceHistoryModal({ productId, productName, onClose }: any) {
  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    }} onClick={onClose}>
      <div style={{
        backgroundColor: 'white',
        padding: '20px',
        borderRadius: '8px',
        maxWidth: '600px',
        width: '90%'
      }} onClick={(e) => e.stopPropagation()}>
        <h2>{productName} - Storico Prezzi</h2>
        <p>Product ID: {productId}</p>
        <button onClick={onClose}>Chiudi</button>
      </div>
    </div>
  );
}
```

**Commit:** `feat(20-05): create price variations dashboard page`

---

### Task 2: Create Price History Modal Component
**Duration:** 15min

Create `archibald-web-app/frontend/src/components/PriceHistoryModal.tsx`:

```tsx
import React, { useEffect, useState } from 'react';

interface PriceHistoryRecord {
  id: number;
  oldPrice: number | null;
  newPrice: number;
  percentageChange: number;
  changeType: string;
  syncDate: number;
  source: string;
}

interface Props {
  productId: string;
  productName: string;
  onClose: () => void;
}

export default function PriceHistoryModal({ productId, productName, onClose }: Props) {
  const [history, setHistory] = useState<PriceHistoryRecord[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchHistory();
  }, [productId]);

  const fetchHistory = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/api/prices/history/${productId}`, {
        headers: { 'Authorization': `Bearer ${token}` },
      });

      const data = await response.json();
      if (data.success) {
        setHistory(data.history || []);
      }
    } catch (error) {
      console.error('Failed to fetch price history:', error);
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (timestamp: number) => {
    return new Date(timestamp * 1000).toLocaleDateString('it-IT', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const formatPrice = (price: number | null) => {
    return price !== null ? `‚Ç¨${price.toFixed(2)}` : 'N/A';
  };

  const getChangeColor = (changeType: string) => {
    if (changeType === 'increase') return '#c62828';
    if (changeType === 'decrease') return '#2e7d32';
    return '#666';
  };

  return (
    <div
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0,0,0,0.6)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        padding: '20px'
      }}
      onClick={onClose}
    >
      <div
        style={{
          backgroundColor: 'white',
          borderRadius: '12px',
          maxWidth: '700px',
          width: '100%',
          maxHeight: '80vh',
          overflow: 'auto',
          boxShadow: '0 8px 24px rgba(0,0,0,0.2)'
        }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div style={{ padding: '20px', borderBottom: '1px solid #ddd', position: 'sticky', top: 0, backgroundColor: 'white' }}>
          <h2 style={{ margin: 0 }}>üìà Storico Prezzi</h2>
          <p style={{ margin: '5px 0 0 0', color: '#666' }}>{productName}</p>
        </div>

        {/* Content */}
        <div style={{ padding: '20px' }}>
          {loading ? (
            <div style={{ textAlign: 'center', padding: '40px' }}>‚è≥ Caricamento...</div>
          ) : history.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
              Nessuno storico disponibile
            </div>
          ) : (
            <div style={{ position: 'relative' }}>
              {/* Timeline */}
              <div style={{ borderLeft: '2px solid #ddd', paddingLeft: '20px', marginLeft: '10px' }}>
                {history.map((record, index) => (
                  <div key={record.id} style={{ marginBottom: '20px', position: 'relative' }}>
                    {/* Timeline dot */}
                    <div style={{
                      position: 'absolute',
                      left: '-26px',
                      top: '5px',
                      width: '12px',
                      height: '12px',
                      borderRadius: '50%',
                      backgroundColor: getChangeColor(record.changeType),
                      border: '2px solid white',
                      boxShadow: '0 0 0 2px ' + getChangeColor(record.changeType)
                    }} />

                    {/* Record card */}
                    <div style={{ backgroundColor: '#f9f9f9', padding: '15px', borderRadius: '8px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <div style={{ fontSize: '14px', color: '#666' }}>
                            {formatDate(record.syncDate)} ‚Ä¢ {record.source}
                          </div>
                          <div style={{ marginTop: '8px', display: 'flex', gap: '20px', alignItems: 'center' }}>
                            <div>
                              <div style={{ fontSize: '12px', color: '#999' }}>Vecchio</div>
                              <div style={{ fontSize: '18px', fontWeight: 'bold' }}>{formatPrice(record.oldPrice)}</div>
                            </div>
                            <div style={{ fontSize: '24px', color: '#666' }}>‚Üí</div>
                            <div>
                              <div style={{ fontSize: '12px', color: '#999' }}>Nuovo</div>
                              <div style={{ fontSize: '18px', fontWeight: 'bold' }}>{formatPrice(record.newPrice)}</div>
                            </div>
                          </div>
                        </div>
                        <div style={{
                          fontSize: '20px',
                          fontWeight: 'bold',
                          color: getChangeColor(record.changeType),
                          textAlign: 'right'
                        }}>
                          {record.percentageChange > 0 ? '+' : ''}{record.percentageChange.toFixed(2)}%
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div style={{ padding: '20px', borderTop: '1px solid #ddd', display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
          <button onClick={onClose} style={{ padding: '10px 20px', cursor: 'pointer' }}>
            Chiudi
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Commit:** `feat(20-05): create price history timeline modal`

---

### Task 3: Add Toast Notification After Sync
**Duration:** 15min

Create post-sync toast in `archibald-web-app/frontend/src/components/PriceSyncNotification.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';

interface Props {
  increases: number;
  decreases: number;
  onDismiss: () => void;
}

export default function PriceSyncNotification({ increases, decreases, onDismiss }: Props) {
  const [visible, setVisible] = useState(true);
  const navigate = useNavigate();

  useEffect(() => {
    // Auto-dismiss after 10s (longer than standard toast)
    const timer = setTimeout(() => {
      setVisible(false);
      setTimeout(onDismiss, 300); // Wait for fade-out animation
    }, 10000);

    return () => clearTimeout(timer);
  }, [onDismiss]);

  if (!visible) return null;

  return (
    <div style={{
      position: 'fixed',
      top: '20px',
      right: '20px',
      backgroundColor: 'white',
      padding: '20px',
      borderRadius: '12px',
      boxShadow: '0 8px 24px rgba(0,0,0,0.2)',
      zIndex: 2000,
      minWidth: '300px',
      transition: 'opacity 0.3s',
      opacity: visible ? 1 : 0
    }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
        <h3 style={{ margin: 0, fontSize: '16px' }}>üìä Variazioni Prezzi</h3>
        <button
          onClick={() => setVisible(false)}
          style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', padding: '0' }}
        >
          √ó
        </button>
      </div>

      <div style={{ display: 'flex', gap: '20px', marginTop: '15px' }}>
        <div style={{ flex: 1 }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#c62828' }}>
            {increases} üî¥
          </div>
          <div style={{ fontSize: '12px', color: '#666' }}>Aumenti</div>
        </div>
        <div style={{ flex: 1 }}>
          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#2e7d32' }}>
            {decreases} üü¢
          </div>
          <div style={{ fontSize: '12px', color: '#666' }}>Diminuzioni</div>
        </div>
      </div>

      <button
        onClick={() => navigate('/prezzi-variazioni')}
        style={{
          marginTop: '15px',
          width: '100%',
          padding: '10px',
          backgroundColor: '#1976d2',
          color: 'white',
          border: 'none',
          borderRadius: '6px',
          cursor: 'pointer',
          fontWeight: 'bold'
        }}
      >
        Vedi Dashboard ‚Üí
      </button>
    </div>
  );
}
```

**Commit:** `feat(20-05): add post-sync price variation toast notification`

---

### Task 4: Add Route and Navigation Link
**Duration:** 5min

Update routing and navigation.

**Files:**
1. Add route in `App.tsx`
2. Add nav link in `DashboardNav.tsx`

**Commit:** `feat(20-05): add price variations page to navigation`

---

## Verification

**Manual Test:**
1. Run price sync
2. Toast appears showing increases/decreases counts
3. Click "Vedi Dashboard" ‚Üí redirects to /prezzi-variazioni
4. Table shows recent changes sorted by %
5. Click "Storico" ‚Üí modal opens with full timeline
6. Filters work (increases only, decreases only)
7. Sorting works (by %, by date)

**Next:** Plan 20-06 (Manual Sync UI & Comprehensive Testing)
