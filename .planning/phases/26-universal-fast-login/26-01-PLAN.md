---
phase: 26-universal-fast-login
plan: 26
type: execute
---

<objective>
Optimize Puppeteer login flow for all operations (sync, bot, queries, reconnect) using cached session strategy.

Purpose: Reduce login overhead from 8-10s to <2s for all operations by reusing authenticated browser contexts.
Output: Unified fast login system with session caching, context reuse, and automatic session refresh.
</objective>

<context>
**Current state**: Each operation logs in independently (~8-10s per login).

**Fast login strategy**:
- Session cache already exists (Phase 7: session-manager.ts with cookie persistence)
- Browser pool already exists (browser-pool.ts)
- Extend browser pool to maintain persistent authenticated contexts
- Reuse contexts across operations (sync, order creation, queries)
- Automatic session refresh (detect expired sessions, re-login transparently)

**Files**: backend/src/browser-pool.ts, backend/src/session-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance browser pool with persistent authenticated contexts</name>
  <files>backend/src/browser-pool.ts</files>
  <action>
    Modify BrowserPool:
    - Maintain pool of N authenticated browser contexts (default: 2)
    - On first use: full login (~8s), cache context
    - Subsequent uses: reuse cached context (~0.5s validation check)
    - Session expiry detection: navigate test, check for login page, re-authenticate if needed
    - Context rotation: close stale contexts after 1 hour inactivity
  </action>
  <verify>Context reuse reduces login time to <2s</verify>
  <done>Browser pool with persistent contexts. TypeScript passes.</done>
</task>

<task type="auto">
  <name>Task 2: Update all sync services to use cached contexts</name>
  <files>backend/src/customer-sync-service.ts, product-sync-service.ts, price-sync-service.ts, order-history-service.ts</files>
  <action>
    Replace new Browser() with browserPool.getAuthenticatedContext().
    Remove individual login logic (delegated to pool).
  </action>
  <verify>Sync services use cached contexts</verify>
  <done>Sync services use browser pool. TypeScript passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Universal fast login with context reuse</what-built>
  <how-to-verify>
    1. Start backend, trigger first customer sync
    2. Check logs: first login ~8-10s (expected)
    3. Trigger second sync (any type) within 1 hour
    4. Verify login time <2s (context reused)
    5. Wait 1 hour, trigger sync
    6. Verify new login (context expired, re-authenticated)
    7. Trigger multiple concurrent operations
    8. Verify context pool handles concurrency (N contexts available)
    9. Check performance logs: avg login time <2s for cached operations

    Success: Login time reduced to <2s for subsequent operations, transparent re-authentication on expiry.
  </how-to-verify>
  <resume-signal>Type "approved"</resume-signal>
</task>

</tasks>

<success_criteria>
- Browser pool maintains persistent authenticated contexts
- Login time reduced from 8-10s to <2s (cached)
- Automatic session refresh on expiry
- All services use unified login system
- User verification passed
</success_criteria>

<output>
Create `.planning/phases/26-universal-fast-login/26-01-SUMMARY.md`
</output>
