# Phase 4, Plan 2: Visual Feedback Enhancement

<objective>
Add real-time visual feedback during voice recognition with confidence indicators, live transcript, and entity highlighting.
</objective>

<execution_context>
@archibald-web-app/frontend/src/components/OrderForm.tsx
@archibald-web-app/frontend/src/hooks/useVoiceInput.ts
@archibald-web-app/frontend/src/utils/orderParser.ts
@archibald-web-app/frontend/src/components/OrderForm.css
@~/.claude/get-shit-done/references/tdd.md
@/Users/hatholdir/Downloads/.claude/CLAUDE.md
</execution_context>

<context>
**Current State:**
- Voice modal exists with basic UI (lines 389-447 in OrderForm.tsx)
- Shows listening indicator (pulsing dot)
- Displays raw transcript
- Shows suggestions from `getVoiceSuggestions()`
- Error messages for recognition failures

**Problems:**
- No real-time confidence indicator
- Transcript not highlighted by entity type (customer, article, quantity)
- No visual distinction between interim and final results
- No progress indicator for parsing/validation
- Suggestions not context-aware (same for all input)

**Goal:**
Enhance voice modal with:
1. Real-time confidence meter (0-100%)
2. Entity highlighting in transcript (customer=blue, article=green, quantity=orange)
3. Interim vs final result visual distinction
4. Loading spinner during validation
5. Smarter suggestions based on parsed entities

**Success Criteria:**
- Confidence meter updates in real-time as user speaks
- Recognized entities highlighted with color-coded badges
- Interim results shown in italic/lighter color
- Validation spinner shown while checking database
- Suggestions adapt to what's missing (customer, article, quantity)
- Accessible (ARIA labels, keyboard navigation)
</context>

<tasks>

## Task 1: Design Voice Modal Enhancement

**Objective:** Plan UI/UX improvements without implementation.

**Steps:**
1. Read current voice modal UI (OrderForm.tsx:389-447)
2. Read current CSS styles (find voice-related classes)
3. Sketch enhanced modal structure:
   ```
   [Voice Modal]
   ├── Header (title + close button)
   ├── Body
   │   ├── Listening Indicator (pulse + status)
   │   ├── Confidence Meter (0-100% bar with color coding)
   │   ├── Live Transcript
   │   │   ├── Recognized Entities (highlighted badges)
   │   │   └── Interim Text (italic, lighter)
   │   ├── Validation Status (spinner or checkmark)
   │   ├── Smart Suggestions (context-aware)
   │   └── Example (usage help)
   └── Footer (controls + apply/cancel)
   ```
4. Define color scheme:
   - Customer: Blue (#2196F3)
   - Article: Green (#4CAF50)
   - Quantity: Orange (#FF9800)
   - Confidence: Red → Yellow → Green gradient
5. Document accessibility requirements:
   - ARIA live region for transcript
   - ARIA progressbar for confidence meter
   - Keyboard shortcuts (Esc=cancel, Enter=apply)

**Verification:**
Review design with user (optional) or proceed with implementation.

---

## Task 2: Create Confidence Meter Component

**Objective:** Build reusable confidence meter with color-coded progress bar.

**Steps:**
1. Create `ConfidenceMeter.tsx` in `frontend/src/components/`
2. Props:
   - `confidence: number` (0-1)
   - `label?: string` (e.g., "Overall Confidence")
   - `showPercentage?: boolean` (default: true)
3. Implementation:
   - Progress bar with color gradient:
     - 0-0.4: Red (#F44336)
     - 0.4-0.7: Yellow (#FFC107)
     - 0.7-1.0: Green (#4CAF50)
   - ARIA attributes:
     - `role="progressbar"`
     - `aria-valuenow={Math.round(confidence * 100)}`
     - `aria-valuemin="0"`
     - `aria-valuemax="100"`
     - `aria-label={label}`
4. Write unit tests:
   - Renders with correct percentage
   - Color changes based on confidence threshold
   - ARIA attributes present
5. Style with CSS module or inline styles

**Verification:**
```bash
cd archibald-web-app/frontend && npm test ConfidenceMeter.spec.tsx
```

---

## Task 3: Create Entity Badge Component

**Objective:** Build component to highlight recognized entities in transcript.

**Steps:**
1. Create `EntityBadge.tsx` in `frontend/src/components/`
2. Props:
   - `type: 'customer' | 'article' | 'quantity' | 'price'`
   - `value: string`
   - `confidence?: number`
   - `onClick?: () => void` (for edit functionality)
3. Implementation:
   - Colored badge based on entity type
   - Confidence indicator (icon or opacity)
   - Tooltip showing confidence score on hover
   - ARIA label: `aria-label="{type}: {value} (confidence: {confidence}%)"`
4. Write unit tests:
   - Renders with correct color for each entity type
   - Confidence affects visual presentation
   - Click handler triggered
5. Style badges:
   - Pill shape with rounded corners
   - Semi-transparent background
   - Bold text
   - Small confidence icon

**Verification:**
```bash
cd archibald-web-app/frontend && npm test EntityBadge.spec.tsx
```

---

## Task 4: Create Transcript Highlighter

**Objective:** Parse transcript and highlight recognized entities with badges.

**Steps:**
1. Create `highlightEntities()` utility in `orderParser.ts`
2. Input: transcript string, parsed entities with positions
3. Logic:
   - Split transcript into segments
   - Identify entity positions in original text
   - Return array of segments with entity metadata:
     ```typescript
     type TranscriptSegment = {
       text: string;
       entity?: {
         type: 'customer' | 'article' | 'quantity' | 'price';
         confidence: number;
       };
     };
     ```
4. Create `TranscriptDisplay.tsx` component:
   - Props: `transcript: string`, `parsedOrder: ParsedOrderWithConfidence`
   - Renders segments with `EntityBadge` for recognized entities
   - Interim results in lighter color
   - ARIA live region for accessibility
5. Write unit tests:
   - Entities highlighted correctly
   - Non-entity text rendered as plain
   - Interim vs final styling applied

**Verification:**
```bash
cd archibald-web-app/frontend && npm test highlightEntities.spec.ts
cd archibald-web-app/frontend && npm test TranscriptDisplay.spec.tsx
```

---

## Task 5: Add Validation Status Indicator

**Objective:** Show loading/success/error states during entity validation.

**Steps:**
1. Create `ValidationStatus.tsx` component
2. Props:
   - `status: 'idle' | 'validating' | 'success' | 'error'`
   - `message?: string`
   - `errors?: string[]`
   - `suggestions?: string[]`
3. Implementation:
   - **Idle**: No indicator
   - **Validating**: Spinner with "Validating..." text
   - **Success**: Green checkmark with "Valid" text
   - **Error**: Red X with error message and suggestions
4. Style with smooth transitions between states
5. ARIA live region for status changes
6. Write unit tests for all states

**Verification:**
```bash
cd archibald-web-app/frontend && npm test ValidationStatus.spec.tsx
```

---

## Task 6: Create Smart Suggestions Component

**Objective:** Context-aware suggestions based on what's missing or invalid.

**Steps:**
1. Enhance `getVoiceSuggestions()` in `orderParser.ts`:
   - Input: transcript, parsed entities, validation results
   - Logic:
     - If no customer → "Say 'cliente [name]'"
     - If invalid customer → "Did you mean: [suggestions]?"
     - If no article → "Say 'articolo [code] quantità [number]'"
     - If invalid article → "Did you mean: [suggestions]?"
     - If quantity missing → "Add 'quantità [number]'"
     - If confidence low → "Speak more clearly: [problem area]"
   - Output: array of actionable suggestions
2. Create `SmartSuggestions.tsx` component:
   - Props: `suggestions: string[]`, `priority: 'high' | 'medium' | 'low'`
   - High priority: Red border, exclamation icon
   - Medium priority: Yellow border, info icon
   - Low priority: Gray border, lightbulb icon
3. Write unit tests for enhanced suggestion logic
4. Write component tests

**Verification:**
```bash
cd archibald-web-app/frontend && npm test orderParser.spec.ts
cd archibald-web-app/frontend && npm test SmartSuggestions.spec.tsx
```

---

## Task 7: Integrate Components into Voice Modal

**Objective:** Update OrderForm voice modal with all new components.

**Steps:**
1. Read current modal implementation (OrderForm.tsx:389-447)
2. Update `handleVoiceStart()` to initialize validation state
3. Add real-time parsing in `useVoiceInput` onResult callback:
   - Parse transcript immediately
   - Calculate confidence
   - Trigger validation (debounced)
4. Update modal JSX:
   - Replace raw transcript with `<TranscriptDisplay />`
   - Add `<ConfidenceMeter />` below listening indicator
   - Add `<ValidationStatus />` for validation feedback
   - Replace static suggestions with `<SmartSuggestions />`
5. Add loading state while validation runs
6. Update CSS for new components
7. Ensure keyboard navigation works (Tab, Esc, Enter)

**Verification:**
Manual testing:
1. Start voice input → confidence meter appears
2. Say "cliente Mario Rossi" → "cliente" and "Mario Rossi" highlighted in blue
3. Say "articolo SF1000" → "articolo" and "SF1000" highlighted in green
4. Say invalid customer → validation error with suggestions
5. Press Esc → modal closes
6. Press Enter (when valid) → input applied

---

## Task 8: Write Integration Tests

**Objective:** Verify complete voice modal behavior with visual feedback.

**Steps:**
1. Update `OrderForm.voice.spec.tsx` with new test cases:
   - Confidence meter updates as transcript changes
   - Entities highlighted correctly in transcript
   - Validation status shown during async validation
   - Suggestions adapt to parsed entities
   - Loading state shown while validating
   - Error state shown for invalid entities
2. Mock API responses for customer/product validation
3. Use React Testing Library for interaction testing:
   - Fire recognition events
   - Assert visual feedback appears
   - Assert ARIA attributes correct
4. Run full test suite

**Verification:**
```bash
cd archibald-web-app/frontend && npm test OrderForm.voice.spec.tsx
cd archibald-web-app/frontend && npm test
```

---

## Task 9: Accessibility Audit and Refinement

**Objective:** Ensure voice modal is fully accessible.

**Steps:**
1. Run automated accessibility checks:
   ```bash
   # Install axe-core if not present
   cd archibald-web-app/frontend && npm install --save-dev @axe-core/react
   ```
2. Add axe audit to tests
3. Manual accessibility checklist:
   - [ ] All interactive elements keyboard accessible
   - [ ] Focus trap within modal
   - [ ] ARIA live regions announce status changes
   - [ ] Color not sole indicator (icons + text)
   - [ ] Sufficient color contrast (WCAG AA)
   - [ ] Screen reader friendly labels
4. Fix any accessibility issues found
5. Document keyboard shortcuts in modal

**Verification:**
- Axe audit passes with 0 violations
- Manual keyboard navigation works
- Screen reader announces changes correctly

---

## Task 10: Code Quality and Documentation

**Objective:** Final code review and documentation.

**Steps:**
1. Run prettier and linting:
   ```bash
   cd archibald-web-app/frontend
   npm run format
   npm run lint
   npm run typecheck
   ```
2. Self-review using QCHECK from CLAUDE.md:
   - Functions follow best practices
   - Tests cover edge cases
   - No unnecessary complexity
3. Add JSDoc comments to new components
4. Update component documentation with usage examples
5. Run full test suite one final time

**Verification:**
```bash
cd archibald-web-app/frontend && npm test
```
Expected: All tests pass, no linting errors

</tasks>

<verification>

## Unit Tests
```bash
cd archibald-web-app/frontend
npm test ConfidenceMeter.spec.tsx
npm test EntityBadge.spec.tsx
npm test TranscriptDisplay.spec.tsx
npm test ValidationStatus.spec.tsx
npm test SmartSuggestions.spec.tsx
```

## Integration Tests
```bash
npm test OrderForm.voice.spec.tsx
```

## Accessibility
```bash
npm test -- --coverage
# Check axe violations = 0
```

## Manual Verification
1. Start voice input → confidence meter appears and updates in real-time
2. Say "cliente Mario Rossi" → customer name highlighted in blue badge
3. Say "articolo SF1000 quantità 5" → all entities highlighted with correct colors
4. Say invalid customer → validation error shown with suggestions
5. Keyboard navigation: Tab through elements, Esc closes, Enter applies
6. Screen reader: Announces status changes via ARIA live regions

</verification>

<success_criteria>
- [ ] ConfidenceMeter component with color-coded progress bar (red → yellow → green)
- [ ] EntityBadge component for highlighting recognized entities
- [ ] TranscriptDisplay component with entity highlighting and interim styling
- [ ] ValidationStatus component showing loading/success/error states
- [ ] SmartSuggestions component with context-aware, actionable suggestions
- [ ] Voice modal updated with all new components
- [ ] Real-time confidence updates as user speaks
- [ ] Entity highlighting works correctly (customer=blue, article=green, quantity=orange)
- [ ] Validation feedback shown during async validation
- [ ] Keyboard navigation fully functional (Tab, Esc, Enter)
- [ ] ARIA attributes present and correct
- [ ] Accessibility audit passes (0 axe violations)
- [ ] All unit and integration tests pass
- [ ] No linting errors, code follows CLAUDE.md best practices
</success_criteria>

<output>
**Files Created:**
- `frontend/src/components/ConfidenceMeter.tsx` - Confidence progress bar
- `frontend/src/components/ConfidenceMeter.spec.tsx` - Unit tests
- `frontend/src/components/EntityBadge.tsx` - Entity highlighting badge
- `frontend/src/components/EntityBadge.spec.tsx` - Unit tests
- `frontend/src/components/TranscriptDisplay.tsx` - Transcript with entity highlighting
- `frontend/src/components/TranscriptDisplay.spec.tsx` - Unit tests
- `frontend/src/components/ValidationStatus.tsx` - Validation state indicator
- `frontend/src/components/ValidationStatus.spec.tsx` - Unit tests
- `frontend/src/components/SmartSuggestions.tsx` - Context-aware suggestions
- `frontend/src/components/SmartSuggestions.spec.tsx` - Unit tests

**Files Modified:**
- `frontend/src/components/OrderForm.tsx` - Enhanced voice modal with new components
- `frontend/src/utils/orderParser.ts` - Added `highlightEntities()` and enhanced `getVoiceSuggestions()`
- `frontend/src/components/OrderForm.voice.spec.tsx` - Extended integration tests
- `frontend/src/components/OrderForm.css` - New styles for voice components

**Commits:**
1. `feat(voice): add ConfidenceMeter component with color-coded progress`
2. `feat(voice): add EntityBadge component for entity highlighting`
3. `feat(voice): add TranscriptDisplay with entity highlighting`
4. `feat(voice): add ValidationStatus component for async feedback`
5. `feat(voice): add SmartSuggestions with context-aware recommendations`
6. `feat(voice): integrate visual feedback components into voice modal`
7. `test(voice): add integration tests for enhanced voice modal`
8. `a11y(voice): ensure voice modal fully accessible with ARIA`

**Next Steps:**
Execute Plan 04-03 to implement form field population from voice input (pre-fill, not submit).
</output>
