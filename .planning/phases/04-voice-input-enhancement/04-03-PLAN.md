# Phase 4, Plan 3: Form Field Population + Manual Edit + Tap Confirmation

<objective>
Implement voice hybrid workflow: dettatura ‚Üí form pre-fill ‚Üí manual edit ‚Üí tap confirmation. Combines Plans 04-03, 04-04, and 04-05 into single cohesive implementation.
</objective>

<execution_context>
@archibald-web-app/frontend/src/components/OrderForm.tsx
@archibald-web-app/frontend/src/utils/orderParser.ts
@archibald-web-app/frontend/src/hooks/useVoiceInput.ts
@~/.claude/get-shit-done/references/tdd.md
@/Users/hatholdir/Downloads/.claude/CLAUDE.md
</execution_context>

<context>
**Current State:**
- Voice modal with enhanced visual feedback (Plan 04-02)
- Enhanced parser with confidence scoring (Plan 04-01)
- `handleVoiceApply()` directly populates form and closes modal
- No review step before applying voice input
- No way to edit voice-populated fields before submission

**Problems:**
- Voice input immediately applied without user review
- Risk of incorrect recognition being submitted
- No way to correct mistakes from voice input
- Defeats purpose of "hybrid" workflow (voice + manual confirmation)

**Goal:**
Implement true hybrid workflow:
1. **Dettatura**: User speaks order details (e.g., "H71 104 032 quantit√† 7")
2. **Package Disambiguation** (if needed): User chooses between 7√ó1pz or 1√ó5pz+2√ó1pz
3. **Form Pre-Fill**: Parsed entities populate form fields (NOT submitted)
4. **Manual Edit**: User can review and edit populated fields
5. **Tap Confirmation**: User explicitly confirms order creation

**Critical Workflow Notes:**
- **Article codes**: Parser handles "H71 104 032" (no "punto") ‚Üí normalizes to "H71.104.032"
- **Mixed-package scenarios**: When qty=7 with 5-pack+1-pack available:
  - Show disambiguation modal: "üì¶ 3 confezioni (1√ó5pz + 2√ó1pz) ‚úì Raccomandato" vs "üì¶ 7 confezioni (7√ó1pz)"
  - User selects preferred breakdown
  - Selected solution applied to form

**Success Criteria:**
- Voice input populates form fields without closing modal
- Package disambiguation modal shown when multiple solutions exist
- User can select packaging breakdown (optimal solution recommended)
- User can edit any voice-populated field
- Visual indicator shows which fields were voice-populated
- Explicit "Confirm Order" button required before submission
- User can clear voice input and start over
- All existing form validation still applies
</context>

<tasks>

## Task 1: Refactor Voice Apply Logic

**Objective:** Change voice input from direct submission to form pre-fill.

**Steps:**
1. Read current `handleVoiceApply()` in OrderForm.tsx (line ~328)
2. Current behavior:
   ```typescript
   const handleVoiceApply = () => {
     const parsed = parseVoiceOrder(transcript);
     // ... directly applies to form
     setShowVoiceModal(false); // Closes modal immediately
   };
   ```
3. New behavior:
   ```typescript
   const handleVoiceApply = () => {
     const parsed = parseVoiceOrderWithConfidence(transcript);

     // Pre-fill customer field
     if (parsed.customerName && parsed.customerNameConfidence > 0.5) {
       setCustomerSearch(parsed.customerName);
       // Trigger autocomplete search
     }

     // Pre-fill article fields
     if (parsed.items.length > 0) {
       const item = parsed.items[0]; // Start with first item

       // Check if package disambiguation needed
       if (item.needsDisambiguation && item.packageSolutions) {
         // Show disambiguation modal FIRST
         setDisambiguationItem(item);
         setShowDisambiguationModal(true);
         // Don't pre-fill form yet - wait for user selection
         return;
       }

       // No disambiguation needed - proceed with pre-fill
       if (item.articleCodeConfidence > 0.5) {
         setProductSearch(item.articleCode);
         // Trigger product autocomplete search
       }
       if (item.quantity) {
         setNewItem(prev => ({ ...prev, quantity: item.quantity }));
       }
     }

     // Mark fields as voice-populated (for visual indicator)
     setVoicePopulatedFields({
       customer: parsed.customerNameConfidence > 0.5,
       article: parsed.items[0]?.articleCodeConfidence > 0.5,
       quantity: !!parsed.items[0]?.quantity,
     });

     // KEEP MODAL OPEN for user review
     // User closes modal manually when satisfied
   };
   ```
4. Add new state for tracking voice-populated fields and disambiguation:
   ```typescript
   const [voicePopulatedFields, setVoicePopulatedFields] = useState<{
     customer: boolean;
     article: boolean;
     quantity: boolean;
   }>({ customer: false, article: false, quantity: false });

   const [showDisambiguationModal, setShowDisambiguationModal] = useState(false);
   const [disambiguationItem, setDisambiguationItem] = useState<ParsedOrderItem | null>(null);
   ```
5. Implement `handlePackageSelection()` callback:
   ```typescript
   const handlePackageSelection = (solution: PackageSolution) => {
     if (!disambiguationItem) return;

     // Apply selected solution to form
     // For now, just use the first variant from breakdown (mixed-package support in future)
     const mainVariant = solution.breakdown[0];
     setProductSearch(disambiguationItem.articleCode);
     setNewItem(prev => ({
       ...prev,
       quantity: disambiguationItem.quantity,
       // Store selected solution for backend
       _selectedPackageSolution: solution
     }));

     // Mark as voice-populated
     setVoicePopulatedFields({
       article: true,
       quantity: true,
     });

     // Close disambiguation modal
     setShowDisambiguationModal(false);
     setDisambiguationItem(null);
   };
   ```
5. Write unit tests for new `handleVoiceApply()` behavior

**Verification:**
- Voice input no longer closes modal automatically
- Form fields populated based on confidence threshold (> 0.5)
- Voice-populated fields tracked in state

---

## Task 2: Add Visual Indicators for Voice-Populated Fields

**Objective:** Show users which fields were populated by voice input.

**Steps:**
1. Create `VoicePopulatedBadge.tsx` component:
   - Props: `confidence?: number`
   - Visual: Small microphone icon + confidence percentage
   - Color: Blue for high confidence (>0.7), Yellow for medium (0.5-0.7)
   - Tooltip: "Populated by voice input ({confidence}% confidence)"
2. Add badge to form fields:
   - Customer search input ‚Üí show badge if `voicePopulatedFields.customer`
   - Article search input ‚Üí show badge if `voicePopulatedFields.article`
   - Quantity input ‚Üí show badge if `voicePopulatedFields.quantity`
3. Position badge:
   - Right side of input field
   - Inline with input text
   - Does not interfere with typing
4. Clear badge when user manually edits field:
   ```typescript
   const handleCustomerSearchChange = (value: string) => {
     setCustomerSearch(value);
     // Clear voice-populated indicator on manual edit
     setVoicePopulatedFields(prev => ({ ...prev, customer: false }));
   };
   ```
5. Write component tests

**Verification:**
```bash
cd archibald-web-app/frontend && npm test VoicePopulatedBadge.spec.tsx
```
Manual: Voice-populated fields show microphone badge, badge clears on edit

---

## Task 3: Add "Review Voice Input" Mode

**Objective:** Add workflow step between voice input and form population.

**Steps:**
1. Add "Review & Apply" button to voice modal:
   - Shown after user stops speaking
   - Only enabled if confidence > 0.5 for at least one entity
   - Shows summary: "‚úì Customer: Mario Rossi (95%) | ‚úì Article: SF1000 (88%) | ‚úì Quantity: 5"
2. Add "Clear & Retry" button:
   - Clears transcript
   - Resets parsing
   - Keeps modal open
   - Allows user to speak again
3. Update modal footer:
   ```tsx
   <div className="voice-modal-footer">
     {transcript && (
       <>
         <button onClick={handleVoiceClear}>
           üîÑ Clear & Retry
         </button>
         <button
           onClick={handleVoiceApply}
           disabled={!hasHighConfidenceEntity}
         >
           ‚úì Review & Apply
         </button>
       </>
     )}
     <button onClick={handleVoiceCancel}>
       Cancel
     </button>
   </div>
   ```
4. Implement `handleVoiceClear()`:
   ```typescript
   const handleVoiceClear = () => {
     resetTranscript();
     setVoiceSuggestions(getVoiceSuggestions(""));
     // Keep modal open
   };
   ```

**Verification:**
- "Review & Apply" button only enabled for confident entities
- "Clear & Retry" clears transcript and allows re-recording
- Summary shows recognized entities with confidence

---

## Task 4: Implement Manual Edit Capability

**Objective:** Allow users to edit voice-populated fields freely.

**Steps:**
1. Ensure all voice-populated fields remain fully editable:
   - Customer search: Can type to search manually
   - Article search: Can type to search manually
   - Quantity: Can adjust number
   - Discount: Can add/edit manually
2. Add "Edit" buttons next to voice-populated badges:
   ```tsx
   {voicePopulatedFields.customer && (
     <div className="voice-badge-container">
       <VoicePopulatedBadge confidence={customerConfidence} />
       <button
         onClick={() => handleEditField('customer')}
         aria-label="Edit customer"
       >
         ‚úèÔ∏è
       </button>
     </div>
   )}
   ```
3. Implement `handleEditField()`:
   - Focuses the input
   - Clears voice-populated indicator
   - Optionally clears the field value (ask user)
4. Test keyboard navigation:
   - Tab through fields works
   - Voice-populated fields can be focused and edited
   - No accessibility barriers

**Verification:**
- All voice-populated fields can be edited
- Edit button focuses field and clears indicator
- Keyboard navigation works smoothly

---

## Task 5: Add Tap Confirmation Requirement

**Objective:** Require explicit user confirmation before order submission.

**Steps:**
1. Read current order submission flow in OrderForm.tsx
2. Current: "Add Item" button adds item to order immediately
3. New workflow:
   - "Add Item" ‚Üí adds to **draft items list** (not submitted)
   - Draft items shown in review section
   - "Create Order" button ‚Üí final confirmation modal
   - Confirmation modal shows:
     - Customer name
     - All items with quantities and prices
     - Total amount (if prices available)
     - "Confirm & Submit" button
4. Implement draft items state:
   ```typescript
   const [draftItems, setDraftItems] = useState<OrderItem[]>([]);
   const [showConfirmModal, setShowConfirmModal] = useState(false);
   ```
5. Update "Add Item" handler:
   ```typescript
   const handleAddItem = () => {
     // Validate package constraints (existing logic)
     // ...

     // Add to draft instead of direct submission
     setDraftItems(prev => [...prev, { ...newItem }]);

     // Clear form for next item
     setNewItem({ articleCode: "", productName: "", quantity: 1, ... });
     setProductSearch("");
     setPackageConstraints(null);

     // Clear voice indicators
     setVoicePopulatedFields({ customer: false, article: false, quantity: false });
   };
   ```
6. Add draft items review section:
   ```tsx
   {draftItems.length > 0 && (
     <div className="draft-items-section">
       <h3>Items to Order ({draftItems.length})</h3>
       {draftItems.map((item, index) => (
         <div key={index} className="draft-item">
           <span>{item.productName} - Qty: {item.quantity}</span>
           <button onClick={() => handleRemoveDraftItem(index)}>
             Remove
           </button>
         </div>
       ))}
       <button
         onClick={() => setShowConfirmModal(true)}
         className="create-order-button"
       >
         Create Order ({draftItems.length} items)
       </button>
     </div>
   )}
   ```
7. Implement confirmation modal:
   ```tsx
   {showConfirmModal && (
     <div className="confirm-modal-overlay">
       <div className="confirm-modal">
         <h2>Confirm Order</h2>
         <div className="order-summary">
           <p><strong>Customer:</strong> {customerName}</p>
           <h3>Items:</h3>
           {draftItems.map((item, i) => (
             <div key={i}>
               {item.productName} - Qty: {item.quantity}
             </div>
           ))}
         </div>
         <div className="confirm-modal-footer">
           <button onClick={() => setShowConfirmModal(false)}>
             Cancel
           </button>
           <button onClick={handleConfirmOrder}>
             ‚úì Confirm & Submit
           </button>
         </div>
       </div>
     </div>
   )}
   ```
8. Implement `handleConfirmOrder()`:
   ```typescript
   const handleConfirmOrder = async () => {
     setLoading(true);
     try {
       // Submit order with draft items
       const response = await fetch('/api/orders', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
           customerId,
           items: draftItems,
         }),
       });

       const data = await response.json();

       if (data.success) {
         onOrderCreated(data.jobId);
         // Clear draft items
         setDraftItems([]);
         setShowConfirmModal(false);
       } else {
         alert(`Error: ${data.error}`);
       }
     } catch (err) {
       alert('Failed to create order');
     } finally {
       setLoading(false);
     }
   };
   ```

**Verification:**
- Items added to draft list, not submitted immediately
- Draft items can be reviewed and removed
- Confirmation modal shows order summary
- Order only submitted after explicit confirmation

---

## Task 6: Add Multi-Item Voice Input Support

**Objective:** Support adding multiple items from single voice input.

**Steps:**
1. Enhance `handleVoiceApply()` to handle multiple items:
   ```typescript
   const handleVoiceApply = () => {
     const parsed = parseVoiceOrderWithConfidence(transcript);

     // Pre-fill customer (same as before)
     // ...

     // Handle multiple items
     if (parsed.items.length > 1) {
       // Show summary modal: "Voice input contains X items. Apply all?"
       setMultiItemSummary(parsed.items);
       setShowMultiItemModal(true);
     } else if (parsed.items.length === 1) {
       // Single item - populate form directly
       populateFormWithItem(parsed.items[0]);
     }
   };
   ```
2. Create multi-item summary modal:
   - Lists all parsed items with confidence scores
   - Allows user to select which items to apply
   - "Apply All" button
   - "Apply Selected" button
3. Implement `populateFormWithItem()` helper:
   ```typescript
   const populateFormWithItem = (item: ParsedOrderItem) => {
     if (item.articleCodeConfidence > 0.5) {
       setProductSearch(item.articleCode);
       // Trigger autocomplete
     }
     if (item.quantity) {
       setNewItem(prev => ({ ...prev, quantity: item.quantity }));
     }
     setVoicePopulatedFields({
       article: item.articleCodeConfidence > 0.5,
       quantity: !!item.quantity,
     });
   };
   ```

**Verification:**
- Single-item voice input populates form
- Multi-item voice input shows summary modal
- User can select which items to apply

---

## Task 7: Write Integration Tests

**Objective:** Test complete hybrid workflow end-to-end.

**Steps:**
1. Update `OrderForm.voice.spec.tsx` with new test cases:
   - **Test: Voice input populates form without closing modal**
     - Start voice input
     - Speak "cliente Mario Rossi articolo SF1000 quantit√† 5"
     - Click "Review & Apply"
     - Assert: Customer field populated, article field populated, quantity=5
     - Assert: Voice modal still open
     - Assert: Voice badges shown on populated fields
   - **Test: Package disambiguation workflow (CRITICAL)**
     - Mock product variants: H129FSQ with K2 (5pz) and K3 (1pz)
     - Speak "articolo H129FSQ quantit√† 7"
     - Click "Review & Apply"
     - Assert: Disambiguation modal shown
     - Assert: 2 solutions displayed:
       - "üì¶ 3 confezioni (1√ó5pz + 2√ó1pz) ‚úì Raccomandato"
       - "üì¶ 7 confezioni (7√ó1pz)"
     - Click optimal solution (3 confezioni)
     - Assert: Form populated with quantity=7
     - Assert: Voice modal still open
     - Assert: Voice badge shown
   - **Test: Article code without "punto" (CRITICAL)**
     - Speak "articolo H71 104 032 quantit√† 5"
     - Assert: Parsed as "H71.104.032"
     - Assert: Product autocomplete triggered with normalized code
   - **Test: Voice recognition error H71‚ÜíH61 (ERROR RECOVERY)**
     - Mock voice recognition: "articolo H61 104 032"
     - Mock database: Has "H71.104.032", not "H61.104.032"
     - Assert: Validation returns `matchType: 'fuzzy'`
     - Assert: Suggestions modal shown with "H71.104.032 (95% match)"
     - User selects "H71.104.032"
     - Assert: Form populated with corrected article
   - **Test: Variant doesn't exist 023‚Üí016 (ERROR RECOVERY)**
     - Mock voice: "articolo 845 104 023"
     - Mock database: Has "845.104.016", not "845.104.023"
     - Assert: Validation returns `matchType: 'base_pattern'`, basePattern="845.104"
     - Assert: Variant selection modal shown with available variants (.016, .032)
     - User selects ".016"
     - Assert: Form populated with "845.104.016"
   - **Test: User can edit voice-populated fields**
     - Voice-populate customer field
     - Manually type in customer field
     - Assert: Voice badge removed
     - Assert: New value accepted
   - **Test: Draft items added before submission**
     - Populate form with voice
     - Click "Add Item"
     - Assert: Item added to draft list
     - Assert: Form cleared for next item
   - **Test: Confirmation modal required for submission**
     - Add items to draft
     - Click "Create Order"
     - Assert: Confirmation modal shown
     - Click "Confirm & Submit"
     - Assert: Order API called
   - **Test: Multi-item voice input**
     - Speak "articolo SF1000 quantit√† 5, articolo TD1272 quantit√† 2"
     - Assert: Multi-item summary modal shown
     - Select both items
     - Assert: Both items added to draft
2. Mock API endpoints for testing
3. Use React Testing Library for interactions

**Verification:**
```bash
cd archibald-web-app/frontend && npm test OrderForm.voice.spec.tsx
```
Expected: All integration tests pass

---

## Task 8: Add User Onboarding Hints

**Objective:** Guide users through hybrid workflow.

**Steps:**
1. Add tooltip/hint to voice button:
   - "üé§ Voice Input: Speak your order, then review and confirm"
2. Add hint in voice modal on first use:
   - "Tip: Speak clearly, then review the populated fields before confirming"
   - Show only on first 3 uses (use localStorage)
3. Add hint in draft items section:
   - "Review your items before creating the order"
4. Add hint on confirmation modal:
   - "Final check: Ensure all details are correct before submitting"

**Verification:**
- Hints shown in appropriate places
- First-use hints dismissed after 3 uses
- Hints don't interfere with workflow

---

## Task 9: Code Quality and Documentation

**Objective:** Final review and documentation.

**Steps:**
1. Run prettier and linting:
   ```bash
   cd archibald-web-app/frontend
   npm run format
   npm run lint
   npm run typecheck
   ```
2. Self-review using QCHECK from CLAUDE.md:
   - Voice hybrid workflow clear and intuitive
   - No unnecessary complexity
   - Functions follow best practices
3. Add JSDoc comments to new functions
4. Update component documentation
5. Run full test suite:
   ```bash
   npm test
   ```

**Verification:**
- All tests pass
- No linting errors
- Code follows CLAUDE.md best practices

</tasks>

<verification>

## Unit Tests
```bash
cd archibald-web-app/frontend
npm test VoicePopulatedBadge.spec.tsx
npm test orderParser.spec.ts
```

## Integration Tests
```bash
npm test OrderForm.voice.spec.tsx
```

## Manual E2E Verification
1. **Voice Pre-Fill Workflow:**
   - Click voice button
   - Say "cliente Mario Rossi"
   - Click "Review & Apply"
   - Assert: Customer field populated with badge
   - Manual edit customer field
   - Assert: Badge removed

2. **Draft Items Workflow:**
   - Voice-populate article SF1000 quantity 5
   - Click "Add Item"
   - Assert: Item in draft list
   - Voice-populate article TD1272 quantity 2
   - Click "Add Item"
   - Assert: 2 items in draft list

3. **Confirmation Workflow:**
   - Click "Create Order (2 items)"
   - Assert: Confirmation modal shows both items
   - Click "Confirm & Submit"
   - Assert: Order created successfully

4. **Multi-Item Voice Input:**
   - Say "articolo SF1000 quantit√† 5, poi TD1272 quantit√† 2"
   - Assert: Multi-item summary modal shown
   - Select both items
   - Assert: Both items added to draft

</verification>

<success_criteria>
- [ ] Voice input populates form fields without closing modal (pre-fill, not submit)
- [ ] Visual indicators (badges) show which fields were voice-populated
- [ ] Voice-populated fields remain fully editable
- [ ] Edit button clears voice indicator and focuses field
- [ ] Draft items list shows items before submission
- [ ] Confirmation modal required before order submission
- [ ] "Review & Apply" button in voice modal
- [ ] "Clear & Retry" button allows re-recording
- [ ] Multi-item voice input supported with summary modal
- [ ] Keyboard navigation works throughout workflow
- [ ] All unit and integration tests pass
- [ ] Code follows CLAUDE.md best practices
- [ ] User onboarding hints guide through workflow
</success_criteria>

<output>
**Files Created:**
- `frontend/src/components/VoicePopulatedBadge.tsx` - Badge for voice-populated fields
- `frontend/src/components/VoicePopulatedBadge.spec.tsx` - Unit tests

**Files Modified:**
- `frontend/src/components/OrderForm.tsx` - Complete hybrid workflow implementation
  - Voice pre-fill logic
  - Draft items state and UI
  - Confirmation modal
  - Multi-item voice input support
- `frontend/src/utils/orderParser.ts` - Enhanced multi-item parsing
- `frontend/src/components/OrderForm.voice.spec.tsx` - Extended integration tests
- `frontend/src/components/OrderForm.css` - New styles for draft items and confirmation

**Commits:**
1. `refactor(voice): change voice apply to form pre-fill instead of direct submission`
2. `feat(voice): add visual indicators for voice-populated fields`
3. `feat(voice): add Review & Apply button to voice modal`
4. `feat(voice): implement manual edit capability for voice fields`
5. `feat(voice): add draft items list before order submission`
6. `feat(voice): add confirmation modal with order summary`
7. `feat(voice): support multi-item voice input with summary modal`
8. `test(voice): add integration tests for complete hybrid workflow`
9. `ux(voice): add user onboarding hints for voice workflow`

**Next Steps:**
Phase 4 complete. Execute `/gsd:progress` to check project status and plan Phase 5 (Order Submission).
</output>
