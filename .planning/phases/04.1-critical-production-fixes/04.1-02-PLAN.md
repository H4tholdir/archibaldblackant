---
phase: 04.1-critical-production-fixes
plan: 02
type: execute
---

<objective>
Investigate and fix price list synchronization so article prices are visible in order form.

Purpose: Price list data exists in Archibald (confirmed via screenshots) but articles in order form don't show prices. Determine root cause and fix integration.

Output: Prices visible in order form autocomplete, synchronized with Archibald price list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-critical-production-fixes/04.1-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/price-sync-service.ts
@archibald-web-app/backend/src/price-database.ts
@archibald-web-app/backend/src/routes/orders.ts
@archibald-web-app/frontend/src/components/OrderForm.tsx

**Evidence from screenshots:**
- Price List Table ("Tabella prezzi") shows prices: 234,59 €, 275,00 €, 10,45 €, 37,63 €, etc.
- Customer: DETTAGLIO (consigliato) - Code 002
- Date ranges with validity periods (31/12/2154)
- Multiple pages of price data exist

**Problem**: Prices exist in Archibald but don't appear in order form article selection.

**Root cause candidates:**
1. Price sync service not running/enabled
2. Price data not queried in order API
3. Frontend not displaying price field
4. Database schema mismatch
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate price sync service and database state</name>
  <files>
    archibald-web-app/backend/src/price-sync-service.ts,
    archibald-web-app/backend/src/price-database.ts,
    archibald-web-app/backend/data/archibald-session.json
  </files>
  <action>
Investigate current state:
1. Check if price-sync-service is initialized and running in index.ts
2. Query database to verify prices table has data: `SELECT COUNT(*) FROM prices`
3. Check session.json for last price sync timestamp
4. Verify price-database.ts queries return price data correctly
5. Log findings: Is sync running? Is data present? What's missing?

Don't make changes yet - pure investigation.
Document all findings in comments for next task.
  </action>
  <verify>Investigation complete, root cause identified, documented in code comments</verify>
  <done>Understand whether issue is sync not running, data not present, or query problem</done>
</task>

<task type="auto">
  <name>Task 2: Fix price integration in API and frontend</name>
  <files>
    archibald-web-app/backend/src/routes/orders.ts,
    archibald-web-app/frontend/src/components/OrderForm.tsx
  </files>
  <action>
Based on Task 1 findings, implement fix:

**If sync not running:**
- Ensure price-sync-service starts in index.ts
- Verify sync completes at least once

**If data not queried:**
- Add price query to orders API endpoint
- Join products with prices in database query
- Return price field in API response

**If frontend not displaying:**
- Add price field to article autocomplete display
- Format price with € symbol
- Update OrderDraftItem interface to include price

Ensure prices flow: Database → API → Frontend display
Use existing sync service patterns from customer/product sync.
  </action>
  <verify>Prices visible in order form article autocomplete, TypeScript compiles</verify>
  <done>Article selection shows prices from Archibald price list, formatted correctly</done>
</task>

<task type="checkpoint" checkpoint="verify">
  <name>Checkpoint: Verify prices visible in order form</name>
  <action>
Manual verification steps:
1. Start backend server
2. Wait for price sync to complete (check logs)
3. Open frontend order form
4. Search for article in autocomplete
5. Confirm price appears next to article description
6. Verify price matches Archibald price list (compare with screenshots)

Expected: Articles show "ARTICLE CODE - Description - €XX,XX"
  </action>
  <verify>User confirms prices visible and correct</verify>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles: `cd archibald-web-app/backend && npx tsc --noEmit`
- [ ] Price sync service running and populating database
- [ ] API returns price data for articles
- [ ] Frontend displays prices in order form
- [ ] Prices match Archibald price list (screenshot verification)
</verification>

<success_criteria>
- Price sync service operational
- Database prices table populated
- Order API includes price data
- Frontend shows prices in article selection
- Prices accurate compared to Archibald
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-critical-production-fixes/04.1-02-SUMMARY.md`
</output>
