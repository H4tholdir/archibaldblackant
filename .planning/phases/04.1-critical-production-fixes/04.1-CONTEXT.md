# Phase 4.1 Context: Critical Production Fixes

**Created**: 2026-01-13
**Type**: URGENT - Blocking production issues
**Priority**: ðŸ”´ CRITICAL - Must fix before Phase 5

## Overview

Four critical production issues discovered that block reliable order creation:

1. **Backend Process Pause**: All backend processes must pause/kill when operator creates order
2. **Price Sync Missing**: Articles in order form not showing prices from price list
3. **Voice UX Insufficient**: Voice modal example and commands need better explanation
4. **Customer Sync Priority**: New customers not synced first (agents can't find new customers)

## Issue Analysis

### Issue 1: Backend Process Conflicts During Order Creation

**Problem**: When operator requests order creation, concurrent backend processes (customer sync, product sync, etc.) can interfere with bot operations causing:
- Resource contention
- Race conditions
- Slower order creation
- Potential failures

**Current Behavior**:
- Backend services run continuously
- No priority system for order creation
- All processes compete for resources

**Required Behavior**:
- Order creation has absolute priority
- All non-critical processes pause immediately
- Resources fully available to bot
- Processes resume after order complete

**Impact**: HIGH - Affects reliability and speed of every order

**Files Involved**:
- `archibald-web-app/backend/src/index.ts` - Main server
- `archibald-web-app/backend/src/customer-sync-service.ts` - Customer sync
- `archibald-web-app/backend/src/product-sync-service.ts` - Product sync
- `archibald-web-app/backend/src/price-sync-service.ts` - Price sync
- `archibald-web-app/backend/src/archibald-bot.ts` - Bot operations

**Technical Approach**:
- Implement PriorityManager singleton
- Expose pause/resume API for each service
- Wrap createOrder() with priority lock
- Emit events for pause/resume lifecycle

---

### Issue 2: Price List Not Synced to Order Form

**Problem**: Price list data exists in Archibald (see screenshots) but articles in order form don't show prices.

**Evidence from Screenshots**:
- Screenshot 1-2: "Tabella prezzi" (Price List Table) shows:
  - Columns: ITEM SELECTION, ITEM DESCRIPTION, DA DATA, DATA, QUANTITAIMPORTDA, QUANTITAIMPORTO, UNITA DI PREZZO, IMPORTO UNITARIO, VALUTA, PREZZO NETTO BRASSLER
  - Multiple articles with prices (234,59 â‚¬, 275,00 â‚¬, 10,45 â‚¬, 37,63 â‚¬, etc.)
  - Customer: DETTAGLIO (consigliato) - Code 002
  - Date ranges (01/07/2022, 12/09/2022, 09/12/2022, 01/01/2023, etc.)
  - Validity periods (DATA column shows 31/12/2154 - far future)

- Screenshot 3: Navigation showing price list is accessible
- Screenshot 4: Pagination showing multiple pages of prices

**Current State**:
- Price sync service exists: `price-sync-service.ts`
- Database table exists: `prices` table
- BUT: Prices not displayed in order form

**Root Cause Candidates**:
1. Price sync not running/enabled
2. Price data not queried in order API
3. Frontend not displaying price data
4. Database schema mismatch

**Required Behavior**:
- Prices visible in order form autocomplete
- Prices update with article selection
- Current price shown in draft items
- Total price calculated correctly

**Impact**: HIGH - Agents can't see pricing, must check manually

**Files to Investigate**:
- `archibald-web-app/backend/src/price-sync-service.ts` - Sync logic
- `archibald-web-app/backend/src/price-database.ts` - Database layer
- `archibald-web-app/backend/src/routes/orders.ts` - Order API
- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Frontend display
- Database schema files

---

### Issue 3: Voice Modal UX - Insufficient Instructions

**Problem**: Current voice modal has minimal instructions. Agents need:
- Better examples with real article codes
- More detailed command explanations
- Workflow guidance (when to speak, when to tap)
- Error recovery instructions

**Current State**:
- Basic example: "Cliente Mario Rossi, articolo SF1000 quantitÃ  5..."
- Command legend exists but minimal
- No workflow explanation
- No error recovery guidance

**Required Enhancements**:
1. **Better Examples**:
   - Show real article code formats (XX.XX.XXX.XXX)
   - Include "punto" usage
   - Show multi-item dictation
   - Include customer variants

2. **Detailed Command Explanations**:
   - When to use each command
   - What happens after command
   - Visual feedback to expect

3. **Workflow Guidance**:
   - Step-by-step process
   - When to speak vs when to wait
   - How to review before confirm
   - What to do if recognition wrong

4. **Error Recovery**:
   - Common recognition errors
   - How to fix wrong customer
   - How to fix wrong article
   - When to use "riprova"

**Impact**: MEDIUM - Affects adoption and user confidence

**Files Involved**:
- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Modal content
- `archibald-web-app/frontend/src/App.css` - Styling

---

### Issue 4: Customer Sync Priority - New Customers Last

**Problem**: Customer sync fetches customers sequentially. New customers are at the end, meaning agents must wait for entire sync (potentially hours) before they can create orders for new customers.

**Current Behavior**:
- Sync starts from first customer ID
- Processes sequentially (ID 1, 2, 3, ...)
- New customers have highest IDs
- Agents can't find new customers until sync complete

**Required Behavior**:
- Fetch new customers first
- Then backfill existing customers
- Progressive availability (new â†’ old)
- Agents can work immediately

**Technical Challenge**:
- How to identify "new" customers?
- API supports filtering by date?
- Can we reverse sort by ID?
- Cache strategy for new vs existing

**Impact**: HIGH - Blocks agents from working with new customers

**Files to Investigate**:
- `archibald-web-app/backend/src/customer-sync-service.ts` - Sync logic
- `archibald-web-app/backend/src/archibald-bot.ts` - Customer API calls
- DevExpress API documentation for filters

---

## Success Criteria

All 4 issues must be resolved:

1. âœ… Backend processes pause during order creation
2. âœ… Prices visible in order form
3. âœ… Voice modal has comprehensive instructions
4. âœ… New customers synced first

## Dependencies

- Phase 4 complete (voice input working)
- No blocking dependencies

## Estimated Effort

- Issue 1 (Backend Pause): 2-3 hours
- Issue 2 (Price Sync): 3-4 hours (investigation + fix)
- Issue 3 (Voice UX): 1-2 hours
- Issue 4 (Customer Priority): 2-3 hours (research + implementation)

**Total**: 8-12 hours (4 plans)

## Next Steps

1. Create 4 separate plans (one per issue)
2. Prioritize by impact Ã— urgency
3. Execute in order: 1 â†’ 4 â†’ 2 â†’ 3
