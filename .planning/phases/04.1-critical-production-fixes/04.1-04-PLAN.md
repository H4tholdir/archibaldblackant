---
phase: 04.1-critical-production-fixes
plan: 04
type: execute
---

<objective>
Implement customer sync priority reversal to fetch new customers first, enabling agents to work immediately with recently added customers.

Purpose: Current sync processes customers sequentially (old→new), forcing agents to wait hours before new customers appear in database. Reverse priority unblocks agents immediately.

Output: Customer sync fetches newest customers first, then backfills older ones progressively.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-critical-production-fixes/04.1-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/customer-sync-service.ts
@archibald-web-app/backend/src/archibald-bot.ts

**Problem**:
- Current: Sync starts from customer ID 1, processes sequentially (1, 2, 3, ...)
- New customers have highest IDs
- Agents can't find new customers until entire sync completes (hours)

**Required**:
- Fetch newest customers first
- Then backfill existing customers
- Progressive availability (new → old)

**Technical challenges:**
- How to identify "new" customers?
- Does DevExpress API support sort/filter by date?
- Can we reverse sort by ID?
- Cache strategy for new vs existing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research DevExpress API sorting and filtering capabilities</name>
  <files>
    archibald-web-app/backend/src/archibald-bot.ts,
    archibald-web-app/backend/src/customer-sync-service.ts
  </files>
  <action>
Research how to reverse customer sync order:

1. Examine archibald-bot.ts customer fetching methods
   - What API endpoints are used?
   - Are there sort/order parameters?
   - Can we pass descending ID sort?

2. Check if DevExpress DataGrid API supports:
   - Sort by creation date or last modified date
   - Filter by date range (e.g., customers created in last 7 days)
   - Reverse sort by ID (highest → lowest)

3. Examine customer-sync-service.ts current pagination:
   - How does it iterate through customers?
   - What's the page size?
   - Can we start from last page and work backwards?

4. Document findings in code comments:
   - What parameters exist for sorting/filtering?
   - Which approach is most reliable?
   - Are there API limitations?

Don't implement yet - pure research.
Goal: Determine feasible approach for reverse priority.
  </action>
  <verify>Research complete, findings documented, approach identified</verify>
  <done>Understand API capabilities and choose implementation strategy</done>
</task>

<task type="auto">
  <name>Task 2: Implement reverse-priority customer sync</name>
  <files>archibald-web-app/backend/src/customer-sync-service.ts</files>
  <action>
Based on Task 1 findings, implement one of these strategies:

**Strategy A: Reverse ID Sort (if API supports)**
- Modify customer fetch to sort by ID descending
- Process highest IDs first (newest customers)
- Continue to ID 1 (oldest customers)

**Strategy B: Date Filter + Progressive Backfill (if API supports date filter)**
- First pass: Fetch customers created/modified in last 30 days
- Second pass: Fetch customers older than 30 days
- Ensures new customers available immediately

**Strategy C: Two-Phase Sync (if limited API)**
- Phase 1: Fetch last N pages first (newest by ID)
- Phase 2: Backfill remaining pages from start
- Requires calculating total pages and working backwards

Implementation requirements:
- Maintain existing pagination logic
- Don't break current sync functionality
- Add logging for which phase/range being synced
- Update progress reporting to reflect new→old order
- Ensure no customers are skipped or duplicated

Use similar patterns to existing sync (updateProgress, error handling).
  </action>
  <verify>Customer sync fetches newest first, TypeScript compiles, sync completes without errors</verify>
  <done>Customer sync implements reverse priority, new customers synced before old ones</done>
</task>

<task type="checkpoint" checkpoint="verify">
  <name>Checkpoint: Verify new customers sync first</name>
  <action>
Manual verification steps:
1. Add a new customer in Archibald (or identify recently added customer)
2. Clear local customer database (or note last sync timestamp)
3. Start backend server and observe customer sync logs
4. Verify new customer appears in first batch of sync logs
5. Check database to confirm new customer available before sync completes
6. Open frontend and search for new customer name
7. Confirm new customer is selectable in order form

Expected: New customer available within first minute of sync starting, not hours later.
  </action>
  <verify>User confirms new customers appear first in sync and are immediately available</verify>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles: `cd archibald-web-app/backend && npx tsc --noEmit`
- [ ] API research documented implementation approach
- [ ] Customer sync modified to fetch newest first
- [ ] Sync logs show reverse-priority order (high IDs → low IDs)
- [ ] New customers available immediately in frontend
- [ ] No customers skipped or duplicated
</verification>

<success_criteria>
- Customer sync fetches newest customers first
- New customers available in minutes, not hours
- Sync still completes all customers (backfill works)
- Agents can immediately work with recently added customers
- Logs clearly show new→old progression
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-critical-production-fixes/04.1-04-SUMMARY.md`
</output>
