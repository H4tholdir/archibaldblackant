---
phase: 04.1-critical-production-fixes
plan: 01
type: execute
---

<objective>
Implement Backend Process Priority Manager to pause all background services during order creation, ensuring bot gets full resource priority and preventing interference.

Purpose: Eliminate race conditions and resource contention between bot operations and sync services for reliable order creation.

Output: PriorityManager singleton, pause/resume API for services, order creation with priority lock.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-critical-production-fixes/04.1-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/customer-sync-service.ts
@archibald-web-app/backend/src/product-sync-service.ts
@archibald-web-app/backend/src/price-sync-service.ts
@archibald-web-app/backend/src/archibald-bot.ts

**Problem**: Concurrent sync services interfere with bot during order creation causing race conditions, resource contention, and slower/unreliable orders.

**Solution**: Singleton PriorityManager that pauses all services, wraps createOrder with priority lock, resumes after completion.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PriorityManager singleton with pause/resume coordination</name>
  <files>archibald-web-app/backend/src/priority-manager.ts</files>
  <action>
Create PriorityManager class as singleton with:
- Private constructor (singleton pattern)
- Static getInstance() method
- pause(): Promise<void> - pauses all registered services
- resume(): void - resumes all paused services
- withPriority<T>(fn: () => Promise<T>): Promise<T> - wraps async function with pause/resume
- EventEmitter for lifecycle events ('pause', 'resume')
- Set<string> to track paused service names
- Logger integration for observability

Use EventEmitter pattern (not custom implementation). Import from 'events'.
Don't use global state outside the class - keep everything encapsulated.
</action>
  <verify>TypeScript compiles, class exports getInstance() and withPriority() methods</verify>
  <done>PriorityManager.ts exists, singleton pattern implemented, pause/resume/withPriority methods defined</done>
</task>

<task type="auto">
  <name>Task 2: Add pause/resume API to all sync services</name>
  <files>
    archibald-web-app/backend/src/customer-sync-service.ts,
    archibald-web-app/backend/src/product-sync-service.ts,
    archibald-web-app/backend/src/price-sync-service.ts
  </files>
  <action>
For each sync service class, add:
- public pause(): Promise<void> method that:
  - Sets internal paused flag
  - Waits for current sync operation to complete (if running)
  - Logs pause event
- public resume(): void method that:
  - Clears paused flag
  - Logs resume event
  - Continues normal operation
- Check paused flag at start of each sync iteration
- Don't interrupt mid-operation - wait for current batch to finish

CustomerSyncService already has updateProgress method - use similar pattern for pause state.
Don't add pause checks inside tight loops - check at operation boundaries only.
</action>
  <verify>Each service exports pause() and resume() methods, TypeScript compiles</verify>
  <done>All 3 sync services have pause/resume methods, respect paused state</done>
</task>

<task type="auto">
  <name>Task 3: Wrap createOrder with priority lock in routes</name>
  <files>archibald-web-app/backend/src/routes/orders.ts</files>
  <action>
In POST /api/orders/create endpoint:
1. Import PriorityManager
2. Import all sync service instances
3. Register services with PriorityManager (if not already registered)
4. Wrap the createOrder bot call with:
   ```typescript
   const result = await PriorityManager.getInstance().withPriority(async () => {
     // Existing createOrder logic here
     return await bot.createOrder(orderData);
   });
   ```

Don't change createOrder signature or return type.
Don't modify error handling - withPriority should propagate errors.
Log priority lock acquisition/release at debug level.
</action>
  <verify>Order creation API endpoint imports PriorityManager, wraps bot call, TypeScript compiles</verify>
  <done>createOrder wrapped with priority lock, services pause during order creation, resume after</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles with no errors: `cd archibald-web-app/backend && npx tsc --noEmit`
- [ ] PriorityManager singleton created with pause/resume/withPriority
- [ ] All 3 sync services have pause/resume methods
- [ ] Order creation endpoint wraps bot call with priority lock
- [ ] Logs show pause/resume events during order creation
</verification>

<success_criteria>
- PriorityManager singleton implemented
- All sync services pausable/resumable
- Order creation wrapped with priority lock
- TypeScript: 0 errors
- Services pause during order, resume after
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-critical-production-fixes/04.1-01-SUMMARY.md`
</output>
