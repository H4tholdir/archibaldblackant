---
phase: 24-background-sync-service
plan: 01
type: execute
---

<objective>
Enable automatic background sync service with staggered scheduling.

Purpose: Activate the existing SyncOrchestrator auto-sync functionality to run syncs automatically in the background without manual intervention.
Output: Auto-sync enabled on server startup, admin controls to manage auto-sync state, verified scheduling behavior.
</objective>

<context>
**Current State:**
- SyncOrchestrator.startAutoSync() already implemented (Phase 22-02) with staggered scheduling
- Frequencies confirmed: Orders (10min, T+0), Customers (30min, T+5), Prices (30min, T+10), Invoices (30min, T+15), DDT (45min, T+20), Products (90min, T+30)
- Auto-sync is DISABLED in server startup (index.ts:5042-5081)
- Manual syncs work perfectly via API and SyncControlPanel UI

**What Needs to Be Done:**
1. Enable orchestrator.startAutoSync() on server startup (index.ts)
2. Add admin API endpoints to control auto-sync (start/stop/status)
3. Add UI controls in SyncControlPanel for starting/stopping auto-sync
4. Verify scheduling works correctly with logging

**Key Files:**
- `backend/src/index.ts` - Server startup (enable auto-sync)
- `backend/src/sync-orchestrator.ts` - Auto-sync methods (already implemented)
- `frontend/src/components/SyncControlPanel.tsx` - Admin UI controls
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable auto-sync on server startup</name>
  <files>backend/src/index.ts</files>
  <action>
    Uncomment/enable syncOrchestrator.startAutoSync() in server.listen callback.
    Replace lines 5042-5081 (TEMPORARILY DISABLED section) with:

    ```typescript
    // ========== AUTOMATIC BACKGROUND SYNC SERVICE ==========
    // Phase 24: Enable orchestrator auto-sync with staggered scheduling
    try {
      syncOrchestrator.startAutoSync();
      logger.info("‚úÖ Background sync service started (staggered scheduling)");
      logger.info("  Orders: 10min (T+0)");
      logger.info("  Customers: 30min (T+5)");
      logger.info("  Prices: 30min (T+10)");
      logger.info("  Invoices: 30min (T+15)");
      logger.info("  DDT: 45min (T+20)");
      logger.info("  Products: 90min (T+30)");
    } catch (error) {
      logger.error("‚ùå Failed to start background sync service", { error });
    }
    ```
  </action>
  <verify>Server starts successfully, logs show auto-sync enabled with intervals</verify>
  <done>Auto-sync enabled on server startup.</done>
</task>

<task type="auto">
  <name>Task 2: Add admin API endpoints for auto-sync control</name>
  <files>backend/src/index.ts</files>
  <action>
    Add 3 JWT-protected admin endpoints after existing sync endpoints:

    ```typescript
    // GET /api/sync/auto-sync/status - Get auto-sync state
    app.get("/api/sync/auto-sync/status", authenticateToken, requireAdmin, (req, res) => {
      try {
        const isRunning = syncOrchestrator.isAutoSyncRunning();
        res.json({ success: true, isRunning });
      } catch (error) {
        logger.error("[API] Error getting auto-sync status:", error);
        res.status(500).json({ success: false, error: "Failed to get auto-sync status" });
      }
    });

    // POST /api/sync/auto-sync/start - Start auto-sync
    app.post("/api/sync/auto-sync/start", authenticateToken, requireAdmin, (req, res) => {
      try {
        syncOrchestrator.startAutoSync();
        logger.info("[API] Auto-sync started by admin", { userId: req.user.userId });
        res.json({ success: true, message: "Auto-sync started" });
      } catch (error) {
        logger.error("[API] Error starting auto-sync:", error);
        res.status(500).json({ success: false, error: "Failed to start auto-sync" });
      }
    });

    // POST /api/sync/auto-sync/stop - Stop auto-sync
    app.post("/api/sync/auto-sync/stop", authenticateToken, requireAdmin, (req, res) => {
      try {
        syncOrchestrator.stopAutoSync();
        logger.info("[API] Auto-sync stopped by admin", { userId: req.user.userId });
        res.json({ success: true, message: "Auto-sync stopped" });
      } catch (error) {
        logger.error("[API] Error stopping auto-sync:", error);
        res.status(500).json({ success: false, error: "Failed to stop auto-sync" });
      }
    });
    ```

    Add isAutoSyncRunning() method to SyncOrchestrator class.
  </action>
  <verify>API endpoints return correct status, start/stop auto-sync</verify>
  <done>Admin API endpoints created.</done>
</task>

<task type="auto">
  <name>Task 3: Add isAutoSyncRunning method to SyncOrchestrator</name>
  <files>backend/src/sync-orchestrator.ts</files>
  <action>
    Add method after stopAutoSync():

    ```typescript
    /**
     * Check if auto-sync is currently running
     */
    isAutoSyncRunning(): boolean {
      return this.autoSyncTimers.length > 0 || this.autoSyncIntervals.length > 0;
    }
    ```
  </action>
  <verify>Method returns true when timers exist, false otherwise</verify>
  <done>isAutoSyncRunning method added.</done>
</task>

<task type="auto">
  <name>Task 4: Add auto-sync toggle controls to SyncControlPanel</name>
  <files>frontend/src/components/SyncControlPanel.tsx</files>
  <action>
    Add auto-sync status and controls at top of panel (before sync sections):

    1. Add state: `const [autoSyncEnabled, setAutoSyncEnabled] = useState<boolean | null>(null);`

    2. Add useEffect to fetch auto-sync status:
    ```typescript
    useEffect(() => {
      const fetchAutoSyncStatus = async () => {
        try {
          const response = await fetch('/api/sync/auto-sync/status', {
            headers: { Authorization: `Bearer ${localStorage.getItem('archibald_jwt')}` }
          });
          const data = await response.json();
          if (data.success) {
            setAutoSyncEnabled(data.isRunning);
          }
        } catch (error) {
          console.error('Failed to fetch auto-sync status:', error);
        }
      };
      fetchAutoSyncStatus();
    }, []);
    ```

    3. Add toggleAutoSync handler:
    ```typescript
    const toggleAutoSync = async () => {
      const endpoint = autoSyncEnabled ? 'stop' : 'start';
      try {
        const response = await fetch(`/api/sync/auto-sync/${endpoint}`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${localStorage.getItem('archibald_jwt')}` }
        });
        const data = await response.json();
        if (data.success) {
          setAutoSyncEnabled(!autoSyncEnabled);
        }
      } catch (error) {
        console.error('Failed to toggle auto-sync:', error);
      }
    };
    ```

    4. Add UI section at top (before existing sync sections):
    ```tsx
    <div style={{
      padding: '16px',
      backgroundColor: autoSyncEnabled ? '#e8f5e9' : '#fff3e0',
      borderRadius: '8px',
      marginBottom: '20px',
      border: `2px solid ${autoSyncEnabled ? '#4caf50' : '#ff9800'}`
    }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <div>
          <h3 style={{ margin: 0, fontSize: '16px', fontWeight: 600 }}>
            ü§ñ Sync Automatico {autoSyncEnabled ? '(Attivo)' : '(Disattivato)'}
          </h3>
          <p style={{ margin: '8px 0 0 0', fontSize: '13px', color: '#666' }}>
            {autoSyncEnabled
              ? 'I sync vengono eseguiti automaticamente in background con intervalli configurati'
              : 'Attiva il sync automatico per eseguire sync in background senza intervento manuale'}
          </p>
        </div>
        <button
          onClick={toggleAutoSync}
          disabled={autoSyncEnabled === null}
          style={{
            padding: '10px 20px',
            backgroundColor: autoSyncEnabled ? '#f44336' : '#4caf50',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: autoSyncEnabled === null ? 'not-allowed' : 'pointer',
            fontWeight: 600,
            opacity: autoSyncEnabled === null ? 0.6 : 1
          }}
        >
          {autoSyncEnabled ? '‚è∏Ô∏è Disattiva' : '‚ñ∂Ô∏è Attiva'}
        </button>
      </div>
    </div>
    ```
  </action>
  <verify>Auto-sync toggle appears, shows correct status, start/stop buttons work</verify>
  <done>Auto-sync controls added to SyncControlPanel.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Background sync service with admin controls</what-built>
  <how-to-verify>
    1. Restart backend server (npm run dev)
    2. Check logs for "‚úÖ Background sync service started (staggered scheduling)"
    3. Verify 6 sync types logged with intervals (Orders 10min, etc.)
    4. Navigate to Admin page ‚Üí Sync Control Panel
    5. Verify auto-sync toggle shows "Attivo" (green) at top
    6. Click "Disattiva" button ‚Üí verify logs show auto-sync stopped
    7. Click "Attiva" button ‚Üí verify logs show auto-sync started
    8. Wait for first sync trigger (Orders at T+0) ‚Üí verify sync executes
    9. Check orchestrator status endpoint ‚Üí verify sync type and timestamps
    10. Verify subsequent syncs trigger at correct intervals (Customers at T+5, etc.)

    Success: Auto-sync runs in background, admin controls work, staggered scheduling verified.
  </how-to-verify>
  <resume-signal>Type "approved"</resume-signal>
</task>

</tasks>

<success_criteria>
- Auto-sync enabled on server startup
- Admin API endpoints (status/start/stop) functional
- SyncControlPanel shows auto-sync toggle with status
- Staggered scheduling works correctly (6 sync types, verified intervals)
- User verification passed
</success_criteria>

<output>
Create `.planning/phases/24-background-sync-service/24-01-SUMMARY.md`
</output>
