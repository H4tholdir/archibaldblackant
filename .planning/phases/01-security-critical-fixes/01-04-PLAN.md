# Plan 01-04: Fix activeSyncType Undefined Bug

**Phase:** 1 - Security Critical Fixes
**Created:** 2026-01-11
**Status:** Ready to execute

## Goal

Fix the runtime error caused by referencing undefined variable `activeSyncType` in sync endpoint error responses. This bug causes the 409 Conflict responses to fail when sync operations are already in progress.

## Context

From CONCERNS.md (lines 34-47):

**Bug**: Variable `activeSyncType` is referenced but never declared in `archibald-web-app/backend/src/index.ts`

**Location**: Lines 403, 406, 477, 515, 553

**Current code** (BROKEN):
```typescript
if (activeSyncType) {  // <- undefined variable, ReferenceError at runtime
  return res.status(409).json({
    error: `Sincronizzazione ${activeSyncType} già in corso...`
  });
}
```

**Root cause**: Variable name mismatch
- Line 35 declares: `let activeOperation: ActiveOperation = null;`
- But error messages use: `activeSyncType` (which doesn't exist)

**Impact**:
- Runtime ReferenceError when sync endpoints called during active operations
- 409 conflict response fails to send, leading to unclear error for client
- Lock mechanism works correctly, but error reporting is broken

**Expected behavior**:
- Use `activeOperation` (the correct variable name)
- 409 responses should successfully inform client which operation is blocking

## Approach

Simple find-and-replace operation: change all 5 occurrences of `activeSyncType` to `activeOperation` in index.ts.

This is a straightforward variable rename with no logic changes required.

## Tasks

<task id="1">
<description>Replace activeSyncType with activeOperation</description>
<details>
Update all occurrences of the undefined variable in `archibald-web-app/backend/src/index.ts`:

**5 locations to fix**:

1. **Line 403-407** (sync-all endpoint):
   ```typescript
   // BEFORE:
   if (activeSyncType) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeSyncType} già in corso. Attendere il completamento.`,
     });
   }

   // AFTER:
   if (activeOperation) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeOperation} già in corso. Attendere il completamento.`,
     });
   }
   ```

2. **Line 474-478** (sync-customers endpoint):
   ```typescript
   // BEFORE:
   if (!acquireSyncLock("customers")) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeSyncType} già in corso. Attendere il completamento.`,
     });
   }

   // AFTER:
   if (!acquireSyncLock("customers")) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeOperation} già in corso. Attendere il completamento.`,
     });
   }
   ```

3. **Line 512-516** (sync-products endpoint):
   ```typescript
   // BEFORE:
   if (!acquireSyncLock("products")) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeSyncType} già in corso. Attendere il completamento.`,
     });
   }

   // AFTER:
   if (!acquireSyncLock("products")) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeOperation} già in corso. Attendere il completamento.`,
     });
   }
   ```

4. **Line 550-554** (sync-prices endpoint):
   ```typescript
   // BEFORE:
   if (!acquireSyncLock("prices")) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeSyncType} già in corso. Attendere il completamento.`,
     });
   }

   // AFTER:
   if (!acquireSyncLock("prices")) {
     return res.status(409).json({
       success: false,
       error: `Sincronizzazione ${activeOperation} già in corso. Attendere il completamento.`,
     });
   }
   ```

**Implementation approach**:
- Use Edit tool for each occurrence with exact old_string → new_string replacement
- Preserve exact indentation and formatting
- No other changes to surrounding code

Commit with message: "fix: replace undefined activeSyncType with activeOperation"
</details>
<files>
- archibald-web-app/backend/src/index.ts (read/write)
</files>
</task>

<task id="2">
<description>Run TypeScript compilation to verify fix</description>
<details>
Verify the fix resolves the undefined variable error:

1. **Run TypeScript compiler check**:
   ```bash
   cd /Users/hatholdir/Downloads/Archibald/archibald-web-app/backend
   npx tsc --noEmit
   ```
   - Should complete without "Cannot find name 'activeSyncType'" errors
   - Other pre-existing errors may remain (not in scope for this plan)

2. **Search for any remaining references**:
   ```bash
   cd /Users/hatholdir/Downloads/Archibald/archibald-web-app/backend
   grep -r "activeSyncType" src/
   ```
   - Should return no results (all occurrences fixed)

3. **Verify activeOperation is used consistently**:
   ```bash
   grep -n "activeOperation" src/index.ts | head -20
   ```
   - Should show declaration on line 35 and all usage sites

Document the verification results.
</details>
<files>
None (verification only)
</files>
</task>

<task id="3">
<description>Manual smoke test of sync conflict handling</description>
<details>
Test that the 409 conflict response now works correctly:

**Test setup**:
1. Start the backend server: `cd archibald-web-app/backend && npm run dev`
2. Open two terminal windows for concurrent API calls

**Test case 1: Concurrent sync operations**
```bash
# Terminal 1: Start a long-running sync
curl -X POST http://localhost:3000/api/sync/customers

# Terminal 2: While sync is running, try another sync
curl -X POST http://localhost:3000/api/sync/products
```

**Expected result**:
- Terminal 2 receives 409 response with message: "Sincronizzazione customers già in corso. Attendere il completamento."
- NO ReferenceError in server logs
- Terminal 1 sync completes successfully

**Test case 2: Sync during order creation**
```bash
# Terminal 1: Create an order (simulated or real)
curl -X POST http://localhost:3000/api/orders -H "Content-Type: application/json" -d '{ ... }'

# Terminal 2: Try sync while order is processing
curl -X POST http://localhost:3000/api/sync/customers
```

**Expected result**:
- Terminal 2 receives 409 with message about order in progress
- NO undefined variable errors

**If Archibald credentials not available**:
- Can simulate by manually setting `activeOperation` in debugger
- Or ask user to run the test when they have access

Document test results and any issues found.
</details>
<files>
None (manual testing)
</files>
</task>

## Success Criteria

- [ ] All 5 occurrences of `activeSyncType` replaced with `activeOperation`
- [ ] No remaining references to `activeSyncType` in the codebase
- [ ] TypeScript compilation passes without "Cannot find name 'activeSyncType'" errors
- [ ] `grep -r "activeSyncType"` returns no results
- [ ] Manual smoke test shows 409 responses work correctly
- [ ] No ReferenceError in server logs during conflict scenarios
- [ ] Changes committed with descriptive message

## Dependencies

None - this is an independent bug fix

## Risks

- **Other undefined variables exist**: This fix only addresses `activeSyncType`
  - Mitigation: TypeScript strict mode should catch other undefined variables

- **Logic error in lock mechanism**: This plan assumes lock logic is correct, only fixes error reporting
  - Mitigation: Lock logic is out of scope, covered in future phases

- **Cannot test without Archibald access**: User may not be able to run full smoke test
  - Mitigation: TypeScript compilation and grep verification are sufficient to confirm fix

## Notes

- This is a simple variable rename (no logic changes)
- The lock mechanism (`acquireSyncLock`, `activeOperation`) is working correctly - only error messages were broken
- TypeScript should have caught this, but may have been disabled or ignored during development
- After this fix, 409 responses will correctly inform clients which operation is blocking
- No impact on functionality (lock was working), but improves error handling and debugging

---

*Plan: 01-04 | Phase: 01-security-critical-fixes*
