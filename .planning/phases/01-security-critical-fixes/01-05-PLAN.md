# Plan 01-05: Centralize Hardcoded URLs

**Phase:** 1 - Security Critical Fixes
**Created:** 2026-01-11
**Status:** Ready to execute

## Goal

Eliminate hardcoded Archibald server URLs scattered across the codebase by centralizing them in `config.ts`. This prevents deployment issues when the Archibald server URL changes (e.g., different staging/production environments).

## Context

From CONCERNS.md (lines 21-30):

**Problem**: Hardcoded IP address and URLs throughout codebase
- Changes to Archibald server URL require code changes and redeployment
- URL appears in 5 different files

**Files with hardcoded URLs**:
1. `customer-sync-service.ts` (lines 165, 172)
2. `product-sync-service.ts` (lines 165, 172)
3. `price-sync-service.ts` (lines 169, 177)
4. `browser-pool.ts` (lines 80, 153, 246)
5. `queue-manager.ts` (line 193)

**Current state**:
- `config.ts` already has `config.archibald.url` set to `https://4.231.124.90/Archibald`
- But services are NOT using it - they hardcode the URL directly

**All hardcoded instances** (10 total):
```typescript
// Hardcoded base URL (6 instances):
await bot.page.goto('https://4.231.124.90/Archibald/', {...})

// Hardcoded page URLs (4 instances):
await bot.page.goto('https://4.231.124.90/Archibald/CUSTTABLE_ListView/', {...})
await bot.page.goto('https://4.231.124.90/Archibald/INVENTTABLE_ListView/', {...})
await bot.page.goto('https://4.231.124.90/Archibald/PRICEDISCTABLE_ListView/', {...})
```

## Approach

1. Import `config` in all affected files
2. Replace hardcoded URLs with `config.archibald.url` + path suffix
3. Keep the trailing slash handling consistent
4. Verify TypeScript compilation passes

**URL construction pattern**:
```typescript
// Base URL only:
const baseUrl = config.archibald.url; // Already has trailing slash
await bot.page.goto(baseUrl, {...});

// Base URL + path:
const pageUrl = `${config.archibald.url}/CUSTTABLE_ListView/`;
await bot.page.goto(pageUrl, {...});
```

## Tasks

<task id="1">
<description>Centralize URLs in customer-sync-service.ts</description>
<details>
Update `archibald-web-app/backend/src/customer-sync-service.ts`:

1. **Add config import** (if not already present):
   ```typescript
   import { config } from './config';
   ```

2. **Replace line 165** (base URL):
   ```typescript
   // BEFORE:
   await bot.page.goto(`https://4.231.124.90/Archibald/`, {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

3. **Replace line 172** (customers page):
   ```typescript
   // BEFORE:
   await bot.page.goto(`https://4.231.124.90/Archibald/CUSTTABLE_ListView/`, {

   // AFTER:
   await bot.page.goto(`${config.archibald.url}/CUSTTABLE_ListView/`, {
   ```

Use Edit tool for precise replacements preserving indentation.
</details>
<files>
- archibald-web-app/backend/src/customer-sync-service.ts (read/write)
</files>
</task>

<task id="2">
<description>Centralize URLs in product-sync-service.ts</description>
<details>
Update `archibald-web-app/backend/src/product-sync-service.ts`:

1. **Add config import** (if not already present):
   ```typescript
   import { config } from './config';
   ```

2. **Replace line 165** (base URL):
   ```typescript
   // BEFORE:
   await bot.page.goto(`https://4.231.124.90/Archibald/`, {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

3. **Replace line 172** (products page):
   ```typescript
   // BEFORE:
   await bot.page.goto(`https://4.231.124.90/Archibald/INVENTTABLE_ListView/`, {

   // AFTER:
   await bot.page.goto(`${config.archibald.url}/INVENTTABLE_ListView/`, {
   ```

Use Edit tool for precise replacements preserving indentation.
</details>
<files>
- archibald-web-app/backend/src/product-sync-service.ts (read/write)
</files>
</task>

<task id="3">
<description>Centralize URLs in price-sync-service.ts</description>
<details>
Update `archibald-web-app/backend/src/price-sync-service.ts`:

1. **Add config import** (if not already present):
   ```typescript
   import { config } from './config';
   ```

2. **Replace line 169** (base URL):
   ```typescript
   // BEFORE:
   await bot.page.goto(`https://4.231.124.90/Archibald/`, {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

3. **Replace line 177** (prices page):
   ```typescript
   // BEFORE:
   await bot.page.goto(`https://4.231.124.90/Archibald/PRICEDISCTABLE_ListView/`, {

   // AFTER:
   await bot.page.goto(`${config.archibald.url}/PRICEDISCTABLE_ListView/`, {
   ```

Use Edit tool for precise replacements preserving indentation.
</details>
<files>
- archibald-web-app/backend/src/price-sync-service.ts (read/write)
</files>
</task>

<task id="4">
<description>Centralize URLs in browser-pool.ts</description>
<details>
Update `archibald-web-app/backend/src/browser-pool.ts`:

1. **Add config import** (if not already present):
   ```typescript
   import { config } from './config';
   ```

2. **Replace line 80** (session verification):
   ```typescript
   // BEFORE:
   await bot.page.goto("https://4.231.124.90/Archibald/", {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

3. **Replace line 153** (session reuse):
   ```typescript
   // BEFORE:
   await bot.page.goto("https://4.231.124.90/Archibald/", {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

4. **Replace line 246** (reset to home):
   ```typescript
   // BEFORE:
   await bot.page.goto("https://4.231.124.90/Archibald/", {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

Use Edit tool for precise replacements preserving indentation.
</details>
<files>
- archibald-web-app/backend/src/browser-pool.ts (read/write)
</files>
</task>

<task id="5">
<description>Centralize URLs in queue-manager.ts</description>
<details>
Update `archibald-web-app/backend/src/queue-manager.ts`:

1. **Add config import** (if not already present):
   ```typescript
   import { config } from './config';
   ```

2. **Replace line 193** (login session reuse):
   ```typescript
   // BEFORE:
   await bot.page.goto('https://4.231.124.90/Archibald/', {

   // AFTER:
   await bot.page.goto(config.archibald.url, {
   ```

Use Edit tool for precise replacements preserving indentation.
</details>
<files>
- archibald-web-app/backend/src/queue-manager.ts (read/write)
</files>
</task>

<task id="6">
<description>Verify centralization and document config.ts</description>
<details>
Confirm all URLs are centralized and document the configuration:

1. **Verify no hardcoded URLs remain**:
   ```bash
   cd /Users/hatholdir/Downloads/Archibald/archibald-web-app/backend
   grep -r "4\.231\.124\.90" src/ | grep -v config.ts
   ```
   - Should return ONLY `config.ts` (the single source of truth)
   - If any other files appear, they still have hardcoded URLs

2. **Run TypeScript compilation**:
   ```bash
   cd /Users/hatholdir/Downloads/Archibald/archibald-web-app/backend
   npx tsc --noEmit
   ```
   - Should complete without import errors or type errors related to config

3. **Document config.ts for future maintainers**:
   Add comment to `config.ts` explaining URL centralization:
   ```typescript
   export const config = {
     archibald: {
       // Centralized Archibald server URL - all services use this
       // Change ARCHIBALD_URL environment variable to point to different environments
       // Format: https://host:port/Archibald (with trailing path, no trailing slash after path)
       url: process.env.ARCHIBALD_URL || 'https://4.231.124.90/Archibald',
       username: process.env.ARCHIBALD_USERNAME || '',
       password: process.env.ARCHIBALD_PASSWORD || '',
     },
     // ...rest of config
   ```

4. **Commit all changes**:
   ```bash
   git add src/config.ts src/customer-sync-service.ts src/product-sync-service.ts src/price-sync-service.ts src/browser-pool.ts src/queue-manager.ts
   git commit -m "refactor: centralize hardcoded Archibald URLs in config.ts"
   ```

Document verification results.
</details>
<files>
- archibald-web-app/backend/src/config.ts (read/write - add comments)
- All updated service files (commit)
</files>
</task>

## Success Criteria

- [ ] Config import added to all 5 affected files
- [ ] All 10 hardcoded URL instances replaced with `config.archibald.url`
- [ ] Grep verification shows NO hardcoded URLs outside config.ts
- [ ] TypeScript compilation passes without errors
- [ ] config.ts documented with URL format explanation
- [ ] All changes committed with descriptive message
- [ ] Code review confirms URL construction is consistent across all services

## Dependencies

None - this is an independent refactoring task

## Risks

- **URL format mismatch**: `config.archibald.url` might have different trailing slash than expected
  - Mitigation: Check config.ts first (line 7 shows it ends with `/Archibald` - no trailing slash)
  - When building page URLs, add leading slash: `${config.archibald.url}/PageName/`

- **Breaking authentication flow**: If URL construction is wrong, login might fail
  - Mitigation: Test manual login after changes (or wait for Phase 2 integration tests)

- **Other hardcoded Archibald URLs in frontend**: This plan only covers backend
  - Mitigation: Out of scope - frontend URLs are separate concern

## Notes

- `config.archibald.url` already exists and has the correct default value
- The default in config.ts (`https://4.231.124.90/Archibald`) will remain as fallback
- This refactoring enables easy environment switching via `ARCHIBALD_URL` env var
- URL format: Base URL has NO trailing slash, page URLs add `/PageName/` suffix
- After this plan, changing Archibald server URL requires ONLY updating .env file (no code changes)
- This is the final plan in Phase 1 - completes all security critical fixes

---

*Plan: 01-05 | Phase: 01-security-critical-fixes*
