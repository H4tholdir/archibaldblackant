# Plan 01-02: Remove .env from Git History

**Phase:** 1 - Security Critical Fixes
**Created:** 2026-01-11
**Status:** Ready to execute

## Goal

Completely remove `archibald-web-app/backend/.env` from git history using BFG Repo-Cleaner, as if it never existed in the repository. This ensures the exposed credentials ([REDACTED-USERNAME] / [REDACTED-PASSWORD]) cannot be recovered from git history by anyone with repository access.

## Context

The file `archibald-web-app/backend/.env` containing hardcoded credentials has been committed to git history. From CONCERNS.md:

```
Username: [REDACTED-USERNAME]
Password: [REDACTED-PASSWORD]
ERP URL: https://4.231.124.90/Archibald
```

These credentials have been rotated in plan 01-01, but the OLD credentials still exist in git history and can be extracted by anyone with repository access using `git log -p` or `git show`.

**Why BFG Repo-Cleaner over git filter-branch:**
- 10-720x faster for history rewriting
- Simpler syntax for file removal
- Safer defaults (protects HEAD by default)
- Recommended by GitHub for sensitive data removal

## Approach

Use BFG Repo-Cleaner to rewrite git history and permanently remove the `.env` file from all commits. This is a DESTRUCTIVE operation that rewrites commit SHAs - coordination required if repository is shared.

**CRITICAL SAFETY**: This plan assumes the repository is LOCAL ONLY and has NOT been pushed to a remote (GitHub/GitLab). If a remote exists, force-push will be required and all collaborators must re-clone.

## Tasks

<task id="1">
<description>Check repository remote status and warn user</description>
<details>
Before proceeding with destructive git operations:

1. Check if git remote exists: `git remote -v`
2. Check if commits have been pushed: `git log --branches --not --remotes`
3. Check current branch: `git branch --show-current`

If remote exists OR commits have been pushed:
- **STOP and get explicit user confirmation**
- Warn: "This will rewrite git history. Anyone with the old history needs to re-clone."
- Warn: "Force push required to remote after cleanup."
- Ask: "Do you want to proceed? (yes/no)"

If no remote or no pushed commits:
- Inform: "Local-only repository detected. Safe to proceed."
- Continue with cleanup

Document the remote status in plan output.
</details>
<files>
None (read-only git operations)
</files>
</task>

<task id="2">
<description>Install BFG Repo-Cleaner and remove .env from history</description>
<details>
Execute git history cleanup:

1. **Install BFG Repo-Cleaner**:
   - macOS: `brew install bfg`
   - Linux: Download from https://rtyley.github.io/bfg-repo-cleaner/
   - Verify: `bfg --version`

2. **Backup repository** (safety first):
   ```bash
   cd /Users/hatholdir/Downloads/
   cp -r Archibald Archibald-backup-$(date +%Y%m%d)
   ```

3. **Remove .env from git index** (current commit):
   ```bash
   cd /Users/hatholdir/Downloads/Archibald
   git rm --cached archibald-web-app/backend/.env
   git commit -m "security: remove .env from tracking (pre-history cleanup)"
   ```

4. **Run BFG to clean history**:
   ```bash
   cd /Users/hatholdir/Downloads/
   bfg --delete-files .env Archibald
   ```

5. **Clean up reflog and gc**:
   ```bash
   cd /Users/hatholdir/Downloads/Archibald
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive
   ```

6. **Verify .env is gone from history**:
   ```bash
   git log --all --full-history -- archibald-web-app/backend/.env
   # Should return empty (no commits found)
   ```

Document each step's output for verification.
</details>
<files>
- .git/* (git history rewrite)
- archibald-web-app/backend/.env (removed from index)
</files>
</task>

<task id="3">
<description>Verify cleanup and document post-cleanup steps</description>
<details>
Confirm the cleanup was successful and provide next steps:

1. **Verify .env removed from all commits**:
   ```bash
   # Search entire history for .env content
   git log --all -p -S "FresisArch2025" | head -20
   # Should return empty (no matches)

   # Check file is not in any tree objects
   git log --all --full-history -- "**/.env" | wc -l
   # Should return 0
   ```

2. **Check repository integrity**:
   ```bash
   git fsck --full
   # Should complete without errors
   ```

3. **Document new commit SHAs**:
   ```bash
   git log --oneline -10
   # Record new commit hashes for reference
   ```

4. **If remote exists - force push instructions**:
   ```bash
   # DO NOT RUN AUTOMATICALLY - provide as instructions only
   git push --force-with-lease origin main
   # Warn: All collaborators must run: git pull --rebase or re-clone
   ```

5. **Remove backup if successful**:
   - Ask user: "Cleanup verified. Delete backup at Archibald-backup-YYYYMMDD? (yes/no)"
   - If yes: `rm -rf /Users/hatholdir/Downloads/Archibald-backup-*`

Document all verification results and next steps for the user.
</details>
<files>
None (verification only)
</files>
</task>

## Success Criteria

- [ ] BFG Repo-Cleaner installed successfully
- [ ] Repository backup created before cleanup
- [ ] `.env` file removed from current working tree and git index
- [ ] BFG execution completed without errors
- [ ] Git reflog expired and garbage collection run
- [ ] Verification confirms `.env` not in any commit history
- [ ] Verification confirms no "FresisArch2025" string in git history
- [ ] `git fsck --full` passes without errors
- [ ] New commit SHAs documented
- [ ] If remote exists: User understands force-push is required
- [ ] Backup retained until user confirms success

## Dependencies

- **Plan 01-01 MUST complete first** - old credentials must be rotated in Archibald ERP before cleaning git history
- If skipped: old credentials in history would still be functional

## Risks

- **Destructive operation**: Cannot be undone without backup
  - Mitigation: Create backup before running BFG

- **Collaborator disruption**: If repository is shared, all collaborators need to re-clone
  - Mitigation: Check remote status first, get explicit user confirmation

- **BFG installation failure**: Tool may not be available on user's platform
  - Mitigation: Provide fallback with `git filter-branch` instructions

- **Repository corruption**: Git history rewrite could fail mid-operation
  - Mitigation: Backup exists, verify with `git fsck` after cleanup

## Notes

- This is the MOST CRITICAL plan in Phase 1 - the primary security fix
- BFG Repo-Cleaner protects HEAD by default (won't delete files in current commit unless explicitly removed first)
- The backup is ESSENTIAL - do not skip
- If BFG is not available, fallback to `git filter-repo` (faster than filter-branch)
- Do NOT push force to remote without explicit user confirmation
- After this plan, `.env` should be added to `.gitignore` (plan 01-03)

---

*Plan: 01-02 | Phase: 01-security-critical-fixes*
