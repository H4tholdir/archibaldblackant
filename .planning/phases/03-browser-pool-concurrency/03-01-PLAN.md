---
phase: 03-browser-pool-concurrency
plan: 01
type: execute
---

<objective>
Fix race conditions nel browser pool e nell'agentLock per rendere il sistema sicuro con concurrency > 1.

Purpose: Prerequisito per abilitare il parallelismo multi-utente. Senza queste fix, aumentare la concurrency del Worker causerebbe eviction di context attivi e rilascio cross-job del lock.
Output: agentLock con release sicura per jobId, browser pool con tracking context in-use, tutti i test aggiornati.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-browser-pool-concurrency/03-RESEARCH.md
@.planning/phases/03-browser-pool-concurrency/03-CONTEXT.md

@.planning/phases/02-operation-queue-core-fixes/02-02-SUMMARY.md

@archibald-web-app/backend/src/operations/agent-lock.ts
@archibald-web-app/backend/src/operations/agent-lock.spec.ts
@archibald-web-app/backend/src/operations/operation-processor.ts
@archibald-web-app/backend/src/operations/operation-processor.spec.ts
@archibald-web-app/backend/src/bot/browser-pool.ts
@archibald-web-app/backend/src/bot/browser-pool.spec.ts

**Established patterns (Phase 2):**
- AbortSignal bridge: addEventListener with { once: true }
- cancelJob + polling preemption with injectable config
- Promise.race timeout wrapping handler execution

**Constraining decisions:**
- Phase 2: Injectable preemptionConfig and getTimeout in ProcessorDeps for testability
- Phase 2: UnrecoverableError on AbortError to prevent BullMQ retry on timeout
</context>

<tasks>

<task type="auto">
  <name>Task 1: agentLock.release con verifica jobId</name>
  <files>archibald-web-app/backend/src/operations/agent-lock.ts, archibald-web-app/backend/src/operations/agent-lock.spec.ts, archibald-web-app/backend/src/operations/operation-processor.ts, archibald-web-app/backend/src/operations/operation-processor.spec.ts</files>
  <action>
**agent-lock.ts:**
- Modificare `release(userId: string)` in `release(userId: string, jobId: string): boolean`
- Dentro release: leggere `activeJobs.get(userId)`, se non esiste o `active.jobId !== jobId` ritornare `false` (non rilasciare). Se corrisponde, `activeJobs.delete(userId)` e ritornare `true`.
- NON toccare acquire, setStopCallback, getActive, getAllActive — solo release cambia.

**operation-processor.ts:**
- Nel `finally` block (linea 170-172), cambiare `agentLock.release(userId)` in `agentLock.release(userId, job.id)`.
- Il `lockAcquired` flag resta come guardia aggiuntiva.

**agent-lock.spec.ts:**
- Aggiungere test: "release with matching jobId returns true and frees lock"
- Aggiungere test: "release with mismatched jobId returns false and keeps lock"
- Aggiornare test esistenti che chiamano release(userId) per passare il jobId corretto.

**operation-processor.spec.ts:**
- Aggiornare i mock di agentLock.release nelle chiamate existing per verificare che passino job.id.
- Verificare che release venga chiamato con (userId, jobId) nel finally.

**Cosa evitare:** NON rendere release async — deve restare sincrono per non introdurre finestre di race condition nel finally block.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend && npm test --prefix archibald-web-app/backend</verify>
  <done>release accetta (userId, jobId), ritorna boolean, non rilascia se jobId non corrisponde. Tutti i test passano.</done>
</task>

<task type="auto">
  <name>Task 2: Browser pool tracking context in-use con protezione eviction</name>
  <files>archibald-web-app/backend/src/bot/browser-pool.ts, archibald-web-app/backend/src/bot/browser-pool.spec.ts, archibald-web-app/backend/src/operations/operation-processor.ts</files>
  <action>
**browser-pool.ts:**
- Aggiungere `const inUseContexts = new Set&lt;string&gt;()` accanto a contextPool e userLocks.
- Aggiungere `function markInUse(userId: string): void { inUseContexts.add(userId); }` — chiamato quando un job inizia a usare il context.
- Aggiungere `function markIdle(userId: string): void { inUseContexts.delete(userId); }` — chiamato quando il job rilascia il context.
- In `evictLeastRecentlyUsed()`: nel loop `for (const [userId, cached] of contextPool.entries())`, aggiungere `if (inUseContexts.has(userId)) continue;` prima del check LRU. Se TUTTI i context sono in-use e serve spazio, throw Error("Browser pool exhausted: all contexts in use") anziché evictare un context attivo.
- Esportare markInUse, markIdle nella return value e nel tipo BrowserPool.
- Aggiornare il tipo `BrowserPoolLike` in operation-processor.ts per includere `markInUse` e `markIdle` (opzionali con `?` per backward compat nei test).

**operation-processor.ts:**
- Dopo `browserPool.acquireContext(userId)` (linea 115), chiamare `browserPool.markInUse?.(userId)`.
- Prima di `browserPool.releaseContext(userId, context, true/false)` nel try e nel catch, chiamare `browserPool.markIdle?.(userId)`.
- L'ordine nel finally deve essere: markIdle → releaseContext → release agentLock.

**browser-pool.spec.ts:**
- Aggiungere test: "evictLeastRecentlyUsed skips in-use contexts" — riempire pool, marcare uno come in-use, verificare che l'eviction scelga un altro.
- Aggiungere test: "evictLeastRecentlyUsed throws when all contexts in use" — riempire pool, marcare tutti come in-use, verificare throw.
- Aggiungere test: "markInUse/markIdle lifecycle" — marcare in-use, verificare nel Set, marcare idle, verificare rimosso.

**Cosa evitare:** NON cambiare la logica di acquireContext o releaseContext esistente — aggiungere solo il tracking in-use come layer aggiuntivo. NON usare un lock distribuito — il Set in-memory basta per singolo processo.
  </action>
  <verify>npm run build --prefix archibald-web-app/backend && npm test --prefix archibald-web-app/backend</verify>
  <done>evictLeastRecentlyUsed non evicta mai context in-use. operation-processor chiama markInUse/markIdle nel lifecycle corretto. Tutti i test passano.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` succeeds
- [ ] `npm test --prefix archibald-web-app/backend` — all tests pass
- [ ] agentLock.release con jobId errato non rilascia il lock (verificato da test)
- [ ] eviction LRU salta context in-use (verificato da test)
- [ ] Nessun test pre-esistente rotto
</verification>

<success_criteria>

- agentLock.release è sicura: non rilascia lock di altri job
- Browser pool non evicta context attivamente in uso
- Tutti i test passano (pre-esistenti + nuovi)
- TypeScript compila senza errori
- Pronto per 03-02 (aumento concurrency)
</success_criteria>

<output>
After completion, create `.planning/phases/03-browser-pool-concurrency/03-01-SUMMARY.md`
</output>
