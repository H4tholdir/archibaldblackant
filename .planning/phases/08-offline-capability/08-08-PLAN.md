---
phase: 08-offline-capability
plan: 08
type: execute
---

<objective>
Implement stale data warning, force refresh mechanism, and handle edge cases for production-ready offline capability.

Purpose: Complete offline feature with cache age warnings (> 3 days), manual refresh, and robust error handling for corrupt cache, storage limits, and first-run online requirement.

Output: Production-ready offline capability with stale data warnings, force refresh, edge case handling, and Phase 8 complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-offline-capability/08-CONTEXT.md
@.planning/phases/08-offline-capability/08-07-SUMMARY.md

**From 08-CONTEXT.md:**
- **Warning Dati Stale**: Se i dati cached sono vecchi (es: 3 giorni), l'agente pu√≤ comunque creare ordini
  - Ma prima di inviare vede un warning: "Prezzi aggiornati 3 giorni fa. Continuare?"
  - Conferma esplicita - scelta informata, non blocco totale
- **First-run**: Al primo avvio l'agente DEVE essere online
  - Durante il sync iniziale (dopo login + PIN setup), l'app scarica tutti i dati
  - Da quel momento in poi, pu√≤ lavorare offline
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement stale cache warning modal</name>
  <files>archibald-web-app/frontend/src/components/StaleCacheWarning.tsx, archibald-web-app/frontend/src/components/OrderForm.tsx</files>
  <action>
Create `StaleCacheWarning.tsx` modal component:

```typescript
import { useState, useEffect } from 'react';
import { cacheService } from '../services/cache-service';

interface StaleCacheWarningProps {
  onConfirm: () => void;
  onCancel: () => void;
}

export function StaleCacheWarning({ onConfirm, onCancel }: StaleCacheWarningProps) {
  const [cacheAge, setCacheAge] = useState<number | null>(null);

  useEffect(() => {
    cacheService.getCacheAge().then(setCacheAge);
  }, []);

  if (cacheAge === null || cacheAge < 72) {
    return null; // Not stale (< 3 days)
  }

  const daysOld = Math.floor(cacheAge / 24);

  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 10000
    }}>
      <div style={{
        backgroundColor: '#fff',
        borderRadius: '8px',
        padding: '24px',
        maxWidth: '400px',
        boxShadow: '0 4px 16px rgba(0,0,0,0.2)'
      }}>
        <h3 style={{ marginTop: 0, color: '#f57c00' }}>
          ‚ö†Ô∏è Dati non aggiornati
        </h3>
        <p style={{ color: '#666', lineHeight: 1.5 }}>
          I prezzi e i prodotti sono stati aggiornati <strong>{daysOld} giorni fa</strong>.
        </p>
        <p style={{ color: '#666', lineHeight: 1.5 }}>
          Puoi continuare a creare l'ordine, ma i prezzi potrebbero non essere corretti.
          Consigliamo di aggiornare i dati prima di procedere.
        </p>
        <div style={{
          display: 'flex',
          gap: '12px',
          marginTop: '24px',
          justifyContent: 'flex-end'
        }}>
          <button
            onClick={onCancel}
            style={{
              padding: '8px 16px',
              borderRadius: '4px',
              border: '1px solid #ddd',
              backgroundColor: '#fff',
              cursor: 'pointer'
            }}
          >
            Annulla
          </button>
          <button
            onClick={onConfirm}
            style={{
              padding: '8px 16px',
              borderRadius: '4px',
              border: 'none',
              backgroundColor: '#f57c00',
              color: '#fff',
              cursor: 'pointer',
              fontWeight: 600
            }}
          >
            Continua comunque
          </button>
        </div>
      </div>
    </div>
  );
}
```

Integrate in OrderForm before order submission:

```typescript
const [showStaleWarning, setShowStaleWarning] = useState(false);

async function handleSubmitOrder() {
  // Check cache age before submitting
  const isStale = await cacheService.isCacheStale();

  if (isStale) {
    setShowStaleWarning(true);
    return; // Wait for user confirmation
  }

  // Proceed with order submission
  submitOrder();
}

function handleStaleConfirm() {
  setShowStaleWarning(false);
  submitOrder(); // User confirmed, proceed anyway
}

function handleStaleCancel() {
  setShowStaleWarning(false);
  // User cancelled, do nothing
}

// In render:
{showStaleWarning && (
  <StaleCacheWarning
    onConfirm={handleStaleConfirm}
    onCancel={handleStaleCancel}
  />
)}
```

Warning shown only when cache > 3 days old, explicit confirmation required.
  </action>
  <verify>Stale warning modal appears when cache > 3 days, allows continuation or cancellation</verify>
  <done>Stale cache warning modal integrated with explicit confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Add force refresh mechanism</name>
  <files>archibald-web-app/frontend/src/components/CacheRefreshButton.tsx, archibald-web-app/frontend/src/App.tsx</files>
  <action>
Create `CacheRefreshButton.tsx`:

```typescript
import { useState } from 'react';
import { cachePopulationService } from '../services/cache-population';

export function CacheRefreshButton() {
  const [refreshing, setRefreshing] = useState(false);
  const [progress, setProgress] = useState(0);

  async function handleRefresh() {
    const jwt = localStorage.getItem('archibald_jwt');
    if (!jwt) {
      alert('Devi effettuare il login per aggiornare i dati');
      return;
    }

    setRefreshing(true);

    const result = await cachePopulationService.populateCache(
      jwt,
      (prog) => setProgress(prog.percentage)
    );

    setRefreshing(false);

    if (result.success) {
      alert(`Dati aggiornati: ${result.recordCounts?.customers} clienti, ${result.recordCounts?.products} prodotti`);
    } else {
      alert(`Errore: ${result.error}`);
    }
  }

  return (
    <button
      onClick={handleRefresh}
      disabled={refreshing}
      style={{
        padding: '8px 16px',
        borderRadius: '4px',
        border: '1px solid #4caf50',
        backgroundColor: refreshing ? '#e0e0e0' : '#fff',
        color: '#4caf50',
        cursor: refreshing ? 'not-allowed' : 'pointer',
        fontWeight: 600
      }}
    >
      {refreshing ? `Aggiornamento... ${progress}%` : 'üîÑ Aggiorna dati'}
    </button>
  );
}
```

Add to App header for easy access:

```typescript
import { CacheRefreshButton } from './components/CacheRefreshButton';

// In App header:
<header>
  {/* Existing user info */}
  <CacheRefreshButton />
</header>
```

Manual refresh available anytime, shows progress percentage.
  </action>
  <verify>Refresh button triggers cache sync, shows progress, updates data successfully</verify>
  <done>Force refresh button with progress indicator integrated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stale data warning, force refresh, and edge case handling for production-ready offline capability</what-built>
  <how-to-verify>
**Test 1: Stale Cache Warning (> 3 days)**
1. Open DevTools ‚Üí Application ‚Üí IndexedDB ‚Üí ArchibaldOfflineDB ‚Üí cacheMetadata
2. Edit "customers" entry: change lastSynced to 4 days ago
3. OrderForm: Fill customer, add items, submit
4. Verify: Modal appears: "‚ö†Ô∏è Dati non aggiornati... 4 giorni fa"
5. Click "Annulla": Order not submitted
6. Submit again, click "Continua comunque": Order submits

**Test 2: Force Refresh**
1. Click "üîÑ Aggiorna dati" button in header
2. Verify: Progress shows "Aggiornamento... 45%"
3. Wait: Complete sync (< 5 seconds)
4. Verify: Alert "Dati aggiornati: 5000 clienti, 4500 prodotti"
5. Check IndexedDB: lastSynced timestamp is current

**Test 3: First-Run Online Requirement**
1. Clear all data: DevTools ‚Üí Application ‚Üí Clear storage
2. DevTools ‚Üí Network: Enable "Offline"
3. Reload app: Login modal appears
4. Verify: Cannot proceed (cache population fails without network)
5. Re-enable network, login
6. Verify: Cache sync starts automatically, app functional after sync

**Test 4: Corrupt Cache**
1. DevTools ‚Üí IndexedDB ‚Üí ArchibaldOfflineDB ‚Üí customers
2. Manually corrupt data (edit random records with invalid JSON)
3. Try to use OrderForm search
4. Verify: Graceful error handling (doesn't crash app)
5. Force refresh: Clears corrupt data and re-syncs

**Test 5: Storage Quota**
1. Check: DevTools ‚Üí Application ‚Üí Storage
2. Verify: Usage shows ~6-10 MB (well under quota)
3. Console: Storage quota logged during initialization

Expected results:
- Stale warning (> 3 days) requires explicit confirmation
- Force refresh works and updates cache timestamp
- First-run requires online (cache sync fails gracefully offline)
- Corrupt cache doesn't crash app
- Storage quota monitored and logged
- All edge cases handled gracefully
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe edge case issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] Stale cache warning modal (> 3 days) requires confirmation
- [ ] Force refresh button updates cache successfully
- [ ] First-run requires online (cannot work offline initially)
- [ ] Corrupt cache handled gracefully (no crash)
- [ ] Storage quota monitored and logged
- [ ] All edge cases tested and handled
- [ ] Human verification passed
- [ ] Phase 8 complete
</verification>

<success_criteria>

- Stale cache warning (> 3 days) with explicit confirmation
- Force refresh mechanism with progress indicator
- First-run online requirement enforced
- Corrupt cache error handling (graceful degradation)
- Storage quota monitoring
- All edge cases handled robustly
- Human verification checkpoint passed
- Phase 8 Offline Capability COMPLETE
  </success_criteria>

<output>
After completion, create `.planning/phases/08-offline-capability/08-08-SUMMARY.md`:

# Phase 8 Plan 08: Stale Data Warning & Edge Cases Summary

**Production-ready offline capability with stale data warnings, force refresh, and comprehensive edge case handling.**

## Accomplishments

- Stale cache warning modal (> 3 days) with explicit confirmation
- Force refresh button with progress indicator
- First-run online requirement enforced (cache sync)
- Corrupt cache error handling (graceful degradation)
- Storage quota monitoring
- Complete offline capability from Plan 08-01 through 08-08
- Banking app parity achieved (Intesa/UniCredit UX reference)

## Files Created/Modified

- `frontend/src/components/StaleCacheWarning.tsx` - Modal for stale data
- `frontend/src/components/CacheRefreshButton.tsx` - Manual refresh
- `frontend/src/components/OrderForm.tsx` - Integrated stale warning

## Decisions Made

- 3-day threshold for stale cache warning (from 08-CONTEXT.md)
- Explicit confirmation required (not blocking, user choice)
- Force refresh available anytime (not just on stale)
- First-run online enforced via auto-sync (no manual trigger)
- Graceful degradation on corrupt cache (app doesn't crash)

## Issues Encountered

[Document any issues or "None"]

## Next Step

**Phase 8 COMPLETE** ‚úÖ

Ready for Phase 9 (Offline Queue with conflict resolution) or continue with roadmap.

**Phase 8 Achievement:**
- ‚úÖ Cache automatica (IndexedDB, ~6 MB)
- ‚úÖ Ricerca < 100ms (CacheService)
- ‚úÖ Offline order queue (automatic sync)
- ‚úÖ Banking app UX (yellow banner, discrete progress)
- ‚úÖ Multi-level feedback (notifications + badge + list)
- ‚úÖ Stale data warning (> 3 days)
- ‚úÖ Full sync (delta deferred to Phase 9)
- ‚úÖ First-run online requirement
- ‚úÖ Edge cases handled (corrupt, quota, errors)

**Essential pillars achieved:**
1. ‚úÖ Affidabilit√† - Ordini non si perdono MAI (persistent queue)
2. ‚úÖ Trasparenza - L'agente vede sempre lo stato (banner + progress + list)
3. ‚úÖ Velocit√† - Ricerca < 100ms (verified in tests)
</output>
