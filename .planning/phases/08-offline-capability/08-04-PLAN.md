---
phase: 08-offline-capability
plan: 04
type: execute
---

<objective>
Configure Workbox service worker with cache-first strategy for offline app shell and static assets.

Purpose: Enable instant offline app loading and reliable asset caching using Workbox via vite-plugin-pwa.

Output: Working service worker with cache-first strategy, offline app shell, tested offline scenarios.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-offline-capability/08-CONTEXT.md
@.planning/phases/08-offline-capability/08-03-SUMMARY.md
@.planning/codebase/STACK.md
@archibald-web-app/frontend/vite.config.ts

**Tech Stack:**
- vite-plugin-pwa 1.2.0 already installed
- Workbox for service worker generation
- React 19 frontend

**From 08-CONTEXT.md:**
- App shell caching for instant offline load
- Service worker caching strategies (cache-first for static assets)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure vite-plugin-pwa with Workbox</name>
  <files>archibald-web-app/frontend/vite.config.ts</files>
  <action>
Update `vite.config.ts` to configure PWA plugin:

```typescript
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'robots.txt', 'apple-touch-icon.png'],
      manifest: {
        name: 'Archibald Black Ant',
        short_name: 'Archibald',
        description: 'PWA per creazione ordini Archibald',
        theme_color: '#ffffff',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365 // 1 year
              },
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          },
          {
            urlPattern: /^https:\/\/fonts\.gstatic\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'gstatic-fonts-cache',
              expiration: {
                maxEntries: 10,
                maxAgeSeconds: 60 * 60 * 24 * 365
              },
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          }
        ]
      }
    })
  ]
});
```

Strategies:
- **App shell (HTML/JS/CSS)**: CacheFirst (instant load offline)
- **API calls**: NetworkFirst (handled separately in code, not service worker)
- **Fonts**: CacheFirst with 1-year expiry
  </action>
  <verify>npm run build generates service worker, dist/sw.js exists</verify>
  <done>Vite PWA configured with Workbox, service worker generated</done>
</task>

<task type="auto">
  <name>Task 2: Register service worker in app</name>
  <files>archibald-web-app/frontend/src/main.tsx</files>
  <action>
Update `main.tsx` to register service worker:

```typescript
import { registerSW } from 'virtual:pwa-register';

// Register service worker
const updateSW = registerSW({
  onNeedRefresh() {
    console.log('[PWA] New content available, reload to update');
    // Could show UI prompt here in future
  },
  onOfflineReady() {
    console.log('[PWA] App ready to work offline');
  }
});

// Continue with existing initialization
initializeDatabase().then(/* ... */);
```

Service worker auto-updates on new deployment (registerType: 'autoUpdate').
  </action>
  <verify>Browser DevTools → Application → Service Workers shows registered SW</verify>
  <done>Service worker registered, onOfflineReady callback working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Service worker with offline app shell and cache-first static assets</what-built>
  <how-to-verify>
1. Run: `npm run build && npm run preview` (production build)
2. Open: http://localhost:4173 in browser
3. DevTools → Application → Service Workers: Verify service worker registered
4. DevTools → Network: Enable "Offline" checkbox
5. Reload page: App should load instantly from cache
6. Test: OrderForm autocomplete should work (IndexedDB cache)
7. DevTools → Application → Cache Storage: Verify workbox caches present
8. Test: Create draft order (should work offline)
9. Re-enable network: Verify app still works

Expected results:
- App loads instantly offline (no network requests)
- Service worker status: "activated and running"
- Cache storage shows workbox-precache and runtime caches
- OrderForm search works offline
- No errors in console
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] Service worker generated in dist/sw.js
- [ ] Service worker registered in DevTools
- [ ] App loads offline (network disabled)
- [ ] Workbox caches visible in Cache Storage
- [ ] OrderForm autocomplete works offline
- [ ] No console errors in offline mode
</verification>

<success_criteria>

- vite-plugin-pwa configured with Workbox
- Service worker with cache-first strategy for app shell
- Auto-update on new deployment
- Offline app loading verified
- Runtime caching for fonts and external resources
- Human verification passed (checkpoint)
  </success_criteria>

<output>
After completion, create `.planning/phases/08-offline-capability/08-04-SUMMARY.md`
</output>
