---
phase: 08-offline-capability
plan: 05
type: tdd
---

<objective>
Implement draft order auto-save and restoration for seamless offline editing.

Purpose: Prevent data loss by automatically saving draft orders to IndexedDB as user types, and restoring on app launch.

Output: Working draft auto-save with tests, draft restoration on app load, draft management UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-offline-capability/08-CONTEXT.md
@.planning/phases/08-offline-capability/08-04-SUMMARY.md
@archibald-web-app/frontend/src/db/schema.ts
@archibald-web-app/frontend/src/components/OrderForm.tsx

**From 08-CONTEXT.md:**
- Affidabilità: Ordini non si perdono MAI
- L'ordine va in coda automatica per sync in background
- Draft orders persist across sessions
</context>

<feature>
  <name>Draft order auto-save with IndexedDB</name>
  <files>archibald-web-app/frontend/src/services/draft-service.ts, archibald-web-app/frontend/src/services/draft-service.spec.ts</files>
  <behavior>
### Expected Behavior

**Auto-save:**
- Debounced save (1 second after last change)
- Saves to draftOrders table in IndexedDB
- Updates existing draft if present (upsert)

**Restoration:**
- On app launch, check for draft
- If found, populate OrderForm with draft data
- Show "Ripristinata bozza" message

**Draft Management:**
- saveDraft(customer, items) → saves/updates draft
- getDraft() → returns most recent draft or null
- clearDraft() → deletes draft after order submitted

### Test Cases

```typescript
it('should save draft with debounce');
it('should update existing draft (upsert)');
it('should restore most recent draft');
it('should clear draft after submission');
it('should handle multiple drafts (keep latest)');
```
  </behavior>
  <implementation>
**RED:** Write failing tests
**GREEN:** Implement DraftService
**REFACTOR:** Integrate with OrderForm (useEffect for auto-save)
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>RED: Write failing tests for DraftService</name>
  <files>archibald-web-app/frontend/src/services/draft-service.spec.ts</files>
  <action>
Create test file with behavior tests from above. Tests must fail initially.

Commit: `test(08-05): add failing tests for draft order persistence`
  </action>
  <verify>npm test shows failing DraftService tests</verify>
  <done>Test suite created and failing</done>
</task>

<task type="auto">
  <name>GREEN: Implement DraftService</name>
  <files>archibald-web-app/frontend/src/services/draft-service.ts</files>
  <action>
Create DraftService with methods:

```typescript
export class DraftService {
  async saveDraft(customerId: string, customerName: string, items: DraftOrderItem[]): Promise<void> {
    const existing = await this.getDraft();

    const draft: DraftOrder = {
      id: existing?.id, // Reuse ID for upsert
      customerId,
      customerName,
      items,
      createdAt: existing?.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    await db.draftOrders.put(draft);
  }

  async getDraft(): Promise<DraftOrder | null> {
    // Get most recent draft
    const drafts = await db.draftOrders.orderBy('updatedAt').reverse().limit(1).toArray();
    return drafts[0] || null;
  }

  async clearDraft(): Promise<void> {
    await db.draftOrders.clear();
  }
}
```

Tests must pass.

Commit: `feat(08-05): implement draft order auto-save to IndexedDB`
  </action>
  <verify>npm test shows all DraftService tests passing</verify>
  <done>DraftService implemented and tested</done>
</task>

<task type="auto">
  <name>REFACTOR: Integrate auto-save in OrderForm</name>
  <files>archibald-web-app/frontend/src/components/OrderForm.tsx</files>
  <action>
Add draft auto-save to OrderForm:

```typescript
import { draftService } from '../services/draft-service';
import { useEffect, useCallback, useRef } from 'react';

// Debounced auto-save
const saveTimeoutRef = useRef<NodeJS.Timeout>();

useEffect(() => {
  if (selectedCustomer && items.length > 0) {
    // Clear previous timeout
    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current);
    }

    // Debounce 1 second
    saveTimeoutRef.current = setTimeout(() => {
      draftService.saveDraft(selectedCustomer.id, selectedCustomer.name, items);
      console.log('[Draft] Auto-saved');
    }, 1000);
  }

  return () => {
    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current);
    }
  };
}, [selectedCustomer, items]);

// Restore draft on mount
useEffect(() => {
  async function restoreDraft() {
    const draft = await draftService.getDraft();
    if (draft) {
      // Populate form with draft data
      setSelectedCustomer({ id: draft.customerId, name: draft.customerName });
      setItems(draft.items);
      console.log('[Draft] Restored from', new Date(draft.updatedAt));
    }
  }
  restoreDraft();
}, []);

// Clear draft after successful order submission
async function handleSubmitOrder() {
  // ... existing submit logic ...
  await draftService.clearDraft();
}
```

Commit: `refactor(08-05): integrate draft auto-save in OrderForm`
  </action>
  <verify>OrderForm auto-saves draft after 1s, restores on reload, clears after submit</verify>
  <done>Draft auto-save integrated with OrderForm</done>
</task>

</tasks>

<verification>
- [ ] All DraftService tests passing
- [ ] OrderForm auto-saves draft (1s debounce)
- [ ] Draft restored on app reload
- [ ] Draft cleared after order submission
- [ ] No data loss on app close/crash
</verification>

<success_criteria>

- DraftService implemented via TDD
- Auto-save with 1s debounce
- Draft restoration on app launch
- Draft cleared after successful submission
- 3 atomic commits (test, feat, refactor)
  </success_criteria>

<output>
After completion, create `.planning/phases/08-offline-capability/08-05-SUMMARY.md`
</output>
