# Phase 7 Plan 1: Web Crypto API Research & Encryption Strategy

<objective>
Research Web Crypto API best practices and design encryption strategy for secure credential storage.

**Purpose:** Establish solid understanding of browser-native encryption before implementation. This is foundational research that informs all subsequent plans.

**Output:** Documented encryption strategy with API patterns, key derivation approach, and security considerations ready for implementation.
</objective>

<execution_context>
@.planning/phases/07-credential-management/07-CONTEXT.md
@archibald-web-app/frontend/src/hooks/useAuth.ts (current auth implementation)
@archibald-web-app/frontend/src/api/auth.ts (current auth API)
</execution_context>

<context>
**Current State (Phase 6):**
- JWT authentication with 8h expiry
- localStorage stores JWT token only (key: 'archibald_jwt')
- Passwords NEVER stored - used only for login validation via Puppeteer
- Backend completely stateless - no credential storage
- useAuth hook manages auth state with localStorage persistence

**Phase 7 Goal:**
Storage sicuro credenziali su device con Web Crypto API, backend stateless

**User Vision:**
Checkbox "Ricorda credenziali" → dopo login successo → setup PIN/biometrica → prossimi accessi: sblocco con PIN/biometrica → login automatico

**Essential Requirements:**
1. Credenziali cifrate con Web Crypto API (standard browser)
2. Chiave di cifratura derivata dal PIN/biometrica, mai salvata in chiaro
3. Se qualcuno accede al device o ispeziona IndexedDB, non può leggere le password

**Research Topics:**
- Web Crypto API encryption/decryption patterns (AES-GCM recommended)
- Key derivation from PIN using PBKDF2 or Argon2
- IndexedDB encrypted credential storage
- Cross-platform biometric access (Web Authentication API / WebAuthn)
- Banking app security patterns (Intesa, UniCredit reference)

**Out of Scope:**
- Sync credenziali tra device (ogni device salva localmente)
- Recupero password dimenticata Archibald (amministratore reset)
- Rotazione credenziali Archibald (utente manuale)
</context>

<tasks>

<task id="1" type="auto">
<files>
- Web Crypto API documentation (MDN, W3C specs)
- WebAuthn / Web Authentication API documentation
- Security best practices for credential storage
- Banking app security patterns (research)
</files>

<action>
Research and document Web Crypto API encryption strategy:

1. **Web Crypto API Fundamentals:**
   - Study SubtleCrypto interface for encryption/decryption
   - AES-GCM algorithm (recommended for authenticated encryption)
   - Key generation and key derivation functions (PBKDF2, HKDF)
   - Random IV generation for each encryption

2. **Key Derivation from PIN:**
   - PBKDF2 (Password-Based Key Derivation Function 2) for PIN → encryption key
   - Salt generation and storage strategy (per-user random salt)
   - Iteration count recommendations (100,000+ for security vs UX)
   - Key format and length (256-bit AES-GCM key)

3. **Credential Encryption Pattern:**
   - Encrypt username/password as JSON object
   - Store encrypted data + IV + salt in IndexedDB
   - Decryption flow: PIN → derive key → decrypt credentials

4. **Cross-Platform Biometric Access:**
   - Web Authentication API (WebAuthn) availability on target platforms
   - Fallback strategy: PIN when biometric unavailable
   - User verification modes (biometric vs PIN)

5. **Security Considerations:**
   - No plaintext credentials in memory after encryption
   - Secure random generation (crypto.getRandomValues)
   - Timing attack mitigation
   - Key derivation iteration tuning (security vs UX)

Create research document: `.planning/phases/07-credential-management/07-RESEARCH.md`

Document structure:
```markdown
# Phase 7: Credential Management - Research

## Web Crypto API Encryption Strategy

### Algorithm Choice: AES-GCM
[rationale, advantages, code examples]

### Key Derivation: PBKDF2
[PIN → key derivation flow, iteration count, salt strategy]

### Credential Storage Schema
[IndexedDB structure, encrypted data format]

### Cross-Platform Biometric Support
[WebAuthn patterns, platform availability, fallback strategy]

### Security Audit Checklist
[what to verify before Phase 7 complete]

## Implementation Patterns

### Encryption Flow
[pseudo-code or TypeScript interfaces]

### Decryption Flow
[pseudo-code or TypeScript interfaces]

### Error Handling
[wrong PIN, decryption failure, key derivation timeout]

## Recommended Libraries
[native Web Crypto API vs third-party, trade-offs]

## References
[MDN links, W3C specs, security papers]
```
</action>

<verify>
- [ ] Research document created at `.planning/phases/07-credential-management/07-RESEARCH.md`
- [ ] Document covers: AES-GCM encryption, PBKDF2 key derivation, IndexedDB schema, WebAuthn patterns
- [ ] Security considerations documented (no plaintext, timing attacks, iteration count)
- [ ] Cross-platform biometric support assessed (iOS, Android, desktop)
- [ ] Implementation patterns ready for coding (encryption/decryption flows)
- [ ] References section includes MDN, W3C specs, security best practices
</verify>

<done>
Research complete. You have:
- Comprehensive encryption strategy documented
- Key derivation approach (PBKDF2 from PIN)
- IndexedDB credential storage schema
- Cross-platform biometric patterns (WebAuthn + PIN fallback)
- Security checklist for Phase 7 completion

Next: Plan 07-02 will implement IndexedDB credential store with encryption based on this research.
</done>
</task>

</tasks>

<verification>
**Success Criteria:**
- [x] 07-RESEARCH.md document created with comprehensive encryption strategy
- [x] Web Crypto API patterns documented (AES-GCM, PBKDF2, random IV)
- [x] Key derivation from PIN strategy clear (salt, iterations, key length)
- [x] IndexedDB schema designed for encrypted credentials
- [x] Cross-platform biometric support assessed (WebAuthn + fallback)
- [x] Security considerations documented
- [x] Implementation patterns ready for next plan

**Quality Gates:**
- Research covers all essential requirements from 07-CONTEXT.md
- Strategy aligns with banking app security patterns
- No plaintext credential storage anywhere in proposed architecture
- Cross-platform compatibility confirmed (Android, iOS, iPad, Windows, Mac)
</verification>

<success_criteria>
Phase 7 Plan 1 succeeds when:

1. **Research Document Complete:**
   - 07-RESEARCH.md exists with all sections filled
   - Encryption strategy uses Web Crypto API (no third-party crypto libs)
   - Key derivation approach documented (PBKDF2 with proper iteration count)

2. **Security Requirements Met:**
   - Strategy ensures no plaintext credentials in storage
   - Key never stored in clear (derived from PIN each time)
   - Random salt per user, random IV per encryption
   - Timing attack considerations documented

3. **Cross-Platform Strategy Clear:**
   - WebAuthn support assessed for target platforms
   - PIN fallback strategy documented
   - Banking app UX patterns (Intesa, UniCredit) referenced

4. **Implementation Ready:**
   - Clear pseudo-code or TypeScript interfaces for encrypt/decrypt
   - IndexedDB schema defined (what to store: encrypted data, IV, salt)
   - Error handling patterns documented (wrong PIN, decrypt failure)

5. **Next Steps Obvious:**
   - Plan 07-02 can immediately implement IndexedDB store based on this research
   - No major open questions remain about encryption approach
</success_criteria>

<output>
**Deliverables:**
1. `.planning/phases/07-credential-management/07-RESEARCH.md` - Comprehensive research document
2. Encryption strategy: AES-GCM + PBKDF2 key derivation
3. IndexedDB schema design for encrypted credentials
4. Cross-platform biometric support assessment
5. Security audit checklist for Phase 7 completion

**Key Decisions:**
- Encryption algorithm: AES-GCM (authenticated encryption)
- Key derivation: PBKDF2 from PIN (100k+ iterations)
- Storage: IndexedDB with encrypted credentials + IV + salt
- Biometric: WebAuthn where available, PIN fallback

**Blockers Removed:**
- Clear understanding of Web Crypto API patterns
- Key derivation strategy decided (no guesswork in implementation)
- Cross-platform compatibility confirmed

**Ready for:** Plan 07-02 (IndexedDB credential store implementation)
</output>

---

**Phase:** 07-credential-management
**Plan:** 01 of 06
**Type:** Research (no code changes)
**Estimated Duration:** 45-60 min
