# Phase 7 Plan 4: PIN Unlock Flow & Auto-Login

<objective>
Implement PIN unlock screen for returning users and automatic login with stored credentials.

**Purpose:** Complete the credential management cycle. User with saved credentials sees unlock screen (not login form), enters PIN, app auto-logins using decrypted credentials. Banking app UX.

**Output:** Full unlock→auto-login flow operational. Users enter PIN once to access app, no password re-entry.
</objective>

<execution_context>
@.planning/phases/07-credential-management/07-CONTEXT.md (unlock flow vision)
@.planning/phases/07-credential-management/07-RESEARCH.md (security patterns)
@archibald-web-app/frontend/src/services/credential-store.ts (decrypt credentials)
@archibald-web-app/frontend/src/hooks/useAuth.ts (auth state)
@archibald-web-app/frontend/src/components/LoginModal.tsx (current login UI)
@archibald-web-app/frontend/src/components/PinInput.tsx (from Plan 07-03)
</execution_context>

<context>
**Current State (Plan 07-03):**
- "Ricorda credenziali" checkbox functional
- PIN setup wizard stores encrypted credentials
- IndexedDB contains encrypted credentials for users who opted in
- Login form still shows username/password fields every time

**User Vision from 07-CONTEXT.md:**
> Quando l'agente torna nell'app (dopo aver chiuso e riaperto), non deve digitare username/password. Invece:
> 1. L'app mostra schermata di sblocco con logo/username
> 2. L'agente sblocca con PIN o biometrica
> 3. L'app fa login automatico ad Archibald usando le credenziali salvate cifrate
> 4. L'agente entra direttamente nell'app, pronto a creare ordini

**Implementation Goals:**
1. On app mount, check if credentials exist in IndexedDB for last user
2. If credentials exist → show unlock screen (NOT login form)
3. Unlock screen shows: logo, username (from last login), PIN input
4. User enters PIN → decrypt credentials → auto-login to backend
5. Success → JWT stored → app loads
6. Failed PIN → error message, retry (3 attempts before fallback)
7. Link "PIN dimenticato?" → reset flow (delete credentials, back to login)

**Flow Decision Logic:**
```
App Mount
  ↓
Check localStorage for lastUserId
  ↓
lastUserId exists?
  ├─ NO → Show LoginModal (standard login)
  └─ YES → Check IndexedDB for credentials
            ↓
            Credentials exist for lastUserId?
              ├─ NO → Show LoginModal
              └─ YES → Show UnlockScreen
                         ↓
                         User enters PIN
                         ↓
                         Decrypt credentials
                         ↓
                         Success?
                           ├─ YES → Auto-login to backend → App loads
                           └─ NO → Error, retry (max 3 attempts)
                                     ↓
                                     3 failed attempts → "PIN dimenticato?" flow
```

**UnlockScreen UI (Banking App Style):**
```
┌─────────────────────────────────┐
│                                 │
│          [App Logo]             │
│                                 │
│     Bentornato, Francesco!      │ ← fullName from lastUser
│                                 │
│     Inserisci il PIN            │
│                                 │
│   ┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐
│   │ • ││ • ││ • ││   ││   ││   │ ← PinInput (shows dots)
│   └───┘└───┘└───┘└───┘└───┘└───┘
│                                 │
│   [PIN dimenticato?]            │ ← Link to reset flow
│                                 │
│   [Usa un altro account]        │ ← Show LoginModal instead
│                                 │
└─────────────────────────────────┘
```

**Error Handling:**
- Wrong PIN (1st/2nd attempt): "PIN errato. Riprova."
- Wrong PIN (3rd attempt): "PIN errato. Ultimo tentativo rimanente."
- 3 failed attempts: Show "PIN dimenticato?" message prominently
- Decryption fails: Treat as wrong PIN
- Backend login fails: Show error, keep unlock screen (may be network issue)

**PIN Recovery Flow:**
User clicks "PIN dimenticato?" →
```
Conferma: "Cancellare le credenziali salvate?
Dovrai inserire di nuovo username e password Archibald."

[Annulla] [Cancella credenziali]
```

If confirmed:
1. Delete credentials from IndexedDB
2. Clear lastUserId from localStorage
3. Show LoginModal (standard login)
</context>

<tasks>

<task id="1" type="auto">
<files>
- archibald-web-app/frontend/src/components/UnlockScreen.tsx (NEW)
</files>

<action>
Create UnlockScreen component with PIN input and auto-login flow.

File: `archibald-web-app/frontend/src/components/UnlockScreen.tsx`

```typescript
import { useState, useEffect } from 'react';
import { PinInput } from './PinInput';

interface UnlockScreenProps {
  userId: string;
  fullName: string;
  onUnlock: (username: string, password: string) => Promise<boolean>;
  onForgotPin: () => void;
  onSwitchAccount: () => void;
}

export function UnlockScreen({
  userId,
  fullName,
  onUnlock,
  onForgotPin,
  onSwitchAccount,
}: UnlockScreenProps) {
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');
  const [isUnlocking, setIsUnlocking] = useState(false);
  const [attempts, setAttempts] = useState(0);

  useEffect(() => {
    // Auto-submit when PIN complete
    if (pin.length === 6 && !isUnlocking) {
      handleUnlock();
    }
  }, [pin]);

  const handleUnlock = async () => {
    setIsUnlocking(true);
    setError('');

    try {
      // Import CredentialStore
      const { getCredentialStore } = await import('../services/credential-store');
      const credStore = getCredentialStore();
      await credStore.initialize();

      // Decrypt credentials with PIN
      const credentials = await credStore.getCredentials(userId, pin);

      if (!credentials) {
        // Wrong PIN or decryption failed
        const newAttempts = attempts + 1;
        setAttempts(newAttempts);

        if (newAttempts >= 3) {
          setError('Troppi tentativi errati. Usa "PIN dimenticato?" per reimpostare.');
        } else if (newAttempts === 2) {
          setError('PIN errato. Ultimo tentativo rimanente.');
        } else {
          setError('PIN errato. Riprova.');
        }

        setPin('');
        setIsUnlocking(false);
        return;
      }

      // Credentials decrypted, attempt auto-login
      const loginSuccess = await onUnlock(credentials.username, credentials.password);

      if (!loginSuccess) {
        setError('Errore durante il login. Verifica la connessione.');
        setPin('');
        setIsUnlocking(false);
        return;
      }

      // Success - onUnlock handles navigation
    } catch (err) {
      setError('Errore imprevisto. Riprova.');
      setPin('');
      setIsUnlocking(false);
    }
  };

  return (
    <div className="unlock-screen">
      <div className="unlock-container">
        <div className="unlock-logo">
          {/* App logo placeholder */}
          <div className="logo-circle">A</div>
        </div>

        <div className="unlock-greeting">
          <h2>Bentornato, {fullName.split(' ')[0]}!</h2>
          <p className="unlock-subtitle">Inserisci il PIN per accedere</p>
        </div>

        <div className="unlock-pin-area">
          <PinInput
            value={pin}
            onChange={setPin}
            autoFocus
          />
        </div>

        {error && <div className="unlock-error">{error}</div>}

        {isUnlocking && (
          <div className="unlock-loading">Accesso in corso...</div>
        )}

        <div className="unlock-actions">
          <button
            onClick={onForgotPin}
            className="unlock-link"
            disabled={isUnlocking}
          >
            PIN dimenticato?
          </button>

          <button
            onClick={onSwitchAccount}
            className="unlock-link"
            disabled={isUnlocking}
          >
            Usa un altro account
          </button>
        </div>
      </div>
    </div>
  );
}
```

**CSS Styles:**

Add to `archibald-web-app/frontend/src/App.css`:

```css
/* Unlock Screen */
.unlock-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

.unlock-container {
  background: white;
  border-radius: 20px;
  padding: 3rem 2rem;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  text-align: center;
}

.unlock-logo {
  margin-bottom: 2rem;
}

.logo-circle {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
  font-weight: bold;
  color: white;
  margin: 0 auto;
}

.unlock-greeting h2 {
  font-size: 1.8rem;
  margin: 0 0 0.5rem 0;
  color: #333;
}

.unlock-subtitle {
  color: #666;
  font-size: 1rem;
  margin: 0;
}

.unlock-pin-area {
  margin: 2rem 0;
}

.unlock-error {
  color: #dc3545;
  font-size: 0.9rem;
  margin-top: 1rem;
  min-height: 1.5rem;
}

.unlock-loading {
  color: #007bff;
  font-size: 0.9rem;
  margin-top: 1rem;
}

.unlock-actions {
  margin-top: 2rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.unlock-link {
  background: transparent;
  border: none;
  color: #007bff;
  font-size: 0.95rem;
  cursor: pointer;
  padding: 0.5rem;
  transition: color 0.2s;
}

.unlock-link:hover:not(:disabled) {
  color: #0056b3;
  text-decoration: underline;
}

.unlock-link:disabled {
  color: #ccc;
  cursor: not-allowed;
}
```

Run: `npm run build` to verify compilation
</action>

<verify>
- [ ] UnlockScreen.tsx created with PIN input
- [ ] Auto-submit when PIN complete (6 digits)
- [ ] Error handling for wrong PIN (3 attempts)
- [ ] "PIN dimenticato?" and "Usa un altro account" links
- [ ] Banking app styling (gradient background, clean card)
- [ ] CSS styles added
- [ ] npm run build succeeds
</verify>

<done>
UnlockScreen component created. Ready to integrate with App.tsx flow logic.
</done>
</task>

<task id="2" type="auto">
<files>
- archibald-web-app/frontend/src/hooks/useAuth.ts
- archibald-web-app/frontend/src/App.tsx
</files>

<action>
Integrate UnlockScreen into app mount flow with lastUser detection.

**Step 1: Add lastUser persistence to useAuth**

In `archibald-web-app/frontend/src/hooks/useAuth.ts`:

1. Add LAST_USER_KEY constant:
```typescript
const TOKEN_KEY = 'archibald_jwt';
const LAST_USER_KEY = 'archibald_last_user'; // NEW
```

2. Update AuthState to include lastUser info:
```typescript
export interface AuthState {
  isAuthenticated: boolean;
  user: authApi.User | null;
  token: string | null;
  isLoading: boolean;
  error: string | null;
  needsPinSetup: boolean;
  lastUser: { userId: string; fullName: string } | null; // NEW
}
```

3. On mount, check for lastUser:
```typescript
useEffect(() => {
  // Load last user info
  const lastUserJson = localStorage.getItem(LAST_USER_KEY);
  const lastUser = lastUserJson ? JSON.parse(lastUserJson) : null;

  const token = localStorage.getItem(TOKEN_KEY);
  if (token) {
    // Existing JWT validation...
  } else if (lastUser) {
    // No token but have lastUser → prepare unlock flow
    setState(prev => ({ ...prev, lastUser, isLoading: false }));
  } else {
    // No token, no lastUser → standard login
    setState(prev => ({ ...prev, isLoading: false }));
  }
}, []);
```

4. Save lastUser on successful login:
```typescript
const login = async (
  username: string,
  password: string,
  rememberCredentials: boolean = false
): Promise<boolean> => {
  // ... existing login logic

  if (response.success && response.token && response.user) {
    localStorage.setItem(TOKEN_KEY, response.token);

    // NEW: Save lastUser for unlock flow
    if (rememberCredentials) {
      const lastUser = {
        userId: response.user.id,
        fullName: response.user.fullName,
      };
      localStorage.setItem(LAST_USER_KEY, JSON.stringify(lastUser));
    }

    setState({
      isAuthenticated: true,
      user: response.user,
      token: response.token,
      isLoading: false,
      error: null,
      needsPinSetup: rememberCredentials,
      lastUser: rememberCredentials ? lastUser : null,
    });
    return true;
  }
};
```

5. Add unlockWithPin method:
```typescript
const unlockWithPin = async (username: string, password: string): Promise<boolean> => {
  setState(prev => ({ ...prev, isLoading: true, error: null }));

  try {
    // Use existing login API (same as manual login)
    const response = await authApi.login({ username, password });

    if (response.success && response.token && response.user) {
      localStorage.setItem(TOKEN_KEY, response.token);
      setState({
        isAuthenticated: true,
        user: response.user,
        token: response.token,
        isLoading: false,
        error: null,
        needsPinSetup: false,
        lastUser: { userId: response.user.id, fullName: response.user.fullName },
      });
      return true;
    } else {
      setState(prev => ({
        ...prev,
        isLoading: false,
        error: response.error || 'Unlock failed',
      }));
      return false;
    }
  } catch (error) {
    setState(prev => ({
      ...prev,
      isLoading: false,
      error: 'Network error',
    }));
    return false;
  }
};
```

6. Add clearLastUser method (for "PIN dimenticato" flow):
```typescript
const clearLastUser = async () => {
  const lastUserJson = localStorage.getItem(LAST_USER_KEY);
  if (lastUserJson) {
    const lastUser = JSON.parse(lastUserJson);

    // Delete credentials from IndexedDB
    const { getCredentialStore } = await import('../services/credential-store');
    const credStore = getCredentialStore();
    await credStore.initialize();
    await credStore.deleteCredentials(lastUser.userId);
  }

  // Clear lastUser from localStorage
  localStorage.removeItem(LAST_USER_KEY);
  setState(prev => ({ ...prev, lastUser: null }));
};
```

7. Add switchAccount method:
```typescript
const switchAccount = () => {
  // Keep credentials but switch to login form
  setState(prev => ({ ...prev, lastUser: null }));
};
```

8. Return new methods:
```typescript
return {
  ...state,
  login,
  logout,
  completePinSetup,
  skipPinSetup,
  unlockWithPin,      // NEW
  clearLastUser,      // NEW
  switchAccount,      // NEW
};
```

**Step 2: Update App.tsx to show UnlockScreen or LoginModal**

In `archibald-web-app/frontend/src/App.tsx`:

1. Import UnlockScreen:
```typescript
import { UnlockScreen } from './components/UnlockScreen';
```

2. Add state to track if user wants login form instead of unlock:
```typescript
const [showLoginForm, setShowLoginForm] = useState(false);
```

3. Update authentication UI logic:
```typescript
const {
  isAuthenticated,
  isLoading,
  lastUser,
  login,
  unlockWithPin,
  clearLastUser,
  switchAccount,
  // ... other auth methods
} = useAuth();

// Determine which screen to show
const showUnlock = !isAuthenticated && !isLoading && lastUser && !showLoginForm;
const showLogin = !isAuthenticated && !isLoading && (!lastUser || showLoginForm);

return (
  <div className="app">
    {/* Unlock Screen */}
    {showUnlock && (
      <UnlockScreen
        userId={lastUser.userId}
        fullName={lastUser.fullName}
        onUnlock={unlockWithPin}
        onForgotPin={async () => {
          const confirmed = window.confirm(
            'Cancellare le credenziali salvate? Dovrai inserire di nuovo username e password Archibald.'
          );
          if (confirmed) {
            await clearLastUser();
            setShowLoginForm(true);
          }
        }}
        onSwitchAccount={() => {
          switchAccount();
          setShowLoginForm(true);
        }}
      />
    )}

    {/* Login Modal (standard login) */}
    {showLogin && (
      <LoginModal
        // ... existing props
      />
    )}

    {/* Main App UI (when authenticated) */}
    {isAuthenticated && (
      // ... existing app UI
    )}
  </div>
);
```

Run: `npm run build` to verify integration
</action>

<verify>
- [ ] useAuth tracks lastUser in localStorage (key: 'archibald_last_user')
- [ ] useAuth saves lastUser on successful login with rememberCredentials
- [ ] useAuth exposes unlockWithPin, clearLastUser, switchAccount methods
- [ ] App.tsx shows UnlockScreen when lastUser exists
- [ ] App.tsx shows LoginModal when no lastUser or showLoginForm=true
- [ ] "PIN dimenticato?" shows confirmation dialog and clears credentials
- [ ] "Usa un altro account" switches to LoginModal
- [ ] npm run build succeeds
</verify>

<done>
UnlockScreen integrated into app flow. Auto-shows unlock screen for returning users with saved credentials.
</done>
</task>

<task id="3" type="checkpoint:human-verify">
<files>
- Browser: http://localhost:5173
- Browser DevTools → Application → Local Storage
- Browser DevTools → Application → IndexedDB
</files>

<action>
**Manual UAT Checkpoint**

User should verify complete unlock flow:

1. **Initial Setup (if not done in Plan 07-03):**
   - Login with checkbox "Ricorda credenziali" checked
   - Complete PIN setup (e.g., PIN: `789456`)
   - Verify credentials stored in IndexedDB
   - ✅ App loads normally after PIN setup

2. **Test Unlock Flow:**
   - Close browser tab completely
   - Reopen http://localhost:5173
   - ✅ UnlockScreen appears (NOT LoginModal)
   - ✅ Shows greeting "Bentornato, Francesco!" (or user's first name)
   - ✅ Shows PIN input (6 boxes)
   - Enter correct PIN: `789456`
   - ✅ Auto-submits when 6 digits entered
   - ✅ Shows "Accesso in corso..." briefly
   - ✅ Puppeteer login runs (see backend logs)
   - ✅ App loads with authenticated state

3. **Test Wrong PIN:**
   - Logout and close tab
   - Reopen → UnlockScreen appears
   - Enter wrong PIN: `000000`
   - ✅ Shows error: "PIN errato. Riprova."
   - ✅ PIN input clears for retry
   - Enter wrong PIN again: `111111`
   - ✅ Shows error: "PIN errato. Ultimo tentativo rimanente."
   - Enter wrong PIN third time: `222222`
   - ✅ Shows error: "Troppi tentativi errati. Usa 'PIN dimenticato?' per reimpostare."
   - ✅ Can still retry with correct PIN (no hard lockout)

4. **Test "PIN dimenticato?" Flow:**
   - Click "PIN dimenticato?" link
   - ✅ Confirmation dialog appears: "Cancellare le credenziali salvate? Dovrai inserire di nuovo username e password Archibald."
   - Click "Annulla" → ✅ Dialog closes, still on UnlockScreen
   - Click "PIN dimenticato?" again
   - Click "OK" → ✅ Credentials deleted from IndexedDB
   - ✅ LoginModal appears (standard login form)
   - ✅ No UnlockScreen on next visit (lastUser cleared)

5. **Test "Usa un altro account" Flow:**
   - Setup: Login with "Ricorda credenziali" and PIN
   - Close and reopen → UnlockScreen appears
   - Click "Usa un altro account"
   - ✅ LoginModal appears immediately
   - ✅ Credentials still in IndexedDB (not deleted)
   - Login with different credentials → ✅ Works normally

6. **Test localStorage Persistence:**
   - DevTools → Application → Local Storage → http://localhost:5173
   - ✅ Find key: `archibald_last_user`
   - ✅ Value is JSON: `{"userId":"...", "fullName":"Francesco Formicola"}`
   - After "PIN dimenticato?" → ✅ Key deleted
   - After "Usa un altro account" → ✅ Key still present

**Expected Outcome:**
✅ UnlockScreen appears for returning users (saved credentials)
✅ Correct PIN → auto-login → app loads
✅ Wrong PIN → error + retry (3 attempts tracked)
✅ "PIN dimenticato?" → confirm → delete credentials → LoginModal
✅ "Usa un altro account" → LoginModal (credentials preserved)

User confirms: "verified" or reports issues
</action>

<verify>
User confirms:
- [ ] UnlockScreen appears on app reopen (saved credentials)
- [ ] Greeting shows user's first name
- [ ] Correct PIN auto-submits and logs in successfully
- [ ] Wrong PIN shows error and allows retry
- [ ] 3 wrong attempts shows prominent error message
- [ ] "PIN dimenticato?" deletes credentials and shows LoginModal
- [ ] "Usa un altro account" shows LoginModal but keeps credentials
- [ ] localStorage contains lastUser data
- [ ] Auto-login via Puppeteer works (backend logs confirm)
</verify>

<done>
Manual verification complete. Unlock flow operational with auto-login.
</done>
</task>

</tasks>

<verification>
**Success Criteria:**
- [x] UnlockScreen component created with banking app UX
- [x] useAuth tracks lastUser in localStorage
- [x] App.tsx shows UnlockScreen for returning users
- [x] PIN unlock → decrypt credentials → auto-login
- [x] Wrong PIN error handling (3 attempts)
- [x] "PIN dimenticato?" flow deletes credentials
- [x] "Usa un altro account" switches to LoginModal
- [x] Manual UAT passes all checkpoints

**Quality Gates:**
- npm run build succeeds
- UnlockScreen appears instead of LoginModal for returning users
- Auto-login works with decrypted credentials
- PIN recovery flow functional
- No credentials leak in error messages or logs
</verification>

<success_criteria>
Phase 7 Plan 4 succeeds when:

1. **Unlock Flow Works:**
   - App detects lastUser on mount
   - UnlockScreen shown instead of LoginModal
   - User enters PIN → credentials decrypted → auto-login
   - Success → app loads authenticated

2. **Error Handling Robust:**
   - Wrong PIN → clear error message + retry
   - 3 failed attempts → prominent message about PIN recovery
   - Decryption failure treated as wrong PIN
   - Backend login failure shows network error (not PIN error)

3. **PIN Recovery Functional:**
   - "PIN dimenticato?" → confirmation dialog
   - Confirmed → delete credentials + lastUser → LoginModal
   - Cancelled → stay on UnlockScreen

4. **Account Switching Works:**
   - "Usa un altro account" → LoginModal immediately
   - Credentials preserved in IndexedDB
   - Can switch back to UnlockScreen by logging in with different account

5. **Banking App UX:**
   - Clean unlock screen (gradient background, white card)
   - Greeting with user's first name
   - Auto-submit PIN when complete (6 digits)
   - "Accesso in corso..." loading state
   - Professional styling (Intesa, UniCredit reference)

6. **Ready for Next Plan:**
   - Plan 07-05 can add biometric option alongside PIN
   - Plan 07-06 can add backend session-per-request refactor

</success_criteria>

<output>
**Deliverables:**
1. `archibald-web-app/frontend/src/components/UnlockScreen.tsx` - PIN unlock UI
2. Updated `archibald-web-app/frontend/src/hooks/useAuth.ts` - lastUser tracking, unlockWithPin
3. Updated `archibald-web-app/frontend/src/App.tsx` - UnlockScreen vs LoginModal logic
4. CSS styles for UnlockScreen (banking app design)
5. localStorage management: lastUser persistence

**Key Decisions:**
- lastUser stored in localStorage (separate from JWT)
- lastUser = {userId, fullName} for unlock greeting
- UnlockScreen auto-submits on 6-digit PIN entry
- 3 wrong attempts → show recovery message (no hard lockout)
- "PIN dimenticato?" deletes credentials + lastUser
- "Usa un altro account" keeps credentials (just switches UI)

**User Journey (Returning User):**
1. User opens app (previously saved credentials)
2. UnlockScreen appears: "Bentornato, Francesco!"
3. User enters 6-digit PIN
4. Auto-submit → decrypt credentials → backend login
5. Success → JWT stored → app loads
6. User ready to create orders (no password re-entry)

**Security Maintained:**
- Credentials still encrypted in IndexedDB
- PIN required every app launch (no persistent unlock)
- lastUser only stores userId + fullName (no sensitive data)
- Decryption happens in-memory, cleared after use

**Ready for:** Plan 07-05 (Biometric unlock for mobile)
</output>

---

**Phase:** 07-credential-management
**Plan:** 04 of 06
**Type:** Implementation (Unlock Flow)
**Estimated Duration:** 75-90 min
