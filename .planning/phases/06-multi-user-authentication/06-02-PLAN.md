---
phase: 06-multi-user-authentication
plan: 02
type: execute
---

<objective>
Implement user database and whitelist management backend.

Purpose: Create the foundational user management system with SQLite database and admin API endpoints for whitelist control.

Output: Working UserDatabase singleton with CRUD operations, admin API endpoints (/api/admin/users), users.db with schema, ready for authentication integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-user-authentication/06-01-ARCHITECTURE.md
@archibald-web-app/backend/src/customer-db.ts
@archibald-web-app/backend/src/product-db.ts

**Architecture from Plan 06-01:**
- Database schema for users table (id, username, fullName, whitelisted, createdAt, lastLoginAt)
- Whitelist management via admin endpoints
- Singleton pattern for database manager

**Established Patterns:**
- Singleton getInstance() for database managers
- better-sqlite3 for SQLite operations
- Zod schemas for validation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserDatabase singleton with CRUD operations</name>
  <files>archibald-web-app/backend/src/user-db.ts, archibald-web-app/backend/data/users.db</files>
  <action>
    Create `backend/src/user-db.ts` following the same singleton pattern as customer-db.ts:

    ```typescript
    import Database from 'better-sqlite3';
    import { v4 as uuidv4 } from 'uuid';
    import { logger } from './logger';

    export interface User {
      id: string;
      username: string;
      fullName: string;
      whitelisted: boolean;
      createdAt: number;
      lastLoginAt: number | null;
    }

    export class UserDatabase {
      private static instance: UserDatabase;
      private db: Database.Database;

      private constructor() {
        const dbPath = path.join(__dirname, '..', 'data', 'users.db');
        this.db = new Database(dbPath);
        this.initSchema();
      }

      static getInstance(): UserDatabase { ... }

      private initSchema(): void {
        this.db.exec(`
          CREATE TABLE IF NOT EXISTS users (
            id TEXT PRIMARY KEY,
            username TEXT UNIQUE NOT NULL,
            fullName TEXT NOT NULL,
            whitelisted INTEGER NOT NULL DEFAULT 1,
            createdAt INTEGER NOT NULL,
            lastLoginAt INTEGER,
            CONSTRAINT unique_username UNIQUE (username)
          );
          CREATE INDEX IF NOT EXISTS idx_username ON users(username);
          CREATE INDEX IF NOT EXISTS idx_whitelisted ON users(whitelisted);
        `);
      }

      // CRUD operations:
      createUser(username: string, fullName: string): User { ... }
      getUserById(id: string): User | null { ... }
      getUserByUsername(username: string): User | null { ... }
      getAllUsers(): User[] { ... }
      updateWhitelist(id: string, whitelisted: boolean): void { ... }
      updateLastLogin(id: string): void { ... }
      deleteUser(id: string): void { ... }
      close(): void { ... }
    }
    ```

    Use uuidv4() for user IDs, Date.now() for timestamps, boolean conversion for whitelisted (SQLite stores as INTEGER).
    Add comprehensive error logging with context.
  </action>
  <verify>npm run build succeeds, users.db created with schema, no TypeScript errors</verify>
  <done>UserDatabase singleton created with all CRUD methods, users.db initialized with indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create admin API endpoints for user management</name>
  <files>archibald-web-app/backend/src/index.ts, archibald-web-app/backend/src/schemas.ts</files>
  <action>
    Add admin endpoints to `backend/src/index.ts`:

    **1. POST /api/admin/users** - Create new user (admin only)
    ```typescript
    app.post("/api/admin/users", (req, res) => {
      const result = createUserSchema.safeParse(req.body);
      if (!result.success) {
        return res.status(400).json({ error: result.error });
      }
      const { username, fullName } = result.data;
      const userDb = UserDatabase.getInstance();
      const user = userDb.createUser(username, fullName);
      res.json({ success: true, user });
    });
    ```

    **2. GET /api/admin/users** - List all users
    ```typescript
    app.get("/api/admin/users", (req, res) => {
      const userDb = UserDatabase.getInstance();
      const users = userDb.getAllUsers();
      res.json({ success: true, users });
    });
    ```

    **3. PATCH /api/admin/users/:id/whitelist** - Update whitelist status
    ```typescript
    app.patch("/api/admin/users/:id/whitelist", (req, res) => {
      const { id } = req.params;
      const { whitelisted } = req.body;
      const userDb = UserDatabase.getInstance();
      userDb.updateWhitelist(id, whitelisted);
      res.json({ success: true });
    });
    ```

    **4. DELETE /api/admin/users/:id** - Delete user
    ```typescript
    app.delete("/api/admin/users/:id", (req, res) => {
      const userDb = UserDatabase.getInstance();
      userDb.deleteUser(id);
      res.json({ success: true });
    });
    ```

    Add Zod schemas to `schemas.ts`:
    ```typescript
    export const createUserSchema = z.object({
      username: z.string().min(3).max(50),
      fullName: z.string().min(1).max(100),
    });

    export const updateWhitelistSchema = z.object({
      whitelisted: z.boolean(),
    });
    ```

    NOTE: For MVP, no authentication on admin endpoints (will add in Phase 7). Document this as known limitation.
    DO NOT add authentication middleware yet (out of scope for this plan).
  </action>
  <verify>
    curl -X POST http://localhost:3000/api/admin/users -H "Content-Type: application/json" -d '{"username":"test","fullName":"Test User"}' returns 200 with user object
    curl http://localhost:3000/api/admin/users returns list of users
  </verify>
  <done>Admin endpoints created and functional, Zod validation in place, can create/list/update/delete users via API</done>
</task>

<task type="auto">
  <name>Task 3: Seed initial users for testing</name>
  <files>archibald-web-app/backend/src/scripts/seed-users.ts</files>
  <action>
    Create a seed script `backend/src/scripts/seed-users.ts`:

    ```typescript
    import { UserDatabase } from '../user-db';
    import { logger } from '../logger';

    async function seedUsers() {
      const userDb = UserDatabase.getInstance();

      // Create 3 test users
      const users = [
        { username: 'mario.rossi', fullName: 'Mario Rossi' },
        { username: 'luca.bianchi', fullName: 'Luca Bianchi' },
        { username: 'sara.verdi', fullName: 'Sara Verdi' },
      ];

      for (const userData of users) {
        try {
          const existing = userDb.getUserByUsername(userData.username);
          if (!existing) {
            const user = userDb.createUser(userData.username, userData.fullName);
            logger.info(`Created user: ${user.username}`);
          } else {
            logger.info(`User ${userData.username} already exists, skipping`);
          }
        } catch (error) {
          logger.error(`Error creating user ${userData.username}`, { error });
        }
      }

      logger.info('User seeding complete');
      userDb.close();
    }

    seedUsers().catch(console.error);
    ```

    Add npm script to package.json:
    ```json
    "seed:users": "tsx src/scripts/seed-users.ts"
    ```

    Run the seed script to populate users.db with test data.
  </action>
  <verify>npm run seed:users succeeds, users.db contains 3 test users</verify>
  <done>Seed script created and executed, 3 test users in database</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] users.db exists with users table and indexes
- [ ] UserDatabase singleton exports all CRUD methods
- [ ] Admin API endpoints respond correctly (POST, GET, PATCH, DELETE)
- [ ] Zod validation rejects invalid inputs
- [ ] Seed script populates test users
</verification>

<success_criteria>

- All tasks completed
- UserDatabase singleton functional
- users.db created with schema
- Admin API endpoints working (create, list, update whitelist, delete)
- Zod validation in place
- 3 test users seeded
- No TypeScript errors
- Ready for Plan 06-03 (Authentication Backend & JWT)
  </success_criteria>

<output>
After completion, create `.planning/phases/06-multi-user-authentication/06-02-SUMMARY.md`:

# Phase 6 Plan 2: User Database & Whitelist Backend Summary

**User management system with SQLite database and admin API operational**

## Accomplishments

- Created UserDatabase singleton with full CRUD operations
- Implemented users.db with indexed schema (username, whitelisted)
- Built 4 admin API endpoints (POST, GET, PATCH, DELETE /api/admin/users)
- Added Zod validation for user creation and whitelist updates
- Created seed script and populated 3 test users

## Files Created/Modified

- `archibald-web-app/backend/src/user-db.ts` - UserDatabase singleton
- `archibald-web-app/backend/data/users.db` - SQLite database
- `archibald-web-app/backend/src/schemas.ts` - Added createUserSchema, updateWhitelistSchema
- `archibald-web-app/backend/src/index.ts` - Added 4 admin endpoints
- `archibald-web-app/backend/src/scripts/seed-users.ts` - Seed script

## Decisions Made

- UUID for user IDs (v4)
- Boolean whitelisted field (default: true)
- No admin authentication yet (deferred to Phase 7)
- Seed script for easy testing setup

## Issues Encountered

None

## Next Step

Ready for Plan 06-03: Authentication Backend & JWT implementation
</output>
