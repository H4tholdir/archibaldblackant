---
phase: 06-multi-user-authentication
plan: 04
type: execute
---

<objective>
Build login UI and frontend authentication state management.

Purpose: Enable users to login with Archibald credentials through intuitive UI, persist JWT in localStorage, maintain auth state across app, protect routes when not authenticated.

Output: LoginModal component, useAuth hook for state management, JWT storage in localStorage, App.tsx shows login when unauthenticated, complete frontend auth flow operational.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-user-authentication/06-03-SUMMARY.md
@archibald-web-app/frontend/src/App.tsx
@archibald-web-app/frontend/src/components/OrderForm.tsx

**From Plan 06-03:**
- POST /api/auth/login returns { success, token, user }
- POST /api/auth/logout clears session
- GET /api/auth/me returns user profile
- JWT middleware requires Authorization: Bearer {token}

**Established Frontend Patterns:**
- React 19 with hooks (useState, useEffect, useContext)
- Components in src/components/
- Hooks in src/hooks/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth API client</name>
  <files>archibald-web-app/frontend/src/api/auth.ts</files>
  <action>
    Create `frontend/src/api/auth.ts`:

    ```typescript
    const API_BASE = '';  // Vite proxy handles /api

    export interface LoginRequest {
      username: string;
      password: string;
    }

    export interface LoginResponse {
      success: boolean;
      token?: string;
      user?: {
        id: string;
        username: string;
        fullName: string;
      };
      error?: string;
    }

    export interface User {
      id: string;
      username: string;
      fullName: string;
      whitelisted: boolean;
      lastLoginAt: number | null;
    }

    export async function login(credentials: LoginRequest): Promise<LoginResponse> {
      const response = await fetch(`${API_BASE}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credentials),
      });
      return response.json();
    }

    export async function logout(token: string): Promise<void> {
      await fetch(`${API_BASE}/api/auth/logout`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
      });
    }

    export async function getMe(token: string): Promise<{ success: boolean; user?: User }> {
      const response = await fetch(`${API_BASE}/api/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      return response.json();
    }
    ```
  </action>
  <verify>TypeScript compilation succeeds, no errors</verify>
  <done>Auth API client created with login, logout, getMe functions</done>
</task>

<task type="auto">
  <name>Task 2: Create useAuth hook for auth state management</name>
  <files>archibald-web-app/frontend/src/hooks/useAuth.ts</files>
  <action>
    Create `frontend/src/hooks/useAuth.ts`:

    ```typescript
    import { useState, useEffect } from 'react';
    import * as authApi from '../api/auth';

    const TOKEN_KEY = 'archibald_jwt';

    export interface AuthState {
      isAuthenticated: boolean;
      user: authApi.User | null;
      token: string | null;
      isLoading: boolean;
      error: string | null;
    }

    export function useAuth() {
      const [state, setState] = useState<AuthState>({
        isAuthenticated: false,
        user: null,
        token: null,
        isLoading: true,
        error: null,
      });

      // Initialize: Check localStorage for existing JWT
      useEffect(() => {
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) {
          // Verify token by fetching user profile
          authApi.getMe(token)
            .then(response => {
              if (response.success && response.user) {
                setState({
                  isAuthenticated: true,
                  user: response.user,
                  token,
                  isLoading: false,
                  error: null,
                });
              } else {
                // Token invalid, clear it
                localStorage.removeItem(TOKEN_KEY);
                setState(prev => ({ ...prev, isLoading: false }));
              }
            })
            .catch(() => {
              localStorage.removeItem(TOKEN_KEY);
              setState(prev => ({ ...prev, isLoading: false }));
            });
        } else {
          setState(prev => ({ ...prev, isLoading: false }));
        }
      }, []);

      const login = async (username: string, password: string): Promise<boolean> => {
        setState(prev => ({ ...prev, isLoading: true, error: null }));

        try {
          const response = await authApi.login({ username, password });

          if (response.success && response.token && response.user) {
            localStorage.setItem(TOKEN_KEY, response.token);
            setState({
              isAuthenticated: true,
              user: response.user,
              token: response.token,
              isLoading: false,
              error: null,
            });
            return true;
          } else {
            setState(prev => ({
              ...prev,
              isLoading: false,
              error: response.error || 'Login failed',
            }));
            return false;
          }
        } catch (error) {
          setState(prev => ({
            ...prev,
            isLoading: false,
            error: 'Network error',
          }));
          return false;
        }
      };

      const logout = async () => {
        if (state.token) {
          await authApi.logout(state.token).catch(() => {});
        }
        localStorage.removeItem(TOKEN_KEY);
        setState({
          isAuthenticated: false,
          user: null,
          token: null,
          isLoading: false,
          error: null,
        });
      };

      return {
        ...state,
        login,
        logout,
      };
    }
    ```

    This hook provides:
    - Auto-restore session from localStorage on mount
    - login(username, password) function
    - logout() function
    - Auth state (isAuthenticated, user, token, isLoading, error)
  </action>
  <verify>TypeScript compilation succeeds, no errors</verify>
  <done>useAuth hook created with localStorage persistence, login, logout, auto-restore</done>
</task>

<task type="auto">
  <name>Task 3: Create LoginModal component</name>
  <files>archibald-web-app/frontend/src/components/LoginModal.tsx</files>
  <action>
    Create `frontend/src/components/LoginModal.tsx`:

    ```tsx
    import { useState } from 'react';

    interface LoginModalProps {
      onLogin: (username: string, password: string) => Promise<boolean>;
      error: string | null;
      isLoading: boolean;
    }

    export function LoginModal({ onLogin, error, isLoading }: LoginModalProps) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');

      const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        await onLogin(username, password);
      };

      return (
        <div className="login-modal-overlay">
          <div className="login-modal">
            <h1>üêú Archibald Black Ant</h1>
            <p className="subtitle">Accedi con le tue credenziali Archibald</p>

            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label htmlFor="username">Username</label>
                <input
                  id="username"
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  placeholder="mario.rossi"
                  required
                  autoFocus
                  disabled={isLoading}
                />
              </div>

              <div className="form-group">
                <label htmlFor="password">Password</label>
                <input
                  id="password"
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                  disabled={isLoading}
                />
              </div>

              {error && (
                <div className="error-message">
                  {error}
                </div>
              )}

              <button
                type="submit"
                className="btn btn-primary"
                disabled={isLoading || !username || !password}
              >
                {isLoading ? 'Autenticazione...' : 'Accedi'}
              </button>
            </form>

            <p className="help-text">
              Usa le stesse credenziali che usi per accedere al sito Archibald.
            </p>
          </div>
        </div>
      );
    }
    ```

    Add CSS to App.css:
    ```css
    .login-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-modal {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .login-modal h1 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      text-align: center;
    }

    .login-modal .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .login-modal .help-text {
      text-align: center;
      color: #666;
      margin-top: 1rem;
      font-size: 0.85rem;
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c00;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    ```

    Simple, clean login UI with username, password, error display, loading state.
  </action>
  <verify>npm run build succeeds, LoginModal component renders correctly</verify>
  <done>LoginModal component created with form, error handling, loading state, styled</done>
</task>

<task type="auto">
  <name>Task 4: Integrate auth state into App.tsx</name>
  <files>archibald-web-app/frontend/src/App.tsx</files>
  <action>
    Update `frontend/src/App.tsx` to use authentication:

    ```tsx
    import { useAuth } from './hooks/useAuth';
    import { LoginModal } from './components/LoginModal';
    import { OrderForm } from './components/OrderForm';
    import { SyncBars } from './components/SyncBars';
    // ... other imports

    function App() {
      const auth = useAuth();

      // Show loading spinner while checking auth
      if (auth.isLoading) {
        return (
          <div style={{ textAlign: 'center', padding: '2rem' }}>
            <p>Caricamento...</p>
          </div>
        );
      }

      // Show login modal if not authenticated
      if (!auth.isAuthenticated) {
        return (
          <LoginModal
            onLogin={auth.login}
            error={auth.error}
            isLoading={auth.isLoading}
          />
        );
      }

      // Show main app if authenticated
      return (
        <div className="container">
          <header>
            <h1>üêú Archibald Black Ant</h1>
            <div className="user-info">
              <span>üë§ {auth.user?.fullName}</span>
              <button
                onClick={auth.logout}
                className="btn btn-secondary btn-sm"
              >
                Logout
              </button>
            </div>
          </header>

          <SyncBars />
          <OrderForm token={auth.token!} />
        </div>
      );
    }
    ```

    Update OrderForm to accept token prop and include in API requests:
    ```tsx
    interface OrderFormProps {
      token: string;
    }

    export function OrderForm({ token }: OrderFormProps) {
      // Use token in fetch headers:
      // headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
      // ...
    }
    ```

    Add header CSS to App.css:
    ```css
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #eee;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .btn-sm {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }
    ```
  </action>
  <verify>npm run dev shows LoginModal when not authenticated, shows app with user info + logout when authenticated</verify>
  <done>App.tsx integrated with auth state, shows LoginModal or main app based on auth status, logout button functional</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete login/logout flow with JWT authentication</what-built>
  <how-to-verify>
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Start frontend: cd archibald-web-app/frontend && npm run dev
    3. Visit: http://localhost:5173
    4. Should see LoginModal (not main app)
    5. Enter invalid credentials ‚Üí should show error message
    6. Enter valid test user credentials (from seed script) ‚Üí should login successfully
    7. Should see main app with user name in header and Logout button
    8. Click Logout ‚Üí should return to LoginModal
    9. Refresh page ‚Üí should stay logged in (JWT from localStorage)
    10. Clear localStorage and refresh ‚Üí should show LoginModal again
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds (both frontend and backend)
- [ ] Auth API client functional
- [ ] useAuth hook provides login, logout, auth state
- [ ] LoginModal renders with form and error display
- [ ] App.tsx shows LoginModal when unauthenticated
- [ ] App.tsx shows main app + logout when authenticated
- [ ] JWT persists in localStorage
- [ ] Logout clears JWT and returns to LoginModal
- [ ] User testing approved at checkpoint
</verification>

<success_criteria>

- All tasks completed
- Frontend auth system operational
- LoginModal functional with error handling
- JWT persisted in localStorage
- Auto-restore session on page load
- Logout clears session
- User manual testing approved
- Ready for Plan 06-05 (Refactor BrowserPool for Multi-User Sessions)
  </success_criteria>

<output>
After completion, create `.planning/phases/06-multi-user-authentication/06-04-SUMMARY.md`:

# Phase 6 Plan 4: Login UI & Frontend Auth State Summary

**Frontend authentication system with login modal and JWT persistence operational**

## Accomplishments

- Created auth API client (login, logout, getMe)
- Built useAuth hook with localStorage JWT persistence
- Created LoginModal component with form validation
- Integrated auth state into App.tsx
- Added user info header with logout button
- Verified complete login/logout flow with manual testing

## Files Created/Modified

- `archibald-web-app/frontend/src/api/auth.ts` - Auth API client
- `archibald-web-app/frontend/src/hooks/useAuth.ts` - Auth state hook
- `archibald-web-app/frontend/src/components/LoginModal.tsx` - Login UI
- `archibald-web-app/frontend/src/App.tsx` - Auth integration
- `archibald-web-app/frontend/src/App.css` - Login modal + header styles
- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Added token prop

## Decisions Made

- JWT storage: localStorage (key: 'archibald_jwt')
- Auto-restore: Verify JWT on mount by calling GET /api/auth/me
- Login UX: Modal overlay prevents access to app when unauthenticated
- User display: Show fullName in header, not username

## Issues Encountered

None

## Next Step

Ready for Plan 06-05: Refactor BrowserPool for Multi-User Sessions
</output>
