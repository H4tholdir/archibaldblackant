---
phase: 06-multi-user-authentication
plan: 06
type: execute
---

<objective>
Integrate per-user sessions into order creation flow.

Purpose: Ensure orders are created using the authenticated user's Archibald session, so orders appear under the correct user account in the ERP system.

Output: Order creation uses userId from JWT, orders created via user's BrowserContext, complete end-to-end multi-user order flow functional.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-user-authentication/06-05-SUMMARY.md
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/queue-manager.ts
@archibald-web-app/backend/src/middleware/auth.ts

**From Plan 06-05:**
- ArchibaldBot now accepts userId parameter
- BrowserPool manages per-user BrowserContexts
- SessionCacheManager caches per-user cookies

**From Plan 06-03:**
- JWT middleware provides req.user.userId
- Protected routes extract userId from JWT
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update POST /api/orders/create to require authentication</name>
  <files>archibald-web-app/backend/src/index.ts</files>
  <action>
    Update POST /api/orders/create endpoint to use JWT middleware:

    ```typescript
    app.post("/api/orders/create", authenticateJWT, async (req: AuthRequest, res) => {
      try {
        const result = createOrderSchema.safeParse(req.body);
        if (!result.success) {
          return res.status(400).json({
            success: false,
            error: "Invalid order data",
            details: result.error,
          });
        }

        const userId = req.user!.userId;  // Extract from JWT
        const username = req.user!.username;

        logger.info(`Order creation requested by user ${username}`, {
          userId,
          customerId: result.data.customerId,
          itemCount: result.data.items.length,
        });

        // Add order to queue with userId
        const queueManager = QueueManager.getInstance();
        const job = await queueManager.addOrder(result.data, userId);

        res.json({
          success: true,
          jobId: job.id,
          message: `Order queued for processing by ${username}`,
        });

      } catch (error) {
        logger.error("Error creating order", { error });
        res.status(500).json({ success: false, error: "Internal server error" });
      }
    });
    ```

    Now POST /api/orders/create requires Authorization: Bearer {token} header.
    Orders without valid JWT are rejected with 401.
  </action>
  <verify>
    curl -X POST http://localhost:3000/api/orders/create (no token) returns 401
    curl -X POST http://localhost:3000/api/orders/create -H "Authorization: Bearer {token}" returns 200 with jobId
  </verify>
  <done>POST /api/orders/create protected with JWT middleware, extracts userId from token</done>
</task>

<task type="auto">
  <name>Task 2: Update QueueManager to accept and pass userId</name>
  <files>archibald-web-app/backend/src/queue-manager.ts</files>
  <action>
    Update `backend/src/queue-manager.ts`:

    **1. Update addOrder signature:**
    ```typescript
    async addOrder(orderData: OrderData, userId: string): Promise<Job> {
      const job = await this.orderQueue.add(
        'create-order',
        {
          orderData,
          userId,  // Include userId in job data
          username: await this.getUsernameFromId(userId),  // For logging
        },
        {
          attempts: 3,
          backoff: {
            type: 'exponential',
            delay: 5000,
          },
        }
      );

      logger.info(`Order job ${job.id} created for user ${userId}`);
      return job;
    }

    private async getUsernameFromId(userId: string): Promise<string> {
      const userDb = UserDatabase.getInstance();
      const user = userDb.getUserById(userId);
      return user?.username || 'unknown';
    }
    ```

    **2. Update processOrder to use userId:**
    ```typescript
    private async processOrder(job: Job): Promise<void> {
      const { orderData, userId, username } = job.data;

      logger.info(`Processing order ${job.id} for user ${username}`, {
        userId,
        customerId: orderData.customerId,
      });

      // Acquire priority lock
      await this.acquireOrderLock();

      try {
        // Create bot with userId for multi-user session
        const bot = new ArchibaldBot(userId);
        await bot.initialize();

        logger.info(`Using authenticated session for user ${username}`);

        // Create order in Archibald
        const orderId = await bot.createOrder(orderData);

        logger.info(`Order ${orderId} created successfully by user ${username}`);

        await bot.close();

        // Update job progress to 100%
        await job.updateProgress(100);

        return orderId;

      } catch (error) {
        logger.error(`Order processing failed for user ${username}`, {
          error,
          jobId: job.id,
          userId,
        });
        throw error;
      } finally {
        // Release priority lock
        this.releaseOrderLock();
      }
    }
    ```

    Now orders are created using the specific user's BrowserContext, ensuring orders appear under that user in Archibald ERP.
  </action>
  <verify>npm run build succeeds, QueueManager.addOrder accepts userId parameter</verify>
  <done>QueueManager updated to accept userId, passes to ArchibaldBot, orders use user's session</done>
</task>

<task type="auto">
  <name>Task 3: Update frontend OrderForm to include JWT token in API calls</name>
  <files>archibald-web-app/frontend/src/components/OrderForm.tsx</files>
  <action>
    Update `frontend/src/components/OrderForm.tsx` to use token in API calls:

    The token prop was added in Plan 06-04, now use it in fetch calls:

    ```typescript
    // In handleSubmit or wherever POST /api/orders/create is called:

    const response = await fetch('/api/orders/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,  // Include JWT
      },
      body: JSON.stringify(orderData),
    });

    const result = await response.json();

    if (!response.ok) {
      if (response.status === 401) {
        // Token expired or invalid - should trigger logout
        console.error('Authentication failed, please login again');
        // Could call auth.logout() here if we pass it as prop
      }
      throw new Error(result.error || 'Order creation failed');
    }
    ```

    Ensure all API calls in OrderForm include Authorization header with token.
    Handle 401 responses gracefully (prompt re-login).
  </action>
  <verify>npm run build succeeds, OrderForm includes Authorization header in API calls</verify>
  <done>OrderForm updated to include JWT in API calls, handles 401 errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds (both backend and frontend)
- [ ] POST /api/orders/create requires JWT authentication
- [ ] QueueManager.addOrder accepts userId parameter
- [ ] Order processing uses ArchibaldBot with userId
- [ ] Orders created via user's BrowserContext
- [ ] Frontend sends JWT in Authorization header
- [ ] Orders appear under correct user in Archibald ERP
</verification>

<success_criteria>

- All tasks completed
- Order creation protected by JWT authentication
- userId extracted from JWT and passed to QueueManager
- ArchibaldBot uses user's BrowserContext for order creation
- Frontend includes JWT in order API calls
- End-to-end multi-user order flow functional
- Ready for Plan 06-07 (Session Cleanup & Testing)
  </success_criteria>

<output>
After completion, create `.planning/phases/06-multi-user-authentication/06-06-SUMMARY.md`:

# Phase 6 Plan 6: Integrate User Sessions in Order Flow Summary

**Multi-user order creation with per-user sessions operational**

## Accomplishments

- Protected POST /api/orders/create with JWT authentication
- Updated QueueManager to accept and use userId from JWT
- Modified order processing to use ArchibaldBot with userId
- Updated frontend OrderForm to include JWT in API calls
- Verified orders created via user's authenticated session

## Files Modified

- `archibald-web-app/backend/src/index.ts` - Added authenticateJWT to orders endpoint
- `archibald-web-app/backend/src/queue-manager.ts` - Added userId parameter, use in processOrder
- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Include JWT in Authorization header

## Decisions Made

- Order API security: JWT required for all order operations
- Error handling: 401 responses should trigger re-login
- Logging: Include username in all order-related logs for traceability

## Issues Encountered

None

## Next Step

Ready for Plan 06-07: Session Cleanup & Testing (final phase plan)
</output>
