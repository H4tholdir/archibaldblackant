---
phase: 21-orders-sync-optimization
plan: 01
type: execute
---

<objective>
Profile and analyze order history sync performance to identify bottlenecks and optimization opportunities.

Purpose: Establish baseline performance metrics for OrderHistoryService and document bottlenecks for optimization.
Output: Performance analysis report with execution times, bottleneck identification, and optimization recommendations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-customers-sync-optimization/18-01-PLAN.md

**Key files:**
@archibald-web-app/backend/src/order-history-service.ts
@archibald-web-app/backend/src/order-db.ts

**Tech stack available:**
- Puppeteer for browser automation
- SQLite with better-sqlite3
- Winston logger for timing logs
- EventEmitter for progress events

**Existing sync implementation:**
- OrderHistoryService.syncOrders() method
- Scrapes order list from SALESTABLE_ListView_Agent
- Stores orders in OrderDatabase with 20 columns + extended fields
- DDT and invoice scraping (separate from main order sync)

**Performance considerations (same as Phase 18-01)**:
- Puppeteer wait times
- Page navigation overhead
- Per-order data extraction
- Database insert batch operations

**Implementation**: Apply same profiling pattern as Phases 18-01, 19-01, 20-01.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add performance profiling instrumentation to syncOrders</name>
  <files>
    archibald-web-app/backend/src/order-history-service.ts
  </files>
  <action>
    Add timing logs throughout sync method (same pattern as previous phases):
    - Start time, login time, navigation time
    - Per-page processing time
    - End time with summary statistics

    See Phase 18-01 Task 1 for detailed pattern.
  </action>
  <verify>
    npm run typecheck passes
    [PERF] logs appear during sync
  </verify>
  <done>
    Performance profiling instrumentation added to syncOrders.
    Timing logs at key points.
    TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run profiled sync and collect performance data</name>
  <files>
    .planning/phases/21-orders-sync-optimization/PERF-DATA.json
  </files>
  <action>
    Execute profiled order sync and capture metrics.
    Create PERF-DATA.json with collected data.

    See Phase 18-01 Task 2 for format.
  </action>
  <verify>
    PERF-DATA.json exists with real timing data
  </verify>
  <done>
    PERF-DATA.json created with baseline metrics.
    Bottlenecks identified.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create performance analysis report</name>
  <files>
    .planning/phases/21-orders-sync-optimization/ANALYSIS.md
  </files>
  <action>
    Create comprehensive analysis report comparing with other sync types.

    See Phase 18-01 Task 3 for format.
  </action>
  <verify>
    ANALYSIS.md exists with complete report
  </verify>
  <done>
    ANALYSIS.md created with optimization roadmap.
    Comparison with customer/product/price sync.
  </done>
</task>

</tasks>

<verification>
- [ ] Performance profiling instrumentation added
- [ ] PERF-DATA.json created
- [ ] ANALYSIS.md created
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- Baseline metrics documented
- Bottlenecks identified
- Optimization potential estimated
- Consistent with Phases 18-01, 19-01, 20-01
</success_criteria>

<output>
After completion, create `.planning/phases/21-orders-sync-optimization/21-01-SUMMARY.md`
</output>
