---
phase: 21-orders-sync-analysis-optimization
plan: 03
title: Invoices PDF Parser & Database with Order Matching
subsystem: integration
complexity: medium
estimated_duration: 60min
tags: [python, pdf-parsing, node-js, invoices, 7-page-cycle, order-matching]
---

# Plan 21-03: Invoices PDF Parser & Database with Order Matching

## Objective

Create Python PDF parser for invoices with **7-page cycle support**, separate `invoices.db` database, and intelligent order matching via customerAccount + date proximity.

## Execution Context

**Discovery Results:**
- ✅ Fatture.pdf has **7-page cycle pattern**
- ✅ 35 pages = ~5 invoices
- ✅ Table-based format (~26 rows per page)
- ✅ Match strategy: customerAccount + date proximity
- ✅ Many-to-many relationship with orders

**Page Cycle Structure:**
- Page 1/7: Invoice ID, Date, Customer Account (4 cols)
- Page 2/7: Billing Name, Quantity, Sales Balance (3 cols)
- Page 3/7: Amount fields (4 cols)
- Page 4-7/7: Additional invoice details

**Matching Strategy:**
- **Primary:** `invoices.customerAccount = orders.customerProfileId` + date within 30 days
- **Relationship:** Many-to-many (1 invoice → N orders, 1 order → N invoices)

## Tasks

### Task 1: Python PDF Parser for Invoices (25min)

Create `scripts/parse-invoices-pdf.py` with 7-page cycle logic extracting invoice fields.

### Task 2: Invoice Database with Matching (20min)

Create `src/invoices-db.ts` with:
- Schema for invoice fields
- `order_invoice_mapping` table for many-to-many relationships
- Auto-matching logic via customerAccount + date
- Manual matching support

### Task 3: Node.js Wrapper & Health Check (15min)

Create `src/pdf-parser-invoices-service.ts` and health check endpoint.

## Verification

E2E test: Parse Fatture.pdf → Save to invoices.db → Match with orders.db → Verify mapping

## Success Criteria

- [ ] 7-page cycle parser working
- [ ] Invoice fields extracted
- [ ] invoices.db created
- [ ] order_invoice_mapping functional
- [ ] Auto-matching by customer+date
- [ ] Performance: < 10s for ~5 invoices

## Output

**Files Created:**
1. `scripts/parse-invoices-pdf.py`
2. `src/invoices-db.ts`
3. `src/pdf-parser-invoices-service.ts`
4. `scripts/test-invoices-sync-e2e.ts`

**Database Created:**
1. `data/invoices.db`

**Commits:**
1. `feat(21-03): add invoices PDF parser with 7-page cycle`
2. `feat(21-03): create invoices database with order matching`
3. `feat(21-03): add Node.js wrapper for invoices parser`
4. `test(21-03): add E2E test for invoices sync`
