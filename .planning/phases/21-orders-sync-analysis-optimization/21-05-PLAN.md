---
phase: 21-orders-sync-analysis-optimization
plan: 05
title: Manual Sync UI & Order History Enhancements  
subsystem: frontend
complexity: high
estimated_duration: 120min
tags: [react, ui-enhancements, manual-sync, filters, invoice-download]
---

# Plan 21-05: Manual Sync UI & Order History Enhancements

## Objective

Add manual sync buttons for Orders/DDT/Invoices, update filters, add "essenziali" toggle, invoice download, and remove clickable icons - completing Phase 21 UI requirements.

## Execution Context

**User Requirements:**
1. **Manual Sync Buttons** - 3 separate buttons (Ordini, DDT, Fatture) + optional combined
2. **Filter Updates** - Replace current filters with: Tutti, Spediti (has tracking), Consegnati, Fatturati
3. **Toggle "Essenziali"** - Show only stato + tracking when ON
4. **Remove Icons** - Remove clickable icons next to numero ordine and numero DDT
5. **Invoice Download** - Add download button in scheda finanziario
6. **Order Articles** - Track articles from PWA order creation (defer scrape enrichment to later)

**NO Background Scheduler** - Will be handled by orchestrator in Phase 22

## Tasks

### Task 1: Manual Sync Buttons (30min)

Add to `OrderHistory.tsx`:
- 3 buttons: "Sync Ordini", "Sync DDT", "Sync Fatture"
- Progress modals for each sync type
- Stats display after completion
- Position: Header or dedicated sync section

API Endpoints to create:
- `POST /api/orders/sync` - Calls OrderSyncService
- `POST /api/ddt/sync` - Calls DDTSyncService
- `POST /api/invoices/sync` - Calls InvoicesSyncService

### Task 2: Filter Updates (20min)

Update `OrderHistory.tsx` filters:
- **Tutti** - No filter
- **Spediti** - JOIN with ddt.db WHERE tracking_number IS NOT NULL
- **Consegnati** - WHERE completion_date IS NOT NULL OR sales_status = 'Consegnato'
- **Fatturati** - EXISTS in order_invoice_mapping

### Task 3: Toggle "Essenziali" (20min)

Add toggle switch in `OrderCard.tsx`:
- When ON: Show only sales_status + tracking badge
- When OFF: Show all badges (current behavior)
- Persist preference in localStorage

### Task 4: Remove Clickable Icons (10min)

Update `OrderCard.tsx`:
- Remove icon next to "Numero ordine" display
- Update logistics section: Remove icon next to "Numero DDT"
- Keep text displays, just remove clickable icons

### Task 5: Invoice Download Button (25min)

Add to `OrderCard.tsx` financial section:
- "Download Fattura" button
- Fetch invoice PDF from invoices.db (pdf_path) or download on-demand
- Download via browser or display in modal

### Task 6: Order Articles Tracking (15min)

Update `QueueManager.processOrder()`:
- After bot creates order successfully, save articles to `order_articles` table
- Fields: order_id, article_code, quantity, unit_price, discount, line_amount

Schema:
```sql
CREATE TABLE order_articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_id TEXT NOT NULL,
  article_code TEXT NOT NULL,
  article_description TEXT,
  quantity REAL NOT NULL,
  unit_price REAL,
  discount_percent REAL,
  line_amount REAL,
  created_at TEXT NOT NULL,
  FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

## Verification

**Manual UAT:**
1. Click "Sync Ordini" → verify progress modal → check stats
2. Test each filter (Tutti/Spediti/Consegnati/Fatturati)
3. Toggle "essenziali" ON/OFF → verify badge display
4. Verify icons removed from numero ordine and DDT
5. Click "Download Fattura" → verify download works
6. Create test order → verify articles saved

## Success Criteria

- [ ] 3 manual sync buttons working
- [ ] Progress modals display correctly
- [ ] Filters functional (4 types)
- [ ] Toggle "essenziali" working
- [ ] Icons removed (2 locations)
- [ ] Invoice download functional
- [ ] Order articles tracking working
- [ ] No background scheduler (orchestrator will handle)

## Output

**Files Modified:**
1. `frontend/src/pages/OrderHistory.tsx` - Add sync buttons + filters
2. `frontend/src/components/OrderCard.tsx` - Toggle + remove icons + invoice button
3. `backend/src/index.ts` - Add 3 sync API endpoints
4. `backend/src/order-db-new.ts` - Add order_articles table + methods
5. `backend/src/queue-manager.ts` - Save articles after order creation

**Commits:**
1. `feat(21-05): add manual sync buttons for orders, DDT, invoices`
2. `feat(21-05): update filters to Spediti/Consegnati/Fatturati`
3. `feat(21-05): add essenziali toggle and remove clickable icons`
4. `feat(21-05): add invoice download button in financial section`
5. `feat(21-05): track order articles from PWA creation`
