---
phase: 21-orders-sync-analysis-optimization
plan: 04
title: PDF Download Bot Flows for Orders, DDT & Invoices
subsystem: integration
complexity: high
estimated_duration: 90min
tags: [puppeteer, pdf-download, bot-automation, italian-locale]
---

# Plan 21-04: PDF Download Bot Flows for Orders, DDT & Invoices

## Objective

Implement automated PDF download flows for all 3 sync types using ArchibaldBot + BrowserPool pattern from Phase 18/19/20, with Italian locale forcing and Accept-Language headers.

## Execution Context

**Proven Pattern (Phase 18/19/20):**
- Navigate to list view URL
- Force Italian locale via `Accept-Language: it-IT`
- Click Export PDF button (user will provide selector)
- Wait for download via Puppeteer CDP
- Save to `/tmp` and return file path
- Parse PDF via service wrappers

**URLs:**
- Orders: `https://4.231.124.90/Archibald/SALESTABLE_ListView_Agent/`
- DDT: `https://4.231.124.90/Archibald/CUSTPACKINGSLIPJOUR_ListView/`
- Invoices: `https://4.231.124.90/Archibald/CUSTINVOICEJOUR_ListView/`

**Button Selectors:**
User will provide during execution (same as Phase 18/19/20 pattern)

## Tasks

### Task 1: Orders PDF Download Method (30min)

Add `downloadOrdersPDF()` to ArchibaldBot:
- Navigate to SALESTABLE_ListView_Agent
- Click export button (selector from user)
- Download via CDP to `/tmp/ordini-{timestamp}.pdf`
- Return file path

### Task 2: DDT PDF Download Method (20min)

Add `downloadDDTPDF()` to ArchibaldBot (similar pattern).

### Task 3: Invoices PDF Download Method (20min)

Add `downloadInvoicesPDF()` to ArchibaldBot (similar pattern).

### Task 4: Sync Service Integration (20min)

Create `OrderSyncService`, `DDTSyncService`, `InvoiceSyncService` with:
- Download PDF via bot
- Parse via PDF parser service
- Upsert to respective database
- Return sync stats

## Verification

Manual test: Execute each download method → Verify PDF saved → Parse PDF → Check database

## Success Criteria

- [ ] 3 PDF download methods working
- [ ] Italian locale forced (Accept-Language)
- [ ] Downloads complete successfully
- [ ] Sync services integrate parsers + DB
- [ ] Stats returned correctly

## Output

**Files Modified:**
1. `src/archibald-bot.ts` - Add 3 download methods
2. `src/order-sync-service.ts` - NEW sync service
3. `src/ddt-sync-service.ts` - NEW sync service
4. `src/invoices-sync-service.ts` - NEW sync service

**Commits:**
1. `feat(21-04): add orders PDF download bot method`
2. `feat(21-04): add DDT and invoices PDF download methods`
3. `feat(21-04): create sync services integrating parsers and databases`
4. `test(21-04): manual verification of all 3 download flows`
