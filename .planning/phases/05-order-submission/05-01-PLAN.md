---
phase: 05-order-submission
plan: "01"
type: execute
depends_on: []
---

# Plan 05-01: Granular Progress Tracking

<objective>
Enhance order creation progress tracking from 2 coarse milestones (25%, 100%) to granular step-by-step updates with real-time WebSocket broadcast, enabling frontend to display detailed progress status and time estimates.
</objective>

<execution_context>
**Phase Goal**: Improve UX around existing order submission process WITHOUT modifying bot logic.

**CRITICAL CONSTRAINT**: DO NOT modify bot createOrder() logic, BullMQ queue, or PriorityManager. Only enhance progress reporting around existing infrastructure.

**Existing Infrastructure**:
- BullMQ queue processes orders via `queue-manager.ts:processOrder()`
- Current progress: only 2 updates (25% after session check, 100% after completion)
- WebSocket server exists at `/ws/sync` for sync services
- Baseline: ~82s order creation time (Phase 3.2 metrics)
- Bot operations tracked via `runOp()` in archibald-bot.ts

**Technical Approach**:
1. Add granular progress updates to processOrder() workflow
2. Create WebSocket endpoint for order progress tracking
3. Emit progress events at key milestones with time estimates
4. Preserve all existing bot logic and retry behavior
</execution_context>

<context>
@archibald-web-app/backend/src/queue-manager.ts (lines 150-282: processOrder method)
@archibald-web-app/backend/src/archibald-bot.ts (lines 1-100: runOp tracking)
@archibald-web-app/backend/src/index.ts (lines 25, 137-142: WebSocket server)
@.planning/phases/05-order-submission/05-CONTEXT.md
@.planning/phases/03.2-bot-performance-implementation/3.2-AD-HOC-SUMMARY.md (performance baseline)
</context>

<tasks>
  <task type="auto">
    <description>Enhance processOrder() with granular progress updates</description>
    <instructions>
Add progress update calls at key workflow milestones in queue-manager.ts:processOrder():

**Progress milestones** (keep existing 25% and 100%, add intermediate steps):
- 10%: Browser initialization started
- 15%: Login/session check complete
- 25%: Session validated (EXISTING)
- 35%: Customer selection started
- 50%: Customer selected
- 65%: Article addition started
- 80%: Articles added
- 90%: Order save initiated
- 100%: Order creation complete (EXISTING)

**Implementation**:
```typescript
// After bot.initialize()
await job.updateProgress(10); // Browser ready

// After session check/login
await job.updateProgress(15); // Login complete

// (Keep existing 25% after session validation)

// Add progress callback to bot.createOrder() or wrap with progress updates
// Note: Do NOT modify bot.createOrder() internals, only add progress updates around it
```

**With metadata for time estimates**:
```typescript
await job.updateProgress({
  percent: 35,
  step: 'customer_selection',
  message: 'Selezione cliente in corso...',
  estimatedRemainingSeconds: 70 // Based on 82s baseline
});
```

Update BullMQ job.updateProgress() calls to include step-level detail.

**Acceptance criteria**:
- processOrder() emits 9 progress updates (10%, 15%, 25%, 35%, 50%, 65%, 80%, 90%, 100%)
- Each update includes: percent, step identifier, human-readable message, time estimate
- Existing bot logic unchanged (no modifications to bot.createOrder() internals)
- TypeScript compiles without errors
    </instructions>
  </task>

  <task type="auto">
    <description>Create WebSocket endpoint for order progress tracking</description>
    <instructions>
Add WebSocket handler for order job progress in index.ts, following existing `/ws/sync` pattern.

**Implementation**:

1. **Add queue-manager progress listener**:
```typescript
// In queue-manager.ts constructor
this.worker.on('progress', (job, progress) => {
  logger.debug(`Job ${job.id} progress`, { progress });

  // Emit to registered listeners
  this.emitProgress(job.id, progress);
});
```

2. **Add WebSocket broadcast in index.ts**:
```typescript
// Store WebSocket clients by job ID subscription
const orderProgressClients = new Map<string, Set<WebSocket>>();

wss.on("connection", (ws, req) => {
  const url = new URL(req.url || '', 'http://localhost');
  const jobId = url.searchParams.get('jobId');

  if (jobId) {
    logger.info(`Client subscribed to order progress: ${jobId}`);

    if (!orderProgressClients.has(jobId)) {
      orderProgressClients.set(jobId, new Set());
    }
    orderProgressClients.get(jobId)!.add(ws);

    // Send initial job status
    queueManager.getJobStatus(jobId).then(status => {
      ws.send(JSON.stringify({ type: 'order_progress', data: status }));
    });

    ws.on('close', () => {
      orderProgressClients.get(jobId)?.delete(ws);
    });
  }
});
```

3. **Wire queue-manager to WebSocket broadcast**:
```typescript
// In queue-manager.ts
private progressBroadcaster?: (jobId: string, progress: any) => void;

setProgressBroadcaster(fn: (jobId: string, progress: any) => void) {
  this.progressBroadcaster = fn;
}

private emitProgress(jobId: string, progress: any) {
  if (this.progressBroadcaster) {
    this.progressBroadcaster(jobId, progress);
  }
}
```

4. **Connect in index.ts startup**:
```typescript
queueManager.setProgressBroadcaster((jobId, progress) => {
  const clients = orderProgressClients.get(jobId);
  if (clients) {
    const message = JSON.stringify({
      type: 'order_progress',
      jobId,
      data: progress
    });
    clients.forEach(client => {
      if (client.readyState === WebSocket.OPEN) {
        client.send(message);
      }
    });
  }
});
```

**Acceptance criteria**:
- WebSocket endpoint accepts `?jobId=<id>` query parameter
- Clients receive real-time progress updates for subscribed job
- Progress messages include: type, jobId, data (percent, step, message, estimatedRemainingSeconds)
- Multiple clients can subscribe to same job
- Clients auto-unsubscribe on disconnect
- TypeScript compiles without errors
    </instructions>
  </task>

  <task type="checkpoint:human-verify">
    <description>Verify real-time progress updates via WebSocket</description>
    <instructions>
**Manual test procedure**:

1. **Start backend**:
```bash
cd archibald-web-app/backend
npm run dev
```

2. **Open WebSocket test client** (browser console or wscat):
```javascript
// Browser console
const ws = new WebSocket('ws://localhost:3000/ws/sync?jobId=TEST_JOB_ID');
ws.onmessage = (event) => {
  console.log('Progress update:', JSON.parse(event.data));
};
```

3. **Create test order via API** (Postman or curl):
```bash
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "customerName": "Test Cliente",
    "items": [
      {
        "articleCode": "11.011",
        "quantity": 1
      }
    ]
  }'
```

4. **Observe WebSocket messages** - should receive 9 progress updates:
```
{ type: 'order_progress', jobId: '...', data: { percent: 10, step: 'browser_init', message: 'Inizializzazione browser...', estimatedRemainingSeconds: 75 } }
{ type: 'order_progress', jobId: '...', data: { percent: 15, step: 'login', message: 'Login completato', estimatedRemainingSeconds: 70 } }
... (7 more updates)
{ type: 'order_progress', jobId: '...', data: { percent: 100, step: 'complete', message: 'Ordine creato!', estimatedRemainingSeconds: 0 } }
```

5. **Check logs** - should show progress emissions:
```
[info]: Job 123 progress { progress: { percent: 35, step: 'customer_selection', ... } }
```

**Success criteria**:
- ✅ WebSocket receives 9 distinct progress updates
- ✅ Each update contains percent, step, message, estimatedRemainingSeconds
- ✅ Progress updates arrive in real-time (< 500ms latency)
- ✅ Multiple WebSocket clients can subscribe to same job
- ✅ Order creation completes successfully with Archibald order ID

**If verification fails**:
- Check backend logs for progress emission
- Verify WebSocket connection established (check browser network tab)
- Ensure jobId matches the one returned from POST /api/orders
- Check for TypeScript/runtime errors in console
    </instructions>
  </task>
</tasks>

<verification>
## Automated Checks
- TypeScript compilation: `npm run typecheck` (backend)
- No new ESLint errors: `npm run lint` (backend)
- Existing tests pass: `npm test` (backend)

## Manual Verification
- WebSocket receives 9 granular progress updates
- Progress metadata includes step, message, time estimate
- Multiple clients can track same job simultaneously
- Order creation still completes successfully
- No regression in existing order flow

## Performance Check
- Order creation time unchanged (~82s baseline)
- WebSocket latency < 500ms per update
- No memory leaks from WebSocket subscriptions
</verification>

<success_criteria>
- [ ] processOrder() emits 9 progress milestones with metadata
- [ ] WebSocket endpoint `/ws/sync?jobId=X` broadcasts real-time updates
- [ ] Progress messages include: percent, step, message, estimatedRemainingSeconds
- [ ] Existing bot logic completely unchanged (no createOrder() modifications)
- [ ] TypeScript compiles without errors
- [ ] Manual test confirms real-time progress updates received
- [ ] Order creation completes successfully with Archibald ID
</success_criteria>

<output>
## Files Modified
- `archibald-web-app/backend/src/queue-manager.ts` - Added 9 progress milestones with metadata
- `archibald-web-app/backend/src/index.ts` - WebSocket order progress endpoint

## Documentation
- SUMMARY.md with progress enhancement details
- Code comments explaining progress milestone strategy

## Next Steps
- Plan 05-02: Frontend progress UI component (step-by-step display)
- Plan 05-03: Toast notifications and error message improvements
</output>
