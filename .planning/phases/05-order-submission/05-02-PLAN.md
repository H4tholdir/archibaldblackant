---
phase: 05-order-submission
plan: "02"
type: execute
depends_on: ["05-01"]
---

# Plan 05-02: Frontend Progress UI & Toast Notifications

<objective>
Create real-time order progress UI component with step-by-step status display, time remaining estimate, and non-invasive toast notifications for success/error states, providing clear feedback without blocking agent workflow.
</objective>

<execution_context>
**Phase Goal**: Enhance UX with visual progress tracking and notifications.

**Dependencies**: Plan 05-01 (WebSocket progress tracking) must be complete.

**User Requirements** (from 05-CONTEXT.md):
1. **Step-by-step progress display**: Show specific steps with status icons (‚úÖ ‚è≥ ‚è∏Ô∏è)
2. **Time remaining estimate**: ~45s countdown that updates dynamically
3. **Toast notification**: Green, non-invasive, auto-dismiss after few seconds
4. **Error messages**: Human-readable with actionable guidance

**Existing Frontend**:
- OrderStatus.tsx exists but shows basic progress bar (10%, 25%, 100%)
- Polling-based status updates (2s interval)
- No WebSocket integration on frontend yet
- React + TypeScript

**Design Principles**:
- Non-blocking: Agent can continue working while order processes
- Clear: Always visible what step is happening
- Actionable: Errors tell user what to do next
</execution_context>

<context>
@archibald-web-app/frontend/src/components/OrderStatus.tsx (existing basic status)
@archibald-web-app/frontend/src/components/OrderForm.tsx (lines 1-100: form structure)
@.planning/phases/05-order-submission/05-CONTEXT.md
@.planning/phases/05-order-submission/05-01-PLAN.md (WebSocket progress format)
</context>

<tasks>
  <task type="auto">
    <description>Create OrderProgressTracker component with step-by-step display</description>
    <instructions>
Create new component `archibald-web-app/frontend/src/components/OrderProgressTracker.tsx` with real-time WebSocket-based progress tracking.

**Component interface**:
```typescript
interface OrderProgressTrackerProps {
  jobId: string;
  onComplete: (orderId: string) => void;
  onError: (error: string) => void;
}

interface ProgressStep {
  key: string;
  label: string;
  percent: number;
  status: 'pending' | 'in_progress' | 'complete';
}
```

**Implementation**:
```typescript
import { useState, useEffect } from 'react';

export function OrderProgressTracker({ jobId, onComplete, onError }: OrderProgressTrackerProps) {
  const [currentStep, setCurrentStep] = useState(0);
  const [estimatedRemainingSeconds, setEstimatedRemainingSeconds] = useState(82);
  const [status, setStatus] = useState<'connecting' | 'active' | 'complete' | 'error'>('connecting');

  // Define progress steps matching backend milestones
  const steps: ProgressStep[] = [
    { key: 'browser_init', label: 'Inizializzazione browser', percent: 10, status: 'pending' },
    { key: 'login', label: 'Verifica sessione', percent: 15, status: 'pending' },
    { key: 'session_validated', label: 'Sessione validata', percent: 25, status: 'pending' },
    { key: 'customer_selection', label: 'Selezione cliente', percent: 35, status: 'pending' },
    { key: 'customer_selected', label: 'Cliente selezionato', percent: 50, status: 'pending' },
    { key: 'article_addition', label: 'Aggiunta articoli', percent: 65, status: 'pending' },
    { key: 'articles_added', label: 'Articoli aggiunti', percent: 80, status: 'pending' },
    { key: 'order_save', label: 'Salvataggio ordine', percent: 90, status: 'pending' },
    { key: 'complete', label: 'Ordine creato', percent: 100, status: 'pending' }
  ];

  useEffect(() => {
    // Connect to WebSocket with jobId
    const ws = new WebSocket(`ws://localhost:3000/ws/sync?jobId=${jobId}`);

    ws.onopen = () => {
      console.log('WebSocket connected for order progress');
      setStatus('active');
    };

    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);

      if (message.type === 'order_progress') {
        const { percent, step, estimatedRemainingSeconds } = message.data;

        // Update current step based on percent
        const stepIndex = steps.findIndex(s => s.percent === percent);
        if (stepIndex >= 0) {
          setCurrentStep(stepIndex);
        }

        if (estimatedRemainingSeconds !== undefined) {
          setEstimatedRemainingSeconds(estimatedRemainingSeconds);
        }

        // Check if complete
        if (percent === 100) {
          setStatus('complete');
          // Fetch final result for order ID
          fetch(`/api/orders/status/${jobId}`)
            .then(res => res.json())
            .then(data => {
              if (data.success && data.data.result) {
                onComplete(data.data.result.orderId);
              }
            });
        }
      }
    };

    ws.onerror = () => {
      setStatus('error');
      onError('Errore di connessione WebSocket. Controlla la connessione di rete.');
    };

    ws.onclose = () => {
      console.log('WebSocket closed');
    };

    return () => {
      ws.close();
    };
  }, [jobId]);

  // Calculate step statuses based on currentStep
  const getStepStatus = (index: number): 'pending' | 'in_progress' | 'complete' => {
    if (index < currentStep) return 'complete';
    if (index === currentStep) return 'in_progress';
    return 'pending';
  };

  const formatTime = (seconds: number) => {
    if (seconds < 60) return `${seconds}s`;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
  };

  return (
    <div className="order-progress-tracker">
      <h3>üìä Creazione Ordine in Corso</h3>

      {status === 'active' && (
        <div className="time-estimate">
          ‚è±Ô∏è Tempo rimanente stimato: <strong>{formatTime(estimatedRemainingSeconds)}</strong>
        </div>
      )}

      <div className="progress-steps">
        {steps.map((step, index) => {
          const stepStatus = getStepStatus(index);
          return (
            <div key={step.key} className={`progress-step ${stepStatus}`}>
              <div className="step-icon">
                {stepStatus === 'complete' && '‚úÖ'}
                {stepStatus === 'in_progress' && '‚è≥'}
                {stepStatus === 'pending' && '‚è∏Ô∏è'}
              </div>
              <div className="step-label">{step.label}</div>
              {stepStatus === 'in_progress' && (
                <div className="step-spinner"></div>
              )}
            </div>
          );
        })}
      </div>

      {status === 'connecting' && (
        <div className="status-message connecting">Connessione in corso...</div>
      )}
    </div>
  );
}
```

**CSS styles** (add to App.css or component-specific CSS):
```css
.order-progress-tracker {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.time-estimate {
  font-size: 1.125rem;
  margin: 1rem 0;
  color: #374151;
}

.progress-steps {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.progress-step {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  border-radius: 6px;
  transition: background 0.2s;
}

.progress-step.complete {
  background: #d1fae5;
}

.progress-step.in_progress {
  background: #fef3c7;
  animation: pulse 2s infinite;
}

.progress-step.pending {
  background: #f3f4f6;
  opacity: 0.6;
}

.step-icon {
  font-size: 1.25rem;
}

.step-label {
  flex: 1;
  font-weight: 500;
}

.step-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid #e5e7eb;
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
```

**Acceptance criteria**:
- Component connects to WebSocket with jobId
- Displays 9 progress steps with status icons (‚úÖ ‚è≥ ‚è∏Ô∏è)
- Time remaining updates dynamically
- Calls onComplete with orderId when finished
- Calls onError with message if WebSocket fails
- TypeScript compiles without errors
    </instructions>
  </task>

  <task type="auto">
    <description>Create Toast notification component for success/error feedback</description>
    <instructions>
Create reusable toast notification system in `archibald-web-app/frontend/src/components/Toast.tsx`.

**Component interface**:
```typescript
interface ToastProps {
  message: string;
  type: 'success' | 'error' | 'info';
  duration?: number; // Auto-dismiss after N ms (default 5000)
  onClose: () => void;
}
```

**Implementation**:
```typescript
import { useEffect } from 'react';

export function Toast({ message, type, duration = 5000, onClose }: ToastProps) {
  useEffect(() => {
    const timer = setTimeout(() => {
      onClose();
    }, duration);

    return () => clearTimeout(timer);
  }, [duration, onClose]);

  const getTypeStyles = () => {
    switch (type) {
      case 'success':
        return { background: '#d1fae5', color: '#065f46', icon: '‚úÖ' };
      case 'error':
        return { background: '#fee2e2', color: '#991b1b', icon: '‚ùå' };
      case 'info':
        return { background: '#dbeafe', color: '#1e40af', icon: '‚ÑπÔ∏è' };
    }
  };

  const styles = getTypeStyles();

  return (
    <div
      className="toast"
      style={{
        position: 'fixed',
        top: '1rem',
        right: '1rem',
        background: styles.background,
        color: styles.color,
        padding: '1rem 1.5rem',
        borderRadius: '8px',
        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
        display: 'flex',
        alignItems: 'center',
        gap: '0.75rem',
        minWidth: '320px',
        maxWidth: '500px',
        zIndex: 9999,
        animation: 'slideIn 0.3s ease-out',
      }}
    >
      <span style={{ fontSize: '1.5rem' }}>{styles.icon}</span>
      <span style={{ flex: 1, fontWeight: 500 }}>{message}</span>
      <button
        onClick={onClose}
        style={{
          background: 'transparent',
          border: 'none',
          cursor: 'pointer',
          fontSize: '1.25rem',
          color: styles.color,
          opacity: 0.7,
        }}
      >
        √ó
      </button>
    </div>
  );
}

// Add to App.css
const toastStyles = `
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
`;
```

**Toast Manager Hook** (for easy usage):
```typescript
// archibald-web-app/frontend/src/hooks/useToast.ts
import { useState, useCallback } from 'react';

interface ToastState {
  message: string;
  type: 'success' | 'error' | 'info';
  id: number;
}

export function useToast() {
  const [toasts, setToasts] = useState<ToastState[]>([]);

  const showToast = useCallback((message: string, type: 'success' | 'error' | 'info') => {
    const id = Date.now();
    setToasts(prev => [...prev, { message, type, id }]);
  }, []);

  const hideToast = useCallback((id: number) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  return { toasts, showToast, hideToast };
}
```

**Acceptance criteria**:
- Toast component renders with success/error/info types
- Auto-dismisses after configurable duration
- Manual close button works
- Slide-in animation smooth
- Multiple toasts stack vertically
- TypeScript compiles without errors
    </instructions>
  </task>

  <task type="auto">
    <description>Integrate progress tracker and toasts into OrderForm workflow</description>
    <instructions>
Update OrderForm.tsx to use new OrderProgressTracker and Toast components.

**Integration in OrderForm.tsx**:
```typescript
import { OrderProgressTracker } from './OrderProgressTracker';
import { Toast } from './Toast';
import { useToast } from '../hooks/useToast';

export default function OrderForm({ onOrderCreated }: OrderFormProps) {
  const [jobId, setJobId] = useState<string | null>(null);
  const [showProgressTracker, setShowProgressTracker] = useState(false);
  const { toasts, showToast, hideToast } = useToast();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customerName,
          items,
        }),
      });

      const data = await response.json();

      if (data.success) {
        setJobId(data.jobId);
        setShowProgressTracker(true);
      } else {
        showToast(
          data.error || 'Errore durante la creazione dell\'ordine',
          'error'
        );
      }
    } catch (error) {
      showToast(
        'Errore di rete. Controlla la connessione e riprova.',
        'error'
      );
    } finally {
      setLoading(false);
    }
  };

  const handleOrderComplete = (orderId: string) => {
    showToast(`Ordine #${orderId} creato con successo!`, 'success');
    setShowProgressTracker(false);
    setJobId(null);

    // Reset form
    setCustomerName('');
    setItems([]);
  };

  const handleOrderError = (error: string) => {
    showToast(error, 'error');
    setShowProgressTracker(false);
  };

  return (
    <div>
      {/* Existing form */}
      <form onSubmit={handleSubmit}>
        {/* ... existing form fields ... */}
      </form>

      {/* Progress tracker (replaces OrderStatus component) */}
      {showProgressTracker && jobId && (
        <OrderProgressTracker
          jobId={jobId}
          onComplete={handleOrderComplete}
          onError={handleOrderError}
        />
      )}

      {/* Toast notifications */}
      {toasts.map(toast => (
        <Toast
          key={toast.id}
          message={toast.message}
          type={toast.type}
          onClose={() => hideToast(toast.id)}
        />
      ))}
    </div>
  );
}
```

**Enhanced error messages** (human-readable with actionable guidance):
```typescript
const ERROR_MESSAGES: Record<string, string> = {
  'TIMEOUT': 'Timeout rete dopo 60s. Controlla la connessione e riprova tra 30s.',
  'ARCHIBALD_UNREACHABLE': 'Archibald non risponde. Riprova tra 1 minuto o controlla che Archibald sia accessibile.',
  'CUSTOMER_NOT_FOUND': 'Cliente non trovato. Verifica che il cliente esista in Archibald.',
  'PRODUCT_NOT_FOUND': 'Articolo non trovato. Verifica il codice articolo.',
  'VALIDATION_ERROR': 'Dati non validi. Controlla i campi e riprova.',
  'LOGIN_FAILED': 'Login fallito. Verifica credenziali Archibald.',
  'SESSION_EXPIRED': 'Sessione scaduta. Riprova, verr√† eseguito un nuovo login.',
};

function getHumanReadableError(error: string): string {
  // Check if error matches known patterns
  for (const [key, message] of Object.entries(ERROR_MESSAGES)) {
    if (error.includes(key) || error.includes(key.toLowerCase())) {
      return message;
    }
  }

  // Fallback to generic message with original error (sanitized)
  return `Errore durante la creazione: ${error}. Riprova o contatta il supporto.`;
}
```

**Acceptance criteria**:
- OrderForm shows progress tracker when order submitted
- Progress tracker replaces old OrderStatus polling component
- Success toast appears when order complete
- Error toast shows human-readable message with action
- Form resets after successful order
- TypeScript compiles without errors
    </instructions>
  </task>

  <task type="checkpoint:human-verify">
    <description>Verify end-to-end progress tracking and toast notifications</description>
    <instructions>
**Manual test procedure**:

1. **Start full stack**:
```bash
# Terminal 1: Backend
cd archibald-web-app/backend
npm run dev

# Terminal 2: Frontend
cd archibald-web-app/frontend
npm run dev
```

2. **Open browser**: Navigate to http://localhost:5173

3. **Create test order**:
- Select customer: "Test Cliente"
- Add article: Code "11.011", Quantity 1
- Click "Crea Ordine"

4. **Observe progress tracker**:
- Should appear immediately after submission
- Shows 9 steps with status icons (‚è∏Ô∏è ‚Üí ‚è≥ ‚Üí ‚úÖ)
- Time remaining counts down from ~82s
- Each step transitions smoothly
- Steps match backend milestones

5. **Verify completion**:
- After ~82s, progress reaches 100%
- Toast notification appears: "‚úÖ Ordine #<ID> creato con successo!"
- Progress tracker disappears
- Form resets to empty state
- Toast auto-dismisses after 5s

6. **Test error handling** (simulate network failure):
- Disconnect WiFi after submitting order
- Should see error toast: "Errore di connessione WebSocket. Controlla la connessione di rete."
- Toast has red background with ‚ùå icon
- Manual close button works

7. **Test multiple orders**:
- Create 2 orders in quick succession (different tabs)
- Each should have independent progress tracking
- Toasts should stack vertically

**Success criteria**:
- ‚úÖ Progress tracker shows all 9 steps with correct icons
- ‚úÖ Time estimate counts down dynamically
- ‚úÖ Success toast appears with Archibald order ID
- ‚úÖ Error toast shows human-readable message
- ‚úÖ Toast auto-dismisses after 5s
- ‚úÖ Form resets after success
- ‚úÖ Multiple orders track independently
- ‚úÖ No console errors or WebSocket connection issues

**If verification fails**:
- Check browser console for WebSocket connection errors
- Verify backend WebSocket endpoint is running
- Ensure jobId is correctly passed from form submission
- Check network tab for WebSocket frames
- Verify toast messages match expected text
    </instructions>
  </task>
</tasks>

<verification>
## Automated Checks
- TypeScript compilation: `npm run typecheck` (frontend + backend)
- No new ESLint errors: `npm run lint` (frontend)
- Existing tests pass: `npm test` (frontend)

## Manual Verification
- Progress tracker displays 9 steps with status icons
- Time remaining estimate updates in real-time
- Success toast appears with order ID
- Error toast shows actionable message
- Form resets after successful order
- Multiple orders can be tracked simultaneously

## Performance Check
- WebSocket connection latency < 500ms
- UI updates smooth (no flicker or lag)
- Toast animations perform well (60fps)
- No memory leaks from WebSocket subscriptions
</verification>

<success_criteria>
- [ ] OrderProgressTracker component created with 9-step display
- [ ] Toast notification system with success/error/info types
- [ ] OrderForm integrated with progress tracker and toasts
- [ ] WebSocket real-time updates working end-to-end
- [ ] Human-readable error messages with actionable guidance
- [ ] Success toast shows Archibald order ID
- [ ] TypeScript compiles without errors
- [ ] Manual test confirms full workflow (form ‚Üí progress ‚Üí toast ‚Üí reset)
</success_criteria>

<output>
## Files Created
- `archibald-web-app/frontend/src/components/OrderProgressTracker.tsx` - Step-by-step progress display
- `archibald-web-app/frontend/src/components/Toast.tsx` - Toast notification component
- `archibald-web-app/frontend/src/hooks/useToast.ts` - Toast management hook

## Files Modified
- `archibald-web-app/frontend/src/components/OrderForm.tsx` - Integrated progress tracker and toasts
- `archibald-web-app/frontend/src/App.css` - Added toast and progress styles

## Documentation
- SUMMARY.md with UX enhancement details
- Screenshots of progress tracker and toast notifications

## Phase Complete
Phase 5 objectives achieved:
- ‚úÖ Real-time progress tracking with step-by-step visibility
- ‚úÖ Time remaining estimate (~45s-82s)
- ‚úÖ Non-invasive toast notifications
- ‚úÖ Human-readable error messages
- ‚úÖ NO changes to existing bot, BullMQ, or PriorityManager infrastructure

**User vision honored**: "non dobbiamo rovinare quello che abbiamo gi√† costruito" - all existing infrastructure preserved, only UX enhancements added.
</output>
