# Phase 18 Plan 03: Manual Sync UI & API Endpoint

<objective>
Creare il bottone "Aggiorna Clienti" nella pagina Clienti con banner di notifica sync, endpoint API per trigger manuale, e integrazione con progress tracking real-time.
</objective>

<execution_context>
@archibald-web-app/frontend/src/pages/CustomersPage.tsx (or similar)
@archibald-web-app/frontend/src/components/OfflineBanner.tsx (pattern reference)
@archibald-web-app/backend/src/index.ts
@archibald-web-app/backend/src/customer-sync-service.ts
</execution_context>

<context>
## Current State
- âœ… Plan 18-02 complete: PDF sync working, 15-20s duration
- âœ… CustomerSyncService with progress callbacks
- âŒ No manual sync UI yet
- âŒ No API endpoint for on-demand sync

## UI/UX Design (from 18-CONTEXT.md)

### Button Placement
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Clienti Page                        â”‚
â”‚                                     â”‚
â”‚ [Search bar...]  [ğŸ”„ Aggiorna]    â”‚  â† Manual sync button (top right)
â”‚                                     â”‚
â”‚ [Customer list...]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User Flow
1. User clicks "ğŸ”„ Aggiorna"
2. Button disables + spinner
3. Banner appears: "â³ Aggiornamento clienti in corso..."
4. Backend executes sync (15-20s)
5. Banner updates: "âœ… 1,515 clienti aggiornati" (auto-hide after 3s)
6. Customer list refreshes
7. Button re-enables

### Banner Component
Reuse OfflineBanner pattern:
- Fixed top position (below header)
- Yellow background (â³ in progress)
- Green background (âœ… completed)
- Red background (âŒ error)
- Progress count: "1,234 / 1,515 clienti"
- Auto-hide after 3s on completion

## Technical Approach
- **API Endpoint**: POST /api/customers/sync (manual trigger)
- **Progress Tracking**: Server-Sent Events (SSE) for real-time updates
- **State Management**: React useState for banner visibility
- **Debounce**: Prevent multiple concurrent syncs
</context>

<tasks>
<task type="auto">
## 1. Create API endpoint for manual sync

**File:** `archibald-web-app/backend/src/index.ts`

Add endpoint after existing customer routes:

```typescript
import { customerSyncService, SyncProgress } from './customer-sync-service';

/**
 * Manual customer sync trigger
 * POST /api/customers/sync
 * Triggers on-demand sync and returns result
 */
app.post('/api/customers/sync', async (req, res) => {
  try {
    // Check if sync already in progress
    if (customerSyncService.isSyncInProgress()) {
      return res.status(409).json({
        error: 'Sync already in progress',
        message: 'Un aggiornamento Ã¨ giÃ  in corso. Attendere il completamento.'
      });
    }

    logger.info('[API] Manual customer sync triggered');

    // Execute sync (no progress callback here - use SSE endpoint for that)
    const result = await customerSyncService.syncCustomers();

    if (result.success) {
      res.json({
        success: true,
        customersProcessed: result.customersProcessed,
        newCustomers: result.newCustomers,
        updatedCustomers: result.updatedCustomers,
        duration: result.duration,
        message: `Aggiornamento completato: ${result.newCustomers} nuovi, ${result.updatedCustomers} modificati`
      });
    } else {
      res.status(500).json({
        success: false,
        error: result.error,
        message: 'Errore durante l\'aggiornamento'
      });
    }

  } catch (error: any) {
    logger.error('[API] Manual sync failed:', error);
    res.status(500).json({
      error: error.message,
      message: 'Errore durante l\'aggiornamento clienti'
    });
  }
});

/**
 * Get last sync status
 * GET /api/customers/sync/status
 * Returns sync progress or last sync time
 */
app.get('/api/customers/sync/status', (req, res) => {
  const inProgress = customerSyncService.isSyncInProgress();
  const lastSync = customerSyncService.getLastSyncTime();

  res.json({
    inProgress,
    lastSync: lastSync ? lastSync.toISOString() : null
  });
});
```

**Simple approach without SSE (MVP):**
- Polling-based progress tracking deferred to background sync (Plan 18-04)
- Manual sync returns final result only
- UI shows spinner during sync, result banner after completion
</task>

<task type="auto">
## 2. Create SyncBanner component

**New File:** `archibald-web-app/frontend/src/components/SyncBanner.tsx`

```typescript
import React from 'react';

export type SyncStatus = 'idle' | 'syncing' | 'success' | 'error';

export interface SyncBannerProps {
  status: SyncStatus;
  message?: string;
  progress?: { current: number; total: number };
  onClose?: () => void;
}

/**
 * Banner for displaying sync status (in-progress, success, error)
 * Reuses OfflineBanner pattern with color-coded status
 */
export const SyncBanner: React.FC<SyncBannerProps> = ({
  status,
  message,
  progress,
  onClose
}) => {
  if (status === 'idle') {
    return null;
  }

  // Color coding
  const backgroundColor =
    status === 'syncing' ? '#ff9800' : // Yellow (in progress)
    status === 'success' ? '#4caf50' : // Green (success)
    '#f44336'; // Red (error)

  const icon =
    status === 'syncing' ? 'â³' :
    status === 'success' ? 'âœ…' :
    'âŒ';

  const displayMessage =
    message ||
    (status === 'syncing' ? 'Aggiornamento in corso...' :
     status === 'success' ? 'Aggiornamento completato' :
     'Errore durante aggiornamento');

  return (
    <div
      style={{
        position: 'fixed',
        top: '64px', // Below header
        left: 0,
        right: 0,
        backgroundColor,
        color: 'white',
        padding: '12px 20px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        zIndex: 1000,
        boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
        fontFamily: 'system-ui, -apple-system, sans-serif',
        fontSize: '14px',
        fontWeight: 500
      }}
    >
      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
        <span style={{ fontSize: '18px' }}>{icon}</span>
        <span>{displayMessage}</span>
        {progress && progress.total > 0 && (
          <span style={{ opacity: 0.9 }}>
            ({progress.current} / {progress.total})
          </span>
        )}
      </div>

      {status !== 'syncing' && onClose && (
        <button
          onClick={onClose}
          style={{
            background: 'transparent',
            border: 'none',
            color: 'white',
            cursor: 'pointer',
            fontSize: '18px',
            padding: '4px 8px'
          }}
          aria-label="Chiudi"
        >
          Ã—
        </button>
      )}
    </div>
  );
};
```

**Features:**
- Color-coded status (yellow/green/red)
- Optional progress counter
- Auto-closeable (manual X button)
- Fixed position below header
- Matches OfflineBanner design pattern
</task>

<task type="auto">
## 3. Add manual sync button to CustomersPage

**File:** `archibald-web-app/frontend/src/pages/CustomersPage.tsx` (or wherever customer list lives)

**Find existing page structure and add button + banner:**

```typescript
import React, { useState } from 'react';
import { SyncBanner, SyncStatus } from '../components/SyncBanner';

// Inside component:
const [syncStatus, setSyncStatus] = useState<SyncStatus>('idle');
const [syncMessage, setSyncMessage] = useState<string>('');
const [isSyncing, setIsSyncing] = useState(false);

const handleManualSync = async () => {
  if (isSyncing) return; // Prevent double-click

  setIsSyncing(true);
  setSyncStatus('syncing');
  setSyncMessage('Aggiornamento clienti in corso...');

  try {
    const response = await fetch('/api/customers/sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const result = await response.json();

    if (result.success) {
      setSyncStatus('success');
      setSyncMessage(result.message || `${result.newCustomers} nuovi, ${result.updatedCustomers} aggiornati`);

      // Auto-hide success banner after 3s
      setTimeout(() => {
        setSyncStatus('idle');
        // Refresh customer list
        window.location.reload(); // Simple approach, can optimize with state refresh
      }, 3000);
    } else {
      setSyncStatus('error');
      setSyncMessage(result.message || 'Errore durante aggiornamento');

      // Keep error visible, user must close manually
    }

  } catch (error: any) {
    console.error('Sync failed:', error);
    setSyncStatus('error');
    setSyncMessage('Errore di connessione');
  } finally {
    setIsSyncing(false);
  }
};

// In JSX:
return (
  <div>
    {/* Sync Banner */}
    <SyncBanner
      status={syncStatus}
      message={syncMessage}
      onClose={() => setSyncStatus('idle')}
    />

    {/* Page Header with Sync Button */}
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '20px'
    }}>
      <h1>Clienti</h1>

      {/* Sync Button */}
      <button
        onClick={handleManualSync}
        disabled={isSyncing}
        style={{
          padding: '10px 16px',
          backgroundColor: isSyncing ? '#ccc' : '#2196F3',
          color: 'white',
          border: 'none',
          borderRadius: '4px',
          cursor: isSyncing ? 'not-allowed' : 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          fontSize: '14px',
          fontWeight: 500
        }}
        title="Scarica ultimi clienti da Archibald"
      >
        {isSyncing ? (
          <>
            <span className="spinner" style={{
              display: 'inline-block',
              width: '14px',
              height: '14px',
              border: '2px solid white',
              borderTop: '2px solid transparent',
              borderRadius: '50%',
              animation: 'spin 1s linear infinite'
            }} />
            Aggiornamento...
          </>
        ) : (
          <>
            ğŸ”„ Aggiorna Clienti
          </>
        )}
      </button>
    </div>

    {/* Search bar and customer list */}
    {/* ... existing UI ... */}
  </div>
);
```

**Add spinner animation to CSS:**
```css
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
```

**Key Features:**
- Button disables during sync (prevents concurrent syncs)
- Spinner animation while syncing
- Success banner auto-hides after 3s
- Error banner requires manual close
- Page refreshes after successful sync (simple approach)
</task>

<task type="checkpoint:human-verify">
## 4. Test manual sync button in browser

**Validation:** Open Clienti page and test manual sync button end-to-end.

**Test Steps:**
1. Start backend: `cd archibald-web-app/backend && npm start`
2. Start frontend: `cd archibald-web-app/frontend && npm start`
3. Navigate to Clienti page
4. Click "ğŸ”„ Aggiorna Clienti" button

**Expected Behavior:**
- Button shows spinner: "Aggiornamento..."
- Yellow banner appears: "â³ Aggiornamento clienti in corso..."
- Wait 15-20s (backend sync)
- Green banner appears: "âœ… X nuovi, Y aggiornati"
- Banner auto-hides after 3s
- Customer list refreshes
- Button re-enables

**Edge Cases to Test:**
1. **Double-click prevention**: Click button twice rapidly â†’ should only trigger once
2. **Concurrent sync**: Click while sync in progress â†’ should show "409 Sync already in progress" error
3. **Network error**: Disconnect Wi-Fi, click button â†’ red error banner
4. **Backend down**: Stop backend, click button â†’ red error banner with connection error

If all tests pass, Plan 18-03 is complete.
</task>

<task type="auto">
## 5. Add API client helper for type-safe sync calls

**New File:** `archibald-web-app/frontend/src/api/customers.ts`

```typescript
export interface SyncResult {
  success: boolean;
  customersProcessed: number;
  newCustomers: number;
  updatedCustomers: number;
  duration: number;
  message?: string;
  error?: string;
}

export interface SyncStatus {
  inProgress: boolean;
  lastSync: string | null;
}

/**
 * Trigger manual customer sync
 * @returns Sync result summary
 * @throws Error if sync fails
 */
export async function triggerCustomerSync(): Promise<SyncResult> {
  const response = await fetch('/api/customers/sync', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Sync failed');
  }

  return response.json();
}

/**
 * Get current sync status
 * @returns Sync status (in progress or last sync time)
 */
export async function getCustomerSyncStatus(): Promise<SyncStatus> {
  const response = await fetch('/api/customers/sync/status');

  if (!response.ok) {
    throw new Error('Failed to fetch sync status');
  }

  return response.json();
}
```

Update CustomersPage to use type-safe API client:

```typescript
import { triggerCustomerSync, SyncResult } from '../api/customers';

const handleManualSync = async () => {
  // ... existing state setup ...

  try {
    const result: SyncResult = await triggerCustomerSync();

    if (result.success) {
      setSyncStatus('success');
      setSyncMessage(result.message!);
      // ... auto-hide logic ...
    }

  } catch (error: any) {
    setSyncStatus('error');
    setSyncMessage(error.message);
  }
};
```

**Benefits:**
- Type-safe API calls
- Centralized error handling
- Reusable across components
</task>
</tasks>

<verification>
## Success Criteria
- âœ… POST /api/customers/sync endpoint working
- âœ… GET /api/customers/sync/status endpoint returns status
- âœ… SyncBanner component displays color-coded status
- âœ… Manual sync button in CustomersPage triggers sync
- âœ… Button disables during sync (prevents concurrent syncs)
- âœ… Spinner animation visible during sync
- âœ… Success banner auto-hides after 3s
- âœ… Error banner requires manual close
- âœ… Customer list refreshes after successful sync
- âœ… 409 error if sync already in progress
- âœ… Type-safe API client for sync calls

## Test Commands
```bash
# Test API endpoint manually
curl -X POST http://localhost:3000/api/customers/sync

# Check sync status
curl http://localhost:3000/api/customers/sync/status

# Frontend test: open browser
http://localhost:3001/customers
```

## UI Validation
- Button placement: Top right, next to search bar
- Banner position: Fixed top, below header
- Colors: Yellow (syncing), Green (success), Red (error)
- Auto-hide: Success banner disappears after 3s
- Accessibility: Button has title tooltip, banner has close button
</verification>

<success_criteria>
Plan complete when:
1. API endpoints deployed and functional
2. SyncBanner component rendering correctly
3. Manual sync button triggers sync successfully
4. Banner shows progress and result
5. Customer list refreshes after sync
6. Edge cases handled (double-click, concurrent sync, errors)
7. Type-safe API client integrated
8. Ready for Phase 18-04 (background sync scheduler)
</success_criteria>

<output>
**Deliverables:**
1. POST /api/customers/sync endpoint
2. GET /api/customers/sync/status endpoint
3. SyncBanner component with color-coded status
4. Manual sync button in CustomersPage
5. Type-safe API client for sync operations

**Files Modified:**
- `archibald-web-app/backend/src/index.ts` (+60 lines - 2 endpoints)
- `archibald-web-app/frontend/src/pages/CustomersPage.tsx` (+80 lines - button + logic)

**Files Created:**
- `archibald-web-app/frontend/src/components/SyncBanner.tsx` (~90 lines)
- `archibald-web-app/frontend/src/api/customers.ts` (~50 lines)

**User Flow Validated:**
1. Click "ğŸ”„ Aggiorna" â†’ button disables + spinner
2. Yellow banner: "â³ Aggiornamento in corso..."
3. Wait 15-20s (backend sync)
4. Green banner: "âœ… 1,515 clienti aggiornati"
5. Auto-hide after 3s â†’ list refreshes

**Next:** Plan 18-04 will add background sync scheduler (every 30 minutes).
</output>
