---
phase: 25-sync-monitoring-dashboard
plan: 03
type: execute
---

<objective>
Create frontend monitoring dashboard with 6 sync cards, history tables, error modals, and interval configuration.

Purpose: Provide admin UI for real-time sync monitoring, error inspection, and dynamic interval configuration.
Output: SyncMonitoringDashboard component integrated into AdminPage with 5-second polling, inline styles, and full CRUD functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-sync-monitoring-dashboard/25-CONTEXT.md
@.planning/phases/25-sync-monitoring-dashboard/25-01-SUMMARY.md
@.planning/phases/25-sync-monitoring-dashboard/25-02-SUMMARY.md

**Key files:**
@archibald-web-app/frontend/src/components/SyncControlPanel.tsx (reference for patterns)
@archibald-web-app/frontend/src/pages/AdminPage.tsx

**Tech stack available:**
- Frontend: React 19, TypeScript, inline styles
- Existing patterns: SyncControlPanel with 5s polling (Phase 23)
- API endpoints: GET /api/sync/monitoring/status, POST /api/sync/intervals/:type (from Plan 25-02)

**Established patterns:**
- Inline styles for all React components (Phase 20-05)
- 5-second polling for real-time status updates (Phase 23-01)
- Modal popups for detailed views (Phase 10-06 banking app)
- Color coding: Green (healthy), Orange (warning), Red (error), Blue (running)

**Constraining decisions:**
- Phase 24-01: Green=active, Orange=inactive UI colors (semantic colors)
- CONTEXT.md: 6 cards in grid, each card self-contained with status/config/history
- CONTEXT.md: History size configurable (10/20/50/100 dropdown)
- CONTEXT.md: Error modal with full stack trace for debugging

**From CONTEXT.md - UI Spec:**
- Layout: 6 cards in CSS grid (2 columns desktop, 1 column mobile)
- Card sections: Status (top), Interval config (middle), History table (bottom)
- Status indicators: üü¢ Healthy, üü° Degraded, üî¥ Unhealthy, üîµ Running
- History table: Timestamp, Duration, Status, Error preview, View Details button
- Error modal: Error message, stack trace, context, close button
- Polling: 5 seconds (same as SyncControlPanel)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncMonitoringDashboard component</name>
  <files>archibald-web-app/frontend/src/components/SyncMonitoringDashboard.tsx</files>
  <action>
    Create component with:
    - 6 sync type cards (orders, customers, products, prices, ddt, invoices)
    - State: status, history, intervals, historyLimit (default 20), selectedError
    - 5-second polling via useEffect
    - Grid layout: `display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))', gap: '20px'`

    Structure:
    ```typescript
    import { useState, useEffect } from "react";

    type SyncType = "customers" | "products" | "prices" | "orders" | "ddt" | "invoices";

    interface HistoryEntry {
      timestamp: string;
      duration: number;
      success: boolean;
      error: string | null;
    }

    interface SyncTypeData {
      isRunning: boolean;
      lastRunTime: string | null;
      queuePosition: number | null;
      history: HistoryEntry[];
      health: "healthy" | "unhealthy" | "idle";
    }

    interface MonitoringStatus {
      currentSync: SyncType | null;
      types: Record<SyncType, SyncTypeData>;
    }

    const syncSections = [
      { type: "orders", label: "Ordini", icon: "üì¶", priority: 6 },
      { type: "customers", label: "Clienti", icon: "üë•", priority: 5 },
      { type: "products", label: "Prodotti", icon: "üè∑Ô∏è", priority: 2 },
      { type: "prices", label: "Prezzi", icon: "üí∞", priority: 1 },
      { type: "ddt", label: "DDT", icon: "üöö", priority: 4 },
      { type: "invoices", label: "Fatture", icon: "üìÑ", priority: 3 },
    ];

    export default function SyncMonitoringDashboard() {
      const [status, setStatus] = useState<MonitoringStatus | null>(null);
      const [intervals, setIntervals] = useState<Record<SyncType, number> | null>(null);
      const [historyLimit, setHistoryLimit] = useState(20);
      const [selectedError, setSelectedError] = useState<{
        type: SyncType;
        error: string;
        timestamp: string;
      } | null>(null);
      const [savingInterval, setSavingInterval] = useState<Record<SyncType, boolean>>({} as any);
      const [editedIntervals, setEditedIntervals] = useState<Partial<Record<SyncType, number>>>({});

      useEffect(() => {
        fetchStatus();
        fetchIntervals();

        const interval = setInterval(() => {
          fetchStatus();
        }, 5000);

        return () => clearInterval(interval);
      }, [historyLimit]);

      const fetchStatus = async () => {
        try {
          const jwt = localStorage.getItem("archibald_jwt");
          if (!jwt) return;

          const response = await fetch(`/api/sync/monitoring/status?limit=${historyLimit}`, {
            headers: { Authorization: `Bearer ${jwt}` },
          });

          const data = await response.json();
          if (data.success) {
            setStatus(data);
          }
        } catch (error) {
          console.error("Failed to fetch monitoring status:", error);
        }
      };

      const fetchIntervals = async () => {
        try {
          const jwt = localStorage.getItem("archibald_jwt");
          if (!jwt) return;

          const response = await fetch("/api/sync/intervals", {
            headers: { Authorization: `Bearer ${jwt}` },
          });

          const data = await response.json();
          if (data.success) {
            setIntervals(data.intervals);
          }
        } catch (error) {
          console.error("Failed to fetch intervals:", error);
        }
      };

      const saveInterval = async (type: SyncType) => {
        const newInterval = editedIntervals[type];
        if (!newInterval || newInterval < 5 || newInterval > 1440) {
          alert("Interval must be between 5 and 1440 minutes");
          return;
        }

        setSavingInterval((prev) => ({ ...prev, [type]: true }));

        try {
          const jwt = localStorage.getItem("archibald_jwt");
          const response = await fetch(`/api/sync/intervals/${type}`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${jwt}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ intervalMinutes: newInterval }),
          });

          const data = await response.json();
          if (data.success) {
            alert(`‚úÖ Interval updated to ${newInterval} minutes`);
            fetchIntervals();
            setEditedIntervals((prev) => {
              const copy = { ...prev };
              delete copy[type];
              return copy;
            });
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Failed to save interval:", error);
          alert("Failed to save interval");
        } finally {
          setSavingInterval((prev) => ({ ...prev, [type]: false }));
        }
      };

      // Render 6 cards in grid...
      // (Implementation continues with card rendering, history table, error modal)
    }
    ```

    Each card renders:
    - Status section with health indicator, last run time, duration
    - Interval config with input + save button
    - History table with timestamp, duration, success/failure, error preview, "View Details" button
    - History table sortable (newest first)
    - Error preview: first 50 chars of error message with "..."
    - Click "View Details" ‚Üí setSelectedError() ‚Üí opens modal

    Use inline styles consistent with SyncControlPanel pattern.
    Color borders based on health: green (#4caf50), orange (#ff9800), red (#f44336), blue (#2196f3).
  </action>
  <verify>Component compiles, renders 6 cards, fetches data, displays history tables</verify>
  <done>SyncMonitoringDashboard component created with 6 cards, polling, and state management</done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorDetailsModal component</name>
  <files>archibald-web-app/frontend/src/components/ErrorDetailsModal.tsx</files>
  <action>
    Create modal component for displaying full error details:

    ```typescript
    interface ErrorDetailsModalProps {
      error: {
        type: string;
        error: string;
        timestamp: string;
      } | null;
      onClose: () => void;
    }

    export default function ErrorDetailsModal({ error, onClose }: ErrorDetailsModalProps) {
      if (!error) return null;

      return (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: "rgba(0, 0, 0, 0.5)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 9999,
          }}
          onClick={onClose}
        >
          <div
            style={{
              backgroundColor: "white",
              borderRadius: "8px",
              padding: "24px",
              width: "80vw",
              maxWidth: "900px",
              maxHeight: "80vh",
              overflow: "auto",
              boxShadow: "0 4px 20px rgba(0, 0, 0, 0.15)",
            }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{ marginBottom: "20px", borderBottom: "2px solid #eee", paddingBottom: "16px" }}>
              <h2 style={{ margin: 0, fontSize: "24px", fontWeight: 600, color: "#333" }}>
                ‚ùå Sync Error Details
              </h2>
              <p style={{ margin: "8px 0 0 0", fontSize: "14px", color: "#666" }}>
                <strong>Type:</strong> {error.type} | <strong>Time:</strong>{" "}
                {new Date(error.timestamp).toLocaleString("it-IT")}
              </p>
            </div>

            {/* Error Message */}
            <div style={{ marginBottom: "20px" }}>
              <h3 style={{ margin: "0 0 8px 0", fontSize: "16px", fontWeight: 600, color: "#d32f2f" }}>
                Error Message
              </h3>
              <div
                style={{
                  padding: "12px",
                  backgroundColor: "#ffebee",
                  border: "1px solid #f44336",
                  borderRadius: "4px",
                  fontFamily: "monospace",
                  fontSize: "13px",
                  color: "#c62828",
                  whiteSpace: "pre-wrap",
                  wordBreak: "break-word",
                }}
              >
                {error.error}
              </div>
            </div>

            {/* Stack Trace */}
            <div style={{ marginBottom: "20px" }}>
              <h3 style={{ margin: "0 0 8px 0", fontSize: "16px", fontWeight: 600, color: "#333" }}>
                Stack Trace
              </h3>
              <div
                style={{
                  padding: "12px",
                  backgroundColor: "#f5f5f5",
                  border: "1px solid #ddd",
                  borderRadius: "4px",
                  fontFamily: "monospace",
                  fontSize: "12px",
                  color: "#333",
                  whiteSpace: "pre-wrap",
                  wordBreak: "break-word",
                  maxHeight: "300px",
                  overflow: "auto",
                }}
              >
                {error.error.includes("\n") ? error.error : "Stack trace not available"}
              </div>
            </div>

            {/* Close Button */}
            <div style={{ display: "flex", justifyContent: "flex-end" }}>
              <button
                onClick={onClose}
                style={{
                  padding: "10px 24px",
                  backgroundColor: "#2196f3",
                  color: "white",
                  border: "none",
                  borderRadius: "4px",
                  cursor: "pointer",
                  fontWeight: 600,
                  fontSize: "14px",
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }
    ```

    Import and use in SyncMonitoringDashboard:
    - Render at bottom: `<ErrorDetailsModal error={selectedError} onClose={() => setSelectedError(null)} />`
    - Click outside or Close button ‚Üí setSelectedError(null)
  </action>
  <verify>Modal renders, displays error details, closes on click outside or Close button</verify>
  <done>ErrorDetailsModal component created with full error display and close functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SyncMonitoringDashboard into AdminPage</name>
  <files>archibald-web-app/frontend/src/pages/AdminPage.tsx</files>
  <action>
    Add SyncMonitoringDashboard after SyncControlPanel (around line 100+):

    1. Import at top:
    ```typescript
    import SyncMonitoringDashboard from "../components/SyncMonitoringDashboard";
    ```

    2. Add section after SyncControlPanel component:
    ```tsx
    {/* Sync Monitoring Dashboard (Phase 25) */}
    <div style={{ marginBottom: "40px" }}>
      <h2 style={{ marginBottom: "16px", fontSize: "24px", fontWeight: 600 }}>
        üìä Sync Monitoring Dashboard
      </h2>
      <SyncMonitoringDashboard />
    </div>
    ```

    Place after the SyncControlPanel section, before other admin sections.
    Both panels visible: SyncControlPanel (manual controls + auto-sync toggle) above, SyncMonitoringDashboard (monitoring + config) below.
  </action>
  <verify>AdminPage renders with SyncMonitoringDashboard visible below SyncControlPanel</verify>
  <done>SyncMonitoringDashboard integrated into AdminPage</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Sync Monitoring Dashboard with 6 cards, history tables, error modal, and interval configuration</what-built>
  <how-to-verify>
    1. Start backend: cd archibald-web-app/backend && npm run dev
    2. Start frontend: cd archibald-web-app/frontend && npm run dev
    3. Login as admin and navigate to Admin page
    4. Scroll to "üìä Sync Monitoring Dashboard" section
    5. Verify 6 cards render (Orders, Customers, Products, Prices, DDT, Invoices)
    6. Check status section: health indicator (üü¢/üü°/üî¥/üîµ), last run time, duration
    7. Check interval config: input field shows current interval, has save button
    8. Check history table: shows last 20 executions, timestamp, duration, status (‚úÖ/‚ùå)
    9. Test history limit dropdown: change from 20 to 50, verify table updates
    10. Trigger a sync from SyncControlPanel above, verify dashboard updates in real-time (5s)
    11. If any sync failed, verify error preview shows (first 50 chars)
    12. Click "üëÅÔ∏è View Details" on failed sync ‚Üí verify modal opens with full error + stack trace
    13. Click outside modal or Close button ‚Üí verify modal closes
    14. Edit interval for one sync type (e.g., Orders from 10 to 15 minutes)
    15. Click Save ‚Üí verify success message "‚úÖ Interval updated to 15 minutes"
    16. Check backend logs ‚Üí verify auto-sync restarted with new interval
    17. Verify validation: try interval < 5 or > 1440 ‚Üí should show error alert
    18. Wait for next auto-sync cycle ‚Üí verify dashboard updates with new execution

    Success: Dashboard provides comprehensive monitoring, history accurate, intervals configurable, error modal functional, real-time updates working.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation succeeds (npm run build)
- [ ] SyncMonitoringDashboard component renders 6 cards
- [ ] ErrorDetailsModal displays full error details
- [ ] AdminPage integration successful
- [ ] 5-second polling updates dashboard in real-time
- [ ] Interval configuration saves and restarts auto-sync
- [ ] User verification passed
</verification>

<success_criteria>
- SyncMonitoringDashboard component created with 6 sync cards
- Each card shows status, interval config, and history table
- ErrorDetailsModal displays full error details with stack trace
- Dashboard integrated into AdminPage below SyncControlPanel
- 5-second polling for real-time updates
- Interval configuration functional with validation (5-1440 minutes)
- History table shows last N executions (configurable via dropdown)
- Health indicators color-coded (green/orange/red/blue)
- User verification passed
</success_criteria>

<output>
Create `.planning/phases/25-sync-monitoring-dashboard/25-03-SUMMARY.md`
</output>
