---
phase: 25-sync-monitoring-dashboard
plan: 01
type: execute
---

<objective>
Add sync history tracking to SyncOrchestrator for monitoring dashboard.

Purpose: Enable monitoring dashboard to display past sync executions with timestamps, durations, success/failure status, and error details.
Output: SyncOrchestrator tracks last 100 executions per sync type in memory with full metadata.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-sync-monitoring-dashboard/25-CONTEXT.md

**Key files:**
@archibald-web-app/backend/src/sync-orchestrator.ts

**Tech stack available:**
- Backend: Express.js, TypeScript, EventEmitter pattern
- SyncOrchestrator: Singleton service coordinating all 6 sync types
- Existing infrastructure: Phase 22 orchestration, Phase 24 auto-sync

**Established patterns:**
- Inline styles for all React components (Phase 20-05)
- Admin-only API endpoints with JWT + requireAdmin middleware (Phase 24-01)
- EventEmitter for progress tracking (Phase 21-04)
- 5-second polling for real-time status updates (Phase 23-01)

**Constraining decisions:**
- Phase 24-01: Auto-sync enabled by default, admin controls for start/stop
- Phase 23-01: 6 sync types (customers, products, prices, orders, ddt, invoices)
- Phase 22: SyncOrchestrator mutex ensures only one sync at a time

**From CONTEXT.md:**
- In-memory array tracking (max 100 entries per type)
- Store: timestamp, duration, success, error message, syncType
- No SQLite persistence (optional future enhancement)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add syncHistory data structure to SyncOrchestrator</name>
  <files>archibald-web-app/backend/src/sync-orchestrator.ts</files>
  <action>
    Add to SyncOrchestrator class (after line 77, near other private fields):

    ```typescript
    // Sync history tracking (max 100 entries per type)
    private syncHistory: Record<SyncType, Array<{
      timestamp: Date;
      duration: number; // milliseconds
      success: boolean;
      error: string | null;
      syncType: SyncType;
    }>> = {
      customers: [],
      products: [],
      prices: [],
      orders: [],
      ddt: [],
      invoices: [],
    };
    private readonly MAX_HISTORY_PER_TYPE = 100;
    ```

    Add public method to get history (after isAutoSyncRunning() method, around line 420):

    ```typescript
    /**
     * Get sync history for a specific type or all types.
     */
    getHistory(type?: SyncType, limit?: number): Array<{
      timestamp: Date;
      duration: number;
      success: boolean;
      error: string | null;
      syncType: SyncType;
    }> {
      if (type) {
        const history = this.syncHistory[type];
        return limit ? history.slice(0, limit) : history;
      }

      // Return all history sorted by timestamp (newest first)
      const allHistory: Array<{
        timestamp: Date;
        duration: number;
        success: boolean;
        error: string | null;
        syncType: SyncType;
      }> = [];

      for (const syncType of Object.keys(this.syncHistory) as SyncType[]) {
        allHistory.push(...this.syncHistory[syncType]);
      }

      allHistory.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
      return limit ? allHistory.slice(0, limit) : allHistory;
    }

    /**
     * Add entry to sync history.
     * Maintains max 100 entries per type (FIFO).
     */
    private addHistoryEntry(
      type: SyncType,
      duration: number,
      success: boolean,
      error: string | null
    ): void {
      const entry = {
        timestamp: new Date(),
        duration,
        success,
        error,
        syncType: type,
      };

      this.syncHistory[type].unshift(entry); // Add to front (newest first)

      // Trim to max size
      if (this.syncHistory[type].length > this.MAX_HISTORY_PER_TYPE) {
        this.syncHistory[type] = this.syncHistory[type].slice(0, this.MAX_HISTORY_PER_TYPE);
      }
    }
    ```
  </action>
  <verify>TypeScript compiles without errors: cd archibald-web-app/backend && npm run build</verify>
  <done>SyncOrchestrator has syncHistory data structure and getHistory() + addHistoryEntry() methods</done>
</task>

<task type="auto">
  <name>Task 2: Integrate history tracking into executeSync method</name>
  <files>archibald-web-app/backend/src/sync-orchestrator.ts</files>
  <action>
    Modify executeSync() method (around line 175) to track execution time and record history:

    Find the executeSync method and wrap the sync execution with timing:

    ```typescript
    private async executeSync(type: SyncType, userId?: string): Promise<void> {
      this.currentSync = type;
      const startTime = Date.now();
      let success = false;
      let errorMessage: string | null = null;

      try {
        logger.info(`[SyncOrchestrator] Starting ${type} sync`, { userId });

        // Existing sync logic (lines 180-220 approximately)
        switch (type) {
          case "customers":
            await this.customerSync.syncFull(userId);
            break;
          case "products":
            await this.productSync.syncFull(userId);
            break;
          case "prices":
            await this.priceSync.syncFull(userId);
            break;
          case "orders":
            await this.orderSync.syncFull(userId);
            break;
          case "ddt":
            await this.ddtSync.syncFull(userId);
            break;
          case "invoices":
            await this.invoiceSync.syncFull(userId);
            break;
        }

        success = true;
        this.lastRunTimes[type] = new Date();
        logger.info(`[SyncOrchestrator] Completed ${type} sync`, { userId });
      } catch (error: any) {
        success = false;
        errorMessage = error?.message || String(error);
        logger.error(`[SyncOrchestrator] Failed ${type} sync`, {
          userId,
          error: errorMessage,
          stack: error?.stack,
        });
        throw error;
      } finally {
        const duration = Date.now() - startTime;

        // Record history entry
        this.addHistoryEntry(type, duration, success, errorMessage);

        this.currentSync = null;

        // Process queue (existing logic)
        this.processQueue();
      }
    }
    ```

    The key changes:
    1. Add startTime = Date.now() at method start
    2. Add success flag and errorMessage tracking
    3. In finally block: calculate duration, call addHistoryEntry()
    4. Preserve existing try/catch/finally structure and queue processing
  </action>
  <verify>TypeScript compiles: cd archibald-web-app/backend && npm run build</verify>
  <done>executeSync() records history entries with timestamp, duration, success/failure, and error details</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation succeeds (npm run build)
- [ ] No runtime errors when starting server
- [ ] SyncOrchestrator has getHistory() method available
- [ ] History tracking integrated into executeSync()
</verification>

<success_criteria>
- syncHistory data structure added to SyncOrchestrator
- getHistory() and addHistoryEntry() methods implemented
- executeSync() modified to track timing and record history
- Max 100 entries per type enforced (FIFO)
- TypeScript compiles without errors
</success_criteria>

<output>
Create `.planning/phases/25-sync-monitoring-dashboard/25-01-SUMMARY.md`
</output>
