---
dependencies:
  - .planning/phases/11-order-management/11-CONTEXT.md
  - .planning/phases/10-order-history/10-01-SUMMARY.md
  - .planning/phases/10-order-history/10-02-SUMMARY.md
  - .planning/phases/10-order-history/10-03-SUMMARY.md
  - .planning/phases/10-order-history/10-04-SUMMARY.md
---

# Plan 11-01: Research Order Management Pages and Workflows

<objective>
Research Archibald's order management pages (DDT, Fatture, order states), document scraping structures and "Invia a Milano" workflow for Phase 11 implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/references/checkpoints.md
@~/.claude/get-shit-done/references/tdd.md
@archibald-web-app/backend/src/archibald-bot.ts
@archibald-web-app/backend/src/order-history-service.ts
@.planning/archibald-ui-selectors.md
@elementi pagina ordini.txt
</execution_context>

<context>
## What We Know

**Phase 10 Patterns** (reusable for Phase 11):
- Text-based element identification (DevExpress dynamic IDs unreliable)
- Label-based field extraction with flexible patterns
- Pattern-based column detection in tables
- Direct URL navigation faster than menu clicks
- Pagination handling with duplicate detection

**Phase 11 Requirements from CONTEXT.md**:

1. **DDT Page** (`CUSTPACKINGSLIPJOUR_ListView`):
   - DDT number (e.g., DDT/26000515)
   - Tracking number with clickable courier links
   - Order ID matching (ORD/26000XXX + customer ID)

2. **Fatture Page** (`CUSTINVOICEJOUR_ListView`):
   - Invoice number, date, amount
   - PDF download mechanism (to investigate)
   - Invoice matching strategy

3. **Order States** (from ARCHIBALD AGENTI.pptx):
   - Creato → Piazzato → Inviato a Milano → In lavorazione → Spedito → Consegnato
   - State transition logic

4. **"Invio a Milano" Workflow** (Step 2):
   - Checkbox selector for order selection
   - "Invio" button workflow
   - Confirmation modals
   - Success verification

## What We Need to Discover

**High Priority:**

1. **DDT Page Scraping**:
   - Exact HTML structure of table
   - Column headers and data extraction patterns
   - Tracking link format per courier (FedEx, UPS, etc.)
   - Pagination mechanism (similar to order history?)

2. **Invoice Page Scraping**:
   - Table structure and column mapping
   - PDF download mechanism (direct link? button? modal?)
   - How to handle PDF in Puppeteer context

3. **"Invio" Button Workflow**:
   - Exact selectors for checkbox and button
   - Confirmation modal structure
   - Success/error feedback elements
   - How to verify operation completed

4. **Order Matching Strategy**:
   - Verify ORD/26000XXX IDs are stable across pages
   - Alternative matching fields (customer ID, order date, etc.)
   - Handle edge cases (multiple orders same customer)

**Questions to Resolve:**

- Are tracking links direct URLs or require additional navigation?
- Does PDF download work with Puppeteer's download API?
- Can "Invio" button be clicked programmatically (no CAPTCHA)?
- What happens if order already sent to Milano (error handling)?

## Research Scope

**In Scope:**
- Document UI selectors for DDT and Fatture pages
- Analyze "Invio" button workflow with screenshots
- Verify order matching strategy reliability
- Identify PDF download mechanism

**Out of Scope:**
- Actual scraping implementation (Plan 11-03, 11-06)
- Database schema changes (Plan 11-04)
- UI components (Plan 11-05)

**Deliverable:**
- `11-01-RESEARCH.md` with comprehensive findings
- UI selectors appended to `.planning/archibald-ui-selectors.md` if needed
- Decision on implementation approach for each feature
</context>

<tasks>
## Task 1: Analyze DDT Page Structure (type: auto)

**Goal**: Document DDT page HTML structure and data extraction strategy.

**Actions**:
1. Launch Puppeteer with active Archibald session
2. Navigate to DDT page: `https://4.231.124.90/Archibald/CUSTPACKINGSLIPJOUR_ListView/`
3. Take screenshot of page with visible DDT entries
4. Inspect table structure:
   - Identify column headers (similar to Phase 10 pattern-based detection)
   - Document data fields: DDT number, tracking number, order ID, customer, dates
   - Analyze tracking link structure (href pattern, courier detection)
5. Test pagination:
   - Check if pagination similar to order history (Next button, page counter)
   - Document pagination selectors
6. Analyze tracking links:
   - Extract sample tracking URLs for FedEx, UPS Italia
   - Document URL format per courier

**Acceptance**:
- Screenshot showing DDT table structure
- Documented column detection strategy
- Tracking link format per courier
- Pagination mechanism documented

## Task 2: Analyze Invoice Page Structure (type: auto)

**Goal**: Document Fatture page HTML structure and PDF download mechanism.

**Actions**:
1. Navigate to Fatture page: `https://4.231.124.90/Archibald/CUSTINVOICEJOUR_ListView/`
2. Take screenshot of invoice table
3. Inspect table structure:
   - Column headers and data fields
   - Invoice number, date, amount extraction
4. Investigate PDF download:
   - Look for download link/button per invoice row
   - Click download link and observe behavior:
     - Direct download? Modal? New tab?
   - Test Puppeteer download interception (page.on('download'))
   - Document PDF download selector and workflow
5. Analyze invoice matching:
   - How to match invoice to order? (Order ID visible in table?)
   - Alternative matching fields

**Acceptance**:
- Screenshot showing invoice table structure
- PDF download mechanism documented
- Puppeteer download approach decided
- Invoice-to-order matching strategy decided

## Task 3: Analyze "Invio a Milano" Workflow (type: checkpoint:human-verify)

**Goal**: Document "Invio" button workflow and verify automation feasibility.

**Actions**:
1. Navigate to main orders page
2. Locate checkbox for order selection:
   - Document checkbox selector (by order ID matching)
   - Test programmatic checkbox click
3. Locate "Invio" button:
   - Document button selector
   - Analyze enabled/disabled state logic
4. Click "Invio" button and observe:
   - Confirmation modal? (take screenshot)
   - Success feedback? (toast notification? page reload?)
   - Error handling? (what if order not eligible?)
5. Verify success:
   - How to confirm order was sent? (state change? confirmation message?)
6. Test automation safety:
   - Can workflow be automated safely?
   - Any CAPTCHA or anti-bot measures?

**Acceptance**:
- Screenshot of each step (checkbox, button, confirmation, success)
- Complete selector documentation
- Success verification strategy defined
- Automation feasibility confirmed

**Checkpoint**: User must verify that testing "Invio" button on real order is safe or provide test order ID.

## Task 4: Verify Order Matching Strategy (type: auto)

**Goal**: Confirm order ID matching is reliable across all pages.

**Actions**:
1. Pick sample order from order history with known ID (e.g., ORD/26000552)
2. Verify ID appears in:
   - Main orders page
   - DDT page (if shipped)
   - Invoice page (if invoiced)
3. Document ID format consistency
4. Test edge cases:
   - Multiple orders for same customer (IDs unique?)
   - Old orders (ID format stable over time?)
5. Document alternative matching fields:
   - Customer ID + order date combination
   - Fallback strategy if ID not found

**Acceptance**:
- Order ID verified across 3+ pages
- Matching strategy documented with confidence level
- Edge case handling defined

## Task 5: Document Research Findings (type: auto)

**Goal**: Consolidate all research into `11-01-RESEARCH.md` document.

**Actions**:
1. Create `11-01-RESEARCH.md` in `.planning/phases/11-order-management/`
2. Document findings for each research area:
   - DDT page structure
   - Invoice page structure
   - "Invio" workflow
   - Order matching strategy
3. Include screenshots (embed or reference)
4. Provide implementation recommendations:
   - Which patterns from Phase 10 to reuse
   - New patterns needed for Phase 11
   - Estimated complexity per feature
5. Document open questions or blockers
6. Update `.planning/archibald-ui-selectors.md` if new selectors found

**Acceptance**:
- Complete `11-01-RESEARCH.md` document
- All screenshots saved and referenced
- Implementation recommendations clear
- No unresolved blocking questions

</tasks>

<verification>
## Success Criteria

- [ ] DDT page structure fully documented with selectors
- [ ] Invoice page structure documented with PDF download mechanism
- [ ] "Invio a Milano" workflow automated safely
- [ ] Order matching strategy verified reliable
- [ ] `11-01-RESEARCH.md` created with comprehensive findings
- [ ] No blocking unknowns for Plans 11-02 through 11-07
- [ ] Screenshots captured for each page/workflow

## Verification Steps

1. Review `11-01-RESEARCH.md` for completeness
2. Verify all screenshots present and clear
3. Check that implementation recommendations align with Phase 10 patterns
4. Confirm no unresolved blocking questions
5. Validate selectors by re-running Puppeteer navigation to each page
</verification>

<success_criteria>
Complete research document enabling confident implementation of Plans 11-02 through 11-07 without unknown blockers.
</success_criteria>

<output>
- `.planning/phases/11-order-management/11-01-RESEARCH.md` - Comprehensive research findings
- Screenshots of DDT, Fatture, "Invio" workflow
- Updated `.planning/archibald-ui-selectors.md` (if needed)
</output>
