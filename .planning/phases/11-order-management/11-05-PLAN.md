---
dependencies:
  - .planning/phases/11-order-management/11-02-PLAN.md
  - .planning/phases/11-order-management/11-03-PLAN.md
  - .planning/phases/11-order-management/11-04-PLAN.md
  - archibald-web-app/frontend/src/components/OrderHistory.tsx
  - .planning/phases/10-order-history/10-06-SUMMARY.md
---

# Plan 11-05: Build Status Tracking UI with Timeline

<objective>
Create timeline UI components displaying order lifecycle with states, dates, DDT, tracking links, and "Invia a Milano" button for eligible orders.
</objective>

<execution_context>
@~/.claude/get-shit-done/references/checkpoints.md
@~/.claude/get-shit-done/references/tdd.md
@archibald-web-app/frontend/src/components/OrderHistory.tsx
@archibald-web-app/frontend/src/components/OrderCard.tsx
@.planning/phases/10-order-history/10-06-SUMMARY.md
</execution_context>

<context>
## UI Requirements from 11-CONTEXT.md

**Timeline Visualization**:
- Date/time of each state change
- Current state highlighted
- DDT number (when available)
- Tracking number with clickable link to courier (when available)
- Invoice number (when available - from Plan 11-06)

**"Invia a Milano" Button**:
- Only for orders in "Piazzato su Archibald" state
- Clear warning: "After sending, order cannot be modified"
- Confirmation modal before action
- Loading state during operation
- Success/error feedback

**Edit Orders** (only pre-Step 1):
- Edit button for orders in "Creato" state
- Navigate to OrderForm with pre-filled data
- Out of scope: Edit orders after Step 1 (future feature)

## Reusable Patterns from Phase 10

- **OrderCard Component**: Expand/collapse pattern (Plan 10-06)
- **Temporal Grouping**: Oggi/Settimana/Mese/Vecchi (Plan 10-06)
- **Status Color Coding**: Blue (In lavorazione), green (Evaso/Consegnato), purple (Spedito), gray (default)
- **Banking App Style**: Clean, modern, professional (Plan 08-06, 09-03)

## Component Structure

```
OrderHistory
â”œâ”€â”€ OrderStatusFilter (chips: Tutti, Piazzato, In lavorazione, Spedito, Consegnato)
â”œâ”€â”€ OrderCard (per order)
â”‚   â”œâ”€â”€ OrderCardHeader (customer, date, total, status badge)
â”‚   â”œâ”€â”€ OrderCardBody (collapsed/expanded)
â”‚   â”‚   â”œâ”€â”€ OrderTimeline (state history with dates)
â”‚   â”‚   â”œâ”€â”€ OrderTracking (DDT + tracking link if available)
â”‚   â”‚   â”œâ”€â”€ OrderActions (Invia a Milano button, Edit button)
â”‚   â”‚   â””â”€â”€ OrderItems (article list)
â””â”€â”€ ForceRefreshButton (manual sync)
```

## New Components Needed

1. **OrderTimeline**: Vertical timeline with state progression
2. **OrderTracking**: DDT and tracking info with clickable courier link
3. **OrderActions**: Action buttons (Invia a Milano, Edit)
4. **SendToMilanoModal**: Confirmation modal with warning
5. **EditOrderButton**: Navigate to OrderForm with draft restoration

## Out of Scope

- Invoice PDF download (Plan 11-06)
- Edit orders after Step 1 (future feature)
- Push notifications (explicitly out of scope in 11-CONTEXT.md)
</context>

<tasks>
## Task 1: Create OrderTimeline Component (type: auto)

**Goal**: Display vertical timeline showing order state progression.

**Actions**:
1. Create `archibald-web-app/frontend/src/components/OrderTimeline.tsx`
2. Component props:
   ```typescript
   interface OrderTimelineProps {
     stateHistory: Array<{
       state: string;
       changedAt: string;
       notes?: string;
     }>;
     currentState: string;
   }
   ```
3. Render vertical timeline:
   - Each state as timeline node with:
     - State icon (checkmark, clock, truck, etc.)
     - State label (Italian translation)
     - Date/time formatted (e.g., "15 Gen, 14:30")
     - Optional notes below
   - Current state highlighted (bold, colored dot)
   - Past states grayed out
   - Future states (not yet reached) dashed line
4. State translations:
   ```typescript
   const stateLabels = {
     creato: 'Creato',
     piazzato: 'Piazzato su Archibald',
     inviato_milano: 'Inviato a Milano',
     in_lavorazione: 'In lavorazione',
     spedito: 'Spedito',
     consegnato: 'Consegnato'
   };
   ```
5. Color coding (reuse Phase 10 pattern):
   - Blue: in_lavorazione
   - Purple: spedito
   - Green: consegnato
   - Gray: creato, piazzato, inviato_milano
6. Responsive design (mobile-friendly)

**Acceptance**:
- OrderTimeline component renders vertical timeline
- Current state highlighted
- Past/future states visually distinct
- Italian state labels
- Responsive on mobile

## Task 2: Create OrderTracking Component (type: auto)

**Goal**: Display DDT and tracking info with clickable courier link.

**Actions**:
1. Create `archibald-web-app/frontend/src/components/OrderTracking.tsx`
2. Component props:
   ```typescript
   interface OrderTrackingProps {
     ddtNumber?: string;
     trackingNumber?: string;
     trackingUrl?: string;
     trackingCourier?: string;
   }
   ```
3. Render tracking info:
   - DDT number with icon (ðŸ“¦)
   - Tracking number with courier logo (FedEx, UPS, DHL)
   - Clickable link: "Traccia spedizione" â†’ opens trackingUrl in new tab
   - If no tracking data: "Tracciamento non ancora disponibile"
4. Courier icons/logos:
   - FedEx: Purple/orange theme
   - UPS: Brown theme
   - DHL: Yellow/red theme
   - Generic: Gray package icon
5. Styling:
   - Card layout with border
   - Hover effect on tracking link
   - Mobile-friendly (stack on small screens)

**Acceptance**:
- OrderTracking component renders DDT and tracking
- Tracking link opens in new tab
- Courier-specific styling
- Graceful fallback when no tracking data
- Responsive on mobile

## Task 3: Create SendToMilanoModal Component (type: auto)

**Goal**: Confirmation modal for "Invia a Milano" action with clear warning.

**Actions**:
1. Create `archibald-web-app/frontend/src/components/SendToMilanoModal.tsx`
2. Component props:
   ```typescript
   interface SendToMilanoModalProps {
     isOpen: boolean;
     onClose: () => void;
     onConfirm: () => void;
     orderId: string;
     customerName: string;
     isLoading: boolean;
   }
   ```
3. Modal content:
   - Title: "Invia Ordine a Milano"
   - Order summary: customer name, order ID
   - **Warning message** (red box):
     - "âš ï¸ Attenzione: dopo l'invio, l'ordine NON potrÃ  piÃ¹ essere modificato."
     - "Questa azione Ã¨ irreversibile."
   - Buttons:
     - "Annulla" (secondary, closes modal)
     - "Conferma e Invia" (primary, red, calls onConfirm)
4. Loading state:
   - Disable buttons when isLoading=true
   - Show spinner on confirm button
   - Prevent modal close during loading
5. Banking app style (reuse Phase 9 modal patterns)

**Acceptance**:
- SendToMilanoModal component with clear warning
- Red warning box stands out
- Loading state prevents interaction
- Accessible (keyboard navigation, ARIA labels)
- Mobile-friendly

## Task 4: Add OrderActions Component to OrderCard (type: auto)

**Goal**: Add action buttons to OrderCard for "Invia a Milano" and Edit.

**Actions**:
1. Create `archibald-web-app/frontend/src/components/OrderActions.tsx`
2. Component props:
   ```typescript
   interface OrderActionsProps {
     orderId: string;
     currentState: string;
     archibaldOrderId?: string;
     onSendToMilano: () => void;
     onEdit: () => void;
   }
   ```
3. Conditional button rendering:
   - **If currentState === 'piazzato'**:
     - Show "Invia a Milano" button (yellow, with warning icon)
   - **If currentState === 'creato'**:
     - Show "Modifica" button (blue)
   - **Otherwise**:
     - Show "Ordine non modificabile" (gray, disabled)
4. Button click handlers:
   - "Invia a Milano" â†’ open SendToMilanoModal
   - "Modifica" â†’ navigate to OrderForm with orderId (restore draft)
5. Styling:
   - Buttons inline (desktop) or stacked (mobile)
   - Clear visual hierarchy

**Acceptance**:
- OrderActions component conditionally shows buttons
- "Invia a Milano" only for piazzato state
- "Modifica" only for creato state
- Button handlers call correct callbacks
- Responsive on mobile

## Task 5: Integrate Components into OrderHistory (type: auto)

**Goal**: Add timeline, tracking, and actions to OrderHistory page.

**Actions**:
1. Update `archibald-web-app/frontend/src/components/OrderHistory.tsx`
2. Fetch state history from API:
   ```typescript
   GET /api/orders/:orderId/state-history
   ```
3. Add OrderTimeline to OrderCard body (always visible when expanded)
4. Add OrderTracking below timeline (if tracking data available)
5. Add OrderActions at bottom of OrderCard body
6. Implement "Invia a Milano" workflow:
   - Open SendToMilanoModal on button click
   - Call API endpoint on confirm:
     ```typescript
     POST /api/orders/:orderId/send-to-milano
     ```
   - Show success toast: "Ordine inviato a Milano con successo"
   - Refresh order list (re-fetch from API)
   - On error: show error toast with message
7. Implement Edit workflow:
   - Navigate to `/order-form?orderId=:orderId`
   - OrderForm should restore draft from database (reuse Phase 8 draft restoration)
8. Add force refresh button:
   - Call sync-states endpoint with forceRefresh=true
   - Show loading indicator
   - Refresh order list on success

**Acceptance**:
- OrderHistory integrates all new components
- State timeline visible for each order
- Tracking info displayed when available
- "Invia a Milano" button works with confirmation
- Edit button navigates to OrderForm
- Force refresh updates states from Archibald
- Success/error toasts provide feedback

## Task 6: Write Component Tests (type: auto)

**Goal**: Vitest tests for new UI components.

**Actions**:
1. Create test files:
   - `OrderTimeline.spec.tsx`
   - `OrderTracking.spec.tsx`
   - `SendToMilanoModal.spec.tsx`
   - `OrderActions.spec.tsx`
2. Test cases:
   - **OrderTimeline**: Renders state history, highlights current state
   - **OrderTracking**: Displays DDT and tracking link
   - **SendToMilanoModal**: Shows warning, calls onConfirm
   - **OrderActions**: Conditional button rendering based on state
3. Mock API calls with vi.mock()
4. Run tests: `npm test -- OrderTimeline OrderTracking SendToMilanoModal OrderActions`

**Acceptance**:
- 4 test files with 15+ test cases total
- All tests passing
- Component rendering verified
- Conditional logic tested
- Test coverage > 80%

## Task 7: Manual UAT (type: checkpoint:human-verify)

**Goal**: User acceptance testing of complete workflow.

**Actions**:
1. Start frontend and backend
2. Login as test user
3. Navigate to OrderHistory
4. Test timeline display:
   - Verify states displayed correctly
   - Check date formatting
   - Confirm current state highlighted
5. Test tracking display:
   - Verify DDT number shown
   - Click tracking link â†’ opens courier website
   - Test different couriers (FedEx, UPS)
6. Test "Invia a Milano" workflow:
   - Find order in "Piazzato" state
   - Click "Invia a Milano" button
   - Verify warning modal appears
   - Click "Conferma e Invia"
   - Verify success toast
   - Confirm order state changed to "Inviato a Milano"
   - Verify button no longer visible (state changed)
7. Test Edit workflow:
   - Find order in "Creato" state
   - Click "Modifica" button
   - Verify OrderForm opens with pre-filled data
8. Test force refresh:
   - Click force refresh button
   - Verify loading indicator
   - Confirm states updated

**Acceptance**:
- All UI components render correctly
- "Invia a Milano" workflow completes successfully
- Edit workflow navigates correctly
- Force refresh updates data
- No UI bugs or layout issues
- Mobile responsive (test on phone or resize browser)

**Checkpoint**: User must verify that test orders exist in appropriate states for testing.

</tasks>

<verification>
## Success Criteria

- [ ] OrderTimeline component displays state progression
- [ ] OrderTracking component shows DDT and tracking link
- [ ] SendToMilanoModal displays clear warning
- [ ] OrderActions conditionally shows correct buttons
- [ ] "Invia a Milano" workflow completes successfully
- [ ] Edit workflow navigates to OrderForm
- [ ] Force refresh updates order states
- [ ] Component tests pass (80%+ coverage)
- [ ] Manual UAT confirms all features work
- [ ] Mobile responsive

## Verification Steps

1. Run component tests: `npm test -- OrderTimeline OrderTracking SendToMilanoModal OrderActions`
2. Start dev server and navigate to OrderHistory
3. Verify timeline displays for expanded orders
4. Click tracking link â†’ opens courier website
5. Test "Invia a Milano" workflow with test order
6. Test Edit button navigation
7. Test force refresh updates data
8. Test on mobile (responsive design)
</verification>

<success_criteria>
Complete UI for order status tracking with timeline, tracking links, "Invia a Milano" button, and edit functionality. All features tested and production-ready.
</success_criteria>

<output>
- `archibald-web-app/frontend/src/components/OrderTimeline.tsx` - Timeline component
- `archibald-web-app/frontend/src/components/OrderTracking.tsx` - Tracking component
- `archibald-web-app/frontend/src/components/SendToMilanoModal.tsx` - Confirmation modal
- `archibald-web-app/frontend/src/components/OrderActions.tsx` - Action buttons
- Updated `archibald-web-app/frontend/src/components/OrderHistory.tsx` - Integration
- `archibald-web-app/frontend/src/components/OrderTimeline.spec.tsx` - Tests
- `archibald-web-app/frontend/src/components/OrderTracking.spec.tsx` - Tests
- `archibald-web-app/frontend/src/components/SendToMilanoModal.spec.tsx` - Tests
- `archibald-web-app/frontend/src/components/OrderActions.spec.tsx` - Tests
- `.planning/phases/11-order-management/11-05-SUMMARY.md` - Implementation summary
</output>
