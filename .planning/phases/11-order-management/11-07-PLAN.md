---
dependencies:
  - .planning/phases/11-order-management/11-02-PLAN.md
  - .planning/phases/11-order-management/11-03-PLAN.md
  - .planning/phases/11-order-management/11-04-PLAN.md
  - .planning/phases/11-order-management/11-05-PLAN.md
  - .planning/phases/11-order-management/11-06-PLAN.md
---

# Plan 11-07: Integration Testing, Error Handling & Audit Log

<objective>
Comprehensive integration testing, edge case handling, error recovery, and audit log verification for Phase 11 Order Management features.
</objective>

<execution_context>
@~/.claude/get-shit-done/references/checkpoints.md
@~/.claude/get-shit-done/references/tdd.md
@archibald-web-app/backend/src/send-to-milano-service.ts
@archibald-web-app/backend/src/ddt-scraper-service.ts
@archibald-web-app/backend/src/order-state-sync-service.ts
@archibald-web-app/backend/src/invoice-scraper-service.ts
</execution_context>

<context>
## Integration Test Scope

Phase 11 introduced multiple services that must work together reliably:

1. **SendToMilanoService** (Plan 11-02): Send order to Milano warehouse
2. **DDTScraperService** (Plan 11-03): Scrape DDT and tracking data
3. **OrderStateSyncService** (Plan 11-04): Sync order states with cache
4. **InvoiceScraperService** (Plan 11-06): Scrape invoices and download PDFs

**Integration Points to Test**:
- Send order → State changes → DDT appears → Invoice generated
- State sync updates order status correctly
- Audit log captures all actions
- Error recovery from Archibald failures
- Concurrent operations (multiple users)
- Cache invalidation on state changes

## Error Handling Requirements from 11-CONTEXT.md

**Critical Scenarios**:
1. **Network errors**: Archibald unreachable during scraping
2. **State conflicts**: Order sent to Milano while being edited
3. **Missing data**: DDT/invoice not found for order
4. **Puppeteer timeouts**: Operations exceed timeout limits
5. **Invalid states**: Attempting to send order in wrong state
6. **Concurrent access**: Multiple users accessing same order

**Error Recovery Strategy**:
- Retry transient errors (network, timeout) max 2 times
- Graceful degradation: return partial data if some operations fail
- Clear error messages for user-facing failures
- Audit log records all failures for debugging
- No data corruption on partial failures (atomic transactions)

## Audit Log Requirements

From 11-CONTEXT.md:

**Audit Log Purpose**: Capture all critical actions for accountability

**Actions to Log**:
- `send_to_archibald`: Order created and sent (Step 1)
- `send_to_milano`: Order sent to Milano (Step 2)
- `edit`: Order modified before Step 1
- `cancel`: Order deleted/cancelled
- `state_change`: Automatic state update from sync
- `sync_error`: Failed sync operation

**Audit Entry Fields** (already in migration 011):
- `order_id`: Foreign key to orders table
- `action`: Action type (enum above)
- `performed_by`: User ID or 'system'
- `performed_at`: ISO 8601 timestamp
- `details`: JSON with action-specific data

## Out of Scope

- Performance stress testing (deferred to Phase 12)
- Security penetration testing (deferred to Phase 13)
- Load testing with many concurrent users
</context>

<tasks>
## Task 1: Write End-to-End Integration Tests (type: auto)

**Goal**: Comprehensive E2E test suite for Phase 11 workflow.

**Actions**:
1. Create `archibald-web-app/backend/src/phase-11-integration.spec.ts`
2. Test scenarios:

   **Scenario 1: Complete Order Lifecycle**
   - Create order (state: creato)
   - Send to Archibald (state: piazzato)
   - Verify audit log entry: send_to_archibald
   - Send to Milano (state: inviato_milano)
   - Verify audit log entry: send_to_milano
   - Run state sync → state changes to in_lavorazione
   - Run DDT sync → DDT data populated
   - Run invoice sync → invoice data populated
   - Verify all state changes in order_state_history
   - Verify complete audit trail

   **Scenario 2: Idempotent Send to Milano**
   - Send order to Milano (first time)
   - Send same order again (idempotent)
   - Verify only one audit log entry
   - Verify state unchanged

   **Scenario 3: Invalid State Transitions**
   - Try to send order in "creato" state to Milano (should fail)
   - Try to edit order in "inviato_milano" state (should fail)
   - Verify no database changes on failures
   - Verify error messages descriptive

   **Scenario 4: Concurrent Operations**
   - User A starts "Send to Milano" operation
   - User B starts "Edit order" operation (same order)
   - Verify PriorityManager prevents conflict
   - Verify one operation succeeds, other waits or fails gracefully

   **Scenario 5: Cache Invalidation**
   - Sync order states (cache populated)
   - Send order to Milano (state changes)
   - Verify cache invalidated
   - Next state sync refreshes from Archibald

   **Scenario 6: Partial Failure Recovery**
   - DDT sync succeeds for 5 orders, fails for 2
   - Verify 5 orders updated, 2 logged as errors
   - Verify no data corruption
   - Verify audit log records failures

3. Test setup:
   - Use test database (isolated from production)
   - Mock Puppeteer for some scenarios (avoid Archibald load)
   - Real Puppeteer for critical scenarios (verify end-to-end)
4. Assertions:
   - Database state after each step
   - Audit log entries created
   - State history timeline complete
   - Error messages match expectations
5. Cleanup:
   - Delete test orders after each scenario
   - Reset database to clean state

**Acceptance**:
- 6+ E2E test scenarios covering main workflows
- All tests passing
- Audit log verified in each scenario
- Concurrent operations tested
- Test coverage includes error paths

## Task 2: Enhance Error Handling and User Messages (type: auto)

**Goal**: Improve error messages and recovery for user-facing failures.

**Actions**:
1. Review error handling in all services:
   - `SendToMilanoService`
   - `DDTScraperService`
   - `OrderStateSyncService`
   - `InvoiceScraperService`
2. **Standardize error response format**:
   ```typescript
   interface ErrorResponse {
     success: false;
     error: {
       code: string;  // E.g., 'ORDER_NOT_FOUND', 'NETWORK_ERROR'
       message: string;  // User-friendly Italian message
       details?: string;  // Technical details for debugging
       retryable: boolean;  // Can user retry?
     };
   }
   ```
3. **Define error codes** (add to each service):
   - `ORDER_NOT_FOUND`: Ordine non trovato
   - `INVALID_STATE`: Ordine non nello stato corretto
   - `NETWORK_ERROR`: Errore di connessione ad Archibald
   - `TIMEOUT`: Operazione scaduta
   - `ARCHIBALD_ERROR`: Errore interno di Archibald
   - `ALREADY_SENT`: Ordine già inviato (success, not error)
   - `MISSING_DATA`: Dati mancanti (DDT/fattura non disponibile)
4. **Add retry logic** where applicable:
   - Network errors: retry 2x with exponential backoff (1s, 2s)
   - Timeout errors: increase timeout and retry 1x
   - Archibald errors: no retry (likely requires manual intervention)
5. **Log all errors** with context:
   - Error code, message, details
   - Order ID, user ID
   - Screenshot path (if Puppeteer error)
   - Timestamp
6. Update API endpoints to return standardized errors
7. Update frontend to display user-friendly error messages

**Acceptance**:
- Standardized error format across all services
- Error codes defined and documented
- Retry logic for transient errors
- Comprehensive error logging
- Frontend displays Italian error messages

## Task 3: Audit Log Verification and Querying (type: auto)

**Goal**: Verify audit log captures all actions and add query endpoint.

**Actions**:
1. Add audit log query endpoint:
   ```typescript
   GET /api/orders/:orderId/audit-log
   ```
2. Endpoint logic:
   - Extract JWT from request
   - Verify order belongs to user
   - Query `order_audit_log` table for order
   - Return array sorted by `performed_at` DESC
3. Response format:
   ```typescript
   {
     orderId: string;
     auditLog: Array<{
       action: string;
       performedBy: string;
       performedAt: string;
       details?: any;
     }>;
   }
   ```
4. Add helper function to insert audit log entries:
   ```typescript
   async function logAuditEntry(
     orderId: string,
     action: string,
     performedBy: string,
     details?: any
   ): Promise<void>
   ```
5. Verify audit log calls in all services:
   - `SendToMilanoService`: log send_to_milano action
   - `OrderStateSyncService`: log state_change action
   - Order creation endpoint: log send_to_archibald action
   - Order edit endpoint: log edit action (if implemented)
6. **Admin-only audit log viewer** (optional):
   - Add endpoint: `GET /api/admin/audit-log` (all orders)
   - Requires admin user (check `whitelisted` field)
   - Useful for debugging and accountability
7. Test audit log completeness:
   - Create order → verify send_to_archibald entry
   - Send to Milano → verify send_to_milano entry
   - State sync → verify state_change entries
   - Delete test order → verify all entries present

**Acceptance**:
- Audit log query endpoint implemented
- All critical actions logged
- Helper function simplifies logging
- Admin audit log viewer available
- Audit log verified in integration tests

## Task 4: Edge Case Testing and Bug Fixes (type: checkpoint:human-verify)

**Goal**: Test edge cases discovered during UAT and fix bugs.

**Actions**:
1. **Test edge cases**:
   - Order with special characters in customer name
   - Order with very large quantity (stress test Archibald)
   - Order with missing product (product discontinued)
   - Order created during Archibald maintenance window
   - User logout during "Send to Milano" operation
   - Multiple DDTs for same order (keep most recent)
   - Invoice without matching order ID
   - Tracking link with special characters
2. **Test UI edge cases**:
   - Timeline with only one state (creato)
   - Timeline with all states (complete lifecycle)
   - OrderCard expanded when tracking data loads
   - Force refresh during active "Send to Milano" operation
   - Mobile view with long order IDs
3. **Test error recovery**:
   - Archibald returns 500 error during scraping
   - Network timeout during PDF download
   - Puppeteer browser crash during operation
   - Database deadlock during transaction
4. **Document bugs found**:
   - Create GitHub issues for each bug
   - Include steps to reproduce
   - Include expected vs actual behavior
5. **Fix critical bugs**:
   - Prioritize by severity (blocker > critical > major > minor)
   - Fix blockers immediately
   - Defer minor bugs to future phases
6. **Regression test**:
   - Re-run E2E tests after each bug fix
   - Verify fix doesn't break other features

**Acceptance**:
- Edge cases tested and documented
- Critical bugs fixed
- Regression tests pass
- Bug list prioritized and tracked
- User confirms no blocking issues

**Checkpoint**: User must test edge cases in real Archibald environment and report any bugs found.

## Task 5: Performance and Cache Verification (type: auto)

**Goal**: Verify cache strategy and performance targets met.

**Actions**:
1. **Verify cache behavior**:
   - First state sync: scrapes Archibald (slow)
   - Second state sync (< 2 hours): returns cached data (fast)
   - Third state sync (> 2 hours): refreshes from Archibald
   - Force refresh: ignores cache, always scrapes
2. **Test cache invalidation**:
   - Send order to Milano → state cache invalidated
   - DDT sync → DDT cache invalidated on new data
   - Invoice sync → invoice cache invalidated on new data
3. **Measure scraping performance**:
   - State sync for 10 orders: < 30 seconds
   - DDT sync for 10 orders: < 20 seconds
   - Invoice sync for 10 orders: < 20 seconds
   - PDF download: < 10 seconds
4. **Measure API response times**:
   - State sync (cached): < 500ms
   - State sync (uncached): < 30s
   - Audit log query: < 200ms
   - Send to Milano: < 15s
5. **Log performance metrics**:
   - Add timing logs to each service
   - Log cache hit/miss ratio
   - Log scraping duration per operation
6. **Optimize if needed**:
   - If performance targets not met, profile and optimize
   - Consider parallel processing for batch operations
   - Consider increasing cache TTL if data changes infrequently

**Acceptance**:
- Cache works correctly (2-hour TTL)
- Force refresh bypasses cache
- Cache invalidation on state changes
- Performance targets met (< 30s scraping)
- Performance metrics logged

## Task 6: Documentation and Summary (type: auto)

**Goal**: Document Phase 11 features and create summary.

**Actions**:
1. Update `archibald-web-app/backend/README.md`:
   - Document all new API endpoints
   - Document audit log structure
   - Document error codes and meanings
   - Document cache strategy
2. Create `11-07-SUMMARY.md`:
   - Summary of Phase 11 achievements
   - List of all features implemented (Plans 11-01 through 11-07)
   - Known limitations and future work
   - Performance metrics achieved
   - Test coverage statistics
3. Update `.planning/archibald-ui-selectors.md`:
   - Document any new selectors discovered
   - Update DDT/invoice page selectors if changed
4. Create user guide (optional):
   - How to use "Invia a Milano" feature
   - How to track order status
   - How to download invoices
   - What each order state means
5. Document audit log for compliance:
   - What actions are logged
   - How long logs are retained
   - Who can access audit logs

**Acceptance**:
- Backend README updated with new endpoints
- Phase 11 summary document complete
- UI selectors documented
- User guide created (optional)
- Audit log documented for compliance

</tasks>

<verification>
## Success Criteria

- [ ] 6+ E2E integration tests passing
- [ ] Error handling standardized across all services
- [ ] Audit log captures all critical actions
- [ ] Audit log query endpoint works
- [ ] Edge cases tested and bugs fixed
- [ ] Cache strategy verified (2-hour TTL)
- [ ] Performance targets met (< 30s scraping)
- [ ] Documentation updated (README, summary)
- [ ] User guide created (optional)
- [ ] Phase 11 complete and production-ready

## Verification Steps

1. Run E2E integration tests: `npm test phase-11-integration.spec.ts`
2. Verify audit log completeness (query endpoint)
3. Test edge cases with real Archibald session
4. Measure scraping performance (< 30s target)
5. Verify cache behavior (hit/miss correctly)
6. Review documentation for completeness
7. Manual UAT of complete workflow
</verification>

<success_criteria>
Phase 11 Order Management complete, thoroughly tested, with comprehensive audit trail and production-ready error handling. All features verified in real Archibald environment.
</success_criteria>

<output>
- `archibald-web-app/backend/src/phase-11-integration.spec.ts` - E2E integration tests
- Updated error handling in all services (standardized format)
- `archibald-web-app/backend/src/audit-log-helper.ts` - Audit log helper functions
- Updated `archibald-web-app/backend/src/index.ts` - Audit log query endpoint
- Updated `archibald-web-app/backend/README.md` - API documentation
- `.planning/phases/11-order-management/11-07-SUMMARY.md` - Phase 11 summary
- `.planning/phases/11-order-management/USER-GUIDE.md` - User guide (optional)
- Bug reports and fixes (GitHub issues)
- Performance metrics and logs
</output>
