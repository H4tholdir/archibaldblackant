---
dependencies:
  - .planning/phases/11-order-management/11-01-RESEARCH.md
  - .planning/phases/11-order-management/11-CONTEXT.md
  - archibald-web-app/backend/src/order-history-service.ts
  - archibald-web-app/backend/src/archibald-bot.ts
---

# Plan 11-02: Implement "Send to Milano" Feature (Step 2)

<objective>
Implement backend automation for "Invia a Milano" (Step 2) workflow: select order by ID, click "Invio" button, verify success, and update database with new order state.
</objective>

<execution_context>
@~/.claude/get-shit-done/references/checkpoints.md
@~/.claude/get-shit-done/references/tdd.md
@archibald-web-app/backend/src/archibald-bot.ts
@archibald-web-app/backend/src/order-history-service.ts
@archibald-web-app/backend/src/browser-pool.ts
@.planning/phases/11-order-management/11-01-RESEARCH.md
</execution_context>

<context>
## Phase 11 Core Feature

The **"Invia a Milano"** feature implements **Step 2** of the two-step order workflow:

**Step 1** (already implemented in Phase 9): Invia ad Archibald
- Order created in our app and placed on Archibald
- **Still editable** after this step

**Step 2** (this plan): Invia a Milano
- Order sent definitively to Milano warehouse
- **No longer editable** after this step
- Starts order state progression (in lavorazione → spedito → consegnato)

## Implementation Approach

**Backend Workflow** (based on 11-CONTEXT.md):
1. Login to Archibald (reuse BrowserPool pattern from Phase 10)
2. Navigate to orders page
3. **Select order with checkbox** (match via order ID)
4. **Click "Invio" button**
5. Confirm action (if modal present)
6. Verify success (check for feedback message or state change)
7. Update database: order state → "Inviato a Milano", store timestamp

**Database Changes Needed**:
- Add `sent_to_milano_at` timestamp to orders table
- Add `current_state` field (enum: creato, piazzato, inviato_milano, in_lavorazione, spedito, consegnato)
- Create `order_audit_log` table for accountability

**Reusable Patterns from Phase 10**:
- BrowserContext management via BrowserPool
- PriorityManager pause/resume for bot conflicts
- Error handling with descriptive messages
- Success flag always true for read-only operations (send = write operation, needs careful verification)

## Scope

**In Scope**:
- Backend service for "Invia a Milano" automation
- Database schema migrations
- Order state enum and audit log table
- API endpoint: `POST /api/orders/:orderId/send-to-milano`
- Success/error response with detailed feedback

**Out of Scope**:
- UI button and confirmation modal (Plan 11-05)
- Status tracking sync (Plan 11-04)
- Edit order functionality (Plan 11-05)

**Safety Considerations**:
- **Idempotent**: If order already sent, return success (no-op)
- **Validation**: Only send orders in "Piazzato su Archibald" state
- **Audit**: Log every send attempt with user ID and timestamp
- **Rollback**: If Archibald operation fails, don't update database
</context>

<tasks>
## Task 1: Database Schema Migration (type: auto)

**Goal**: Add order state tracking fields and audit log table.

**Actions**:
1. Create migration file: `archibald-web-app/backend/migrations/011-order-management.sql`
2. Add columns to `orders` table:
   ```sql
   ALTER TABLE orders ADD COLUMN sent_to_milano_at TEXT;
   ALTER TABLE orders ADD COLUMN current_state TEXT DEFAULT 'creato';
   ```
3. Create `order_audit_log` table:
   ```sql
   CREATE TABLE order_audit_log (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     order_id TEXT NOT NULL,
     action TEXT NOT NULL,  -- 'send_to_archibald', 'send_to_milano', 'edit', 'cancel'
     performed_by TEXT NOT NULL,  -- user_id
     performed_at TEXT NOT NULL,  -- ISO 8601 timestamp
     details TEXT,  -- JSON with action-specific data
     FOREIGN KEY (order_id) REFERENCES orders(id)
   );
   CREATE INDEX idx_audit_order ON order_audit_log(order_id);
   CREATE INDEX idx_audit_performed_at ON order_audit_log(performed_at);
   ```
4. Update OrderDB interface in `archibald-web-app/backend/src/order-db.ts`:
   - Add `sentToMilanoAt?: string` field
   - Add `currentState?: string` field
5. Run migration against test database
6. Verify schema changes with `PRAGMA table_info(orders)` and `PRAGMA table_info(order_audit_log)`

**Acceptance**:
- Migration file created and tested
- Orders table has new columns with correct types
- Audit log table created with indexes
- TypeScript types updated in order-db.ts

## Task 2: Implement SendToMilanoService (type: auto)

**Goal**: Create backend service for "Invia a Milano" automation.

**Actions**:
1. Create `archibald-web-app/backend/src/send-to-milano-service.ts`
2. Implement `SendToMilanoService` class with method:
   ```typescript
   async sendToMilano(orderId: string, userId: string, username: string, password: string): Promise<SendToMilanoResult>
   ```
3. Service workflow:
   - Acquire BrowserContext from BrowserPool
   - Navigate to orders page (direct URL from Phase 10 pattern)
   - Locate order by ID using text-based search
   - Find and click checkbox for order selection (selector from 11-01-RESEARCH.md)
   - Click "Invio" button (selector from research)
   - Handle confirmation modal if present
   - Wait for success feedback (toast notification or state change)
   - Return success/failure with detailed message
4. Error handling:
   - Order not found → clear error message
   - Order already sent → return success (idempotent)
   - Archibald error → descriptive error with screenshot
   - Network timeout → retry logic (max 2 retries)
5. Logging:
   - Debug logs for each step
   - Error logs with screenshot paths
   - Success log with timestamp

**Acceptance**:
- `SendToMilanoService` class created
- Puppeteer workflow implements research findings
- Error handling covers edge cases
- Comprehensive debug logging
- Service compiles without TypeScript errors

## Task 3: Create API Endpoint (type: auto)

**Goal**: Add REST endpoint for "Invia a Milano" feature.

**Actions**:
1. Add endpoint to `archibald-web-app/backend/src/index.ts`:
   ```typescript
   POST /api/orders/:orderId/send-to-milano
   ```
2. Endpoint logic:
   - Extract JWT from request (requireAuth middleware)
   - Validate orderId parameter (must be non-empty string)
   - Fetch order from database (verify exists and belongs to user)
   - Validate order state (must be "piazzato")
   - If already sent, return 200 with message "Order already sent"
   - Pause background services (PriorityManager pattern from Phase 4.1-01)
   - Call SendToMilanoService.sendToMilano()
   - Resume background services
   - On success:
     - Update order: `currentState = 'inviato_milano'`, `sentToMilanoAt = now()`
     - Insert audit log entry
     - Return 200 with success message
   - On failure:
     - Return 500 with error details
     - Don't update database (rollback)
3. Response format:
   ```typescript
   {
     success: boolean;
     message: string;
     orderId: string;
     sentToMilanoAt?: string;
   }
   ```
4. Add request validation (orderId required)
5. Add user authorization (order must belong to authenticated user)

**Acceptance**:
- Endpoint registered in index.ts
- JWT authentication required
- Order ownership validated
- State validation prevents double-send
- PriorityManager integration for bot safety
- Audit log entry created on success
- Database rollback on Archibald failure

## Task 4: Write Unit Tests (type: auto)

**Goal**: TDD test coverage for SendToMilanoService.

**Actions**:
1. Create `archibald-web-app/backend/src/send-to-milano-service.spec.ts`
2. Test cases:
   - **Happy path**: Order sent successfully
   - **Idempotent**: Order already sent returns success
   - **Not found**: Order ID not found in Archibald
   - **Invalid state**: Order not in "piazzato" state
   - **Puppeteer error**: Archibald returns error
   - **Network timeout**: Timeout handling with retry
3. Mock BrowserPool and Puppeteer page interactions
4. Verify audit log entries created
5. Run tests: `npm test send-to-milano-service.spec.ts`

**Acceptance**:
- 6+ test cases covering main scenarios
- All tests passing
- Mock BrowserPool correctly
- Test coverage > 80%

## Task 5: Integration Test with Manual Verification (type: checkpoint:human-verify)

**Goal**: Test full workflow with real Archibald session.

**Actions**:
1. Create test order in "piazzato" state (or use existing test order from Phase 10)
2. Start backend server
3. Make API request:
   ```bash
   curl -X POST http://localhost:3000/api/orders/:orderId/send-to-milano \
     -H "Authorization: Bearer $JWT" \
     -H "Content-Type: application/json"
   ```
4. Observe:
   - Backend logs (each workflow step)
   - Puppeteer browser automation (visible for debugging)
   - Archibald feedback (success message or error)
   - Database updates (order state changed, timestamp set, audit log entry)
5. Verify in Archibald UI:
   - Order state changed (if visible in UI)
   - Order no longer editable (verify manually)
6. Test idempotency:
   - Send same order again
   - Should return success without error

**Acceptance**:
- Test order successfully sent to Milano
- Database updated correctly
- Audit log entry present
- Second send returns success (idempotent)
- No errors in backend logs

**Checkpoint**: User must provide test order ID safe for sending, or create test order in staging environment.

## Task 6: Update Documentation (type: auto)

**Goal**: Document new feature for team reference.

**Actions**:
1. Update `archibald-web-app/backend/README.md`:
   - Document new API endpoint
   - Document request/response format
   - Document error codes and meanings
2. Add comments to SendToMilanoService explaining workflow
3. Document audit log table purpose and fields
4. Update `.planning/phases/11-order-management/11-02-SUMMARY.md` (create after completion)

**Acceptance**:
- API endpoint documented in backend README
- Code comments clear and helpful
- Summary document drafted for plan completion

</tasks>

<verification>
## Success Criteria

- [ ] Database migration adds order state and audit log table
- [ ] SendToMilanoService implements research findings correctly
- [ ] API endpoint validates state and user ownership
- [ ] Audit log captures every send attempt
- [ ] Unit tests cover main scenarios with 80%+ coverage
- [ ] Integration test sends real order successfully
- [ ] Idempotency verified (second send succeeds)
- [ ] Documentation updated with new endpoint

## Verification Steps

1. Run database migration and verify schema changes
2. Run unit tests: `npm test send-to-milano-service.spec.ts`
3. Run integration test with real Archibald session
4. Verify order state in database after send
5. Check audit log entry created
6. Test idempotency by sending same order twice
7. Verify no errors in backend logs
</verification>

<success_criteria>
Backend automation for "Invia a Milano" feature complete, tested, and production-ready with comprehensive audit trail.
</success_criteria>

<output>
- `archibald-web-app/backend/migrations/011-order-management.sql` - Database migration
- `archibald-web-app/backend/src/send-to-milano-service.ts` - SendToMilano automation service
- `archibald-web-app/backend/src/send-to-milano-service.spec.ts` - Unit tests
- Updated `archibald-web-app/backend/src/index.ts` - New API endpoint
- Updated `archibald-web-app/backend/src/order-db.ts` - Type definitions
- Updated `archibald-web-app/backend/README.md` - API documentation
- `.planning/phases/11-order-management/11-02-SUMMARY.md` - Implementation summary
</output>
