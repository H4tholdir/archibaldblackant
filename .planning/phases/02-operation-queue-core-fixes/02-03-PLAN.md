---
phase: 02-operation-queue-core-fixes
plan: 03
type: execute
---

<objective>
Replace broken timestamp-based idempotencyKey with BullMQ native deduplication and add fine-grained shouldStop checks inside DB iteration loops.

Purpose: Current idempotencyKey uses `Date.now()` making every job "unique" — deduplication is effectively disabled. Sync services also lack shouldStop checks inside for-loops that can process hundreds of records, blocking preemption for minutes. This plan completes the Phase 2 fixes.
Output: Native BullMQ deduplication prevents duplicate jobs atomically. Sync services check shouldStop every 10 records in DB loops. Phase 2 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-operation-queue-core-fixes/02-RESEARCH.md
@.planning/phases/02-operation-queue-core-fixes/02-CONTEXT.md
@.planning/phases/02-operation-queue-core-fixes/02-01-SUMMARY.md
@.planning/phases/02-operation-queue-core-fixes/02-02-SUMMARY.md

# Key source files:
@archibald-web-app/backend/src/operations/operation-queue.ts
@archibald-web-app/backend/src/operations/operation-queue.spec.ts
@archibald-web-app/backend/src/operations/operation-types.ts
@archibald-web-app/backend/src/sync/services/customer-sync.ts
@archibald-web-app/backend/src/sync/services/customer-sync.spec.ts
@archibald-web-app/backend/src/sync/services/order-sync.ts
@archibald-web-app/backend/src/sync/services/order-sync.spec.ts
@archibald-web-app/backend/src/sync/services/ddt-sync.ts
@archibald-web-app/backend/src/sync/services/invoice-sync.ts
@archibald-web-app/backend/src/sync/services/product-sync.ts
@archibald-web-app/backend/src/sync/services/price-sync.ts
@archibald-web-app/backend/src/sync/sync-scheduler.ts

**Depends on:** Plan 02-01 (signal wiring), Plan 02-02 (timeout/preemption)

**Research findings (from 02-RESEARCH.md):**
- BullMQ `deduplication: { id: '...' }` — Simple mode (deduplicate while job active) for syncs
- BullMQ `deduplication: { id: '...', ttl: N }` — Throttle mode for write operations (short window)
- `queueEvents.on('deduplicated')` event for logging
- DO NOT hand-roll deduplication — use BullMQ native
- Pitfall: deduplication + retry conflict — use Simple mode for syncs (retry is same job, not new enqueue)
- All 6 sync services have for-loops without shouldStop: customer, order, ddt, invoice, product, price
- shouldStop check every ~10 records is good compromise (cost is negligible)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Switch to BullMQ native deduplication in operation-queue</name>
  <files>
    archibald-web-app/backend/src/operations/operation-queue.ts,
    archibald-web-app/backend/src/operations/operation-queue.spec.ts,
    archibald-web-app/backend/src/operations/operation-types.ts
  </files>
  <action>
1. In operation-queue.ts, update `getJobOptions` to include deduplication:

   For scheduled syncs (sync-customers, sync-orders, etc.):
   - Use **Simple mode** deduplication. The dedup ID should be `${type}-${userId}` for per-user syncs and `${type}` for shared syncs (sync-products, sync-prices use 'service-account').
   - Simple mode blocks duplicates while the job is active (waiting, delayed, or processing). Perfect for syncs.
   - The dedup option must be added PER JOB, not in queue options.

   For write operations (submit-order, create-customer, etc.):
   - Keep NO deduplication by default. Write operations use unique data (different orderId each time). The caller can pass an explicit deduplication ID via the `idempotencyKey` parameter for specific cases (e.g., retry of same submit).
   - If `idempotencyKey` is provided AND it's a write operation, use Throttle mode with `ttl: 30_000` (30s window to prevent double-tap).

   For download operations (download-ddt-pdf, download-invoice-pdf):
   - No deduplication needed (each download is for a specific document).

   Updated `enqueue` function:
   ```
   async function enqueue(type, userId, data, idempotencyKey?) {
     const jobData = { type, userId, data, timestamp: Date.now() };
     const options = getJobOptions(type);

     if (isScheduledSync(type)) {
       options.deduplication = { id: `${type}-${userId}` };
     } else if (idempotencyKey && isWriteOperation(type)) {
       options.deduplication = { id: idempotencyKey, ttl: 30_000 };
     }

     const job = await queue.add(type, jobData, options);
     return job.id!;
   }
   ```

   - Remove the auto-generated idempotencyKey fallback (`idempotencyKey ?? \`${type}-${userId}-${Date.now()}\``). The idempotencyKey field in OperationJobData becomes truly optional — only set when the caller explicitly provides one.

2. In operation-types.ts:
   - Make `idempotencyKey` optional in `OperationJobData` (change from `idempotencyKey: string` to `idempotencyKey?: string`). This is safe because the field was only used for the requeue path, and BullMQ deduplication now handles that.

3. In operation-queue.spec.ts:
   - Update existing enqueue tests to verify deduplication options:
     - Test: "enqueue adds deduplication for sync operations" — verify `deduplication: { id: 'sync-customers-user-a' }` in options
     - Test: "enqueue adds throttle deduplication for write ops with idempotencyKey" — verify `deduplication: { id: 'key-1', ttl: 30000 }` when idempotencyKey provided
     - Test: "enqueue does not add deduplication for write ops without idempotencyKey"
     - Test: "enqueue does not add deduplication for download operations"
   - Update existing tests that check for `idempotencyKey` in jobData — it's now optional

4. In sync-scheduler.ts:
   - No changes needed. The scheduler calls `enqueue('sync-customers', userId, {})` without idempotencyKey. The deduplication will be added automatically by the queue for sync types.
  </action>
  <verify>
    npm run build --prefix archibald-web-app/backend
    npm test --prefix archibald-web-app/backend
  </verify>
  <done>
    - Sync operations use Simple mode deduplication (id: `${type}-${userId}`)
    - Write operations use Throttle mode deduplication only when idempotencyKey provided
    - Auto-generated timestamp-based idempotencyKey removed
    - idempotencyKey is optional in OperationJobData
    - 4+ new/updated deduplication tests pass
    - All existing tests pass
    - TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add shouldStop checks inside DB iteration loops in sync services</name>
  <files>
    archibald-web-app/backend/src/sync/services/customer-sync.ts,
    archibald-web-app/backend/src/sync/services/customer-sync.spec.ts,
    archibald-web-app/backend/src/sync/services/order-sync.ts,
    archibald-web-app/backend/src/sync/services/order-sync.spec.ts,
    archibald-web-app/backend/src/sync/services/ddt-sync.ts,
    archibald-web-app/backend/src/sync/services/ddt-sync.spec.ts,
    archibald-web-app/backend/src/sync/services/invoice-sync.ts,
    archibald-web-app/backend/src/sync/services/invoice-sync.spec.ts,
    archibald-web-app/backend/src/sync/services/product-sync.ts,
    archibald-web-app/backend/src/sync/services/product-sync.spec.ts,
    archibald-web-app/backend/src/sync/services/price-sync.ts,
    archibald-web-app/backend/src/sync/services/price-sync.spec.ts
  </files>
  <action>
In each of the 6 sync services, add a shouldStop check INSIDE the main for-loop that iterates over parsed records. Check every 10 records to minimize overhead while ensuring responsiveness.

Pattern for each service (example for customer-sync.ts):
```
let loopIndex = 0;
for (const customer of parsedCustomers) {
  if (loopIndex > 0 && loopIndex % 10 === 0 && shouldStop()) {
    throw new SyncStoppedError('db-loop');
  }
  loopIndex++;

  // ... existing insert/update logic unchanged ...
}
```

Apply this pattern to:
1. customer-sync.ts — `for (const customer of parsedCustomers)` (~line 88)
2. order-sync.ts — `for (const order of parsedOrders)` (~line 78)
3. ddt-sync.ts — `for (const ddt of parsedDdts)` (~line 70)
4. invoice-sync.ts — `for (const inv of parsedInvoices)` (~line 72)
5. product-sync.ts — `for (const p of products)` (~line 67)
6. price-sync.ts — `for (const p of prices)` (~line 68)

Notes:
- Start checking at index > 0 (skip first iteration — shouldStop was already checked before the loop)
- Check every 10 records (% 10 === 0). This means for 500 customers, shouldStop is checked ~50 times during the loop. Cost is negligible.
- Use SyncStoppedError with stage 'db-loop' to distinguish from macro-checkpoint stops
- Do NOT add shouldStop inside the DELETE section after the loop (it's a quick operation)

Update tests in each spec file:
- Add test: "stops during DB loop when shouldStop returns true mid-iteration" — provide >10 parsed records, set shouldStop to return true after 10th record, verify result shows stopped and records processed < total. Use customer-sync.spec.ts and order-sync.spec.ts as the two primary test cases (they have the most complex loops). For the other 4 services, add minimal tests following the same pattern.
  </action>
  <verify>
    npm run build --prefix archibald-web-app/backend
    npm test --prefix archibald-web-app/backend
  </verify>
  <done>
    - All 6 sync services check shouldStop every 10 records in DB loops
    - SyncStoppedError('db-loop') thrown when stopped mid-loop
    - 6 new tests (1 per service) verify mid-loop stop behavior
    - All existing shouldStop tests still pass
    - All other existing tests still pass
    - TypeScript compiles
    - Phase 2 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/backend` passes
- [ ] `grep -r "Date.now()" archibald-web-app/backend/src/operations/operation-queue.ts` does NOT show idempotencyKey generation
- [ ] All 6 sync services have shouldStop checks inside for-loops
- [ ] BullMQ deduplication options verified in tests
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Timestamp-based idempotencyKey eliminated
- BullMQ native deduplication active for sync operations
- Write operation deduplication only when caller provides key
- All 6 sync services check shouldStop inside DB loops (every 10 records)
- All tests pass, TypeScript compiles
- Phase 2: Operation Queue Core Fixes complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-operation-queue-core-fixes/02-03-SUMMARY.md`

Update `.planning/STATE.md`:
- Current Position: Phase 2 complete
- Progress: 20%
- Last activity: Phase 2 completed
</output>
