---
phase: 02-operation-queue-core-fixes
plan: 01
type: execute
---

<objective>
Wire BullMQ's native AbortSignal through the entire operation processing stack and connect it to shouldStop in all sync handlers.

Purpose: Enable real job cancellation — currently all 6 sync handlers pass `() => false` as shouldStop, making preemption and graceful stop impossible. This plan builds the foundation that Plans 02-02 and 02-03 depend on.
Output: AbortSignal flows from Worker → processor → handlers. All sync handlers bridge signal to shouldStop. Existing tests updated and passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-operation-queue-core-fixes/02-RESEARCH.md
@.planning/phases/02-operation-queue-core-fixes/02-CONTEXT.md

# Key source files:
@archibald-web-app/backend/src/operations/operation-processor.ts
@archibald-web-app/backend/src/operations/operation-processor.spec.ts
@archibald-web-app/backend/src/operations/operation-types.ts
@archibald-web-app/backend/src/main.ts (lines 225-250)
@archibald-web-app/backend/src/operations/handlers/sync-customers.ts
@archibald-web-app/backend/src/operations/handlers/sync-orders.ts
@archibald-web-app/backend/src/operations/handlers/sync-ddt.ts
@archibald-web-app/backend/src/operations/handlers/sync-invoices.ts
@archibald-web-app/backend/src/operations/handlers/sync-products.ts
@archibald-web-app/backend/src/operations/handlers/sync-prices.ts
@archibald-web-app/backend/src/operations/handlers/sync-order-articles.ts

# Phase 1 context:
@.planning/phases/01-cleanup-dead-code/01-02-SUMMARY.md

**Constraining decisions:**
- Phase 1: File orfani cancellati direttamente (git safety net)
- Phase 1: send-to-verona rename completed (code+DB)

**Research findings (from 02-RESEARCH.md):**
- BullMQ Worker processor accepts 3rd param `signal: AbortSignal` — use this instead of manual callbacks
- Pattern: bridge AbortSignal to `() => boolean` shouldStop via event listener
- DO NOT hand-roll cancellation — use BullMQ native AbortSignal
- All 6 sync handlers currently pass `() => false` — must replace
- sync-order-articles handler doesn't use shouldStop (different pattern, non-scheduled)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AbortSignal to operation processor infrastructure</name>
  <files>
    archibald-web-app/backend/src/operations/operation-processor.ts,
    archibald-web-app/backend/src/operations/operation-processor.spec.ts,
    archibald-web-app/backend/src/main.ts
  </files>
  <action>
1. In operation-processor.ts:
   - Add `signal?: AbortSignal` as last parameter to `OperationHandler` type
   - Add `signal?: AbortSignal` to `JobLike` type
   - In `processJob`, pass `job.signal` as 5th argument when calling `handler(context, data, userId, onProgress, job.signal)`

2. In main.ts (Worker setup, ~line 235):
   - Change worker callback from `async (job)` to `async (job, token, signal)` to receive BullMQ's AbortSignal
   - Pass `signal` through to processJob by adding it to the JobLike object: `{ id, data, updateProgress, signal }`

3. In operation-processor.spec.ts:
   - Update `createMockJob` to optionally include a mock `signal` (use `AbortController` to create real signals in tests)
   - Add test: "passes signal to handler" — verify handler receives signal as 5th argument
   - Add test: "processJob works when signal is undefined" — backward compatibility

Do NOT change the handler implementations yet (that's Task 2). Only the infrastructure that carries signal through.
  </action>
  <verify>
    npm run build --prefix archibald-web-app/backend (type-check passes)
    npm test --prefix archibald-web-app/backend (all tests pass including new ones)
  </verify>
  <done>
    - OperationHandler type has optional signal parameter
    - JobLike type has optional signal field
    - Worker passes BullMQ signal through to processor
    - processJob forwards signal to handler
    - 2 new tests pass, all existing tests still pass
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire signal→shouldStop bridge in all sync handlers</name>
  <files>
    archibald-web-app/backend/src/operations/handlers/sync-customers.ts,
    archibald-web-app/backend/src/operations/handlers/sync-orders.ts,
    archibald-web-app/backend/src/operations/handlers/sync-ddt.ts,
    archibald-web-app/backend/src/operations/handlers/sync-invoices.ts,
    archibald-web-app/backend/src/operations/handlers/sync-products.ts,
    archibald-web-app/backend/src/operations/handlers/sync-prices.ts
  </files>
  <action>
In each of the 6 sync handler files, apply the IDENTICAL pattern:

1. Add `signal?: AbortSignal` as 5th parameter to the returned OperationHandler function

2. Inside the handler function body, add the bridge BEFORE calling the sync service:
   ```
   let stopped = false;
   signal?.addEventListener('abort', () => { stopped = true; }, { once: true });
   ```

3. Replace `() => false` with `() => stopped` in the sync service call

Example for sync-customers.ts — the returned handler becomes:
```
return async (context, _data, userId, onProgress, signal) => {
  let stopped = false;
  signal?.addEventListener('abort', () => { stopped = true; }, { once: true });
  const bot = createBot(userId);
  const result = await syncCustomers(
    { pool: deps.pool, downloadPdf: ..., parsePdf: ..., cleanupFile: ... },
    userId,
    onProgress,
    () => stopped,  // was: () => false
  );
  return result as unknown as Record<string, unknown>;
};
```

Apply the same pattern to all 6 handlers. Note:
- sync-products.ts and sync-prices.ts have slightly different signatures (no userId param in sync service call) — preserve their existing pattern, only change shouldStop
- sync-order-articles.ts does NOT need this change (not a scheduled sync, no shouldStop parameter)
- Use `{ once: true }` on addEventListener to avoid memory leaks
  </action>
  <verify>
    npm run build --prefix archibald-web-app/backend
    npm test --prefix archibald-web-app/backend
  </verify>
  <done>
    - All 6 sync handlers bridge AbortSignal to shouldStop
    - Zero instances of `() => false` remain as shouldStop in sync handlers
    - All existing tests pass (handlers are backward-compatible since signal is optional)
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build --prefix archibald-web-app/backend` passes
- [ ] `npm test --prefix archibald-web-app/backend` passes (all existing + new tests)
- [ ] `grep -r "() => false" archibald-web-app/backend/src/operations/handlers/sync-*.ts` returns NO matches
- [ ] OperationHandler type includes `signal?: AbortSignal`
- [ ] Worker in main.ts receives and forwards signal
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- AbortSignal flows: Worker → processJob → handler
- All 6 sync handlers bridge signal→shouldStop
- No `() => false` shouldStop remaining in sync handlers
- All tests pass, TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/02-operation-queue-core-fixes/02-01-SUMMARY.md`
</output>
