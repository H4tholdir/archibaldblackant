---
phase: 10-order-history
plan: 05
type: execute
---

<objective>
Create REST API endpoints for order history with JWT authentication, filters, and per-user session management.

Purpose: Expose order history data to frontend via secure API endpoints with filtering capabilities (customer, date range, status).
Output: Two API endpoints - GET /api/orders/history (list with filters) and GET /api/orders/:id (detail) - both JWT-protected and session-isolated per user.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-order-history/10-CONTEXT.md
@.planning/phases/10-order-history/10-RESEARCH.md
@.planning/phases/10-order-history/10-02-SUMMARY.md
@.planning/phases/10-order-history/10-03-SUMMARY.md
@.planning/phases/10-order-history/10-04-SUMMARY.md

**CONTEXT.md Requirements:**
- Filters: customer search, date/period, status (all equally essential)
- Timeline UI needs: list + detail data
- Per-user order history (not global)

**Existing API Patterns (Phase 6):**
- JWT authentication via authenticateJWT middleware
- AuthRequest interface with req.user.userId
- BrowserPool session acquisition/release pattern
- Error handling with winston logger

**Key Files:**
@archibald-web-app/backend/src/index.ts (add new routes)
@archibald-web-app/backend/src/order-history-service.ts (use service)
@archibald-web-app/backend/src/middleware/auth.ts (authenticateJWT)
@archibald-web-app/backend/src/browser-pool.ts (session management)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/orders/history endpoint with filters</name>
  <files>archibald-web-app/backend/src/index.ts</files>
  <action>
    Add order history list endpoint to Express app:

    1. **Endpoint signature:**
       ```typescript
       app.get(
         "/api/orders/history",
         authenticateJWT,
         async (req: AuthRequest, res) => {
           // Implementation
         }
       );
       ```

    2. **Query parameters for filters:**
       ```typescript
       interface HistoryQuery {
         customer?: string;      // Customer name search (partial match)
         dateFrom?: string;      // ISO date (e.g., "2024-01-01")
         dateTo?: string;        // ISO date
         status?: string;        // e.g., "In lavorazione", "Evaso", "Spedito"
         limit?: string;         // Default: "100"
         offset?: string;        // Default: "0"
       }
       ```

    3. **Implementation flow:**
       - Extract userId from req.user (JWT auth)
       - Parse query parameters from req.query
       - Acquire BrowserContext for userId via browserPool
       - Call orderHistoryService.getOrderList(context, userId, options)
       - Apply filters in-memory (filter by customer name, date range, status)
       - Release BrowserContext
       - Return JSON: { success: true, data: { orders, total, hasMore } }

    4. **Filter implementation:**
       - Customer: case-insensitive partial match on customerName
       - Date range: parse ISO dates, compare with order.date
       - Status: exact match (case-insensitive)
       - Apply all filters that are present (AND logic)

    5. **Error handling:**
       - 401 if JWT missing/invalid (handled by middleware)
       - 400 if date format invalid
       - 500 if scraping fails, log error with userId context
       - Always release BrowserContext (use try/finally)

    Use winston logger for all logging.
    Follow existing endpoint patterns from Phase 6 (e.g., /api/orders/create).
    Import OrderHistoryService from order-history-service.ts.
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>GET /api/orders/history endpoint with filters and JWT auth implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create GET /api/orders/:id endpoint for detail</name>
  <files>archibald-web-app/backend/src/index.ts</files>
  <action>
    Add order detail endpoint to Express app:

    1. **Endpoint signature:**
       ```typescript
       app.get(
         "/api/orders/:id",
         authenticateJWT,
         async (req: AuthRequest, res) => {
           // Implementation
         }
       );
       ```

    2. **Implementation flow:**
       - Extract orderId from req.params.id
       - Extract userId from req.user (JWT auth)
       - Validate orderId format (numeric string expected)
       - Acquire BrowserContext for userId via browserPool
       - Call orderHistoryService.getOrderDetail(context, userId, orderId)
       - Release BrowserContext
       - Return JSON: { success: true, data: orderDetail } or 404 if not found

    3. **Error handling:**
       - 401 if JWT missing/invalid (handled by middleware)
       - 400 if orderId format invalid
       - 404 if orderDetail returns null (order not found)
       - 500 if scraping fails, log error with userId + orderId context
       - Always release BrowserContext (use try/finally)

    4. **Response format:**
       - Success: { success: true, data: OrderDetail }
       - Not found: { success: false, error: "Order not found" } (404)
       - Error: { success: false, error: "Failed to fetch order detail" } (500)

    Use winston logger for all logging.
    Follow existing endpoint error handling patterns.
    Ensure BrowserContext always released (try/finally block).
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>GET /api/orders/:id endpoint for order detail with JWT auth implemented</done>
</task>

<task type="auto">
  <name>Task 3: Integrate with BrowserPool session management</name>
  <files>archibald-web-app/backend/src/index.ts</files>
  <action>
    Ensure both endpoints properly integrate with multi-user session management:

    1. **Session acquisition pattern:**
       ```typescript
       let context: BrowserContext | null = null;
       try {
         context = await browserPool.acquireContext(req.user.userId);
         const page = await context.newPage();

         // Scraping operations with orderHistoryService
         const result = await orderHistoryService.getOrderList(context, req.user.userId, options);

         res.json({ success: true, data: result });
       } catch (error) {
         logger.error("Order history request failed", {
           error,
           userId: req.user.userId,
           endpoint: req.path
         });
         res.status(500).json({
           success: false,
           error: "Failed to fetch order history"
         });
       } finally {
         if (context) {
           await browserPool.releaseContext(req.user.userId);
         }
       }
       ```

    2. **Coordinate with PriorityManager:**
       - Import PriorityManager from priority-manager.ts
       - Pause sync services during order history scraping (like order creation)
       - Resume after completion or error

    3. **Request logging:**
       - Log start: "Fetching order history for user X"
       - Log success: "Order history fetched: Y orders for user X"
       - Log errors with full context (userId, orderId if applicable)

    Follow existing patterns from Phase 6 (order creation endpoint).
    Ensure proper cleanup on both success and error paths.
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>Session management integration complete with proper acquire/release and error handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GET /api/orders/history endpoint created with JWT auth
- [ ] Query parameter filters implemented (customer, dateFrom/To, status)
- [ ] GET /api/orders/:id endpoint created with JWT auth
- [ ] BrowserContext acquisition/release pattern implemented correctly
- [ ] PriorityManager integration to avoid conflicts with sync services
- [ ] Error handling covers all cases (400, 404, 500)
- [ ] Winston logger used for all logging
- [ ] TypeScript compilation passes without errors
</verification>

<success_criteria>
- Both endpoints accessible and JWT-protected
- GET /api/orders/history returns filtered order list
- GET /api/orders/:id returns complete order detail
- Per-user session isolation via BrowserPool
- Proper error responses (400/404/500) with logging
- BrowserContext always released (no resource leaks)
- No TypeScript errors introduced
- Ready for Plan 10-06 (Timeline UI Components)
</success_criteria>

<output>
After completion, create `.planning/phases/10-order-history/10-05-SUMMARY.md`:

# Phase 10 Plan 05: Order History API Endpoints Summary

**Created REST API endpoints for order history with JWT authentication, filters, and per-user session management.**

## Accomplishments

- Created GET /api/orders/history endpoint with filter query parameters
- Created GET /api/orders/:id endpoint for order detail
- Implemented JWT authentication for both endpoints
- Integrated with BrowserPool for per-user session isolation
- Added filters: customer search, date range, status
- Proper error handling (400/404/500) with logging

## Files Created/Modified

- `archibald-web-app/backend/src/index.ts` - API endpoints

## Decisions Made

[Filter implementation approach, error response format, or session management strategy]

## Issues Encountered

[Any endpoint design issues, filter edge cases, or session management challenges]

## Next Step

Ready for Plan 10-06 (Timeline UI Components) to build frontend order history display.
</output>
