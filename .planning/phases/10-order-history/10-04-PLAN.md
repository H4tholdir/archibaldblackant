---
phase: 10-order-history
plan: 04
type: execute
---

<objective>
Extract shipping tracking and document links (fatture/DDT) from order detail view.

Purpose: Complete order data extraction with tracking information (courier + number) and document access (invoices, delivery notes) as required by CONTEXT.md banking app vision.
Output: Extended OrderDetail interface with tracking and documents fields populated when available.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-order-history/10-CONTEXT.md
@.planning/phases/10-order-history/10-RESEARCH.md
@.planning/phases/10-order-history/UI-SELECTORS.md
@.planning/phases/10-order-history/10-01-SUMMARY.md
@.planning/phases/10-order-history/10-02-SUMMARY.md
@.planning/phases/10-order-history/10-03-SUMMARY.md

**CONTEXT.md Requirements:**
- Tracking spedizione: Badge "Tracking disponibile" quando presente
- Tracking details: corriere + numero tracking
- Documenti: Pulsante "Vedi documenti" per fatture e DDT
- Both features essential (equal priority)

**Discovery Findings (from Plan 10-01):**
- Location of tracking info in Archibald UI
- Location of document links (invoices, DDT)
- When tracking/documents become available (order state-dependent)

**Key Files:**
@archibald-web-app/backend/src/order-history-service.ts (extend OrderDetail interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shipping tracking when available</name>
  <files>archibald-web-app/backend/src/order-history-service.ts</files>
  <action>
    Extend OrderDetail interface and getOrderDetail() method to extract tracking:

    1. **Extend OrderDetail interface:**
       ```typescript
       interface OrderDetail {
         // ... existing fields from Plan 10-03
         tracking?: TrackingInfo;
       }

       interface TrackingInfo {
         courier: string;      // e.g., "BRT", "DHL", "UPS"
         trackingNumber: string;
         trackingUrl?: string; // If Archibald provides direct link
         addedAt?: string;     // ISO 8601 timestamp when tracking added
       }
       ```

    2. **Extract tracking from detail view:**
       - Use selector from UI-SELECTORS.md (Plan 10-01) to locate tracking section
       - Extract courier name and tracking number
       - Handle cases where tracking not yet available (return undefined)
       - Parse tracking URL if Archibald includes link to courier tracking page

    3. **Conditional extraction:**
       - Only populated for orders with status "Spedito" or similar
       - Log when tracking found: "Found tracking for order X: courier Y, number Z"
       - Log when tracking not found (expected for non-shipped orders)

    4. **Error handling:**
       - If tracking section selector not found, return tracking: undefined (not an error)
       - If tracking section exists but empty, return tracking: undefined
       - If tracking malformed, log warning and return undefined

    Use text-based selectors (not dynamic IDs).
    Handle optional field gracefully (undefined when not available).
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>Tracking extraction implemented with graceful handling when not available</done>
</task>

<task type="auto">
  <name>Task 2: Extract document links (fatture/DDT)</name>
  <files>archibald-web-app/backend/src/order-history-service.ts</files>
  <action>
    Extend OrderDetail interface to include documents:

    1. **Extend OrderDetail interface:**
       ```typescript
       interface OrderDetail {
         // ... existing fields
         documents?: OrderDocument[];
       }

       interface OrderDocument {
         type: 'invoice' | 'ddt' | 'other';  // fattura, DDT, altro
         name: string;         // e.g., "Fattura 2024/001234"
         url: string;          // Link to document (may be Archibald internal URL)
         date?: string;        // ISO 8601 when document created
       }
       ```

    2. **Extract document links:**
       - Use selector from UI-SELECTORS.md to locate documents section
       - Identify document type from link text or icon (Fattura vs DDT)
       - Extract document name and URL
       - Extract document date if visible

    3. **Document type detection:**
       - Regex pattern: /fattura/i → type: 'invoice'
       - Regex pattern: /ddt|bolla/i → type: 'ddt'
       - Otherwise → type: 'other'

    4. **Conditional extraction:**
       - Return empty array if no documents available
       - Log document count: "Found X documents for order Y"
       - Handle cases where document section doesn't exist (return [])

    5. **URL handling:**
       - If relative URL, prepend Archibald base URL (https://4.231.124.90)
       - If download link, preserve as-is
       - Log document URLs for debugging

    Use text-based identification for document links.
    Return empty array (not undefined) when no documents.
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>Document extraction implemented with type detection and URL handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TrackingInfo interface added to OrderDetail
- [ ] Tracking extraction handles available/unavailable cases
- [ ] OrderDocument interface and array added to OrderDetail
- [ ] Document extraction identifies type (invoice/DDT) and URLs
- [ ] TypeScript compilation passes without errors
- [ ] Graceful handling when tracking/documents not available
</verification>

<success_criteria>
- OrderDetail.tracking populated when shipping tracking available in Archibald
- OrderDetail.documents array contains all invoices and DDT links
- Type detection correctly identifies invoice vs DDT documents
- Graceful handling of orders without tracking or documents yet
- Frontend will be able to show "Tracking disponibile" badge and "Vedi documenti" button
- No TypeScript errors introduced
- Ready for Plan 10-05 (Order History API Endpoints)
</success_criteria>

<output>
After completion, create `.planning/phases/10-order-history/10-04-SUMMARY.md`:

# Phase 10 Plan 04: Tracking & Documents Extraction Summary

**Implemented extraction of shipping tracking and document links (fatture/DDT) from order detail.**

## Accomplishments

- Extended OrderDetail interface with tracking and documents fields
- Extracted shipping tracking (courier + number) when available
- Extracted document links with type detection (invoice/DDT)
- Handled conditional availability gracefully
- URL normalization for document links

## Files Created/Modified

- `archibald-web-app/backend/src/order-history-service.ts` - Tracking & documents extraction

## Decisions Made

[Document type detection strategy, URL handling approach, or availability logic]

## Issues Encountered

[Any missing tracking info, document URL issues, or extraction challenges]

## Next Step

Ready for Plan 10-05 (Order History API Endpoints) to expose data via REST API.
</output>
