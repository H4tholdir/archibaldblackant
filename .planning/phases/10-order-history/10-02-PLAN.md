---
phase: 10-order-history
plan: 02
type: execute
---

<objective>
Implement Puppeteer scraper for Archibald order list table with pagination support.

Purpose: Extract order list data (ID, date, customer, total, status) from Archibald using per-user sessions and reusable DevExpress patterns.
Output: OrderHistoryService class with getOrderList() method that returns paginated order list for a given user.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-order-history/10-CONTEXT.md
@.planning/phases/10-order-history/10-RESEARCH.md
@.planning/phases/10-order-history/UI-SELECTORS.md
@.planning/phases/10-order-history/10-01-SUMMARY.md

**Discovery Findings (from Plan 10-01):**
- Navigation path to order history section
- DevExpress table selectors for order list
- Pagination controls (if present)
- Available fields: ID, date, customer, total, status

**Reusable Patterns:**
- DevExpress helpers from archibald-bot.ts (Phase 3.08)
- Pagination pattern from customer-sync-service.ts (Phase 4.1-04)
- Session management via BrowserPool (Phase 6)

**Key Files:**
@archibald-web-app/backend/src/archibald-bot.ts (DevExpress helpers)
@archibald-web-app/backend/src/customer-sync-service.ts (pagination pattern)
@archibald-web-app/backend/src/browser-pool.ts (session management)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderHistoryService class with order list scraper</name>
  <files>archibald-web-app/backend/src/order-history-service.ts</files>
  <action>
    Create OrderHistoryService class following patterns from customer-sync-service.ts:

    1. **Class structure:**
       ```typescript
       export class OrderHistoryService {
         constructor(private logger: Logger) {}

         async getOrderList(
           context: BrowserContext,
           userId: string,
           options?: OrderListOptions
         ): Promise<OrderListResult>
       }

       interface OrderListOptions {
         limit?: number;        // Max orders to fetch (default: 100)
         offset?: number;       // Pagination offset (default: 0)
         filters?: OrderFilters; // Customer, date range, status (defer to Plan 10-05)
       }

       interface OrderListResult {
         orders: Order[];
         total: number;
         hasMore: boolean;
       }

       interface Order {
         id: string;
         date: string;         // ISO 8601 format
         customerName: string;
         customerId: string;   // If available
         total: string;        // e.g., "1.234,56 â‚¬"
         status: string;       // e.g., "In lavorazione", "Evaso", "Spedito"
       }
       ```

    2. **Navigation to order history:**
       - Use navigation path from UI-SELECTORS.md (Plan 10-01)
       - Click menu items using text-based selectors (not dynamic IDs)
       - Wait for order list table to load

    3. **Scrape order list table:**
       - Adapt pattern from customer-sync-service.ts scrapeCustomerPage()
       - Use DevExpress table selectors from UI-SELECTORS.md
       - Extract fields: ID, date, customer, total, status
       - Handle empty results gracefully

    4. **Error handling:**
       - Timeout if table doesn't load (30s)
       - Log errors with context (userId, page URL)
       - Return empty result on error (don't throw)

    Use winston logger (this.logger.info/error).
    Use PriorityManager to coordinate with sync services (import from priority-manager.ts).
    NO pagination in this task - single page only (pagination in Task 2).
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>OrderHistoryService class created with getOrderList() method extracting order list from single page</done>
</task>

<task type="auto">
  <name>Task 2: Add pagination support for multiple pages</name>
  <files>archibald-web-app/backend/src/order-history-service.ts</files>
  <action>
    Add pagination logic to getOrderList() method:

    1. **Pagination detection:**
       - Check for "Next page" button using selector from UI-SELECTORS.md
       - Detect current page number and total pages (if available)

    2. **Multi-page iteration:**
       ```typescript
       let allOrders: Order[] = [];
       let currentPage = 1;
       let hasMore = true;

       while (hasMore && allOrders.length < (options?.limit || 100)) {
         // Scrape current page
         const pageOrders = await scrapeOrderPage(page);
         allOrders.push(...pageOrders);

         // Check for next page
         hasMore = await hasNextPageButton(page);
         if (hasMore && allOrders.length < (options?.limit || 100)) {
           await clickNextPage(page);
           await waitForTableReload(page);
           currentPage++;
         }
       }
       ```

    3. **Pagination safeguards:**
       - Max 10 pages to prevent infinite loops
       - Detect duplicate orders (same ID on consecutive pages)
       - Log pagination progress: "Scraped page X, Y orders so far"

    4. **Respect limit/offset:**
       - If offset > 0, skip first N orders
       - If limit reached, stop pagination early
       - Return hasMore: true if stopped early

    Adapt pagination pattern from customer-sync-service.ts (Phase 4.1-04 implemented sort manipulation).
    Use text-based button identification (not dynamic IDs).
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>Pagination support added with safeguards against infinite loops and duplicate detection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] OrderHistoryService class created in order-history-service.ts
- [ ] getOrderList() method navigates to order history and scrapes table
- [ ] Pagination support handles multiple pages with safeguards
- [ ] TypeScript compilation passes without errors
- [ ] Winston logger used for all logging (no console.log)
- [ ] Error handling returns empty results gracefully
</verification>

<success_criteria>
- OrderHistoryService.getOrderList() successfully extracts order list from Archibald
- Pagination iterates through multiple pages without infinite loops
- Per-user session isolation via BrowserContext parameter
- Reuses existing DevExpress helpers and patterns
- No TypeScript errors introduced
- Ready for Plan 10-03 (Order Detail Extraction)
</success_criteria>

<output>
After completion, create `.planning/phases/10-order-history/10-02-SUMMARY.md`:

# Phase 10 Plan 02: Order List Scraper Implementation Summary

**Implemented Puppeteer scraper for Archibald order list table with pagination support.**

## Accomplishments

- Created OrderHistoryService class with getOrderList() method
- Implemented navigation to order history section
- Scraped DevExpress table for order data (ID, date, customer, total, status)
- Added pagination support with safeguards (max pages, duplicate detection)
- Integrated with BrowserPool for per-user session isolation

## Files Created/Modified

- `archibald-web-app/backend/src/order-history-service.ts` - Order list scraper

## Decisions Made

[Pagination strategy, error handling approach, or performance optimizations]

## Issues Encountered

[Any selector issues, pagination edge cases, or DevExpress quirks]

## Next Step

Ready for Plan 10-03 (Order Detail Extraction) to scrape complete order data.
</output>
