---
phase: 10-order-history
plan: 03
type: execute
---

<objective>
Implement order detail extraction including articles, quantities, prices, customer info, and status timeline.

Purpose: Extract complete order data beyond the list view - items purchased, timeline of status updates, and customer information for the expanded order view.
Output: OrderHistoryService.getOrderDetail() method that returns complete order data for a single order ID.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-order-history/10-CONTEXT.md
@.planning/phases/10-order-history/10-RESEARCH.md
@.planning/phases/10-order-history/UI-SELECTORS.md
@.planning/phases/10-order-history/10-01-SUMMARY.md
@.planning/phases/10-order-history/10-02-SUMMARY.md

**Discovery Findings (from Plan 10-01):**
- Navigation flow to access order detail (click row? button? modal?)
- Selectors for article list table within order detail
- Location of status timeline / history
- Customer info location within detail view

**Reusable Patterns:**
- DevExpress helpers from archibald-bot.ts
- Table scraping pattern from Plan 10-02
- Navigation patterns from Phase 3.08

**Key Files:**
@archibald-web-app/backend/src/order-history-service.ts (extend this)
@archibald-web-app/backend/src/archibald-bot.ts (DevExpress helpers)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement navigation to order detail view</name>
  <files>archibald-web-app/backend/src/order-history-service.ts</files>
  <action>
    Add getOrderDetail() method to OrderHistoryService:

    1. **Method signature:**
       ```typescript
       async getOrderDetail(
         context: BrowserContext,
         userId: string,
         orderId: string
       ): Promise<OrderDetail | null>

       interface OrderDetail {
         id: string;
         date: string;
         customerName: string;
         customerId: string;
         customerAddress?: string;
         customerNotes?: string;
         total: string;
         status: string;
         items: OrderItem[];
         statusTimeline: StatusUpdate[];
         // tracking and documents in Plan 10-04
       }

       interface OrderItem {
         articleCode: string;
         articleName: string;
         variantId?: string;
         quantity: number;
         unitPrice: string;
         subtotal: string;
       }

       interface StatusUpdate {
         status: string;
         timestamp: string;  // ISO 8601
         note?: string;
       }
       ```

    2. **Navigation to detail:**
       - From order list, identify row with matching orderId
       - Click row or detail button (based on UI-SELECTORS.md from Plan 10-01)
       - Wait for detail view to load (modal? new page? expanded row?)
       - Use selector from UI-SELECTORS.md for wait condition

    3. **Error handling:**
       - Return null if orderId not found in list
       - Timeout if detail view doesn't load (30s)
       - Log navigation attempts and failures

    Use existing DevExpress helpers where applicable.
    Use winston logger for all logging.
    NO article scraping yet - just navigation (article scraping in Task 2).
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>Navigation to order detail view implemented with error handling</done>
</task>

<task type="auto">
  <name>Task 2: Extract complete order data (items, timeline, customer info)</name>
  <files>archibald-web-app/backend/src/order-history-service.ts</files>
  <action>
    Complete getOrderDetail() implementation by extracting all detail fields:

    1. **Article list extraction:**
       - Scrape article table using selectors from UI-SELECTORS.md
       - Extract fields: article code, name, variant ID (if visible), quantity, unit price, subtotal
       - Handle empty article list (order with no items yet)
       - Parse numeric values: quantity (number), prices (string with â‚¬ symbol)

    2. **Status timeline extraction:**
       - Locate status history/timeline section using selector from UI-SELECTORS.md
       - Extract entries: status name, timestamp
       - Parse timestamps to ISO 8601 format
       - Sort by timestamp descending (newest first)
       - If timeline not visible, create single entry from current status + order date

    3. **Customer information:**
       - Extract customer name, ID (if available)
       - Extract customer address (if visible in detail)
       - Extract order notes (if field exists)

    4. **Order header data:**
       - Confirm order ID, date, total match list view
       - Extract any additional fields visible in detail view

    Reuse DevExpress table scraping pattern from Plan 10-02.
    Handle missing/optional fields gracefully (use undefined for optional fields).
    Log extraction progress: "Extracted X items, Y status updates for order Z".
  </action>
  <verify>
    TypeScript compiles without errors:
    cd archibald-web-app/backend && npx tsc --noEmit
  </verify>
  <done>Complete order data extraction including items, timeline, and customer info</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] getOrderDetail() method added to OrderHistoryService
- [ ] Navigation to order detail view works reliably
- [ ] Article list extracted with all fields (code, name, quantity, prices)
- [ ] Status timeline extracted with timestamps
- [ ] Customer information extracted from detail view
- [ ] TypeScript compilation passes without errors
- [ ] Winston logger used (no console.log)
</verification>

<success_criteria>
- OrderHistoryService.getOrderDetail() returns complete order data for given order ID
- Article items include all required fields from CONTEXT.md requirements
- Status timeline provides history of order state changes
- Customer information available for display in frontend
- Graceful handling of missing/optional fields
- No TypeScript errors introduced
- Ready for Plan 10-04 (Tracking & Documents Extraction)
</success_criteria>

<output>
After completion, create `.planning/phases/10-order-history/10-03-SUMMARY.md`:

# Phase 10 Plan 03: Order Detail Extraction Summary

**Implemented order detail extraction including articles, quantities, prices, customer info, and status timeline.**

## Accomplishments

- Added getOrderDetail() method to OrderHistoryService
- Implemented navigation from list to detail view
- Extracted article list with code, name, quantity, unit price, subtotal
- Extracted status timeline with timestamps
- Extracted customer information from detail view
- Handled optional fields gracefully

## Files Created/Modified

- `archibald-web-app/backend/src/order-history-service.ts` - Order detail extraction

## Decisions Made

[Navigation approach, timeline parsing strategy, or field mapping decisions]

## Issues Encountered

[Any missing fields, navigation issues, or parsing challenges]

## Next Step

Ready for Plan 10-04 (Tracking & Documents Extraction) to complete data extraction.
</output>
